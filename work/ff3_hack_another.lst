#[1]   ff3_hack_another.asm
   15                     ;----------------------------------------------------------------------------------------------------------
   16           0000              .ifdef BALANCED_VERSION
   22                             .else
   23  00:E000                            .incbin "ff3_hack_base.nes"     ;header must be stripped
   24                             .endif  ;BALANCED_VERSION
#[4]   ff3_asm.h
   25                             .include "ff3_asm.h"
    1                     ; ff3_asm.h
    2                     ;
    3                     ; include file for hackcodes
    4                     ;======================================================================================================
    5                     ;consts
#[5]   ff3_const.h
    6                             .include "ff3_const.h"
    1                     ; ff3_const.h
    2                     ;
    3                     ; various constant value definitions
    4                     ;--------------------------------------------------------------------------------
    5                     ; original consts
    6                     
    7                     ;--------------------------------------------------------------------------------
    8                     ;status flags
    9                     ;
   10           0001      STATUS_LITE_MASK        = $01
   11                     ; heavy
   12           0002      STATUS_POISON           = $02
   13           0004      STATUS_BLIND            = $04
   14           0008      STATUS_MINIMUM          = $08
   15           0010      STATUS_SEALED           = $10
   16           0020      STATUS_TOAD             = $20
   17           0040      STATUS_STONE            = $40
   18           0080      STATUS_DEAD             = $80
   19                     ; lite
   20           0001      STATUS_JUMPING          = $01   ; valid only in battle (cannot enchant)
   21           0006      STATUS_PETRIFY_MASK     = $06
   22           0018      STATUS_REMAIN_MASK      = $18
   23           0020      STATUS_CONFUSED         = $20
   24           0040      STATUS_SLEEPING         = $40
   25           0080      STATUS_PARALYZED        = $80
   26                     
   27                     ;--------------------------------------------------------------------------------
   28                     ;BattleChar related
   29                     ;
   30           0001      BP_OFFSET_STATUS_HEAVY          = $01
   31           0002      BP_OFFSET_STATUS_LITE           = $02
   32           001E      X_BP_OFFSET_PARAM                       = $1e
   33           001F      X_BP_OFFSET_TYPE                        = $1f
   34           0027      BP_OFFSET_ATTACK_MULTIPLIER = $27
   35           0028      BP_OFFSET_CRITICAL_RATE         = $28
   36           002C      BP_OFFSET_INDEX_AND_MODE        = $2c
   37           002E      BP_OFFSET_ACTION_ID             = $2e
   38           002F      BP_OFFSET_ACTION_TARGET = $2f
   39           0030      BP_OFFSET_TARGET_FLAG           = $30
   40           0037      BP_OFFSET_SPECIAL_RATE          = $37
   41                     
   42           0080      TARGET_ENEMY_PARTY      = $80
   43           0040      TARGET_MULTIPLE         = $40
   44                     
   45                     ;--------------------------------------------------------------------------------
   46                     ; action ids
   47                     ;
   48                     
   49           0000      ACTION_NOTHING  = $00
   50           0004      ACTION_FIGHT    = $04
   51           0006      ACTION_ESCAPE   = $06
   52                     
   53                     
   54                     ;--------------------------------------------------------------------------------
   55                     ; job ids
   56                     ;
   57                     
   58           0008      JOB_THIEF       = $08
   59                     
   60                     ;--------------------------------------------------------------------------------
   61                     ; chip ids
   62                     ;
   63                     
   64           007C      CHIPID_TREASURE_BOX = $7c
   65           007D      CHIPID_OPENED_TREASURE_BOX = $7d
   66                     
   67                     ;--------------------------------------------------------------------------------
   68                     ; treasure
   69                     
   70           00E0      TREASURE_WITH_ENCOUNTER_BASE = $e0
   71                     
   72                     ;--------------------------------------------------------------------------------
   73                     ; event flags
   74                     
   75           0020      EVENT_FLAG_ENCOUNTER = $20
   76                     
   77                     ;--------------------------------------------------------------------------------
   78                     ; extention to original
   79                     
   80                     ;EXSTATUS_OFFSET_PARAM  = $1e
   81                     ;EXSTATUS_OFFSET_TYPE   = $1f
   82                     
   83           0019      EFFECT_PROVOKE  = $19
   84           001A      EFFECT_ABYSS    = $1a
   85                     
   86           0016      CMDX_ID_BEGIN           = $16
   87           0016      CMDX_PROVOKE            = $16
   88           0017      CMDX_DISORDERED_SHOT= $17
   89           0018      CMDX_ABYSS                      = $18
   90           0019      CMDX_RAID                       = $19
   91           001A      CMDX_ID_END                     = $1a
   92                     
   93           0006      BATTLE_PROCESS_EX_DISORDERED_SHOT = $06
   94                     
   95           0026      PRESENT_SCENE_EX_BLOWONLY = $26
   96           0027      PRESENT_SCENE_EX_ABYSS = $27
   97                     
   98           000A      BF_PICK_RANDOM_TARGET = $0a
   99           000B      BF_GET_RANDOM_SUCCEEDED_COUNT = $0b
  100           000C      BF_CALC_DAMAGE = $0c
#[4]   ff3_asm.h
    7                     ;proc addrs
#[5]   ff3_30-31.h
    8                             .include "ff3_30-31.h"
    1                     ; ff3_30-31.h
    2                     ;
    3                     ;description:
    4                     ;       include file for bank $30,$31
    5                     ;
    6                     ;version:
    7                     ;       v0.05 (2007-08-21)
    8                     ;
    9                     ;======================================================================================================
   10                     ;$30-31
   11           A2B5      b31_getActor2C                          = $a2b5 ;2c:index & flag
   12           A2BA      cacheStatus                                     = $a2ba
   13           A300      getRandomTarget                         = $a300
   14           A368      sumDamage                                       = $a368
   15           A389      addValueAtOffsetToAttack        = $a389
   16           A397      isRangedWeapon                          = $a397
   17           A482      loadPlayerParam                         = $a482
   18           A4F6      loadEnemyParam                          = $a4f6
   19           A8C8      getActionMode                           = $a8c8 ;[in] $2c: battleChar* [out] y : #2c, a : $24.+2c
   20           A8CD      setRandomTargetFromEnemyParty = $a8cd   ;[in] BattleChar* $24
   21           A8EC      getLeastLvInPlayerParty         = $a8ec
   22           A91B      decideEnemyActionTarget         = $a91b
   23           A9F7      isValidTarget                           = $a9f7 ;[out] bool zero :valid
   24           AA16      recalcPlayerParam                       = $aa16
   25           AF77      calcAction                                      = $af77
   26           B9AB      segmentate                                      = $b9ab
   27                     ;getRandomSucceededCount                = $bb28 ;$24:count, $25:rate, [out] $30:succeededCount
   28           BB28      getNumberOfRandomSuccess        = $bb28
   29           BB44      calcDamage                                      = $bb44 ;[out] $1c,1d : damage
   30           BBE2      isTargetWeakToHoly                      = $bbe2 ;[out] $27: 2=weak
   31           BC25      b31_getTarget2C                         = $bc25
   32                     ;applyDamage                                    = $bcd2
   33           BCD2      damageHp                                        = $bcd2
   34           BD24      healHp                                          = $bd24
   35           BDAA      shiftRightDamageBy2                     = $bdaa
   36           BDB3      set24ToActor                            = $bdb3
   37           BDBC      set24ToTarget                           = $bdbc
   38           BE14      checkEnchantedStatus            = $be14
   39           BE90      b31_updatePlayerOffset          = $be90
   40           BE98      b31_setYtoOffsetOf                      = $be98
   41           BE9D      calcDataAddress                         = $be9d
   42           BEB4      b31_getBattleRandom                     = $beb4
   43           BF53      checkSegment                            = $bf53
#[4]   ff3_asm.h
#[5]   ff3_32-33.h
    9                             .include "ff3_32-33.h"
    1                     ; ff3_32-33.h
    2                     ;
    3                     ;description:
    4                     ;       include file for bank $32,33
    5                     ;
    6                     ;version:
    7                     ;       v0.02 (2006-10-23)
    8                     ;
    9                     ;======================================================================================================
   10                     ;$32-33
   11           8AE6      incrementSwingFrame                     = $8ae6 ;a = ++$b6
   12           A059      beginSwingFrame                         = $a059 ;$b6 = 0
   13           A094      blowEffect_limitHitCount        = $a094
   14           A0C0      effect_playerBlow                       = $a0c0 ;[effectFunction_04]
   15           A245      getSwingCountOfCurrentHand      = $a245
   16           A44F      getSys0Random_00_ff                     = $a44f
#[4]   ff3_asm.h
#[5]   ff3_34-35.h
   10                             .include "ff3_34-35.h"
    1                     ; ff3_34-35.h
    2                     ;
    3                     ;description:
    4                     ;       label definition for bank $34-35
    5                     ;
    6                     ;version:
    7                     ;       0.03 (2006-10-19)
    8                     ;
    9                     ;======================================================================================================
   10                     ;$34-35
   11           801E      dispatchBattleFunction_03       = $801e
   12           8026      dispatchBattleFunction_05       = $8026
   13           802A      dispatchBattleFunction_06       = $802a
   14           802E      dispatchBattleFunction_07       = $802e
   15           8185      presentCharacter                        = $8185
   16                     ;playEffect                                     = $8411 ;hacked
   17                     ;set52toIndexFromActorBit       = $8532 ;[in] $7e98 : target indicator bits?,
   18           8545      dispatchPresentScene_1f         = $8545
   19           86AB      targetBitToCharIndex            = $86ab ;[in] x = side? [out] y = index
   20           892E      tileSprites2x2                          = $892e
   21           8966      loadCursor                                      = $8966
   22           899E      getInputAndUpdateCursorWithSound = $899e
   23           8ADF      clearSprites2x2                         = $8adf
   24                     
   25           8B38      draw8LineWindow                         = $8b38 ;[in] $18:left, $19:right, $1a:borderFlag, $7ac0:tilePtr
   26           8D03      setBackgroundProperty           = $8d03 ;
   27           8D1B      draw1LineWindow                         = $8d1b ;[in] $18:windowkind
   28           8EB0      eraseWindow                                     = $8eb0
   29           8F0B      eraseFromLeftBottom0Bx0A        = $8f0b
   30           91CE      setNoTargetMessage                      = $91ce
   31           95BD      setBaseAddrTo_8a40                      = $95bd
   32           95C6      setBaseAddrTo_8c40                      = $95c6
   33           95CF      set18toTargetCache                      = $95cf
   34           95E1      itoa_16                                         = $95e1
   35           966A      strToTileArray                          = $966a
   36                     ;initTileArrayStorage           = $9754 ;hacked (fill $7200[0x200] and set $4e to point $7200)
   37                     ;getCommandInput_next           = $99fd ;hacked
   38           9A69      createCommandWindow                     = $9a69
   39           9AE7      putCanceledItem                         = $9ae7
   40           9B79      requestSoundEffect18                    = $9b79 ;setCA_18_and_incC9
   41           9B7D      requestSoundEffect05                    = $9b7d ;setCA_05_and_incC9
   42           9B81      requestSoundEffect06                    = $9b81 ;setCA_06_and_incC9
   43           9B88      setYtoOffsetOf                          = $9b88 ;y = $5f + a
   44           9B8D      setYtoOffset03                          = $9b8d
   45           9B94      setYtoOffset2F                          = $9b94 ;target indicator
   46           9B9B      setYtoOffset2E                          = $9b9b ;action id
   47           9BA2      drawInfoWindow                          = $9ba2
   48           9D1D      cachePlayerStatus                       = $9d1d
   49           9D9E      drawEnemyNamesWindow            = $9d9e
   50           9F7B      setActorActionAndClearMode      = $9f7b
   51           9F87      setActionTargetToSelf           = $9f87
   52                     ;getIndexOfGreatest                     = $a30f ;hacked [in] u16 $1a[4] : values ,$24[4] : indices [out] x : index
   53           A353      consumeEquippedItem                     = $a353 ;x unchanges
   54           A42E      getActor2C                                      = $a42e
   55           A541      getPlayerOffset                         = $a541
   56           A549      initString                                      = $a549 ;fill x bytes at $7ad7 #$00ff (null terminated)
   57           A558      offsetTilePtr                           = $a558
   58           A564      getSys1Random                           = $a564
   59           A609      loadString                                      = $a609
   60                     ;itemWindowInputLoop            = $aeaa ;hacked
   61                     ;endItemWindow                          = $b1b0 ;hacked
   62                     ;itemWindow_OnB                         = $b198 ;hacked
   63                     ;loadTileArrayForItemWindowColumn = $b48b
   64                     ;moveCursor                                     = $b4d4 ;hacked
   65                     ;itemWindow_OnUse                       = $b4f7 ;hacked
   66                     ;drawEquipWindow                        = $b419 ;hacked
   67                     ;drawEquipWindowNoErase         = $b5f9 ;hacked
   68                     ;isPlayerAllowedToUseItem       = $b8fd ;hacked
   69           B979      setActionTargetByParam          = $b979
   70           BA3A      loadTo7400FromBank30            = $ba3a
#[4]   ff3_asm.h
   11                     ;$3e-3f
   12           C750      field_callSoundDriver           = $c750
   13           C98F      field_cacheWindowPalette        = $c98f
   14           C9A9      field_setWindowPalette          = $c9a9
   15           ED56      field_fill_07c0_ff                      = $ed56
   16           EDE1      field_setBgScrollTo0            = $ede1
   17           F6AA      field_putWindowTiles            = $f6aa
   18           F727      switchBanksTo3c3d                       = $f727
   19           F8B0      updateDmaPpuScrollSyncNmiEx = $f8b0
   20           F8C5      updateDmaPpuScrollSyncNmi       = $f8c5 ;(y is unchanged)
   21           F8CB      updatePpuScrollNoWait           = $f8cb
   22           F8E0      setVramAddr                                     = $f8e0 ;[in] a:high, x:low
   23           F8EA      mul_8x8_reg                                     = $f8ea ;a,x = a * x
   24           FA0E      call_2e_9d53                            = $fa0e
   25           FA26      doBattle                                        = $fa26
   26           FB80      waitNmi                                         = $fb80 ;wait on $05 clear
   27           FB87      switchFirst2Banks                       = $fb87 ;[in] a : per16k bank index
   28           FBAA      getPad1Input                            = $fbaa ;[out] $12 : inputFlags
   29           FBEF      getBattleRandom                         = $fbef ;[out] a : rand [min:x - max:a] max included
   30           FC27      initBattleRandom                        = $fc27
   31           FC92      div_16                                          = $fc92 ;$1c = $18,19 / $1a,1b; $1d = $18,19 % $1a,1b
   32           FCD6      mul_8x8                                         = $fcd6 ;$1a,1b = a * x
   33           FCF5      mul_16x16                                       = $fcf5 ;$1c,1d,1e,1f = $18,19 * $1a,1b
   34           FD20      flagTargetBit                           = $fd20
   35           FD2C      clearTargetBit                          = $fd2c
   36           FD38      maskTargetBit                           = $fd38
   37           FD3C      shiftLeft6                                      = $fd3c
   38           FD43      shiftRight6                                     = $fd43
   39           FD4A      loadStringWorker                        = $fd4a
   40           FD60      get2byteAtBank18                        = $fd60
   41           FDA6      loadTo7400Ex                            = $fda6
   42           FDDC      copyTo7400                                      = $fddc
   43                     ;call_30_9e58                           = $fdf3
   44           FDF3      invoke_b30_battleFunction       = $fdf3
   45           FF00      waitNmiBySetHandler                     = $ff00
   46           FF06      call_switch1stBank                      = $ff06
   47           FF09      call_switch2ndBank                      = $ff09
   48                     ;----------------------------------------------------------------------------------------------------------
   49                     ;well known vars
   50           0101      pNmiHandler                     = $0101 ;$0100 jmp xxxx
   51           0104      pIrqHandler                     = $0104 ;$0103 jmp xxxx
   52           0000      irqFlag                         = $00
   53           0001      enableScanlineCounter = $01     ;mmc3's irq
   54           0003      irqCountDown            = $03
   55           0005      nmiFlag                         = $05
   56           0006      ppuCtrl1SetOnNmi        = $06
   57           0008      ppuCtrl1SetOnIrq        = $08
   58           0009      ppuCtrl2SetOnNmi        = $09
   59           000C      scrollXSetOnNmi         = $0c
   60           000D      scrollYSetOnNmi         = $0d
   61           0010      scrollXSetOnIrq         = $10
   62           0011      scrollYSetOnIrq         = $11
   63           0012      inputBits                       = $12
   64           00B3      selectTarget_behavior           = $b3   ;param of presentSceneFunction10($2e:9d53)
   65           00B4      selectTarget_selectedBits       = $b4
   66           00B5      selectTarget_targetFlag         = $b5
   67           00C0      playerX                         = $c0   ;*4
   68           00C4      playerY                         = $c4   ;*4
   69           00C9      playSoundEffect         = $c9   ;1=play
   70           00CA      soundEffectId           = $ca   ; played on irq if $c9 != 0
   71           00E0      targetStatusCache       = $e0   ;in process battle phase
   72           00F0      actorStatusCache        = $f0   ;
   73           78D5      presentActionParams     = $78d5 ;?,actor,action,targetflag,effectmsg,messages
   74           78D5      battleProcessType       = $78d5
   75           78D7      actionName                      = $78d7
   76           78D8      targetName                      = $78d8
   77           78D9      effectMessage           = $78d9
   78           78DA      battleMessages          = $78da
   79           78EE      battleMessageCount      = $78ee
   80                     ;pTileArray                     = $7ac0
   81           7AC7      selectedMagicLv         = $7ac7 ;[4]
   82           7AD7      stringCache                     = $7ad7
   83           7BE3      battleRandoms           = $7be3
   84           7CED      encounterId                     = $7ced
   85           7CF3      isRendering                     = $7cf3
   86                     
   87           7D6B      groupToEnemyIdMap       = $7d6b ;*4
   88                     ;;indexToGroupMap               = $7da7
   89           7DD7      enemyPos                        = $7dd7 ;{x,y}*8
   90                     ;param for playing (magic) effect
   91           7E1F      play_weaponRight                = $7e1f
   92           7E20      play_weaponLeft                 = $7e20
   93           7E4F      play_damages                    = $7e4f
   94           7E6F      play_damageTarget               = $7e6f ;0=player
   95           7E98      play_actorBits                  = $7e98
   96           7E96      play_arrowTarget                = $7e96
   97           7E99      play_castTargetBits             = $7e99 ;battle
   98           7E9A      play_effectTargetSide   = $7e9a ;80:actor enemy 40:target enemy
   99           7E9B      play_effectTargetBits   = $7e9b ;param of presentActionEffect($33:b68d)
  100           7E9D      play_magicType                  = $7e9d
  101           7EB8      play_reflectedTargetBits= $7eb8 ;param of presentEffectAtTarget($33:b64f)
  102                     
  103           7EC2      effectHandlerIndex      = $7ec2 ;
  104           7EC3      effectHandlerFlag       = $7ec3
  105           7EC4      effect_enemyStatus      = $7ec4
  106           7ECD      indexToGroupMap         = $7ecd ;*8
  107           7ED8      battleMode                      = $7ed8 ; 80:boss? 20:fireCannon(invincible) 10:disallowEnlarge 08:? 01:disallowEscape
  108           7EDF      play_protectionTargetBits = $7edf
  109           7EE1      play_segmentedGroup = $7ee1
  110                     
  111           7F40      soundDriver_playingMusicId = $7f40
  112           7F41      soundDriver_lastMusicId = $7f41
  113           7F42      soundDriver_control     = $7f42 ;01:playNew(7f43) 02:playLast(7f41,saved when 01) 04:stop 80:playOn
  114           7F43      soundDriver_musicId     = $7f43
  115           7F49      soundDriver_effectId= $7f49     ;msb should be 1
  116                     ;----------------------------------------------------------------------------------------------------------
  117                     ;in memory structs
  118           60C0      backpackItems           = $60c0
  119           6100      playerBaseParams        = $6100
  120           6200      playerEquips            = $6200
  121           7575      playerBattleParams      = $7575 ;$40*4
  122           7675      enemyBattleParams       = $7675 ;$40*8
  123                     ;----------------------------------------------------------------------------------------------------------
  124                     ;in rom structs
  125           0900      userFlags                       = $00900
  126           0000      stringPtrTable          = $30000
  127           0000      monsterBaseParams       = $60000        ;8*256
  128           1000      monsterBattleParams = $61000
  129           1400      itemBaseParams          = $61400
  130           3B88      initialMps                      = $73b88
  131           AD59      lvupParamPtrTable       = $7ad59
  132                     ;handler tables
  133           83F8      commandIdToEffectMap    = $683f8
  134           843E      commandEffectHandlers   = $6843e
  135           9A16      commandWindowHandlers   = $69a16
  136           9FAC      commandHandlers                 = $69fac
  137                     ;------------------------------------------------------------------------------------------------------
  138           7900      TEMP_RAM = $7900        ;we cannot use stack regeon due to dugeon's floor save
  139                     ;------------------------------------------------------------------------------------------------------
  140                     
  141                     ;------------------------------------------------------------------------------------------------------
  142                     ;macros
  143                     INIT16  .macro  ;addr,val
  144                             lda #LOW(\2)
  145                             sta \1
  146                             lda #HIGH(\2)
  147                             sta \1+1
  148                                     .endm
  149                     
  150                     INIT16_x        .macro  ;addr,val
  151                             ldx #LOW(\2)
  152                             stx \1
  153                             ldx #HIGH(\2)
  154                             stx \1+1
  155                                     .endm
  156                                             
  157                     ADD16   .macro  ;addr,val               
  158                             lda \1
  159                             clc
  160                             adc #LOW(\2)
  161                             sta \1
  162                             lda \1+1
  163                             adc #HIGH(\2)
  164                             sta \1+1
  165                                     .endm
  166                     
  167                     ADD16by8        .macro
  168                             lda \1
  169                             clc
  170                             adc \2
  171                             sta \1
  172                             bcc .add16by8_\@
  173                                     inc \1+1
  174                             .add16by8_\@:
  175                             .endm
  176                     
  177                     SUB16   .macro  ;addr,val               
  178                             lda \1
  179                             sec
  180                             sbc #LOW(\2)
  181                             sta \1
  182                             lda \1+1
  183                             sbc #HIGH(\2)
  184                             sta \1+1
  185                                     .endm
  186                     
  187                     SUB16by8        .macro  ;addr,val
  188                             lda \1
  189                             sec
  190                             sbc \2
  191                             sta \1
  192                             bcs .sub16by8_\@
  193                                     dec \1+1
  194                             .sub16by8_\@:
  195                             .endm
  196                     
  197                     FILEORG .macro
  198                             .bank   (\1) >> 13
  199                             .org    ($8000 | ((\1) & $7fff))
  200                                     .endm
  201                                     
  202                     RESTORE_PC      .macro
  203                             .bank   BANK(\1)
  204                             .org    \1
  205                                     .endm
  206                                     
  207                     INIT_PATCH      .macro
  208                             .bank   \1
  209                             .org    \2
  210                             .ds             ((\3) - (\2))
  211                             .org    \2
  212                                     .endm
  213                     
  214           0000              .ifdef RESPECT_ORIGINAL_ADDR
  218                             .else
  219                     ORIGINAL_ADDR   .macro
  220                                     .endm
  221                             .endif
  222                             
  223                     ALIGN_EVEN      .macro  ;value to align
  224                             .check_align_\@:
  225                             .if (.check_align_\@ & 1) != 0
  226                                     nop     ;pad
  227                             .endif
  228                             .endm   ;ALIGN_EVEN
  229                     
  230                     VERIFY_PC       .macro
  231                             .verify_pc_\@:
  232                             .if (.verify_pc_\@ > \1)
  233                                     .fail
  234                             .endif
  235                             .endm   ;VERIFY_PC
#[3]   ff3_hack_master.asm
   26           0000              .bank   $00
   27           8000              .org    $8000
#[4]   ff3_string.asm
   28                             .include "ff3_string.asm"
    1                     ; ff3_string.asm
    2                     ;
    3                     ; string related codes in bank $34-35
    4                     ;
    5                     ;version:
    6                     ;       0.05 (2006-11-12)
    7                     ;======================================================================================================
    8  00:8000            ff3_string_begin:
    9                     
   10           7220      TILE_ARRAY_BASE = $7200+$20;(1 << UNROLL_SHIFT)
   11                     ;======================================================================================================
   12                     ;strToTileArray
   13                     ; 意外にもフィールドのルーチンからも呼ばれる模様
   14           0001              .ifdef ENABLE_strToTileArray
   15                             ;.bank  $34
   16                             ;.org   $966a
   17                             INIT_PATCH $34,$966a,$9754
                0034              .bank   $34
                966A              .org    $966a
       34:966A                    .ds             (($9754) - ($966a))
                966A              .org    $966a
   18                             
   19  34:966A            strToTileArray:
   20           0018      .cchLine        = $18
   21           001C      .char           = $1c
   22           001E      .pUpperLine     = $1e
   23           004E      .pTileArray     = $4e
   24           7AD7      .pString        = $7ad7
   25  34:966A  A5 4E             lda <.pTileArray
   26  34:966C  85 1E             sta <.pUpperLine
   27  34:966E  A5 4F             lda <.pTileArray+1
   28  34:9670  85 1F             sta <.pUpperLine+1
   29  34:9672  A5 18             lda <.cchLine
   30  34:9674  20 58 A5          jsr offsetTilePtr
   31                             
   32  34:9677  A0 00             ldy #0
   33  34:9679  A2 00             ldx #0
   34  34:967B            .decode_loop:
   35  34:967B  8A                txa
   36  34:967C  48                pha
   37  34:967D  BD D7 7A          lda .pString,x
   38  34:9680  F0 54             beq .return
   39  34:9682  C9 01             cmp #1
   40  34:9684  F0 56             beq .force_linefeed
   41  34:9686  C9 02             cmp #2
   42  34:9688  F0 5A             beq .space_run
   43  34:968A  C4 18             cpy <.cchLine
   44  34:968C  90 07             bcc .decode
   45                                     ;.linefeed
   46  34:968E  48                        pha
   47  34:968F  A5 18                     lda <.cchLine
   48  34:9691  20 C3 96                  jsr .do_feed
   49  34:9694  68                        pla
   50  34:9695            .decode:
   51  34:9695  38                sec
   52  34:9696  E9 29             sbc #$29
   53  34:9698  C9 33             cmp #$5c-$29
   54  34:969A  B0 1D             bcs .put_tile
   55                                     ;original code 29-5f reaches here
   56  34:969C  85 1C                     sta <.char
   57                                     ;tax
   58                                     ;lda .offsetAndFlags,x
   59  34:969E  A2 00                     ldx #0
   60  34:96A0                    .find_char_type:
   61  34:96A0  DD EF 96                          cmp .codeBounds,x
   62  34:96A3  E8                                inx
   63  34:96A4  B0 FA                             bcs .find_char_type
   64                                     ;x = type + 1
   65  34:96A6  BD F9 96                  lda .offsetFlags-1,x
   66  34:96A9  4A                        lsr a
   67  34:96AA  48                        pha
   68  34:96AB  A9 C0                     lda #$c0
   69  34:96AD  69 00                     adc #0  ;take lsb as carry
   70  34:96AF  91 1E                     sta [.pUpperLine],y
   71  34:96B1  68                        pla
   72  34:96B2  F0 24                     beq .put_he
   73  34:96B4  69 60                     adc #$60
   74  34:96B6  65 1C                     adc <.char
   75  34:96B8  38                        sec
   76  34:96B9            .put_tile:
   77  34:96B9  69 28             adc #$28        ;carry
   78  34:96BB            .put_only:      
   79  34:96BB  91 4E             sta [.pTileArray],y
   80  34:96BD  C8                iny
   81  34:96BE            .next:
   82  34:96BE  68                pla
   83  34:96BF  AA                tax
   84  34:96C0            .next_nopop:    
   85  34:96C0  E8                inx
   86  34:96C1  D0 B8             bne .decode_loop
   87  34:96C3            .do_feed:
   88  34:96C3  A0 00             ldy #0
   89  34:96C5  48                pha
   90  34:96C6  20 58 A5          jsr offsetTilePtr
   91  34:96C9  18                clc
   92  34:96CA  68                pla
   93  34:96CB  65 1E             adc <.pUpperLine
   94  34:96CD  85 1E             sta <.pUpperLine
   95  34:96CF  A9 00             lda #0
   96  34:96D1  65 1F             adc <.pUpperLine+1
   97  34:96D3  85 1F             sta <.pUpperLine+1
   98  34:96D5  60                rts
   99  34:96D6            .return:
  100  34:96D6  68                pla     ;dummy
  101  34:96D7  60                rts     
  102  34:96D8            .put_he:
  103  34:96D8  A9 A6             lda #$a6
  104  34:96DA  D0 DF             bne .put_only
  105  34:96DC            .force_linefeed:
  106  34:96DC  A5 18             lda <.cchLine
  107  34:96DE  0A                asl a
  108  34:96DF  20 C3 96          jsr .do_feed    
  109  34:96E2  D0 DA             bne .next       ;always satisfied
  110  34:96E4            .space_run:
  111  34:96E4  68                pla
  112  34:96E5  E8                inx
  113  34:96E6  98                tya
  114  34:96E7  18                clc
  115  34:96E8  7D D7 7A          adc .pString,x
  116  34:96EB  A8                tay
  117  34:96EC  4C C0 96          jmp .next_nopop
  118  34:96EF            .codeBounds:
  119                                                             ;code (after subtracted by #$29 )
  120  34:96EF  0F                .db $0f                 ;00-0e  +66 06 がぎぐげござじずぜぞだぢづでど (29 => 8f)
  121  34:96F0  14                .db $14                 ;0f-13  +6b 0b ばびぶべぼ 12+89 (38 => a3)
  122  34:96F1  19                .db $19                 ;14-18  +66 06 ぱぴぷぺぽ 17+89 (3d => a3)
  123  34:96F2  1A                .db $1a                 ;19-19  +8a 2a ヴ (42 => cc)
  124  34:96F3  29                .db $29                 ;1a-28  +8c 2c ガギグゲゴザジズゼゾダヂヅデト (43 => cf)
  125  34:96F4  2C 2D 2E          .db $2c,$2d,$2e ;29-2d  +91 31 バビブベボ 2c+89 (ヘ: => a6)
  126  34:96F7  31 32 33          .db $31,$32,$33 ;2e-32  +8c 2c パピプペポ 31+89
  127  34:96FA            .offsetFlags:
  128                             ;bit0 indicates 1='Handakuten'
  129                             ;offset 0 is special;means 'he'
  130                             ;higher bits are offset,subtracted by $60
  131  34:96FA  0C                .db $0c
  132  34:96FB  16                .db $16
  133  34:96FC  0D                .db $0d
  134  34:96FD  54                .db $54
  135  34:96FE  58                .db $58
  136  34:96FF  62 00 62          .db $62,$00,$62
  137  34:9702  59 01 59          .db $59,$01,$59
  138                             ;9719
  139                             .endif  ;ENABLE_strToTileArray
  140                     ;9754
  141                     ;======================================================================================================
  142                     ;$96f8:
  143                     ;
  144                     ;$34:9754 initTileArrayStorage
  145                             INIT_PATCH $34,$9754,$9777
                0034              .bank   $34
                9754              .org    $9754
       34:9754                    .ds             (($9777) - ($9754))
                9754              .org    $9754
  146  34:9754            initTileArrayStorage:
  147  34:9754  A2 72             ldx #HIGH(TILE_ARRAY_BASE)      ;#$72
  148  34:9756  8E 4F 00          stx $4f
  149  34:9759  8E C1 7A          stx $7ac1
  150  34:975C  A2 20             ldx #LOW(TILE_ARRAY_BASE)       ;#$20   ;original: 00
  151  34:975E  8E 4E 00          stx $4e
  152  34:9761  8E C0 7A          stx $7ac0
  153  34:9764  A9 FF             lda #$ff
  154  34:9766  A2 00             ldx #0
  155  34:9768            .loop:
  156  34:9768  9D 00 72          sta $7200,x     ;TILE_ARRAY_BASEによらず常に7200-73FFを初期化
  157  34:976B  9D 00 73          sta $7300,x
  158  34:976E  E8                inx
  159  34:976F  D0 F7             bne .loop
  160  34:9771  60                rts
  161                     ;======================================================================================================
  162                             INIT_PATCH $35,$a609,$a66c
                0035              .bank   $35
                A609              .org    $a609
       35:A609                    .ds             (($a66c) - ($a609))
                A609              .org    $a609
  163  35:A609            loadString:
  164                     ;$35:a609 loadString
  165                     ;       [in] u16 $18 : tableBase
  166                     ;       [in] u8 A : index
  167                     ;       [in,out] u8 X : destOffset
  168           0018      .pTableBase = $18
  169           0018      .offset = $18
  170           001A      .index = $1a
  171                     ;----------------------------
  172  35:A609  85 1A             sta <.index
  173  35:A60B  8A                txa
  174  35:A60C  48                pha
  175  35:A60D  20 60 FD          jsr get2byteAtBank18    ;get2byteAtBank18($1a) $fd60
  176  35:A610  68                pla
  177  35:A611  AA                tax
  178  35:A612  A5 19             lda <.offset+1
  179  35:A614  48                pha
  180  35:A615  29 3F             and #$3f
  181  35:A617  09 80             ora #$80
  182  35:A619  85 19             sta <.offset+1
  183  35:A61B  68                pla
  184  35:A61C  20 43 FD          jsr shiftRight6 ;$fd43
  185  35:A61F  18                clc
  186  35:A620  69 0C             adc #$0c
  187  35:A622  4C 4A FD          jmp loadStringWorker    ;$3f:fd4a
  188                     ;$a66c:
  189                     ;======================================================================================================
  190  35:A625            itoa_8:
  191                     ;       [in] u8 a : value
  192                     ;       [out] u8 $1a[3] : tileArray (higher first)
  193           001A      .result = $1a
  194  35:A625  A2 00             ldx #0
  195  35:A627            .digit_loop:    
  196  35:A627  A0 FF                     ldy #$ff
  197  35:A629                    .subtraction_loop:      
  198  35:A629  C8                                iny
  199  35:A62A  38                                sec
  200  35:A62B  FD 50 A6                          sbc .digits,x
  201  35:A62E  B0 F9                             bcs .subtraction_loop
  202  35:A630  7D 50 A6                  adc .digits,x
  203  35:A633  48                        pha
  204  35:A634  98                        tya
  205  35:A635  D0 04                     bne .has_digit
  206  35:A637  A9 FF                             lda #$ff
  207  35:A639  D0 02                             bne .store
  208  35:A63B                    .has_digit:
  209  35:A63B  09 80                             ora #$80
  210  35:A63D                    .store:
  211  35:A63D  95 1A                     sta <.result,x
  212  35:A63F  68                        pla
  213  35:A640  E8                        inx
  214  35:A641  E0 03                     cpx #3
  215  35:A643  D0 E2             bne .digit_loop
  216  35:A645  A5 1C             lda <.result+2
  217  35:A647  C9 FF             cmp #$ff
  218  35:A649  D0 04             bne .return
  219  35:A64B  A9 80             lda #$80
  220  35:A64D  85 1C             sta <.result+2
  221  35:A64F            .return:        
  222  35:A64F  60                rts
  223  35:A650  64 0A 01  .digits .db     100,10,1
  224                     ;======================================================================================================
  225                             RESTORE_PC      ff3_string_begin
                0000              .bank   BANK(ff3_string_begin)
                8000              .org    ff3_string_begin
#[3]   ff3_hack_master.asm
#[4]   ff3_command_string.asm
   29                             .include "ff3_command_string.asm"
    1                     ; ff3_command_string.asm
    2                     ;
    3                     ;description:
    4                     ;       defines extra strings
    5                     ;
    6                     ;version:
    7                     ;       0.05 (2006-11-09)
    8                     ;
    9                     ;======================================================================================================
   10  00:8000            ff3_command_string_begin:
   11                             ;extra strings (reuse free space)
   12                             FILEORG $3cbbd
                001E              .bank   ($3cbbd) >> 13
                CBBD              .org    ($8000 | (($3cbbd) & $7fff))
   13  1E:CBBD                    cmdstr_provoke_fail:
   14  1E:CBBD  8A 8B 9C                  .db     $8a,$8b,$9c,$9f,$94,$b3,$9e,$8f,$7c,$99,$c4,$00
       1E:CBC0  9F 94 B3  
       1E:CBC3  9E 8F 7C  
       1E:CBC6  99 C4 00  
   15                                     
   16                             ;FILEORG        $3de12
   17  1E:CBC9                    cmdstr_provoke_success:
   18  1E:CBC9  9C 90 29                  .db $9c,$90,$29,$8e,$93,$7c,$99,$c4,$00
       1E:CBCC  8E 93 7C  
       1E:CBCF  99 C4 00  
   19                             
   20                             FILEORG $3a4f4
                001D              .bank   ($3a4f4) >> 13
                A4F4              .org    ($8000 | (($3a4f4) & $7fff))
   21  1D:A4F4                    cmdstr_provoke: ;ちょうはつ
   22  1D:A4F4  9A 7F 8C                  .db $9a,$7f,$8c,$a3,$9b,$00     ;
       1D:A4F7  A3 9B 00  
   23  1D:A4FA                    cmdstr_disordered_shot: ;みだれうち
   24  1D:A4FA  A9 33 B3                  .db $a9,$33,$b3,$8c,$9a,$00
       1D:A4FD  8C 9A 00  
   25  1D:A500                    cmdstr_abyss:                   ;あんこく
   26  1D:A500  8A B6 93                  .db $8a,$b6,$93,$91,$00
       1D:A503  91 00     
   27  1D:A505                    cmdstr_raid:    ;ふみこむ
   28  1D:A505  A5 A9 93                  .db $a5,$a9,$93,$aa,$00
       1D:A508  AA 00     
   29  1D:A50A                    cmdstr_counter_message: ;カウンター!!
   30  1D:A50A  CF CC F6                  .db $cf,$cc,$f6,$d9,$c2,$c4,$c4,$00
       1D:A50D  D9 C2 C4  
       1D:A510  C4 00     
   31  1D:A512                    cmdstr_abyss_message:   ;やみのちからが からだをむしばむ
   32  1D:A512  AD A9 A2                  .db $ad,$a9,$a2,$9a,$8f,$b0,$29,$ff,$8f,$b0,$33,$7b,$aa,$95,$38,$aa,$00
       1D:A515  9A 8F B0  
       1D:A518  29 FF 8F  
       1D:A51B  B0 33 7B  
       1D:A51E  AA 95 38  
       1D:A521  AA 00     
   33  1D:A523                    cmdstr_raid_message:    ;てきのはんげきをうけた!
   34  1D:A523  9C 90 A2                  .db $9c,$90,$a2,$a3,$b6,$2c,$90,$7b,$8c,$92,$99,$c4,$00
       1D:A526  A3 B6 2C  
       1D:A529  90 7B 8C  
       1D:A52C  92 99 C4  
       1D:A52F  00        
   35                             FILEORG $3dabd  ;string for command 0A (original:$3dafd)
                001E              .bank   ($3dabd) >> 13
                DABD              .org    ($8000 | (($3dabd) & $7fff))
   36                     
   37                             ;----------------------------------------------------------------------------------------       
   38           0018              .bank   stringPtrTable >> 13
   39           8C40              .org    $8000 + (stringPtrTable & $7fff) + $0c40; + ($87 * 2)
   40                             
   41  18:8C40                    battleMessageOffsets:
   42           DE21      .nullstr = $de21
   43           0057      EXTRA_BATTLE_MESSAGE_BEGIN = $57        ;87d
   44           8C54              .org    battleMessageOffsets + ($0a * 2)        ;string ptr for command 0A
   45  18:8C54  F4 A4                     .dw (cmdstr_provoke & $ffff)
   46           8CEE              .org    battleMessageOffsets + (EXTRA_BATTLE_MESSAGE_BEGIN * 2) ;message
   47  18:8CEE  C9 CB                     .dw (cmdstr_provoke_success & $ffff)            ;57
   48  18:8CF0  BD CB                     .dw     (cmdstr_provoke_fail & $ffff);58
   49  18:8CF2  0A A5                     .dw (cmdstr_counter_message & $ffff); 59
   50  18:8CF4  FA A4                     .dw (cmdstr_disordered_shot & $ffff); 5a
   51  18:8CF6  00 A5                     .dw     (cmdstr_abyss & $ffff)  ;5b
   52  18:8CF8  05 A5                     .dw (cmdstr_raid & $ffff)       ;5c
   53  18:8CFA  12 A5                     .dw     (cmdstr_abyss_message & $ffff)  ;5d
   54  18:8CFC  23 A5                     .dw (cmdstr_raid_message & $ffff)       ;5e
   55                                     ;5f = "HPかいふく!"
   56                     ;------------------------------------------------------------------------------------------------------
   57           0057              .rsset EXTRA_BATTLE_MESSAGE_BEGIN
   58           0057      EXMSG_PROVOKE_SUCCESS   .rs 1
   59           0058      EXMSG_PROVOKE_FAIL              .rs 1
   60           0059      EXMSG_COUNTER                   .rs 1
   61           005A      EXMSG_DISORDERED_SHOT   .rs 1
   62           005B      EXMSG_ABYSS                             .rs 1
   63           005C      EXMSG_RAID                              .rs 1
   64           005D      EXMSG_ABYSS_MESSAGE             .rs 1
   65           005E      EXMSG_RAID_MESSAGE              .rs 1
   66                     ;======================================================================================================
   67                             RESTORE_PC ff3_command_string_begin
                0000              .bank   BANK(ff3_command_string_begin)
                8000              .org    ff3_command_string_begin
#[3]   ff3_hack_master.asm
#[4]   ff3_rand.asm
   30                             .include "ff3_rand.asm"
    1                     ; ff3_rand.asm
    2                     ;
    3                     ; description:
    4                     ;       small patch for pseudorandom generator for battle
    5                     ;
    6                     ; version:
    7                     ;       0.01 (2006-10-12)
    8                     ;
    9                     ;======================================================================================================
   10  00:8000            ff3_rand_begin:
   11           003F              .bank   $3f
   12           FC27              .org    $fc27
   13  3F:FC27            initBattleRandom:
   14           FC37              .org    $fc37
   15                             
   16  3F:FC37  69 0B             adc #RANDOM_LCG_A       ;original:3
   17                     ;======================================================================================================
   18                             RESTORE_PC ff3_rand_begin
                0000              .bank   BANK(ff3_rand_begin)
                8000              .org    ff3_rand_begin
#[3]   ff3_hack_master.asm
#[4]   ff3_fix.asm
   31                             .include "ff3_fix.asm"
    1                     ; ff3_fix.asm
    2                     ;
    3                     ;description:
    4                     ;       small fixes
    5                     ;
    6                     ;version:
    7                     ;       0.06 (2006-11-07)
    8                     ;
    9                     ;======================================================================================================
   10  00:8000            ff3_fix_begin:
   11                     
   12           0001              .ifdef FIX_ATTR_BOOST
   13           0031                      .bank   $31
   14           AB62                      .org    $ab62
   15  31:AB62                    resetAttributeBoostAndFormation:
   16  31:AB62  29 01                     and #$01        ;original : $f9 (this improperly keeps previous attr-boost value,seems to be bug)
   17           AF18                      .org    $af18
   18  31:AF18                    storeAttributeBoostAndFormation:
   19  31:AF18  29 F9                     and #$f9        ;original: 1 (this masks attr-boost out, seems to be bug)
   20                             .endif  ;FIX_ATTR_BOOST
   21                     ;------------------------------------------------------------------------------------------------------
   22           0001              .ifdef FIX_HP_GROW
   23           0035                      .bank   $35
   24           BEC3                      .org    $bec3
   25  35:BEC3            prize_doLevelUp:
   26           0032      .lvBefore = $32
   27           0024      .hpGrowth = $24
   28           0057      .pBaseParam = $57
   29                             ;a = lvAfter
   30                             ;x = lvAfter
   31                             ;y = offset01 (lv)
   32  35:BEC3  91 57                     sta [.pBaseParam],y
   33  35:BEC5  0A                        asl a
   34  35:BEC6  85 24                     sta <.hpGrowth
   35  35:BEC8  A9 14                     lda #$14
   36  35:BECA  20 88 9B                  jsr setYtoOffsetOf
   37  35:BECD  B1 57                     lda [.pBaseParam],y     ;vit
   38  35:BECF  4A                        lsr a
   39  35:BED0  20 64 A5                  jsr getSys1Random       ;a564 (y is unchanged)
   40  35:BED3  18                        clc
   41  35:BED4  71 57                     adc [.pBaseParam],y
   42                                     ;carry should be cleared (99+48)
   43  35:BED6  18                        clc
   44  35:BED7  65 24                     adc <.hpGrowth
   45  35:BED9  85 24                     sta <.hpGrowth
   46  35:BEDB  A9 00                     lda #0
   47  35:BEDD  69 00                     adc #0
   48  35:BEDF  48                        pha
   49  35:BEE0  A9 0E                     lda #$0e
   50  35:BEE2  20 88 9B                  jsr setYtoOffsetOf      ;9b88
   51  35:BEE5  18                        clc
   52  35:BEE6  B1 57                     lda [.pBaseParam],y     ;maxHp
   53  35:BEE8  65 24                     adc <.hpGrowth
   54  35:BEEA  91 57                     sta [.pBaseParam],y
   55  35:BEEC  C8                        iny
   56  35:BEED  68                        pla
   57  35:BEEE  71 57                     adc [.pBaseParam],y
   58  35:BEF0  91 57                     sta [.pBaseParam],y
   59  35:BEF2  88                        dey     ;set y to maxHp.low
   60  35:BEF3  EA                        nop
   61  35:BEF4  EA                        nop
   62  35:BEF5  EA                        nop
   63                     ;$bef6:         
   64                             .endif  ;FIX_HP_GROW
   65                     ;------------------------------------------------------------------------------------------------------
   66           0001              .ifdef FIX_ITEM99
   67           0035                      .bank   $35
   68           BFC7                      .org    $bfc7
   69  35:BFC7                    branchIfItemOverflow:
   70  35:BFC7  B0 25                     bcs $bfee
   71                             .endif  ;FIX_ITEM99
   72                     ;------------------------------------------------------------------------------------------------------
   73           0000              .ifdef FIX_255X_DAMAGE
   88                             .endif ;FIX_255X_DAMAGE
   89                     ;------------------------------------------------------------------------------------------------------
   90           0001              .ifdef FIX_DUNGEON_FLOOR_SAVE
   91           003F                      .bank   $3f
   92           E299                      .org    $e299
   93  3F:E299                    dungeon_checkStackPointer:
   94  3F:E299  BA                        tsx
   95  3F:E29A  E0 4B                     cpx #$4b        ;original:$20
   96                             .endif ;FIX_DUNGEON_FLOOR_SAVE
   97                     ;======================================================================================================
   98                             RESTORE_PC ff3_fix_begin
                0000              .bank   BANK(ff3_fix_begin)
                8000              .org    ff3_fix_begin
#[3]   ff3_hack_master.asm
   32                     
   33           0001              .ifdef BETA
#[4]   ff3_enemy_target.asm
   34                                     .include "ff3_enemy_target.asm" ;save
    1                     ; ff3_enemy_target.asm
    2                     ;
    3                     ;description:
    4                     ;       replaces enemy's action related codes
    5                     ;
    6                     ;version:
    7                     ;       0.04 (2007-08-17)
    8                     ;
    9                     ;======================================================================================================
   10  00:8000            ff3_enemy_target_begin:
   11                             INIT_PATCH $31,$a732,$a8c8
                0031              .bank   $31
                A732              .org    $a732
       31:A732                    .ds             (($a8c8) - ($a732))
                A732              .org    $a732
   12                             
   13  31:A732            battleFunction_02:
   14  31:A732            decideEnemyAction:
   15                     ;[in]
   16           005B      .pPlayer = $5b
   17           7BE2      .barrierChangeFlag = $7be2
   18                     ;groupToIdMap = $7d6b
   19           7DA7      .indexToGroupMap = $7da7
   20           7ED8      .battleMode = $7ed8
   21                     ;[in,out]
   22           78B7      .sequence = $78b7
   23                     ;[local]
   24           0053      .confused = $53
   25           0024      .pEnemy = $24
   26           004A      .iEnemy = $4a
   27                     ;-------------------------------------------------
   28  31:A732  A2 00             ldx #0
   29  31:A734  86 69             stx <$69
   30  31:A736            .for_each_enemy:
   31  31:A736  86 4A                     stx <.iEnemy
   32  31:A738  86 18                     stx <$18
   33  31:A73A  A9 40                     lda #$40
   34  31:A73C  85 1A                     sta <$1a
   35                                     INIT16 <$20,$7675
       31:A73E  A9 75             lda #LOW($7675)
       31:A740  85 20             sta <$20
       31:A742  A9 76             lda #HIGH($7675)
       31:A744  85 21             sta <$20+1
   36  31:A746  20 9D BE                  jsr calcDataAddress
   37  31:A749  A5 1C                     lda <$1c
   38  31:A74B  85 24                     sta <.pEnemy
   39  31:A74D  A5 1D                     lda <$1d
   40  31:A74F  85 25                     sta <.pEnemy+1
   41  31:A751  20 C8 A8                  jsr getActionMode       ;$a8c8  ;get2c
   42  31:A754  29 EF                     and #$ef        ;clear action mode
   43  31:A756  91 24                     sta [.pEnemy],y
   44  31:A758  A9 00                     lda #0
   45  31:A75A  A0 2F                     ldy #$2f        ;target
   46  31:A75C  91 24                     sta [.pEnemy],y
   47  31:A75E  C8                        iny                     ;target mode
   48  31:A75F  91 24                     sta [.pEnemy],y
   49  31:A761  85 53                     sta <.confused
   50  31:A763  AA                        tax
   51  31:A764  A0 01                     ldy #1
   52  31:A766  B1 24                     lda [.pEnemy],y
   53  31:A768  29 E8                     and #$e8        ;dead|stone|toad|minimum
   54  31:A76A  F0 05                     beq .check_status_2nd
   55                                             ;can't move
   56  31:A76C  A9 00                             lda #0
   57  31:A76E  4C 22 A8                          jmp .next               ;a8b9
   58  31:A771                    .check_status_2nd:
   59  31:A771  C8                        iny
   60  31:A772  B1 24                     lda [.pEnemy],y
   61  31:A774  29 20                     and #STATUS_CONFUSED    ;$20
   62  31:A776  D0 09                     bne .status_confused
   63  31:A778  29 C0                     and #STATUS_SLEEPING | STATUS_PARALYZED ;$c0
   64  31:A77A  F0 0B                     beq .status_good
   65                             ;paralyzed|sleeping
   66  31:A77C  A9 01                             lda #1
   67  31:A77E  4C 22 A8                          jmp .next               ;a8b9
   68  31:A781                    .status_confused:
   69  31:A781  A9 80                     lda #$80
   70  31:A783  85 53                     sta <.confused
   71  31:A785  D0 34                     bne .select_action      ;always satisfied
   72  31:A787                    .status_good:
   73  31:A787  AD D8 7E                  lda .battleMode
   74  31:A78A  30 2F                     bmi .select_action      ;a7c5
   75  31:A78C  4A                        lsr a
   76  31:A78D  B0 2C                     bcs .select_action      ;a7c5   if (($7ed8 & 1) != 0) $a7c5; //bne
   77                                             ;
   78  31:A78F  A0 00                             ldy #0
   79           0028      .lv = $28
   80  31:A791                            .cache_lv:
   81  31:A791  B1 5B                                     lda [.pPlayer],y        ;lv
   82  31:A793  95 28                                     sta <.lv,x
   83  31:A795  E8                                        inx
   84  31:A796  98                                        tya
   85  31:A797  18                                        clc
   86  31:A798  69 40                                     adc #$40
   87  31:A79A  A8                                        tay
   88  31:A79B  D0 F4                                     bne .cache_lv
   89  31:A79D  B1 24                     lda [.pEnemy],y ;y=0
   90  31:A79F  18                        clc
   91  31:A7A0  69 0F                     adc #15
   92  31:A7A2  48                        pha
   93  31:A7A3  20 EC A8                  jsr $a8ec       ;getLeastLvInPlayerParty
   94  31:A7A6  68                        pla
   95  31:A7A7  C5 28                     cmp <.lv
   96  31:A7A9  B0 10                     bcs .select_action
   97                                             ;try to escape
   98  31:A7AB  A9 64                             lda #100
   99  31:A7AD  20 B4 BE                          jsr b31_getBattleRandom ;beb4
  100  31:A7B0  A0 22                             ldy #$22
  101  31:A7B2  D1 24                             cmp [.pEnemy],y ;evade
  102  31:A7B4  90 05                             bcc .select_action
  103  31:A7B6  A9 06                                     lda #ACTION_ESCAPE
  104  31:A7B8  4C 22 A8                                  jmp .next
  105  31:A7BB                    .select_action: ;$a7c5
  106  31:A7BB  A6 4A                     ldx <.iEnemy
  107  31:A7BD  BD A7 7D                  lda .indexToGroupMap,x  ;2007-08-21
  108  31:A7C0  AA                        tax
  109  31:A7C1  BD 6B 7D                  lda groupToEnemyIdMap,x
  110  31:A7C4  C9 D2                     cmp #$d2        ;d2:まどうしハイン
  111  31:A7C6  F0 04                     beq .check_barrier_change
  112  31:A7C8  C9 B4                     cmp #$b4        ;b4:アモン
  113  31:A7CA  D0 13                     bne .check_special
  114  31:A7CC                    .check_barrier_change:
  115  31:A7CC  AD E2 7B                          lda .barrierChangeFlag
  116  31:A7CF  C9 02                             cmp #2
  117  31:A7D1  D0 0C                             bne .check_special
  118  31:A7D3  20 C8 A8                                  jsr getActionMode       ;$a8c8
  119  31:A7D6  09 10                                     ora #$10
  120  31:A7D8  91 24                                     sta [.pEnemy],y
  121  31:A7DA  A9 4D                                     lda #$4d        ;4d:barrier-change
  122  31:A7DC  4C 22 A8                                  jmp .next
  123  31:A7DF                    .check_special: ;a7e9
  124  31:A7DF  A0 37                     ldy #BP_OFFSET_SPECIAL_RATE     ;$37
  125  31:A7E1  B1 24                     lda [.pEnemy],y
  126  31:A7E3  F0 09                     beq .decide_to_fight
  127  31:A7E5  A9 64                             lda #100
  128  31:A7E7  20 B4 BE                          jsr b31_getBattleRandom
  129  31:A7EA  D1 24                             cmp [.pEnemy],y
  130  31:A7EC  90 0F                             bcc .select_special
  131  31:A7EE                    .decide_to_fight:       ;a7fd
  132                                     ;new decideEnemyTarget implementation has proper handling for confused enemy
  133  31:A7EE                    .select_fight_target:
  134                                     ;select valid target (must not be dead/stone/jumping)
  135                                     ;if there is no valid target,then decide to action0 (that do nothing)
  136  31:A7EE  A9 04                     lda #ACTION_FIGHT       ;4
  137                                     ;pha
  138  31:A7F0  85 46                     sta <$46
  139  31:A7F2  A9 00                     lda #0
  140  31:A7F4  20 38 A9                  jsr decideEnemyTarget   ;[out] a = target bit
  141  31:A7F7  F0 44                     beq .fail_to_target
  142                                     ;pla
  143  31:A7F9  A9 04                     lda #ACTION_FIGHT
  144  31:A7FB  D0 25                     bne .next
  145  31:A7FD                    .select_special:        ;$a85f
  146  31:A7FD  20 C8 A8                  jsr getActionMode       ;$a8c8  ;get24_2c
  147  31:A800  09 10                     ora #$10
  148  31:A802  91 24                     sta [.pEnemy],y
  149  31:A804  AD D8 7E                  lda .battleMode
  150  31:A807  10 27                     bpl .select_randomly
  151                             ;sequencial     
  152  31:A809  AD B7 78                          lda .sequence
  153  31:A80C  18                                clc
  154  31:A80D  69 37                             adc #$37
  155  31:A80F  20 48 A8                          jsr .setTarget
  156  31:A812  D0 29                             bne .fail_to_target     ;$a8ad
  157  31:A814  AC B7 78                          ldy .sequence
  158  31:A817  C8                                iny
  159  31:A818  C0 09                             cpy #9
  160  31:A81A  D0 02                             bne .update_sequence
  161  31:A81C  A0 01                                     ldy #1
  162  31:A81E                            .update_sequence:
  163  31:A81E  8C B7 78                          sty .sequence
  164  31:A821                    .id_and_next:
  165  31:A821  8A                        txa
  166  31:A822                    .next:  ;$a8b9
  167  31:A822  A0 2E                     ldy #$2e
  168  31:A824  91 24                     sta [.pEnemy],y
  169  31:A826  A6 4A                     ldx <.iEnemy
  170  31:A828  E8                        inx
  171  31:A829  E0 08                     cpx #8
  172  31:A82B  F0 2B                     beq .finish     ;$a8c8  ;get24_2c
  173  31:A82D  4C 36 A7                  jmp .for_each_enemy
  174                                     ;bne .for_each_enemy    ;$a8c8;.finish
  175                                     ;       jmp $a8c8       ;finish
  176  31:A830                    .select_randomly:       ;$a896
  177  31:A830  A9 07                             lda #7
  178  31:A832  20 B4 BE                          jsr b31_getBattleRandom
  179  31:A835  18                                clc
  180  31:A836  69 38                             adc #$38
  181  31:A838  20 48 A8                          jsr .setTarget  ;if failed, ZF = 0
  182  31:A83B  F0 E4                             beq .id_and_next
  183  31:A83D                    .fail_to_target:
  184  31:A83D  20 C8 A8                          jsr getActionMode       ;$a8c8  ;get24_2c
  185  31:A840  29 EF                             and #$ef
  186  31:A842  91 24                             sta [.pEnemy],y
  187  31:A844  A9 00                             lda #0
  188  31:A846  F0 DA                             beq .next
  189  31:A848                    .setTarget:
  190                             ;a = offset to selected command (in list)
  191                             ;[out] a : = $69, x : decided command
  192  31:A848  A8                                tay
  193  31:A849  B1 24                             lda [.pEnemy],y
  194                                             ;and #$7f
  195                                             ;pha
  196  31:A84B  B1 24                             lda [.pEnemy],y
  197  31:A84D  48                                pha
  198  31:A84E  20 1B A9                          jsr decideEnemyActionTarget     ;a91b [out] $69 : failed
  199  31:A851  68                                pla
  200  31:A852  29 7F                             and #$7f
  201  31:A854  AA                                tax
  202  31:A855  A5 69                             lda <$69        ;failed flag
  203  31:A857  60                                rts
  204  31:A858            .finish:
  205  31:A858  4C C8 A8          jmp getActionMode       ;$a8c8
  206                     ;======================================================================================================
  207                     ;ex battle function
  208  31:A85B            pickRandomTargetFromEnemyParty:
  209                     ;[in]
  210                     ;[out] u8 $62 : targetbit; x = index
  211           0062      .targetBit = $62
  212           0064      .candidateCount = $64
  213           0070      .pTarget = $70
  214  31:A85B  A9 08             lda #8
  215  31:A85D  A2 04             ldx #4
  216  31:A85F  20 AE A9          jsr buildTargetCandidateList
  217                     ;       jsr verifyCandidatesByStatusCache
  218                     ;verifyCandidatesByStatusCache:
  219           00E0      .targetStatusCache = $e0
  220           0062      .candidateBits = $62
  221  31:A862  A2 07             ldx #7
  222  31:A864  A5 62             lda <.candidateBits
  223  31:A866  48                pha
  224  31:A867            .verify:
  225  31:A867  68                        pla
  226  31:A868  0A                        asl a
  227  31:A869  48                        pha
  228  31:A86A  90 13                     bcc .verify_next
  229                     ;marked as candidate. verify status cache
  230  31:A86C  8A                        txa
  231  31:A86D  0A                        asl a
  232  31:A86E  A8                        tay
  233  31:A86F  B9 E0 00                  lda .targetStatusCache,y
  234  31:A872  29 E8                     and #$e8        ;dead|stone|toad|minimum
  235  31:A874  F0 09                     beq .verify_next
  236                     
  237  31:A876  C6 64                             dec <.candidateCount
  238  31:A878  A5 62                             lda <.candidateBits
  239  31:A87A  20 2C FD                          jsr clearTargetBit
  240  31:A87D  85 62                             sta <.candidateBits
  241  31:A87F                    .verify_next:
  242  31:A87F  CA                        dex
  243  31:A880  10 E5                     bpl .verify
  244  31:A882  68                        pla     ;dispose
  245                     
  246  31:A883  A5 64             lda <.candidateCount
  247  31:A885  F0 25             beq .no_valid_target_there
  248  31:A887  20 D6 A9                  jsr pickOneOfCandidate
  249                                     ;convert target bit to index
  250  31:A88A  A5 62                     lda <.targetBit
  251  31:A88C  A2 07                     ldx #7
  252  31:A88E                    .to_index:
  253  31:A88E  4A                                lsr a
  254  31:A88F  B0 03                             bcs .calc_addr
  255  31:A891  CA                                dex
  256  31:A892  10 FA                             bpl .to_index
  257  31:A894                    .calc_addr:
  258  31:A894  8A                        txa
  259  31:A895  48                        pha
  260                                     
  261  31:A896  86 1A                     stx <$1a        ;index
  262  31:A898  A9 40                     lda #$40
  263  31:A89A  20 D6 FC                  jsr mul_8x8
  264                                     ;$1a,1b = offset to enemy
  265  31:A89D  18                        clc
  266  31:A89E  A5 1A                     lda <$1a
  267  31:A8A0  69 75                     adc #$75
  268  31:A8A2  85 70                     sta <.pTarget
  269  31:A8A4  A5 1B                     lda <$1b
  270  31:A8A6  69 76                     adc #$76
  271  31:A8A8  85 71                     sta <.pTarget+1
  272                                     
  273  31:A8AA  68                        pla
  274  31:A8AB  AA                        tax
  275  31:A8AC            .no_valid_target_there:
  276  31:A8AC  60                rts
  277                     ;------------------------------------------------------------------------------------------------------
  278                             VERIFY_PC $a8c8
       31:A8AD                    .verify_pc_00013:
                0000              .if (.verify_pc_00013 > $a8c8)
                                  .endif
  279                     ;$a8c8
  280                     ;======================================================================================================
  281                             ;.org   $a91b
  282                             INIT_PATCH $31,$a91b,$a9f7
                0031              .bank   $31
                A91B              .org    $a91b
       31:A91B                    .ds             (($a9f7) - ($a91b))
                A91B              .org    $a91b
  283  31:A91B            decideEnemyActionTarget:
  284           0046      .actionId = $46
  285           7400      .actionParams = $7400
  286  31:A91B  85 46             sta <.actionId
  287  31:A91D  29 7F             and #$7f
  288  31:A91F  85 18             sta <$18
  289  31:A921  A9 08             lda #8
  290  31:A923  85 1A             sta <$1a
  291                             INIT16 <$20,$98c0
       31:A925  A9 C0             lda #LOW($98c0)
       31:A927  85 20             sta <$20
       31:A929  A9 98             lda #HIGH($98c0)
       31:A92B  85 21             sta <$20+1
  292  31:A92D  A9 18             lda #$18
  293  31:A92F  A8                tay
  294  31:A930  A2 00             ldx #0
  295  31:A932  20 A6 FD          jsr loadTo7400Ex        ;fda6
  296  31:A935  AD 05 74          lda .actionParams+5
  297                             ;fall through
  298  31:A938            decideEnemyTarget:
  299           0024      .pEnemy = $24
  300           0053      .confused = $53 ;$80:confused
  301                     ;[out]
  302           0069      .failed = $69
  303                     ;local
  304           0046      .actionId = $46
  305           0062      .targetBits = $62
  306           0063      .targetFlags = $63
  307           0064      .candidateCount = $64
  308  31:A938  48                pha
  309  31:A939  05 53             ora <.confused  ;eor is ideal, but some enemy specials are intended to target enemy party even when confused
  310  31:A93B  10 14             bpl .select_from_player_party
  311  31:A93D            .select_from_enemy_party:
  312  31:A93D  A9 08                     lda #8
  313  31:A93F  A2 04                     ldx #4
  314  31:A941  20 AE A9                  jsr buildTargetCandidateList
  315  31:A944  A5 64                     lda <.candidateCount
  316  31:A946  F0 5A                     beq .no_valid_target_there
  317  31:A948  A2 FF                     ldx #$ff
  318  31:A94A  68                        pla
  319  31:A94B  29 40                     and #TARGET_MULTIPLE    ;$40
  320  31:A94D  09 80                     ora #TARGET_ENEMY_PARTY ;$80
  321  31:A94F  30 10                     bmi .set_target
  322  31:A951            .select_from_player_party:
  323                                     ;build candidate list
  324  31:A951  A9 04                     lda #4
  325  31:A953  A2 00                     ldx #0
  326  31:A955  20 AE A9                  jsr buildTargetCandidateList
  327  31:A958  A5 64                     lda <.candidateCount
  328  31:A95A  F0 46                     beq .no_valid_target_there
  329  31:A95C  A2 F0                     ldx #$f0
  330  31:A95E  68                        pla
  331  31:A95F  29 40                     and #TARGET_MULTIPLE    ;$40
  332  31:A961            .set_target:
  333  31:A961  85 63             sta <.targetFlags
  334  31:A963  24 63             bit <.targetFlags
  335  31:A965  70 2D             bvs .target_multiple
  336  31:A967  A5 46             lda <.actionId
  337  31:A969  30 29             bmi .target_multiple
  338  31:A96B            .target_single:
  339           0001              .ifdef TAG_PROVOKE_EFFECT
  340  31:A96B  A0 1F                     ldy #X_BP_OFFSET_TYPE   ;$1f    ;enchanted status(lefthand)
  341  31:A96D  B1 24                     lda [.pEnemy],y
  342  31:A96F  29 1F                     and #$1f
  343  31:A971  F0 1C                     beq .do_usual
  344  31:A973  38                                sec
  345  31:A974  E9 01                             sbc #1
  346  31:A976  91 24                             sta [.pEnemy],y
  347  31:A978  29 0F                             and #$0f
  348  31:A97A  D0 0A                             bne .change_target
  349                                                     ;clear effects
  350  31:A97C  91 24                                     sta [.pEnemy],y
  351  31:A97E  A0 28                                     ldy #$28
  352  31:A980  A9 05                                     lda #5
  353  31:A982  91 24                                     sta [.pEnemy],y ;critical rate
  354  31:A984  D0 09                                     bne .do_usual
  355  31:A986                            .change_target:
  356  31:A986  88                                dey
  357  31:A987  B1 24                             lda [.pEnemy],y
  358  31:A989  F0 04                             beq .do_usual
  359  31:A98B  85 62                             sta <.targetBits
  360  31:A98D  D0 07                             bne .store_result
  361  31:A98F                    .do_usual:
  362                             .endif  ;TAG_PROVOKE_EFFECT
  363  31:A98F  20 D6 A9                  jsr pickOneOfCandidate
  364  31:A992  D0 02                     bne .store_result       ;always (a = targetbit
  365  31:A994            .target_multiple:
  366  31:A994  86 62                     stx <.targetBits
  367  31:A996            .store_result:
  368  31:A996  A0 30             ldy #BP_OFFSET_TARGET_FLAG      ;$30
  369  31:A998  A5 63             lda <.targetFlags
  370  31:A99A  91 24             sta [.pEnemy],y
  371  31:A99C  88                dey
  372  31:A99D  A5 62             lda <.targetBits
  373  31:A99F  91 24             sta [.pEnemy],y
  374  31:A9A1  60                rts
  375  31:A9A2            .no_valid_target_there:
  376  31:A9A2  68                pla     ;dispose (actionParam[5] )
  377  31:A9A3  A2 00             ldx #0
  378  31:A9A5  86 62             stx <.targetBits
  379  31:A9A7  86 63             stx <.targetFlags
  380  31:A9A9  E8                inx
  381  31:A9AA  86 69             stx <.failed
  382  31:A9AC  D0 E8             bne .store_result
  383                     ;------------------------------------------------------------------------------------------------------
  384  31:A9AE            buildTargetCandidateList:
  385                     ;[in]
  386                     ;a = count
  387                     ;x = indexOffset
  388           0065      .indexOffset = $65      ;enemy = 4
  389                     ;[out]
  390           0064      .candidateCount = $64
  391           0062      .candidateBits = $62
  392                     ;
  393           0063      .candidateLast = $63
  394  31:A9AE  85 63             sta <.candidateLast
  395  31:A9B0  86 65             stx <.indexOffset
  396  31:A9B2  A2 00             ldx #0
  397  31:A9B4  86 62             stx <.candidateBits
  398  31:A9B6  86 64             stx <.candidateCount
  399  31:A9B8            .build_candidates:
  400  31:A9B8  8A                        txa
  401  31:A9B9  48                        pha
  402  31:A9BA  18                        clc
  403  31:A9BB  65 65                     adc <.indexOffset
  404  31:A9BD  20 F7 A9                  jsr isValidTarget       ;a9f7
  405  31:A9C0  D0 0C                     bne .build_next
  406  31:A9C2  E6 64                             inc <.candidateCount
  407  31:A9C4  68                                pla
  408  31:A9C5  48                                pha
  409  31:A9C6  AA                                tax
  410  31:A9C7  A5 62                             lda <.candidateBits
  411  31:A9C9  20 20 FD                          jsr flagTargetBit
  412  31:A9CC  85 62                             sta <.candidateBits
  413  31:A9CE                    .build_next:
  414  31:A9CE  68                        pla
  415  31:A9CF  AA                        tax
  416  31:A9D0  E8                        inx
  417  31:A9D1  E4 63                     cpx <.candidateLast
  418  31:A9D3  D0 E3                     bne .build_candidates
  419  31:A9D5  60                rts     
  420                     ;------------------------------------------------------------------------------------------------------
  421  31:A9D6            pickOneOfCandidate:
  422           0062      .candidateBits = $62
  423           0064      .candidateCount = $64
  424  31:A9D6  A5 64             lda <.candidateCount
  425  31:A9D8  38                sec 
  426  31:A9D9  E9 01             sbc #1
  427  31:A9DB  20 B4 BE          jsr b31_getBattleRandom ;beb4
  428  31:A9DE  A8                tay
  429  31:A9DF  C8                iny
  430                             ;y = (0-count]
  431                             ;lda <.candidateBits
  432  31:A9E0  A2 00             ldx #0
  433  31:A9E2            .find_nth_set:
  434  31:A9E2  06 62                     asl <.candidateBits
  435  31:A9E4  E8                        inx
  436  31:A9E5  90 FB                     bcc .find_nth_set
  437  31:A9E7  88                        dey
  438  31:A9E8  D0 F8                     bne .find_nth_set
  439                             ;x = bit index(reversed) of Nth set
  440  31:A9EA  CA                dex
  441  31:A9EB  A9 00             lda #0
  442  31:A9ED  20 20 FD          jsr flagTargetBit
  443  31:A9F0  85 62             sta <.candidateBits
  444  31:A9F2  60                rts
  445                     ;$a9f7  
  446                     ;======================================================================================================
  447                             RESTORE_PC      ff3_enemy_target_begin
                0000              .bank   BANK(ff3_enemy_target_begin)
                8000              .org    ff3_enemy_target_begin
#[3]   ff3_hack_master.asm
#[4]   ff3_calc_player_param.asm
   35                                     .include "ff3_calc_player_param.asm"    ;save
    1                     ; ff3_calc_player_param.asm
    2                     ;
    3                     ;description:
    4                     ;       replaces code for player parameter calculation
    5                     ;       adds 'extra job ability' feature
    6                     ;
    7                     ;version:
    8                     ;       0.05 (2006-11-10)
    9                     ;
   10                     ;======================================================================================================
   11  00:8000            ff3_calc_player_param_begin:
   12                             INIT_PATCH $31,$aa16,$ab0a
                0031              .bank   $31
                AA16              .org    $aa16
       31:AA16                    .ds             (($ab0a) - ($aa16))
                AA16              .org    $aa16
   13  31:AA16            battleFunction05:
   14  31:AA16            calcPlayerParam:
   15                     ;[in]
   16           0052      .iPlayer = $52
   17           0057      .pBaseParam = $57
   18           0059      .pEquips = $59
   19           005B      .pBattleParam = $5b
   20                     ;locals
   21           0027      .equipId_right = $27
   22           0028      .equipId_left = $28
   23           002C      .baseParams = $2c               ;str,agi,vit,int,men
   24           7400      .equipParams = $7400    ;[8][5]
   25           742F      .equipIds = $742f       ;{head,body,wrest,righthand,count,lefthand}
   26           0032      .equipTraitFlag = $32
   27           0048      .equipFlag_right = $48  ;=> pBattleParam[31]
   28           0049      .equipFlag_left = $49   ;=> +32
   29                     ;------------------------------------------------------------------------
   30  31:AA16  20 90 BE          jsr b31_updatePlayerOffset      ;be90
   31  31:AA19  A8                tay
   32  31:AA1A  A2 00             ldx #0
   33  31:AA1C            .load_equips:
   34  31:AA1C  B1 59                     lda [.pEquips],y
   35  31:AA1E  9D 2F 74                  sta .equipIds,x
   36  31:AA21  95 24                     sta <$24,x
   37  31:AA23  C8                        iny
   38  31:AA24  E8                        inx
   39  31:AA25  E0 06                     cpx #6
   40  31:AA27  D0 F3                     bne .load_equips
   41  31:AA29  A2 02             ldx #2
   42  31:AA2B            .replace_empty_armor:
   43  31:AA2B  B5 24                     lda <$24,x
   44  31:AA2D  D0 04                     bne .replace_next
   45  31:AA2F  A9 57                             lda #$57
   46  31:AA31  95 24                             sta <$24,x
   47  31:AA33                    .replace_next:
   48  31:AA33  CA                        dex
   49  31:AA34  10 F5                     bpl .replace_empty_armor
   50  31:AA36  A5 29             lda <$24+5
   51  31:AA38  85 28             sta <$24+4
   52  31:AA3A  8D 33 74          sta .equipIds+4
   53                             
   54  31:AA3D  A5 27             lda <.equipId_right
   55  31:AA3F  20 94 AA          jsr idToKindFlag        ;extra
   56  31:AA42  85 48             sta <.equipFlag_right
   57                             
   58  31:AA44  A5 28             lda <.equipId_left
   59  31:AA46  20 94 AA          jsr idToKindFlag        ;extra
   60  31:AA49  85 49             sta <.equipFlag_left
   61  31:AA4B  F0 04             beq .empty_either
   62  31:AA4D  A5 48                     lda <.equipFlag_right
   63  31:AA4F  D0 1A                     bne .set_traits
   64  31:AA51            .empty_either:
   65                                     ;at least lefthand or righthand is empty (or invalid item)
   66  31:AA51  A5 48                     lda <.equipFlag_right
   67  31:AA53  29 06                     and #6
   68  31:AA55  F0 06                     beq .check_left
   69                                             ;bow or arrow
   70  31:AA57  A9 00                             lda #0
   71  31:AA59  85 27                             sta <$24+3
   72  31:AA5B  F0 0A                             beq .clear_flags
   73  31:AA5D                    .check_left:
   74  31:AA5D  A5 49                     lda <.equipFlag_left
   75  31:AA5F  29 06                     and #6
   76  31:AA61  F0 08                     beq .set_traits
   77                                             ;bow or arrow
   78  31:AA63  A9 00                             lda #0
   79  31:AA65  85 28                             sta <$24+4
   80  31:AA67                            .clear_flags:
   81  31:AA67  85 48                             sta <.equipFlag_right
   82  31:AA69  85 49                             sta <.equipFlag_left
   83  31:AA6B            .set_traits:
   84  31:AA6B  A5 48             lda <.equipFlag_right
   85  31:AA6D  05 49             ora <.equipFlag_left
   86                             ;00:both bare fist or bow/arrow with other empty
   87                             ;01:onehanded weapon
   88                             ;06:bow(2) & arrow(4) set
   89                             ;08:harp
   90                             ;80:shield
   91  31:AA6F  F0 0D             beq .finish     ;$ab0a  ;both barefist
   92  31:AA71  C9 06             cmp #6
   93  31:AA73  F0 09             beq .finish     ;$ab0a  ;bow_arrow_set
   94  31:AA75  C9 08             cmp #8
   95  31:AA77  D0 03             bne .others
   96                     ;harp   
   97  31:AA79  4A                lsr a
   98  31:AA7A  D0 02             bne .finish
   99  31:AA7C            .others:
  100  31:AA7C  A9 02             lda #2
  101  31:AA7E            .finish:
  102           0001              .ifdef ENABLE_EXTRA_ABILITY_TAG
  103  31:AA7E  48                        pha
  104                                     
  105  31:AA7F  20 90 BE                  jsr b31_updatePlayerOffset
  106  31:AA82  A8                        tay
  107  31:AA83  B1 57                     lda [.pBaseParam],y
  108  31:AA85  AA                        tax     ;job
  109  31:AA86  A9 3C                     lda #EXTRA_ABILITY_OFFSET
  110  31:AA88  20 98 BE                  jsr b31_setYtoOffsetOf
  111  31:AA8B  BD B0 AA                  lda extraAbilityFlags,x
  112  31:AA8E  91 5B                     sta [.pBattleParam],y
  113                                     
  114  31:AA90  68                        pla
  115  31:AA91  4C 0A AB                  jmp $ab0a
  116                             .else
  118                             .endif  ;ENABLE_EXTRA_ABILITY_TAG
  119                     ;-------------------------------------------------------------------------------------------------------
  120  31:AA94            idToKindFlag:   ;[in] a = id [out] x = resultKind,a = flagValue
  121  31:AA94  A2 05             ldx #5
  122  31:AA96            .loop:
  123  31:AA96  DD A3 AA                  cmp .bounds,x
  124  31:AA99  B0 03                     bcs .return
  125  31:AA9B  CA                        dex
  126  31:AA9C  10 F8             bpl .loop
  127  31:AA9E            .return:
  128  31:AA9E  E8                inx
  129  31:AA9F  BD A9 AA          lda .kindToFlag,x
  130  31:AAA2  60                rts
  131  31:AAA3            .bounds:
  132  31:AAA3  01 46 4A          .db     $01,$46,$4a,$4f,$58,$65
       31:AAA6  4F 58 65  
  133  31:AAA9            .kindToFlag
  134  31:AAA9  00 01 08          .db     $00,$01,$08,$02,$04,$80,$00
       31:AAAC  02 04 80  
       31:AAAF  00        
  135                     ;-------------------------------------------------------------------------------------------------------
  136  31:AAB0            calc_player_param_free_begin:
  137           AB0A      calc_player_param_free_end = $ab0a
  138                     ;-------------------------------------------------------------------------------------------------------
  139                             INIT_PATCH $31,$ac69,$aca2
                0031              .bank   $31
                AC69              .org    $ac69
       31:AC69                    .ds             (($aca2) - ($ac69))
                AC69              .org    $ac69
  140  31:AC69            calcPlayerParam_testWrestlingAbility:
  141           005B      .pBattleParam = $5b
  142           0032      .equipTraitFlag = $32
  143                     
  144  31:AC69  A9 3C             lda #EXTRA_ABILITY_OFFSET
  145  31:AC6B  20 98 BE          jsr b31_setYtoOffsetOf
  146  31:AC6E  B1 5B             lda [.pBattleParam],y
  147  31:AC70  29 08             and #PASSIVE_WRESTLING
  148  31:AC72  F0 2E             beq $aca2
  149                             
  150  31:AC74  A5 32             lda <.equipTraitFlag
  151  31:AC76  29 06             and #$06
  152  31:AC78  D0 28             bne $aca2
  153  31:AC7A  AD 28 74                  lda $7428
  154  31:AC7D  4A                        lsr a
  155  31:AC7E  4A                        lsr a
  156  31:AC7F  85 24                     sta <$24
  157                     
  158  31:AC81  AD 2E 74                  lda $742e
  159  31:AC84  4A                        lsr a
  160  31:AC85  18                        clc
  161  31:AC86  6D 2E 74                  adc $742e
  162  31:AC89  85 25                     sta <$25
  163                     
  164  31:AC8B  AD 2D 74                  lda $742d
  165  31:AC8E  4A                        lsr a
  166  31:AC8F  4A                        lsr a
  167  31:AC90  18                        clc
  168  31:AC91  65 24                     adc <$24
  169  31:AC93  65 25                     adc <$25
  170  31:AC95  69 02                     adc #$02
  171  31:AC97  85 3B                     sta <$3b
  172  31:AC99  85 40                     sta <$40
  173  31:AC9B  4C 3D AD                  jmp $ad3d
  174                     ;$ac69:
  175                     ;       if ( ($57[y = $5f] == #02 //beq ac76
  176                     ;               || $57[y] == #0d ) //bne aca2
  177                     ;$ac76:         &&  (($32 & #06) == 0) ) //bne aca2
  178                     ;       {       //モンクor空手家 and 素手
  179                     ;$ac7c:
  180                     ;               $24 = $7428 >> 2;       //fd47
  181                     ;               $25 = $742e >> 1 + $742e;
  182                     ;               $40 = $3b = $24 + $25 + $742d >> 2;     //fd47
  183                     ;               //jmp $ad3d
  184                     ;       } else {
  185                     ;$aca2:
  186                     ;=======================================================================================================
  187  31:AC9E            ff3_calc_player_param_end:      
  188                             RESTORE_PC ff3_calc_player_param_begin
                0000              .bank   BANK(ff3_calc_player_param_begin)
                8000              .org    ff3_calc_player_param_begin
#[3]   ff3_hack_master.asm
#[4]   ff3_blow_effect.asm
   36                                     .include "ff3_blow_effect.asm"  ;save
    1                     ; ff3_blow_effect.asm
    2                     ;
    3                     ; description:
    4                     ;       replaces blow-effect playing code
    5                     ;       
    6                     ; version:
    7                     ;       0.03 (2006-10-23)
    8                     ;======================================================================================================
    9  00:8000            ff3_blow_effect_begin:
   10                     ;======================================================================================================
   11                             INIT_PATCH      $32,$98d1,$991f
                0032              .bank   $32
                98D1              .org    $98d1
       32:98D1                    .ds             (($991f) - ($98d1))
                98D1              .org    $98d1
   12  32:98D1            showBlowSprite_02:      ;
   13  32:98D1  A9 12             lda #$12
   14  32:98D3  D0 02             bne randomizePosAndShow
   15                             
   16  32:98D5            showBlowSprite_01:      ;type 0(fist) ,2(bell,book,rod,cane) ,4(harp),9(claw)
   17  32:98D5  A9 10             lda #$10
   18                             ;fall through
   19  32:98D7            randomizePosAndShow:
   20           00B6      .frameCount = $b6
   21           008C      .spriteX = $8c
   22           008D      .spriteY = $8d
   23           00BE      .randX = $be
   24           00BF      .randY = $bf
   25           00B8      .target = $b8
   26           00CD      .hand = $cd
   27  32:98D7  48                pha
   28                     ;$98e8:
   29  32:98D8  A6 BF             ldx <.randY
   30  32:98DA  A5 B6             lda <.frameCount
   31           0001              .ifdef VARIABLE_SWING_FRAMES
   32  32:98DC  20 C1 A3                  jsr blowEffect_isFrameCountSatisfied    ;a unchanged
   33                                     ;x = range index
   34                                     ;a = frame count
   35  32:98DF  0A                        asl a
   36  32:98E0  38                        sec
   37  32:98E1  FD D9 A3                  sbc blowEffect_frameBounds,x
   38  32:98E4  4A                        lsr a
   39  32:98E5  4A                        lsr a
   40  32:98E6  B0 21                     bcs .no_update
   41                             .else
   44                             .endif  ;VARIABLE_SWING_FRAMES
   45                     
   46  32:98E8  A5 B8                     lda <.target
   47  32:98EA  0A                        asl a
   48  32:98EB  A8                        tay
   49  32:98EC  B9 D7 7D                  lda enemyPos,y
   50  32:98EF  85 BE                     sta <.randX
   51  32:98F1  B9 D8 7D                  lda enemyPos+1,y
   52  32:98F4  85 BF                     sta <.randY
   53                     
   54  32:98F6  20 4F A4                  jsr getSys0Random_00_ff
   55  32:98F9  29 1F                     and #$1f
   56  32:98FB  18                        clc
   57  32:98FC  65 BE                     adc <.randX
   58  32:98FE  85 BE                     sta <.randX
   59                                     
   60  32:9900  20 4F A4                  jsr getSys0Random_00_ff
   61  32:9903  29 1F                     and #$1f
   62  32:9905  18                        clc
   63  32:9906  65 BF                     adc <.randY
   64  32:9908  AA                        tax
   65  32:9909            .no_update:
   66                     ;$9912:
   67                             ;lda <.randY
   68  32:9909  86 8D             stx <.spriteY
   69  32:990B  A5 BE             lda <.randX
   70  32:990D  85 8C             sta <.spriteX
   71  32:990F  A9 00             lda #0
   72  32:9911  85 8F             sta <$8f
   73                             ;fall through
   74                     ;$991f
   75                     ;$32:98d6
   76  32:9913  68                pla
   77  32:9914  A8                tay
   78  32:9915  A5 CD             lda <.hand
   79  32:9917  F0 01             beq .show
   80  32:9919  C8                        iny
   81  32:991A            .show:
   82  32:991A  84 8E             sty <$8e
   83  32:991C  4C 57 93          jmp $9357
   84                     ;$991f
   85           97DF              .org    $97df
   86  32:97DF            blowSpriteHandlers:
   87                     ;1F 99 E0 98 D1 98 1C 98 15 98 EB 97
   88  32:97DF  1F 99             .dw     $991f   ;type 1
   89  32:97E1  D5 98             .dw     showBlowSprite_01       ;$98e0  ;type 0,2,4,9
   90  32:97E3  D1 98             .dw showBlowSprite_02   ;$98d1
   91  32:97E5  1C 98             .dw $981c
   92  32:97E7  15 98             .dw $9815
   93  32:97E9  EB 97             .dw $97eb
   94                     ;======================================================================================================
   95                             INIT_PATCH      $33,$a1ef,$a245
                0033              .bank   $33
                A1EF              .org    $a1ef
       33:A1EF                    .ds             (($a245) - ($a1ef))
                A1EF              .org    $a1ef
   96                             
   97  33:A1EF            blowEffect_init:
   98  33:A1EF  20 1C A1          jsr $a11c
   99  33:A1F2  A6 95             ldx <$95
  100  33:A1F4  4C F9 A3          jmp $a3f9
  101  33:A1F7            blowEffect_type07       ;shuriken       
  102           00CD      .hand = $cd
  103           00B6      .frameCount = $b6
  104  33:A1F7  20 EF A1          jsr blowEffect_init
  105                             
  106  33:A1FA  20 59 A0          jsr beginSwingFrame     ;a059
  107  33:A1FD  A9 AF             lda #$af
  108  33:A1FF  8D 49 7F          sta soundDriver_effectId
  109                     ;$a1ff:
  110  33:A202            .frame_loop:
  111  33:A202  20 5E A0                  jsr $a05e       ;;fill_A0hBytes_f0_at$0200andSet$c8_0
  112  33:A205  A5 B6                     lda <.frameCount
  113  33:A207  20 C1 A3                  jsr blowEffect_isFrameCountSatisfied
  114  33:A20A  A5 CD                     lda <.hand
  115  33:A20C  B0 0E                     bcs .frame_2nd_half
  116  33:A20E  F0 06                             beq .frame_1st_right
  117  33:A210  A2 07                                     ldx #$07
  118  33:A212  A9 1E                                     lda #$1e
  119  33:A214  D0 12                                     bne .show_hand
  120  33:A216                            .frame_1st_right:
  121  33:A216  A2 05                                     ldx #$05
  122  33:A218  A9 18                                     lda #$18
  123  33:A21A  D0 0C                                     bne .show_hand
  124  33:A21C                    .frame_2nd_half:
  125  33:A21C  F0 06                             beq .frame_2nd_right
  126  33:A21E  A2 06                                     ldx #$06
  127  33:A220  A9 1F                                     lda #$1f
  128  33:A222  D0 04                                     bne .show_hand
  129  33:A224                            .frame_2nd_right:
  130  33:A224  A2 01                                     ldx #$01
  131  33:A226  A9 19                                     lda #$19
  132  33:A228                            .show_hand:
  133  33:A228  20 6E A0                          jsr $a06e
  134  33:A22B                    .next_frame:
  135  33:A22B  20 B0 F8                  jsr updateDmaPpuScrollSyncNmiEx ;f8b0
  136  33:A22E  20 E6 8A                  jsr incrementSwingFrame ;8ae6
  137  33:A231  4A                        lsr a
  138  33:A232  20 C1 A3                  jsr blowEffect_isFrameCountSatisfied
  139  33:A235  90 CB                     bcc .frame_loop
  140  33:A237  20 FE A5          jsr $a5fe
  141  33:A23A  4C 35 AC          jmp $ac35
  142                     ;$a245
  143                     ;------------------------------------------------------------------------------------------------------
  144                             ;INIT_PATCH     $33,$a2fb,$a365
  145                             ;INIT_PATCH     $33,$a379,$a3dd
  146                             INIT_PATCH $33,$a2fb,$a3dd
                0033              .bank   $33
                A2FB              .org    $a2fb
       33:A2FB                    .ds             (($a3dd) - ($a2fb))
                A2FB              .org    $a2fb
  147                             
  148  33:A2FB            blowEffect_doSwing_type09:      ;09=claw also 00(fist),08(arrow)
  149           00CD      .hand = $cd
  150           00BD      .swingCount = $bd
  151           00B6      .frameCount = $b6
  152                     
  153                             ;jsr $a11c
  154                             ;ldx <$95
  155                             ;jsr $a3f9
  156  33:A2FB  20 EF A1          jsr blowEffect_init
  157  33:A2FE            .swing_loop:
  158  33:A2FE  20 59 A0                  jsr beginSwingFrame     ;a059
  159  33:A301  A9 8A                     lda #$8a
  160  33:A303  8D 49 7F                  sta soundDriver_effectId        ;$7f49
  161  33:A306                    .frame_loop:
  162  33:A306  20 5E A0                          jsr     $a05e   ;fill_A0hBytes_f0_at$0200andSet$c8_0
  163  33:A309  A5 CD                             lda <.hand
  164  33:A30B  F0 09                             beq     .righthand
  165                     ;$a312
  166  33:A30D  A9 06                                     lda #$06
  167  33:A30F  20 35 A3                                  jsr .showFist
  168  33:A312  A9 0D                                     lda #$0d
  169  33:A314  D0 07                                     bne .show_blow
  170  33:A316                                    .righthand:
  171  33:A316  A9 05                                     lda #$05
  172  33:A318  20 35 A3                                  jsr .showFist
  173  33:A31B  A9 04                                     lda #$04
  174  33:A31D                            .show_blow:
  175  33:A31D  48                                pha
  176  33:A31E  20 CF A2                          jsr $a2cf
  177  33:A321  D0 05                             bne .play_blow
  178  33:A323  68                                        pla
  179  33:A324  48                                        pha
  180  33:A325  20 A1 92                                  jsr $92a1
  181  33:A328                            .play_blow:
  182  33:A328  68                                pla
  183  33:A329  A9 02                             lda #2
  184  33:A32B  20 B2 97                          jsr $97b2
  185  33:A32E                            .next_frame:
  186  33:A32E  20 47 A3                          jsr blowEffect_advanceFrameOrFinish
  187  33:A331  90 D3                             bcc .frame_loop
  188  33:A333  B0 C9                             bcs .swing_loop
  189  33:A335            .showFist:
  190  33:A335  20 D9 A2          jsr $a2d9
  191  33:A338  20 4F A4          jsr     $a44f
  192  33:A33B  29 01             and #1
  193  33:A33D  85 7E             sta <$7e
  194  33:A33F  20 4F A4          jsr $a44f
  195  33:A342  29 01             and #1
  196  33:A344  85 7F             sta <$7f
  197  33:A346            blowEffect_doReturn_00:
  198  33:A346  60                rts
  199                     ;------------------------------------------------------------------------------------------------------ 
  200  33:A347            blowEffect_advanceFrameOrFinish:
  201           00BD      .swingCount = $bd
  202                     ;[out] bool carry: do next frame(0),do next swing(1)
  203  33:A347  20 B0 F8          jsr updateDmaPpuScrollSyncNmiEx ;$f8b0
  204  33:A34A  20 E6 8A          jsr incrementSwingFrame                 ;$8ae6
  205  33:A34D  20 C1 A3          jsr blowEffect_isFrameCountSatisfied
  206  33:A350  90 F4             bcc blowEffect_doReturn_00 ;.return
  207  33:A352  C6 BD             dec <.swingCount
  208  33:A354  30 02             bmi .finish
  209  33:A356  D0 EE             bne blowEffect_doReturn_00      ;beq .finish
  210                     ;.return:
  211                     ;               rts
  212  33:A358            .finish:
  213  33:A358  68                pla     ;retaddr
  214  33:A359  68                pla     ;retaddr
  215  33:A35A  4C 35 AC          jmp $ac35
  216                     ;------------------------------------------------------------------------------------------------------ 
  217                             ;.org   $a365
  218  33:A35D            blowEffect_type01:
  219  33:A35D  20 45 A2          jsr getSwingCountOfCurrentHand  ;a245
  220  33:A360  A9 00             lda #$00
  221  33:A362  F0 05             beq blowEffect_storeBlow
  222                     ;------------------------------------------------------------------------------------------------------         
  223                             ;.org   $a36f
  224  33:A364            blowEffect_type02:
  225  33:A364  20 45 A2          jsr getSwingCountOfCurrentHand  ;a245
  226  33:A367  A9 01             lda #$01
  227  33:A369            blowEffect_storeBlow
  228  33:A369  85 BA             sta <$ba
  229                             ;jmp blowEffect_doSwing_type0102
  230                             ;bne blowEffect_doSwing_type0102
  231                     ;------------------------------------------------------------------------------------------------------ 
  232                     
  233  33:A36B            blowEffect_doSwing_type0102:
  234                     ;[in]
  235           00BA      .blowSprite = $ba
  236           00BD      .swingCount = $bd
  237           00CD      .hand = $cd     ;right=0 left=1
  238                     ;locals
  239           00B6      .frameCount = $b6       ;shared
  240                     ;locals (extra)
  241                     ;---------------------------------------
  242  33:A36B  20 38 A4          jsr $a438       ;getWeaponSprite
  243  33:A36E  20 0F A4          jsr $a40f       ;copySpriteProps
  244  33:A371  A6 95             ldx <$95
  245  33:A373  20 F9 A3          jsr $a3f9       ;clearWeaponSprite
  246                     
  247  33:A376            .swing_loop:    ;$a384:
  248  33:A376  20 59 A0                  jsr beginSwingFrame     ;$a059
  249  33:A379  85 B9                     sta <$b9
  250  33:A37B  A9 B6                     lda #$b6
  251  33:A37D  8D 49 7F                  sta soundDriver_effectId        ;$7f49
  252  33:A380                    .frame_loop:    ;$a38e:
  253  33:A380  20 5E A0                          jsr $a05e       ;fill_A0hBytes_f0_at$0200andSet$c8_0();
  254  33:A383  A5 B6                             lda <.frameCount
  255  33:A385  0A                                asl a
  256  33:A386  20 C1 A3                          jsr blowEffect_isFrameCountSatisfied
  257  33:A389  A5 CD                             lda <.hand
  258  33:A38B  B0 16                             bcs .frame_2nd_half
  259                                                     ;前半(4フレーム)
  260  33:A38D  F0 0A                                     beq .righthand_1st
  261  33:A38F  A9 07                                             lda #7
  262  33:A391  A2 02                                             ldx #2
  263  33:A393  20 65 A0                                          jsr $a065
  264  33:A396  4C BA A3                                          jmp .next_frame
  265                                                             ;
  266  33:A399                                    .righthand_1st:
  267  33:A399  A2 05                                             ldx #5
  268  33:A39B  A9 00                                             lda #0
  269  33:A39D  20 6E A0                                          jsr $a06e
  270  33:A3A0  4C BA A3                                          jmp .next_frame
  271  33:A3A3                            .frame_2nd_half:
  272                                                     ;後半
  273  33:A3A3  F0 0A                                     beq .righthand_2nd
  274  33:A3A5  A9 06                                             lda #6
  275  33:A3A7  A2 03                                             ldx #3
  276  33:A3A9  20 65 A0                                          jsr $a065
  277  33:A3AC  4C B5 A3                                          jmp .show_blow
  278  33:A3AF                                    .righthand_2nd:
  279  33:A3AF  A9 01                                             lda #1
  280  33:A3B1  AA                                                tax
  281  33:A3B2  20 6E A0                                          jsr $a06e
  282  33:A3B5                            .show_blow:
  283  33:A3B5  A5 BA                             lda <.blowSprite
  284  33:A3B7  20 B2 97                          jsr $97b2
  285  33:A3BA                    .next_frame:
  286  33:A3BA  20 47 A3                  jsr blowEffect_advanceFrameOrFinish
  287  33:A3BD  90 C1                     bcc .frame_loop
  288  33:A3BF  B0 B5                     bcs .swing_loop
  289                     ;               a,x
  290                     ;r/1st  0,5
  291                     ;l/1st  7,2
  292                     ;r/2nd  1,1
  293                     ;l/2nd  6,3     
  294  33:A3C1            blowEffect_isFrameCountSatisfied:
  295                     ;[in] a : frameCount
  296                     ;[out] bool carry : 1:satisfied ( frame >= limit)
  297           00CD      .hand = $cd
  298           00BB      .swingCounts = $bb
  299           0001              .ifdef VARIABLE_SWING_FRAMES
  300  33:A3C1  48                        pha
  301  33:A3C2  A6 CD                     ldx <.hand
  302  33:A3C4  B5 BB                     lda <.swingCounts,x
  303  33:A3C6  A2 03                     ldx #3
  304  33:A3C8                    .find_range:
  305  33:A3C8  DD D5 A3                          cmp .bounds,x
  306  33:A3CB  B0 03                             bcs .found
  307  33:A3CD  CA                                dex
  308  33:A3CE  10 F8                             bpl .find_range
  309  33:A3D0                    .found:
  310                                     ;x=index
  311  33:A3D0  68                        pla
  312  33:A3D1  DD D9 A3                  cmp blowEffect_frameBounds,x
  313  33:A3D4  60                        rts
  314  33:A3D5                    .bounds:
  315  33:A3D5  00 05 0B                  .db $00,$05,$0b,$10
       33:A3D8  10        
  316  33:A3D9            blowEffect_frameBounds:
  317  33:A3D9  08 06 04                  .db $08,$06,$04,$02
       33:A3DC  02        
  318                             .else
  321                             .endif  ;VARIABLE_SWING_FRAMES
  322                     ;original: $a3dd        
  323                     ;------------------------------------------------------------------------------------------------------
  324           0033              .bank   $33
  325           A077              .org    $a077
  326  33:A077            swingCountBounds:
  327                                                     ;original
  328  33:A077  11                .db     $11             ;07 fist = 0
  329  33:A078  11                .db     $11             ;05 axe = 1, spear = 1, sword = 1,
  330  33:A079  11                .db     $11             ;05 rod = 2, book = 2, bell = 2,
  331  33:A07A  11                .db     $11             ;07 bow = 3,
  332  33:A07B  05                .db     $05             ;05 harp = 4,
  333  33:A07C  07                .db     $07             ;07 boomerang = 5,
  334  33:A07D  07                .db     $07             ;07 ring = 6,
  335  33:A07E  07                .db     $07             ;07 shuriken = 7,
  336  33:A07F  11                .db     $11             ;07 arrow = 8,
  337                             ;       claw = 9 (oops)
  338                     ;------------------------------------------------------------------------------------------------------
  339           0033              .bank   $33
  340           A080              .org    $a080
  341  33:A080            blowEffectHandlers:
  342  33:A080  F2 A2             .dw     $a2f2   ;fist
  343  33:A082  5D A3             .dw     blowEffect_type01       ;$a365  ;axe
  344  33:A084  64 A3             .dw     blowEffect_type02       ;$a36f  ;rod,book,bell
  345  33:A086  51 A2             .dw     $a251   ;bow
  346  33:A088  A5 A1             .dw     $a1a5   ;harp
  347  33:A08A  2C A1             .dw     $a12c   ;boomerang
  348  33:A08C  25 A1             .dw     $a125   ;engeturin
  349  33:A08E  F7 A1             .dw     blowEffect_type07       ;$a1ef  ;shuriken
  350  33:A090  F2 A2             .dw     $a2f2   ;arrow
  351  33:A092  FB A2             .dw     $a2fb   ;claw
  352                     ;======================================================================================================
  353                             RESTORE_PC      ff3_blow_effect_begin
                0000              .bank   BANK(ff3_blow_effect_begin)
                8000              .org    ff3_blow_effect_begin
#[3]   ff3_hack_master.asm
   37                                     ;
#[4]   ff3_present_battle.asm
   38                                     .include "ff3_present_battle.asm"       ;save
    1                     ; ff3_present_battle.asm
    2                     ;
    3                     ; description:
    4                     ;       replaces presentBattle ($34:8ff7) related codes
    5                     ;
    6                     ; version:
    7                     ;       0.05 (2006-10-27)
    8                     ;======================================================================================================
    9  00:8000            ff3_present_battle_begin:
   10                     
   11                             INIT_PATCH $34,$8ff7,$9474
                0034              .bank   $34
                8FF7              .org    $8ff7
       34:8FF7                    .ds             (($9474) - ($8ff7))
                8FF7              .org    $8ff7
   12                             ;$93cd
   13                             
   14  34:8FF7            presentBattle:
   15                     ;[in]
   16           7EC2      .situation = $7ec2      ; usually commandId (set by commandHandler); toadsAction=18,prizeMessage=2
   17           78D5      .presentMode = $78d5; (commandChainId) (0-5: 0=attack 1=action 2,4=prize)
   18                     ;[shared]
   19           004B      .commandId = $4b
   20           0062      .pCommandList = $62
   21           0064      .iCommand = $64
   22                     ;--------------------------------------------------------------
   23  34:8FF7  AD C2 7E          lda .situation
   24  34:8FFA  F0 39             beq .finish
   25  34:8FFC  AD D5 78                  lda .presentMode
   26  34:8FFF  0A                        asl a
   27  34:9000  AA                        tax
   28  34:9001  BD FA 94                  lda pb_commandLists,x
   29  34:9004  85 62                     sta <.pCommandList
   30  34:9006  BD FB 94                  lda pb_commandLists+1,x
   31  34:9009  85 63                     sta <.pCommandList+1
   32  34:900B  A2 00                     ldx #0
   33  34:900D  8E EE 78                  stx battleMessageCount ;fromhere meaning changes to 'message index'
   34  34:9010  8E EF 78                  stx $78ef
   35  34:9013  86 64                     stx <.iCommand
   36  34:9015                    .command_loop:
   37  34:9015  20 3A 90                          jsr pb_initString
   38  34:9018  A4 64                             ldy <.iCommand
   39  34:901A  B1 62                             lda [.pCommandList],y
   40  34:901C  85 4B                             sta <.commandId ;00-0e
   41                                             ;cmp #$ff
   42                                             ;beq .finish
   43  34:901E  30 15                             bmi .finish
   44  34:9020  0A                                asl a
   45  34:9021  18                                clc
   46  34:9022  69 42                             adc #LOW(pb_handlers) ;#$4d
   47  34:9024  85 19                             sta <$19
   48  34:9026  A9 95                             lda #HIGH(pb_handlers) ;#$95
   49                                             ;adc #$00
   50  34:9028  85 1A                             sta <$1a
   51  34:902A  A9 6C                             lda #$6c        ;jmp (ptr)
   52  34:902C  85 18                             sta <$18
   53                                             ;0018: jmp ($954d + commandId<<1)
   54                                             ;jmp $0018
   55  34:902E  20 18 00                          jsr $0018
   56  34:9031  E6 64                             inc <.iCommand
   57  34:9033  D0 E0                             bne .command_loop
   58                     ;$9051:
   59                     ;       .org $9051
   60                     ;               rts
   61  34:9035            .finish: ;$9056:
   62  34:9035  A9 25             lda #$25
   63  34:9037  4C 0E FA          jmp call_2e_9d53        ;fa0e
   64                     ;$905b:
   65  34:903A            pb_initString:
   66  34:903A  A9 00             lda #0
   67  34:903C  A2 13             ldx #$13
   68  34:903E            .init_string:
   69  34:903E  9D D7 7A                  sta stringCache,x
   70  34:9041  CA                        dex
   71  34:9042  10 FA                     bpl .init_string
   72                             ;rts
   73  34:9044  4C 54 97          jmp initTileArrayStorage        ;9754
   74                     ;------------------------------------------------------------------------------------------------------
   75                     ;       .org    $905b
   76                     
   77  34:9047            pb_loadName:
   78           0057      .pPlayer = $57
   79                     ;indexToGroup = $7ecd
   80                     ;[in] a : charIndex
   81  34:9047  30 14             bmi .index_means_enemy
   82  34:9049  20 3C FD                  jsr shiftLeft6
   83  34:904C  18                        clc
   84  34:904D  69 0B                     adc #$0b
   85  34:904F  A8                        tay
   86  34:9050  A2 05                     ldx #5
   87  34:9052                    .load_player_name:
   88  34:9052  B1 57                             lda [.pPlayer],y
   89  34:9054  9D D7 7A                          sta stringCache,x
   90  34:9057  88                                dey
   91  34:9058  CA                                dex
   92  34:9059  10 F7                             bpl .load_player_name
   93  34:905B  30 24                             bmi .finish
   94  34:905D            .index_means_enemy:
   95  34:905D  29 7F                     and #$7f
   96  34:905F  C9 08                     cmp #8
   97  34:9061  D0 0A                     bne .single_target
   98  34:9063  20 C6 95                          jsr setBaseAddrTo_8c40
   99  34:9066  A9 16                             lda #$16
  100  34:9068  85 1A                             sta <$1a
  101  34:906A  4C 7A 90                          jmp .load
  102  34:906D                    .single_target:
  103  34:906D  AA                                tax
  104  34:906E  BD CD 7E                          lda indexToGroupMap,x
  105  34:9071  AA                                tax
  106  34:9072  BD 6B 7D                          lda groupToEnemyIdMap,x
  107  34:9075  85 1A                             sta <$1a
  108  34:9077  20 BD 95                          jsr setBaseAddrTo_8a40
  109  34:907A                    .load:
  110  34:907A  A2 00                     ldx #0
  111  34:907C  A5 1A                     lda <$1a
  112  34:907E  20 09 A6                  jsr loadString
  113  34:9081            .finish:
  114  34:9081  60                rts
  115                     
  116  34:9082            pb_checkNoMessage:
  117  34:9082  C9 FF             cmp #$ff
  118  34:9084  D0 02             bne .ok
  119  34:9086  68                        pla     ;retaddr
  120  34:9087  68                        pla     ;retaddr
  121  34:9088            .ok:
  122  34:9088  60                rts
  123                     ;------------------------------------------------------------------------------------------------------
  124  34:9089            pb_showActorName:       ;command05
  125           78D6      .actor = $78d6
  126  34:9089  AD D6 78          lda .actor
  127  34:908C  20 82 90          jsr pb_checkNoMessage
  128  34:908F  20 47 90          jsr pb_loadName
  129  34:9092  A9 00             lda #0
  130  34:9094  F0 25             beq pb_drawWindow
  131                     ;$90a0:
  132                     ;------------------------------------------------------------------------------------------------------
  133                     ;       .org $9177
  134  34:9096            pb_showTargetName:      ;command07
  135           78D8      .target = $78d8 ;charIndex
  136  34:9096  AD D8 78          lda .target
  137  34:9099  20 82 90          jsr pb_checkNoMessage
  138  34:909C  20 47 90          jsr pb_loadName
  139  34:909F  A9 02             lda #2
  140  34:90A1  D0 18             bne pb_drawWindow
  141                     ;$91ce:
  142                     ;------------------------------------------------------------------------------------------------------
  143                     ;       .org    $91d4
  144  34:90A3            pb_showEffectMessage:   ;command08
  145           78D9      .effect = $78d9
  146  34:90A3  AD D9 78          lda .effect
  147  34:90A6  20 82 90          jsr pb_checkNoMessage
  148  34:90A9  18                clc
  149  34:90AA  69 0C             adc #$0c
  150  34:90AC  85 1A             sta <$1a
  151  34:90AE  A2 82             ldx #$82
  152  34:90B0  86 19             stx <$19
  153  34:90B2  A2 00             ldx #0
  154  34:90B4  86 18             stx <$18
  155  34:90B6  20 09 A6          jsr loadString
  156  34:90B9  A9 03             lda #3
  157                             ;bne pb_drawWindow
  158  34:90BB            pb_drawWindow:
  159  34:90BB  48                pha
  160  34:90BC  A2 08             ldx #8
  161  34:90BE  86 18             stx <$18
  162  34:90C0  20 6A 96          jsr strToTileArray
  163  34:90C3  68                pla
  164  34:90C4  4C 1B 8D          jmp draw1LineWindow
  165                             ;jmp $9051      
  166                     ;------------------------------------------------------------------------------------------------------
  167                     ;       .org    $90a0
  168  34:90C7            pb_showActionName:      ;command06
  169           0072      .isItem = $72
  170           78D7      .messageId = $78d7
  171           7AC0      .pTileArray = $7ac0
  172  34:90C7  A5 72             lda <.isItem
  173  34:90C9  F0 1D             beq .not_item
  174                     ;item
  175  34:90CB  A2 00                     ldx #0
  176  34:90CD  86 18                     stx <$18
  177  34:90CF  A9 88                     lda #$88
  178  34:90D1  85 19                     sta <$19
  179  34:90D3  AD D7 78                  lda .messageId
  180  34:90D6  20 09 A6                  jsr loadString
  181  34:90D9  A2 F7                     ldx #$f7        ;-9
  182  34:90DB                    .shift_itemstr:
  183  34:90DB  BD E1 79                          lda stringCache-$f6,x
  184  34:90DE  9D E0 79                          sta stringCache-$f7,x
  185  34:90E1  E8                                inx
  186  34:90E2  D0 F7                             bne .shift_itemstr
  187  34:90E4  A9 01                     lda #1
  188  34:90E6  D0 D3                     bne pb_drawWindow
  189  34:90E8            .not_item:
  190  34:90E8  AD D7 78          lda .messageId
  191  34:90EB  20 82 90          jsr pb_checkNoMessage
  192  34:90EE  A0 05             ldy #5
  193  34:90F0            .map_to_kind:
  194  34:90F0  D9 35 91                  cmp .bounds,y
  195  34:90F3  B0 03                     bcs .mapped
  196  34:90F5  88                        dey
  197  34:90F6  10 F8                     bpl .map_to_kind
  198  34:90F8            .mapped:
  199                             ;y = kind
  200  34:90F8  A2 00             ldx #0
  201  34:90FA  C0 01             cpy #1  ;01 <= msgid <= 20 'n times hit'
  202  34:90FC  D0 15             bne .not_hit_message
  203  34:90FE  85 18                     sta <$18
  204  34:9100  86 19                     stx <$19        ;0
  205  34:9102  20 E1 95                  jsr itoa_16
  206  34:9105  A2 02                     ldx #2
  207  34:9107                    .store_count_digits:
  208  34:9107  B5 1D                             lda <$1d,x
  209  34:9109  9D D7 7A                          sta stringCache,x
  210  34:910C  CA                                dex
  211  34:910D  10 F8                             bpl .store_count_digits
  212  34:910F  A2 02                     ldx #2
  213  34:9111  A9 13                     lda #$13
  214  34:9113            .not_hit_message:
  215  34:9113            .load_base:
  216  34:9113  48                pha
  217  34:9114  98                tya
  218  34:9115  0A                asl a
  219  34:9116  A8                tay
  220  34:9117  B9 3B 91          lda .baseOffsets,y
  221  34:911A  85 18             sta <$18
  222  34:911C  B9 3C 91          lda .baseOffsets+1,y
  223  34:911F  85 19             sta <$19
  224  34:9121  68                pla
  225  34:9122  C0 06             cpy #(3*2)
  226  34:9124  D0 08             bne .load_string
  227                                             ;action
  228  34:9126  38                                sec
  229  34:9127  E9 39                             sbc #$39
  230           0001              .ifdef ENABLE_EXTRA_ABILITY
  231  34:9129  20 B0 9C                          jsr getExtraAbilityNameId
  232                             .endif  ;ENABLE_EXTRA_ABILITY
  233  34:912C  A2 00                             ldx #0
  234  34:912E            .load_string:
  235  34:912E  20 09 A6          jsr loadString
  236  34:9131  A9 01             lda #1
  237  34:9133  D0 86             bne pb_drawWindow
  238                     ;       msg             base    msgToIndex      meaning
  239                     ;       00:             8c40    =09             miss
  240                     ;       01-20:  8c40    =13             fight
  241                     ;       21-38:  8a40    +c6             summon
  242                     ;       39-51:  8c40    -39             action
  243                     ;       52-7f:  8200    -46             status
  244                     ;       80-fe:  8990    -80             special
  245                     ;       ff: no message
  246  34:9135            .bounds:
  247  34:9135  00 01 21          .db $00,$01,$21,$39,$52,$80
       34:9138  39 52 80  
  248                     ;.messageOffsets:
  249                     ;       .db $09,$00,$c6,$c7,$ba,$80
  250  34:913B            .baseOffsets:
  251  34:913B  52 8C             .dw     $8c40 + $09*2
  252  34:913D  40 8C             .dw     $8c40
  253  34:913F  CC 8B             .dw     $8a40 + $c6*2
  254  34:9141  40 8C             .dw $8c40; - $39*2
  255  34:9143  74 81             .dw $8200 - $46*2
  256  34:9145  90 88             .dw $8990 - $80*2
  257                     ;$9177:
  258                     ;------------------------------------------------------------------------------------------------------
  259  34:9147            pb_showInfoMessage:     ;command09
  260                     ;.messages = $78da
  261                     ;.messageCount = $78ee
  262           78E4      .messageParams = $78e4
  263           78EF      .iMessageParam = $78ef
  264           9575      pb_showInfoMessage_subCommands = $9575
  265  34:9147  AE EE 78          ldx battleMessageCount
  266  34:914A  BD DA 78          lda battleMessages,x
  267  34:914D  20 82 90          jsr pb_checkNoMessage
  268  34:9150  4A                lsr a
  269  34:9151  AA                tax
  270  34:9152  BD 75 95          lda pb_showInfoMessage_subCommands,x
  271                             ;carry still remains
  272  34:9155  B0 03             bcs .even_index
  273  34:9157  20 45 FD                  jsr $fd45       ;shiftright4
  274  34:915A            .even_index:
  275  34:915A  29 0F             and #$0f
  276  34:915C  0A                asl a
  277  34:915D  18                clc
  278  34:915E  69 64             adc #LOW(pb_showInfoMessage_handlers) ;#$6b
  279  34:9160  85 19             sta <$19
  280  34:9162  A9 95             lda #HIGH(pb_showInfoMessage_handlers) ;#$95
  281  34:9164  69 00             adc #0
  282  34:9166  85 1A             sta <$1a
  283  34:9168  A9 6C             lda #$6c        ;jmp (xxxx)
  284  34:916A  85 18             sta <$18
  285  34:916C  20 18 00          jsr $0018
  286                     ;$9236  
  287  34:916F  EE EE 78          inc battleMessageCount
  288  34:9172  60                rts
  289                     ;$923c
  290                     ;------------------------------------------------------------------------------------------------------
  291  34:9173            pb_loadInfoMessage:
  292  34:9173  48                pha
  293  34:9174  20 C6 95          jsr setBaseAddrTo_8c40
  294  34:9177  68                pla
  295  34:9178  AA                tax
  296  34:9179  AC EE 78          ldy battleMessageCount
  297  34:917C  B9 DA 78          lda battleMessages,y
  298  34:917F  4C 09 A6          jmp loadString
  299  34:9182            pb_showInfoMessage_00:
  300  34:9182  A9 00             lda #0
  301                             ;fall through
  302  34:9184            pb_loadInfoMessageAndDraw:
  303  34:9184  20 73 91          jsr pb_loadInfoMessage
  304  34:9187            pb_drawInfoWindow:
  305  34:9187  A2 11             ldx #$11
  306  34:9189  86 18             stx <$18
  307  34:918B  20 6A 96          jsr strToTileArray
  308  34:918E  A9 04             lda #4
  309  34:9190  4C 1B 8D          jmp draw1LineWindow     ;8d1b
  310                     ;------------------------------------------------------------------------------------------------------
  311  34:9193            pb_loadInfoMessageAndDrawWithWait:
  312  34:9193            pb_showInfoMessage_01:
  313  34:9193  A9 00             lda #0
  314  34:9195  20 84 91          jsr pb_loadInfoMessageAndDraw
  315                             ;jmp waitForPad1AButtonDown
  316  34:9198            waitForPad1AButtonDown:
  317  34:9198            .wait_loop:
  318  34:9198  20 AA FB                  jsr getPad1Input
  319  34:919B  A5 12                     lda <inputBits  ;$12
  320  34:919D  29 01                     and #1
  321  34:919F  F0 F7                     beq .wait_loop
  322  34:91A1  60                rts
  323                     ;------------------------------------------------------------------------------------------------------
  324  34:91A2            pb_printHp:
  325                     ;.destEnd = $24
  326  34:91A2  48                pha
  327  34:91A3  20 B4 91          jsr pb_getMessageParam16
  328  34:91A6  A2 04             ldx #4
  329  34:91A8  68                pla
  330  34:91A9  A8                tay
  331  34:91AA            .copy:
  332  34:91AA  B5 1A                     lda <$1a,x
  333  34:91AC  99 D7 7A                  sta stringCache,y
  334  34:91AF  88                        dey
  335  34:91B0  CA                        dex
  336  34:91B1  10 F7                     bpl .copy
  337  34:91B3  60                rts
  338                     ;------------------------------------------------------------------------------------------------------
  339  34:91B4            pb_getMessageParam16:
  340           78EF      .iParam = $78ef
  341           78E4      .battleMessageParams = $78e4
  342  34:91B4  AE EF 78          ldx .iParam
  343  34:91B7  BD E4 78          lda .battleMessageParams,x
  344  34:91BA  85 18             sta <$18
  345  34:91BC  E8                inx
  346  34:91BD  BD E4 78          lda .battleMessageParams,x
  347  34:91C0  85 19             sta <$19
  348  34:91C2  E8                inx
  349  34:91C3  8E EF 78          stx .iParam
  350  34:91C6  4C E1 95          jmp itoa_16
  351                     ;------------------------------------------------------------------------------------------------------
  352                     ;$34:91ce setNoTargetMessage
  353           91CE              .org    $91ce
  354  34:91CE            setNoTargetMessage:
  355  34:91CE  A9 FF             lda #$ff
  356  34:91D0  8D D8 78          sta $78d8
  357  34:91D3  60                rts
  358                     ;------------------------------------------------------------------------------------------------------
  359  34:91D4            pb_showInfoMessage_02_message:  ;"HP_?????/?????"
  360  34:91D4  77 79 FF          .db     $77,$79,$ff,$c5,$c5,$c5,$c5,$c5,$c7,$c5,$c5,$c5,$c5,$c5
       34:91D7  C5 C5 C5  
       34:91DA  C5 C5 C7  
       34:91DD  C5 C5 C5  
       34:91E0  C5 C5     
  361                     ;------------------------------------------------------------------------------------------------------
  362                             ;.org   $91d4
  363  34:91E2            pb_showInfoMessage_02:
  364           006E      .pActor = $6e   ;
  365  34:91E2  A2 0D             ldx #$0d
  366  34:91E4            .init_string:
  367                                     ; 0123456789abcd
  368                                     ;"HP_?????/?????"
  369  34:91E4  BD D4 91                  lda pb_showInfoMessage_02_message,x
  370  34:91E7  9D D7 7A                  sta stringCache,x
  371  34:91EA  CA                        dex
  372  34:91EB  10 F7                     bpl .init_string
  373  34:91ED  A0 30             ldy #$30
  374  34:91EF  B1 6E             lda [.pActor],y
  375  34:91F1  10 05             bpl .get_hp
  376  34:91F3  AD D8 7E          lda battleMode
  377  34:91F6  30 0A             bmi .show
  378  34:91F8            .get_hp:
  379  34:91F8  A9 07                     lda #$07
  380                                     ;sta <$24
  381  34:91FA  20 A2 91                  jsr pb_printHp
  382  34:91FD  A9 0D                     lda #$0d
  383                                     ;sta <$24
  384  34:91FF  20 A2 91                  jsr pb_printHp
  385  34:9202            .show:
  386                             ;fall through
  387  34:9202            pb_drawAndWait:
  388  34:9202  20 87 91          jsr pb_drawInfoWindow
  389  34:9205  4C 98 91          jmp waitForPad1AButtonDown
  390                     ;$92b5
  391                     ;------------------------------------------------------------------------------------------------------
  392                     ;$92db:
  393  34:9208            pb_showInfoMessage_03:
  394                     ;       %u + message
  395  34:9208  20 B4 91          jsr pb_getMessageParam16
  396  34:920B  A2 00             ldx #0
  397  34:920D  A0 00             ldy #0
  398  34:920F            .copy:
  399  34:920F  B5 1A                     lda <$1a,x
  400  34:9211  C9 FF                     cmp #$ff
  401  34:9213  F0 04                     beq .next
  402  34:9215  99 D7 7A                          sta stringCache,y
  403  34:9218  C8                                iny
  404  34:9219                    .next:
  405  34:9219  E8                        inx
  406  34:921A  E0 05                     cpx #5
  407  34:921C  D0 F1                     bne .copy
  408  34:921E  98                tya
  409  34:921F  20 84 91          jsr pb_loadInfoMessageAndDraw
  410  34:9222  4C 98 91          jmp waitForPad1AButtonDown
  411                     ;------------------------------------------------------------------------------------------------------
  412                     ;$932b
  413  34:9225            pb_showInfoMessage_04:
  414  34:9225  A9 00             lda #0
  415  34:9227  20 73 91          jsr pb_loadInfoMessage
  416                             ;stx <$2a
  417                             INIT16 <$18,$8800
       34:922A  A9 00             lda #LOW($8800)
       34:922C  85 18             sta <$18
       34:922E  A9 88             lda #HIGH($8800)
       34:9230  85 19             sta <$18+1
  418  34:9232  AD E4 78          lda $78e4
  419                             ;ldx <$2a
  420  34:9235  20 09 A6          jsr loadString
  421  34:9238  A9 FF             lda #$ff
  422  34:923A  8D DC 7A          sta stringCache+5
  423                             ;jmp pb_drawAndWait
  424  34:923D  D0 C3             bne pb_drawAndWait
  425                     ;$934e
  426                     ;------------------------------------------------------------------------------------------------------
  427                     ;$34:934e dispCommand_0B
  428  34:923F            pb_showDamage:  ;command0C
  429  34:923F  A9 17             lda #$17
  430                             ;fall through
  431  34:9241            pb_storeAndPlayEffect:
  432  34:9241  8D C2 7E          sta $7ec2
  433                             ;fall through
  434  34:9244            pb_playEffect:
  435  34:9244  4C 11 84          jmp playEffect  ;8411
  436                     ;------------------------------------------------------------------------------------------------------
  437  34:9247            pb_showDyingEffect:     ;command0D
  438           006E      .pActor = $6e
  439                     ;       [in] u8 $78d3 : ?
  440  34:9247  AD D3 78          lda $78d3
  441  34:924A  29 02             and #2
  442  34:924C  D0 2D             bne pb_doReturn
  443                     ;actor:         player                  enemy
  444                     ;target:
  445                     ; player        f0/93cd-e0/93cd f0/9408-e0/93cd
  446                     ; enemy         f0/93cd-e0/9408 f0/9408-e0/9408
  447  34:924E  20 D8 95          jsr $95d8       ;$18 = $00f0
  448  34:9251  20 2E A4          jsr getActor2C  ;a42e
  449  34:9254  30 06             bmi .actor_is_enemy     
  450  34:9256  20 88 92                  jsr pb_updatePlayerStatus       ;$93cd
  451  34:9259  4C 5F 92                  jmp .update_target
  452  34:925C            .actor_is_enemy:
  453  34:925C  20 B7 92                  jsr pb_updateEnemyStatus        ;$9408
  454  34:925F            .update_target:
  455                             ;todo: check actor != target 
  456  34:925F  20 CF 95          jsr $95cf       ;$18 = $00e0
  457  34:9262  A0 30             ldy #$30
  458  34:9264  B1 6E             lda [.pActor],y
  459  34:9266  30 06             bmi .target_is_enemy
  460  34:9268  20 88 92                  jsr pb_updatePlayerStatus       ;$93cd
  461  34:926B  4C 71 92                  jmp .show_effect
  462  34:926E            .target_is_enemy:
  463  34:926E  20 B7 92                  jsr pb_updateEnemyStatus        ;$9408
  464  34:9271            .show_effect:
  465  34:9271  20 74 94          jsr $9474
  466  34:9274  20 06 9D          jsr $9d06
  467  34:9277            pb_setEffect16:
  468  34:9277  A9 16             lda #$16
  469  34:9279  D0 C6             bne pb_storeAndPlayEffect
  470  34:927B            pb_doReturn:
  471  34:927B  60                rts
  472                     ;------------------------------------------------------------------------------------------------------
  473                     ;$34:93c4 dispCommand_0E
  474  34:927C            pb_updateTargetCache:   ;command0E
  475                             ;jsr $95cf
  476                             ;jsr pb_updateEnemyStatus       ;$9408
  477  34:927C  20 82 92          jsr updateEnemyStatusByTargetCache
  478  34:927F  4C 77 92          jmp pb_setEffect16
  479                     ;$93cd
  480  34:9282            updateEnemyStatusByTargetCache:
  481  34:9282  20 CF 95          jsr set18toTargetCache  ;$95cf
  482  34:9285  4C B7 92          jmp pb_updateEnemyStatus        ;$9408
  483                     ;------------------------------------------------------------------------------------------------------
  484                     ;$34:93cd updatePlayerStatus
  485  34:9288            pb_updatePlayerStatus:
  486           0018      .pCache = $18
  487           0052      .iPlayer = $52
  488           005B      .pBattleParam = $5b
  489           005F      .offset = $5f
  490                     
  491  34:9288  A2 03             ldx #3
  492  34:928A            .for_each_player:
  493  34:928A  86 52                     stx <.iPlayer
  494  34:928C  20 41 A5                  jsr getPlayerOffset     ;a541
  495                     
  496  34:928F  A5 52                     lda <.iPlayer
  497  34:9291  0A                        asl a
  498  34:9292  AA                        tax
  499  34:9293  A8                        tay
  500  34:9294  B1 18                     lda [.pCache],y ;y = player * 2
  501  34:9296  A4 5F                     ldy <.offset
  502  34:9298  C8                        iny
  503  34:9299  11 5B                     ora [.pBattleParam],y   ;y = offset 01
  504  34:929B  91 5B                     sta [.pBattleParam],y
  505  34:929D  10 04                     bpl .player_alive
  506                                             ;lda [.pBattleParam],y
  507  34:929F  29 FE                             and #$fe
  508  34:92A1  30 0C                             bmi .next       ;always satisfied
  509  34:92A3                    .player_alive:
  510  34:92A3  C8                                iny
  511  34:92A4  84 1A                             sty <$1a
  512  34:92A6  8A                                txa
  513  34:92A7  A8                                tay
  514  34:92A8  C8                                iny
  515  34:92A9  B1 18                             lda [.pCache],y
  516  34:92AB  A4 1A                             ldy <$1a
  517  34:92AD  11 5B                             ora [.pBattleParam],y
  518  34:92AF                    .next:
  519  34:92AF  91 5B                     sta [.pBattleParam],y
  520  34:92B1  A6 52                     ldx <.iPlayer
  521  34:92B3  CA                        dex
  522  34:92B4  10 D4                     bpl .for_each_player
  523  34:92B6  60                rts
  524                     ;------------------------------------------------------------------------------------------------------
  525                     ;$34:9408 updateEnemyStatus
  526  34:92B7            pb_updateEnemyStatus:
  527           0018      .pCache = $18
  528           001E      .pEnemy = $1e
  529           7EC4      .status = $7ec4
  530                     
  531                             INIT16 <.pEnemy,$7835
       34:92B7  A9 35             lda #LOW($7835)
       34:92B9  85 1E             sta <.pEnemy
       34:92BB  A9 78             lda #HIGH($7835)
       34:92BD  85 1F             sta <.pEnemy+1
  532  34:92BF  A2 07             ldx #7
  533  34:92C1            .for_each_enemy:
  534  34:92C1  8A                        txa
  535  34:92C2  0A                        asl a
  536  34:92C3  48                        pha
  537                                     
  538  34:92C4  A8                        tay
  539  34:92C5  B1 18                     lda [.pCache],y
  540  34:92C7  A0 01                     ldy #1
  541  34:92C9  11 1E                     ora [.pEnemy],y
  542  34:92CB  91 1E                     sta [.pEnemy],y
  543  34:92CD  29 E8                     and #$e8        ;dead|stone|toad|minimum
  544  34:92CF  F0 07                     beq .enemy_alive
  545  34:92D1  09 80                             ora #$80
  546  34:92D3  91 1E                             sta [.pEnemy],y
  547  34:92D5  9D C4 7E                          sta .status,x
  548  34:92D8                    .enemy_alive:
  549  34:92D8  68                        pla
  550  34:92D9  A8                        tay
  551  34:92DA  C8                        iny
  552  34:92DB  B1 18                     lda [.pCache],y
  553  34:92DD  A0 02                     ldy #2
  554  34:92DF  11 1E                     ora [.pEnemy],y
  555  34:92E1  91 1E                     sta [.pEnemy],y
  556                                     
  557                                     ;SUB16 <.pEnemy,$0040
  558                                     SUB16by8 <.pEnemy,#$40
       34:92E3  A5 1E             lda <.pEnemy
       34:92E5  38                sec
       34:92E6  E9 40             sbc #$40
       34:92E8  85 1E             sta <.pEnemy
       34:92EA  B0 02             bcs .sub16by8_00027
       34:92EC  C6 1F                     dec <.pEnemy+1
       34:92EE                    .sub16by8_00027:
  559  34:92EE  CA                        dex
  560  34:92EF  10 D0                     bpl .for_each_enemy
  561  34:92F1  60                rts
  562                     ;$9450:
  563                     ;======================================================================================================
  564                     ;       .org    $9450
  565                             ;$34:9450 dispCommand_0A //[waitForAButtonDownOrMessageTimeOut]
  566  34:92F2            pb_waitConfirmOrTimeout:        ;command0A
  567           6010      .messageSpeed = $6010
  568           0024      .timeout = $24
  569  34:92F2  A9 08             lda #8
  570  34:92F4  38                sec
  571  34:92F5  ED 10 60          sbc .messageSpeed
  572  34:92F8  0A                asl a
  573  34:92F9  0A                asl a
  574  34:92FA  0A                asl a
  575  34:92FB  85 24             sta <.timeout
  576  34:92FD  F0 10             beq .finish
  577  34:92FF            .wait_loop:
  578  34:92FF  20 85 81                  jsr presentCharacter
  579  34:9302  20 AA FB                  jsr getPad1Input
  580  34:9305  A5 12                     lda <inputBits
  581  34:9307  29 01                     and #1
  582  34:9309  D0 04                     bne .finish
  583  34:930B  C6 24                     dec <.timeout
  584  34:930D  D0 F0                     bne .wait_loop
  585  34:930F            .finish:
  586  34:930F  60                rts
  587                     ;$9474
  588  34:9310            pb_free_begin:
  589           9474      pb_free_end = $9474
  590                     ;------------------------------------------------------------------------------------------------------
  591                             ;.org   $94d6
  592                             INIT_PATCH $34,$94d6,$9575
                0034              .bank   $34
                94D6              .org    $94d6
       34:94D6                    .ds             (($9575) - ($94d6))
                94D6              .org    $94d6
  593  34:94D6            pb_closeWindow: ;command00,01,02,04
  594           004B      .commandId = $4b
  595           78D6      .params = $78d6
  596  34:94D6  A6 4B             ldx <.commandId
  597  34:94D8  BD D6 78          lda .params,x
  598  34:94DB  20 82 90          jsr pb_checkNoMessage
  599  34:94DE  8A                txa
  600  34:94DF  4C 14 8E          jmp $8e14
  601                     ;$94e7:
  602                     ;------------------------------------------------------------------------------------------------------
  603  34:94E2            pb_backCommand: ;command03
  604           0064      .iCommand = $64
  605  34:94E2  AE EE 78          ldx battleMessageCount
  606  34:94E5  BD DA 78          lda battleMessages,x
  607  34:94E8  C9 FF             cmp #$ff
  608  34:94EA  F0 EA             beq pb_closeWindow
  609                     
  610  34:94EC  A2 04             ldx #4
  611  34:94EE  AD D5 78          lda battleProcessType
  612  34:94F1  F0 01             beq .decrement
  613  34:94F3  E8                        inx
  614  34:94F4            .decrement:
  615  34:94F4  C6 64                     dec <.iCommand
  616  34:94F6  CA                        dex
  617  34:94F7  D0 FB                     bne .decrement
  618  34:94F9            .finish:
  619  34:94F9  60                rts
  620                     ;$950d:
  621                     
  622                     ;======================================================================================================
  623                     ;       .org    $950d
  624                             ;INIT_PATCH $34,$950d,$9575
  625  34:94FA            pb_commandLists:
  626  34:94FA  08 95             .dw     pb_processType_00
  627  34:94FC  17 95             .dw     pb_processType_01
  628  34:94FE  26 95             .dw     pb_processType_02
  629  34:9500  2A 95             .dw     pb_processType_03
  630  34:9502  31 95             .dw     pb_processType_04
  631  34:9504  37 95             .dw     pb_processType_05
  632  34:9506  3C 95             .dw pb_processEx_00
  633                     ;       .org    $9519
  634  34:9508            pb_processType_00:
  635  34:9508  05 07 0B          .db $05,$07,$0B,$06,$0C,$08,$0D,$09,$0A,$04,$03,$01,$02,$00,$FF
       34:950B  06 0C 08  
       34:950E  0D 09 0A  
       34:9511  04 03 01  
       34:9514  02 00 FF  
  636  34:9517            pb_processType_01:
  637  34:9517  05 06 07          .db $05,$06,$07,$0B,$0C,$08,$09,$0D,$0A,$04,$03,$02,$01,$00,$FF
       34:951A  0B 0C 08  
       34:951D  09 0D 0A  
       34:9520  04 03 02  
       34:9523  01 00 FF  
  638  34:9526            pb_processType_02:
  639  34:9526  09 0A 04          .db $09,$0A,$04,$FF
       34:9529  FF        
  640  34:952A            pb_processType_03:      ;fire cannon
  641  34:952A  09 0B 0C          .db $09,$0B,$0C,$0E,$0A,$04,$FF
       34:952D  0E 0A 04  
       34:9530  FF        
  642  34:9531            pb_processType_04:
  643  34:9531  05 09 0A          .db $05,$09,$0A,$04,$00,$FF
       34:9534  04 00 FF  
  644  34:9537            pb_processType_05:
  645  34:9537  09 0C 0A          .db $09,$0C,$0A,$04,$FF
       34:953A  04 FF     
  646  34:953C            pb_processEx_00:
  647  34:953C  05                .db $05
  648  34:953D  06                .db $06
  649  34:953E  0F                .db $0f ;processDisorderedShot (ex)
  650           0000              .ifndef SHOW_INFO_ON_DISORDERED_SHOT
  654                             .endif  ;SHOW_INFO_ON_DISORDERED_SHOT
  655  34:953F  01                .db $01
  656  34:9540  00                .db $00
  657  34:9541  FF                .db $FF ;end
  658                     
  659                     ;       .org    $954d
  660  34:9542            pb_handlers:
  661  34:9542  D6 94             .dw     pb_closeWindow  ;00 $94d6
  662  34:9544  D6 94             .dw     pb_closeWindow  ;01 $94d6
  663  34:9546  D6 94             .dw pb_closeWindow      ;02 $94d6
  664  34:9548  E2 94             .dw pb_backCommand      ;03 $94e7
  665  34:954A  D6 94             .dw pb_closeWindow      ;04 $94d6
  666  34:954C  89 90             .dw pb_showActorName            ;05 905b
  667  34:954E  C7 90             .dw     pb_showActionName               ;06 90a0
  668  34:9550  96 90             .dw     pb_showTargetName               ;07 9177
  669  34:9552  A3 90             .dw     pb_showEffectMessage    ;08 91d4
  670  34:9554  47 91             .dw pb_showInfoMessage          ;09 $91fe
  671  34:9556  F2 92             .dw pb_waitConfirmOrTimeout     ;0a $9450
  672  34:9558  44 92             .dw pb_playEffect                       ;0b $934e
  673  34:955A  3F 92             .dw pb_showDamage                       ;0c $9354
  674  34:955C  47 92             .dw pb_showDyingEffect          ;0d $935f
  675  34:955E  7C 92             .dw pb_updateTargetCache        ;0e $93c4
  676  34:9560            pb_handlers_ex:
  677  34:9560  00 00             .dw 0   ;0f extenstion
  678  34:9562  00 00             .dw 0   ;10
  679                     ;       .org    $956b
  680  34:9564            pb_showInfoMessage_handlers:
  681  34:9564  82 91             .dw pb_showInfoMessage_00
  682  34:9566  93 91             .dw pb_showInfoMessage_01
  683  34:9568  E2 91             .dw pb_showInfoMessage_02
  684  34:956A  08 92             .dw pb_showInfoMessage_03
  685  34:956C  25 92             .dw pb_showInfoMessage_04
  686                     ;$9575:
  687                     ;======================================================================================================
  688                             RESTORE_PC ff3_present_battle_begin
                0000              .bank   BANK(ff3_present_battle_begin)
                8000              .org    ff3_present_battle_begin
#[3]   ff3_hack_master.asm
#[4]   ff3_info_window.asm
   39                                     .include "ff3_info_window.asm"          ;save
    1                     ; ff3_info_window
    2                     ;
    3                     ;description:
    4                     ;       replaces code for information window (larger window on the bottom right)
    5                     ;
    6                     ;version:
    7                     ;       0.01 (2006-10-24)
    8                     ;
    9                     ;======================================================================================================
   10  00:8000            ff3_info_window_begin:
   11                     
   12                             INIT_PATCH      $34,$9ba2,$9ce3
                0034              .bank   $34
                9BA2              .org    $9ba2
       34:9BA2                    .ds             (($9ce3) - ($9ba2))
                9BA2              .org    $9ba2
   13  34:9BA2            drawInfoWindow:
   14           0052      .iPlayer = $52
   15           0057      .pBaseParam = $57
   16           005B      .pBattleParam = $5b
   17           78CF      .commandIds = $78cf
   18                     
   19  34:9BA2  AD EB 7C          lda $7ceb
   20  34:9BA5  F0 06             beq .continue_process
   21  34:9BA7  A9 00                     lda #0
   22  34:9BA9  8D EB 7C                  sta $7ceb
   23  34:9BAC  60                        rts
   24  34:9BAD            .continue_process:
   25  34:9BAD  20 54 97          jsr initTileArrayStorage
   26                             ;INIT16 $720a,$7977
   27                             INIT16 TILE_ARRAY_BASE+$0a,$7977        ;'H' 'P'
       34:9BB0  A9 77             lda #LOW($7977)
       34:9BB2  8D 2A 72          sta TILE_ARRAY_BASE+$0a
       34:9BB5  A9 79             lda #HIGH($7977)
       34:9BB7  8D 2B 72          sta TILE_ARRAY_BASE+$0a+1
   28  34:9BBA  A5 52             lda <.iPlayer
   29  34:9BBC  48                pha
   30  34:9BBD  A2 00             ldx #0
   31  34:9BBF            .for_each_player:
   32  34:9BBF  86 52                     stx <.iPlayer
   33  34:9BC1  A2 12                     ldx #$12
   34  34:9BC3  20 49 A5                  jsr initString
   35                                     ;$7ae3 = #c7;
   36  34:9BC6  20 41 A5                  jsr getPlayerOffset     ;a541
   37  34:9BC9  18                        clc
   38  34:9BCA  69 0B                     adc #$0b
   39  34:9BCC  A8                        tay
   40  34:9BCD  A2 06                     ldx #6
   41  34:9BCF                    .copy_name:
   42  34:9BCF  B1 57                             lda [.pBaseParam],y
   43  34:9BD1  9D D7 7A                          sta stringCache,x
   44  34:9BD4  88                                dey
   45  34:9BD5  CA                                dex
   46  34:9BD6  D0 F7                             bne .copy_name
   47                                             
   48  34:9BD8  A2 0B                     ldx #7+4
   49  34:9BDA  A9 03                     lda #3
   50  34:9BDC  20 8D 9C                  jsr getStringFromValueAt        ;ex
   51                     
   52                                     ;lda #0
   53                                     ;sta <$24
   54  34:9BDF  20 1D 9D                  jsr cachePlayerStatus   ;9d1d
   55  34:9BE2  AD E8 7C                  lda $7ce8
   56  34:9BE5  C9 FF                     cmp #$ff
   57  34:9BE7  F0 5A                     beq .show_maxhp
   58                     
   59  34:9BE9  A6 52                             ldx <.iPlayer
   60  34:9BEB  BD CF 78                          lda .commandIds,x
   61  34:9BEE  C9 FF                             cmp #$ff
   62  34:9BF0  F0 1F                             beq .check_status
   63                     
   64  34:9BF2  C9 C8                                     cmp #$c8
   65  34:9BF4  90 0C                                     bcc .not_magic
   66  34:9BF6                                    .action_is_magic:
   67                                                             INIT16_x <$18, ($8990 - $c8 * 2)
       34:9BF6  A2 00             ldx #LOW(($8990 - $c8 * 2))
       34:9BF8  86 18             stx <$18
       34:9BFA  A2 88             ldx #HIGH(($8990 - $c8 * 2))
       34:9BFC  86 19             stx <$18+1
   68  34:9BFE  A2 0C                                             ldx #$0c
   69  34:9C00  D0 3B                                             bne .load_string
   70  34:9C02                                    .not_magic:
   71           0001              .ifdef ENABLE_EXTRA_ABILITY
   72  34:9C02  20 B0 9C                                          jsr getExtraAbilityNameId
   73                             .endif ;ENABLE_EXTRA_ABILITY
   74                                                             INIT16_x <$18, $8c40
       34:9C05  A2 40             ldx #LOW($8c40)
       34:9C07  86 18             stx <$18
       34:9C09  A2 8C             ldx #HIGH($8c40)
       34:9C0B  86 19             stx <$18+1
   75  34:9C0D  A2 0D                                             ldx #$0d
   76  34:9C0F  D0 2C                                             bne .load_string
   77  34:9C11                            .check_status:
   78  34:9C11  A5 1B                             lda <$1b
   79  34:9C13  05 1A                             ora <$1a
   80  34:9C15  F0 2C                             beq .show_maxhp
   81  34:9C17  A5 1B                                     lda <$1b
   82  34:9C19  29 20                                     and #$20
   83  34:9C1B  F0 0A                                     beq .status_bit_to_index
   84  34:9C1D  A5 1B                                             lda <$1b
   85  34:9C1F  29 DF                                             and #$df
   86  34:9C21  85 1B                                             sta <$1b
   87  34:9C23  05 1A                                             ora <$1a
   88  34:9C25  F0 1C                                             beq .show_maxhp
   89  34:9C27                                    .status_bit_to_index:
   90  34:9C27  A0 00                                     ldy #0
   91  34:9C29                                    .find_index:
   92  34:9C29  06 1B                                             asl <$1b
   93  34:9C2B  26 1A                                             rol <$1a
   94  34:9C2D  B0 03                                             bcs .got_index
   95  34:9C2F  C8                                                iny
   96  34:9C30  90 F7                                             bcc .find_index
   97  34:9C32                                    .got_index:
   98                                                     INIT16_x <$18,$822c
       34:9C32  A2 2C             ldx #LOW($822c)
       34:9C34  86 18             stx <$18
       34:9C36  A2 82             ldx #HIGH($822c)
       34:9C38  86 19             stx <$18+1
   99  34:9C3A  98                                        tya
  100  34:9C3B  A2 0D                                     ldx #$0d
  101                                                     ;bne .load_string
  102  34:9C3D                            .load_string:
  103  34:9C3D  20 09 A6                          jsr loadString
  104  34:9C40  4C 60 9C                          jmp .to_tiles
  105                     ;$9c7f:
  106  34:9C43                            .show_maxhp:
  107  34:9C43  AD E8 7C                          lda $7ce8
  108  34:9C46  C9 FF                             cmp #$ff
  109  34:9C48  F0 0F                             beq .get_maxhp
  110  34:9C4A  AD E1 7B                                  lda $7be1
  111  34:9C4D  A6 52                                     ldx <.iPlayer
  112  34:9C4F  20 38 FD                                  jsr maskTargetBit
  113  34:9C52  F0 05                                     beq .get_maxhp
  114  34:9C54  BD CF 78                                          lda .commandIds,x
  115  34:9C57  D0 9D                                             bne .action_is_magic
  116  34:9C59                            .get_maxhp:
  117  34:9C59  A2 10                             ldx #$10
  118  34:9C5B  A9 05                             lda #5
  119  34:9C5D  20 8D 9C                          jsr getStringFromValueAt
  120                     ;$9cba:
  121                                     ;$7ae3 = #c7;
  122  34:9C60                    .to_tiles:
  123  34:9C60  A9 C7                     lda #$c7
  124  34:9C62  8D E3 7A                  sta stringCache+$0c
  125  34:9C65  A9 12                     lda #$12
  126  34:9C67  85 18                     sta <$18
  127  34:9C69  20 6A 96                  jsr strToTileArray
  128  34:9C6C  A9 12                     lda #$12
  129  34:9C6E  20 58 A5                  jsr offsetTilePtr
  130  34:9C71  A6 52                     ldx <.iPlayer
  131  34:9C73  E8                        inx
  132  34:9C74  E0 04                     cpx #4
  133  34:9C76  F0 03                     beq .finish
  134  34:9C78  4C BF 9B                  jmp .for_each_player
  135                     ;$9cd1:
  136  34:9C7B            .finish:
  137  34:9C7B  68                pla
  138  34:9C7C  85 52             sta <.iPlayer
  139  34:9C7E  A9 0B             lda #$0b
  140  34:9C80  85 18             sta <$18
  141  34:9C82  A9 1E             lda #$1e
  142  34:9C84  85 19             sta <$19
  143  34:9C86  A9 03             lda #$03
  144  34:9C88  85 1A             sta <$1a
  145  34:9C8A  4C 38 8B          jmp draw8LineWindow
  146                     ;------------------------------------------------------------------------------------------------------
  147  34:9C8D            getStringFromValueAt:
  148                     ;[in] x = dest end offset
  149                     ;[in] a = offset to value
  150           005B      .pBattleParam = $5b
  151  34:9C8D  20 88 9B          jsr setYtoOffsetOf
  152  34:9C90  B1 5B             lda [.pBattleParam],y
  153  34:9C92  85 18             sta <$18
  154  34:9C94  C8                iny
  155  34:9C95  B1 5B             lda [.pBattleParam],y
  156  34:9C97  85 19             sta <$19
  157  34:9C99  8A                txa
  158  34:9C9A  48                pha
  159  34:9C9B  20 E1 95          jsr itoa_16     ;95e1
  160  34:9C9E  68                pla
  161  34:9C9F  A8                tay
  162  34:9CA0  A2 03             ldx #3
  163  34:9CA2            .copy:
  164  34:9CA2  B5 1B                     lda <$1b,x
  165  34:9CA4  99 D7 7A                  sta stringCache,y
  166  34:9CA7  88                        dey
  167  34:9CA8  CA                        dex
  168  34:9CA9  10 F7                     bpl .copy
  169  34:9CAB  60                rts
  170                     
  171  34:9CAC            infoWindow_free_begin:
  172           9CE3      infoWindow_free_end = $9ce3
  173                     ;------------------------------------------------------------------------------------------------------
  174                     ;$9ce3
  175                     ;======================================================================================================
  176                             RESTORE_PC ff3_info_window_begin
                0000              .bank   BANK(ff3_info_window_begin)
                8000              .org    ff3_info_window_begin
#[3]   ff3_hack_master.asm
#[4]   ff3_executeAction.asm
   40                                     .include "ff3_executeAction.asm"        ;save
    1                     ; ff3_executeAction.asm
    2                     ;
    3                     ;description:
    4                     ;       replaces executeAction()
    5                     ;
    6                     ;version:
    7                     ;       0.01 (2006-10-26)
    8                     ;
    9                     ;======================================================================================================
   10  00:8000            ff3_executeAction_begin:
   11                     
   12                             ;INIT_PATCH $34,$9de4,$9fac
   13           0034              .bank   $34
   14           9DE4              .org    $9de4
   15  34:9DE4            executeAction:
   16                     ;[in]
   17           7AC2      .currentActor = $7ac2
   18           7ACB      .ordinalToIndex = $7acb
   19                     ;[local]
   20           006E      .pActor = $6e
   21           0070      .pTarget = $70
   22                     
   23  34:9DE4  AE C2 7A          ldx .currentActor
   24  34:9DE7  BD CB 7A          lda .ordinalToIndex,x
   25  34:9DEA  48                pha
   26                             
   27  34:9DEB  10 05             bpl .actor_is_player_char
   28  34:9DED  18                        clc
   29  34:9DEE  29 7F                     and #$7f
   30  34:9DF0  69 04                     adc #4
   31  34:9DF2            .actor_is_player_char:
   32                     ;$9df3:
   33  34:9DF2  85 18             sta <$18
   34  34:9DF4  85 26             sta <$26
   35                             
   36  34:9DF6  A9 40             lda #$40
   37  34:9DF8  85 1A             sta <$1a
   38                             INIT16 <$20,$7575
       34:9DFA  A9 75             lda #LOW($7575)
       34:9DFC  85 20             sta <$20
       34:9DFE  A9 75             lda #HIGH($7575)
       34:9E00  85 21             sta <$20+1
   39                             
   40  34:9E02  20 2E 80          jsr dispatchBattleFunction_07   ;802e => calcDataAddress
   41                     
   42  34:9E05  A5 1C             lda <$1c
   43  34:9E07  85 6E             sta <.pActor
   44  34:9E09  A5 1D             lda <$1d
   45  34:9E0B  85 6F             sta <.pActor+1
   46                     
   47  34:9E0D  A5 26             lda <$26
   48  34:9E0F  C9 0C             cmp #$0c
   49  34:9E11  90 03             bcc .actor_valid
   50                                     ;?
   51  34:9E13  68                        pla
   52  34:9E14  D0 39                     bne .check_status       ;$9e5f
   53  34:9E16            .actor_valid:
   54  34:9E16  68                pla
   55  34:9E17  A8                tay
   56  34:9E18  29 87             and #$87
   57  34:9E1A  8D D6 78          sta $78d6       ;actor name
   58  34:9E1D  29 7F             and #$7f
   59  34:9E1F  AA                tax
   60                             ;lda #0
   61                             ;jsr flagTargetBit
   62  34:9E20  20 BA 9F          jsr flagSingleTarget
   63  34:9E23  8D 98 7E          sta $7e98
   64  34:9E26  98                tya     ;actor index|flag
   65                     
   66  34:9E27  10 26             bpl .check_status
   67                                     ;actor enemy
   68  34:9E29  AD 9A 7E                  lda $7e9a
   69  34:9E2C  09 80                     ora #$80
   70  34:9E2E  8D 9A 7E                  sta $7e9a
   71                                     
   72                                     ;a = $7ced;
   73                                     ;if( ((#55 == $7ced) && ($7cee == 0))
   74                                     ;       || ( ((#79 == $7ced) || (#90 == $7ced)) && ($7cee != 0) ) )
   75  34:9E31  AD ED 7C                  lda $7ced
   76  34:9E34  AE EE 7C                  ldx $7cee
   77  34:9E37  D0 06                     bne ._7cee_not_0
   78  34:9E39  C9 55                             cmp #$55
   79  34:9E3B  D0 12                             bne .check_status
   80  34:9E3D  F0 08                             beq .heal_hp
   81  34:9E3F                    ._7cee_not_0:
   82  34:9E3F  C9 79                             cmp #$79
   83  34:9E41  F0 04                             beq .heal_hp
   84  34:9E43  C9 90                             cmp #$90
   85  34:9E45  D0 08                             bne .check_status
   86  34:9E47                    .heal_hp:
   87  34:9E47  A0 06                             ldy #6
   88  34:9E49  B1 6E                             lda [.pActor],y
   89  34:9E4B  A0 04                             ldy #4
   90  34:9E4D  91 6E                             sta [.pActor],y
   91  34:9E4F            .check_status:  ;$9e5f:
   92  34:9E4F  A0 01             ldy #1
   93  34:9E51  B1 6E             lda [.pActor],y
   94  34:9E53  29 C0             and #$c0        ;dead|stone
   95  34:9E55  D0 68             bne .actor_status_bad
   96                                     ;check more
   97  34:9E57  C8                        iny
   98  34:9E58  B1 6E                     lda [.pActor],y
   99  34:9E5A  29 C0                     and #$c0        ;paralyzed | sleeping
  100  34:9E5C  F0 0B                     beq .actor_status_ok
  101  34:9E5E  A9 01                             lda #1
  102  34:9E60  20 7B 9F                          jsr setActorActionAndClearMode  ;$9f7b
  103  34:9E63  20 CE 91                          jsr setNoTargetMessage  ;$91ce
  104  34:9E66  20 87 9F                          jsr setActionTargetToSelf       ;$9f87
  105                     ;$9e93:
  106  34:9E69                    .actor_status_ok:
  107  34:9E69  A0 2F                     ldy #$2f
  108  34:9E6B  B1 6E                     lda [.pActor],y
  109  34:9E6D  8D 99 7E                  sta $7e99
  110  34:9E70  8D 9B 7E                  sta $7e9b
  111  34:9E73  D0 03                     bne .target_valid
  112  34:9E75  20 87 9F                          jsr setActionTargetToSelf
  113  34:9E78                    .target_valid:
  114  34:9E78  A2 00                     ldx #0
  115  34:9E7A                    .target_bit_to_index:
  116  34:9E7A  0A                                asl a
  117  34:9E7B  B0 03                             bcs .got_index
  118  34:9E7D  E8                                inx
  119  34:9E7E  D0 FA                             bne .target_bit_to_index
  120  34:9E80                    .got_index:
  121  34:9E80  8A                        txa
  122  34:9E81  48                        pha
  123                                     
  124  34:9E82  C8                        iny
  125  34:9E83  B1 6E                     lda [.pActor],y ;+30
  126  34:9E85  A8                        tay
  127                                     
  128  34:9E86  10 11                     bpl .target_player
  129  34:9E88  AD 9A 7E                          lda play_effectTargetSide       ;$7e9a
  130  34:9E8B  09 40                             ora #$40
  131  34:9E8D  8D 9A 7E                          sta play_effectTargetSide       ;$7e9a
  132                                             
  133  34:9E90  68                                pla
  134  34:9E91  09 80                             ora #$80
  135  34:9E93  48                                pha     ;sta $78d8
  136                     
  137  34:9E94  18                                clc
  138  34:9E95  8A                                txa
  139  34:9E96  69 04                             adc #4
  140  34:9E98  AA                                tax
  141                                             ;bne .set_target_name
  142  34:9E99                    .target_player:
  143  34:9E99                    .set_target_name:
  144  34:9E99  86 18                     stx <$18        ;actor ordinal
  145  34:9E9B  68                        pla     ;target index
  146  34:9E9C  AA                        tax
  147                                     
  148  34:9E9D  98                        tya     ;target flag
  149  34:9E9E  0A                        asl a
  150  34:9E9F  10 02                     bpl .target_single
  151  34:9EA1  A2 88                             ldx #$88
  152  34:9EA3                    .target_single:
  153  34:9EA3  8E D8 78                  stx $78d8
  154                     
  155  34:9EA6  A9 40                     lda #$40
  156  34:9EA8  85 1A                     sta <$1a
  157                                     INIT16 <$20,$7575
       34:9EAA  A9 75             lda #LOW($7575)
       34:9EAC  85 20             sta <$20
       34:9EAE  A9 75             lda #HIGH($7575)
       34:9EB0  85 21             sta <$20+1
  158  34:9EB2  20 2E 80                  jsr dispatchBattleFunction_07   ;$802e
  159                                     
  160  34:9EB5  A5 1C                     lda <$1c
  161  34:9EB7  85 70                     sta <.pTarget
  162  34:9EB9  A5 1D                     lda <$1d
  163  34:9EBB  85 71                     sta <.pTarget+1
  164  34:9EBD  D0 15                     bne .check_action_mode  ;target address should be $75xx-$77xx
  165                                     ;bne
  166  34:9EBF            .actor_status_bad
  167  34:9EBF  88                        dey
  168  34:9EC0  98                        tya
  169  34:9EC1  8C C2 7E                  sty effectHandlerIndex  ;$7ec2
  170  34:9EC4  8C 98 7E                  sty $7e98
  171  34:9EC7  88                        dey
  172  34:9EC8  8C EB 7C                  sty $7ceb
  173  34:9ECB  8C D8 78                  sty $78d8
  174  34:9ECE  8C D6 78                  sty $78d6
  175  34:9ED1  20 7B 9F                  jsr setActorActionAndClearMode  ;$9f7b
  176                     ;$9eec:
  177                     ;-----------------------------
  178  34:9ED4            .check_action_mode:
  179           001A      .actionId = $1a
  180  34:9ED4  A0 2E             ldy #$2e
  181  34:9ED6  B1 6E             lda [.pActor],y
  182  34:9ED8  85 1A             sta <.actionId  ;actionid
  183                             
  184  34:9EDA  20 2E A4          jsr getActor2C
  185  34:9EDD  AA                tax
  186  34:9EDE  29 10             and #$10        ;special
  187  34:9EE0  D0 36             bne .special_attack     ;$9f5a
  188  34:9EE2  8A                txa
  189  34:9EE3  29 08             and #$08
  190  34:9EE5  D0 0A             bne .use_item   ;$9f19
  191                     ;$9f0b:
  192  34:9EE7  A5 1A             lda <.actionId
  193           0001              .ifdef ENABLE_EXTRA_ABILITY
  194  34:9EE9  C9 1A                     cmp #CMDX_ID_END
  195                             .else
  197                             .endif
  198  34:9EEB  90 2D             bcc .dispatch
  199  34:9EED  C9 46             cmp #$46
  200  34:9EEF  B0 04             bcs .check_caster
  201                             ;invalid action id
  202  34:9EF1            .use_item:
  203  34:9EF1  A9 13             lda #$13
  204  34:9EF3  D0 25             bne .dispatch
  205  34:9EF5            .check_caster:
  206                             ;jsr getActor2C
  207  34:9EF5  8A                txa
  208  34:9EF6  30 20             bmi .special_attack
  209                     ;decrement mp
  210           0052      .iPlayer = $52
  211  34:9EF8  29 07                     and #7
  212  34:9EFA  AA                        tax
  213  34:9EFB  BD C7 7A                  lda selectedMagicLv,x
  214  34:9EFE  18                        clc
  215  34:9EFF  69 07                     adc #7
  216  34:9F01  A8                        tay
  217  34:9F02  38                        sec
  218  34:9F03  B1 6E                     lda [.pActor],y ;mp
  219  34:9F05  E9 01                     sbc #1
  220  34:9F07  91 6E                     sta [.pActor],y
  221                                     
  222  34:9F09  A5 1A                     lda <.actionId
  223  34:9F0B  A2 07                     ldx #7
  224  34:9F0D                    .check_summon_id:
  225  34:9F0D  DD 2C 9F                          cmp .summonMagicIds,x
  226  34:9F10  D0 03                             bne .check_summon_next
  227  34:9F12  4C 00 A0                                  jmp executeAction_summon
  228  34:9F15                            .check_summon_next:
  229  34:9F15  CA                                dex
  230  34:9F16  10 F5                             bpl .check_summon_id
  231  34:9F18            .special_attack:        ;$9f5a
  232  34:9F18  A9 14             lda #$14
  233  34:9F1A            .dispatch:      ;$9f5c
  234  34:9F1A  8D C2 7E          sta effectHandlerIndex  ;$7ec2
  235                     
  236  34:9F1D  0A                asl a
  237  34:9F1E  AA                tax
  238  34:9F1F  BD 34 9F          lda executeAction_handlers,x
  239  34:9F22  85 18             sta <$18
  240  34:9F24  BD 35 9F          lda executeAction_handlers+1,x
  241  34:9F27  85 19             sta <$19
  242  34:9F29  6C 18 00          jmp [$0018]
  243  34:9F2C            .summonMagicIds:
  244  34:9F2C  CE D5 DC          .db $ce,$d5,$dc,$e3,$ea,$f1,$f8,$ff
       34:9F2F  E3 EA F1  
       34:9F32  F8 FF     
  245  34:9F34            executeAction_end:
  246                     ;======================================================================================================
  247           9FA8      command_none            = $9fa8
  248           A68A      command_01                      = $a68a
  249                     ;command_forward        = $a7df
  250                     ;command_back           = $a7ea
  251                     ;command_fight          = $a104
  252                     ;command_guard          = $a881
  253                     ;command_escape         = $a8bf
  254                     ;command_sneakAway      = $a93b
  255                     ;command_jump           = $a9d8
  256                     ;command_land           = $aa11
  257                     ;command_0A                     = $a89f
  258                     ;command_geomance       = $aa5d
  259                     ;command_inspect        = $ab73
  260                     ;command_detect         = $ab0c
  261                     ;command_steal          = $aba4
  262                     ;command_charge         = $ac6f
  263                     ;command_sing           = $acd5
  264                     ;command_intimidate     = $ad16
  265                     ;command_cheer          = $ad75
  266           A3BB      command_item            = $a3bb
  267           A367      command_magic           = $a367
  268                     ;------------------------------------------------------------------------------------------------------
  269                     ;       .org    $9fac
  270                             INIT_PATCH $34,$9fac,$9fac+($02*$15)
                0034              .bank   $34
                9FAC              .org    $9fac
       34:9FAC                    .ds             (($9fac+($02*$15)) - ($9fac))
                9FAC              .org    $9fac
  271                             RESTORE_PC executeAction_end
                0034              .bank   BANK(executeAction_end)
                9F34              .org    executeAction_end
  272                     
  273  34:9F34            executeAction_handlers: ;$9fac: //function table
  274  34:9F34  A8 9F             .dw     command_none            ;$9fa8
  275  34:9F36  8A A6             .dw command_01                  ;$a68a
  276  34:9F38  3D A8             .dw command_forward             ;$a7df
  277  34:9F3A  3D A8             .dw command_back                ;$a7ea
  278  34:9F3C  04 A1             .dw command_fight               ;$a104
  279  34:9F3E  6F A8             .dw command_guard               ;$a881
  280  34:9F40  86 A8             .dw command_escape              ;$a8bf
  281  34:9F42  10 A9             .dw command_sneakAway   ;$a93b
  282  34:9F44  3B A9             .dw command_jump                ;$a9d8
  283  34:9F46  5F A9             .dw command_land                ;$aa11
  284  34:9F48  A8 9F             .dw command_none                ;$9fa8
  285  34:9F4A  70 A9             .dw command_geomance    ;$aa5d
  286  34:9F4C  51 AA             .dw command_inspect             ;$ab73
  287  34:9F4E  1F AA             .dw command_detect              ;$ab0c
  288  34:9F50  78 AA             .dw command_steal               ;$aba4
  289  34:9F52  0B AB             .dw command_charge              ;$ac6f
  290  34:9F54  55 AB             .dw command_sing                ;$acd5
  291  34:9F56  73 AB             .dw command_intimidate  ;$ad16
  292  34:9F58  B0 AB             .dw command_cheer               ;$ad75
  293  34:9F5A  BB A3             .dw command_item                ;$a3bb
  294  34:9F5C  67 A3             .dw command_magic               ;$a367
  295                             ;extension to original
  296  34:9F5E  00 00             .dw 0   ;dummy
  297  34:9F60  18 B6             .dw cmdx_provoke
  298  34:9F62  ED B6             .dw cmdx_disorderedShot
  299  34:9F64  BB B8             .dw cmdx_abyss
  300  34:9F66  F0 B8             .dw cmdx_raid
  301  34:9F68            executeAction_free_begin:
  302                     ;$9f7b
  303                     ;======================================================================================================
  304                     ;$34:9f7b setActorCommandIdAndClearMode
  305                     
  306                     ;$34:9f87 setActionTargetToSelf //setActionTargetBitAndFlags
  307                     
  308                     ;$34:9fa8 handleCommand00_0a //do nothing
  309                     ;======================================================================================================
  310                             INIT_PATCH $34,$9fa6,$a000
                0034              .bank   $34
                9FA6              .org    $9fa6
       34:9FA6                    .ds             (($a000) - ($9fa6))
                9FA6              .org    $9fa6
  311                     ;------------------------------------------------------------------------------------------------------
  312  34:9FA6            setXtoTargetIndex:
  313           0070      .pTarget = $70
  314  34:9FA6  A0 2C             ldy #$2c
  315  34:9FA8  B1 70             lda [.pTarget],y
  316  34:9FAA  4C B0 9F          jmp maskToIndex
  317                     ;       and #$07
  318                     ;       tax
  319                     ;       rts
  320                     
  321  34:9FAD            setXtoActorIndex:
  322  34:9FAD  20 2E A4          jsr getActor2C
  323  34:9FB0            maskToIndex:
  324  34:9FB0  29 07             and #7
  325  34:9FB2  AA                tax
  326  34:9FB3  60                rts
  327                     
  328  34:9FB4            setXtoActorIndex16:
  329  34:9FB4  20 AD 9F          jsr setXtoActorIndex
  330  34:9FB7  0A                asl a
  331  34:9FB8  AA                tax
  332  34:9FB9  60                rts
  333                     
  334  34:9FBA            flagSingleTarget:
  335                     ;[in] x = targetIndex
  336  34:9FBA  A9 00             lda #0
  337  34:9FBC  4C 20 FD          jmp flagTargetBit
  338                     
  339  34:9FBF            addBattleMessage:
  340                     ;[in] a : msg
  341                     ;[in,out] x : count
  342  34:9FBF  AE EE 78          ldx battleMessageCount
  343  34:9FC2  9D DA 78          sta battleMessages,x
  344  34:9FC5  E8                inx
  345  34:9FC6  8E EE 78          stx battleMessageCount
  346                             ;inc battleMessageCount
  347  34:9FC9  60                rts
  348                     
  349  34:9FCA            swapDamages:
  350  34:9FCA  A2 0F             ldx #$0f
  351  34:9FCC            .swap:
  352  34:9FCC  BD 4F 7E                  lda play_damages,x
  353  34:9FCF  48                        pha
  354  34:9FD0  BD 5F 7E                  lda play_damages+$10,x
  355  34:9FD3  9D 4F 7E                  sta play_damages,x
  356  34:9FD6  68                        pla
  357  34:9FD7  9D 5F 7E                  sta play_damages+$10,x
  358  34:9FDA  CA                        dex
  359  34:9FDB  10 EF                     bpl .swap
  360  34:9FDD  60                rts
  361                     
  362  34:9FDE            swapHitCounts:
  363           00BB      .hitCount = $bb
  364           7900      .temp = TEMP_RAM
  365  34:9FDE  A2 01             ldx #1
  366  34:9FE0            .save:
  367  34:9FE0  B4 BB                     ldy <.hitCount,x
  368  34:9FE2  BD 00 79                  lda .temp,x
  369  34:9FE5  95 BB                     sta <.hitCount,x
  370  34:9FE7  98                        tya
  371  34:9FE8  9D 00 79                  sta .temp,x
  372  34:9FEB  CA                        dex
  373  34:9FEC  10 F2                     bpl .save
  374  34:9FEE  60                rts
  375                     
  376                     ;workaround for doFight behavior
  377  34:9FEF            initAllDamages:
  378  34:9FEF  A2 E0             ldx #$e0
  379  34:9FF1  D0 02             bne initDamage
  380  34:9FF3            initActorDamages:
  381  34:9FF3  A2 F0             ldx #$f0
  382                             ;fall through
  383  34:9FF5            initDamage:
  384  34:9FF5  A9 FF             lda #$ff
  385  34:9FF7            .fill:
  386  34:9FF7  9D 6F 7D                  sta play_damages+$10-$f0,x
  387  34:9FFA  E8                        inx
  388  34:9FFB  D0 FA                     bne .fill
  389  34:9FFD  60                rts
  390                     ;------------------------------------------------------------------------------------------------------
  391                             INIT_PATCH $35,$a000,$a104
                0035              .bank   $35
                A000              .org    $a000
       35:A000                    .ds             (($a104) - ($a000))
                A000              .org    $a000
  392                     
  393  35:A000            executeAction_summon:
  394           0018      .magicParamsCache = $18
  395                     ;.actionId = $26
  396                     ;.targetBit = $27
  397                     ;.targetFlag = $28
  398           0030      .summonType = $30
  399           0052      .iPlayer = $52
  400           006E      .pActor = $6e
  401                     
  402  35:A000  A2 3F             ldx #$3f
  403  35:A002  A9 00             lda #0
  404  35:A004  8D 93 7E          sta $7e93
  405  35:A007            .init_char_struct:
  406  35:A007  9D 75 78                  sta $7875,x
  407  35:A00A  CA                        dex
  408  35:A00B  10 FA                     bpl .init_char_struct
  409  35:A00D  A9 02             lda #2
  410  35:A00F  85 30             sta <.summonType
  411                     ;original checks job == #13 || #14
  412  35:A011  A0 3C             ldy #EXTRA_ABILITY_OFFSET
  413  35:A013  B1 6E             lda [.pActor],y
  414  35:A015  29 10             and #PASSIVE_SUMMON_FUSION
  415  35:A017  D0 0D             bne .summon_fusion
  416                     ;$9ffc:
  417  35:A019  A9 63                     lda #99
  418  35:A01B  20 64 A5                  jsr getSys1Random       ;a564
  419  35:A01E  C9 32                     cmp #50
  420  35:A020  B0 02                     bcs .summon_black
  421  35:A022  C6 30                             dec <.summonType
  422  35:A024                    .summon_black:
  423  35:A024  C6 30                     dec <.summonType
  424  35:A026            .summon_fusion:
  425                     ;$a009:
  426                             ;.bank $35
  427                             
  428                             ;jsr getActor2C
  429                             ;and #7
  430                             ;sta <.iPlayer
  431                             ;tax
  432  35:A026  20 AD 9F          jsr setXtoActorIndex
  433  35:A029  BD C7 7A          lda selectedMagicLv,x
  434  35:A02C  48                pha
  435                             
  436  35:A02D  20 3E FD          jsr $fd3e       ;a<<=4
  437  35:A030  05 30             ora <.summonType
  438  35:A032  8D 94 7E          sta $7e94
  439                     
  440                     ;       INIT16 <.pActor,$7875
  441                     ;       setYtoOffsetOf(a = #0f);        //$9b88
  442  35:A035  A0 0F             ldy #$0f
  443  35:A037  A2 02             ldx #2
  444  35:A039            .load_params:
  445  35:A039  B1 6E                     lda [.pActor],y
  446  35:A03B  0A                        asl a
  447  35:A03C  95 18                     sta <.magicParamsCache,x
  448  35:A03E  C8                        iny
  449  35:A03F  CA                        dex
  450  35:A040  10 F7                     bpl .load_params
  451                     
  452  35:A042  A0 01             ldy #1
  453  35:A044  B1 6E             lda [.pActor],y
  454  35:A046  29 30             and #$30        ;toad|sealed
  455  35:A048  48                pha
  456                             
  457                             INIT16 <.pActor,$7875
       35:A049  A9 75             lda #LOW($7875)
       35:A04B  85 6E             sta <.pActor
       35:A04D  A9 78             lda #HIGH($7875)
       35:A04F  85 6F             sta <.pActor+1
  458                     
  459  35:A051  68                pla
  460  35:A052  91 6E             sta [.pActor],y
  461                             ;
  462  35:A054  88                dey
  463  35:A055  A5 1A             lda <.magicParamsCache+2        ;joblv
  464  35:A057  91 6E             sta [.pActor],y
  465                     
  466  35:A059  A0 0F             ldy #$0f
  467  35:A05B  A2 02             ldx #2
  468  35:A05D            .store_params:
  469  35:A05D  B5 18                     lda <.magicParamsCache,x
  470  35:A05F  91 6E                     sta [.pActor],y
  471  35:A061  C8                        iny
  472  35:A062  CA                        dex
  473  35:A063  10 F8                     bpl .store_params
  474  35:A065  A0 03             ldy #3
  475  35:A067  98                tya
  476  35:A068  91 6E             sta [.pActor],y ;hp
  477                             
  478  35:A06A  AE C2 7A          ldx $7ac2
  479  35:A06D  A9 88             lda #$88
  480  35:A06F  9D CB 7A          sta $7acb,x
  481                     
  482                             ;$6e[y] = getActor2C() | #90;
  483  35:A072  A0 2C             ldy #$2c
  484  35:A074  A9 90             lda #$90
  485  35:A076  91 6E             sta [.pActor],y
  486                     ;$a065:
  487  35:A078  68                pla     ;selectedMagicLv
  488  35:A079  85 18             sta <$18
  489  35:A07B  0A                asl a
  490  35:A07C  18                clc
  491  35:A07D  65 18             adc <$18
  492  35:A07F  65 30             adc <.summonType
  493  35:A081  AA                tax     ; a = selectedMagicLv*3 + summonType
  494                     
  495  35:A082  18                clc
  496  35:A083  69 78             adc #$78
  497  35:A085  8D DA 78          sta battleMessages
  498                             
  499  35:A088  8A                txa
  500  35:A089  18                clc
  501  35:A08A  69 21             adc #$21
  502  35:A08C  8D D9 78          sta effectMessage
  503                     
  504  35:A08F  8A                txa
  505  35:A090  69 5B             adc #$5b
  506  35:A092  85 18             sta <$18
  507  35:A094  48                pha     ;sta <.actionId
  508                             
  509  35:A095  A9 08             lda #8
  510  35:A097  85 1A             sta <$1a
  511                             INIT16 <$20,$98c0
       35:A099  A9 C0             lda #LOW($98c0)
       35:A09B  85 20             sta <$20
       35:A09D  A9 98             lda #HIGH($98c0)
       35:A09F  85 21             sta <$20+1
  512  35:A0A1  A2 00             ldx #0
  513  35:A0A3  20 3A BA          jsr loadTo7400FromBank30        ;$ba3a
  514                             
  515           7400      .actionParams = $7400
  516                             
  517  35:A0A6  2C 05 74          bit .actionParams+5
  518  35:A0A9  10 07             bpl .target_enemy
  519  35:A0AB  A9 F0                     lda #$f0
  520  35:A0AD  48                        pha
  521  35:A0AE  A9 40                     lda #$40
  522  35:A0B0  D0 11                     bne .store_action_params
  523  35:A0B2            .target_enemy:
  524  35:A0B2  50 07                     bvc .target_single
  525  35:A0B4  A9 FF                             lda #$ff
  526  35:A0B6  48                                pha
  527  35:A0B7                    .target_all:
  528  35:A0B7  A9 C0                             lda #$c0
  529  35:A0B9  D0 08                             bne .store_action_params
  530  35:A0BB                    .target_single:
  531                             
  532           0062      .targetBit = $62
  533                     
  534  35:A0BB  20 DA A0                          jsr invokePickRandomTarget
  535  35:A0BE  A5 62                             lda <.targetBit
  536  35:A0C0  48                                pha
  537  35:A0C1  A9 80                             lda #$80
  538  35:A0C3            .store_action_params:
  539  35:A0C3  A0 30             ldy #$30
  540  35:A0C5  91 6E             sta [.pActor],y ;target flag
  541  35:A0C7  88                dey
  542  35:A0C8  68                pla
  543  35:A0C9  91 6E             sta [.pActor],y ;target bit
  544  35:A0CB  88                dey
  545  35:A0CC  68                pla
  546  35:A0CD  91 6E             sta [.pActor],y ;action id
  547                     
  548                             INIT16 <$5d,$7675
       35:A0CF  A9 75             lda #LOW($7675)
       35:A0D1  85 5D             sta <$5d
       35:A0D3  A9 76             lda #HIGH($7675)
       35:A0D5  85 5E             sta <$5d+1
  549                     ;$a0ea:
  550  35:A0D7  4C E4 9D          jmp executeAction
  551                             ;jmp $9de4      ;executeAction
  552                     ;------------------------------------------------------------------------------------------------------
  553  35:A0DA            invokePickRandomTarget:
  554           004C      .battleFunctionId = $4c
  555  35:A0DA  A9 0A             lda #BF_PICK_RANDOM_TARGET
  556  35:A0DC  85 4C             sta <.battleFunctionId
  557  35:A0DE  4C F3 FD          jmp invoke_b30_battleFunction
  558                     ;$a104:
  559                     
  560                     ;======================================================================================================
  561                             RESTORE_PC ff3_executeAction_begin
                0000              .bank   BANK(ff3_executeAction_begin)
                8000              .org    ff3_executeAction_begin
#[3]   ff3_hack_master.asm
   41                                     
#[4]   ff3_command_window.asm
   42                                     .include "ff3_command_window.asm"
    1                     ; ff3_command_window.asm
    2                     ;
    3                     ;description:
    4                     ;       command window related codes
    5                     ;       implements 'extra ability' feature ready mechanism
    6                     ;
    7                     ;version:
    8                     ;       0.14 (2006-11-01)
    9                     ;======================================================================================================
   10  00:8000            ff3_commandWindow_begin:
   11                             INIT_PATCH $34,$986c,$99fd
                0034              .bank   $34
                986C              .org    $986c
       34:986C                    .ds             (($99fd) - ($986c))
                986C              .org    $986c
   12                     
   13           0001              .ifdef BETA
   14                     RET_TO_GET_COMMAND_INPUT        .macro
   15                             rts
   16                             .endm
   17                             
   18                             .else
   23                             .endif  ;beta
   24                     
   25           0001              .ifdef BETA
   26  34:986C            getPlayerCommandInput:
   27           0052      .iPlayer = $52
   28           0055      .cursorId = $55
   29           005B      .pPlayer = $5b
   30           005F      .playerOffset = $5f
   31           78BA      .beginningMode = $78ba  ;08:backattack 01:escapable? 80:enemy surprise attack
   32           78CF      .selectedCommands = $78cf       ;[4]
   33           7ED8      .battleMode = $7ed8
   34                     ;-------------------------------------
   35  34:986C  20 9E 9D          jsr drawEnemyNamesWindow        ;9d9e
   36  34:986F            .input_next:    
   37  34:986F  A6 52             ldx <.iPlayer
   38  34:9871  E0 04             cpx #4
   39  34:9873  F0 28             beq .drawHpWindow
   40  34:9875  AD E1 7B                  lda $7be1
   41  34:9878  20 2C FD                  jsr clearTargetBit      ;$fd2c
   42  34:987B  8D E1 7B                  sta $7be1
   43  34:987E  20 41 A5                  jsr getPlayerOffset
   44  34:9881  A8                        tay
   45  34:9882  C8                        iny
   46  34:9883  C8                        iny
   47  34:9884  B1 5B                     lda [.pPlayer],y
   48  34:9886  4A                        lsr a
   49  34:9887  90 0A                     bcc .not_jumping
   50  34:9889  20 94 9B                          jsr setYtoOffset2F
   51  34:988C  B1 5B                             lda [.pPlayer],y
   52  34:988E  9D 0F 7E                          sta $7e0f,x
   53  34:9891  D0 0A                             bne .drawHpWindow
   54  34:9893                    .not_jumping:
   55  34:9893  A9 FF                     lda #$ff
   56  34:9895  9D CF 78                  sta .selectedCommands,x
   57  34:9898  A9 00                     lda #0
   58  34:989A  9D 0F 7E                  sta $7e0f,x
   59  34:989D            .drawHpWindow:
   60  34:989D  20 A2 9B          jsr drawInfoWindow      ;9ba2
   61  34:98A0  20 33 A4          jsr $a433       ;endCommandInputIfDone
   62  34:98A3  20 41 A5          jsr getPlayerOffset     ;a541
   63  34:98A6  A6 52             ldx <.iPlayer
   64  34:98A8  BD E4 7C          lda $7ce4,x
   65  34:98AB  F0 0E             beq .check_status0
   66  34:98AD  48                        pha
   67  34:98AE  A9 23                     lda #$23
   68  34:98B0  20 88 9B                  jsr setYtoOffsetOf
   69  34:98B3  68                        pla
   70  34:98B4  91 5B                     sta [.pPlayer],y
   71  34:98B6  A9 00                     lda #0
   72  34:98B8  9D E4 7C                  sta $7ce4,x
   73  34:98BB            .check_status0: ;98bd
   74  34:98BB  A4 5F             ldy <.playerOffset
   75  34:98BD  C8                iny
   76  34:98BE  B1 5B             lda [.pPlayer],y
   77  34:98C0  29 C0             and #$c0        ;dead|stone
   78  34:98C2  F0 08             beq .check_status1
   79  34:98C4  E6 52                     inc <.iPlayer
   80  34:98C6  EE EB 7C                  inc $7ceb
   81  34:98C9  4C 6F 98                  jmp .input_next
   82  34:98CC            .check_status1: ;98ce
   83  34:98CC  C8                iny
   84  34:98CD  B1 5B             lda [.pPlayer],y
   85  34:98CF  4A                lsr a
   86  34:98D0  29 70             and #$70        ; (paralyze | sleep | confuse) >> 1
   87  34:98D2  F0 03             beq .check_jumping
   88  34:98D4  4C 6C A6                  jmp $a66c
   89  34:98D7            .check_jumping: ;98d8
   90  34:98D7  90 04             bcc .create_commandWindow
   91  34:98D9  E6 52                     inc <.iPlayer
   92  34:98DB  D0 92                     bne .input_next
   93  34:98DD            .create_commandWindow:  ;$98e3
   94  34:98DD  20 69 9A          jsr createCommandWindow ; $9a69
   95  34:98E0  20 9B 9B          jsr setYtoOffset2E      ;$9b9b
   96  34:98E3  A9 00             lda #0
   97  34:98E5  A2 03             ldx #3
   98  34:98E7            .init_action_params:
   99  34:98E7  91 5B             sta [.pPlayer],y
  100  34:98E9  C8                iny
  101  34:98EA  CA                dex
  102  34:98EB  D0 FA             bne .init_action_params
  103                             
  104  34:98ED  A9 2C             lda #$2c
  105  34:98EF  20 88 9B          jsr setYtoOffsetOf
  106  34:98F2  B1 5B             lda [.pPlayer],y
  107  34:98F4  29 F7             and #$f7
  108  34:98F6  91 5B             sta [.pPlayer],y
  109  34:98F8  98                tya
  110  34:98F9  18                clc
  111  34:98FA  69 13             adc #$13
  112  34:98FC  A8                tay
  113  34:98FD  B1 5B             lda [.pPlayer],y        ;y:+3f
  114  34:98FF  F0 03             beq .check_redraw_enemy_names
  115  34:9901  20 E7 9A                  jsr putCanceledItem     ;$9ae7
  116  34:9904            .check_redraw_enemy_names:
  117  34:9904  AD F3 7C          lda $7cf3
  118  34:9907  D0 25             bne .move_character
  119                                     ;1st phase
  120  34:9909  20 9E 9D                  jsr drawEnemyNamesWindow        ;9d9e
  121  34:990C  A9 00                     lda #0
  122  34:990E  20 0E FA                  jsr call_2e_9d53
  123  34:9911  AD D8 7E                  lda .battleMode
  124  34:9914  29 20                     and #$20
  125  34:9916  F0 06                     beq .check_surprise_attack
  126  34:9918  20 0B A5                          jsr $a50b
  127  34:991B  4C 6C 98                          jmp getPlayerCommandInput
  128  34:991E                    .check_surprise_attack:
  129  34:991E  AD BA 78                  lda .beginningMode ;$78ba
  130  34:9921  10 01                     bpl .wait_any_button
  131  34:9923  60                                rts
  132  34:9924                    .wait_any_button:
  133  34:9924  20 AA FB                          jsr getPad1Input
  134  34:9927  A5 12                             lda <inputBits
  135  34:9929  F0 F9                             beq .wait_any_button
  136  34:992B  20 69 9A                  jsr createCommandWindow
  137  34:992E            .move_character:        ;9940
  138  34:992E  A9 02             lda #2
  139  34:9930  20 0E FA          jsr call_2e_9d53        ;fa0e
  140  34:9933  A5 52             lda <.iPlayer
  141  34:9935  85 53             sta <$53
  142  34:9937  A9 00             lda #0
  143  34:9939  85 55             sta <.cursorId
  144  34:993B  85 24             sta <$24
  145  34:993D  85 25             sta <$25
  146  34:993F  85 1A             sta <$1a
  147  34:9941  20 66 89          jsr loadCursor  ;8966
  148                     
  149  34:9944            .input_wait:;9958
  150  34:9944  A0 03             ldy #3  ;to keep input accepted in 3 frames interval 
  151  34:9946            .wait_loop:     
  152  34:9946  20 80 FB                  jsr waitNmi
  153  34:9949  88                        dey
  154  34:994A  D0 FA                     bne .wait_loop
  155  34:994C  A9 00             lda #0
  156  34:994E  85 1B             sta <$1b
  157  34:9950  A9 03             lda #3
  158  34:9952  85 46             sta <$46        
  159                     
  160  34:9954  20 9E 89          jsr getInputAndUpdateCursorWithSound    ;899e
  161           0050      .inputCopy = $50
  162                     ;.invert = $18
  163           0023      .row = $23
  164                     
  165  34:9957  A9 01             lda #1
  166  34:9959  24 50             bit <.inputCopy
  167  34:995B  D0 42             bne .OnA
  168  34:995D  A9 02             lda #2
  169  34:995F  24 50             bit <.inputCopy
  170  34:9961  D0 10             bne .OnB
  171  34:9963  70 19             bvs .OnLeft
  172  34:9965  10 DD             bpl .input_wait
  173  34:9967            .OnRight:
  174  34:9967  A0 00                     ldy #0
  175  34:9969  A6 25                     ldx <$25
  176  34:996B  D0 1E                     bne .change_position
  177  34:996D  84 24                             sty <$24
  178  34:996F  E6 25                             inc <$25
  179  34:9971  10 D1                             bpl .input_wait
  180  34:9973            .OnB:
  181  34:9973  A5 52             lda <.iPlayer
  182  34:9975  F0 03             beq .back_input_char
  183  34:9977  20 42 9A                  jsr $9a42
  184  34:997A            .back_input_char:
  185  34:997A  A9 01             lda #1
  186  34:997C  D0 4C             bne .go_next_char
  187                             ;jmp getCommandInput_next
  188  34:997E            .OnLeft:
  189  34:997E  A0 01                     ldy #1
  190  34:9980  A6 24                     ldx <$24
  191  34:9982  D0 07                     bne .change_position
  192  34:9984  84 24                             sty <$24
  193  34:9986  88                                dey
  194  34:9987  84 25                             sty <$25
  195  34:9989  F0 B9                             beq .input_wait
  196  34:998B                    .change_position:
  197  34:998B  A9 08                     lda #8
  198  34:998D  2C BA 78                  bit $78ba       ;backattack flag
  199  34:9990  F0 04                     beq .back
  200  34:9992  A9 04                             lda #4
  201  34:9994  D0 02                             bne .store_command
  202  34:9996                    .back:
  203  34:9996  A9 05                             lda #5
  204  34:9998                    .store_command:
  205  34:9998  85 23                     sta <.row
  206  34:999A  98                        tya
  207  34:999B  45 23                     eor <.row
  208  34:999D  85 23                     sta <.row
  209  34:999F            .OnA:   ;99c6
  210  34:999F  20 7D 9B          jsr requestSoundEffect05        ;9b7d
  211                             ;v0.6.2 fix
  212                             ;lda #0
  213                             ;sta <$18
  214                             ;<--
  215                             ;jsr clearSprites2x2            ;8adf
  216  34:99A2  20 E3 99          jsr clearCursor0
  217                             
  218  34:99A5  A6 23             ldx <.row
  219  34:99A7  BD 00 74          lda $7400,x
  220  34:99AA  48                pha
  221  34:99AB  A6 52             ldx <.iPlayer
  222  34:99AD  9D CF 78          sta .selectedCommands,x
  223  34:99B0  A5 23             lda <.row
  224  34:99B2  9D C3 7A          sta $7ac3,x
  225  34:99B5  68                pla             ;commandId
  226                             ;v0.6.3 --->
  227  34:99B6  AA                tax
  228                             ;<---
  229  34:99B7  0A                asl a
  230  34:99B8  18                clc
  231  34:99B9  69 EA             adc #LOW(commandWindow_handlers)
  232  34:99BB  85 19             sta <$19
  233  34:99BD  A9 00             lda #0
  234  34:99BF  69 99             adc #HIGH(commandWindow_handlers)
  235  34:99C1  85 1A             sta <$1a
  236  34:99C3  A9 6C             lda #$6c        ;jmp (addr)
  237  34:99C5  85 18             sta <$18
  238                     ;99c7:
  239  34:99C7  20 18 00          jsr $0018       ;invoke commandWindowHandler (x = handlerIndex = commandId)
  240                     ;$99fd
  241                     ;getCommandInput_next:
  242  34:99CA            .go_next_char:
  243  34:99CA  48                pha
  244  34:99CB  A5 52             lda <.iPlayer
  245  34:99CD  48                pha
  246  34:99CE  A5 53             lda <$53
  247  34:99D0  85 52             sta <.iPlayer
  248  34:99D2  A9 01             lda #1
  249  34:99D4  20 0E FA          jsr call_2e_9d53
  250  34:99D7  68                pla
  251  34:99D8  85 52             sta <.iPlayer
  252  34:99DA  68                pla
  253  34:99DB  F0 03             beq .redraw
  254  34:99DD  4C 6F 98                  jmp getPlayerCommandInput+3     ;986f
  255  34:99E0            .redraw:
  256  34:99E0  4C 6C 98          jmp getPlayerCommandInput       ;986c
  257  34:99E3            clearCursor0:
  258                             ;v0.6.2 fix
  259  34:99E3  A9 00             lda #0
  260  34:99E5  85 18             sta <$18
  261                             ;<--
  262  34:99E7  4C DF 8A          jmp clearSprites2x2             ;8adf
  263                     ;$9a16
  264                     ;=======================================================================================================
  265                     ;original addresses
  266                     ;commandWindow_nop      = $9a68
  267                     ;01
  268                     ;commandWindow_OnForward        = $a71c
  269                     ;commandWindow_OnBack   = $a750
  270                     ;commandWindow_OnFight  = $a843
  271                     ;commandWindow_OnGuard  = $a877
  272                     ;commandWindow_OnEscape = $a8ab
  273                     ;commandWindow_OnSneakAway      = $a8b5
  274                     ;commandWindow_OnJump   = $a9ab
  275                     ;09
  276                     ;commandWindow_OnA      ;hacked
  277                     ;commandWindow_OnGeomance       = $aa22
  278                     ;commandWindow_OnInspect                = $ab6e
  279                     ;commandWindow_OnDetect         = $ab07
  280                     ;commandWindow_OnSteal          = $ab9f
  281                     ;commandWindow_OnCharge         = $ac65
  282                     ;commandWindow_OnSing           = $acd0
  283                     ;commandWindow_OnIntimidate     = $ad0c
  284                     ;commandWindow_OnCheer          = $ad6b
  285                     ;13
  286                     ;commandWindow_OnItem   = $adaf ;14
  287                     ;commandWindow_OnMagic  = $b646 ;15
  288                     ;------------------------------------------------------------------------------------------------------
  289                     ;       .org $9a16
  290                             ALIGN_EVEN
       34:99EA                    .check_align_00047:
                0000              .if (.check_align_00047 & 1) != 0
                                  .endif
  291                     
  292  34:99EA            commandWindow_handlers:
  293  34:99EA  B3 A7             .dw     commandWindow_nop       ;$9a68
  294  34:99EC  B3 A7             .dw     commandWindow_nop       ;$9a68
  295  34:99EE  45 A7             .dw commandWindow_OnForward     ;$a71c
  296  34:99F0  57 A7             .dw commandWindow_OnBack        ;$a750
  297  34:99F2  C1 A7             .dw commandWindow_OnFight       ;$a843
  298  34:99F4  D7 A7             .dw commandWindow_OnGuard       ;$a877
  299  34:99F6  E2 A7             .dw commandWindow_OnEscape      ;$a8ab
  300  34:99F8  E2 A7             .dw commandWindow_OnSneakAway   ;$a8b5
  301  34:99FA  EA A7             .dw commandWindow_OnJump        ;$a9ab
  302  34:99FC  B3 A7             .dw commandWindow_nop   ;$9a68
  303  34:99FE  B3 A7             .dw commandWindow_nop   ;$9a68
  304  34:9A00  F9 A7             .dw commandWindow_OnGeomance    ;$aa22
  305  34:9A02  C1 A7             .dw commandWindow_OnInspect             ;$ab6e
  306  34:9A04  C1 A7             .dw commandWindow_OnDetect              ;$ab07
  307  34:9A06  C1 A7             .dw commandWindow_OnSteal               ;$ab9f
  308  34:9A08  D7 A7             .dw commandWindow_OnCharge              ;$ac65
  309  34:9A0A  C1 A7             .dw commandWindow_OnSing                ;$acd0
  310  34:9A0C  D7 A7             .dw commandWindow_OnIntimidate  ;$ad0c
  311  34:9A0E  D7 A7             .dw commandWindow_OnCheer               ;$ad6b
  312  34:9A10  B3 A7             .dw commandWindow_nop           ;$9a68
  313  34:9A12  D5 AB             .dw commandWindow_OnItem        ;$adaf
  314  34:9A14  C3 B2             .dw commandWindow_OnMagic       ;$b646
  315                             ;extra
  316                             ;容量以外に制限無し
  317  34:9A16  C1 A7             .dw commandWindow_OnProvoke     ;extra
  318  34:9A18  D7 A7             .dw commandWindow_OnDisorderedShot      ;extra
  319  34:9A1A  B6 A7             .dw commandWindow_OnAbyss       ;abyss
  320  34:9A1C  C1 A7             .dw commandWindow_OnRaid
  321                     ;$9a40
  322                     ;=======================================================================================================
  323  34:9A1E            getCommandInput_end:
  324           9A40      getCommandInput_free_end = $9a40
  325                     ;=======================================================================================================
  326                             INIT_PATCH $34,$9a69,$9ae7
                0034              .bank   $34
                9A69              .org    $9a69
       34:9A69                    .ds             (($9ae7) - ($9a69))
                9A69              .org    $9a69
  327  34:9A69            createCommandWindow:
  328                     ;[in]
  329           0006      .width = COMMAND_WINDOW_WIDTH   ;original:5
  330           0057      .pPlayerBaseParam = $57
  331           005F      .playerOffset = $5f
  332           78BA      .beginningMode = $78ba
  333           9B21      .jobCommandList = $9b21
  334                     ;[out]
  335           0038      .emptyCount = $38
  336           7400      .commandIdList = $7400
  337                     ;---------------------------------------------------
  338  34:9A69  A2 02             ldx #2
  339  34:9A6B  8E 04 74          stx .commandIdList+4
  340  34:9A6E  E8                inx
  341  34:9A6F  8E 05 74          stx .commandIdList+5
  342  34:9A72  A4 5F             ldy <.playerOffset
  343  34:9A74  B1 57             lda [.pPlayerBaseParam],y
  344  34:9A76  0A                asl a
  345  34:9A77  0A                asl a
  346  34:9A78  A8                tay
  347  34:9A79  A2 FC             ldx #$fc
  348  34:9A7B            .load_loop:
  349  34:9A7B  B9 21 9B                  lda .jobCommandList,y
  350  34:9A7E  9D 04 73                  sta .commandIdList - $fc,x
  351  34:9A81  C8                        iny
  352  34:9A82  E8                        inx
  353  34:9A83  D0 F6                     bne .load_loop
  354  34:9A85  20 54 97          jsr initTileArrayStorage
  355                     ;.counter = $2d
  356  34:9A88  86 38             stx <.emptyCount
  357                             ;stx <.counter
  358  34:9A8A  A9 FC             lda #$fc
  359  34:9A8C            .create_tiles:
  360  34:9A8C  48                        pha
  361  34:9A8D  A2 06                     ldx #.width
  362  34:9A8F  20 49 A5                  jsr initString
  363  34:9A92  68                        pla
  364  34:9A93  AA                        tax
  365  34:9A94  BD 04 73                  lda .commandIdList - $fc,x
  366  34:9A97  E8                        inx
  367                                     ;cmp #$ff
  368                                     ;bne .load_command_name
  369                                     ;       inc <.emptyCount
  370                                     ;       lda #0
  371  34:9A98                    .load_command_name:
  372                             
  373  34:9A98  A8                        tay
  374  34:9A99  8A                        txa
  375  34:9A9A  48                        pha
  376                                     INIT16 <$18,$8c40
       34:9A9B  A9 40             lda #LOW($8c40)
       34:9A9D  85 18             sta <$18
       34:9A9F  A9 8C             lda #HIGH($8c40)
       34:9AA1  85 19             sta <$18+1
  377  34:9AA3  98                        tya
  378           0001              .ifdef ENABLE_EXTRA_ABILITY
  379  34:9AA4  20 B0 9C                  jsr getExtraAbilityNameId
  380                             .endif
  381  34:9AA7  A2 01                     ldx #1
  382  34:9AA9  20 09 A6                  jsr loadString
  383  34:9AAC  A2 06                     ldx #.width
  384  34:9AAE  86 18                     stx <$18
  385  34:9AB0  20 6A 96                  jsr strToTileArray
  386  34:9AB3  A9 06                     lda #.width
  387  34:9AB5  20 58 A5                  jsr offsetTilePtr
  388                     
  389  34:9AB8  68                        pla     ;counter
  390  34:9AB9  D0 D1                     bne .create_tiles
  391  34:9ABB  A9 03             lda #($0a - (.width + 1))
  392  34:9ABD  85 18             sta <$18
  393  34:9ABF  A9 0A             lda #$0a
  394  34:9AC1  85 19             sta <$19
  395  34:9AC3  A9 03             lda #3
  396  34:9AC5  85 1A             sta <$1a
  397  34:9AC7  4C 38 8B          jmp draw8LineWindow
  398                     ;$9ae7:
  399                             .endif ;beta
  400                     ;------------------------------------------------------------------------------------------------------
  401                             ;FILEORG        $68b00
  402           8B00              .org    $8b00
  403  34:8B00            commandWindow_cursorPos:
  404           0020      .cursorX = ($50 - ($08 * COMMAND_WINDOW_WIDTH))
  405  34:8B00  A8 20                     .db     $a8, .cursorX
  406  34:8B02  B8 20                     .db     $b8, .cursorX
  407  34:8B04  C8 20                     .db     $c8, .cursorX
  408  34:8B06  D8 20                     .db     $d8, .cursorX
  409                             RESTORE_PC ff3_commandWindow_begin
                0000              .bank   BANK(ff3_commandWindow_begin)
                8000              .org    ff3_commandWindow_begin
#[3]   ff3_hack_master.asm
   43                     
#[4]   ff3_commands.asm
   44                                     .include "ff3_commands.asm"     ;saving a lot
    1                     ; ff3_commands.asm
    2                     ;
    3                     ; description:
    4                     ;       replaces command handlers
    5                     ;
    6                     ; version:
    7                     ;       0.08 (2006-11-12)
    8                     ;
    9                     ; note:
   10                     ;       'ff3_executeAction.asm' and 'ff3_command_window.asm' must be included before this file
   11                     ;======================================================================================================
   12  00:8000            ff3_commands_begin:
   13                     
   14                             INIT_PATCH $35,$a71c,$adaf
                0035              .bank   $35
                A71C              .org    $a71c
       35:A71C                    .ds             (($adaf) - ($a71c))
                A71C              .org    $a71c
   15                             ;INIT_PATCH $35,$a71c,$a7df
   16                             
   17                     DECLARE_COMMAND_VARS    .macro
   18                     .iPlayer = $52
   19                     .pBaseParam = $57
   20                     .pEquips = $59
   21                     .pBattleParam = $5b
   22                     .pTargetBase = $5d
   23                     .offset = $5f
   24                             .endm
   25                     
   26                     DECLARE_BATTLE_PTR      .macro
   27                     .pActor = $6e
   28                     .pTareget = $70
   29                             .endm
   30                     ;======================================================================================================
   31  35:A71C            selectSingleTargetAndSetYto2F:
   32                     ;out a : targetbit
   33                     ;out y : #2f
   34           00B3      .targetMode = $b3
   35           00B4      .selectedTarget = $b4
   36  35:A71C  A9 00             lda #0 ;single sel
   37  35:A71E  85 B3             sta <.targetMode
   38  35:A720  A9 10             lda #$10        ;select target
   39  35:A722  20 0E FA          jsr call_2e_9d53
   40  35:A725  20 94 9B          jsr setYtoOffset2F
   41  35:A728  A5 B4             lda <.selectedTarget
   42  35:A72A  60                rts
   43                     
   44  35:A72B            getPlayerLine:
   45           0059      .pEquips = $59
   46  35:A72B  A9 0F             lda #$0f
   47  35:A72D  20 88 9B          jsr setYtoOffsetOf
   48  35:A730  B1 59             lda [.pEquips],y
   49  35:A732  4A                lsr a
   50  35:A733  60                rts
   51                     
   52                     ;$35:a7cd initMoveArrowSprite
   53  35:A734            initMoveArrowSprite:
   54           0052      .iPlayer = $52
   55  35:A734  A9 00             lda #0
   56  35:A736  85 18             sta <$18
   57  35:A738  20 DF 8A          jsr clearSprites2x2     ;$8adf
   58  35:A73B  A9 5D             lda #$5d        ;arrow
   59  35:A73D  8D 21 02          sta $0221       ;sprite.tileIndex
   60  35:A740  A5 52             lda <.iPlayer
   61  35:A742  0A                asl a
   62  35:A743  0A                asl a
   63  35:A744  60                rts
   64                     ;------------------------------------------------------------------------------------------------------
   65                     ;ぜんしん(02)
   66                     ;$35:a71c commandWindow_OnForwardSelected
   67  35:A745            commandWindow_OnForward:
   68                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
   69  35:A745  20 2B A7          jsr getPlayerLine
   70  35:A748  90 66             bcc commandWindow_beepAndCancel
   71  35:A74A            .ok:
   72  35:A74A  20 34 A7          jsr initMoveArrowSprite
   73  35:A74D  AA                tax
   74                     
   75  35:A74E  A9 80             lda #$80 ;rightkey
   76  35:A750  48                pha ;sta $18
   77  35:A751  A0 43             ldy #$43 ;sta $0222
   78                     
   79  35:A753  A9 02             lda #$02
   80  35:A755  D0 12             bne commandWindow_setupMove
   81                     ;$a750:
   82                     
   83                     ;command 03
   84                     ;$35:a750 commandWindow_OnBack
   85  35:A757            commandWindow_OnBack:
   86                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
   87                     
   88  35:A757  20 2B A7          jsr getPlayerLine
   89  35:A75A  B0 54             bcs commandWindow_beepAndCancel
   90                     
   91  35:A75C  20 34 A7          jsr initMoveArrowSprite
   92  35:A75F  18                clc
   93  35:A760  69 02             adc #2
   94  35:A762  AA                tax
   95                     
   96  35:A763  A9 40             lda #$40 ;left
   97  35:A765  48                pha
   98  35:A766  A0 03             ldy #$03 ;sta $0222
   99  35:A768  98                tya
  100                     
  101                     ;fall through
  102  35:A769            commandWindow_setupMove:
  103  35:A769  85 19             sta <$19
  104                     
  105  35:A76B  BD 1D A8          lda commandWindow_arrowCoords,x
  106  35:A76E  8D 20 02          sta $0220       ;y
  107  35:A771  BD 1E A8          lda commandWindow_arrowCoords+1,x
  108  35:A774  8D 23 02          sta $0223       ;x
  109                     
  110                     ;$35:a784 showArrowAndDecideCommand
  111  35:A777            showArrowAndDecide:
  112                     ;[in] y : spriteFlag
  113                     ;[in] sp+0 : cancelKey
  114           78BA      .beginningFlag = $78ba
  115           0018      .cancelKey = $18
  116           0019      .commandId = $19
  117  35:A777  AD BA 78          lda .beginningFlag
  118  35:A77A  29 08             and #$08
  119  35:A77C  F0 0E             beq .normal
  120                     ;backattack!
  121  35:A77E  98                        tya
  122  35:A77F  49 40                     eor #$40
  123  35:A781  A8                        tay
  124  35:A782  BD 2E A8                  lda commandWindow_arrowCoords_backattack+1,x
  125  35:A785  8D 23 02                  sta $0223
  126                                     
  127  35:A788  68                        pla ;cancel key
  128  35:A789  49 C0                     eor #%11000000  ;$80 => 40 / 40 => 80
  129  35:A78B  48                        pha
  130  35:A78C            .normal:
  131  35:A78C  8C 22 02          sty $0222
  132  35:A78F  68                pla     ;cancel key
  133  35:A790  85 18             sta <.cancelKey
  134  35:A792            .get_input:     ;$a7a4:
  135  35:A792  20 85 81                  jsr presentCharacter
  136  35:A795  20 AA FB                  jsr getPad1Input
  137  35:A798  A5 12                     lda <inputBits
  138  35:A79A  F0 F6                     beq .get_input
  139                                     
  140  35:A79C  AA                        tax
  141  35:A79D  4A                        lsr a
  142  35:A79E  B0 09                     bcs .OnA
  143  35:A7A0  4A                        lsr a
  144  35:A7A1  B0 10                     bcs commandWindow_cancelReturn
  145  35:A7A3  E4 18                     cpx <.cancelKey
  146  35:A7A5  D0 EB                     bne .get_input
  147  35:A7A7  F0 0A                     beq commandWindow_cancelReturn
  148  35:A7A9            .OnA:
  149  35:A7A9  20 7D 9B          jsr requestSoundEffect05
  150  35:A7AC  A6 19             ldx <.commandId
  151  35:A7AE  D0 27             bne commandWindow_decideReturn
  152  35:A7B0            commandWindow_beepAndCancel:
  153  35:A7B0  20 81 9B          jsr requestSoundEffect06
  154  35:A7B3            commandWindow_nop:
  155  35:A7B3            commandWindow_cancelReturn:
  156  35:A7B3  A9 01             lda #1
  157  35:A7B5  60                rts
  158  35:A7B6            commandWindow_decideToTargetAll:
  159                     ;x = commandId
  160  35:A7B6  20 94 9B          jsr setYtoOffset2F
  161  35:A7B9  A9 C0             lda #$c0        ;target flag
  162  35:A7BB  85 B5             sta <$b5
  163  35:A7BD  A9 FF             lda #$ff        ;target bit
  164  35:A7BF  D0 0F             bne commandWindow_setTargetAndCommand
  165                     ;------------------------------------------------------------------------------------------------------
  166                     ;//04:たたかう
  167                     ;$35:a843 commandWindow_OnFight
  168                     ;       .org $a843
  169                     ;commandWindow_OnFight:
  170                     ;       lda #$04
  171                     ;       ;fall through
  172  35:A7C1            commandWindow_OnFight:
  173  35:A7C1            commandWindow_selectSingleTargetAndNext:
  174                     ;[in] u8 x : commandId
  175           00B4      .selectedTarget = $b4
  176  35:A7C1  8A                txa
  177  35:A7C2  48                pha
  178  35:A7C3  20 1C A7          jsr selectSingleTargetAndSetYto2F
  179  35:A7C6  D0 04             bne .ok
  180  35:A7C8  68                        pla
  181  35:A7C9  A9 01                     lda #1
  182  35:A7CB  60                        rts
  183  35:A7CC            .ok:
  184  35:A7CC  68                pla
  185  35:A7CD  AA                tax
  186  35:A7CE  A5 B4             lda <.selectedTarget
  187                             ;fall through
  188  35:A7D0            commandWindow_setTargetAndCommand:
  189                     ;[in] u8 a : targetBit
  190                     ;[in] u8 x : commandId
  191                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
  192           00B5      .targetFlag = $b5
  193  35:A7D0  91 5B             sta [.pBattleParam],y   ;2f
  194                                     
  195  35:A7D2  C8                iny
  196  35:A7D3  A5 B5             lda <.targetFlag
  197  35:A7D5  91 5B             sta [.pBattleParam],y   ;30
  198                             ;fall through
  199  35:A7D7            commandWindow_decideReturn:
  200                     ;[in] u8 X : commandId
  201                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
  202                     
  203                             ;pha    ;commandId
  204  35:A7D7  20 9B 9B          jsr setYtoOffset2E      ;9b9b
  205                             ;pla
  206  35:A7DA  8A                txa
  207  35:A7DB  91 5B             sta [.pBattleParam],y
  208  35:A7DD  E6 52             inc <.iPlayer
  209  35:A7DF  A9 01             lda #1
  210  35:A7E1  60                rts
  211                     ;------------------------------------------------------------------------------------------------------
  212                     ;//05:ぼうぎょ
  213                     ;$35:a877 commandWindow_OnGuard
  214                     ;commandWindow_OnGuard:
  215                     ;       lda #$05
  216                     ;       bne commandWindow_decideReturn
  217           A7D7      commandWindow_OnGuard = commandWindow_decideReturn
  218                     ;------------------------------------------------------------------------------------------------------
  219                     ;//06:にげる
  220                     ;$35:a8ab commandWindow_OnEscapeSelected
  221                     ;       .org $a8ab
  222                     ;commandWindow_OnEscape:
  223                     ;       lda #$06
  224                     ;       bne commandWindow_decideReturn
  225                     ;commandWindow_OnEscape = commandWindow_decideReturn
  226                     ;------------------------------------------------------------------------------------------------------
  227                     ;//07:とんずら
  228                     ;$35:a8b5 commandWindow_OnSneakAway
  229                     ;commandWindow_OnSneakAway:
  230                     ;       lda #$07
  231                     ;       bne commandWindow_decideReturn
  232                     ;commandWindow_OnSneakAway = commandWindow_decideReturn
  233  35:A7E2            commandWindow_OnEscape:
  234  35:A7E2            commandWindow_OnSneakAway:
  235  35:A7E2  AD D8 7E          lda battleMode
  236  35:A7E5  4A                lsr a   ;escape flag
  237  35:A7E6  90 EF             bcc commandWindow_decideReturn
  238  35:A7E8  B0 C6             bcs commandWindow_beepAndCancel
  239                     ;------------------------------------------------------------------------------------------------------
  240                     ;//08:ジャンプ
  241                     ;$35:a9ab commandWindow_OnJump
  242                     ;       .org $a9ab
  243  35:A7EA            commandWindow_OnJump:
  244           00B4      .selectedTarget = $b4
  245           00B5      .targetFlag = $b5
  246  35:A7EA  20 1C A7          jsr selectSingleTargetAndSetYto2F
  247  35:A7ED  F0 C4             beq commandWindow_cancelReturn
  248  35:A7EF  A5 B5             lda <.targetFlag
  249  35:A7F1  10 F7             bpl commandWindow_OnJump
  250                             
  251  35:A7F3  A2 08             ldx #$08
  252  35:A7F5  A5 B4             lda <.selectedTarget
  253  35:A7F7  D0 D7             bne commandWindow_setTargetAndCommand
  254                     ;------------------------------------------------------------------------------------------------------
  255                     ;//0d:みやぶる
  256                     ;$35:ab07 commandWindow_OnDetect
  257                     ;       .org $ab07
  258                     ;commandWindow_OnDetect:
  259                     ;       lda #$0d
  260                     ;       bne commandWindow_selectSingleTargetAndNext
  261           A7C1      commandWindow_OnDetect = commandWindow_selectSingleTargetAndNext
  262                     ;------------------------------------------------------------------------------------------------------
  263                     ;//0c:しらべる
  264                     ;$35:ab6e commandWindow_OnInspect
  265                     ;       .org $ab6e
  266                     ;commandWindow_OnInspect:
  267                     ;       lda #$0c
  268                     ;       bne commandWindow_selectSingleTargetAndNext
  269           A7C1      commandWindow_OnInspect = commandWindow_selectSingleTargetAndNext
  270                     ;------------------------------------------------------------------------------------------------------
  271                     ;//0E:ぬすむ
  272                     ;$35:ab9f commandWindow_OnSteal
  273                     ;       .org $ab9f
  274                     ;commandWindow_OnSteal:
  275                     ;       lda #$0e
  276                     ;       bne commandWindow_selectSingleTargetAndNext
  277           A7C1      commandWindow_OnSteal = commandWindow_selectSingleTargetAndNext
  278                     ;------------------------------------------------------------------------------------------------------
  279                     ;//0F:ためる
  280                     ;$35:ac65 commandWindow_OnChargeSelected
  281                     ;       .org $ac65
  282                     ;commandWindow_OnCharge:
  283                     ;       lda #$0f
  284                     ;       bne commandWindow_decideReturn
  285           A7D7      commandWindow_OnCharge = commandWindow_decideReturn
  286                     ;------------------------------------------------------------------------------------------------------
  287                     ;//10:うたう
  288                     ;$35:acd0 commandWindow_OnSing  
  289                     ;       .org $acd0
  290                     ;commandWindow_OnSing:
  291                     ;       lda #$10
  292                     ;       bne commandWindow_selectSingleTargetAndNext
  293           A7C1      commandWindow_OnSing = commandWindow_selectSingleTargetAndNext
  294                     ;------------------------------------------------------------------------------------------------------
  295                     ;//11:おどかす
  296                     ;$35:ad0c commandWindow_OnIntimidate    
  297                     ;       .org $ad0c
  298                     ;commandWindow_OnIntimidate:
  299                     ;       lda #$11
  300                     ;       bne commandWindow_decideReturn
  301           A7D7      commandWindow_OnIntimidate = commandWindow_decideReturn
  302                     ;------------------------------------------------------------------------------------------------------
  303                     ;//12:おうえん
  304                     ;$35:ad6b commandWindow_OnCheer
  305                     ;       .org $ad6b
  306                     ;commandWindow_OnCheer:
  307                     ;       lda #$12
  308                     ;       bne commandWindow_decideReturn
  309           A7D7      commandWindow_OnCheer = commandWindow_decideReturn
  310                     ;------------------------------------------------------------------------------------------------------
  311                     ;//0b:ちけい
  312                     ;$35:aa22 commandWindow_0b
  313                     ;       .org $aa22
  314           0000              .ifdef EXTEND_GEOMANCE
  316                             .else
  317  35:A7F9            commandWindow_OnGeomance:
  318           007A      .geomanceTargetFlag = $7a;$35:ab06 .db $7a      //???
  319  35:A7F9  20 E5 A9          jsr getCurrentTerrain
  320  35:A7FC  AA                tax
  321  35:A7FD  E8                inx
  322                     
  323  35:A7FE  A9 7A             lda #.geomanceTargetFlag
  324  35:A800            .shift_loop:
  325  35:A800  0A                        asl a
  326  35:A801  CA                        dex
  327  35:A802  D0 FC                     bne .shift_loop
  328  35:A804  90 0A             bcc .target_all
  329  35:A806  20 2A 80                  jsr dispatchBattleFunction_06   ;802a
  330  35:A809  AE 99 7E                  ldx $7e99
  331  35:A80C  A9 80                     lda #$80
  332  35:A80E  30 03                     bmi .store
  333  35:A810            .target_all:
  334  35:A810  CA                        dex
  335  35:A811  A9 C0                     lda #$c0
  336  35:A813            .store:
  337           00B5      .targetFlag = $b5
  338  35:A813  85 B5             sta <.targetFlag
  339  35:A815  20 94 9B          jsr setYtoOffset2F
  340  35:A818  8A                txa
  341  35:A819  A2 0B             ldx #$0b
  342  35:A81B  D0 B3             bne commandWindow_setTargetAndCommand
  343                             .endif  ;EXTEND_GEOMANCE
  344                     ;======================================================================================================
  345                     ;a823
  346  35:A81D            commandWindow_arrowCoords:
  347  35:A81D  34 B4 34          .db $34,$B4,$34,$D4, $50,$B4,$50,$D4, $6C,$B4,$6C,$D4, $88,$B4,$88,$D4
       35:A820  D4 50 B4  
       35:A823  50 D4 6C  
       35:A826  B4 6C D4  
       35:A829  88 B4 88  
       35:A82C  D4        
  348                     ;a833
  349  35:A82D            commandWindow_arrowCoords_backattack:
  350  35:A82D  34 44 34          .db $34,$44,$34,$24, $50,$44,$50,$24, $6C,$44,$6C,$24, $88,$44,$88,$24
       35:A830  24 50 44  
       35:A833  50 24 6C  
       35:A836  44 6C 24  
       35:A839  88 44 88  
       35:A83C  24        
  351                     ;$a7df:
  352                     ;======================================================================================================
  353                     ;//02:ぜんしん
  354                     ;$35:a7df command_forward
  355                     ;       .org $a7df
  356  35:A83D            command_forward:
  357                     ;       ldx #$39+$02
  358                     ;       bne command_move
  359  35:A83D            command_back:
  360                     ;       ldx #$39+$03
  361  35:A83D            command_move:
  362                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
  363           006E      .pActor = $6e
  364                     
  365  35:A83D  A0 33             ldy #$33
  366  35:A83F  B1 6E             lda [.pActor],y
  367  35:A841  49 01             eor #$01        ;invert line flag
  368  35:A843  91 6E             sta [.pActor],y
  369  35:A845  20 65 A8          jsr getPlayerOffsetFromActor
  370  35:A848  18                clc
  371  35:A849  69 0F             adc #$0f
  372  35:A84B  A8                tay
  373  35:A84C  B1 59             lda [.pEquips],y
  374  35:A84E  49 01             eor #$01
  375  35:A850  91 59             sta [.pEquips],y
  376                             ;fall through
  377  35:A852            setupNullTargetActionType01:
  378                     ;[in] x : actionId * 2
  379  35:A852  A9 FF             lda #$ff
  380  35:A854  8D D8 78          sta targetName  ;78d8
  381                             ;fall through
  382  35:A857            setupActionType01:
  383                     ;[in] x : actionId * 2
  384  35:A857  A9 01             lda #1
  385  35:A859  8D D5 78          sta battleProcessType
  386  35:A85C            setupActionName:
  387                     ;[in] x : actionId * 2
  388  35:A85C  8A                txa
  389  35:A85D  4A                lsr a
  390  35:A85E  18                clc
  391  35:A85F  69 39             adc #$39        ;convert actionid to actionNameId
  392  35:A861  8D D7 78          sta actionName  ;78d7
  393  35:A864  60                rts
  394                     ;$a816:
  395  35:A865            getPlayerOffsetFromActor:
  396                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
  397  35:A865  20 2E A4          jsr getActor2C
  398  35:A868  29 07             and #7
  399  35:A86A  85 52             sta <.iPlayer
  400  35:A86C  4C 41 A5          jmp getPlayerOffset
  401                     
  402                     ;$a881
  403                     ;$35:a881 command_guard
  404  35:A86F            command_guard:
  405                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
  406           006E      .pActor = $6e
  407  35:A86F  20 52 A8          jsr setupNullTargetActionType01
  408                     
  409  35:A872  20 AD 9F          jsr setXtoActorIndex
  410  35:A875  A0 23             ldy #$23
  411  35:A877  B1 6E             lda [.pActor],y
  412  35:A879  9D E4 7C          sta $7ce4,x
  413  35:A87C  10 04             bpl .def_under_80
  414  35:A87E  A9 FF                     lda #$ff
  415  35:A880  D0 01                     bne .store
  416  35:A882            .def_under_80:
  417  35:A882  0A                        asl a
  418  35:A883            .store:
  419  35:A883  91 6E             sta [.pActor],y
  420  35:A885  60                rts
  421                     ;======================================================================================================
  422                     ;$35:a8bf command_escape //06
  423  35:A886            command_escape:
  424                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
  425           006E      .pActor = $6e
  426           0024      .rate = $24
  427                             ;ldx #$39+$06
  428  35:A886  20 52 A8          jsr setupNullTargetActionType01
  429                             
  430  35:A889  A9 64             lda #100
  431  35:A88B  20 64 A5          jsr getSys1Random
  432  35:A88E  48                pha     ;rand
  433                             
  434  35:A88F  20 2E A4          jsr getActor2C
  435  35:A892  30 5B             bmi command_escape_enemy
  436  35:A894            .actor_is_player:
  437           0024      .pEnemy = $24
  438  35:A894  A2 00             ldx #0
  439  35:A896  8A                txa
  440  35:A897  A8                tay
  441  35:A898  86 18             stx <$18
  442  35:A89A  86 19             stx <$19
  443  35:A89C  86 1A             stx <$1a
  444  35:A89E  86 1B             stx <$1b
  445                             INIT16 <.pEnemy,$7835
       35:A8A0  A9 35             lda #LOW($7835)
       35:A8A2  85 24             sta <.pEnemy
       35:A8A4  A9 78             lda #HIGH($7835)
       35:A8A6  85 25             sta <.pEnemy+1
  446  35:A8A8  A2 07             ldx #7
  447  35:A8AA            .sum_enemy_lv:
  448  35:A8AA  BD A7 7D                  lda $7da7,x     ;group
  449  35:A8AD  30 0F                     bmi .next
  450  35:A8AF  18                                clc
  451  35:A8B0  B1 24                             lda [.pEnemy],y
  452  35:A8B2  65 18                             adc <$18
  453  35:A8B4  85 18                             sta <$18
  454  35:A8B6  A9 00                             lda #0
  455  35:A8B8  65 19                             adc <$19
  456  35:A8BA  85 19                             sta <$19
  457  35:A8BC  E6 1A                             inc <$1a
  458  35:A8BE                    .next:
  459                                     ;SUB16 <.pEnemy,$0040
  460                                     SUB16by8 <.pEnemy,#$40
       35:A8BE  A5 24             lda <.pEnemy
       35:A8C0  38                sec
       35:A8C1  E9 40             sbc #$40
       35:A8C3  85 24             sta <.pEnemy
       35:A8C5  B0 02             bcs .sub16by8_00061
       35:A8C7  C6 25                     dec <.pEnemy+1
       35:A8C9                    .sub16by8_00061:
  461  35:A8C9  CA                        dex
  462  35:A8CA  10 DE                     bpl .sum_enemy_lv
  463                     
  464  35:A8CC  20 92 FC          jsr div_16
  465  35:A8CF  A0 2A             ldy #$2a
  466  35:A8D1  B1 6E             lda [.pActor],y
  467  35:A8D3  18                clc
  468  35:A8D4  69 19             adc #25
  469  35:A8D6  38                sec
  470  35:A8D7  E5 1C             sbc <$1c        ;average lv of enemies
  471  35:A8D9  B0 02             bcs .rate_plus
  472  35:A8DB  A9 00                     lda #0
  473  35:A8DD            .rate_plus:
  474           78BA      .beginningMode = $78ba
  475  35:A8DD  85 24             sta <.rate
  476  35:A8DF  68                pla     ;rand
  477  35:A8E0  C5 24             cmp <.rate
  478  35:A8E2  90 2F             bcc command_escape_possible
  479  35:A8E4  AD BA 78          lda .beginningMode
  480  35:A8E7  4A                lsr a   ;party surprise attack
  481  35:A8E8  B0 29             bcs command_escape_possible
  482                     ;.fail:
  483  35:A8EA            command_escape_fail:
  484  35:A8EA  A9 1F             lda #$1f        ;"にげられない！"
  485                             ;sta battleMessages
  486                             ;rts
  487  35:A8EC  4C BF 9F          jmp addBattleMessage
  488                     
  489                     ;enemy:
  490                     ;a978
  491  35:A8EF            command_escape_enemy:
  492           006E      .pActor = $6e
  493  35:A8EF  68                pla     ;rand
  494  35:A8F0  A0 22             ldy #$22
  495  35:A8F2  D1 6E             cmp [.pActor],y
  496  35:A8F4  B0 F4             bcs command_escape_fail
  497                     
  498  35:A8F6  A9 1E             lda #$1e
  499  35:A8F8  8D DA 78          sta battleMessages
  500  35:A8FB  20 AD 9F          jsr setXtoActorIndex
  501  35:A8FE  A9 00             lda #0
  502  35:A900  20 20 FD          jsr flagTargetBit
  503  35:A903  48                pha ;sta $78d4
  504  35:A904  8A                txa
  505  35:A905  0A                asl a
  506  35:A906  AA                tax
  507  35:A907  B5 F0             lda <$f0,x
  508  35:A909  09 80             ora #$80
  509  35:A90B  95 F0             sta <$f0,x
  510                             ;rts
  511  35:A90D  68                pla
  512  35:A90E  D0 23             bne command_escape_succeeded
  513                     ;//07
  514                     ;$35:a93b command_sneakAway     //[sneak away]
  515  35:A910            command_sneakAway:
  516                             ;ldx #$39+$07
  517  35:A910  20 52 A8          jsr setupNullTargetActionType01
  518  35:A913            command_escape_possible:
  519                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
  520                     
  521  35:A913  AD D8 7E          lda battleMode  ;7ed8
  522  35:A916  4A                lsr a   ;escape forbidden flag
  523  35:A917  B0 D1             bcs command_escape_fail
  524                     
  525  35:A919  A2 03             ldx #3
  526  35:A91B            .check_confused_member:
  527  35:A91B  86 52                     stx <.iPlayer
  528  35:A91D  20 41 A5                  jsr getPlayerOffset
  529  35:A920  A8                        tay
  530  35:A921  C8                        iny
  531  35:A922  C8                        iny
  532  35:A923  B1 5B                     lda [.pBattleParam],y
  533  35:A925  29 20                     and #$20
  534  35:A927  D0 C1                     bne command_escape_fail
  535  35:A929  CA                        dex
  536  35:A92A  10 EF                     bpl .check_confused_member
  537                     ;ok
  538  35:A92C  A9 02             lda #2
  539  35:A92E  8D D3 78          sta $78d3
  540  35:A931  A9 F0             lda #$f0
  541  35:A933            command_escape_succeeded:
  542  35:A933  8D D4 78          sta $78d4
  543  35:A936  A9 1E             lda #$1e        ;"にげだした････"
  544  35:A938  4C BF 9F          jmp addBattleMessage
  545                             ;sta battleMessages
  546                             ;rts
  547                     ;======================================================================================================
  548                     ;$a9d8
  549                     ;$35:a9d8 command_jump
  550  35:A93B            command_jump:
  551                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
  552           006E      .pActor = $6e
  553                             ;ldx #$39+$08
  554  35:A93B  20 57 A8          jsr setupActionType01
  555                     
  556  35:A93E  A0 01             ldy #$01
  557  35:A940  B1 6E             lda [.pActor],y
  558  35:A942  29 28             and #$28
  559  35:A944  F0 08             beq .ok
  560                     ;fail
  561  35:A946  A9 18                     lda #$18
  562  35:A948  8D C2 7E                  sta effectHandlerIndex
  563  35:A94B  4C 4C AA                  jmp command_setNoEffectAndReturn
  564  35:A94E            .ok:
  565                     ;$a9f6:
  566  35:A94E  20 B4 9F          jsr setXtoActorIndex16
  567  35:A951  E8                inx
  568  35:A952  B5 F0             lda <$f0,x
  569  35:A954  09 01             ora #$01
  570  35:A956  95 F0             sta <$f0,x
  571  35:A958  C8                iny
  572  35:A959  C8                iny
  573  35:A95A  A9 09             lda #$09
  574  35:A95C  91 6E             sta [.pActor],y ;2e
  575  35:A95E  60                rts
  576                     ;
  577                     ;$35:aa11 command_09 //landing
  578  35:A95F            command_land:
  579           006E      .pActor = $6e
  580  35:A95F  A0 02             ldy #2
  581  35:A961  B1 6E             lda [.pActor],y
  582  35:A963  29 FE             and #$fe
  583  35:A965  91 6E             sta [.pActor],y
  584  35:A967  A0 27             ldy #$27
  585  35:A969  A9 18             lda #CHARGE_COUNT_JUMP
  586  35:A96B  91 6E             sta [.pActor],y
  587  35:A96D  4C 1E 80          jmp dispatchBattleFunction_03   ;801e
  588                     ;$aa22:
  589                     ;======================================================================================================
  590                     
  591                     ;$aa5d:
  592                     ;$35:aa5d command_0b
  593                     
  594                     
  595           0000              .ifdef EXTEND_GEOMANCE
  683                             .else ;EXTEND_GEOMANCE
  684                     
  685  35:A970            command_geomance:
  686                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
  687           006E      .pActor = $6e
  688  35:A970  20 2E A4          jsr getActor2C
  689  35:A973  09 10             ora #$10
  690  35:A975  91 6E             sta [.pActor],y
  691  35:A977  20 E5 A9          jsr getCurrentTerrain   ;aac3
  692  35:A97A  18                clc
  693  35:A97B  69 50             adc #$50
  694                     
  695                             .endif ;EXTEND_GEOMANCE
  696                     
  697  35:A97D  A0 2E             ldy #$2e
  698  35:A97F  91 6E             sta [.pActor],y
  699  35:A981  85 1A             sta <$1a
  700           0001              .ifdef BOOST_GEOMANCER
  701  35:A983  A0 00                     ldy #$0
  702  35:A985  B1 6E                     lda [.pActor],y
  703  35:A987  48                        pha
  704  35:A988  A0 0F                     ldy #$0f
  705  35:A98A  18                        clc
  706  35:A98B  71 6E                     adc [.pActor],y
  707  35:A98D  A0 00                     ldy #0
  708  35:A98F  91 6E                     sta [.pActor],y
  709  35:A991  20 67 A3                  jsr command_magic
  710  35:A994  68                        pla
  711  35:A995  A0 00                     ldy #$0
  712  35:A997  91 6E                     sta [.pActor],y
  713                             .else
  715                             .endif  ;BOOST_GEOMANCER
  716  35:A999  E6 CC             inc <$cc
  717  35:A99B  A9 14             lda #$14
  718  35:A99D  8D C2 7E          sta effectHandlerIndex
  719                             
  720  35:A9A0  AD 9B 7E          lda play_effectTargetBits       ;7e9b
  721  35:A9A3  D0 3F             bne command_doReturn
  722                     ;failed. nature bites player
  723  35:A9A5  A9 03             lda #3
  724  35:A9A7  85 54             sta <$54
  725                     ;$aac3:
  726  35:A9A9            damageActorByQuoterHalf:
  727                     ;[out] x : cacheIndex
  728           0018      .maxhp = $18
  729           006E      .pActor = $6e
  730           00F0      .actorStatusCache = $f0
  731  35:A9A9  20 B4 9F          jsr setXtoActorIndex16
  732                     
  733  35:A9AC  A0 05             ldy #5
  734  35:A9AE  B1 6E             lda [.pActor],y
  735  35:A9B0  9D 5F 7E          sta $7e5f,x
  736  35:A9B3  C8                iny
  737  35:A9B4  B1 6E             lda [.pActor],y
  738  35:A9B6  4A                lsr a
  739  35:A9B7  7E 5F 7E          ror $7e5f,x
  740  35:A9BA  4A                lsr a
  741  35:A9BB  9D 60 7E          sta $7e60,x
  742  35:A9BE  7E 5F 7E          ror $7e5f,x
  743                     
  744  35:A9C1  A0 03             ldy #3
  745  35:A9C3  38                sec
  746  35:A9C4  B1 6E             lda [.pActor],y
  747  35:A9C6  FD 5F 7E          sbc $7e5f,x
  748  35:A9C9  91 6E             sta [.pActor],y
  749  35:A9CB  C8                iny
  750  35:A9CC  B1 6E             lda [.pActor],y
  751  35:A9CE  FD 60 7E          sbc $7e60,x
  752  35:A9D1  91 6E             sta [.pActor],y
  753  35:A9D3  88                dey
  754  35:A9D4  11 6E             ora [.pActor],y
  755                             ;a9d4
  756  35:A9D6  F0 02             beq .result_dead
  757  35:A9D8  B0 0A             bcs .finish
  758  35:A9DA            .result_dead:
  759  35:A9DA  A9 80                     lda #$80
  760  35:A9DC  95 F0                     sta <.actorStatusCache,x
  761  35:A9DE  0A                        asl a
  762  35:A9DF  91 6E                     sta [.pActor],y
  763  35:A9E1  C8                        iny
  764  35:A9E2  91 6E                     sta [.pActor],y
  765  35:A9E4            .finish:
  766  35:A9E4            command_doReturn:
  767  35:A9E4  60                rts
  768                     ;$35:aac3 getCurrentTerrain
  769  35:A9E5            getCurrentTerrain:
  770  35:A9E5  AD E3 7C          lda $7ce3
  771  35:A9E8  C9 08             cmp #$08
  772  35:A9EA  90 2E             bcc .finish
  773  35:A9EC  A2 05                     ldx #$05
  774  35:A9EE  C9 12                     cmp #$12
  775  35:A9F0  F0 25                     beq .use_low
  776                                     ;bne .load_param
  777                                     ;       ;lda #$55
  778                                     ;       lda #$05
  779                                     ;       rts
  780  35:A9F2                    .load_param:
  781  35:A9F2  18                        clc
  782  35:A9F3  AD C8 74                  lda $74c8       ;field $48
  783  35:A9F6  69 4E                     adc #$4e
  784  35:A9F8  85 46                     sta <$46
  785  35:A9FA  A9 00                     lda #0
  786  35:A9FC  69 A2                     adc #$a2
  787  35:A9FE  85 47                     sta <$47
  788                                     
  789  35:AA00  A9 1A                     lda #$1a        
  790  35:AA02  85 4A                     sta <$4a        ;current bank
  791  35:AA04  A9 01                     lda #1
  792  35:AA06  85 4B                     sta <$4b        ;size
  793  35:AA08  A9 00                     lda #0          ;src bank
  794  35:AA0A  20 DC FD                  jsr copyTo7400
  795                     
  796  35:AA0D  AE 00 74                  ldx $7400
  797  35:AA10  AD D8 7E                  lda battleMode  ;$7ed8
  798  35:AA13  29 08                     and #8
  799                     
  800  35:AA15  D0 04                     bne .use_high
  801  35:AA17                    .use_low:
  802  35:AA17  8A                                txa
  803  35:AA18  29 0F                             and #$0f
  804  35:AA1A                    .finish:
  805  35:AA1A  60                                rts
  806  35:AA1B                    .use_high:
  807  35:AA1B  8A                        txa
  808  35:AA1C  4C 45 FD                  jmp $fd45       ;a>>4
  809                     ;$35:ab06 .db $7a       //???
  810                     ;======================================================================================================
  811                     ;setEffectHandlerTo18 = $ab66
  812                     ;$35:ab0c command_detect
  813  35:AA1F            command_detect:
  814           0070      .pTarget = $70
  815                             ;ldx #$39+$0d
  816  35:AA1F  20 6D AA          jsr setupNoMotionType01
  817                     
  818  35:AA22  A0 01             ldy #1
  819  35:AA24  B1 70             lda [.pTarget],y
  820  35:AA26  30 24             bmi command_setNoEffectAndReturn
  821  35:AA28            .ok:
  822                     ;$ab27:
  823           0018      .count = $18
  824  35:AA28  A0 12             ldy #$12
  825  35:AA2A  B1 70             lda [.pTarget],y
  826                     
  827  35:AA2C  A0 00             ldy #0
  828                             ;ldx battleMessageCount
  829  35:AA2E  84 18             sty <.count
  830  35:AA30            .queue_weak_points:
  831  35:AA30  0A                        asl a
  832  35:AA31  90 0A                     bcc .next
  833  35:AA33  E6 18                             inc <.count
  834  35:AA35  48                                pha
  835                                             ;pha
  836                                             ;tya
  837                                             ;;clc (always set)
  838                                             ;adc #$47
  839                                             ;sta battleMessages,x
  840                                             ;pla
  841                                             ;inx
  842                                             ;stx battleMessageCount
  843  35:AA36  98                                tya
  844                                             ;carry always be set
  845  35:AA37  69 47                             adc #$47
  846  35:AA39  20 BF 9F                          jsr addBattleMessage
  847  35:AA3C  68                                pla
  848  35:AA3D                    .next:
  849  35:AA3D  C8                        iny
  850  35:AA3E  C0 07                     cpy #7
  851  35:AA40  D0 EE                     bne .queue_weak_points
  852  35:AA42  A5 18             lda <.count
  853  35:AA44  D0 05             bne .finish
  854  35:AA46  A9 43                     lda #$43
  855  35:AA48  20 BF 9F                  jsr addBattleMessage
  856                                     ;sta battleMessages,x
  857  35:AA4B            .finish:
  858  35:AA4B  60                rts
  859                     
  860  35:AA4C            command_setNoEffectAndReturn:
  861                             ;ldx #$3b
  862                             ;stx battleMessages
  863                             ;rts
  864  35:AA4C  A9 3B             lda #$3b
  865  35:AA4E  4C BF 9F          jmp addBattleMessage
  866                     ;======================================================================================================
  867                     ;$35:ab73 command_inspect
  868  35:AA51            command_inspect:
  869           0070      .pTarget = $70
  870                             ;jsr setEffectHandlerTo18
  871  35:AA51  A0 06             ldy #6
  872  35:AA53  A2 03             ldx #3
  873  35:AA55            .copy_hp:
  874  35:AA55  B1 70                     lda [.pTarget],y
  875  35:AA57  9D E4 78                  sta $78e4,x
  876  35:AA5A  88                        dey
  877  35:AA5B  CA                        dex
  878  35:AA5C  10 F7                     bpl .copy_hp
  879                             
  880  35:AA5E  A0 01             ldy #1
  881  35:AA60  A2 3F             ldx #$3f
  882  35:AA62  B1 70             lda [.pTarget],y
  883  35:AA64  10 02             bpl .ok
  884  35:AA66  A2 3B                     ldx #$3b
  885  35:AA68            .ok:
  886  35:AA68  8E DA 78          stx battleMessages
  887  35:AA6B  A2 18             ldx #$0c*2
  888                             ;fall through
  889  35:AA6D            setupNoMotionType01:
  890                     ;[in] x : actionId * 2 (initial value on handler entry)
  891  35:AA6D  20 57 A8          jsr setupActionType01
  892  35:AA70            setEffectHandlerTo18    ;18=do nothing
  893  35:AA70  A9 18             lda #$18
  894  35:AA72  8D C2 7E          sta effectHandlerIndex
  895  35:AA75  E6 CC             inc <$cc
  896  35:AA77  60                rts
  897                     ;======================================================================================================
  898                     ;$35:aba4 command_steal
  899  35:AA78            command_steal:
  900           006E      .pActor = $6e
  901           0070      .pTarget = $70
  902                             ;ldx #$39+$0E
  903  35:AA78  20 6D AA          jsr setupNoMotionType01
  904                     
  905  35:AA7B  A0 2C             ldy #$2c
  906  35:AA7D  B1 70             lda [.pTarget],y
  907  35:AA7F  30 05             bmi .target_is_enemy
  908  35:AA81            .fail:
  909  35:AA81  A9 35                     lda #$35 ;"ぬすみそこなった"
  910  35:AA83  4C BF 9F                  jmp addBattleMessage
  911                                     ;sta battleMessages
  912                                     ;rts
  913  35:AA86            .target_is_enemy:
  914  35:AA86  A0 01             ldy #1
  915  35:AA88  B1 70             lda [.pTarget],y
  916  35:AA8A  29 E8             and #$e8
  917  35:AA8C  D0 F3             bne .fail
  918                     
  919           0024      .rate = $24
  920  35:AA8E  18                clc
  921  35:AA8F  88                dey
  922  35:AA90  B1 6E             lda [.pActor],y
  923  35:AA92  A0 0F             ldy #$0f
  924  35:AA94  71 6E             adc [.pActor],y
  925  35:AA96  85 24             sta <.rate
  926  35:AA98  A9 FF             lda #$ff
  927  35:AA9A  20 64 A5          jsr getSys1Random
  928  35:AA9D  C5 24             cmp <.rate
  929  35:AA9F  B0 E0             bcs .fail
  930                     
  931           0018      .dropTableIndex = $18
  932  35:AAA1  A0 36             ldy #$36
  933  35:AAA3  B1 70             lda [.pTarget],y
  934  35:AAA5  29 1F             and #$1f
  935  35:AAA7  85 18             sta <.dropTableIndex
  936                             ;
  937  35:AAA9  A9 08             lda #$08
  938  35:AAAB  85 1A             sta <$1a
  939                             INIT16 <$20,$9b80
       35:AAAD  A9 80             lda #LOW($9b80)
       35:AAAF  85 20             sta <$20
       35:AAB1  A9 9B             lda #HIGH($9b80)
       35:AAB3  85 21             sta <$20+1
  940  35:AAB5  A9 08             lda #$08
  941  35:AAB7  A2 00             ldx #$00
  942  35:AAB9  A0 1A             ldy #$1a
  943  35:AABB  20 A6 FD          jsr loadTo7400Ex
  944           7400      .dropList = $7400
  945  35:AABE  A9 FF             lda #$ff
  946  35:AAC0  20 64 A5          jsr getSys1Random
  947  35:AAC3  A2 03             ldx #3
  948  35:AAC5            .get_index:
  949  35:AAC5  DD 07 AB                  cmp .bounds,x
  950  35:AAC8  B0 03                     bcs .found_index
  951  35:AACA  CA                        dex
  952  35:AACB  10 F8                     bpl .get_index
  953  35:AACD            .found_index:
  954  35:AACD  BD 00 74          lda .dropList,x
  955  35:AAD0  A8                tay
  956  35:AAD1  F0 AE             beq .fail
  957                     
  958  35:AAD3  20 FA AA          jsr .findItem
  959  35:AAD6  30 07             bmi .put_drop
  960  35:AAD8  A9 00             lda #0
  961  35:AADA  20 FA AA          jsr .findItem
  962  35:AADD  10 A2             bpl .fail
  963  35:AADF            .put_drop:
  964  35:AADF  FE 01 60          inc backpackItems-$c0+1,x
  965  35:AAE2  BD 01 60          lda backpackItems-$c0+1,x
  966  35:AAE5  C9 64             cmp #100
  967  35:AAE7  90 05             bcc .store_id
  968  35:AAE9  A9 63                     lda #99
  969  35:AAEB  9D 01 60                  sta backpackItems-$c0+1,x
  970  35:AAEE            .store_id:
  971  35:AAEE  98                tya     ;itemid
  972  35:AAEF  9D 00 60          sta backpackItems-$c0,x
  973  35:AAF2            .finish:
  974  35:AAF2  8D E4 78          sta $78e4
  975  35:AAF5  A9 29             lda #$29
  976  35:AAF7  4C BF 9F          jmp addBattleMessage
  977                             ;sta battleMessages
  978                             ;rts
  979  35:AAFA            .findItem:
  980                     ;[in] a : itemid to find
  981  35:AAFA  A2 C0             ldx #$c0
  982  35:AAFC            .find_loop:
  983  35:AAFC  DD 00 60                  cmp backpackItems-$c0,x
  984  35:AAFF  F0 04                     beq .found
  985  35:AB01  E8                        inx
  986  35:AB02  E8                        inx
  987  35:AB03  D0 F7                     bne .find_loop
  988  35:AB05            .found:
  989  35:AB05  8A                txa
  990  35:AB06  60                rts
  991  35:AB07            .bounds:
  992  35:AB07  00 30 60          .db $00,$30,$60,$90
       35:AB0A  90        
  993                     ;$ac65
  994                     ;======================================================================================================
  995                     ;$35:ac6f command_charge //0F
  996  35:AB0B            command_charge:
  997           006E      .pActor = $6e
  998                             ;ldx #$39+$0f
  999  35:AB0B  20 57 A8          jsr setupActionType01
 1000                     
 1001  35:AB0E  A2 3B             ldx #$3b ;"こうかがなかった"
 1002  35:AB10  A0 01             ldy #1
 1003  35:AB12  B1 6E             lda [.pActor],y
 1004  35:AB14  29 28             and #$28
 1005  35:AB16  D0 39             bne .fail
 1006  35:AB18  A0 27                     ldy #$27
 1007  35:AB1A  B1 6E                     lda [.pActor],y
 1008  35:AB1C  18                        clc
 1009  35:AB1D  69 14                     adc #CHARGE_INCREMENT
 1010  35:AB1F  C9 29                     cmp #CHARGE_MAX
 1011  35:AB21  B0 08                     bcs .bomb
 1012                                     ;ok
 1013  35:AB23  91 6E                             sta [.pActor],y
 1014  35:AB25  A9 00                             lda #0
 1015  35:AB27  8D 93 7E                          sta $7e93
 1016  35:AB2A  60                                rts
 1017  35:AB2B            .bomb:
 1018                                     ;bomb
 1019  35:AB2B  A9 00                     lda #0
 1020  35:AB2D  91 6E                     sta [.pActor],y
 1021  35:AB2F  A0 04                     ldy #4
 1022  35:AB31  B1 6E                     lda [.pActor],y
 1023  35:AB33  4A                        lsr a
 1024  35:AB34  91 6E                     sta [.pActor],y
 1025  35:AB36  88                        dey
 1026  35:AB37  B1 6E                     lda [.pActor],y
 1027  35:AB39  6A                        ror a
 1028  35:AB3A  91 6E                     sta [.pActor],y
 1029  35:AB3C  C8                        iny
 1030  35:AB3D  11 6E                     ora [.pActor],y
 1031  35:AB3F  D0 09                     bne .bomb_alive
 1032                                             ;jsr setXtoActorIndex
 1033                                             ;asl a
 1034                                             ;tax
 1035  35:AB41  20 B4 9F                          jsr setXtoActorIndex16
 1036  35:AB44  B5 F0                             lda <$f0,x
 1037  35:AB46  09 80                             ora #$80
 1038  35:AB48  95 F0                             sta <$f0,x
 1039  35:AB4A                    .bomb_alive:
 1040  35:AB4A  A9 01                     lda #1
 1041  35:AB4C  8D 93 7E                  sta $7e93
 1042  35:AB4F  A2 2F                     ldx #$2f        ;"ためすぎてじばくした!"
 1043  35:AB51            .fail:
 1044  35:AB51  8E DA 78          stx battleMessages
 1045  35:AB54  60                rts
 1046                     ;======================================================================================================
 1047                     ;$35:acd5 command_sing
 1048  35:AB55            command_sing:
 1049           006E      .pActor = $6e
 1050                     ;竪琴チェック オリジナルは装備欄のIDによる
 1051  35:AB55  A0 31             ldy #$31
 1052  35:AB57  B1 6E             lda [.pActor],y
 1053  35:AB59  C8                iny
 1054  35:AB5A  11 6E             ora [.pActor],y
 1055  35:AB5C  29 08             and #$08        ;harp
 1056  35:AB5E  F0 03             beq .fail
 1057  35:AB60  4C 04 A1                  jmp command_fight
 1058  35:AB63            .fail:
 1059  35:AB63  A9 01             lda #1
 1060  35:AB65  8D D5 78          sta battleProcessType
 1061  35:AB68  A9 42             lda #$42        ;"たてごとがないのでうたえない"
 1062  35:AB6A  8D DA 78          sta battleMessages
 1063  35:AB6D  A9 18             lda #$18
 1064  35:AB6F  8D C2 7E          sta effectHandlerIndex
 1065  35:AB72  60                rts
 1066                     ;======================================================================================================
 1067                     ;$35:ad16 command_intimidate
 1068  35:AB73            command_intimidate:
 1069                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
 1070                     
 1071  35:AB73  AD D8 7E          lda battleMode
 1072  35:AB76  4A                lsr a   ;escape forbidden
 1073  35:AB77  90 03             bcc .ok
 1074  35:AB79  4C 4C AA                  jmp command_setNoEffectAndReturn
 1075  35:AB7C            .ok:
 1076  35:AB7C  A0 00             ldy #0
 1077                             
 1078           0001              .ifdef BOOST_INTIMIDATE
 1079  35:AB7E  A2 07                     ldx #7
 1080  35:AB80                    .set_lv:
 1081  35:AB80  B1 5D                             lda [.pTargetBase],y
 1082  35:AB82  4A                                lsr a
 1083  35:AB83  91 5D                             sta [.pTargetBase],y
 1084  35:AB85  4A                                lsr a
 1085  35:AB86  18                                clc
 1086  35:AB87  71 5D                             adc [.pTargetBase],y
 1087  35:AB89  91 5D                             sta [.pTargetBase],y
 1088                                             ;ADD16 <.pTargetBase,$0040
 1089                                             ADD16by8 <.pTargetBase,#$40
       35:AB8B  A5 5D             lda <.pTargetBase
       35:AB8D  18                clc
       35:AB8E  69 40             adc #$40
       35:AB90  85 5D             sta <.pTargetBase
       35:AB92  90 02             bcc .add16by8_00067
       35:AB94  E6 5E                     inc <.pTargetBase+1
       35:AB96                    .add16by8_00067:
 1090  35:AB96  CA                                dex
 1091  35:AB97  10 E7                             bpl .set_lv
 1092                             .else
 1108                             .endif  ;BOOST_INTIMIDATE
 1109                             
 1110                             INIT16 <.pTargetBase,$7675
       35:AB99  A9 75             lda #LOW($7675)
       35:AB9B  85 5D             sta <.pTargetBase
       35:AB9D  A9 76             lda #HIGH($7675)
       35:AB9F  85 5E             sta <.pTargetBase+1
 1111  35:ABA1  A9 32             lda #$32
 1112  35:ABA3  8D DA 78          sta battleMessages
 1113  35:ABA6  A9 FF             lda #$ff
 1114  35:ABA8  8D D8 78          sta targetName  ;$78d8
 1115                             ;ldx #$39+$11
 1116  35:ABAB  A2 22             ldx #$11*2
 1117  35:ABAD  4C 57 A8          jmp setupActionType01
 1118                     
 1119                     ;$ad6b:
 1120                     ;}
 1121                     ;======================================================================================================
 1122                     ;$35:ad75 command_cheer
 1123  35:ABB0            command_cheer:
 1124                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
 1125  35:ABB0  A2 03             ldx #3
 1126  35:ABB2            .for_each_player:
 1127  35:ABB2  86 52                     stx <.iPlayer
 1128  35:ABB4  20 41 A5                  jsr getPlayerOffset
 1129  35:ABB7  18                        clc
 1130           0001              .ifdef BOOST_CHEER
 1131  35:ABB8  69 38                     adc #$38        ;bonus atk
 1132  35:ABBA  A8                        tay
 1133  35:ABBB  B1 5B                     lda [.pBattleParam],y
 1134                                     ;clc    ;always cleared
 1135  35:ABBD  69 20                     adc #$20
 1136  35:ABBF  90 05                     bcc .next
 1137  35:ABC1  A9 FF                             lda #$ff
 1138  35:ABC3  8D D8 78                          sta targetName
 1139                             .else
 1148                             .endif  ;BOOST_CHEER
 1149  35:ABC6                    .next:
 1150  35:ABC6  91 5B                     sta [.pBattleParam],y
 1151  35:ABC8  CA                        dex
 1152  35:ABC9  10 E7                     bpl .for_each_player
 1153  35:ABCB  A2 31             ldx #$31
 1154  35:ABCD  8E DA 78          stx battleMessages
 1155                             ;ldx #$39+$12
 1156  35:ABD0  A2 24             ldx #$12*2
 1157  35:ABD2  4C 57 A8          jmp setupActionType01
 1158                     
 1159  35:ABD5            ff3_commands_end:
 1160                     ;======================================================================================================
 1161                     ;       RESTORE_PC ff3_commands_begin
#[3]   ff3_hack_master.asm
#[4]   ff3_command_ex.asm
   45                                     .include "ff3_command_ex.asm"; consume( infoWindow_free, calc_player_param_free )
    1                     ; ff3_command_ex.asm
    2                     ;
    3                     ; description:
    4                     ;       replaces originally unimplemented command ($0a)
    5                     ;       implements 'extra ability' feature
    6                     ;
    7                     ; version:
    8                     ;       0.06 (2006-11-10)
    9                     ;======================================================================================================
   10  35:ABD5            ff3_command_ex_begin:
   11                     ;------------------------------------------------------------------------------------------------------
   12           003C      EXTRA_ABILITY_OFFSET    = $3c
   13                     
   14                     ;PASSIVE_ABILITY_MASK   = $FF
   15           0080      PASSIVE_COUNTER                 = $80
   16           0040      PASSIVE_DOUBLE_ITEM_EFFECT = $40
   17           0020      PASSIVE_PROTECT                 = $20
   18           0010      PASSIVE_SUMMON_FUSION   = $10
   19           0008      PASSIVE_WRESTLING               = $08
   20                     ;------------------------------------------------------------------------------------------------------
   21                     
   22                     ;replace tables
   23                     ;$34:9b21(file:69b31) actionId jobActionLists[4][22]
   24                             FILEORG $69b21
                0034              .bank   ($69b21) >> 13
                9B21              .org    ($8000 | (($69b21) & $7fff))
   25  34:9B21                    job_commands:
   26  34:9B21  04 05 06                  .db             $04,$05,$06,$14 ;00 onion
       34:9B24  14        
   27           0001              .ifdef GIVE_FIGHTER_RAID
   28  34:9B25  04 19 06                  .db             $04,$19,$06,$14 ;01 fighter
       34:9B28  14        
   29                             .else
   31                             .endif  ;GIVE_FIGHTER_RAID
   32  34:9B29  04 05 06                  .db             $04,$05,$06,$14 ;02 monk
       34:9B2C  14        
   33  34:9B2D  04 15 06                  .db             $04,$15,$06,$14 ;03 priest (white
       34:9B30  14        
   34  34:9B31  04 15 06                  .db             $04,$15,$06,$14 ;04 mage (black
       34:9B34  14        
   35  34:9B35  04 15 06                  .db             $04,$15,$06,$14 ;05 red
       34:9B38  14        
   36           0001              .ifdef GIVE_HUNTER_DISORDERED_SHOT
   37  34:9B39  04 17 15                          .db             $04,$17,$15,$14
       34:9B3C  14        
   38                             .else
   40                             .endif ;GIVE_HUNTER_DISORDERED_SHOT
   41  34:9B3D  04 05 06                  .db             $04,$05,$06,$14 ;07
       34:9B40  14        
   42  34:9B41  04 0E 07                  .db             $04,$0E,$07,$14 ;08
       34:9B44  14        
   43  34:9B45  04 0C 0D                  .db             $04,$0C,$0D,$14 ;09
       34:9B48  14        
   44  34:9B49  04 0B 05                  .db             $04,$0B,$05,$14 ;0a
       34:9B4C  14        
   45  34:9B4D  04 08 05                  .db             $04,$08,$05,$14 ;0b
       34:9B50  14        
   46           0001              .ifdef GIVE_VIKING_PROVOKE
   47  34:9B51  04 16 05                          .db             $04,$16,$05,$14 ;0c viking
       34:9B54  14        
   48                             .else
   50                             .endif  
   51  34:9B55  04 0F 05                  .db             $04,$0F,$05,$14 ;0d     martialist
       34:9B58  14        
   52           0001              .ifdef GIVE_EVILSWORDMAN_ABYSS
   53  34:9B59  04 18 15                  .db             $04,$18,$15,$14 ;0e
       34:9B5C  14        
   54                             .else
   56                             .endif
   57  34:9B5D  04 15 06                  .db             $04,$15,$06,$14 ;0f
       34:9B60  14        
   58  34:9B61  10 11 12                  .db             $10,$11,$12,$14 ;10     bard
       34:9B64  14        
   59  34:9B65  04 15 06                  .db             $04,$15,$06,$14 ;11
       34:9B68  14        
   60  34:9B69  04 15 06                  .db             $04,$15,$06,$14 ;12
       34:9B6C  14        
   61  34:9B6D  04 15 06                  .db             $04,$15,$06,$14 ;13
       34:9B70  14        
   62  34:9B71  04 15 06                  .db             $04,$15,$06,$14 ;14 sage
       34:9B74  14        
   63  34:9B75  04 05 06                  .db             $04,$05,$06,$14 ;15 ninja
       34:9B78  14        
   64                     ;------------------------------------------------------------------------------------------------------
   65           0039              .bank   $39
   66                     
   67           0001              .ifdef GIVE_FIGHTER_RAID
   68           BB23                      .org    $bb1a + ($01 * 5 + 4)
   69  39:BB23  F1                                .db %11110001   ;12 12 0 4
   70                             .endif  ;raid
   71           0001              .ifdef GIVE_HUNTER_DISORDERED_SHOT
   72           BB3C                      .org    $bb1a + ($06 * 5 + 4)
   73  39:BB3C                            jobParams_hunter_04:
   74  39:BB3C  F9                                .db %11111001   ;12 12 8 4 ; original = $d9 (%11011001)
   75                             .endif  ;disordered_shot
   76                             
   77           0001              .ifdef GIVE_VIKING_PROVOKE
   78           BB5A                      .org    $bb1a + ($0c * 5 + 4)   ;viking job param +04 (actionJobExp)
   79  39:BB5A                            jobParams_viking_04:
   80  39:BB5A  FA                                .db %11111010   ;12 12 8 8
   81                             .endif  ;provoke
   82                             
   83           0001              .ifdef GIVE_EVILSWORDMAN_ABYSS
   84           BB64                              .org    $bb1a + ($0e * 5 + 4)
   85  39:BB64  F9                                .db %11111001   ;12 12 8 4; original = $d9
   86                             .endif  ;abyss
   87                     ;======================================================================================================
   88                             RESTORE_PC infoWindow_free_begin
                0034              .bank   BANK(infoWindow_free_begin)
                9CAC              .org    infoWindow_free_begin
   89                     
   90  34:9CAC            extraAbilityNameIds:
   91  34:9CAC  0A                .db $0a
   92  34:9CAD  5A                .db EXMSG_DISORDERED_SHOT
   93  34:9CAE  5B                .db EXMSG_ABYSS
   94  34:9CAF  5C                .db EXMSG_RAID
   95                     
   96  34:9CB0            getExtraAbilityNameId:
   97                     ;[in] u8 a : actionId
   98  34:9CB0  C9 16             cmp #CMDX_ID_BEGIN
   99  34:9CB2  90 04             bcc .normal_command
  100  34:9CB4  AA                        tax
  101  34:9CB5  BD 96 9C                  lda extraAbilityNameIds-CMDX_ID_BEGIN,x
  102  34:9CB8            .normal_command
  103  34:9CB8  60                rts
  104                     
  105                     
  106           0001              .ifdef FAST_DISORDERED_SHOT
  107                     ;v0.6.1
  108  34:9CB9            setIndexAndCallPresentScene:
  109           0052      .iPlayer = $52
  110  34:9CB9  48                pha
  111  34:9CBA  20 AD 9F          jsr setXtoActorIndex
  112  34:9CBD  86 52             stx <.iPlayer
  113  34:9CBF  68                pla
  114  34:9CC0  4C 0E FA          jmp call_2e_9d53
  115                             .endif ;FAST_DISORDERED_SHOT
  116                     
  117  34:9CC3            updateTargetStatusByCache:
  118           0070      .pTarget = $70
  119           00E0      .targetStatusCache = $e0
  120  34:9CC3  20 A6 9F          jsr setXtoTargetIndex
  121  34:9CC6  0A                asl a
  122  34:9CC7  AA                tax
  123  34:9CC8  A0 02             ldy #2
  124  34:9CCA            .update:
  125                                     ;lda [.pTarget],y
  126  34:9CCA  B5 E1                     lda <.targetStatusCache+1,x
  127  34:9CCC  91 70                     sta [.pTarget],y
  128  34:9CCE  CA                        dex
  129  34:9CCF  88                        dey
  130  34:9CD0  D0 F8                     bne .update
  131  34:9CD2  60                rts
  132                     
  133                             VERIFY_PC infoWindow_free_end
       34:9CD3                    .verify_pc_00072:
                0000              .if (.verify_pc_00072 > infoWindow_free_end)
                                  .endif
  134                     ;======================================================================================================
  135                             RESTORE_PC calc_player_param_free_begin
                0031              .bank   BANK(calc_player_param_free_begin)
                AAB0              .org    calc_player_param_free_begin
  136  31:AAB0            extraAbilityFlags:
  137  31:AAB0  00                .db $00
  138  31:AAB1  00                .db $00
  139  31:AAB2  88                .db $88 ;monk
  140  31:AAB3  00                .db $00
  141                     
  142  31:AAB4  00                .db $00
  143  31:AAB5  00                .db $00
  144  31:AAB6  00                .db $00 ;hunter
  145  31:AAB7  20                .db $20 ;knight
  146                     
  147  31:AAB8  00                .db $00
  148  31:AAB9  40                .db $40 ;scholar
  149  31:AABA  00                .db $00
  150  31:AABB  00                .db $00
  151                     
  152  31:AABC  00                .db $00
  153  31:AABD  08                .db $08 ;martialist
  154  31:AABE  00                .db $00
  155  31:AABF  00                .db $00
  156                     
  157  31:AAC0  00 00 00          .db $00,$00,$00
  158  31:AAC3  10                .db $10 ;summoner
  159  31:AAC4  10                .db $10 ;sage
  160  31:AAC5  00                .db     $00     ;ninja
  161                     ;======================================================================================================
  162                             RESTORE_PC ff3_command_ex_begin
                0035              .bank   BANK(ff3_command_ex_begin)
                ABD5              .org    ff3_command_ex_begin
#[3]   ff3_hack_master.asm
   46                     
#[4]   ff3_item_window.asm
   47                                     .include "ff3_item_window.asm"  ;save
    1                     ; ff3_item_window.asm
    2                     ;
    3                     ; description:
    4                     ;       replaces entire item-window related codes
    5                     ;
    6                     ; version:
    7                     ;       0.12 (2006-11-12)
    8                     ;
    9                     ;======================================================================================================
   10  35:ABD5            ff3_itemWindow_begin:
   11                     
   12           ADAF      item_window_patch_begin = $adaf ;commandWindow_OnItemSelected
   13           B646      item_window_patch_end   = $b646 ;commandWindow_OnMagicSelected
   14                     
   15                             INIT_PATCH $35,item_window_patch_begin,item_window_patch_end
                0035              .bank   $35
                ADAF              .org    item_window_patch_begin
       35:ADAF                    .ds             ((item_window_patch_end) - (item_window_patch_begin))
                ADAF              .org    item_window_patch_begin
   16           ABD5              .org ff3_itemWindow_begin
   17                             ORIGINAL_ADDR item_window_patch_begin
   18                     ;----------------------------------------------------------------------------------------------------------     
   19                     ;global vars
   20                     ;shared with command window
   21           0052      iPlayer                 = $52   ;
   22           0059      pEquips                 = $59   ;
   23           005B      pPlayer                 = $5b   ;
   24           78CF      selectedAction  = $78cf ;
   25           7CE8      doesDrawActionName = $7ce8
   26                     ;------------------------------------------------------------------------------
   27           0062      row                             = $62
   28           0063      col                             = $63
   29           0066      windowLeft              = $66
   30           0067      mode                    = $67
   31           0068      lastRow                 = $68
   32           0069      lastCol                 = $69
   33           60C0      backpackItems   = $60c0
   34           7AF5      cachedItems             = $7af5
   35           7B3D      equipFlags              = $7b3d 
   36                     ;------------------------------------------------------------------------------
   37                     ;
   38           003E      removeId                = $3e           ;address must be $3e
   39           003F      removeCount             = $3f
   40           0040      equipId                 = $40           ;address must be $40
   41           0041      equipCount              = $41
   42           0042      removeIndex             = $42
   43           0043      equipIndex              = $43
   44           0044      removeFlag              = $44
   45           0045      equipFlag               = $45
   46                     ;==========================================================================================================
   47                     ;$35:adaf commandWindow_OnItemSelected()
   48                     ;       [in,out] u8 $52 : playerIndex
   49                     ;uses:
   50                     ;       u8 $62 : cursor row index (0-3), init : 0
   51                     ;       u8 $63 : cursor col index (0-7), init : 1
   52                     ;       u8 $65 : background no (used in scrolling function), init : 0
   53                     ;       u8 $66 : current window left (col index,equipWindow = 0), init : 1
   54                     ;       u8 $67 : indicates Nth selection  (0-1)
   55                     ;       u8 $68 : row index of 1st selection 
   56                     ;       u8 $69 : col index of 1st selection
   57                     ;       u8 $7afd[0x40] : items {id,count}
   58                     ;       u8 $7b3d[0x40] : equipflags (0 = cannot use/equip,mark 'x' next to name)
   59                     ;commandWindow_OnItemSelected:
   60  35:ABD5            commandWindow_OnItem:
   61           0010      .scrollX = $10
   62           0043      .counter = $43
   63  35:ABD5  20 C5 F8          jsr updateDmaPpuScrollSyncNmi
   64  35:ABD8  A9 00             lda #0
   65  35:ABDA  85 3D             sta <$3d        ;erase flag
   66  35:ABDC  20 B0 8E          jsr eraseWindow
   67                     
   68  35:ABDF  A9 78             lda #$78
   69  35:ABE1  85 10             sta <.scrollX
   70  35:ABE3  20 C5 F8          jsr updateDmaPpuScrollSyncNmi
   71                             
   72  35:ABE6  A9 00             lda #0
   73  35:ABE8  8D 73 75          sta $7573       ;erase flag
   74  35:ABEB  20 1F B1          jsr drawEquipWindow
   75                     
   76  35:ABEE  20 8D 9B          jsr setYtoOffset03
   77  35:ABF1  A2 00             ldx #0
   78  35:ABF3            .init_hands:
   79  35:ABF3  B1 59             lda [pEquips],y
   80  35:ABF5  9D F5 7A          sta $7af5,x
   81  35:ABF8  9D F7 7A          sta $7af7,x
   82  35:ABFB  C8                iny
   83  35:ABFC  B1 59             lda [pEquips],y
   84  35:ABFE  9D F6 7A          sta $7af6,x
   85  35:AC01  9D F8 7A          sta $7af8,x
   86  35:AC04  C8                iny
   87  35:AC05  E8                inx
   88  35:AC06  E8                inx
   89  35:AC07  E8                inx
   90  35:AC08  E8                inx
   91  35:AC09  E0 08             cpx #8
   92  35:AC0B  D0 E6             bne .init_hands
   93                             
   94  35:AC0D  A2 23             ldx #$23
   95  35:AC0F  A9 01             lda #1
   96  35:AC11            .init_flags:
   97  35:AC11  9D 3D 7B          sta equipFlags,x
   98  35:AC14  CA                dex
   99  35:AC15  10 FA             bpl .init_flags 
  100                             
  101  35:AC17  E8                inx     ;0
  102  35:AC18            .init_items:
  103  35:AC18  A9 00                     lda #0
  104  35:AC1A  85 20                     sta <$20
  105  35:AC1C  A9 94                     lda #$94
  106  35:AC1E  85 21                     sta <$21
  107  35:AC20  86 43                     stx <.counter
  108  35:AC22  BD C1 60                  lda backpackItems+1,x   ;count
  109  35:AC25  9D FE 7A                  sta cachedItems+9,x
  110  35:AC28  BD C0 60                  lda backpackItems,x             ;id
  111  35:AC2B  9D FD 7A                  sta cachedItems+8,x
  112                                     
  113  35:AC2E  C9 62                     cmp #$62        ;leather cap
  114  35:AC30  90 0A                     bcc .check_equip_valid_for_job
  115  35:AC32  C9 98                     cmp #$98        ;magical key
  116  35:AC34  90 0F                     bcc .cannot_use
  117  35:AC36  C9 C8                     cmp #$c8        ;magic 'flare'
  118  35:AC38  B0 0B                     bcs .cannot_use
  119  35:AC3A  90 10                     bcc .next
  120  35:AC3C                    .check_equip_valid_for_job:
  121                                             ;weapon or shield
  122  35:AC3C  85 18                             sta <$18
  123  35:AC3E  20 F9 B4                          jsr isPlayerAllowedToUseItem    ;$b8fd
  124  35:AC41  A5 1C                             lda <$1c
  125  35:AC43  D0 07                             bne .next
  126  35:AC45                    .cannot_use:    
  127  35:AC45  A5 43                     lda <.counter
  128  35:AC47  4A                        lsr a
  129  35:AC48  AA                        tax
  130  35:AC49  DE 41 7B                  dec equipFlags+4,x
  131  35:AC4C                    .next:
  132  35:AC4C  A6 43                     ldx <.counter
  133  35:AC4E  E8                        inx
  134  35:AC4F  E8                        inx
  135  35:AC50  E0 40                     cpx #$40
  136  35:AC52  D0 C4                     bne .init_items
  137                             
  138  35:AC54  A2 00             ldx #0
  139  35:AC56  86 3D             stx <$3d
  140  35:AC58            .init_window:
  141  35:AC58  86 43             stx <.counter
  142  35:AC5A  20 82 B1          jsr loadTileArrayForItemWindowColumn
  143  35:AC5D  A6 43             ldx <.counter
  144  35:AC5F  BD 2C AD          lda initWindowParams,x
  145  35:AC62  85 18             sta <$18
  146  35:AC64  E8                inx
  147  35:AC65  BD 2C AD          lda initWindowParams,x
  148  35:AC68  85 19             sta <$19
  149  35:AC6A  E8                inx
  150  35:AC6B  BD 2C AD          lda initWindowParams,x
  151  35:AC6E  85 1A             sta <$1a
  152  35:AC70  E8                inx
  153  35:AC71  86 43             stx <.counter
  154  35:AC73  20 38 8B          jsr draw8LineWindow
  155  35:AC76  A6 43             ldx <.counter
  156  35:AC78  E0 09             cpx #$9
  157  35:AC7A  D0 DC             bne .init_window
  158                             
  159  35:AC7C  A9 02             lda #2
  160  35:AC7E  85 55             sta <$55
  161  35:AC80  A9 01             lda #1
  162  35:AC82  85 1A             sta <$1a
  163  35:AC84  20 66 89          jsr loadCursor
  164                             
  165  35:AC87  A9 01             lda #1
  166  35:AC89  85 1A             sta <$1a
  167  35:AC8B  A9 F0             lda #$f0
  168  35:AC8D  85 1C             sta <$1c
  169  35:AC8F  85 1D             sta <$1d
  170  35:AC91  20 2E 89          jsr tileSprites2x2
  171                             
  172  35:AC94  A9 02             lda #2
  173  35:AC96  85 55             sta <$55
  174  35:AC98  A9 00             lda #0
  175  35:AC9A  85 1A             sta <$1a
  176  35:AC9C  20 66 89          jsr loadCursor
  177                     
  178  35:AC9F  A2 00             ldx #0
  179  35:ACA1  86 62             stx <$62        ;row
  180                             ;stx <$65       ;scroll toggle
  181  35:ACA3  86 67             stx <$67        ;mode
  182  35:ACA5  E8                inx
  183  35:ACA6  86 63             stx <$63        ;col
  184  35:ACA8  86 66             stx <$66        ;left
  185                     
  186  35:ACAA            itemWindowInputLoop:
  187  35:ACAA  20 85 81          jsr presentCharacter
  188  35:ACAD  20 AA FB          jsr getPad1Input
  189  35:ACB0  A5 12             lda <inputBits
  190  35:ACB2  F0 F6             beq itemWindowInputLoop
  191  35:ACB4  48                pha
  192  35:ACB5  20 79 9B          jsr requestSoundEffect18        ;9b79
  193  35:ACB8  68                pla
  194                     ;itemWindow_dispatchInput:
  195  35:ACB9  A6 63                     ldx <col
  196  35:ACBB  A4 62                     ldy <row
  197  35:ACBD  0A                        asl a
  198  35:ACBE  B0 4A                     bcs .OnRight
  199  35:ACC0  0A                        asl a
  200  35:ACC1  B0 30                     bcs .OnLeft
  201  35:ACC3  0A                        asl a
  202  35:ACC4  B0 1D                     bcs .OnDown
  203  35:ACC6  0A                        asl a
  204  35:ACC7  B0 0D                     bcs .OnUp
  205  35:ACC9  0A                        asl a
  206                                     ;bcs start
  207  35:ACCA  0A                        asl a
  208                                     ;bcs select
  209  35:ACCB  0A                        asl a
  210  35:ACCC  B0 05                     bcs .OnB
  211  35:ACCE  0A                        asl a
  212  35:ACCF  90 D9                     bcc itemWindowInputLoop ;($aeaa)
  213  35:ACD1            .OnA:
  214                                     ;jmp itemWindow_OnA
  215  35:ACD1  B0 62                     bcs itemWindow_OnA
  216  35:ACD3            .OnB:
  217  35:ACD3  4C E7 AE                  jmp itemWindow_OnB
  218  35:ACD6            .OnUp:  
  219  35:ACD6  98                        tya
  220  35:ACD7  F0 D1                     beq itemWindowInputLoop ;($aeaa)
  221  35:ACD9  E0 00                     cpx #$00
  222  35:ACDB  D0 03                     bne .nocheck_up
  223  35:ACDD  88                        dey
  224  35:ACDE  F0 CA                     beq itemWindowInputLoop
  225  35:ACE0                    .nocheck_up:
  226  35:ACE0  88                        dey
  227  35:ACE1  10 3D                     bpl .update             
  228  35:ACE3            .OnDown:
  229  35:ACE3  C0 03                     cpy #$03
  230  35:ACE5  F0 C3                     beq itemWindowInputLoop ;($aeaa)
  231  35:ACE7  E0 00                     cpx #$00
  232  35:ACE9  D0 05                     bne .nocheck_down
  233  35:ACEB  C8                        iny
  234  35:ACEC  C0 04                     cpy #$04
  235  35:ACEE  F0 BA                     beq itemWindowInputLoop ;($aeaa)
  236  35:ACF0                    .nocheck_down:
  237  35:ACF0  C8                        iny
  238  35:ACF1  10 2D                     bpl .update
  239  35:ACF3            .OnLeft:
  240  35:ACF3  8A                        txa
  241  35:ACF4  F0 B4                     beq itemWindowInputLoop
  242  35:ACF6  C5 66                     cmp <$66
  243  35:ACF8  D0 07                     bne .noscroll_left
  244  35:ACFA  20 52 B0                  jsr itemWindow_scrollLeft       ;$b362
  245  35:ACFD  A6 63                     ldx <col
  246  35:ACFF  A4 62                     ldy <row
  247  35:AD01                    .noscroll_left:
  248  35:AD01  CA                        dex
  249  35:AD02  D0 04                     bne .nocheck_left
  250  35:AD04  98                        tya
  251  35:AD05  09 01                     ora #1
  252  35:AD07  A8                        tay
  253  35:AD08                    .nocheck_left:
  254  35:AD08  D0 16                     bne .update     
  255  35:AD0A            .OnRight:
  256  35:AD0A  E0 08                     cpx #$08
  257  35:AD0C  F0 9C                     beq itemWindowInputLoop
  258  35:AD0E  A5 66                     lda <$66
  259  35:AD10  C9 07                     cmp #$07
  260  35:AD12  F0 0B                     beq .noscroll_right
  261  35:AD14  C5 63                     cmp <col
  262  35:AD16  F0 07                     beq .noscroll_right
  263  35:AD18  20 26 B0                  jsr itemWindow_scrollRight      ;$b2a7
  264  35:AD1B  E6 63                     inc <col
  265  35:AD1D  D0 07                     bne .moveOnly
  266  35:AD1F                    .noscroll_right:
  267  35:AD1F  E8                        inx
  268  35:AD20            .update:
  269  35:AD20  8A                        txa
  270  35:AD21  85 63                     sta <col
  271  35:AD23  98                        tya
  272  35:AD24  85 62                     sta <row
  273  35:AD26            .moveOnly:
  274  35:AD26  20 C1 B1                  jsr itemWindow_moveCursor
  275  35:AD29  4C AA AC                  jmp itemWindowInputLoop
  276                     ;----------------------------------------------------------------------------------------------------------
  277  35:AD2C  10 1E 01  initWindowParams:       DB      $10,$1e,1,      $1f,$8d,0,      $8e,$9c,0
       35:AD2F  1F 8D 00  
       35:AD32  8E 9C 00  
  278                     ;==========================================================================================================
  279                     ;itemWindow_OnA
  280                     ;------------------------------------------------------------------------------
  281                     ;       .org    $af4c
  282  35:AD35            itemWindow_OnA:
  283  35:AD35  A5 67             lda <mode
  284  35:AD37  D0 29             bne .second_item
  285  35:AD39  E6 67                     inc <mode
  286  35:AD3B  A5 62                     lda <row
  287  35:AD3D  85 68                     sta <lastRow
  288  35:AD3F  A5 63                     lda <col
  289  35:AD41  85 69                     sta <lastCol
  290  35:AD43  20 C1 B1                  jsr itemWindow_moveCursor
  291  35:AD46  A5 1D                     lda <$1d
  292  35:AD48  18                        clc
  293  35:AD49  69 04                     adc #4
  294  35:AD4B  85 1D                     sta <$1d
  295  35:AD4D  A9 01                     lda #1
  296  35:AD4F  85 1A                     sta <$1a
  297  35:AD51  20 2E 89                  jsr tileSprites2x2
  298  35:AD54  20 7D 9B                  jsr requestSoundEffect05        ;9b7d
  299  35:AD57  A2 10                     ldx #$10
  300  35:AD59            .present_loop:
  301  35:AD59  20 85 81                          jsr presentCharacter
  302  35:AD5C  CA                                dex
  303  35:AD5D  D0 FA                             bne .present_loop
  304  35:AD5F  4C AA AC                  jmp itemWindowInputLoop
  305  35:AD62            .second_item:
  306  35:AD62  A6 63             ldx <col
  307  35:AD64  A4 62             ldy <row
  308  35:AD66  E4 69             cpx <lastCol
  309  35:AD68  D0 07             bne .exchange_item
  310  35:AD6A  C4 68             cpy <lastRow
  311  35:AD6C  D0 03             bne .exchange_item
  312  35:AD6E  4C DD B1                  jmp itemWindow_OnUse
  313  35:AD71            .exchange_item:
  314  35:AD71  8A                txa
  315  35:AD72  D0 06             bne .check_lastcol
  316  35:AD74  A5 69             lda <lastCol
  317  35:AD76  D0 0C             bne .exchange_ok
  318  35:AD78  F0 04             beq .cannot_exchange
  319  35:AD7A            .check_lastcol:
  320  35:AD7A  A5 69             lda <lastCol
  321  35:AD7C  F0 06             beq .exchange_ok
  322  35:AD7E            .cannot_exchange:
  323  35:AD7E  20 81 9B          jsr $9b81
  324  35:AD81  4C AA AC          jmp itemWindowInputLoop
  325  35:AD84            .exchange_ok:
  326  35:AD84  A9 00             lda #0
  327  35:AD86  8D 08 74          sta $7408
  328  35:AD89  A9 01             lda #1
  329  35:AD8B  8D 09 74          sta $7409
  330  35:AD8E  E4 69             cpx <lastCol
  331  35:AD90  90 09             bcc .no_swap
  332  35:AD92  20 0E AF                  jsr swap_current_and_last
  333  35:AD95  EE 08 74                  inc $7408
  334  35:AD98  CE 09 74                  dec $7409
  335  35:AD9B            .no_swap:
  336  35:AD9B  A5 69             lda <lastCol
  337  35:AD9D  0A                asl a
  338  35:AD9E  0A                asl a
  339  35:AD9F  18                clc             ;not neccesary
  340  35:ADA0  65 68             adc <lastRow
  341  35:ADA2  85 45             sta <equipFlag
  342  35:ADA4  0A                asl a
  343  35:ADA5  85 43             sta <equipIndex
  344  35:ADA7  A6 45             ldx <equipFlag
  345  35:ADA9  BD 3D 7B          lda equipFlags,x
  346  35:ADAC  D0 0E             bne .exchangeable
  347  35:ADAE            .fail:
  348  35:ADAE  20 81 9B                  jsr $9b81
  349  35:ADB1  AD 08 74                  lda $7408
  350  35:ADB4  F0 03                     beq .no_swap_restore
  351  35:ADB6  20 0E AF                          jsr swap_current_and_last
  352  35:ADB9            .no_swap_restore:
  353  35:ADB9  4C AA AC                  jmp itemWindowInputLoop
  354  35:ADBC            .exchangeable:
  355  35:ADBC  A6 43             ldx <equipIndex
  356  35:ADBE  BD F5 7A          lda cachedItems,x
  357  35:ADC1  B0 EB             bcs .fail
  358  35:ADC3  85 40             sta <equipId
  359  35:ADC5  E8                inx
  360  35:ADC6  BD F5 7A          lda cachedItems,x
  361  35:ADC9  85 41             sta <equipCount
  362                             
  363  35:ADCB  A5 63             lda <col
  364  35:ADCD  0A                asl a
  365  35:ADCE  0A                asl a
  366  35:ADCF  18                clc
  367  35:ADD0  65 62             adc <row
  368  35:ADD2  85 44             sta <removeFlag
  369  35:ADD4  0A                asl a
  370  35:ADD5  85 42             sta <removeIndex
  371                             
  372  35:ADD7  AA                tax
  373  35:ADD8  BD F5 7A          lda cachedItems,x
  374  35:ADDB  85 3E             sta <removeId
  375  35:ADDD  E8                inx
  376  35:ADDE  BD F5 7A          lda cachedItems,x
  377  35:ADE1  85 3F             sta <removeCount
  378                     
  379                             ;jsr $b242      ;checks 2-handed weapon?
  380  35:ADE3  20 F1 AF          jsr isHandFreeForItem
  381  35:ADE6  B0 C6             bcs .fail
  382  35:ADE8  A5 40             lda <equipId
  383  35:ADEA  C5 3E             cmp <removeId
  384  35:ADEC  D0 2C             bne .different_item
  385  35:ADEE  C9 00                     cmp #0
  386  35:ADF0  F0 BC                     beq .fail
  387  35:ADF2  A9 00                     lda #0
  388  35:ADF4  A6 42                     ldx <removeIndex
  389  35:ADF6  9D F5 7A                  sta cachedItems,x
  390  35:ADF9  E8                        inx
  391  35:ADFA  9D F5 7A                  sta cachedItems,x
  392  35:ADFD  A6 44                     ldx <removeFlag
  393  35:ADFF  A9 01                     lda #1
  394  35:AE01  9D 3D 7B                  sta equipFlags,x
  395  35:AE04  A6 43                     ldx <equipIndex
  396  35:AE06  E8                        inx
  397  35:AE07  18                        clc
  398  35:AE08  A5 3F                     lda <removeCount
  399  35:AE0A  65 41                     adc <equipCount
  400  35:AE0C  C9 64                     cmp #100
  401  35:AE0E  90 02                     bcc .under_100
  402  35:AE10  A9 63                             lda #99
  403  35:AE12            .under_100:
  404  35:AE12  9D F5 7A                  sta cachedItems,x
  405  35:AE15  8A                        txa
  406  35:AE16  48                        pha
  407  35:AE17  4C 53 AE                  jmp .copyback    
  408  35:AE1A            .different_item:
  409  35:AE1A  A4 41             ldy <equipCount
  410  35:AE1C  C9 00             cmp #0
  411  35:AE1E  F0 2F             beq .pick_result_empty
  412  35:AE20  C9 4F             cmp #$4f        ;wooden arrow
  413  35:AE22  90 0C             bcc .not_arrow
  414  35:AE24  C9 57             cmp #$57        ;medusa arrow
  415  35:AE26  B0 08             bcs .not_arrow
  416  35:AE28            .arrow:
  417                             ;min(equipcount,20)
  418  35:AE28  C0 15             cpy #21
  419  35:AE2A  90 23             bcc .pick_result_empty
  420  35:AE2C  A0 14             ldy #20
  421  35:AE2E  D0 06             bne .exchange
  422  35:AE30            .not_arrow:
  423  35:AE30  C0 01             cpy #1
  424  35:AE32  F0 1B             beq .pick_result_empty
  425  35:AE34  A0 01             ldy #1
  426  35:AE36            .exchange:
  427  35:AE36  A6 3E             ldx <removeId
  428  35:AE38  F0 15             beq .pick_result_empty
  429           0025      .count = $25
  430  35:AE3A  84 25             sty <.count
  431  35:AE3C  20 75 AF          jsr getIndexToPutRemovedItem
  432  35:AE3F  90 03             bcc .can_put
  433  35:AE41  4C AE AD          jmp .fail
  434  35:AE44            .can_put:       
  435  35:AE44  A5 40             lda <equipId
  436  35:AE46  A4 25             ldy <.count
  437  35:AE48  20 FD AE          jsr doExchange
  438  35:AE4B  48                pha     ;col index
  439  35:AE4C  4C 53 AE          jmp .copyback
  440  35:AE4F            .pick_result_empty:
  441                             ;here already a = equipid,y = count
  442  35:AE4F  20 FD AE          jsr doExchange
  443  35:AE52  48                pha     ;col index
  444  35:AE53            .swap_flag:
  445           0000              .IFNDEF CONTINUE_ON_EQUIP_CHANGE
  456                             .ENDIF
  457                     ;here originally $b131          
  458                     ;       .org $b131
  459  35:AE53            .copyback:      
  460  35:AE53  A2 3F             ldx #$3f
  461  35:AE55                    .copyloop:
  462  35:AE55  BD FD 7A                  lda cachedItems+8,x
  463  35:AE58  9D C0 60                  sta backpackItems,x
  464  35:AE5B  CA                        dex
  465  35:AE5C  10 F7                     bpl .copyloop
  466                     
  467                     ;$b13e:         
  468  35:AE5E  20 8D 9B          jsr $9b8d       ;set y to offset 3
  469  35:AE61  AD F7 7A          lda $7af7
  470  35:AE64  91 59             sta [pEquips],y
  471  35:AE66  C8                iny
  472  35:AE67  AD F8 7A          lda $7af8
  473  35:AE6A  91 59             sta [pEquips],y
  474  35:AE6C  C8                iny
  475                             
  476  35:AE6D  AD FB 7A          lda $7afb
  477  35:AE70  91 59             sta [pEquips],y
  478  35:AE72  C8                iny
  479  35:AE73  AD FC 7A          lda $7afc
  480  35:AE76  91 59             sta [pEquips],y
  481  35:AE78  C8                iny
  482  35:AE79  20 7D 9B          jsr requestSoundEffect05
  483  35:AE7C  AD 08 74          lda $7408
  484  35:AE7F  F0 03             beq .no_swap_restore_req
  485  35:AE81  20 0E AF                  jsr swap_current_and_last
  486  35:AE84            .no_swap_restore_req:
  487  35:AE84  68                pla     ;updated col index
  488  35:AE85  4A                lsr a
  489  35:AE86  4A                lsr a
  490  35:AE87  4A                lsr a
  491  35:AE88  48                pha
  492                             
  493  35:AE89  A6 63             ldx <col
  494  35:AE8B  D0 10             bne .not_in_equipWindow
  495  35:AE8D  20 1A B1                  jsr drawEquipWindowNoErase      ;$35:b5f9
  496  35:AE90  68                        pla
  497  35:AE91  C9 03                     cmp #3
  498  35:AE93  B0 27                     bcs .finish
  499  35:AE95  AA                                tax
  500  35:AE96  CA                                dex
  501  35:AE97  20 80 B0                          jsr drawItemWindowColumn        ;subsituate jsr $b601
  502  35:AE9A  4C BC AE                          jmp .finish     
  503  35:AE9D            .not_in_equipWindow:
  504  35:AE9D  CA                        dex     ;based equip-window => based item0
  505  35:AE9E  20 80 B0                  jsr drawItemWindowColumn
  506  35:AEA1  68                        pla
  507  35:AEA2  AA                        tax     ;updated col
  508  35:AEA3  18                        clc
  509  35:AEA4  69 02                     adc #2
  510  35:AEA6  38                        sec
  511  35:AEA7  E5 66                     sbc <windowLeft ;a = (col - 1) - left + 3
  512  35:AEA9  30 08                     bmi .check_equip_redraw ; (col + 2) - left < 0 : col < left - 2
  513  35:AEAB  C9 05                     cmp #5
  514  35:AEAD  B0 04                     bcs .check_equip_redraw ; col + 2 - left - 5 >= 0  col >= left + 3
  515  35:AEAF  CA                                dex     
  516  35:AEB0  20 80 B0                          jsr drawItemWindowColumn        ;subsituate jsr $b601
  517  35:AEB3                    .check_equip_redraw:
  518  35:AEB3  A5 63                     lda <col
  519  35:AEB5  C9 03                     cmp #3
  520  35:AEB7  B0 03                     bcs .finish
  521  35:AEB9  20 1A B1                          jsr drawEquipWindowNoErase
  522                     
  523  35:AEBC            .finish:
  524  35:AEBC  20 26 80          jsr dispatchBattleFunction_05   ;$8026 => recalcParams
  525           E000              .IF CONTINUE_ON_EQUIP_CHANGE
  526  35:AEBF  4C EB AE                  jmp itemWindow_cancel2nd                        
  527                             .ENDIF  
  528                     
  529                     ; itemWindow_OnB will jump to here
  530  35:AEC2            itemWindow_closeAndKeepCurrentPlayer:   
  531  35:AEC2  C6 52             dec <iPlayer
  532                     ; useItem will jump to here
  533                     ;$b198
  534  35:AEC4            closeItemWindow:
  535  35:AEC4  20 B0 8E          jsr eraseWindow ;$34:8eb0();
  536  35:AEC7  A9 00             lda #0
  537  35:AEC9  85 10             sta <$10
  538  35:AECB  A5 08             lda <$08
  539  35:AECD  29 FE             and #$fe
  540  35:AECF  85 08             sta <$08
  541  35:AED1  20 C5 F8          jsr updateDmaPpuScrollSyncNmi ;$3f:f8c5();
  542  35:AED4  A9 00             lda #0
  543  35:AED6  85 18             sta <$18
  544  35:AED8  20 DF 8A          jsr clearSprites2x2      ;
  545  35:AEDB  A9 01             lda #1
  546  35:AEDD  85 18             sta <$18
  547  35:AEDF  20 DF 8A          jsr clearSprites2x2
  548  35:AEE2  E6 52             inc <iPlayer
  549                             ;causes window-erase bug
  550                             ;$b1d0: dispatchBattleCommand(5); ;$34:8026();  
  551  35:AEE4  A9 00             lda #0
  552                             RET_TO_GET_COMMAND_INPUT
       35:AEE6  60                rts
  553                             ;jmp getCommandInput_next       ;$99fd
  554                     
  555                     ;$b198:
  556                     ;[in,out] u8 $67 : mode (0 = 1st,1=2nd selection)
  557  35:AEE7            itemWindow_OnB:
  558  35:AEE7  A5 67             lda <mode
  559  35:AEE9  F0 D7             beq itemWindow_closeAndKeepCurrentPlayer
  560  35:AEEB            itemWindow_cancel2nd:   
  561  35:AEEB  C6 67                     dec <mode
  562  35:AEED  A9 01                     lda #1
  563  35:AEEF  85 1A                     sta <$1a
  564  35:AEF1  A9 F0                     lda #$f0
  565  35:AEF3  85 1C                     sta <$1c
  566  35:AEF5  85 1D                     sta <$1d
  567  35:AEF7  20 2E 89                  jsr tileSprites2x2
  568  35:AEFA  4C AA AC                  jmp itemWindowInputLoop ;$aeaa
  569                     ;----------------------------------------------------------------------------------------------------------
  570                     ;utilities
  571  35:AEFD            doExchange:
  572                     ;[in] y = counttopick, a = id
  573                     ;[out] a = offset to removed item's count
  574  35:AEFD  20 23 AF          jsr pickAndEquipItem
  575  35:AF00  20 75 AF          jsr getIndexToPutRemovedItem
  576  35:AF03  B0 08             bcs .itemfull
  577  35:AF05  A5 3E             lda <removeId
  578  35:AF07  A4 3F             ldy <removeCount
  579  35:AF09  20 4D AF          jsr putItem
  580  35:AF0C  8A                txa
  581  35:AF0D            .itemfull:      
  582  35:AF0D  60                rts
  583  35:AF0E            swap_current_and_last:
  584  35:AF0E  A5 62             lda <row
  585  35:AF10  48                pha
  586  35:AF11  A5 68             lda <lastRow
  587  35:AF13  85 62             sta <row
  588  35:AF15  68                pla
  589  35:AF16  85 68             sta <lastRow
  590  35:AF18            swap_col:
  591  35:AF18  A5 63             lda <col
  592  35:AF1A  48                pha
  593  35:AF1B  A5 69             lda <lastCol
  594  35:AF1D  85 63             sta <col
  595  35:AF1F  68                pla
  596  35:AF20  85 69             sta <lastCol
  597  35:AF22  60                rts
  598                     ;----------------------------------------------------------------------------------------------------------     
  599  35:AF23            pickAndEquipItem:       ;y : countToPick
  600  35:AF23  A6 43             ldx <equipIndex
  601                             ;dey
  602  35:AF25  98                tya
  603  35:AF26  49 FF             eor #$ff        ;NOT
  604  35:AF28  18                clc
  605  35:AF29  65 41             adc <equipCount
  606                             ;here A = equipCount - pickCount - 1
  607  35:AF2B  90 08             bcc .pickAll    
  608  35:AF2D  E8                inx
  609  35:AF2E  69 00             adc #0  ;add carry (here always 1)
  610                             ;iny
  611  35:AF30  9D F5 7A          sta cachedItems,x       ;update count
  612  35:AF33  10 0B             bpl .putEquip
  613  35:AF35            .pickAll:
  614  35:AF35  A9 00             lda #0
  615  35:AF37  9D F5 7A          sta cachedItems,x
  616  35:AF3A  E8                inx
  617  35:AF3B  9D F5 7A          sta cachedItems,x
  618           0000              .IF UPDATE_FLAGS
  622                             .ENDIF
  623  35:AF3E  A4 41             ldy <equipCount
  624  35:AF40            .putEquip:
  625  35:AF40  A6 42             ldx <removeIndex
  626  35:AF42  A5 40             lda <equipId    
  627  35:AF44  9D F5 7A          sta cachedItems,x
  628  35:AF47  E8                inx
  629  35:AF48  98                tya     ;count
  630  35:AF49  9D F5 7A          sta cachedItems,x
  631  35:AF4C  60                rts
  632                     ;----------------------------------------------------------------------------------------------------------     
  633  35:AF4D            putItem:
  634                     ;[in] a:itemid, x:index, y:count
  635                     ;[out] x : offset to put item's count
  636  35:AF4D  DD F5 7A          cmp cachedItems,x
  637  35:AF50  D0 08             bne .putToFree
  638                             ;there is same item,stack it
  639  35:AF52  E8                inx
  640  35:AF53  98                tya
  641  35:AF54  18                clc
  642  35:AF55  7D F5 7A          adc cachedItems,x
  643  35:AF58  10 05             bpl .storeCount
  644  35:AF5A            .putToFree
  645  35:AF5A  9D F5 7A          sta cachedItems,x       ;id
  646           0000              .IF UPDATE_FLAGS
  655                             .ENDIF
  656  35:AF5D  E8                inx
  657  35:AF5E  98                tya
  658  35:AF5F            .storeCount:
  659  35:AF5F  9D F5 7A          sta cachedItems,x       ;count
  660  35:AF62  60                rts
  661                     ;----------------------------------------------------------------------------------------------------------
  662           0048      findItem_notFound = $48 
  663  35:AF63            findItem:       ;a : findId     
  664           0024      .idToFind = $24
  665  35:AF63  A2 08             ldx #8
  666  35:AF65  85 24             sta <.idToFind
  667  35:AF67            .find_loop:
  668  35:AF67  BD F5 7A                  lda cachedItems,x
  669  35:AF6A  C5 24                     cmp <.idToFind
  670  35:AF6C  F0 06                     beq .found
  671  35:AF6E  E8                        inx
  672  35:AF6F  E8                        inx
  673  35:AF70  E0 48                     cpx #findItem_notFound 
  674  35:AF72  D0 F3                     bne .find_loop
  675  35:AF74            .found:         
  676  35:AF74  60                rts
  677                     ;----------------------------------------------------------------------------------------------------------
  678  35:AF75            getIndexToPutRemovedItem:
  679                     ;[out] bool carry : 0=putable ,x = index
  680  35:AF75  A5 3E             lda <removeId
  681  35:AF77  20 63 AF          jsr findItem
  682  35:AF7A  E0 48             cpx #findItem_notFound
  683  35:AF7C  D0 08             bne .checkCount
  684  35:AF7E            .tryFreeSpace:  
  685  35:AF7E  A9 00             lda #0
  686  35:AF80  20 63 AF          jsr findItem
  687  35:AF83  E0 48             cpx #findItem_notFound
  688  35:AF85  60                rts
  689  35:AF86            .checkCount:
  690  35:AF86  E8                inx
  691  35:AF87  A5 3F             lda <removeCount
  692  35:AF89  18                clc
  693  35:AF8A  7D F5 7A          adc cachedItems,x
  694  35:AF8D  CA                dex
  695  35:AF8E  C9 64             cmp #100
  696  35:AF90  60                rts
  697                     ;==========================================================================================================
  698                     ;       .org $b1d8
  699                     ;       .incbin "ff3_$35_b1d8-b4f6.bin"
  700                     ;       .org $b1d8
  701                     
  702  35:AF91            loadTileArrayOfItemProps:       
  703                     ;       [in] u8 $34[2][4] : items
  704                     ;       [in] u16 $43 : ptrToDestTileArray
  705           0034      .items = $34
  706           003C      .counter = $3c
  707  35:AF91  20 54 97          jsr initTileArrayStorage        ;$9754  ;fill_7200to73ff_ff();
  708  35:AF94  A9 00             lda #0
  709  35:AF96  85 3C             sta <.counter
  710  35:AF98            .loop:
  711  35:AF98  A2 0D                     ldx #$0d
  712  35:AF9A  20 49 A5                  jsr initString  ;$35:a549
  713  35:AF9D  A6 3C                     ldx <.counter
  714  35:AF9F  B5 34                     lda <.items,x
  715  35:AFA1  C9 FF                     cmp #$ff
  716  35:AFA3  D0 04                     bne .check_string
  717  35:AFA5  A9 1A                             lda #$0d * 2
  718  35:AFA7  D0 3A                             bne .offset_line
  719  35:AFA9                    .check_string:
  720  35:AFA9  85 1A                     sta <$1a
  721  35:AFAB  BD 00 74                  lda $7400,x
  722  35:AFAE  D0 05                     bne .load_string
  723  35:AFB0  A9 73                             lda #$73
  724  35:AFB2  8D D7 7A                          sta stringCache ;$7ad7
  725  35:AFB5                    .load_string:
  726  35:AFB5  A9 88                     lda #$88
  727  35:AFB7  85 19                     sta <$19
  728  35:AFB9  B5 35                     lda <.items+1,x
  729  35:AFBB  48                        pha
  730  35:AFBC  A9 00                     lda #0
  731  35:AFBE  AA                        tax
  732  35:AFBF  E8                        inx
  733  35:AFC0  85 18                     sta <$18
  734  35:AFC2  A5 1A                     lda <$1a
  735  35:AFC4  20 09 A6                  jsr loadString
  736                                     
  737  35:AFC7  A9 C8                     lda #$c8
  738  35:AFC9  8D E1 7A                  sta stringCache+10
  739           0000              .IFNDEF USE_ITOA8       
  749                             .ELSE
  750  35:AFCC  68                        pla     ;count
  751  35:AFCD  20 25 A6                  jsr itoa_8
  752  35:AFD0  A5 1B                     lda <$1b
  753  35:AFD2  8D E2 7A                  sta stringCache+11
  754  35:AFD5  A5 1C                     lda <$1c
  755  35:AFD7  8D E3 7A                  sta stringCache+12
  756                             .ENDIF  
  757  35:AFDA  A9 0D                     lda #$0d
  758  35:AFDC  85 18                     sta <$18
  759  35:AFDE  20 6A 96                  jsr strToTileArray
  760  35:AFE1  A9 0D                     lda #$0d
  761  35:AFE3                    .offset_line:
  762  35:AFE3  20 58 A5                  jsr offsetTilePtr       ;$35:a559
  763  35:AFE6  E6 3C                     inc <.counter
  764  35:AFE8  E6 3C                     inc <.counter
  765  35:AFEA  A5 3C                     lda <.counter
  766  35:AFEC  C9 08                     cmp #8
  767  35:AFEE  D0 A8             bne .loop
  768  35:AFF0  60                rts
  769                     ;==========================================================================================================
  770                     ;$35:b242 isHandFreeForItem
  771                     ;       [in] itemid $3e : toRemove
  772                     ;       [in] itemid $40 : toEquip
  773                     ;       [in] itemid $7af5 : righthand
  774                     ;       [in] itemid $7af9 : lefthand
  775                     ;       [out] bool carry : 0:ok 1:bad combination
  776                     ;       original:65h bytes      
  777                     ;(id)
  778                     ;00             o       o       o       o       o       o
  779                     ;01-45          o       x       x       x       o
  780                     ;46-49                  x       x       x       x
  781                     ;4a-4e                          x       o       x
  782                     ;4f-57                                  x       x
  783                     ;58-64                                          o
  784                     ;       .ORG $b242
  785                     ;       .DS $65+$172            ;init original region
  786                     ;
  787  35:AFF1            isHandFreeForItem:
  788           003E      .toRemove = $3e
  789           0040      .toEquip = $40
  790           7AF7      .right = $7af5+2        ;original version uses $7af5,but it is not updated through equip change
  791           7AFB      .left = $7af9+2         ;
  792  35:AFF1  AD F7 7A          lda .right
  793  35:AFF4  C5 3E             cmp <.toRemove
  794  35:AFF6  D0 03             bne .get_mask
  795  35:AFF8  AD FB 7A                  lda .left
  796  35:AFFB            .get_mask:
  797  35:AFFB  20 14 B0          jsr idToKind
  798  35:AFFE  BD 0D B0          lda .masks,x
  799  35:B001  48                pha
  800  35:B002  A5 40             lda <.toEquip
  801  35:B004  20 14 B0          jsr idToKind
  802  35:B007  68                pla
  803  35:B008            .shift_loop:
  804  35:B008  0A                        asl a
  805  35:B009  CA                        dex
  806  35:B00A  10 FC             bpl .shift_loop
  807  35:B00C  60                rts
  808  35:B00D            .masks: ;0=ok 1:no
  809  35:B00D  03                .DB             %00000011       ;00
  810  35:B00E  3B                .DB             %00111011       ;01-45
  811  35:B00F  7F                .DB             %01111111       ;46-49
  812  35:B010  77                .DB             %01110111       ;4a-4e
  813  35:B011  6F                .DB             %01101111       ;4f-57
  814  35:B012  3B                .DB             %00111011       ;58-64
  815  35:B013  FF                .DB             %11111111       ;65-
  816                     ;---------------------------------------------------------------------------------------------------------
  817  35:B014            idToKind:       ;a = id,x = result
  818  35:B014  A2 05             ldx #5
  819  35:B016            .loop:
  820  35:B016  DD 20 B0                  cmp .bounds,x
  821  35:B019  B0 03                     bcs .return
  822  35:B01B  CA                        dex
  823  35:B01C  10 F8             bpl .loop
  824  35:B01E            .return:
  825  35:B01E  E8                inx
  826  35:B01F  60                rts
  827  35:B020            .bounds:
  828  35:B020  01 46 4A          .db     $01,$46,$4a,$4f,$58,$65
       35:B023  4F 58 65  
  829                     ;==========================================================================================================
  830                     ;original:$b2a7
  831                     ;scrolling functions
  832                     ;       [in,out] u8 $65 : background no
  833                     ;       [in,out] u8 $66 : left(colIndex,0-7)
  834                     ;       [in] u8 $69 : col index of 1st selection (if avail)
  835                     ;       [in] u8 $67 : mode
  836                     ;       .ORG $b2a7
  837           0078      itemWindowScrollX       = 120
  838           0028      itemWindowDx            = 120/3 ;orig : $14
  839  35:B026            itemWindow_scrollRight
  840  35:B026  A5 66             lda <windowLeft
  841  35:B028  C9 06             cmp #6
  842  35:B02A  B0 0F             bcs .do_scroll
  843  35:B02C  69 02                     adc #2
  844  35:B02E  48                        pha
  845  35:B02F  C9 07                     cmp #7
  846  35:B031  90 03                     bcc .draw_next_column
  847  35:B033  20 0B 8F                          jsr eraseFromLeftBottom0Bx0A    ;//$34:8f0b
  848  35:B036            .draw_next_column:      
  849  35:B036  68                        pla
  850  35:B037  AA                        tax
  851  35:B038  20 80 B0                  jsr drawItemWindowColumn
  852  35:B03B            .do_scroll:
  853  35:B03B  A5 66             lda <windowLeft
  854  35:B03D  C9 07             cmp #7
  855  35:B03F  F0 09             beq .update_cursor
  856  35:B041  E6 66                     inc <windowLeft
  857  35:B043  A9 78                     lda #itemWindowScrollX
  858  35:B045  A0 28                     ldy #itemWindowDx
  859  35:B047  20 BB B0                  jsr scrollItemWindow
  860  35:B04A            .update_cursor:
  861  35:B04A  A5 67             lda <mode
  862  35:B04C  F0 03             beq .return
  863  35:B04E  20 E5 B0                  jsr update1stCursor
  864  35:B051            .return:
  865  35:B051  60                rts
  866                     ;---------------------------------------------------------------------------------------------------------      
  867                     ;original:$b362
  868                     ;       .ORG $b362
  869  35:B052            itemWindow_scrollLeft:
  870                     ;       [in,out] u8 $65 : background no
  871                     ;       [in,out] u8 $66 : left(colIndex,0-7)
  872                     ;       [in] u8 $69 : col index of 1st selection (if avail)
  873                     ;       [in] u8 $67 : mode
  874  35:B052  A5 66             lda <windowLeft
  875  35:B054  C9 02             cmp #2
  876  35:B056  90 13             bcc .do_scroll
  877  35:B058  D0 0B             bne .draw_next_column
  878  35:B05A  A9 00                     lda #0
  879  35:B05C  8D 73 75                  sta $7573
  880  35:B05F  20 1F B1                  jsr drawEquipWindow
  881  35:B062  4C 6B B0                  jmp .do_scroll
  882  35:B065            .draw_next_column:      
  883                                     ;always sec
  884  35:B065  E9 03                     sbc #3
  885  35:B067  AA                        tax
  886  35:B068  20 80 B0                  jsr drawItemWindowColumn
  887  35:B06B            .do_scroll:
  888  35:B06B  A5 66             lda <windowLeft
  889  35:B06D  F0 09             beq .update_cursor
  890  35:B06F  C6 66                     dec <windowLeft
  891  35:B071  A9 88                     lda #-itemWindowScrollX
  892  35:B073  A0 D8                     ldy #-itemWindowDx
  893  35:B075  20 BB B0                  jsr scrollItemWindow
  894  35:B078            .update_cursor:
  895  35:B078  A5 67             lda <mode
  896  35:B07A  F0 03             beq .return
  897  35:B07C  20 E5 B0                  jsr update1stCursor
  898  35:B07F            .return:
  899  35:B07F  60                rts                             
  900                     ;---------------------------------------------------------------------------------------------------------
  901  35:B080            drawItemWindowColumn:
  902                     ;       [in] x : colIndex (equip=-1)
  903           0018      .left = $18
  904           0019      .right = $19
  905           001A      .drawFlag = $1a
  906           003D      .firstItemOffset = $3d
  907                     ;.windowPos = $b636
  908  35:B080  8A                txa
  909  35:B081  0A                asl a
  910  35:B082  48                pha
  911  35:B083  0A                asl a
  912  35:B084  0A                asl a
  913  35:B085  85 3D             sta <.firstItemOffset
  914  35:B087  20 82 B1          jsr loadTileArrayForItemWindowColumn    ;$34:b48b
  915  35:B08A  68                pla
  916  35:B08B  AA                tax
  917  35:B08C  F0 08             beq .left_required
  918                     ;check right
  919  35:B08E  E0 0E             cpx #14 ;7*2
  920  35:B090  F0 08             beq .right_required
  921  35:B092  A9 00             lda #0
  922  35:B094  F0 06             beq .store_flag
  923  35:B096            .left_required:
  924  35:B096  A9 01             lda #1
  925  35:B098  D0 02             bne .store_flag
  926  35:B09A            .right_required:        
  927  35:B09A  A9 02             lda #2
  928  35:B09C            .store_flag
  929  35:B09C  85 1A             sta <.drawFlag          
  930  35:B09E  BD AB B0          lda .windowPos,x
  931  35:B0A1  85 18             sta <.left
  932  35:B0A3  BD AC B0          lda .windowPos+1,x
  933  35:B0A6  85 19             sta <.right
  934                             
  935  35:B0A8  4C 38 8B          jmp draw8LineWindow     ;$8b38
  936  35:B0AB            .windowPos:
  937  35:B0AB  10 1E             .db     $10,$1E
  938  35:B0AD  1F 8D             .db     $1F,$8D
  939  35:B0AF  8E 9C             .db     $8E,$9C
  940  35:B0B1  9D 0B             .db $9D,$0B
  941  35:B0B3  0C 1A             .db $0C,$1A
  942  35:B0B5  1B 89             .db $1B,$89
  943  35:B0B7  8A 98             .db $8A,$98
  944  35:B0B9  99 07             .db $99,$07     
  945                     ;---------------------------------------------------------------------------------------------------------      
  946  35:B0BB            scrollItemWindow:
  947                     ;       [in] s8 a : scrollX
  948                     ;       [in] s8 y : dx
  949           0064      .scrollTo = $64
  950           0065      .invert = $65
  951                     ;.windowLeft = $66
  952           0008      .ppuFlag1 = $08
  953           0010      .currentX = $10
  954  35:B0BB  AA                tax
  955  35:B0BC  30 04             bmi .scroll_left
  956  35:B0BE  A9 00             lda #%00000000
  957  35:B0C0  F0 02             beq .store_invert
  958  35:B0C2            .scroll_left:
  959  35:B0C2  A9 01             lda #%00000001
  960  35:B0C4            .store_invert:
  961  35:B0C4  85 65             sta <.invert
  962  35:B0C6  8A                txa
  963  35:B0C7  18                clc
  964  35:B0C8  65 10             adc <.currentX
  965  35:B0CA  85 64             sta <.scrollTo
  966  35:B0CC            .scroll_loop:
  967  35:B0CC  20 C5 F8                  jsr updateDmaPpuScrollSyncNmi   ;$3f:f8c5 (y is unchanged)
  968  35:B0CF  98                        tya
  969  35:B0D0  18                        clc
  970  35:B0D1  65 10                     adc <.currentX
  971  35:B0D3  85 10                     sta <.currentX
  972  35:B0D5  2A                        rol     a       ;take carry
  973  35:B0D6  29 01                     and #1  ;mask
  974  35:B0D8  45 65                     eor <.invert    ;invert if scroll to left
  975                                     ;a = 01 if overflow
  976  35:B0DA  45 08                     eor <.ppuFlag1
  977  35:B0DC  85 08                     sta <.ppuFlag1
  978  35:B0DE  A5 10                     lda <.currentX
  979  35:B0E0  C5 64                     cmp <.scrollTo
  980  35:B0E2  D0 E8             bne .scroll_loop
  981  35:B0E4  60                rts
  982                     ;---------------------------------------------------------------------------------------------------------
  983  35:B0E5            update1stCursor:
  984                             ;if (lastCol == left || lastCol == left + 1)
  985  35:B0E5  A6 66             ldx <windowLeft
  986  35:B0E7  E4 69             cpx <lastCol
  987  35:B0E9  F0 09             beq .move_cursor
  988  35:B0EB  E8                inx
  989  35:B0EC  E4 69             cpx <lastCol
  990  35:B0EE  D0 18             bne .hide_cursor
  991  35:B0F0  A9 84             lda #$84
  992  35:B0F2  D0 02             bne .store_x
  993  35:B0F4            .move_cursor:
  994  35:B0F4  A9 0C             lda #$0c
  995  35:B0F6            .store_x:       
  996  35:B0F6  85 1D             sta <$1d        ;#$84 or #0c
  997  35:B0F8  A5 68             lda <lastRow
  998  35:B0FA  20 3E FD          jsr $fd3e       ;asl * 4
  999  35:B0FD  69 A8             adc #$a8
 1000  35:B0FF  85 1C             sta <$1c
 1001  35:B101  A9 01             lda #1
 1002  35:B103  85 1A             sta <$1a
 1003  35:B105  4C 2E 89          jmp tileSprites2x2
 1004                             ;jsr tileSprites2x2
 1005                             ;rts
 1006  35:B108            .hide_cursor:   
 1007  35:B108  A5 1C             lda <$1c
 1008  35:B10A  48                pha
 1009  35:B10B  A9 F0             lda #$f0
 1010  35:B10D  85 1C             sta <$1c
 1011  35:B10F  A9 01             lda #1
 1012  35:B111  85 1A             sta <$1a
 1013  35:B113  20 2E 89          jsr tileSprites2x2
 1014  35:B116  68                pla
 1015  35:B117  85 1C             sta <$1c
 1016  35:B119  60                rts     
 1017                     ;$b419:
 1018                     ;==========================================================================================================
 1019                     ;$35:b5f9 drawEquipWindowNoErase
 1020  35:B11A            drawEquipWindowNoErase:
 1021           7573      .eraseFlag = $7573      
 1022  35:B11A  A9 FF             lda #$ff
 1023  35:B11C  8D 73 75          sta .eraseFlag
 1024                             ;jmp drawEquipWindow
 1025                     ;==========================================================================================================
 1026                     ;$35:b419 drawEquipWindow
 1027                     ;       [in] u16 $59 : ptrToEquips ($6200)
 1028                     ;       [in] bool $7573 : eraseFlag 
 1029  35:B11F            drawEquipWindow:
 1030           0034      .items = $34
 1031  35:B11F  A2 07             ldx #7
 1032  35:B121            .initloop:
 1033  35:B121  A9 01                     lda #1
 1034  35:B123  9D 00 74                  sta $7400,x
 1035  35:B126  A9 FF                     lda #$ff
 1036  35:B128  95 34                     sta <.items,x
 1037  35:B12A  CA                        dex
 1038  35:B12B  10 F4                     bpl .initloop
 1039  35:B12D  20 41 A5          jsr getPlayerOffset
 1040  35:B130  69 03             adc #3
 1041  35:B132  A8                tay     
 1042                     
 1043  35:B133  B1 59             lda [pEquips],y
 1044  35:B135  85 36             sta <.items+2
 1045  35:B137  C8                iny
 1046  35:B138  B1 59             lda [pEquips],y
 1047  35:B13A  85 37             sta <.items+3
 1048  35:B13C  C8                iny
 1049  35:B13D  B1 59             lda [pEquips],y
 1050  35:B13F  85 3A             sta <.items+6
 1051  35:B141  C8                iny
 1052  35:B142  B1 59             lda [pEquips],y
 1053  35:B144  85 3B             sta <.items+7
 1054                     
 1055  35:B146  20 91 AF          jsr loadTileArrayOfItemProps
 1056                     
 1057  35:B149  A0 08             ldy #8
 1058  35:B14B            .putText:
 1059  35:B14B  BE 70 B1                  ldx .putOffsets,y
 1060                                     ;tax
 1061  35:B14E  B9 79 B1                  lda .text,y
 1062  35:B151  9D 20 72                  sta TILE_ARRAY_BASE,x
 1063  35:B154  88                        dey
 1064  35:B155  10 F4                     bpl .putText
 1065                     
 1066  35:B157  AD 73 75          lda $7573
 1067  35:B15A  C9 FF             cmp #$ff
 1068  35:B15C  F0 03             beq .draw
 1069  35:B15E  20 0B 8F                  jsr eraseFromLeftBottom0Bx0A
 1070  35:B161            .draw:  
 1071  35:B161  A9 01             lda #1
 1072  35:B163  85 18             sta <$18        ;left
 1073  35:B165  A9 0F             lda #$0f
 1074  35:B167  85 19             sta <$19        ;right
 1075  35:B169  A9 03             lda #$03
 1076  35:B16B  85 1A             sta <$1a
 1077  35:B16D  4C 38 8B          jmp draw8LineWindow
 1078  35:B170            .putOffsets:
 1079  35:B170  01 35 0F          .db $01,$35,$0f,$44,$0d,$0e,$41,$42,$43
       35:B173  44 0D 0E  
       35:B176  41 42 43  
 1080  35:B179            .text:
 1081  35:B179  C0 C0 9C          .db $c0,$c0,$9c,$9c,$a9,$90,$a4,$99,$b1
       35:B17C  9C A9 90  
       35:B17F  A4 99 B1  
 1082                             ;b184
 1083                     ;$b48b
 1084                     ;==========================================================================================================
 1085                     ;$35:b48b loadTileArrayForItemWindowColumn()
 1086                     ;       [in,out] u8 $3d : firstItemOffset, incremented by 8 per call
 1087  35:B182            loadTileArrayForItemWindowColumn:
 1088           003D      .firstItem = $3d
 1089           0034      .items = $34
 1090  35:B182  A9 07             lda #7
 1091  35:B184  AA                tax
 1092  35:B185  18                clc
 1093  35:B186  65 3D             adc <.firstItem
 1094  35:B188  A8                tay
 1095  35:B189            .init_loop:
 1096  35:B189  A9 01                     lda #1
 1097  35:B18B  9D 00 74                  sta $7400,x
 1098  35:B18E  B9 C0 60                  lda $60c0,y
 1099  35:B191  9D 34 00                  sta .items,x
 1100  35:B194  88                        dey
 1101  35:B195  CA                        dex
 1102  35:B196  10 F1                     bpl .init_loop
 1103                             
 1104  35:B198  E8                inx     ;x => 0
 1105  35:B199  A5 3D             lda <.firstItem
 1106  35:B19B  4A                lsr a
 1107  35:B19C  A8                tay
 1108  35:B19D            .replace_loop:
 1109  35:B19D  BD 34 00                  lda .items,x
 1110  35:B1A0  D0 05                     bne .check_flag
 1111  35:B1A2  A9 57                             lda #$57        ;bare fist
 1112  35:B1A4  9D 34 00                          sta .items,x
 1113  35:B1A7                    .check_flag:
 1114  35:B1A7  B9 41 7B                  lda $7b41,y
 1115  35:B1AA  D0 03                     bne .next
 1116  35:B1AC  DE 00 74                          dec $7400,x
 1117  35:B1AF                    .next:
 1118  35:B1AF  C8                        iny
 1119  35:B1B0  E8                        inx
 1120  35:B1B1  E8                        inx
 1121  35:B1B2  E0 08                     cpx #8
 1122  35:B1B4  D0 E7                     bne .replace_loop
 1123                             
 1124  35:B1B6  18                clc
 1125  35:B1B7  A5 3D             lda <.firstItem
 1126  35:B1B9  69 08             adc #8
 1127  35:B1BB  85 3D             sta <.firstItem
 1128  35:B1BD  A8                tay
 1129  35:B1BE  4C 91 AF          jmp loadTileArrayOfItemProps
 1130                     ;$b4d4:
 1131                     ;==========================================================================================================
 1132                     ;$35:b4d4 itemWindow_moveCursor
 1133  35:B1C1            itemWindow_moveCursor:
 1134  35:B1C1  A5 62             lda <row
 1135  35:B1C3  20 3E FD          jsr $fd3e       ;a <<= 4
 1136  35:B1C6  69 A8             adc #$a8
 1137  35:B1C8  85 1C             sta <$1c
 1138  35:B1CA  A9 08             lda #8
 1139  35:B1CC  A6 63             ldx <col
 1140  35:B1CE  E4 66             cpx <windowLeft
 1141  35:B1D0  F0 02             beq .store_x
 1142  35:B1D2  A9 80                     lda #$80
 1143  35:B1D4            .store_x:
 1144  35:B1D4  85 1D             sta <$1d
 1145  35:B1D6  A9 00             lda #0
 1146  35:B1D8  85 1A             sta <$1a
 1147  35:B1DA  4C 2E 89          jmp tileSprites2x2
 1148                     ;==========================================================================================================
 1149                     ;$b4f7  
 1150                     ;       .ORG $b4f7
 1151  35:B1DD            itemWindow_OnUse:
 1152           0026      .index = $26
 1153           0027      .itemId = $27
 1154           7478      .itemParams = $7478
 1155  35:B1DD  A5 63             lda <col
 1156  35:B1DF  0A                asl a
 1157  35:B1E0  0A                asl a
 1158  35:B1E1  18                clc
 1159  35:B1E2  65 62             adc <row
 1160  35:B1E4  85 26             sta <.index
 1161  35:B1E6  AA                tax
 1162  35:B1E7  BD 3D 7B          lda equipFlags,x
 1163  35:B1EA  F0 09             beq .fail
 1164  35:B1EC  06 26             asl <.index
 1165  35:B1EE  A6 26             ldx <.index
 1166  35:B1F0  BD F5 7A          lda cachedItems,x
 1167  35:B1F3  D0 0D             bne .use_ok
 1168  35:B1F5            .fail:  
 1169  35:B1F5  20 9B 9B                  jsr setYtoOffset2E      ;$9b9b
 1170  35:B1F8  A9 00                     lda #0
 1171  35:B1FA  91 5B                     sta [pPlayer],y
 1172  35:B1FC  20 81 9B                  jsr requestSoundEffect06        ;9b81
 1173  35:B1FF  4C AA AC                  jmp itemWindowInputLoop
 1174  35:B202            .use_ok:
 1175  35:B202  85 27             sta <.itemId            
 1176  35:B204  AA                tax
 1177  35:B205  20 7D 9B          jsr requestSoundEffect05        ;9b7d
 1178  35:B208  20 9B 9B          jsr setYtoOffset2E      ;$9b9b
 1179  35:B20B  8A                txa
 1180  35:B20C  91 5B             sta [pPlayer],y
 1181  35:B20E  C9 A6             cmp #$a6
 1182  35:B210  90 09             bcc .not_heal
 1183  35:B212  C9 A9             cmp #$a9
 1184  35:B214  B0 05             bcs .not_heal
 1185  35:B216  A9 FF             lda #$ff
 1186  35:B218  8D E8 7C          sta $7ce8
 1187  35:B21B            .not_heal:      
 1188  35:B21B  88                dey
 1189  35:B21C  88                dey
 1190  35:B21D  A9 08             lda #8
 1191  35:B21F  11 5B             ora [pPlayer],y
 1192  35:B221  91 5B             sta [pPlayer],y
 1193                             ;here x = id
 1194                             ;[00-56] ok
 1195                             ;[57-97]
 1196                             ;[98-c7] ok
 1197                             ;[c8-ff]
 1198  35:B223  E0 57             cpx #$57
 1199  35:B225  90 2E             bcc .use_equip
 1200  35:B227  E0 98             cpx #$98
 1201  35:B229  90 CA             bcc .fail
 1202  35:B22B  E0 C8             cpx #$c8
 1203  35:B22D  B0 C6             bcs .fail
 1204                             ;[98-c7] $b564:
 1205  35:B22F  AD 00 74                  lda $7400
 1206  35:B232  48                        pha
 1207  35:B233  8A                        txa     ;id
 1208                                     ;clc here always clear
 1209  35:B234  69 08                     adc #8          ;$46 = #$91a0 + (a - #$98)
 1210  35:B236  85 46                     sta <$46
 1211  35:B238  A9 00                     lda #0
 1212  35:B23A  69 91                     adc #$91
 1213  35:B23C  85 47                     sta <$47
 1214  35:B23E  A9 01                     lda #1
 1215  35:B240  85 4B                     sta <$4b
 1216  35:B242  A9 1A                     lda #$1a
 1217  35:B244  85 4A                     sta <$4a
 1218  35:B246  A9 17                     lda #$17
 1219  35:B248  20 DC FD                  jsr $fddc       ;copyTo7400(bank:a = #17 base:$46 = #91a0 + (a - #98), size:$4b = 1, restore:$4a = #1a):        ;$fd
 1220  35:B24B  AC 00 74                  ldy $7400
 1221  35:B24E  68                        pla
 1222  35:B24F  8D 00 74                  sta $7400
 1223  35:B252  18                        clc
 1224  35:B253  90 17                     bcc .check_flag
 1225  35:B255            .use_equip:             
 1226                             ;itemid:[00-56]
 1227  35:B255  8A                        txa     ;id
 1228  35:B256  85 18                     sta <$18
 1229  35:B258  A9 08                     lda #8
 1230  35:B25A  85 1A                     sta <$1a
 1231  35:B25C  A9 00                     lda #$00
 1232  35:B25E  85 20                     sta <$20
 1233  35:B260  A9 94                     lda #$94
 1234  35:B262  85 21                     sta <$21
 1235  35:B264  A2 78                     ldx #$78
 1236  35:B266  20 3A BA                  jsr $ba3a       ;loadTo7400FromBank30(index:$18 = a,size:$1a = 8,base:$20 = #9400,dest:x = #78);        ;$ba3a
 1237                                     
 1238  35:B269  AC 7C 74                  ldy .itemParams+4 ;$747c
 1239  35:B26C            .check_flag
 1240                             ;here y: effect type? $b58b
 1241                             ;ldx <.index
 1242                             ;lda equipFlags,x
 1243                             ;beq .fail
 1244  35:B26C  C0 7F             cpy #$7f
 1245  35:B26E  D0 07             bne .load_param
 1246  35:B270  A9 09                     lda #9
 1247  35:B272  8D 7D 74                  sta .itemParams+5
 1248  35:B275  D0 13                     bne .select_target
 1249  35:B277            .load_param:
 1250  35:B277  84 18                     sty <$18
 1251  35:B279  A9 08                     lda #8
 1252  35:B27B  85 1A                     sta <$1a
 1253  35:B27D  A9 C0                     lda #$c0
 1254  35:B27F  85 20                     sta <$20
 1255  35:B281  A9 98                     lda #$98
 1256  35:B283  85 21                     sta <$21
 1257  35:B285  A2 78                     ldx #$78
 1258  35:B287  20 3A BA                  jsr $ba3a
 1259  35:B28A            .select_target:
 1260  35:B28A  20 79 B9          jsr $b979 ;     ;対象選択? (2 == cancel)
 1261  35:B28D  C9 02             cmp #2
 1262  35:B28F  D0 03             bne .consume
 1263                                     ;dec <iPlayer
 1264                                     ;jmp closeItemWindow
 1265  35:B291  4C C2 AE                  jmp itemWindow_closeAndKeepCurrentPlayer
 1266  35:B294            .consume:
 1267  35:B294  A9 3F             lda #$3f
 1268  35:B296  20 88 9B          jsr $9b88
 1269  35:B299  A5 27             lda <.itemId
 1270  35:B29B  91 5B             sta [pPlayer],y
 1271  35:B29D  A5 63             lda <col
 1272  35:B29F  D0 05             bne .not_equip
 1273  35:B2A1  88                        dey
 1274  35:B2A2  A9 01                     lda #1
 1275  35:B2A4  91 5B                     sta [pPlayer],y
 1276  35:B2A6            .not_equip:
 1277  35:B2A6  A6 26             ldx <.index
 1278  35:B2A8  E8                inx
 1279  35:B2A9  DE F5 7A          dec cachedItems,x
 1280  35:B2AC  BD F5 7A          lda cachedItems,x
 1281  35:B2AF  D0 04             bne .copyback
 1282                                     ;as cosumed,item count reached 0.so clear id
 1283  35:B2B1  CA                        dex
 1284  35:B2B2  9D F5 7A                  sta cachedItems,x
 1285  35:B2B5            .copyback:              
 1286  35:B2B5  A2 3F             ldx #$3f
 1287  35:B2B7            .copyloop:      
 1288  35:B2B7  BD FD 7A                  lda cachedItems+8,x
 1289  35:B2BA  9D C0 60                  sta backpackItems,x
 1290  35:B2BD  CA                        dex
 1291  35:B2BE  10 F7                     bpl .copyloop
 1292  35:B2C0  4C C4 AE          jmp closeItemWindow
 1293                     ;==========================================================================================================
 1294                     ;$b601
 1295                     ;$35:b601 redrawColumn
 1296                     ;//     [in] u8 x : col
 1297                     ;==========================================================================================================
 1298                     ;$b636
 1299  35:B2C3            ff3_itemWindow_end:
 1300           06EE      ff3_itemWindow_size = ff3_itemWindow_end - ff3_itemWindow_begin
 1301                     
#[3]   ff3_hack_master.asm
#[4]   ff3_magic_window.asm
   48                                     .include "ff3_magic_window.asm" ;save
    1                     ; ff3_magic_window.asm
    2                     ;
    3                     ;description:
    4                     ;       replaces magic-selection-window 
    5                     ;
    6                     ;version:
    7                     ;       0.06 (2006-10-29)
    8                     ;
    9                     ;======================================================================================================
   10  35:B2C3            ff3_magic_window_begin:
   11                     ;------------------------------------------------------------------------------------------------------
   12                             INIT_PATCH $35,$b646,$b979
                0035              .bank   $35
                B646              .org    $b646
       35:B646                    .ds             (($b979) - ($b646))
                B646              .org    $b646
   13           B2C3              .org ff3_magic_window_begin
   14                     ;------------------------------------------------------------------------------------------------------
   15                     ;commandWindow_OnMagicSelected:
   16  35:B2C3            commandWindow_OnMagic:
   17           0057      .pPlayerBaseParam = $57 ;[in]
   18           0059      .pPlayerEquips = $59    ;[in]
   19           005B      .pPlayer = $5b                  ;[in]
   20           0018      .magicIdOffset = $18
   21           0024      .magicSlot = $24
   22           0026      .magicIndex = $26
   23           0027      .currentMagicLv = $27
   24           0046      .maxMagicLv = $46
   25                     ;---------------------------------------
   26  35:B2C3  2C D8 7E          bit $7ed8       ;status_2?
   27  35:B2C6  50 06             bvc     .castable       ;bit6 is clear
   28  35:B2C8  20 81 9B                  jsr requestSoundEffect06
   29  35:B2CB  A9 01                     lda #1
   30                                     RET_TO_GET_COMMAND_INPUT
       35:B2CD  60                rts
   31                                     ;jmp getCommandInput_next
   32  35:B2CE            .castable:              
   33  35:B2CE  A2 17             ldx #$17
   34  35:B2D0  A9 FF             lda #$ff
   35  35:B2D2            .init_7400:
   36  35:B2D2  9D 00 74                  sta $7400,x
   37  35:B2D5  CA                        dex
   38  35:B2D6  10 FA                     bpl .init_7400
   39  35:B2D8  A9 3F             lda #$3f
   40  35:B2DA  20 88 9B          jsr setYtoOffsetOf
   41  35:B2DD  A2 07             ldx #7
   42  35:B2DF            .find_max_lv:   
   43  35:B2DF  B1 57                     lda [.pPlayerBaseParam],y
   44  35:B2E1  D0 05                     bne .found_lv
   45  35:B2E3  CA                        dex
   46  35:B2E4  88                        dey
   47  35:B2E5  88                        dey
   48  35:B2E6  D0 F7                     bne .find_max_lv        ;y shouldn't be 0
   49  35:B2E8            .found_lv:              
   50  35:B2E8  86 27             stx <.currentMagicLv
   51  35:B2EA  86 46             stx <.maxMagicLv
   52                             ;txa
   53                             ;pha
   54  35:B2EC  A9 07             lda #7
   55  35:B2EE  38                sec
   56  35:B2EF  E5 27             sbc <.currentMagicLv
   57                             ;$18 = (7- currentMagicLv)*7
   58  35:B2F1  85 18             sta <.magicIdOffset
   59  35:B2F3  0A                asl a
   60  35:B2F4  0A                asl a
   61  35:B2F5  0A                asl a
   62  35:B2F6  38                sec
   63  35:B2F7  E5 18             sbc <.magicIdOffset
   64  35:B2F9  85 18             sta <.magicIdOffset
   65  35:B2FB  A9 00             lda #0
   66  35:B2FD  85 26             sta <.magicIndex
   67  35:B2FF            .getMagicIds:
   68  35:B2FF  85 24                     sta <.magicSlot
   69  35:B301  48                        pha     ;magicslot
   70  35:B302  A9 07                     lda #7
   71  35:B304  AA                        tax     ;x:index
   72  35:B305  18                        clc
   73  35:B306  65 27                     adc <.currentMagicLv
   74  35:B308  20 88 9B                  jsr setYtoOffsetOf
   75  35:B30B  B1 59                     lda [.pPlayerEquips],y
   76  35:B30D                    .find_equipped_magic:   ;$b69e
   77  35:B30D  4A                                lsr a
   78  35:B30E  90 0B                             bcc .find_equipped_next
   79  35:B310  48                                        pha
   80  35:B311  A4 24                                     ldy <.magicSlot
   81  35:B313  A5 18                                     lda <.magicIdOffset
   82  35:B315  99 00 74                                  sta $7400,y
   83  35:B318  E6 24                                     inc <.magicSlot
   84  35:B31A  68                                        pla
   85  35:B31B                            .find_equipped_next:
   86  35:B31B  E6 18                             inc <.magicIdOffset
   87  35:B31D  CA                                dex
   88  35:B31E  D0 ED                             bne .find_equipped_magic
   89  35:B320  68                        pla     ;magicslot
   90  35:B321  18                        clc
   91  35:B322  69 03                     adc #3
   92  35:B324  C6 27                     dec <.currentMagicLv
   93  35:B326  A6 27                     ldx <.currentMagicLv
   94  35:B328  10 D5                     bpl .getMagicIds
   95                     ;$b6cc:
   96           0024      .magicLv = $24
   97  35:B32A  20 54 97          jsr initTileArrayStorage        ;$9754
   98  35:B32D  A6 46             ldx <.maxMagicLv
   99  35:B32F  86 24             stx <.magicLv
  100                     ;$b6dc:
  101  35:B331            .loadMagicNames:
  102           0027      .dest = $27
  103  35:B331  A2 1C                     ldx #$1c
  104  35:B333  20 49 A5                  jsr initString  ;a549
  105  35:B336  A9 08                     lda #8
  106  35:B338  85 27                     sta <.dest
  107  35:B33A  A9 81                     lda #$81        ;'1'
  108  35:B33C  18                        clc
  109  35:B33D  65 24                     adc <.magicLv
  110  35:B33F  8D D7 7A                  sta stringCache+0
  111  35:B342  A9 C7                     lda #$c7
  112  35:B344  8D DB 7A                  sta stringCache+4
  113  35:B347  A9 07                     lda #7
  114                                     ;clc always clear
  115  35:B349  65 24                     adc <.magicLv
  116  35:B34B  20 88 9B                  jsr setYtoOffsetOf      ;9b88
  117  35:B34E  B1 5B                     lda [pPlayer],y ;currentMp
  118  35:B350  20 25 A6                  jsr itoa_8
  119  35:B353  A5 1B                     lda <$1b
  120  35:B355  8D D9 7A                  sta stringCache+2
  121  35:B358  A5 1C                     lda <$1c
  122  35:B35A  8D DA 7A                  sta stringCache+3
  123                                     ;
  124  35:B35D  A5 24                     lda <.magicLv
  125  35:B35F  0A                        asl a
  126                                     ;clc always cleared (0 <= magicLv < 8)
  127  35:B360  69 31                     adc #$31
  128  35:B362  20 88 9B                  jsr setYtoOffsetOf      ;9b88
  129  35:B365  B1 57                     lda [.pPlayerBaseParam],y       ;maxMp
  130  35:B367  20 25 A6                  jsr itoa_8
  131  35:B36A  A5 1B                     lda <$1b
  132  35:B36C  8D DC 7A                  sta stringCache+5
  133  35:B36F  A5 1C                     lda <$1c
  134  35:B371  8D DD 7A                  sta stringCache+6
  135                     ;$b734
  136  35:B374  A9 03                     lda #3
  137  35:B376                    .loadMagicNamesOfCurrentLv:
  138  35:B376  48                                pha     ;index (means slot)
  139  35:B377  A6 26                             ldx <.magicIndex
  140  35:B379  BD 00 74                          lda $7400,x
  141  35:B37C  C9 FF                             cmp #$ff        ;empty
  142  35:B37E  F0 2F                             beq .load_next
  143                     ;$b73f:
  144  35:B380  85 18                                     sta <$18
  145  35:B382  48                                        pha     ;magic id
  146                                                     INIT16 <$20,$98c0
       35:B383  A9 C0             lda #LOW($98c0)
       35:B385  85 20             sta <$20
       35:B387  A9 98             lda #HIGH($98c0)
       35:B389  85 21             sta <$20+1
  147  35:B38B  20 F9 B4                                  jsr isPlayerAllowedToUseItem    ;$b8fd
  148  35:B38E  A5 1C                                     lda <$1c
  149  35:B390  D0 0E                                     bne .load_name
  150  35:B392  A6 27                                             ldx <.dest
  151  35:B394  A9 73                                             lda #$73        ;'x'
  152  35:B396  9D D7 7A                                          sta stringCache,x
  153  35:B399  A6 26                                             ldx <.magicIndex
  154  35:B39B  A9 FF                                             lda #$ff
  155  35:B39D  9D 00 74                                          sta $7400,x
  156  35:B3A0                                    .load_name:
  157  35:B3A0  A6 27                                     ldx <.dest
  158  35:B3A2  E8                                        inx
  159                                                     INIT16 <$18,$8990
       35:B3A3  A9 90             lda #LOW($8990)
       35:B3A5  85 18             sta <$18
       35:B3A7  A9 89             lda #HIGH($8990)
       35:B3A9  85 19             sta <$18+1
  160  35:B3AB  68                                        pla     ;magic id
  161  35:B3AC  20 09 A6                                  jsr loadString  ;a609 loadString(index:a, dest:x, src:$18 )
  162  35:B3AF                            .load_next:
  163  35:B3AF  A5 27                             lda <.dest
  164  35:B3B1  18                                clc
  165  35:B3B2  69 07                             adc #7
  166  35:B3B4  85 27                             sta <.dest
  167  35:B3B6  E6 26                             inc <.magicIndex
  168  35:B3B8  68                                pla     ;index (means slot)
  169                                             ;sec    always clear (dest < 6 * 3)
  170  35:B3B9  E9 00                             sbc #0
  171  35:B3BB  D0 B9                             bne .loadMagicNamesOfCurrentLv
  172                     ;$b77e:
  173  35:B3BD  A9 1C                     lda #$1c
  174  35:B3BF  85 18                     sta <$18
  175  35:B3C1  20 6A 96                  jsr strToTileArray      ;966a
  176  35:B3C4  A9 1C                     lda #$1c
  177  35:B3C6  20 58 A5                  jsr offsetTilePtr
  178  35:B3C9  C6 24                     dec <.magicLv
  179  35:B3CB  A5 24                     lda <.magicLv
  180  35:B3CD  30 03                     bmi .create_window
  181  35:B3CF  4C 31 B3                          jmp .loadMagicNames
  182                     ;$b793:
  183  35:B3D2            .create_window:
  184  35:B3D2  20 B0 8E          jsr eraseWindow
  185  35:B3D5  A9 01             lda #1
  186  35:B3D7  85 18             sta <$18
  187  35:B3D9  85 55             sta <$55        ;cursor id
  188  35:B3DB  A9 1E             lda #$1e
  189  35:B3DD  85 19             sta <$19
  190  35:B3DF  A9 03             lda #$3 ;left|right
  191  35:B3E1  85 1A             sta <$1a
  192  35:B3E3  20 38 8B          jsr draw8LineWindow     ;draw8LineWindow(left = 1, right = #$1e, border = #3); //$34:8b38
  193  35:B3E6  A9 00             lda #0
  194  35:B3E8  85 1A             sta <$1a
  195  35:B3EA  20 66 89          jsr loadCursor  ;8966
  196                     ;---------------------------
  197  35:B3ED            magicWindow_getInput:
  198           001A      .cursorId = $1a
  199           0024      .row = $24
  200           0025      .cursorRow = $25
  201           0026      .col = $26
  202           0046      .rowMax = $46
  203  35:B3ED  A2 00             ldx #0
  204  35:B3EF  86 24             stx <.row
  205  35:B3F1  86 25             stx <.cursorRow
  206  35:B3F3  86 26             stx <.col
  207                     ;$b7b8
  208  35:B3F5            .magicWindow_inputLoop:
  209           BA2A      .magicWindow_inputHandlerTable = $ba2a
  210  35:B3F5  A2 00             ldx #0
  211  35:B3F7  86 38             stx <$38
  212  35:B3F9  86 1A             stx <.cursorId
  213  35:B3FB  A9 02             lda #2
  214  35:B3FD  85 1B             sta <$1b
  215  35:B3FF  20 9E 89          jsr getInputAndUpdateCursorWithSound    ;commandWindow_dispatchInput    ;899e
  216                             INIT16 <$1e, .magicWindow_inputHandlerTable
       35:B402  A9 2A             lda #LOW(.magicWindow_inputHandlerTable)
       35:B404  85 1E             sta <$1e
       35:B406  A9 BA             lda #HIGH(.magicWindow_inputHandlerTable)
       35:B408  85 1F             sta <$1e+1
  217  35:B40A  A5 12             lda <inputBits
  218                     ;getInputAndUpdateCursorWithSound processes input bit from lsb
  219  35:B40C  A6 26             ldx <.col
  220  35:B40E  A4 24             ldy <.row
  221                     
  222  35:B410  4A                lsr a
  223  35:B411  90 03             bcc .not_a
  224  35:B413  4C 8F B4                  jmp .magicWindow_OnA
  225  35:B416            .not_a:
  226  35:B416  4A                lsr a
  227  35:B417  B0 6D             bcs .magicWindow_OnB
  228  35:B419  4A                lsr a   ;sel
  229  35:B41A  4A                lsr a   ;start
  230  35:B41B  4A                lsr a
  231  35:B41C  B0 18             bcs .magicWindow_OnUp
  232  35:B41E  4A                lsr a
  233  35:B41F  B0 31             bcs .magicWindow_OnDown
  234  35:B421  4A                lsr a
  235  35:B422  B0 0B             bcs .magicWindow_OnLeft
  236  35:B424  4A                lsr a
  237                             ;bcs .magicWindow_OnRight
  238  35:B425  90 CE             bcc .magicWindow_inputLoop
  239                     ;------------------------------------------------------------------------------------------------------
  240  35:B427            .magicWindow_OnRight:
  241  35:B427  E0 02             cpx #2
  242  35:B429  F0 CA             beq .magicWindow_inputLoop
  243  35:B42B  E6 26             inc <.col
  244  35:B42D  10 C6             bpl .magicWindow_inputLoop
  245                     ;------------------------------------------------------------------------------------------------------ 
  246  35:B42F            .magicWindow_OnLeft:
  247  35:B42F  8A                txa
  248  35:B430  F0 C3             beq .magicWindow_inputLoop
  249  35:B432  C6 26             dec <.col
  250  35:B434  10 BF             bpl .magicWindow_inputLoop
  251                     ;------------------------------------------------------------------------------------------------------ 
  252  35:B436            .magicWindow_OnUp:
  253  35:B436  98                tya
  254  35:B437  F0 BC             beq .magicWindow_inputLoop
  255  35:B439  C6 24             dec <.row
  256  35:B43B  C6 25             dec <.cursorRow
  257  35:B43D  10 B6             bpl .magicWindow_inputLoop
  258  35:B43F  E6 25             inc <.cursorRow ;keep 0
  259                             SUB16by8 $7ac0,#$38
       35:B441  AD C0 7A          lda $7ac0
       35:B444  38                sec
       35:B445  E9 38             sbc #$38
       35:B447  8D C0 7A          sta $7ac0
       35:B44A  B0 03             bcs .sub16by8_00083
       35:B44C  CE C1 7A                  dec $7ac0+1
       35:B44F                    .sub16by8_00083:
  260  35:B44F  4C 74 B4          jmp .magicWindow_redraw
  261                     ;------------------------------------------------------------------------------------------------------ 
  262  35:B452            .magicWindow_OnDown:    
  263  35:B452  C0 07             cpy #7
  264  35:B454  F0 9F             beq .magicWindow_inputLoop
  265  35:B456  C4 46             cpy <.rowMax
  266  35:B458  F0 9B             beq .magicWindow_inputLoop
  267  35:B45A  E6 24             inc <.row
  268  35:B45C  E6 25             inc <.cursorRow
  269  35:B45E  A5 25             lda <.cursorRow
  270  35:B460  C9 04             cmp #4
  271  35:B462  90 91             bcc .magicWindow_inputLoop
  272  35:B464  C6 25             dec <.cursorRow ;keep 3
  273                             ADD16by8 $7ac0,#$38
       35:B466  AD C0 7A          lda $7ac0
       35:B469  18                clc
       35:B46A  69 38             adc #$38
       35:B46C  8D C0 7A          sta $7ac0
       35:B46F  90 03             bcc .add16by8_00084
       35:B471  EE C1 7A                  inc $7ac0+1
       35:B474                    .add16by8_00084:
  274  35:B474            .magicWindow_redraw:    
  275  35:B474  A9 01             lda #1
  276  35:B476  85 18             sta <$18
  277  35:B478  A9 1E             lda #$1e
  278  35:B47A  85 19             sta <$19
  279  35:B47C  A9 03             lda #3
  280  35:B47E  85 1A             sta <$1a
  281  35:B480  20 38 8B          jsr draw8LineWindow
  282  35:B483  4C F5 B3          jmp .magicWindow_inputLoop
  283                     ;------------------------------------------------------------------------------------------------------
  284  35:B486            .magicWindow_OnB:
  285  35:B486            .magicWindow_close:
  286  35:B486  20 E3 99          jsr clearCursor0
  287  35:B489  20 B0 8E          jsr eraseWindow
  288  35:B48C  A9 00             lda #0  ;redraw
  289                             RET_TO_GET_COMMAND_INPUT
       35:B48E  60                rts
  290                             ;jmp getCommandInput_next
  291                     ;------------------------------------------------------------------------------------------------------ 
  292  35:B48F            .magicWindow_OnA:
  293           7400      .magicIdList = $7400
  294                     ;.col = $26     ;x
  295                     ;.row = $24     ;y
  296           0046      .maxLv = $46
  297           0047      .lv = $47
  298           0052      .iPlayer = $52
  299           005B      .pPlayer = $5b
  300           005F      .playerOffset = $5f
  301  35:B48F  98                tya
  302  35:B490  0A                asl a
  303  35:B491  65 24             adc <.row
  304  35:B493  65 26             adc <.col
  305  35:B495  AA                tax
  306  35:B496  BD 00 74          lda .magicIdList,x
  307  35:B499  C9 FF             cmp #$ff
  308  35:B49B  F0 25             beq .bad_selection
  309                             
  310  35:B49D  48                pha
  311  35:B49E  AD D8 7E          lda $7ed8
  312  35:B4A1  29 10             and #$10
  313  35:B4A3  F0 06             beq .check_mp
  314                             
  315  35:B4A5  68                pla
  316  35:B4A6  C9 2F             cmp #$2f
  317  35:B4A8  F0 18             beq .bad_selection      
  318  35:B4AA  48                pha
  319                             
  320  35:B4AB            .check_mp:
  321  35:B4AB  A5 46             lda <.maxLv
  322  35:B4AD  38                sec
  323  35:B4AE  E5 24             sbc <.row
  324  35:B4B0  85 47             sta <.lv
  325                             ;pha
  326  35:B4B2  A6 52             ldx <.iPlayer
  327  35:B4B4  9D C7 7A          sta $7ac7,x
  328                             ;pla
  329  35:B4B7  18                clc
  330  35:B4B8  69 07             adc #7
  331  35:B4BA  65 5F             adc <.playerOffset      ;offset
  332  35:B4BC  A8                tay
  333  35:B4BD  B1 5B             lda [.pPlayer],y        ;mp
  334  35:B4BF  D0 07             bne .cast_allowed
  335  35:B4C1            .bad_selection_pop:     
  336  35:B4C1  68                        pla     ;magic id
  337  35:B4C2            .bad_selection:
  338  35:B4C2  20 81 9B                  jsr requestSoundEffect06        ;9b81
  339  35:B4C5  4C F5 B3                  jmp .magicWindow_inputLoop
  340                     ;$b8bb
  341  35:B4C8            .cast_allowed:
  342  35:B4C8  20 7D 9B          jsr requestSoundEffect05        ;9b7d
  343  35:B4CB  68                pla
  344  35:B4CC  48                pha
  345  35:B4CD  20 32 B5          jsr getMagicTarget      ;$b953  ;get target?
  346  35:B4D0  AA                tax
  347  35:B4D1  F0 07             beq .store_command
  348  35:B4D3  68                        pla
  349  35:B4D4  E0 01                     cpx #1
  350  35:B4D6  F0 EA                     beq .bad_selection
  351  35:B4D8  D0 AC                     bne .magicWindow_close
  352  35:B4DA            .store_command:
  353  35:B4DA  20 9B 9B          jsr setYtoOffset2E      ;9b9b
  354  35:B4DD  A6 52             ldx <.iPlayer
  355  35:B4DF  68                pla
  356  35:B4E0  18                clc
  357  35:B4E1  69 C8             adc #$c8
  358  35:B4E3  9D CF 78          sta $78cf,x
  359  35:B4E6  91 5B             sta [pPlayer],y
  360  35:B4E8  C9 FF             cmp #$ff
  361  35:B4EA  D0 09             bne .finish
  362  35:B4EC  AD E1 7B                  lda $7be1
  363  35:B4EF  20 20 FD                  jsr flagTargetBit       ;$fd20
  364  35:B4F2  8D E1 7B                  sta $7be1
  365  35:B4F5            .finish:
  366  35:B4F5  E6 52             inc <.iPlayer
  367  35:B4F7  D0 8D             bne .magicWindow_close
  368                     ;======================================================================================================
  369  35:B4F9            ff3_misc_begin:
  370           0035              .bank   $35
  371           B8FD              .org    $b8fd
  372  35:B8FD                    .ds             $b953 - $b8fd
  373                             ;.org   $b8fd
  374           B4F9              .org    ff3_misc_begin
  375  35:B4F9            isPlayerAllowedToUseItem:
  376                     ;       [in] u8 $18 : itemid
  377                     ;       [in] u16 $20 : ? itemDataBase = #$9400
  378                     ;       [out] u8 $1c : allowed (1:ok 0:not)
  379                     ;uses:
  380                     ;       u8 $7478[8] : itemParams
  381           0018      .itemId = $18
  382           0020      .baseAddress = $20
  383           001C      .allowed = $1c
  384           7478      .itemParam = $7478
  385           0038      .userType = $38
  386           003B      .userFlags = $3b
  387           0057      .pPlayerBaseParam = $57
  388  35:B4F9  A9 08             lda #8
  389  35:B4FB  85 1A             sta <$1a
  390  35:B4FD  A2 78             ldx #$78
  391  35:B4FF  20 3A BA          jsr loadTo7400FromBank30        ;$ba3a
  392  35:B502  AD 7F 74          lda .itemParam+7
  393  35:B505  29 7F             and #$7f
  394  35:B507  85 38             sta <.userType
  395  35:B509  0A                asl a
  396                             ;clc always clearted (&7f ed)
  397  35:B50A  65 38             adc <.userType
  398  35:B50C  AA                tax
  399  35:B50D  20 8B FD          jsr $fd8b       ;loadUserFlags
  400  35:B510  20 41 A5          jsr getPlayerOffset     ;$a541
  401  35:B513  A8                tay
  402  35:B514  B1 57             lda [.pPlayerBaseParam],y       ;job
  403                             ;$b93e();
  404  35:B516  48                pha
  405  35:B517  4A                lsr a
  406  35:B518  4A                lsr a
  407  35:B519  4A                lsr a
  408  35:B51A  85 38             sta <$38
  409  35:B51C  A9 02             lda #2
  410  35:B51E  38                sec
  411  35:B51F  E5 38             sbc <$38
  412  35:B521  AA                tax
  413  35:B522  68                pla
  414  35:B523  29 07             and #7
  415  35:B525  A8                tay
  416  35:B526  B5 3B             lda <.userFlags,x
  417  35:B528            .move_flag:     
  418  35:B528  4A                        lsr a
  419  35:B529  88                        dey
  420  35:B52A  10 FC                     bpl .move_flag
  421  35:B52C  2A                rol a
  422  35:B52D  29 01             and #1
  423  35:B52F  85 1C             sta <.allowed
  424  35:B531  60                rts
  425                     ;$b93e:
  426                     ;$b953
  427                     ;======================================================================================================
  428                     ;$35:b953 setMagicTarget
  429  35:B532            getMagicTarget:
  430                     ;[in] a
  431           7478      .magicParams = $7478
  432  35:B532  38                sec     ;??
  433  35:B533  85 18             sta <$18
  434  35:B535  8D E8 7C          sta $7ce8
  435                             INIT16 <$20,$98c0
       35:B538  A9 C0             lda #LOW($98c0)
       35:B53A  85 20             sta <$20
       35:B53C  A9 98             lda #HIGH($98c0)
       35:B53E  85 21             sta <$20+1
  436  35:B540  20 F9 B4          jsr isPlayerAllowedToUseItem    ;b8fd
  437  35:B543  AE 7C 74          ldx .magicParams+4
  438  35:B546  CA                dex
  439  35:B547  D0 04             bne .ok
  440  35:B549  CA                        dex     
  441  35:B54A  8E E8 7C                  stx $7ce8 ;x = $ff
  442  35:B54D            .ok:
  443  35:B54D  A5 1C             lda <$1c
  444  35:B54F  F0 03             beq .finish
  445  35:B551  4C 79 B9                  jmp setActionTargetByParam      ;b979
  446  35:B554            .finish 
  447  35:B554  A9 01             lda #1
  448  35:B556  60                rts
  449                             ;bne $ba29      ;do return
  450                     ;$b979
  451                     ;======================================================================================================
  452  35:B557            ff3_magic_window_free_begin:
  453           B979      ff3_magic_window_free_end = $b979
  454                     ;------------------------------------------------------------------------------------------------------
  455                     ;quickfix
  456           0034              .bank   $34
  457           8064              .org    $8064
  458  34:8064  20 F9 B4          jsr isPlayerAllowedToUseItem
  459                     ;======================================================================================================
  460                             RESTORE_PC ff3_magic_window_free_begin
                0035              .bank   BANK(ff3_magic_window_free_begin)
                B557              .org    ff3_magic_window_free_begin
  461           0294      ff3_magic_window_size = ff3_magic_window_free_begin - ff3_magic_window_begin
#[3]   ff3_hack_master.asm
#[4]   ff3_window.asm
   49                                     .include "ff3_window.asm"               ;consume( origin )
    1                     ; ff3_window.asm
    2                     ;
    3                     ;       replaces window drawing functions
    4                     ;       performs faster than original
    5                     ;       "だるまさんがころんだ"
    6                     ;version:
    7                     ;       0.13 (2006-11-13)
    8                     ;
    9                     ;       $1b,22,23,24,25,26 used in caller (so should be avoided)
   10                     ;
   11                     ;======================================================================================================
   12                     
   13  35:B557            ff3_window_begin:
   14                     
   15                     ;GENCODE_ENABLE_LOOP
   16           0005      UNROLL_SHIFT = 5        ;valid range: 1-5
   17           0020      UNROLL_COUNT = (1 << UNROLL_SHIFT)
   18           0006      SIZEOF_PUT_CODE = 6     ;lda $xxxx, sta $2007
   19           000B      LOOP_OVERHEAD = ((69+14) >> 3) + 1
   20                     ;------------------------------------------------------------------------------------------------------
   21                     ;shared variables:
   22           0018      pLeftParts = $18
   23           001A      pRightParts = $1a
   24           001A      borderDrawFlags = $1a   ; [in] bit0:draw left, bit1:draw right
   25           001C      updateCounter = $1c             ;incremented by updateCount;if it overflows then stops drawing and waits for nmi
   26           001D      clockCount = $1d                ;indicates required cpu cycle count / 8 (approx.) for drawing line
   27           001E      borderPutFlags = $1e    ; [lrLRxxxx] R:put right border in 2ndBG,l: put left border in 1st BG
   28           001F      lineLen = $1f                   ;total line width without border
   29           0020      drawLen = $20                   ;line length for bg currently drawing
   30           002E      vram = $2e
   31           7AC0      pTileArray = $7ac0      ;see also initTileArrayStorage
   32                     ;------------------------------------------------------------------------------------------------------
   33                             INIT_PATCH $34,$8b38,$8d03
                0034              .bank   $34
                8B38              .org    $8b38
       34:8B38                    .ds             (($8d03) - ($8b38))
                8B38              .org    $8b38
   34                     
   35  34:8B38            draw8LineWindow:
   36                     ;args
   37           0018      .left = $18                     ; [in] unit = tiles, bit7 = bg select, border incl
   38           0019      .right = $19            ; [in] unit = tiles, bit7 = bg select, border excl
   39                     ;locals
   40           001C      .maskedLeft = $1c               ;temp
   41           001D      .maskedRight = $1d              ;temp
   42           001E      .crossFlag = $1e                ;temp
   43           78B8      .len_1st = $78b8        ;width without border
   44           78B9      .len_2nd = $78b9        ;width without border
   45           002A      .vram_1st = $2a
   46           002C      .vram_2nd = $2c
   47           0030      .line = $30
   48                     ;---------------------------------------
   49  34:8B38  A5 18             lda <.left
   50                             ;pha
   51  34:8B3A  29 1F             and #$1f
   52  34:8B3C  85 1C             sta <.maskedLeft
   53                             
   54  34:8B3E  A5 19             lda <.right
   55                             ;pha
   56  34:8B40  29 1F             and #$1f
   57  34:8B42  85 1D             sta <.maskedRight
   58                             
   59  34:8B44  A5 18             lda <.left
   60  34:8B46  45 19             eor <.right
   61  34:8B48  30 10             bmi .crosses_boundary
   62                             ;both are in same bg
   63  34:8B4A  A9 C0                     lda #$c0        ;left1st | right1st
   64  34:8B4C  85 1E                     sta <borderPutFlags
   65  34:8B4E  A5 19                     lda <.right
   66  34:8B50  18                        clc     ;to exclude border      
   67  34:8B51  E5 18                     sbc <.left
   68  34:8B53  8D B8 78                  sta .len_1st
   69                                     
   70  34:8B56  A9 00                     lda #0
   71  34:8B58  F0 0E                     beq .store_width
   72  34:8B5A            .crosses_boundary:
   73  34:8B5A  A9 90                     lda #$90        ;left1st | right2nd
   74  34:8B5C  85 1E                     sta <borderPutFlags
   75  34:8B5E  A9 1F                     lda #$1f
   76  34:8B60  38                        sec
   77  34:8B61  E5 1C                     sbc <.maskedLeft
   78  34:8B63  8D B8 78                  sta .len_1st
   79  34:8B66  A5 1D                     lda <.maskedRight
   80  34:8B68            .store_width:           
   81  34:8B68  8D B9 78          sta .len_2nd
   82                     ; --- init 1st bg addr
   83  34:8B6B  18                clc
   84  34:8B6C  A9 60             lda #$60
   85  34:8B6E  85 2C             sta <.vram_2nd          ;2nd bg also have $60 at low byte
   86  34:8B70  65 1C             adc <.maskedLeft
   87  34:8B72  85 2A             sta <.vram_1st
   88  34:8B74  A5 18             lda <.left
   89  34:8B76  30 04             bmi .left_starts_bg1
   90  34:8B78  A9 22                     lda #$22
   91  34:8B7A  D0 02                     bne .store_left_high
   92  34:8B7C            .left_starts_bg1:
   93  34:8B7C  A9 26                     lda #$26
   94  34:8B7E            .store_left_high:
   95  34:8B7E  69 00             adc #0  ;carry still remains
   96  34:8B80  85 2B             sta <.vram_1st+1
   97                     ; --- init 2nd bg addr
   98  34:8B82  A5 19             lda <.right
   99  34:8B84  30 04             bmi .right_ends_bg1
  100  34:8B86  A9 22                     lda #$22
  101  34:8B88  D0 02                     bne .store_right_high
  102  34:8B8A            .right_ends_bg1:
  103  34:8B8A  A9 26                     lda #$26
  104  34:8B8C            .store_right_high:
  105  34:8B8C  85 2D             sta <.vram_2nd+1
  106                     
  107  34:8B8E  20 4A 8C          jsr getBorderParts
  108                     ;here still required vars:
  109                     ;       .vram_1st, .vram_2nd, .len_1st, .len_2nd
  110                     ;       lineLen
  111  34:8B91  AD B8 78          lda .len_1st
  112                     
  113  34:8B94  85 20             sta <drawLen
  114  34:8B96  18                clc
  115  34:8B97  6D B9 78          adc .len_2nd
  116  34:8B9A  85 1F             sta <lineLen
  117                     
  118  34:8B9C  20 57 B5          jsr generateCopyLoopCode
  119  34:8B9F  20 80 FB          jsr waitNmi
  120                     ; --- begin drawing     
  121  34:8BA2  A6 2A             ldx <.vram_1st          ;3
  122  34:8BA4  A5 2B             lda <.vram_1st+1        ;3
  123  34:8BA6  20 36 8C          jsr drawWindow_setVram          ;6+24
  124                             
  125  34:8BA9  AD B8 78          lda .len_1st            ;3
  126  34:8BAC  38                sec                                     ;2
  127  34:8BAD  E5 1F             sbc <lineLen            ;3
  128  34:8BAF  20 D4 8B          jsr .drawOnCurrent      ;6 80
  129                             
  130  34:8BB2  AD B9 78          lda .len_2nd
  131  34:8BB5  D0 01             bne .draw_2nd
  132  34:8BB7  60                        rts
  133  34:8BB8            .draw_2nd:      
  134  34:8BB8  48                        pha     ; len_2nd
  135  34:8BB9  85 20                     sta <drawLen
  136  34:8BBB  06 1E                     asl <borderPutFlags
  137  34:8BBD  06 1E                     asl <borderPutFlags
  138  34:8BBF  20 57 B5                  jsr generateCopyLoopCode
  139                     
  140  34:8BC2  20 80 FB                  jsr waitNmi
  141  34:8BC5  A6 2C                     ldx <.vram_2nd          ;3
  142  34:8BC7  A5 2D                     lda <.vram_2nd+1        ;3
  143  34:8BC9  20 36 8C                  jsr drawWindow_setVram          ;6+52
  144                                     
  145  34:8BCC  68                        pla     ; len_2nd               ;4
  146  34:8BCD  38                        sec                                     ;2
  147  34:8BCE  E5 1F                     sbc <lineLen            ;3
  148  34:8BD0  18                        clc                                     ;2
  149  34:8BD1  6D B8 78                  adc .len_1st            ;4 79
  150                                     ;jmp .drawOnCurrent
  151  34:8BD4            .drawOnCurrent:
  152                     ;[in]   a : initialOffset
  153                     ;.len = $18
  154  34:8BD4  48                pha                                     ;2
  155  34:8BD5  A9 00             lda #0                          ;2      (25>>3)
  156  34:8BD7  85 1C             sta <updateCounter      ;3
  157                             
  158  34:8BD9  A9 F8             lda #$f8        ;topline;2
  159  34:8BDB  A6 20             ldx <drawLen                    ;3
  160  34:8BDD  A0 00             ldy #0                          ;2
  161  34:8BDF  20 F8 8B          jsr putTopBottom        ;6+x
  162  34:8BE2  A2 08             ldx #8                          ;2
  163  34:8BE4  86 30             stx <.line                      ;3
  164                             ;
  165  34:8BE6  68                pla     ;initialOffset  ;4
  166  34:8BE7  A8                tay                                     ;2
  167  34:8BE8            .putLines:
  168                                     ;1loop:69 + genCode
  169  34:8BE8  20 01 79                  jsr genCodeBase ;6
  170                     
  171  34:8BEB  20 1B 8C                  jsr checkUpdateAndOffsetVram;56 = 6+50
  172                                     
  173  34:8BEE  C6 30                     dec <.line              ;4
  174  34:8BF0  D0 F6                     bne .putLines   ;3
  175                     ;------
  176  34:8BF2  A9 FD             lda #$fd        ;bottomline
  177  34:8BF4  A6 20             ldx <drawLen
  178  34:8BF6  A0 06             ldy #6
  179                             ;jmp putTopBottom
  180                     ;------------------------------------------------------------------------------------------------------
  181                     ;helpers
  182  34:8BF8            putTopBottom:
  183                     ;[in] a : centerPartTile
  184                     ;[in] x : len_current
  185                     ;[in] y : top(0) or bottom(6)
  186  34:8BF8  48                pha
  187  34:8BF9  24 1E             bit <borderPutFlags
  188  34:8BFB  10 05             bpl .putCenter  ;bpl: bit7 is clear
  189  34:8BFD  B1 18                     lda [pLeftParts],y
  190  34:8BFF  8D 07 20                  sta $2007
  191  34:8C02            .putCenter:
  192  34:8C02  68                pla
  193  34:8C03  CA                dex
  194  34:8C04  30 06             bmi .put_right
  195  34:8C06            .putCenter_loop:
  196  34:8C06  8D 07 20                  sta $2007
  197  34:8C09  CA                        dex
  198  34:8C0A  10 FA                     bpl .putCenter_loop
  199  34:8C0C            .put_right:             
  200  34:8C0C  24 1E             bit <borderPutFlags
  201  34:8C0E  50 05             bvc .finish                     ;bvc: bit6 is clear
  202  34:8C10  B1 1A                     lda [pRightParts],y
  203  34:8C12  8D 07 20                  sta $2007
  204  34:8C15            .finish:
  205  34:8C15  98                tya     ;0(top) or 6(bottom)
  206  34:8C16  F0 03             beq checkUpdateAndOffsetVram
  207                                     ;we finished drawing. setup scroll values
  208  34:8C18  4C CB F8                  jmp updatePpuScrollNoWait
  209                             ;jmp checkUpdateAndOffsetVram
  210                     ;-----------------------------------------------------------------------------------------------------
  211  34:8C1B            checkUpdateAndOffsetVram:       ;50clk = 24 + 26clk(if update skipped)
  212  34:8C1B  A5 1C             lda <updateCounter      ;3
  213  34:8C1D  18                clc                                     ;2
  214  34:8C1E  65 1D             adc <clockCount         ;3
  215  34:8C20  90 09             bcc .store_counter      ;2+1
  216  34:8C22  20 CB F8                  jsr updatePpuScrollNoWait       ;$f8cb 6+34
  217  34:8C25  20 80 FB                  jsr waitNmi             ;
  218  34:8C28  18                        clc                             ;2
  219  34:8C29  A9 05                     lda #(40>>3)    ;2
  220  34:8C2B            .store_counter:
  221  34:8C2B  85 1C             sta <updateCounter      ;3
  222                     
  223  34:8C2D  A5 2E             lda <vram               ;3
  224                             ;clc                    ;always cleared
  225  34:8C2F  69 20             adc #$20                ;2
  226  34:8C31  AA                tax                             ;2
  227  34:8C32  A5 2F             lda <vram+1             ;3
  228  34:8C34  69 00             adc #0                  ;2
  229                             ;fall through
  230  34:8C36            drawWindow_setVram:             ;24clk = 6+18
  231  34:8C36  85 2F             sta <vram+1
  232  34:8C38  86 2E             stx <vram
  233                             ;fall through
  234  34:8C3A            drawWindow_setVramAddr: ;18clk
  235  34:8C3A  2C 02 20          bit $2002       ;reset flip-flop        ;4
  236  34:8C3D  8D 06 20          sta $2006       ;vram addr high         ;4
  237  34:8C40  8E 06 20          stx $2006       ;vram addr low          ;4
  238  34:8C43            drawWindow_doReturn:
  239  34:8C43  60                rts
  240                     
  241  34:8C44            drawWindow_setVramAndInitPpu:
  242  34:8C44  20 3A 8C          jsr drawWindow_setVramAddr      ;6+12
  243  34:8C47  4C CB F8          jmp updatePpuScrollNoWait       ;3+28
  244                     ;------------------------------------------------------------------------------------------------------
  245  34:8C4A            getBorderParts:
  246  34:8C4A  A5 1A             lda <borderDrawFlags
  247  34:8C4C  48                pha
  248  34:8C4D  A9 68             lda #LOW(.borderParts)
  249  34:8C4F  85 18             sta <pLeftParts
  250  34:8C51  18                clc
  251  34:8C52  69 02             adc #2
  252  34:8C54  85 1A             sta <pRightParts
  253  34:8C56  A9 8C             lda #HIGH(.borderParts)
  254  34:8C58  85 19             sta <pLeftParts+1
  255  34:8C5A  85 1B             sta <pRightParts+1
  256                             
  257  34:8C5C  68                pla
  258  34:8C5D  4A                lsr a
  259  34:8C5E  B0 02             bcs .check_right
  260  34:8C60  E6 18                     inc <pLeftParts ;no border
  261  34:8C62            .check_right:
  262  34:8C62  4A                lsr a
  263  34:8C63  B0 02             bcs .finish
  264  34:8C65  C6 1A                     dec <pRightParts
  265  34:8C67            .finish:                
  266  34:8C67  60                rts
  267  34:8C68            .borderParts:
  268  34:8C68  F7 F8 F9          .db $f7,$f8,$f9
  269  34:8C6B  FA FF FB          .db $fa,$ff,$fb
  270  34:8C6E  FC FD FE          .db $fc,$fd,$fe 
  271                     ;------------------------------------------------------------------------------------------------------
  272  34:8C71            genCode_begin:
  273  34:8C71            genCode_put_left:
  274  34:8C71  A9 00             lda #00         ;2
  275  34:8C73  8D 07 20          sta $2007       ;4
  276  34:8C76            genCode_copyLoop:       
  277  34:8C76  98                tya                     ;2
  278  34:8C77  18                clc                     ;2
  279  34:8C78            genCode_adc_offset:     
  280  34:8C78  69 00             adc #0          ;2 alignOffset + (totalWidth - width)
  281  34:8C7A  A8                tay                     ;2
  282  34:8C7B            genCode_go_next:
  283  34:8C7B            genCode_loop_begin:     ;(4+4)*8
  284  34:8C7B  B9 00 72          lda $7200,y
  285  34:8C7E  8D 07 20          sta $2007
  286                     ;       unrolled UNROLL_COUNT times
  287                     
  288  34:8C81            genCode_dex:
  289  34:8C81            genCode_put_right:
  290  34:8C81  A9 00             lda #00         ;2
  291  34:8C83  8D 07 20          sta $2007       ;4
  292  34:8C86            genCode_finish_line:
  293  34:8C86  60                rts                     ;6
  294  34:8C87            genCode_end:    ;21(prolog/epilog)+6(left)+6(right)+ 64~72(loop)+5+7(loop overhead)
  295           8D03      genCode_free_end = $8d03
  296                     ;------------------------------------------------------------------------------------------------------
  297                     ;here original:$8d03    
  298                     ;------------------------------------------------------------------------------------------------------
  299           0035              .bank BANK(ff3_window_begin)
  300           B557              .org ff3_window_begin ;$8000 + (ff3_window_begin & $7fff)
  301                     ;------------------------------------------------------------------------------------------------------
  302           7901      genCodeBase = TEMP_RAM+1
  303  35:B557            generateCopyLoopCode:
  304                     ;       [out] clockCount
  305           0021      .alignOffset = $21
  306                     ;genCode_loopOffset = genCodeBase - 1
  307                     ;-----------------------------------
  308  35:B557  A5 20             lda <drawLen
  309                             ; alignOffset = (7 - width)+1 & 7
  310  35:B559  49 FF             eor #$ff
  311  35:B55B  18                clc
  312  35:B55C  69 01             adc #1
  313  35:B55E  29 1F             and #(UNROLL_COUNT - 1) ;
  314  35:B560  85 21             sta <.alignOffset
  315                             ;calc required cpu cycle count
  316                             ; 
  317                             ;clock required: 69 + 26 + (9 * drawLen)
  318                             ; overhead + put cost + loop cost
  319                             ;countdown value : req.clk / (2266/256) (113.3clock*20scanline)
  320  35:B562  A5 20             lda <drawLen
  321  35:B564  4A                lsr a
  322  35:B565  4A                lsr a
  323  35:B566  4A                lsr a
  324  35:B567  18                clc
  325  35:B568  65 20             adc <drawLen
  326                     
  327                             ;sta <clockCount        ;(9 * drawLen) / denom (=8)
  328                             ;lda <drawLen
  329                             ;jsr $fd49 - (UNROLL_SHIFT - 4 + 3)
  330                             ;clc
  331                             ;adc <clockCount
  332  35:B56A  69 0B             adc #LOOP_OVERHEAD
  333  35:B56C  85 1D             sta <clockCount
  334                     
  335                             ;-----------------------------
  336  35:B56E  A0 03             ldy #3
  337  35:B570  B1 1A             lda [pRightParts],y
  338  35:B572  48                pha
  339  35:B573  B1 18             lda [pLeftParts],y
  340  35:B575  48                pha
  341                             ;-----------------------------
  342                             ;from here,Y is reserved to 'dest index'
  343  35:B576  A0 00             ldy #0
  344  35:B578  24 1E             bit <borderPutFlags
  345  35:B57A  10 0E             bpl .copy_loop_code     ;bpl: bit7 is clear
  346  35:B57C  E6 1D                     inc <clockCount
  347  35:B57E  A9 05                     lda #(genCode_copyLoop - genCode_put_left)
  348  35:B580  A2 00                     ldx #0
  349  35:B582  20 F6 B5                  jsr copyCodeBytes
  350  35:B585  68                        pla
  351  35:B586  48                        pha
  352  35:B587  8D 02 79                  sta genCodeBase + 1     ;lda #xx
  353  35:B58A            .copy_loop_code:
  354  35:B58A  68                pla     ;dummy
  355                     ;       tya
  356                     ;       sta genCode_loopOffset
  357                     
  358  35:B58B  A5 20             lda <drawLen
  359  35:B58D  F0 50             beq .no_center_tiles
  360  35:B58F  A9 05                     lda #(genCode_loop_begin - genCode_copyLoop)
  361  35:B591  A2 05                     ldx #(genCode_copyLoop - genCode_begin)
  362  35:B593  20 F6 B5                  jsr copyCodeBytes
  363                     
  364                                     ;--------------------------------------------------------------
  365                                     ; offsetIndex =
  366                                     ; 8+(len-lenCurrent)-align
  367  35:B596  A9 21                     lda #UNROLL_COUNT+1
  368  35:B598  18                        clc
  369  35:B599  65 1F                     adc <lineLen
  370  35:B59B  E5 20                     sbc <drawLen
  371                                     ;sec    ;always set (above sbc)
  372  35:B59D  E5 21                     sbc <.alignOffset
  373  35:B59F  99 FF 78                  sta genCodeBase - (genCode_loop_begin - genCode_adc_offset) + 1,y
  374                                     ;----------------------------------------------------------------
  375  35:B5A2  AD C0 7A                  lda pTileArray
  376  35:B5A5  18                        clc
  377  35:B5A6  65 21                     adc <.alignOffset
  378  35:B5A8  90 03                     bcc .sub_offset
  379  35:B5AA  EE C1 7A                          inc pTileArray+1
  380  35:B5AD                    .sub_offset:
  381  35:B5AD  38                        sec
  382  35:B5AE  E9 20                     sbc #UNROLL_COUNT
  383  35:B5B0  8D C0 7A                  sta pTileArray
  384  35:B5B3  B0 03                     bcs .done_offset
  385  35:B5B5  CE C1 7A                          dec pTileArray+1
  386  35:B5B8                    .done_offset:
  387  35:B5B8  A6 20                     ldx <drawLen
  388  35:B5BA                            .unroll_loopBytes:
  389  35:B5BA  8A                                txa
  390  35:B5BB  48                                pha
  391  35:B5BC  A9 06                             lda #SIZEOF_PUT_CODE
  392  35:B5BE  A2 0A                             ldx #(genCode_loop_begin - genCode_begin)
  393  35:B5C0  20 F6 B5                          jsr copyCodeBytes
  394                                             ; --- init address
  395  35:B5C3  AD C0 7A                          lda pTileArray
  396  35:B5C6  18                                clc
  397  35:B5C7  99 FC 78                          sta genCodeBase + (1 - SIZEOF_PUT_CODE),y
  398  35:B5CA  69 01                             adc #1  ;post increment
  399  35:B5CC  8D C0 7A                          sta pTileArray
  400                                             
  401  35:B5CF  AD C1 7A                          lda pTileArray+1
  402  35:B5D2  99 FD 78                          sta genCodeBase + (2 - SIZEOF_PUT_CODE),y
  403  35:B5D5  69 00                             adc #0
  404  35:B5D7  8D C1 7A                          sta pTileArray+1
  405                                             ;-----------------
  406  35:B5DA  68                                pla
  407  35:B5DB  AA                                tax
  408  35:B5DC  CA                                dex
  409  35:B5DD  D0 DB                     bne .unroll_loopBytes
  410                     
  411  35:B5DF            .no_center_tiles:
  412  35:B5DF            .copy_put_right_code:
  413                     
  414  35:B5DF  24 1E             bit <borderPutFlags
  415  35:B5E1  50 0E             bvc .copy_last  ;bvc: bit6 is clear
  416  35:B5E3  E6 1D                     inc <clockCount
  417  35:B5E5  A9 05                     lda #(genCode_finish_line - genCode_put_right)
  418  35:B5E7  A2 10                     ldx #(genCode_put_right - genCode_begin)
  419  35:B5E9  20 F6 B5                  jsr copyCodeBytes
  420  35:B5EC  68                        pla
  421  35:B5ED  48                        pha
  422  35:B5EE  99 FD 78                  sta genCodeBase - 4,y   ;lda #xx
  423  35:B5F1            .copy_last:
  424  35:B5F1  68                pla     ;dummy
  425  35:B5F2  A9 01             lda #(genCode_end - genCode_finish_line)
  426  35:B5F4  A2 15             ldx #(genCode_finish_line - genCode_begin)
  427                             ;jmp .copyCodeBytes
  428  35:B5F6            copyCodeBytes:
  429                     ;       [in] a : len
  430                     ;       [in] x : sourceOffset
  431                     ;       [in] y : destOffset     
  432           0030      .copyLast = $30
  433  35:B5F6  84 30             sty <.copyLast
  434  35:B5F8  18                clc
  435  35:B5F9  65 30             adc <.copyLast
  436  35:B5FB  85 30             sta <.copyLast
  437  35:B5FD            .copy:
  438  35:B5FD  BD 71 8C          lda genCode_begin,x
  439  35:B600  99 01 79          sta genCodeBase,y
  440  35:B603  E8                inx
  441  35:B604  C8                iny
  442  35:B605  C4 30             cpy <.copyLast
  443  35:B607  D0 F4             bne .copy
  444  35:B609  60                rts
  445  35:B60A            ff3_window_last:        
  446                     ;------------------------------------------------------------------------------------------------------
  447                             INIT_PATCH $34,$8eb0,$8f0b
                0034              .bank   $34
                8EB0              .org    $8eb0
       34:8EB0                    .ds             (($8f0b) - ($8eb0))
                8EB0              .org    $8eb0
  448  34:8EB0            eraseWindow:
  449           2240      .vram1stBegin = $2240
  450           23A0      .vram1stEnd = $23a0     ;last line begins $2380
  451           2640      .vram2ndBegin = $2640
  452                             ;jsr waitNmi    ;presentCharacterのかわりに使うと画面消去中キャラが動かないが多少描画に使える時間が増える
  453  34:8EB0  20 85 81          jsr presentCharacter
  454  34:8EB3  A2 40             ldx #LOW(.vram1stBegin)
  455  34:8EB5  A9 22             lda #HIGH(.vram1stBegin)
  456  34:8EB7  20 C1 8E          jsr .erase
  457                             ;jsr waitNmi
  458  34:8EBA  20 85 81          jsr presentCharacter
  459  34:8EBD  A2 40             ldx #LOW(.vram2ndBegin)
  460  34:8EBF  A9 26             lda #HIGH(.vram2ndBegin)
  461                             ;fall through
  462  34:8EC1            .erase:
  463                             ;jsr drawWindow_setVramAndInitPpu       ;6+49
  464  34:8EC1  20 3A 8C          jsr drawWindow_setVramAddr      ;6+12
  465  34:8EC4  A9 00             lda #0
  466  34:8EC6  A2 20             ldx #$20
  467  34:8EC8            .erase_loop:    ;fill 32*11 bytes
  468  34:8EC8  8D 07 20                  sta $2007
  469  34:8ECB  8D 07 20                  sta $2007
  470  34:8ECE  8D 07 20                  sta $2007
  471  34:8ED1  8D 07 20                  sta $2007
  472  34:8ED4  8D 07 20                  sta $2007
  473  34:8ED7  8D 07 20                  sta $2007
  474  34:8EDA  8D 07 20                  sta $2007
  475  34:8EDD  8D 07 20                  sta $2007
  476  34:8EE0  8D 07 20                  sta $2007
  477  34:8EE3  8D 07 20                  sta $2007
  478  34:8EE6  8D 07 20                  sta $2007
  479  34:8EE9  CA                        dex
  480  34:8EEA  D0 DC                     bne .erase_loop
  481  34:8EEC  4C CB F8          jmp updatePpuScrollNoWait
  482                     ;$8f0b
  483                     ;------------------------------------------------------------------------------------------------------
  484                             ;.bank  $34
  485                             ;.org   $8f0b
  486                             INIT_PATCH $34,$8f0b,$8f43
                0034              .bank   $34
                8F0B              .org    $8f0b
       34:8F0B                    .ds             (($8f43) - ($8f0b))
                8F0B              .org    $8f0b
  487  34:8F0B            eraseFromLeftBottom0Bx0A:
  488           0018      .vram = $18
  489                             INIT16 <.vram,$2380
       34:8F0B  A9 80             lda #LOW($2380)
       34:8F0D  85 18             sta <.vram
       34:8F0F  A9 23             lda #HIGH($2380)
       34:8F11  85 19             sta <.vram+1
  490  34:8F13  20 80 FB          jsr waitNmi
  491  34:8F16  A0 0A             ldy #$0a
  492  34:8F18            .erase_loop:
  493  34:8F18  A6 18                     ldx <.vram
  494  34:8F1A  A5 19                     lda <.vram+1
  495  34:8F1C  20 44 8C                  jsr drawWindow_setVramAndInitPpu        ;6+49
  496                                     ;jsr drawWindow_setVramAddr
  497  34:8F1F  A2 05                     ldx #5
  498  34:8F21  A9 00                     lda #0
  499  34:8F23                    .erase_line:    
  500  34:8F23  8D 07 20                          sta $2007
  501  34:8F26  8D 07 20                          sta $2007
  502  34:8F29  CA                                dex 
  503  34:8F2A  D0 F7                             bne .erase_line
  504  34:8F2C  8D 07 20                  sta $2007
  505                                     ;SUB16 <.vram,$0020
  506                                     SUB16by8 <.vram,#$20
       34:8F2F  A5 18             lda <.vram
       34:8F31  38                sec
       34:8F32  E9 20             sbc #$20
       34:8F34  85 18             sta <.vram
       34:8F36  B0 02             bcs .sub16by8_00092
       34:8F38  C6 19                     dec <.vram+1
       34:8F3A                    .sub16by8_00092:
  507  34:8F3A  88                        dey     
  508  34:8F3B  D0 DB                     bne .erase_loop
  509  34:8F3D  60                rts
  510                             ;jmp updatePpuScrollNoWait
  511                     ;=======================================================================================================        
  512                             RESTORE_PC      ff3_window_last
                0035              .bank   BANK(ff3_window_last)
                B60A              .org    ff3_window_last
#[3]   ff3_hack_master.asm
   50                     
#[4]   ff3_command_04.asm
   51                                     .include "ff3_command_04.asm"   ;consume( genCode_end, getCommandInput_end )
    1                     ; ff3_command_04.asm
    2                     ;
    3                     ;description:
    4                     ;       patches calculations for command 04 ('fight')
    5                     ;       implements 'counter attack' feature
    6                     ;
    7                     ;version:
    8                     ;       0.08 (2006-11-10)
    9                     ;
   10                     ;======================================================================================================
   11  35:B60A            ff3_command_04_begin:
   12                             ;INIT_PATCH $35,$a104,$a212
   13                             INIT_PATCH $35,$a104,$a353
                0035              .bank   $35
                A104              .org    $a104
       35:A104                    .ds             (($a353) - ($a104))
                A104              .org    $a104
   14  35:A104            command_fight:
   15           0018      .actorIndex = $18
   16           001A      .knightHps = $1a
   17           0022      .cHealthyKnight = $22
   18           0052      .iPlayer = $52
   19           0057      .pPlayerBaseParams = $57
   20           0059      .pEquips = $59
   21           005B      .pPlayerParams = $5b
   22           005F      .playerOffset = $5f
   23           006E      .pActor = $6e
   24           0070      .pTarget = $70
   25           7CEC      .nearlyDeadFlag = $7cec ;probably (not yet confirmed)
   26                     
   27  35:A104  20 2E A4          jsr getActor2C  ;a42e
   28                             ;bpl .actor_is_player_char
   29  35:A107  30 03             bmi .actor_is_enemy     
   30  35:A109  4C 9C A1          jmp .actor_is_player_char
   31  35:A10C            .actor_is_enemy 
   32                                     ;enemy
   33  35:A10C  B1 70                     lda [.pTarget],y
   34  35:A10E  29 07                     and #7
   35  35:A110  85 18                     sta <.actorIndex
   36  35:A112  AA                        tax
   37  35:A113  AD EC 7C                  lda .nearlyDeadFlag
   38  35:A116  20 38 FD                  jsr maskTargetBit
   39  35:A119  F0 4D                     beq .bump
   40                     
   41  35:A11B  A9 C0                     lda #$c0        ;dead|stone
   42  35:A11D  A2 21                     ldx #$21        ;confused|jumping
   43  35:A11F  20 2B 9A                  jsr isTargetNotInStatus
   44  35:A122  90 72                     bcc .finish_protect_check
   45                                             ;ok
   46                                             ;a == 0 (naturally)
   47  35:A124  85 22                             sta <.cHealthyKnight
   48  35:A126                            .check_protect:
   49  35:A126  A2 03                             ldx #3
   50  35:A128  86 52                             stx <.iPlayer
   51  35:A12A                            .find_healthy_knight:
   52                                                     
   53  35:A12A  A5 52                                     lda <.iPlayer
   54  35:A12C  0A                                        asl a
   55  35:A12D  AA                                        tax
   56  35:A12E  95 24                                     sta <$24,x
   57  35:A130  A9 00                                     lda #0
   58  35:A132  95 1A                                     sta <.knightHps,x
   59  35:A134  95 1B                                     sta <.knightHps+1,x
   60                                                     
   61  35:A136  20 41 A5                                  jsr getPlayerOffset     ;a541   ;x,y unchanged
   62                     
   63  35:A139  A9 3C                                     lda #EXTRA_ABILITY_OFFSET
   64  35:A13B  20 88 9B                                  jsr setYtoOffsetOf
   65  35:A13E  B1 5B                                     lda [.pPlayerParams],y
   66  35:A140  29 20                                     and #PASSIVE_PROTECT
   67  35:A142  F0 1E                                     beq .find_next
   68                                                     
   69  35:A144  A9 01                                     lda #1
   70  35:A146  20 88 9B                                  jsr setYtoOffsetOf
   71                                                     ;iny    ;+01
   72  35:A149  B1 5B                                     lda [.pPlayerParams],y
   73  35:A14B  29 C1                                     and #$c1
   74  35:A14D  D0 13                                     bne .find_next
   75                                                     
   76  35:A14F  C8                                        iny     ;+02
   77  35:A150  B1 5B                                     lda [.pPlayerParams],y
   78  35:A152  29 E0                                     and #$e0
   79  35:A154  D0 0C                                     bne .find_next
   80                                                             ;ok
   81  35:A156  C8                                                iny     ;setYtoOffset03
   82  35:A157  B1 5B                                             lda [.pPlayerParams],y
   83  35:A159  95 1A                                             sta <.knightHps,x
   84  35:A15B  C8                                                iny
   85  35:A15C  B1 5B                                             lda [.pPlayerParams],y
   86  35:A15E  95 1B                                             sta <.knightHps+1,x
   87  35:A160  E6 22                                             inc <.cHealthyKnight
   88  35:A162                                    .find_next:
   89  35:A162  C6 52                                     dec <.iPlayer
   90  35:A164  10 C4                                     bpl .find_healthy_knight
   91                     ;$a175:
   92  35:A166  A5 22                             lda <.cHealthyKnight
   93  35:A168            .bump:
   94  35:A168  F0 2C                             beq .finish_protect_check
   95  35:A16A  20 87 8C                                  jsr getIndexOfGreatest  ;a30f
   96                                                     ;lda #0
   97                                                     ;jsr flagTargetBit      ;fd20
   98  35:A16D  20 BA 9F                                  jsr flagSingleTarget
   99                                                     
  100  35:A170  8D 99 7E                                  sta $7e99
  101  35:A173  8D DF 7E                                  sta play_protectionTargetBits   ;$7edf
  102                                                     
  103  35:A176  A6 18                                     ldx <.actorIndex
  104                                                     ;lda #0
  105                                                     ;jsr flagTargetBit
  106  35:A178  20 BA 9F                                  jsr flagSingleTarget
  107  35:A17B  8D E0 7E                                  sta $7ee0
  108                                                     
  109  35:A17E  A5 5F                                     lda <.playerOffset
  110  35:A180  18                                        clc
  111  35:A181  69 75                                     adc #$75
  112  35:A183  85 70                                     sta <.pTarget
  113  35:A185  A9 00                                     lda #0
  114  35:A187  69 75                                     adc #$75
  115  35:A189  85 71                                     sta <.pTarget+1
  116                                                     
  117  35:A18B  A0 33                                     ldy #$33
  118  35:A18D  B1 70                                     lda [.pTarget],y
  119  35:A18F  8D E3 7C                                  sta $7ce3       ;save
  120  35:A192  29 FE                                     and #$fe        ;clear 'at backline' flag
  121  35:A194  91 70                                     sta [.pTarget],y
  122  35:A196            .finish_protect_check:
  123                                     ;extra
  124  35:A196  20 53 A2                  jsr checkCounter
  125  35:A199  90 06                     bcc command_fight_doCalc
  126  35:A19B  60                                rts
  127                     ;a1ac
  128  35:A19C            .actor_is_player_char:
  129  35:A19C            command_fight_setupWeaponParam:
  130           0052      .iPlayer = $52
  131  35:A19C  29 07             and #7  ;index
  132  35:A19E  20 E6 A2          jsr setupWeaponId
  133                     ;a212:
  134  35:A1A1            command_fight_doCalc:
  135           0052      .iPlayer = $52
  136           006E      .pActor = $6e
  137           0070      .pTarget = $70
  138  35:A1A1  20 1E 80          jsr dispatchBattleFunction_03   ;801e
  139                     
  140  35:A1A4  AD DF 7E          lda play_protectionTargetBits
  141  35:A1A7  F0 0C             beq .sum_hit_count
  142  35:A1A9  A9 52                     lda #$52        ;"ナイトが みをていして かばった！"
  143  35:A1AB  20 BF 9F                  jsr addBattleMessage
  144                     
  145  35:A1AE  AD EA 7C                  lda $7cea
  146  35:A1B1  A0 33                     ldy #$33
  147  35:A1B3  91 70                     sta [.pTarget],y
  148                     
  149  35:A1B5            .sum_hit_count:
  150           007C      .hitCountRight = $7c
  151           007D      .hitCountLeft = $7d
  152           00E0      .targetStatusCache = $e0
  153           00F0      .actorStatusCache = $f0
  154  35:A1B5  18                clc
  155  35:A1B6  A5 7C             lda <.hitCountRight
  156  35:A1B8  65 7D             adc <.hitCountLeft
  157  35:A1BA  C9 21             cmp #33
  158  35:A1BC  90 02             bcc .store_count
  159  35:A1BE  A9 20                     lda #32
  160  35:A1C0            .store_count:
  161  35:A1C0  8D D7 78          sta actionName  ;78d7
  162                             
  163  35:A1C3  A6 64             ldx <$64
  164  35:A1C5  B5 E0             lda <.targetStatusCache,x
  165  35:A1C7  30 4E             bmi .target_is_dead
  166                             ;alive
  167  35:A1C9  AD D7 78          lda actionName  
  168  35:A1CC  F0 56             beq .consume_item       ;miss
  169                             ;alive && hit
  170  35:A1CE  E8                inx
  171  35:A1CF  B5 E0             lda <.targetStatusCache,x
  172  35:A1D1  A0 02             ldy #2
  173  35:A1D3  29 18             and #STATUS_REMAIN_MASK ;$18
  174                             ;beq .check_death       ;target is alive (already checked)
  175  35:A1D5  F0 4D             beq .consume_item       ;status unchanged
  176                                     ;18 10 08
  177  35:A1D7  38                        sec
  178  35:A1D8  E9 08                     sbc #8
  179  35:A1DA  D0 30                     bne .update_status      ;a295
  180                     ;$a254:
  181                     ;打撃によって回復した
  182  35:A1DC  B5 E0                             lda <.targetStatusCache,x
  183  35:A1DE  48                                pha
  184  35:A1DF  29 07                             and #STATUS_PETRIFY_MASK | STATUS_JUMPING
  185  35:A1E1  95 E0                             sta <.targetStatusCache,x
  186  35:A1E3  91 70                             sta [.pTarget],y
  187  35:A1E5  20 1E 9A                          jsr isTargetActor
  188  35:A1E8  D0 08                             bne .get_status_name
  189  35:A1EA  B5 E0                                     lda <.targetStatusCache,x
  190  35:A1EC  95 F0                                     sta <.actorStatusCache,x
  191  35:A1EE  A0 02                                     ldy #BP_OFFSET_STATUS_LITE      ;2
  192  35:A1F0  91 6E                                     sta [.pActor],y
  193  35:A1F2                            .get_status_name:
  194  35:A1F2  68                                pla
  195  35:A1F3  A2 01                             ldx #$01
  196  35:A1F5                            .find_first_set:
  197  35:A1F5  E8                                        inx
  198  35:A1F6  0A                                        asl a
  199  35:A1F7  90 FC                                     bcc .find_first_set
  200                     ;a27e
  201  35:A1F9  8E D9 78                  stx effectMessage       ;78d9
  202                                     ;jsr clearTargetAction
  203  35:A1FC  A0 2C                             ldy #BP_OFFSET_INDEX_AND_MODE   ;$2c
  204  35:A1FE  B1 70                             lda [.pTarget],y
  205  35:A200  29 E7                             and #$e7
  206  35:A202  91 70                             sta [.pTarget],y
  207  35:A204  C8                                iny
  208  35:A205  C8                                iny
  209  35:A206  A9 00                             lda #0
  210  35:A208  91 70                             sta [.pTarget],y
  211  35:A20A  F0 18                     beq .consume_item       ;always satisfied (cleartargetaction)
  212                     
  213  35:A20C                    .update_status: ;a295
  214  35:A20C  B5 E0                     lda <.targetStatusCache,x
  215  35:A20E  38                        sec
  216  35:A20F  E9 08                     sbc #8
  217  35:A211  95 E0                     sta <.targetStatusCache,x
  218  35:A213  91 70                     sta [.pTarget],y
  219  35:A215  B0 0D                     bcs .consume_item       ;always set
  220  35:A217            .target_is_dead:
  221  35:A217  A0 2C                     ldy #$2c
  222  35:A219  A2 1A                     ldx #$1a        ;"しんでしまった!"
  223  35:A21B  B1 70                     lda [.pTarget],y
  224  35:A21D  10 01                     bpl .store_death_message
  225  35:A21F  E8                                inx             ;"てきをたおした!"
  226  35:A220                    .store_death_message:
  227  35:A220  8A                        txa
  228  35:A221  20 BF 9F                  jsr addBattleMessage
  229                     
  230  35:A224            .consume_item: ;a2b7
  231           0024      .recalcRequired = $24
  232  35:A224  A9 00             lda #0
  233  35:A226  8D D5 78          sta battleProcessType   ;78d5
  234  35:A229  85 24             sta <.recalcRequired
  235  35:A22B  20 2E A4          jsr getActor2C
  236  35:A22E  30 22             bmi .finish
  237                     ;$a2c3  
  238  35:A230  29 07                     and #7
  239  35:A232  85 52                     sta <.iPlayer
  240  35:A234  20 41 A5                  jsr getPlayerOffset
  241  35:A237  A9 01                     lda #1
  242  35:A239  20 2A A3                  jsr consumeIfArrow
  243  35:A23C  A9 02                     lda #2
  244  35:A23E  20 2A A3                  jsr consumeIfArrow
  245  35:A241  A9 03                     lda #3
  246  35:A243  20 3C A3                  jsr consumeIfShuriken
  247  35:A246  A9 05                     lda #5
  248  35:A248  20 3C A3                  jsr consumeIfShuriken
  249                     ;$a307:
  250  35:A24B  A5 24                     lda <.recalcRequired
  251  35:A24D  F0 03                     beq .finish
  252  35:A24F  4C 26 80                          jmp dispatchBattleFunction_05
  253  35:A252            .finish:
  254  35:A252            command_fight_doReturn:
  255  35:A252  60                rts
  256                     ;$a30f
  257                     ;------------------------------------------------------------------------------------------------------
  258  35:A253            checkCounter:   ;extra
  259                     ;out] bool carry : (countered : 1)
  260           0018      .rand = $18
  261           0052      .iPlayer = $52
  262           0057      .pPlayerBaseParams = $57
  263           0059      .pEquips = $59
  264           005B      .pPlayerParams = $5b
  265           006E      .pActor = $6e
  266           0070      .pTarget = $70
  267  35:A253  20 27 9A          jsr isTargetActive
  268  35:A256  90 FA             bcc command_fight_doReturn
  269  35:A258  20 A6 9F          jsr setXtoTargetIndex
  270  35:A25B  A0 3C             ldy #EXTRA_ABILITY_OFFSET
  271  35:A25D  B1 70             lda [.pTarget],y
  272                             ;and #PASSIVE_COUNTER = 80
  273  35:A25F  18                clc
  274  35:A260  10 F0             bpl command_fight_doReturn
  275  35:A262            .calc_rate:
  276  35:A262  8A                txa
  277  35:A263  48                pha
  278  35:A264  A9 64             lda #100
  279  35:A266  20 64 A5          jsr getSys1Random
  280  35:A269  85 18             sta <.rand
  281                             ;%success = 25 + joblv>>1
  282  35:A26B  68                pla
  283  35:A26C  AA                tax     ;index
  284  35:A26D  A0 0F             ldy #$0f
  285  35:A26F  B1 70             lda [.pTarget],y        ;joblv
  286  35:A271  4A                lsr a
  287  35:A272  18                clc
  288  35:A273  69 19             adc #25
  289  35:A275  C5 18             cmp <.rand
  290           0000              .ifdef TEST_COUNTER_ATTACK
  292                             .else
  293  35:A277  90 D9                     bcc command_fight_doReturn
  294                             .endif ;TEST_COUNTER_ATTACK
  295                     
  296  35:A279            .doCounter:
  297                             ;x = target index
  298  35:A279  20 BA 9F          jsr flagSingleTarget
  299  35:A27C  8D 98 7E          sta play_actorBits
  300                             ;lda play_effectTargetSide
  301                             ;ora #$c1       ;original uses higher 2bit.
  302  35:A27F  A9 41             lda #$41
  303  35:A281  8D 9A 7E          sta play_effectTargetSide
  304                     
  305  35:A284  A9 59             lda #EXMSG_COUNTER
  306  35:A286  20 BF 9F          jsr addBattleMessage
  307                     
  308  35:A289  20 AD 9F          jsr setXtoActorIndex
  309  35:A28C  20 BA 9F          jsr flagSingleTarget
  310  35:A28F  8D 9B 7E          sta play_effectTargetBits       ;damage
  311  35:A292  8D 99 7E          sta play_castTargetBits         ;blow
  312                     
  313  35:A295            command_fight_counter:
  314           006E      .pActor = $6e
  315           0070      .pTarget = $70
  316                             ;jsr .swapActorAndTarget
  317  35:A295  20 C7 A2          jsr .swapStatusCache
  318                             
  319  35:A298  20 2E A4          jsr getActor2C
  320  35:A29B  AA                tax
  321                             
  322  35:A29C  A0 2F             ldy #$2f
  323  35:A29E  B1 6E             lda [.pActor],y ;target bit
  324  35:A2A0  48                pha     
  325                     
  326  35:A2A1  C8                iny
  327  35:A2A2  B1 6E             lda [.pActor],y
  328  35:A2A4  48                pha
  329                             
  330  35:A2A5  8A                txa
  331  35:A2A6  49 80             eor #$80
  332  35:A2A8  29 80             and #$80
  333  35:A2AA  91 6E             sta [.pActor],y ;force opponent side
  334                     
  335  35:A2AC  A0 28             ldy #$28
  336  35:A2AE  B1 6E             lda [.pActor],y
  337  35:A2B0  48                pha
  338  35:A2B1  A9 32             lda #COUNTER_CRITICAL_RATE
  339  35:A2B3  91 6E             sta [.pActor],y
  340                             
  341  35:A2B5  8A                txa     ;actor 2c
  342  35:A2B6  20 9C A1          jsr command_fight_setupWeaponParam;command_fight_doCalc
  343                             
  344  35:A2B9  68                pla
  345  35:A2BA  A0 28             ldy #$28
  346  35:A2BC  91 6E             sta [.pActor],y ;critical
  347                             
  348  35:A2BE  A0 30             ldy #$30
  349  35:A2C0  68                pla
  350  35:A2C1  91 6E             sta [.pActor],y ;target flag
  351                             
  352  35:A2C3  88                dey
  353  35:A2C4  68                pla
  354  35:A2C5  91 6E             sta [.pActor],y ;target bit
  355                     
  356  35:A2C7            .swapStatusCache:
  357  35:A2C7  A2 0F             ldx #$0f
  358  35:A2C9            .swap_stats:
  359  35:A2C9  B4 E0             ldy <$e0,x
  360  35:A2CB  B5 F0             lda <$f0,x
  361  35:A2CD  95 E0             sta <$e0,x
  362  35:A2CF  94 F0             sty <$f0,x
  363  35:A2D1  CA                dex
  364  35:A2D2  10 F5             bpl .swap_stats
  365  35:A2D4  38                sec     ;[out] countered
  366  35:A2D5            .swapActorAndTarget:
  367  35:A2D5  A6 6E             ldx <.pActor
  368  35:A2D7  A5 70             lda <.pTarget
  369  35:A2D9  86 70             stx <.pTarget
  370  35:A2DB  85 6E             sta <.pActor
  371  35:A2DD  A6 6F             ldx <.pActor+1
  372  35:A2DF  A5 71             lda <.pTarget+1
  373  35:A2E1  86 71             stx <.pTarget+1
  374  35:A2E3  85 6F             sta <.pActor+1
  375  35:A2E5            .finish:
  376  35:A2E5  60                rts
  377                     ;------------------------------------------------------------------------------------------------------
  378                     
  379  35:A2E6            setupWeaponId:
  380                     ;[in] u8 a : index
  381           0052      .iPlayer = $52
  382           0059      .pEquips = $59
  383           006E      .pActor = $6e
  384           0070      .pTarget = $70
  385                     ;[out]
  386           7E1F      .righthand = $7e1f
  387           7E20      .lefthand = $7e20
  388                     ;       and #7
  389  35:A2E6  85 52             sta <.iPlayer
  390  35:A2E8  A2 00             ldx #0
  391  35:A2EA  8E 20 7E          stx .lefthand
  392  35:A2ED  8E 1F 7E          stx .righthand
  393  35:A2F0  A0 01             ldy #1
  394  35:A2F2  B1 6E             lda [.pActor],y
  395  35:A2F4  29 28             and #$28
  396  35:A2F6  D0 31             bne .finish     ;toad | minimum
  397                                     ;ok
  398  35:A2F8  20 41 A5                  jsr getPlayerOffset     ;a541
  399  35:A2FB  20 8D 9B                  jsr setYtoOffset03
  400  35:A2FE  B1 59                     lda [.pEquips],y
  401  35:A300  20 AB 8C                  jsr filterShield
  402  35:A303  8D 1F 7E                  sta .righthand
  403                     
  404  35:A306  C8                        iny
  405  35:A307  C8                        iny
  406  35:A308  B1 59                     lda [.pEquips],y
  407  35:A30A  20 AB 8C                  jsr filterShield
  408  35:A30D  8D 20 7E                  sta .lefthand
  409                                     
  410  35:A310  F0 05                     beq .either_empty
  411  35:A312  AD 1F 7E                  lda .righthand
  412  35:A315  D0 12                     bne .finish
  413  35:A317            .either_empty:
  414                                             ;at least either lefthand or righthand is empty or shield
  415  35:A317  AD 20 7E                          lda .lefthand
  416  35:A31A  20 A7 8C                          jsr filterBowArrow
  417  35:A31D  8D 20 7E                          sta .lefthand
  418  35:A320  AD 1F 7E                          lda .righthand
  419  35:A323  20 A7 8C                          jsr filterBowArrow
  420  35:A326  8D 1F 7E                          sta .righthand
  421  35:A329            .finish:
  422  35:A329  60                rts
  423                     ;------------------------------------------------------------------------------------------------------
  424  35:A32A            consumeIfArrow:
  425                     ;a = 1 : right, 2 : left
  426           005B      .pPlayerParams = $5b
  427  35:A32A  AA                tax
  428  35:A32B  18                clc
  429  35:A32C  69 30             adc #$30
  430  35:A32E  20 88 9B          jsr setYtoOffsetOf
  431  35:A331  B1 5B             lda [.pPlayerParams],y
  432  35:A333  29 04             and #$04        ;arrow flag
  433  35:A335  F0 2F             beq $a366       ;.finish
  434  35:A337  E8                        inx
  435  35:A338  8A                        txa
  436  35:A339  0A                        asl a
  437  35:A33A  D0 17                     bne consumeEquippedItem
  438                     ;------------------------------------------------------------------------------------------------------
  439  35:A33C            consumeIfShuriken:
  440           0059      .pEquips = $59
  441  35:A33C  AA                tax
  442  35:A33D  20 88 9B          jsr setYtoOffsetOf
  443  35:A340  B1 59             lda [.pEquips],y
  444  35:A342  C9 41             cmp #$41        ;shuriken
  445  35:A344  D0 20             bne $a366 ;.finish
  446  35:A346  E8                        inx
  447  35:A347  8A                        txa
  448  35:A348  D0 09                     bne consumeEquippedItem
  449                     ;$a353
  450                     ;------------------------------------------------------------------------------------------------------
  451                             RESTORE_PC      genCode_end
                0034              .bank   BANK(genCode_end)
                8C87              .org    genCode_end
  452                     ;------------------------------------------------------------------------------------------------------
  453                             ;INIT_PATCH $35,$a30f,$a353
  454  34:8C87            getIndexOfGreatest:     ;original:a30f
  455           001A      .values = $1a
  456           0024      .indices = $24
  457           0052      .iPlayer = $52
  458  34:8C87  A0 05             ldy #5
  459  34:8C89  A2 07             ldx #7
  460  34:8C8B            .find_max:
  461  34:8C8B  38                        sec
  462  34:8C8C  B5 19                     lda <.values-1,x
  463  34:8C8E  F9 19 00                  sbc .values-1,y
  464  34:8C91  B5 1A                     lda <.values,x
  465  34:8C93  F9 1A 00                  sbc .values,y
  466  34:8C96  B0 02                     bcs .next
  467                                     ;16bit value at y is greater than value at x
  468  34:8C98  98                                tya
  469  34:8C99  AA                                tax
  470  34:8C9A                    .next:
  471  34:8C9A  88                        dey
  472  34:8C9B  88                        dey
  473  34:8C9C  10 ED                     bpl .find_max
  474                     ;now x is index of the greatest value
  475  34:8C9E  B5 23             lda <.indices-1,x
  476  34:8CA0  4A                lsr a
  477  34:8CA1  85 52             sta <.iPlayer
  478  34:8CA3  AA                tax
  479  34:8CA4  4C 41 A5          jmp getPlayerOffset
  480                     ;------------------------------------------------------------------------------------------------------
  481  34:8CA7            filterBowArrow:
  482  34:8CA7  A2 03             ldx #3
  483  34:8CA9  D0 02             bne filterByItemKind
  484  34:8CAB            filterShield:
  485  34:8CAB  A2 05             ldx #5  
  486  34:8CAD            filterByItemKind:
  487                     ;a :itemid
  488                     ;x : bound
  489           0018      .bound = $18
  490  34:8CAD  86 18             stx <.bound
  491  34:8CAF  48                pha
  492  34:8CB0  20 14 B0          jsr idToKind
  493  34:8CB3  E4 18             cpx <.bound
  494  34:8CB5  90 04             bcc .valid
  495  34:8CB7  68                        pla
  496  34:8CB8  A9 00                     lda #0
  497  34:8CBA  60                        rts
  498  34:8CBB            .valid:
  499  34:8CBB  68                pla
  500  34:8CBC  60                rts
  501                     ;------------------------------------------------------------------------------------------------------
  502  34:8CBD            set52toEffectTargetIndex:
  503  34:8CBD  A2 01             ldx #1
  504  34:8CBF  20 AB 86          jsr targetBitToCharIndex
  505  34:8CC2  84 52             sty <$52
  506  34:8CC4  60                rts
  507                     
  508                             VERIFY_PC genCode_free_end
       34:8CC5                    .verify_pc_00096:
                0000              .if (.verify_pc_00096 > genCode_free_end)
                                  .endif
  509                     ;------------------------------------------------------------------------------------------------------
  510                             RESTORE_PC      getCommandInput_end
                0034              .bank   BANK(getCommandInput_end)
                9A1E              .org    getCommandInput_end
  511  34:9A1E            isTargetActor:
  512           006E      .pActor = $6e
  513           0070      .pTarget = $70
  514                     ;.actor = $18
  515  34:9A1E  A0 2C             ldy #$2c
  516  34:9A20  B1 6E             lda [.pActor],y
  517  34:9A22  51 70             eor [.pTarget],y
  518  34:9A24  29 87             and #$87
  519  34:9A26  60                rts
  520                     ;------------------------------------------------------------------------------------------------------
  521  34:9A27            isTargetActive:
  522  34:9A27  A9 C0             lda #$c0        ;dead | stone
  523  34:9A29  A2 E1             ldx #$e1        ;paralyzed | sleeping | confused | jumping
  524  34:9A2B            isTargetNotInStatus:
  525                     ;[in] a = status00, x = status01
  526                     ;[out] carry : 
  527           0070      .pTarget = $70
  528  34:9A2B  18                clc
  529  34:9A2C  A0 01             ldy #1
  530  34:9A2E  31 70             and [.pTarget],y
  531  34:9A30  D0 07             bne .finish
  532                             
  533  34:9A32  C8                iny
  534  34:9A33  8A                txa
  535  34:9A34  31 70             and [.pTarget],y
  536  34:9A36  D0 01             bne .finish
  537  34:9A38  38                sec
  538  34:9A39            .finish:
  539  34:9A39  60                rts
  540                     
  541                             VERIFY_PC getCommandInput_free_end
       34:9A3A                    .verify_pc_00098:
                0000              .if (.verify_pc_00098 > getCommandInput_free_end)
                                  .endif
  542                     ;$9a40
  543                     ;======================================================================================================
  544                             INIT_PATCH $34,$8613,$8689
                0034              .bank   $34
                8613              .org    $8613
       34:8613                    .ds             (($8689) - ($8613))
                8613              .org    $8613
  545  34:8613            playEffect_fight:       ;function00
  546  34:8613  A2 00             ldx #0
  547  34:8615  8E 96 7E          stx $7e96
  548  34:8618  20 AB 86          jsr targetBitToCharIndex        ;86ab
  549  34:861B  AD 9A 7E          lda play_effectTargetSide       ;7e9a
  550  34:861E  10 10             bpl .actor_is_player_char
  551  34:8620  20 45 85                  jsr dispatchPresentScene_1f     ;8545
  552  34:8623  A9 20                     lda #$20
  553  34:8625  20 6E 86                  jsr .showBlowEffect
  554  34:8628  20 BD 8C                  jsr set52toEffectTargetIndex
  555  34:862B            .show_hit_effect:
  556  34:862B  A9 14                     lda #$14
  557  34:862D  4C 0E FA                  jmp call_2e_9d53
  558  34:8630            .actor_is_player_char:  ;8647
  559  34:8630  84 52                     sty <$52
  560  34:8632  29 01                     and #1
  561  34:8634  F0 11                     beq .do_usually
  562  34:8636  AD 98 7E                          lda play_actorBits
  563  34:8639  48                                pha
  564  34:863A  AD 9B 7E                          lda play_effectTargetBits
  565  34:863D  8D 98 7E                          sta play_actorBits
  566  34:8640  20 45 85                          jsr dispatchPresentScene_1f     ;
  567  34:8643  68                                pla
  568  34:8644  8D 98 7E                          sta play_actorBits
  569  34:8647                    .do_usually:
  570  34:8647  A9 12                     lda #$12
  571  34:8649  20 6E 86                  jsr .showBlowEffect
  572                                     
  573  34:864C  EE 96 7E                  inc $7e96
  574  34:864F  A5 BB                     lda <$bb
  575  34:8651  48                        pha
  576  34:8652  A5 BC                     lda <$bc
  577  34:8654  48                        pha
  578  34:8655  A9 00                     lda #0
  579  34:8657  85 BB                     sta <$bb
  580  34:8659  85 BC                     sta <$bc
  581  34:865B  A9 12                     lda #$12
  582  34:865D  20 0E FA                  jsr call_2e_9d53
  583                                     
  584  34:8660  20 BD 8C                  jsr set52toEffectTargetIndex
  585                                     
  586  34:8663  68                        pla
  587  34:8664  85 BC                     sta <$bc
  588  34:8666  68                        pla
  589  34:8667  85 BB                     sta <$bb
  590  34:8669  05 BC                     ora <$bc
  591  34:866B  D0 BE                     bne .show_hit_effect
  592  34:866D  60                        rts
  593                     ;------------------------------------------------------------------------------------------------------
  594  34:866E            .showBlowEffect:
  595                     ;[in] a : type ( enemy = 20, player = 12
  596  34:866E  AE 6F 7E          ldx $7e6f
  597  34:8671  F0 0E             beq .finish
  598  34:8673  48                        pha
  599  34:8674  A2 01                     ldx #1
  600  34:8676  20 AB 86                  jsr targetBitToCharIndex        ;86ab
  601  34:8679  84 B8                     sty <$b8
  602  34:867B  68                        pla
  603  34:867C  20 0E FA                  jsr call_2e_9d53
  604  34:867F  68                        pla     ;retaddr
  605  34:8680  68                        pla     ;retaddr
  606  34:8681            .finish:
  607  34:8681  60                rts
  608                     ;$868a:
  609                     ;======================================================================================================
  610  34:8682            ff3_command_04_end:
  611                             RESTORE_PC ff3_command_04_begin
                0035              .bank   BANK(ff3_command_04_begin)
                B60A              .org    ff3_command_04_begin
#[3]   ff3_hack_master.asm
#[4]   ff3_command_13.asm
   52                                     .include "ff3_command_13.asm"   ;save
    1                     ; ff3_command_13.asm
    2                     ;
    3                     ; description:
    4                     ;       replaces command 13 (useItem)
    5                     ;
    6                     ; version:
    7                     ;       0.05 (2006-10-28)
    8                     ;======================================================================================================
    9  35:B60A            ff3_command_13_begin:
   10                             INIT_PATCH $31,$a65e,$a732
                0031              .bank   $31
                A65E              .org    $a65e
       31:A65E                    .ds             (($a732) - ($a65e))
                A65E              .org    $a65e
   11  31:A65E            setupItemCalculation:   ;$31:a65e useItem //dispid:04 [battleFunction04]
   12                     ;[in]
   13           001A      .actionId = $1a
   14           006E      .pActor = $6e
   15           0070      .pTarget = $70
   16                     ;---------------------------------------
   17  31:A65E  A0 01             ldy #1
   18  31:A660  8C D5 78          sty battleProcessType
   19  31:A663  85 72             sta <$72
   20  31:A665  85 4B             sta <$4b
   21  31:A667  A9 14             lda #$14
   22  31:A669  8D C2 7E          sta $7ec2
   23  31:A66C  A5 1A             lda <.actionId
   24  31:A66E  8D D7 78          sta actionName
   25  31:A671  C9 98             cmp #$98        ;magical key
   26  31:A673  B0 27             bcs .not_equip
   27           001A      .pItemParam = $1a
   28  31:A675  A2 08                     ldx #8
   29  31:A677  20 D6 FC                  jsr mul_8x8     ;y is unchanged
   30  31:A67A  18                        clc
   31  31:A67B  A5 1B                     lda <.pItemParam+1
   32  31:A67D  69 94                     adc #$94
   33  31:A67F  85 1B                     sta <.pItemParam+1
   34  31:A681  A0 04                     ldy #4
   35  31:A683  B1 1A                     lda [.pItemParam],y
   36  31:A685  29 7F                     and #$7f
   37  31:A687  C9 7F                     cmp #$7f
   38  31:A689  F0 06                     beq .no_effect  ;a722
   39  31:A68B  85 1A                     sta <.actionId
   40  31:A68D  A9 01                     lda #1
   41  31:A68F  D0 7E                     bne .take_effect        ;a71b
   42  31:A691            .no_effect:     ;a722
   43  31:A691  A9 18             lda #$18
   44  31:A693  8D C2 7E          sta $7ec2
   45  31:A696  A9 51             lda #$51        ;"なにも おこらなかった"
   46  31:A698  8D DA 78          sta battleMessages
   47  31:A69B  60                rts
   48  31:A69C            .not_equip:
   49  31:A69C  C9 C8             cmp #$c8
   50  31:A69E  B0 F1             bcs .no_effect  ;a722
   51           0046      .pItemEffect = $46
   52           001B      .effectId = $1b
   53                                     ;consumeable item
   54                                     ;$46,47 = (a - #98) + #91a0;
   55  31:A6A0  18                        clc
   56  31:A6A1  69 08                     adc #08
   57  31:A6A3  85 46                     sta <.pItemEffect
   58  31:A6A5  A9 00                     lda #0
   59  31:A6A7  69 91                     adc #$91
   60  31:A6A9  85 47                     sta <.pItemEffect+1
   61  31:A6AB  A9 18                     lda #$18
   62  31:A6AD  85 4A                     sta <$4a
   63                                     ;fix! v0.6.1
   64  31:A6AF  A9 01                     lda #1
   65  31:A6B1  85 4B                     sta <$4b
   66                                     ;
   67  31:A6B3  A9 17                     lda #$17
   68  31:A6B5  20 DC FD                  jsr copyTo7400  ;fddc
   69  31:A6B8  AD 00 74                  lda $7400
   70  31:A6BB  85 1B                     sta <.effectId
   71  31:A6BD  C9 7F                     cmp #$7f
   72  31:A6BF  F0 D0                     beq .no_effect  ;a722
   73                                     
   74  31:A6C1  AD D8 7E                  lda $7ed8
   75  31:A6C4  29 10                     and #$10
   76  31:A6C6  F0 06                     beq .consume_item
   77                                     
   78  31:A6C8  A5 1A                     lda <.actionId  ;also itemid
   79  31:A6CA  C9 AD                     cmp #$ad        ;うちでのこづち
   80  31:A6CC  F0 C3                     beq .no_effect  ;a722
   81  31:A6CE            .consume_item:
   82  31:A6CE  A2 00                             ldx #0
   83  31:A6D0                            .find_item:
   84  31:A6D0  BD C0 60                                  lda backpackItems,x
   85  31:A6D3  C5 1A                                     cmp <.actionId
   86  31:A6D5  F0 04                                     beq .found
   87  31:A6D7  E8                                        inx
   88  31:A6D8  E8                                        inx
   89  31:A6D9  D0 F5                                     bne .find_item
   90  31:A6DB                            .found: 
   91                                             ;ASSERT(x < 0x40)
   92  31:A6DB  E8                                inx
   93  31:A6DC  DE C0 60                          dec backpackItems,x
   94  31:A6DF  D0 06                             bne .get_cast_count
   95  31:A6E1  CA                                        dex
   96  31:A6E2  A9 00                                     lda #0
   97  31:A6E4  9D C0 60                                  sta backpackItems,x
   98  31:A6E7                            .get_cast_count:
   99  31:A6E7  A5 1A                             lda <.actionId
  100  31:A6E9  A6 1B                             ldx <.effectId
  101  31:A6EB  86 1A                             stx <.actionId
  102  31:A6ED  C9 A6                             cmp #$a6        ;potion
  103  31:A6EF  B0 04                             bcs .load_cast_count
  104  31:A6F1  A9 00                                     lda #0
  105  31:A6F3  F0 1A                                     beq .take_effect
  106  31:A6F5                            .load_cast_count:
  107           0046      .pItemHitCount = $46
  108                                             ;$46,47 = #a35e + (a - #a6);
  109  31:A6F5  18                                clc
  110  31:A6F6  69 B8                             adc #$b8
  111  31:A6F8  85 46                             sta <.pItemHitCount
  112  31:A6FA  A9 00                             lda #0
  113  31:A6FC  AA                                tax
  114  31:A6FD  69 A2                             adc #$a2
  115  31:A6FF  85 47                             sta <.pItemHitCount+1
  116  31:A701  A9 18                             lda #$18
  117  31:A703  85 4A                             sta <$4a
  118  31:A705  8A                                txa
  119  31:A706  E8                                inx
  120  31:A707  86 4B                             stx <$4b        ;1
  121  31:A709  20 DC FD                          jsr copyTo7400
  122                                             
  123  31:A70C  AD 00 74                          lda $7400
  124  31:A70F            .take_effect: ;a71b
  125           007C      .castCountFinal = $7c
  126           0030      .castCount = $30
  127           0001              .ifdef ENABLE_EXTRA_ABILITY_TAG
  128  31:A70F  AA                        tax
  129  31:A710  A9 3C                     lda #EXTRA_ABILITY_OFFSET
  130  31:A712  20 98 BE                  jsr b31_setYtoOffsetOf
  131  31:A715  B1 6E                     lda [.pActor],y
  132  31:A717  29 40                     and #PASSIVE_DOUBLE_ITEM_EFFECT
  133  31:A719  F0 03                     beq .effect_normal
  134  31:A71B  8A                                txa
  135  31:A71C  0A                                asl a
  136  31:A71D  AA                                tax
  137  31:A71E                    .effect_normal:
  138  31:A71E  86 30                     stx <.castCount
  139  31:A720  86 7C                     stx <.castCountFinal
  140                             .endif ;ENABLE_EXTRA_ABILITY_TAG
  141                     
  142  31:A722  4C 77 AF          jmp $af77       ;doSpecialAction
  143                     ;------------------------------------------------------------------------------------------------------
  144                     ;$a732
  145                     ;======================================================================================================
  146                             RESTORE_PC ff3_command_13_begin
                0035              .bank   BANK(ff3_command_13_begin)
                B60A              .org    ff3_command_13_begin
#[3]   ff3_hack_master.asm
   53                                             
#[4]   ff3_b34_play_effect.asm
   54                                     .include "ff3_b34_play_effect.asm"      ;save
    1                     ; ff3_b34_play_effect.asm
    2                     ;
    3                     ; description:
    4                     ;       replaces code for controling various effects
    5                     ;
    6                     ; version:
    7                     ;       0.05 (2006-11-30)
    8                     ;======================================================================================================
    9  35:B60A            ff3_b34_play_effect_begin:
   10                             ;INIT_PATCH $34,$8411,$843e
   11                             ;INIT_PATCH $34,$83f8,$8460
   12                             INIT_PATCH $34,$8411,$8460
                0034              .bank   $34
                8411              .org    $8411
       34:8411                    .ds             (($8460) - ($8411))
                8411              .org    $8411
   13  34:8411            playEffect:
   14                     ;[in]
   15                     ; u8 $7e9a :    action side flag (80:actor enemy 40:target enemy)
   16                     ; u8 $7ec2 : effectType; set by commandHandler, usually commandId
   17                     ; u8 $7ec3 : (0 or 1?)
   18                     ;playEffect_handlerIndices = $83f8
   19                     ;playEffect_handlers = $843e
   20  34:8411  A2 00             ldx #0
   21  34:8413  2C 9A 7E          bit play_effectTargetSide
   22  34:8416  50 01             bvc .target_player
   23  34:8418  E8                        inx
   24  34:8419            .target_player:
   25  34:8419  8E 6F 7E          stx play_damageTarget
   26                             
   27  34:841C  AC C2 7E          ldy effectHandlerIndex
   28  34:841F  B9 3C 84          lda playEffect_handlerIndices,y
   29  34:8422  C9 01             cmp #1
   30  34:8424  D0 04             bne .not_handler_01
   31  34:8426  18                        clc
   32  34:8427  6D C3 7E                  adc effectHandlerFlag
   33  34:842A            .not_handler_01
   34  34:842A  8D 97 7E          sta $7e97
   35  34:842D  0A                asl a
   36  34:842E  A8                tay
   37  34:842F  B9 57 84          lda playEffect_handlers,y
   38  34:8432  85 18             sta <$18
   39  34:8434  B9 58 84          lda playEffect_handlers+1,y
   40  34:8437  85 19             sta <$19
   41  34:8439  6C 18 00          jmp [$0018]
   42  34:843C            playEffect_handlerIndices:
   43  34:843C  03 03 04          .db $03,$03,$04,$05,$00,$06,$0D,$0D
       34:843F  05 00 06  
       34:8442  0D 0D     
   44  34:8444  07 08 03          .db $07,$08,$03,$03,$03,$03,$03,$09
       34:8447  03 03 03  
       34:844A  03 09     
   45  34:844C  00 0A 0B          .db $00,$0A,$0B,$01,$01,$0C,$0E,$0F
       34:844F  01 01 0C  
       34:8452  0E 0F     
   46  34:8454  10                .db $10
   47                             ;extention to original
   48  34:8455  11                .db $11
   49  34:8456  12                .db $12
   50                     ;$843e
   51  34:8457            playEffect_handlers:
   52  34:8457  13 86             .dw $8613
   53  34:8459  77 85             .dw $8577
   54  34:845B  ED 85             .dw $85ed
   55  34:845D  76 85             .dw $8576       ;effect_for_command_00_01_0a_0b_0c_0d_0e        ;$8576
   56                     
   57  34:845F  B9 84             .dw playEffect_04       ;$853b
   58  34:8461  BD 84             .dw playEffect_05       ;$8540
   59  34:8463  B1 84             .dw playEffect_06       ;$8528
   60  34:8465  B5 84             .dw playEffect_07       ;$852d
   61                     
   62  34:8467  2A 85             .dw playEffect_08       ;$8516
   63  34:8469  1F 85             .dw playEffect_09       ;$850a
   64  34:846B  AD 84             .dw playEffect_0a       ;$8505
   65  34:846D  C1 84             .dw playEffect_0b       ;$84fb
   66                     
   67  34:846F  1B 85             .dw playEffect_0c               ;$84f6
   68  34:8471  FF 84             .dw playEffect_escape   ;$84d7
   69  34:8473  8B 84             .dw playEffect_die              ;$8470
   70  34:8475  7D 84             .dw playEffect_damage   ;$8460
   71                     
   72  34:8477  55 85             .dw $8555
   73  34:8479            playEffect_handlers_end:
   74                     ;$8460:
   75  34:8479  D5 B6             .dw playEffect_provoke
   76  34:847B  A1 B8             .dw playEffect_abyss
   77                             ;.ds $04 ;reserve 4bytes
   78                     ;------------------------------------------------------------------------------------------------------
   79                             ;.org   (playEffect_handlers_end + 4)
   80                             
   81  34:847D            playEffect_damage       ;effect 0f
   82           7EE1      .segmentatedEnemyGroup = $7ee1
   83           006E      .pActor = $6e
   84  34:847D  20 8A 86          jsr $868a       ;showDamage
   85  34:8480            .do_usually:
   86  34:8480  AD E1 7E          lda .segmentatedEnemyGroup
   87                             ;cmp #$ff
   88  34:8483  30 23             bmi playEffect_doReturn_00
   89  34:8485  85 7E                     sta <$7e
   90  34:8487  A9 0C                     lda #$0c
   91  34:8489  D0 3D                     bne playEffect_call_2e_9d53
   92                     
   93                     ;$34:8470 playEffect_0e
   94  34:848B            playEffect_die:
   95  34:848B  AD 9A 7E          lda play_effectTargetSide
   96  34:848E  10 06             bpl .actor_is_player
   97  34:8490  20 99 84                  jsr playEffect_0E_worker        ;$8481
   98  34:8493  4C CB 84                  jmp playEffect_8496
   99  34:8496            .actor_is_player:
  100  34:8496  20 CB 84          jsr playEffect_8496
  101                             ;fall through
  102  34:8499            playEffect_0E_worker:
  103  34:8499  A2 00             ldx #0
  104                             ;ldx #$f8
  105  34:849B            .loop:
  106                                     ;lda $78bb - $f8,x
  107                                     ;cmp $7d9b - $f8,x
  108  34:849B  BD BB 78                  lda $78bb,x
  109  34:849E  DD 9B 7D                  cmp $7d9b,x
  110  34:84A1  D0 06                     bne playEffect_present07
  111  34:84A3  E8                        inx
  112  34:84A4  E0 08                     cpx #8
  113  34:84A6  D0 F3                     bne .loop
  114  34:84A8            playEffect_doReturn_00:
  115  34:84A8  60                rts
  116                     
  117  34:84A9            playEffect_present07:
  118  34:84A9  A9 07             lda #$07
  119  34:84AB  D0 1B             bne playEffect_call_2e_9d53
  120                     
  121  34:84AD            playEffect_0a:  ;8505
  122  34:84AD  A9 1A             lda #$1a
  123  34:84AF  D0 12             bne playEffect_set52toActorAndCall
  124                     ;8528 effect06
  125  34:84B1            playEffect_06:  ;8528
  126  34:84B1  A9 15             lda #$15
  127  34:84B3  D0 0E             bne playEffect_set52toActorAndCall
  128                     ;852d effect07 {
  129  34:84B5            playEffect_07:  ;852d
  130  34:84B5  A9 18             lda #$18
  131  34:84B7  D0 0A             bne playEffect_set52toActorAndCall
  132                     
  133  34:84B9            playEffect_04: ;853b
  134  34:84B9  A9 04             lda #$04
  135  34:84BB  D0 06             bne playEffect_set52toActorAndCall 
  136                     
  137  34:84BD            playEffect_05:  ;8540
  138  34:84BD  A9 03             lda #$03
  139  34:84BF  D0 02             bne playEffect_set52toActorAndCall
  140                     
  141  34:84C1            playEffect_0b:
  142  34:84C1  A9 1B             lda #$1b
  143                     ;fall
  144  34:84C3            playEffect_set52toActorAndCall: ;84fd
  145  34:84C3  48                pha
  146  34:84C4  20 3C 85          jsr set52toIndexFromActorBit    ;8532
  147  34:84C7  68                pla
  148                     ;fall
  149  34:84C8            playEffect_call_2e_9d53:
  150  34:84C8  4C 0E FA          jmp call_2e_9d53
  151                     ;------------------------------------------------------------------------------------------------------
  152                     ;$34:8496
  153  34:84CB            playEffect_8496:
  154           7DA7      .enemyIds = $7da7
  155  34:84CB  A2 07             ldx #7
  156  34:84CD            .for_each_enemy:
  157  34:84CD  BC A7 7D                  ldy .enemyIds,x
  158  34:84D0  BD C4 7E                  lda effect_enemyStatus,x
  159  34:84D3  30 10                     bmi .dead
  160  34:84D5  C8                                iny
  161  34:84D6  D0 10                             bne .next
  162                                                     ;enemyId == #$ff
  163  34:84D8  20 F3 84                                  jsr playEffect_buildDeadBits
  164  34:84DB  A5 7E                                     lda <$7e
  165  34:84DD  49 FF                                     eor #$ff
  166  34:84DF  85 7E                                     sta <$7e
  167  34:84E1  A9 0B                                     lda #$0b
  168  34:84E3  D0 E3                                     bne playEffect_call_2e_9d53
  169  34:84E5                    .dead:
  170                                             ;cpy #$ff
  171                                             ;bne .do_die
  172  34:84E5  C8                                iny
  173  34:84E6  D0 04                             bne .do_die
  174  34:84E8                    .next:
  175  34:84E8  CA                        dex
  176  34:84E9  10 E2                     bpl .for_each_enemy
  177  34:84EB  60                rts
  178  34:84EC            .do_die:
  179  34:84EC  20 F3 84          jsr playEffect_buildDeadBits
  180  34:84EF  A9 0A             lda #$0a
  181  34:84F1  D0 D5             bne playEffect_call_2e_9d53
  182                             
  183  34:84F3            playEffect_buildDeadBits:       ;$84c7
  184           007E      .deadBits = $7e
  185  34:84F3  A2 07             ldx #7
  186  34:84F5            .loop:
  187  34:84F5  BD C4 7E                  lda effect_enemyStatus,x
  188  34:84F8  0A                        asl a
  189  34:84F9  66 7E                     ror <.deadBits
  190  34:84FB  CA                        dex
  191  34:84FC  10 F7                     bpl .loop
  192  34:84FE            playEffect_doReturn_01:
  193  34:84FE  60                rts
  194                     ;$84d7:
  195                     ;------------------------------------------------------------------------------------------------------
  196                     ;$34:84d7 playEffect_0d
  197  34:84FF            playEffect_escape:      ;0d
  198  34:84FF  AD 9A 7E          lda play_effectTargetSide
  199  34:8502  30 09             bmi .actor_enemy
  200  34:8504  AD D4 78                  lda $78d4
  201  34:8507  F0 F5                     beq playEffect_doReturn_01
  202  34:8509  A9 21                             lda #$21
  203  34:850B  D0 BB                             bne playEffect_call_2e_9d53
  204  34:850D            .actor_enemy:
  205  34:850D  20 45 85                  jsr $8545 ;dispatchPresenetScene_1f();
  206  34:8510  AD D4 78                  lda $78d4
  207  34:8513  F0 E9                     beq playEffect_doReturn_01
  208  34:8515  85 7E                             sta <$7e
  209  34:8517  A9 0D                             lda #$0d
  210  34:8519  D0 AD                             bne playEffect_call_2e_9d53
  211                     ;$84f6
  212                     ;------------------------------------------------------------------------------------------------------
  213                     ;$34:84f6 playEffect_0c
  214  34:851B            playEffect_0c:
  215  34:851B  A9 24             lda #$24
  216  34:851D  D0 A9             bne playEffect_call_2e_9d53
  217                     ;$84fb
  218                     ;------------------------------------------------------------------------------------------------------
  219  34:851F            playEffect_09:  ;850a
  220  34:851F  20 3C 85          jsr set52toIndexFromActorBit;8532
  221  34:8522  18                clc
  222  34:8523  AD 93 7E          lda $7e93
  223  34:8526  69 16             adc #$16
  224  34:8528  D0 9E             bne playEffect_call_2e_9d53
  225                     ;$8516
  226                     ;$34:8516 effect08
  227  34:852A            playEffect_08:  ;8516
  228  34:852A  20 3C 85          jsr set52toIndexFromActorBit
  229  34:852D  A2 01             ldx #1
  230  34:852F  20 AB 86          jsr targetBitToCharIndex
  231  34:8532  84 B8             sty <$b8
  232  34:8534  A9 19             lda #$19
  233  34:8536  20 0E FA          jsr call_2e_9d53
  234  34:8539  4C 89 86          jmp $8689
  235                             ;.org $8532
  236  34:853C            set52toIndexFromActorBit:       ;8532
  237  34:853C  A2 00             ldx #0
  238  34:853E  20 AB 86          jsr targetBitToCharIndex ;86ab
  239  34:8541  84 52             sty <$52
  240  34:8543  60                rts
  241                     ;8545
  242                     ;------------------------------------------------------------------------------------------------------
  243                     ;quickfix
  244           0035              .bank   $35
  245           BAD5              .org    $bad5
  246  35:BAD5  20 11 84                  jsr playEffect
  247           0034              .bank   $34
  248           858D              .org    $858d
  249  34:858D  20 3C 85                  jsr set52toIndexFromActorBit
  250           0034              .bank   $34
  251           85F0              .org    $85f0
  252  34:85F0  20 3C 85                  jsr set52toIndexFromActorBit
  253                     ;======================================================================================================
  254                             RESTORE_PC ff3_b34_play_effect_begin
                0035              .bank   BANK(ff3_b34_play_effect_begin)
                B60A              .org    ff3_b34_play_effect_begin
#[3]   ff3_hack_master.asm
#[4]   ff3_b30_invokeBattleFunction.asm
   55                                     .include "ff3_b30_invokeBattleFunction.asm"
    1                     ; ff3_b30_invokeBattleFunction.asm
    2                     ;
    3                     ;description:
    4                     ;       replaces invokeBattleFunction()
    5                     ;
    6                     ;version:
    7                     ;       0.03 (2006-11-07)
    8                     ;
    9                     ;======================================================================================================
   10  35:B60A            ff3_b30_invokeBattleFunction_begin:
   11                             INIT_PATCH $30,$9e58,$9e8a
                0030              .bank   $30
                9E58              .org    $9e58
       30:9E58                    .ds             (($9e8a) - ($9e58))
                9E58              .org    $9e58
   12  30:9E58            invokeBattleFunction:
   13                     ;       least value of S = $12 = $20 - ($0a + $06) (original:$14)
   14                     ;               (dungeon_mainLoop - dungeon_mainLoop - beginBattle - call_doBattle - battleLoop)
   15                     ;                       +(presentBattle - pb_disorderedShot)
   16                     ;                       +(getPlayerCommandInput - commandWindow_OnItem)
   17                     ;                       +(executeAction>command_fight - doCounter - command_fight_doFight)
   18                     ;[in]
   19           004C      .functionId = $4c
   20                     ;.pFunctions = $9e76
   21                     ;note: $18,19,1a are reserved!
   22  30:9E58  A5 4C             lda <.functionId
   23  30:9E5A  0A                asl a
   24  30:9E5B  AA                tax
   25  30:9E5C  BD 69 9E          lda .pFunctions,x
   26  30:9E5F  85 4C             sta <$4c
   27  30:9E61  BD 6A 9E          lda .pFunctions+1,x
   28  30:9E64  85 4D             sta <$4d
   29  30:9E66  6C 4C 00          jmp [$004c]
   30                     ;9e76
   31  30:9E69            .pFunctions:
   32  30:9E69  77 AF             .dw $af77       ;00 doSpecial
   33  30:9E6B  00 A4             .dw $a400       ;01 
   34  30:9E6D  32 A7             .dw $a732       ;02 decideEnemyAction
   35  30:9E6F  8A 9E             .dw $9e8a       ;03 doFight
   36  30:9E71  5E A6             .dw $a65e       ;04 useItem
   37  30:9E73  16 AA             .dw $aa16       ;05 calcBattleParams
   38  30:9E75  E9 A2             .dw $a2e9       ;06
   39  30:9E77  9D BE             .dw $be9d       ;07 calcDataAddress
   40  30:9E79  BF BE             .dw $bebf       ;08 rebuildBackpackItems
   41  30:9E7B  17 BF             .dw $bf17       ;09
   42                             ; end of originally implemented
   43  30:9E7D  5B A8             .dw pickRandomTargetFromEnemyParty      ;0a extra
   44  30:9E7F  28 BB             .dw getNumberOfRandomSuccess                    ;0b extra
   45  30:9E81  44 BB             .dw calcDamage                                          ;0c extra
   46                     ;$30:9e8a
   47                     ;======================================================================================================
   48                             RESTORE_PC ff3_b30_invokeBattleFunction_begin
                0035              .bank   BANK(ff3_b30_invokeBattleFunction_begin)
                B60A              .org    ff3_b30_invokeBattleFunction_begin
#[3]   ff3_hack_master.asm
   56                                     
#[4]   ff3_cmdx_provoke.asm
   57                                     .include "ff3_cmdx_provoke.asm"         ;consume( origin )
    1                     ; ff3_cmdx_provoke.asm
    2                     ;
    3                     ; description:
    4                     ;       implements 'provoke' command 
    5                     ;
    6                     ; version:
    7                     ;       0.16 (2007-08-13)
    8                     ;======================================================================================================
    9  35:B60A            ff3_cmdx_provoke_begin:
   10                     
   11                     ;======================================================================================================         
   12                     ;consumes space from origin
   13                     
   14           0001              .ifdef PROVOKE_TARGET_SINGLE
   15           A7C1      commandWindow_OnProvoke = commandWindow_selectSingleTargetAndNext
   16                             .else
   18                             .endif  
   19                     ;======================================================================================================
   20                     ;command handler
   21  35:B60A            cmdx_setupPresentParam:
   22                     ;[in] a : effectHanlderIndex
   23                     ;[in] x : actionId * 2
   24  35:B60A  8D C2 7E          sta effectHandlerIndex
   25  35:B60D  A9 00             lda #0
   26                     ;       sta play_castTargetBits
   27  35:B60F  8D 9B 7E          sta play_effectTargetBits
   28  35:B612  8D B8 7E          sta play_reflectedTargetBits
   29  35:B615  4C 57 A8          jmp setupActionType01
   30                     
   31           0001              .ifdef PROVOKE_TARGET_SINGLE
   32  35:B618            cmdx_provoke:
   33  35:B618            doProvokeSingle:
   34           006E      .pActor = $6e
   35           0070      .pTarget = $70
   36           0018      .flag = $18
   37           0022      .message = $22
   38           7E89      .effectApplyTarget = $7e89
   39           7E88      .actionIdForEffect = $7e88
   40                     
   41  35:B618  A9 19             lda #EFFECT_PROVOKE
   42  35:B61A  20 0A B6          jsr cmdx_setupPresentParam
   43                     
   44  35:B61D  A9 58             lda #EXMSG_PROVOKE_FAIL ;
   45  35:B61F  85 22             sta <.message
   46  35:B621  A0 2C             ldy #BP_OFFSET_INDEX_AND_MODE   ;$2c
   47  35:B623  B1 70             lda [.pTarget],y
   48  35:B625  48                pha
   49  35:B626  10 08             bpl .check_status
   50                             ;enemy
   51  35:B628  29 07                     and #7
   52  35:B62A  AA                        tax
   53  35:B62B  BD CD 7E                  lda indexToGroupMap,x
   54  35:B62E  30 51                     bmi .fail
   55  35:B630            .check_status:
   56  35:B630  20 27 9A          jsr isTargetActive
   57  35:B633  90 4C             bcc .fail
   58                             ;valid target
   59  35:B635  20 87 B6                  jsr hasProvokeSucceeded
   60  35:B638  B0 47                     bcs .fail
   61                                     ;succeeded
   62  35:B63A  20 2E A4                          jsr getActor2C
   63  35:B63D  29 E7                             and #$e7
   64  35:B63F  85 18                             sta <.flag
   65  35:B641  A0 30                             ldy #BP_OFFSET_TARGET_FLAG      ;$30
   66  35:B643  B1 70                             lda [.pTarget],y
   67  35:B645  29 40                             and #TARGET_MULTIPLE    ;$40    ;multiple target
   68  35:B647  D0 11                             bne .set_provoked
   69                                                     ;single target
   70  35:B649  A5 18                                     lda <.flag
   71  35:B64B  29 07                                     and #7
   72  35:B64D  AA                                        tax
   73  35:B64E  A9 00                                     lda #0
   74  35:B650  91 70                                     sta [.pTarget],y
   75  35:B652  20 20 FD                                  jsr flagTargetBit
   76  35:B655  88                                        dey
   77  35:B656  91 70                                     sta [.pTarget],y        ;2f
   78  35:B658  85 18                                     sta <.flag
   79  35:B65A                            .set_provoked:
   80           0001                      .ifdef TAG_PROVOKE_EFFECT
   81  35:B65A  68                                pla     ;target2c
   82  35:B65B  48                                pha
   83  35:B65C  10 0B                             bpl .set_effect_bit
   84  35:B65E  A0 1E                                     ldy #X_BP_OFFSET_PARAM  ;right atk
   85  35:B660  A5 18                                     lda <.flag
   86  35:B662  91 70                                     sta [.pTarget],y
   87  35:B664  C8                                        iny
   88  35:B665  A9 13                                     lda #$10 | PROVOKE_EFFECT_REMAIN ;extra effect 1 | effect remains 3 phases
   89  35:B667  91 70                                     sta [.pTarget],y
   90                                     .endif ;TAG_PROVOKE_EFFECT
   91  35:B669                            .set_effect_bit:
   92  35:B669  68                                pla
   93  35:B66A  48                                pha
   94  35:B66B  29 07                             and #7
   95  35:B66D  AA                                tax
   96  35:B66E  AD 9B 7E                          lda play_effectTargetBits
   97  35:B671  20 20 FD                          jsr flagTargetBit
   98  35:B674  8D 9B 7E                          sta play_effectTargetBits
   99  35:B677  A0 28                             ldy #BP_OFFSET_CRITICAL_RATE    ;$28 (critical rate)
  100  35:B679  A9 4B                             lda #PROVOKE_CRITICAL_RATE
  101  35:B67B  91 70                             sta [.pTarget],y
  102                                     ;
  103  35:B67D  A9 57                             lda #EXMSG_PROVOKE_SUCCESS      ;
  104  35:B67F  85 22                             sta <.message
  105  35:B681            .fail:
  106  35:B681  68                pla     ;dispose (target 2c)
  107                             ;lda <.message
  108                             ;ldx $78ee
  109                             ;sta $78da,x    ;message
  110  35:B682  A5 22             lda <.message
  111  35:B684  4C BF 9F          jmp addBattleMessage
  112                     ;------------------------------------------------------------------------------------------------------
  113                             .else   ;ifdef PROVOKE_TARGET_SINGLE
  189                             .endif ;PROVOKE_TARGET_SINGLE
  190                     
  191  35:B687            hasProvokeSucceeded:
  192           0023      .penalty = $23
  193           0023      .rate = $23
  194           006E      .pActor = $6e
  195           0070      .pTarget = $70
  196                     
  197  35:B687  A0 0F             ldy #$0f
  198  35:B689  B1 6E             lda [.pActor],y ;joblv
  199  35:B68B  A0 00             ldy #0
  200  35:B68D  84 23             sty <.penalty
  201  35:B68F  18                clc
  202  35:B690  71 6E             adc [.pActor],y ;lv
  203  35:B692  18                clc
  204  35:B693  69 64             adc #PROVOKE_BASE_SUCCESS_RATE
  205  35:B695  90 02             bcc .calc_shield_penalty
  206  35:B697  A9 FF                     lda #$ff
  207  35:B699            .calc_shield_penalty:
  208  35:B699  48                pha
  209  35:B69A  B1 70             lda [.pTarget],y        ;lv
  210  35:B69C  48                pha
  211  35:B69D  A0 31             ldy #$31
  212  35:B69F  B1 6E             lda [.pActor],y ;righthand flag
  213  35:B6A1  10 04             bpl .check_left
  214  35:B6A3  A9 14                     lda #PROVOKE_SHIELD_PENALTY
  215  35:B6A5  85 23                     sta <.penalty
  216  35:B6A7            .check_left:
  217  35:B6A7  A0 32             ldy #$32
  218  35:B6A9  B1 6E             lda [.pActor],y ;lefthand flag
  219  35:B6AB  18                clc
  220  35:B6AC  10 06             bpl .store_penalty
  221  35:B6AE  A5 23                     lda <.penalty
  222  35:B6B0  69 14                     adc #PROVOKE_SHIELD_PENALTY
  223  35:B6B2  85 23                     sta <.penalty
  224  35:B6B4            .store_penalty: 
  225  35:B6B4  68                pla
  226  35:B6B5  65 23             adc <.penalty
  227  35:B6B7  85 23             sta <.penalty
  228  35:B6B9  68                pla
  229  35:B6BA  38                sec
  230  35:B6BB  E5 23             sbc <.penalty
  231  35:B6BD  B0 02             bcs .store_rate
  232  35:B6BF  A9 01                     lda #1
  233  35:B6C1            .store_rate:
  234  35:B6C1  85 23             sta <.rate
  235                             ;check for position
  236  35:B6C3  A0 33             ldy #$33
  237  35:B6C5  B1 6E             lda [.pActor],y
  238  35:B6C7  29 01             and #1
  239  35:B6C9  F0 02             beq .get_rand
  240  35:B6CB  46 23                     lsr <.rate
  241  35:B6CD            .get_rand:              
  242  35:B6CD  A9 64             lda #100
  243  35:B6CF  20 64 A5          jsr getSys1Random
  244  35:B6D2  C5 23             cmp <.rate
  245  35:B6D4  60                rts
  246                     ;======================================================================================================
  247  35:B6D5            playEffect_provoke:
  248  35:B6D5  E6 CC             inc <$cc        ;prevent cast motion
  249                     
  250  35:B6D7  A9 0F             lda #15         ;'yyyaaa'
  251  35:B6D9  85 CA             sta <soundEffectId
  252  35:B6DB  A9 20             lda #$20        ;'confuse'
  253  35:B6DD  8D 88 7E          sta $7e88       ;effect id
  254                             ;lda play_castTargetBits        
  255                             ;sta $7e89      ;target bits
  256  35:B6E0  A9 00             lda #0          ;effect type 0='normal (play on each target)'
  257  35:B6E2  8D 9D 7E          sta $7e9d
  258  35:B6E5  20 3C 85          jsr set52toIndexFromActorBit    ;$8532
  259  35:B6E8  A9 1D             lda #$1d        ;magic (funcid)
  260  35:B6EA  4C 0E FA          jmp call_2e_9d53
  261                     ;======================================================================================================
  262  35:B6ED            ff3_cmdx_provoke_end:
  263                     ;       RESTORE_PC ff3_cmdx_provoke_begin
#[3]   ff3_hack_master.asm
#[4]   ff3_cmdx_disordered_shot.asm
   58                                     .include "ff3_cmdx_disordered_shot.asm" ;consume( origin )
    1                     ; ff3_cmdx_disordered_shot.asm
    2                     ;
    3                     ; description:
    4                     ;       implements 'disordered shot' command 
    5                     ;
    6                     ; version:
    7                     ;       0.10 (2007-08-13)
    8                     ;======================================================================================================
    9  35:B6ED            ff3_cmdx_disorderedShot_begin:
   10                     
   11                     ;------------------------------------------------------------------------------------------------------
   12                             RESTORE_PC pb_handlers_ex
                0034              .bank   BANK(pb_handlers_ex)
                9560              .org    pb_handlers_ex
   13  34:9560  07 B7                     .dw pbx_doDisorderedShot
   14                     ;------------------------------------------------------------------------------------------------------
   15           7450      cmdx_ds_damages = $7450 ;TEMP_RAM+$f0   ;$0110
   16                     ;cmdx_ds_missFlags = cmdx_ds_damages + $20
   17           744F      cmdx_ds_count = cmdx_ds_damages - 1
   18                     
   19                     ;------------------------------------------------------------------------------------------------------
   20                             RESTORE_PC ff3_cmdx_disorderedShot_begin
                0035              .bank   BANK(ff3_cmdx_disorderedShot_begin)
                B6ED              .org    ff3_cmdx_disorderedShot_begin
   21                     ;consumes space from origin
   22           A7D7      commandWindow_OnDisorderedShot = commandWindow_decideReturn
   23                             ;nothing to do
   24                     ;------------------------------------------------------------------------------------------------------
   25  35:B6ED            cmdx_disorderedShot:
   26                             ;setup action params
   27  35:B6ED  A9 06             lda #BATTLE_PROCESS_EX_DISORDERED_SHOT
   28  35:B6EF  8D D5 78          sta battleProcessType   ;$78d5
   29                             
   30  35:B6F2  A9 50             lda #$39+CMDX_DISORDERED_SHOT
   31  35:B6F4  8D D7 78          sta actionName  ;action name
   32                             
   33  35:B6F7  A2 03             ldx #3
   34  35:B6F9  8E 4F 74          stx cmdx_ds_count       ;count
   35  35:B6FC            cmdx_initDamageCache:
   36  35:B6FC  A9 00             lda #$00
   37  35:B6FE  A2 3F             ldx #($40-1)
   38  35:B700            .init_tag:
   39  35:B700  9D 50 74                  sta cmdx_ds_damages,x
   40  35:B703  CA                        dex
   41  35:B704  10 FA                     bpl .init_tag
   42  35:B706  60                rts
   43                     ;------------------------------------------------------------------------------------------------------
   44  35:B707            pbx_doDisorderedShot:
   45           0064      .iCommand = $64
   46           0052      .index = $52
   47           006E      .pActor = $6e
   48                     
   49  35:B707  A5 62             lda <$62
   50  35:B709  48                pha
   51  35:B70A  A5 63             lda <$63
   52  35:B70C  48                pha
   53                     
   54  35:B70D  A5 64             lda <.iCommand
   55  35:B70F  48                pha
   56                     
   57  35:B710  A2 03             ldx #3
   58  35:B712            .reduce_atk_hit:
   59  35:B712  86 52             stx <.index
   60  35:B714  BD F9 B7          lda disorderedShot_offsets,x
   61                             ;weaken attack properties
   62  35:B717  A8                        tay
   63  35:B718  B1 6E                     lda [.pActor],y
   64  35:B71A  48                        pha
   65  35:B71B  AA                        tax
   66                                     
   67  35:B71C  98                        tya
   68  35:B71D  48                        pha
   69  35:B71E  A0 0F                     ldy #$0f        ;joblv
   70  35:B720  B1 6E                     lda [.pActor],y
   71  35:B722  4A                        lsr a
   72  35:B723  4A                        lsr a
   73  35:B724  18                        clc
   74  35:B725  69 46                     adc #DISORDERED_SHOT_BASE_RATE
   75  35:B727  20 EA F8                  jsr mul_8x8_reg
   76  35:B72A  85 18                     sta <$18        ;low
   77  35:B72C  86 19                     stx <$19        ;high
   78  35:B72E  A9 64                     lda #$64        ;
   79  35:B730  85 1A                     sta <$1a
   80  35:B732  A9 00                     lda #0
   81  35:B734  85 1B                     sta <$1b
   82  35:B736  20 92 FC                  jsr div_16
   83                                     ;$1c = value * (70 + joblv/4) / 100
   84  35:B739  68                        pla
   85  35:B73A  A8                        tay
   86  35:B73B  A5 1C                     lda <$1c
   87  35:B73D  91 6E                     sta [.pActor],y
   88                             ;
   89  35:B73F  A6 52             ldx <.index
   90  35:B741  CA                dex
   91  35:B742  10 CE             bpl .reduce_atk_hit
   92                     
   93           0001              .ifdef FAST_DISORDERED_SHOT
   94                     ;v0.6.1
   95  35:B744  A9 09                     lda #$09
   96  35:B746  20 B9 9C                  jsr setIndexAndCallPresentScene
   97                             .endif ;FAST_DISORDERED_SHOT
   98                     
   99  35:B749            disorderedShot_attackRandomTarget:
  100           006E      .pActor = $6e
  101           0062      .targetBit = $62
  102  35:B749  20 F3 9F          jsr initActorDamages    ;workaround
  103                     
  104  35:B74C  A0 30             ldy #$30
  105  35:B74E  A9 80             lda #$80        ;enemy
  106  35:B750  91 6E             sta [.pActor],y
  107                     
  108  35:B752  4A                lsr a   ;lda #$40       ;actor player | target enemy
  109  35:B753  8D 9A 7E          sta play_effectTargetSide
  110                             
  111  35:B756  88                dey
  112  35:B757  88                dey
  113  35:B758  A9 04             lda #$04        ;fight
  114  35:B75A  91 6E             sta [.pActor],y
  115                     
  116  35:B75C  20 B4 9F          jsr setXtoActorIndex16
  117  35:B75F  B5 F0             lda <$f0,x
  118  35:B761  30 4D             bmi disorderedShot_finish
  119                     ;x=ff
  120  35:B763  20 DA A0          jsr invokePickRandomTarget
  121                     
  122  35:B766  A5 62             lda <.targetBit
  123  35:B768  F0 46             beq disorderedShot_finish
  124                     
  125  35:B76A            .valid_target:
  126  35:B76A  8A                txa
  127  35:B76B  48                pha     ;target index
  128                     
  129  35:B76C  20 04 A1          jsr command_fight
  130  35:B76F  68                pla
  131  35:B770  48                pha     ;target index
  132  35:B771  20 8A B8          jsr cmdx_sumDamagesOfTargetAndActor
  133                     
  134  35:B774            .done_hp:
  135                     ;------------------------------------------------------------------------------------------------------
  136  35:B774            effect_disorderedShot:
  137                     ;[in]
  138                     ;.actorBits = $7e98
  139           0052      .iPlayer = $52
  140           00B8      .blowTarget = $b8
  141           00BB      .hitCount_right = $bb
  142           00BC      .hitCount_left = $bc
  143                     
  144  35:B774  A2 00             ldx #0
  145  35:B776  8E 96 7E          stx play_arrowTarget
  146                     
  147  35:B779  68                pla     ;target index
  148  35:B77A  85 B8             sta <.blowTarget
  149                     
  150           0001              .ifdef FAST_DISORDERED_SHOT
  151  35:B77C  A9 26                     lda #PRESENT_SCENE_EX_BLOWONLY
  152  35:B77E  20 B9 9C                  jsr setIndexAndCallPresentScene
  153                             .else
  158                             .endif ;FAST_DISORDERED_SHOT
  159                     
  160  35:B781  20 C3 9C          jsr updateTargetStatusByCache
  161                     ;------------------------------------------------------------------------------------------------------
  162  35:B784            pbx_loopDisorderedShot:
  163                     
  164  35:B784  AD E1 7E          lda play_segmentedGroup
  165  35:B787  30 0C             bmi .not_segmented
  166  35:B789  85 7E                     sta <$7e
  167  35:B78B  A9 0C                     lda #$0c
  168  35:B78D  20 0E FA                  jsr call_2e_9d53
  169  35:B790  A9 FF                     lda #$ff
  170  35:B792  8D E1 7E                  sta play_segmentedGroup
  171                     
  172  35:B795            .not_segmented:
  173  35:B795  AE 4F 74          ldx cmdx_ds_count
  174  35:B798  CA                dex
  175  35:B799  30 15             bmi disorderedShot_finish
  176  35:B79B  8E 4F 74                  stx cmdx_ds_count
  177                     
  178  35:B79E                    .find_end_of_message:
  179  35:B79E  AE EE 78                          ldx battleMessageCount
  180  35:B7A1  BD DA 78                          lda battleMessages,x
  181  35:B7A4  C9 FF                             cmp #$ff
  182  35:B7A6  F0 05                             beq .message_ok
  183  35:B7A8  EE EE 78                          inc battleMessageCount
  184  35:B7AB  D0 F1                             bne .find_end_of_message
  185  35:B7AD                    .message_ok:
  186  35:B7AD  4C 49 B7                  jmp disorderedShot_attackRandomTarget
  187                     
  188  35:B7B0            disorderedShot_finish:
  189           0064      .iCommand = $64
  190           004B      .commandId = $4b
  191           006E      .pActor = $6e
  192           0001              .ifdef FAST_DISORDERED_SHOT
  193  35:B7B0  A9 08                     lda #$08
  194  35:B7B2  20 B9 9C                  jsr setIndexAndCallPresentScene
  195                             .endif ;FAST_DISORDERED_SHOT
  196                     
  197  35:B7B5  20 A3 90          jsr pb_showEffectMessage
  198                             
  199           0001              .ifdef SHOW_INFO_ON_DISORDERED_SHOT
  200                     
  201  35:B7B8  20 3F 92          jsr pb_showDamage
  202  35:B7BB  20 47 92          jsr pb_showDyingEffect
  203  35:B7BE  A2 00             ldx #0
  204  35:B7C0  8E EE 78          stx battleMessageCount
  205  35:B7C3            .show_messages:
  206  35:B7C3  20 3A 90                  jsr pb_initString
  207  35:B7C6  20 47 91                  jsr pb_showInfoMessage
  208  35:B7C9  20 F2 92                  jsr pb_waitConfirmOrTimeout
  209                                     
  210  35:B7CC  A9 04                     lda #$04
  211  35:B7CE  85 4B                     sta <.commandId
  212  35:B7D0  20 D6 94                  jsr pb_closeWindow
  213                             
  214  35:B7D3  AE EE 78                  ldx battleMessageCount
  215  35:B7D6  BD DA 78                  lda battleMessages,x
  216  35:B7D9  C9 FF                     cmp #$ff
  217  35:B7DB  D0 E6             bne .show_messages
  218                     
  219  35:B7DD  A9 03             lda #$03
  220  35:B7DF  85 4B             sta <.commandId
  221  35:B7E1  20 D6 94          jsr pb_closeWindow
  222                     
  223                             .endif  ;SHOW_INFO_ON_DISORDERED_SHOT
  224                     ;restore
  225  35:B7E4  A2 FC             ldx #$fc
  226  35:B7E6            .restore_atk_hit:
  227  35:B7E6  BC FD B6                  ldy disorderedShot_offsets-$fc,x
  228  35:B7E9  68                        pla
  229  35:B7EA  91 6E                     sta [.pActor],y
  230  35:B7EC  E8                        inx
  231  35:B7ED  D0 F7                     bne .restore_atk_hit
  232                     ;restore ptr
  233  35:B7EF  68                pla
  234  35:B7F0  85 64             sta <.iCommand
  235  35:B7F2  68                pla
  236  35:B7F3  85 63             sta <$63
  237  35:B7F5  68                pla
  238  35:B7F6  85 62             sta <$62
  239                     
  240  35:B7F8  60                rts
  241                     
  242  35:B7F9            disorderedShot_offsets:
  243  35:B7F9  18 19 1D          .db $18,$19,$1d,$1e
       35:B7FC  1E        
  244                     ;======================================================================================================
  245                     
  246  35:B7FD            cmdx_sumDamage:
  247                     ;[in] a : index
  248                     ;[out] carry : 1=damage0 
  249           00E0      .statusCache = $e0
  250           0018      .low = $18
  251  35:B7FD  0A                asl a
  252  35:B7FE  AA                tax
  253                     
  254  35:B7FF  BD 4F 7E          lda play_damages,x
  255  35:B802  A8                tay
  256                     
  257  35:B803  BD 50 7E          lda play_damages+1,x
  258  35:B806  48                pha
  259  35:B807  C9 FF             cmp #$ff
  260  35:B809  D0 05             bne .valid_damage
  261  35:B80B  68                        pla
  262  35:B80C  A9 00                     lda #0
  263  35:B80E  A8                        tay
  264  35:B80F  48                        pha
  265  35:B810            .valid_damage:
  266  35:B810  68                pla
  267  35:B811  29 BF             and #$bf        ;clear miss
  268  35:B813  10 03             bpl .not_heal
  269  35:B815  20 7C B8                  jsr .neg15_y_a
  270  35:B818            .not_heal:
  271  35:B818  48                pha     ;high
  272  35:B819  18                clc
  273  35:B81A  98                tya
  274  35:B81B  7D 50 74          adc cmdx_ds_damages,x
  275  35:B81E  A8                tay     ;low
  276  35:B81F  68                pla     ;high
  277  35:B820  7D 51 74          adc cmdx_ds_damages+1,x
  278  35:B823            .check_negative:
  279  35:B823  10 03             bpl .result_damage
  280                     ;healed
  281  35:B825  20 7C B8                  jsr .neg15_y_a
  282  35:B828            .result_damage:
  283  35:B828  48                pha
  284  35:B829  98                tya
  285  35:B82A  38                sec
  286  35:B82B  E9 10             sbc #LOW(10000)
  287  35:B82D  68                pla
  288  35:B82E  48                pha
  289  35:B82F  29 7F             and #$7f
  290  35:B831  E9 27             sbc #HIGH(10000)
  291  35:B833  90 08             bcc .store_result
  292  35:B835  A0 0F                     ldy #LOW(9999)
  293  35:B837  68                        pla
  294  35:B838  29 80                     and #$80
  295  35:B83A  09 27                     ora #HIGH(9999)
  296  35:B83C  48                        pha
  297  35:B83D            .store_result:
  298  35:B83D  98                tya
  299  35:B83E  9D 4F 7E          sta play_damages,x
  300  35:B841  68                pla
  301  35:B842  48                pha
  302  35:B843  1D 4F 7E          ora play_damages,x
  303  35:B846  D0 20             bne .store_high
  304                                     ;result0. heal0 or miss
  305  35:B848  BD 50 7E                  lda play_damages+1,x
  306  35:B84B  C9 FF                     cmp #$ff
  307  35:B84D  D0 02                     bne .not_missed
  308  35:B84F  A9 00                             lda #0
  309  35:B851                    .not_missed:
  310  35:B851  29 BF                     and #$bf
  311  35:B853  1D 50 74                  ora cmdx_ds_damages,x
  312  35:B856  1D 51 74                  ora cmdx_ds_damages+1,x
  313  35:B859  D0 09                     bne .heal_0pt
  314  35:B85B                    .miss:
  315  35:B85B  38                                sec
  316  35:B85C  A9 40                             lda #$40
  317  35:B85E  9D 50 7E                          sta play_damages+1,x
  318  35:B861  68                                pla
  319  35:B862  F0 09                             beq .check_result_negative
  320  35:B864                    .heal_0pt:
  321                                             ;heal 0pt
  322  35:B864  68                                pla
  323  35:B865  A9 80                             lda #$80
  324  35:B867  48                                pha
  325  35:B868            .store_high:
  326  35:B868  18                clc     ;result (miss flag)
  327  35:B869  68                pla
  328  35:B86A  9D 50 7E          sta play_damages+1,x
  329  35:B86D            .check_result_negative:
  330  35:B86D  10 05             bpl .store_cache
  331  35:B86F  20 7C B8                  jsr .neg15_y_a
  332  35:B872  09 80                     ora #$80
  333  35:B874            .store_cache:
  334  35:B874  9D 51 74          sta cmdx_ds_damages+1,x
  335  35:B877  98                tya
  336  35:B878  9D 50 74          sta cmdx_ds_damages,x
  337  35:B87B  60                rts
  338  35:B87C            .neg15_y_a:
  339                     ;[in] a : high, y: low
  340  35:B87C  48                pha
  341  35:B87D  98                tya
  342  35:B87E  49 FF             eor #$ff
  343  35:B880  18                clc
  344  35:B881  69 01             adc #1
  345  35:B883  A8                tay
  346  35:B884  68                pla
  347  35:B885  49 7F             eor #$7f
  348  35:B887  69 00             adc #0
  349                             ;
  350                             ;ora #$80
  351  35:B889  60                rts
  352                     
  353  35:B88A            cmdx_sumDamagesOfTargetAndActor:
  354                     ;[in] a = target index
  355  35:B88A  20 FD B7          jsr cmdx_sumDamage
  356                             ;fall through
  357  35:B88D            cmdx_sumActorDamage:
  358  35:B88D  20 AD 9F          jsr setXtoActorIndex
  359  35:B890  18                clc
  360  35:B891  69 08             adc #8
  361  35:B893  20 FD B7          jsr cmdx_sumDamage
  362  35:B896  90 08             bcc .finish
  363                                     ;actor's hp not varied
  364  35:B898  A9 FF                     lda #$ff
  365  35:B89A  9D 50 7E                  sta play_damages+1,x
  366  35:B89D  9D 4F 7E                  sta play_damages,x
  367  35:B8A0            .finish:
  368  35:B8A0  60                rts
  369                     ;-------------------------------------------------------------------------------------------------------
  370                     ;$b979
  371  35:B8A1            ff3_cmdx_disorderedShot_end:
  372                             VERIFY_PC ff3_magic_window_free_end
       35:B8A1                    .verify_pc_00109:
                0000              .if (.verify_pc_00109 > ff3_magic_window_free_end)
                                  .endif
  373                             ;.if ff3_cmdx_disorderedShot_end > ff3_magic_window_free_end
  374                             ;       .fail
  375                             ;.endif
#[3]   ff3_hack_master.asm
#[4]   ff3_cmdx_abyss.asm
   59                                     .include "ff3_cmdx_abyss.asm"   ;consume( origin , pb_free )
    1                     ; ff3_cmdx_abyss.asm
    2                     ;
    3                     ; description:
    4                     ;       implements 'abyss' command 
    5                     ;
    6                     ; version:
    7                     ;       0.03 (2006-11-12)
    8                     ;======================================================================================================
    9  35:B8A1            ff3_cmdx_abyss_begin:
   10                     
   11           0001              .ifdef GIVE_EVILSWORDMAN_ABYSS
   12                     ;======================================================================================================
   13           A7B6      commandWindow_OnAbyss = commandWindow_decideToTargetAll
   14                     ;------------------------------------------------------------------------------------------------------
   15                     ;consumes space
   16                             RESTORE_PC pb_free_begin
                0034              .bank   BANK(pb_free_begin)
                9310              .org    pb_free_begin
   17                     
   18  34:9310            calcAbyss:
   19           006E      .pActor = $6e
   20           0070      .pTarget = $70  ;in,const
   21           007C      .count = $7c
   22           0024      .rate = $24
   23           0025      .try = $25
   24           0025      .atkLow = $25
   25           0026      .def = $26
   26           0027      .attr = $27
   27           0028      .bonus = $28
   28           0029      .bonusMul = $29
   29           002A      .divide = $2a
   30           002B      .atkHigh = $2b
   31           0030      .succeeded = $30
   32           00E0      .targetCache = $e0
   33                     
   34  34:9310  A0 13             ldy #$13        ;mevade count
   35  34:9312  B1 70             lda [.pTarget],y
   36  34:9314  85 25             sta <.try
   37  34:9316  C8                iny
   38  34:9317  B1 70             lda [.pTarget],y
   39  34:9319  85 24             sta <.rate
   40  34:931B  20 BB 93          jsr .callGetRandomSucceededCount
   41                     ;       威力 = 75 + 熟練度 + 精神
   42  34:931E  A0 0F             ldy #$0f
   43  34:9320  B1 6E             lda [.pActor],y
   44  34:9322  48                pha
   45  34:9323  18                clc
   46  34:9324  69 4B             adc #75
   47                             ;sta <.atkLow
   48                     
   49  34:9326  C8                iny
   50  34:9327  C8                iny
   51  34:9328  71 6E             adc [.pActor],y
   52  34:932A  90 02             bcc .store_atk
   53  34:932C  A9 FF                     lda #$ff
   54  34:932E            .store_atk
   55  34:932E  85 25             sta <.atkLow
   56                     ;       回数 = 1 + 熟練度/16 + 精神/8
   57  34:9330  B1 6E             lda [.pActor],y
   58  34:9332  4A                lsr a
   59  34:9333  4A                lsr a
   60  34:9334  4A                lsr a
   61  34:9335  85 7C             sta <.count
   62  34:9337  68                pla     ;joblv
   63  34:9338  4A                lsr a
   64  34:9339  4A                lsr a
   65  34:933A  4A                lsr a
   66  34:933B  4A                lsr a
   67  34:933C  38                sec
   68  34:933D  65 7C             adc <.count
   69                             ;adc #2
   70  34:933F  38                sec
   71  34:9340  E5 30             sbc <.succeeded
   72  34:9342  B0 02             bcs .store_count
   73  34:9344  A9 00                     lda #0
   74  34:9346            .store_count:
   75  34:9346  85 7C             sta <.count
   76                     ;
   77  34:9348  A0 15             ldy #$15
   78  34:934A  B1 70             lda [.pTarget],y
   79  34:934C  85 26             sta <.def
   80                     ;attr check
   81  34:934E  A2 00             ldx #0
   82  34:9350  86 28             stx <.bonus
   83  34:9352  86 29             stx <.bonusMul
   84  34:9354  86 2B             stx <.atkHigh
   85  34:9356  E8                inx
   86  34:9357  86 2A             stx <.divide    ;1
   87  34:9359  E8                inx
   88                     
   89  34:935A  A0 20             ldy #$20
   90  34:935C  B1 70             lda [.pTarget],y
   91  34:935E  29 02             and #$02        ;dark
   92  34:9360  F0 02             beq .not_strong
   93  34:9362  A2 01                     ldx #1
   94  34:9364            .not_strong:
   95  34:9364  A0 12             ldy #$12
   96  34:9366  B1 70             lda [.pTarget],y
   97  34:9368  29 02             and #$02        ;dark
   98  34:936A  F0 02             beq .not_weak
   99  34:936C  A2 04                     ldx #4
  100  34:936E            .not_weak:
  101                             ;x = 1(strong) 2(normal) 4(weak)
  102  34:936E  86 27             stx <.attr
  103                             ;calcDamage(hitcount:$7c, atk:$25,2b, def:$26, 
  104                             ;       attr:$27, bonus:$28, bonusMul:$29, divide:$2a);
  105  34:9370  20 BF 93          jsr .callCalcDamage
  106           001C      .resultDamage = $1c
  107  34:9373  20 A6 9F          jsr setXtoTargetIndex
  108                     ;flag target
  109  34:9376  AD 9B 7E          lda play_effectTargetBits
  110  34:9379  20 20 FD          jsr flagTargetBit
  111  34:937C  8D 9B 7E          sta play_effectTargetBits
  112                     
  113  34:937F  8A                txa
  114  34:9380  0A                asl a
  115  34:9381  AA                tax
  116  34:9382  A5 1C             lda <.resultDamage
  117  34:9384  9D 4F 7E          sta play_damages,x
  118  34:9387  A5 1D             lda <.resultDamage+1
  119  34:9389  9D 50 7E          sta play_damages+1,x
  120                     ;apply damage
  121  34:938C  A0 03             ldy #3
  122  34:938E  38                sec
  123  34:938F  B1 70             lda [.pTarget],y
  124  34:9391  E5 1C             sbc <.resultDamage
  125  34:9393  91 70             sta [.pTarget],y
  126  34:9395  C8                iny
  127  34:9396  B1 70             lda [.pTarget],y
  128  34:9398  E5 1D             sbc <.resultDamage+1
  129  34:939A  91 70             sta [.pTarget],y
  130  34:939C  88                dey
  131  34:939D  11 70             ora [.pTarget],y
  132  34:939F  F0 02             beq .target_dead
  133  34:93A1  B0 0B             bcs .remove_segmenting_abiliy
  134  34:93A3            .target_dead:
  135                                     ;result minus (target dead)
  136  34:93A3  A9 00                     lda #0
  137  34:93A5  91 70                     sta [.pTarget],y
  138  34:93A7  C8                        iny
  139  34:93A8  91 70                     sta [.pTarget],y
  140  34:93AA  A9 80                     lda #$80
  141  34:93AC  95 E0                     sta <.targetCache,x
  142  34:93AE            .remove_segmenting_abiliy:
  143                             ;
  144  34:93AE  A0 38             ldy #$38
  145  34:93B0  B1 70             lda [.pTarget],y        ;actionId[0]
  146  34:93B2  C9 4F             cmp #$4f        ;4f:segment
  147  34:93B4  D0 04             bne .finish
  148                             ;remove target's segmenting ability
  149  34:93B6  A9 34                     lda #$34        ;34: care
  150  34:93B8  91 70                     sta [.pTarget],y
  151  34:93BA            .finish:
  152  34:93BA  60                rts
  153  34:93BB            .callGetRandomSucceededCount:
  154  34:93BB  A9 0B             lda #BF_GET_RANDOM_SUCCEEDED_COUNT
  155  34:93BD  D0 02             bne .call
  156  34:93BF            .callCalcDamage:
  157  34:93BF  A9 0C             lda #BF_CALC_DAMAGE
  158  34:93C1            .call:
  159           004C      .functionId = $4c
  160  34:93C1  85 4C             sta <.functionId
  161  34:93C3  4C F3 FD          jmp invoke_b30_battleFunction   ;fdf3
  162  34:93C6            calcAbyss_end:
  163                     ;------------------------------------------------------------------------------------------------------
  164                     ;consumes space from origin
  165                             RESTORE_PC ff3_cmdx_abyss_begin
                0035              .bank   BANK(ff3_cmdx_abyss_begin)
                B8A1              .org    ff3_cmdx_abyss_begin
  166  35:B8A1            playEffect_abyss:
  167           00CC      .castFlag = $cc
  168  35:B8A1  E6 CC             inc <.castFlag  ;prevent cast
  169                             ;inc <$cb       ;critical flag?
  170  35:B8A3  A9 0B             lda #$0b
  171                             ;lda #$00
  172  35:B8A5  8D 9D 7E          sta play_magicType      ;7e9d
  173                             ;lda #$10       ;'dimension'
  174  35:B8A8  A9 4A             lda #$4a        ;mega flare
  175                             ;lda #$68
  176  35:B8AA  8D 88 7E          sta $7e88       ;effect id
  177                     
  178                     
  179                             ;lda #$4a       ;wavecannon
  180                             ;lda #$11       ;death
  181  35:B8AD  A9 47             lda #$47        ;sound of dimension
  182                             ;lda #$22
  183  35:B8AF  85 CA             sta <soundEffectId
  184                             
  185  35:B8B1  A9 27             lda #PRESENT_SCENE_EX_ABYSS
  186  35:B8B3  20 B9 9C          jsr setIndexAndCallPresentScene
  187  35:B8B6  A9 00             lda #0
  188  35:B8B8  85 CC             sta <.castFlag
  189  35:B8BA  60                rts
  190                     ;------------------------------------------------------------------------------------------------------
  191  35:B8BB            cmdx_abyss:
  192           006E      .pActor = $6e
  193           00F0      .actorStatusCache = $f0
  194  35:B8BB  A9 1A             lda #EFFECT_ABYSS
  195                     ;       sta effectHandlerIndex
  196  35:B8BD  20 0A B6          jsr cmdx_setupPresentParam
  197                     
  198                     ;main calcs
  199           0070      .pTarget = $70
  200                             INIT16 <.pTarget,$7835
       35:B8C0  A9 35             lda #LOW($7835)
       35:B8C2  85 70             sta <.pTarget
       35:B8C4  A9 78             lda #HIGH($7835)
       35:B8C6  85 71             sta <.pTarget+1
  201  35:B8C8  A2 07             ldx #7
  202  35:B8CA            .for_each_enemy:
  203  35:B8CA  8A                        txa
  204  35:B8CB  48                        pha
  205  35:B8CC  A9 E8                     lda #$e8        ;dead | stone | toad | minimum
  206  35:B8CE  A2 00                     ldx #$00
  207  35:B8D0  20 2B 9A                  jsr isTargetNotInStatus
  208  35:B8D3  90 03                     bcc .offset_ptr
  209                                             ;ok
  210  35:B8D5  20 10 93                          jsr calcAbyss
  211  35:B8D8                    .offset_ptr:
  212                                     SUB16by8 <.pTarget,#$40
       35:B8D8  A5 70             lda <.pTarget
       35:B8DA  38                sec
       35:B8DB  E9 40             sbc #$40
       35:B8DD  85 70             sta <.pTarget
       35:B8DF  B0 02             bcs .sub16by8_00113
       35:B8E1  C6 71                     dec <.pTarget+1
       35:B8E3                    .sub16by8_00113:
  213  35:B8E3  68                        pla
  214  35:B8E4  AA                        tax
  215  35:B8E5  CA                        dex
  216  35:B8E6  10 E2                     bpl .for_each_enemy
  217                     
  218  35:B8E8  20 A9 A9          jsr damageActorByQuoterHalf     ;also set x to cache index
  219                     ;setup message and effect params
  220  35:B8EB  A9 5D             lda #EXMSG_ABYSS_MESSAGE
  221  35:B8ED  4C BF 9F          jmp addBattleMessage
  222                     ;       sta battleMessages
  223                     ;       lda .actorStatusCache,x
  224                     ;       bpl .finish
  225                     ;               ldx #1
  226                     ;               stx battleMessageCount
  227                     ;               lda #$1a        ;"しんでしまった"
  228                     ;               sta battleMessages,x
  229                     ;.finish:
  230                     ;       rts
  231                             ;jsr setXtoActorIndex
  232                             ;jmp setupWeaponId
  233                     
  234                     ;======================================================================================================         
  235  35:B8F0            ff3_cmdx_abyss_end:
  236                             VERIFY_PC ff3_magic_window_free_end
       35:B8F0                    .verify_pc_00114:
                0000              .if (.verify_pc_00114 > ff3_magic_window_free_end)
                                  .endif
  237                             ;.if ff3_cmdx_abyss_end >= ff3_magic_window_free_end
  238                             ;       .fail
  239                             ;.endif
  240                             
  241                             .else   ;GIVE_EVILSWORDMAN_ABYSS
  248                             .endif  ;GIVE_EVILSWORDMAN_ABYSS
#[3]   ff3_hack_master.asm
#[4]   ff3_cmdx_raid.asm
   60                                     .include "ff3_cmdx_raid.asm"    ;consume( origin )
    1                     ; ff3_cmdx_raid.asm
    2                     ;
    3                     ; description:
    4                     ;       implements 'raid' command 
    5                     ;
    6                     ; version:
    7                     ;       0.04 (2006-11-13)
    8                     ;======================================================================================================
    9  35:B8F0            ff3_cmdx_raid_begin:
   10                     
   11           A7C1      commandWindow_OnRaid = commandWindow_selectSingleTargetAndNext
   12                     
   13  35:B8F0            cmdx_raid:
   14                     ; [in] x : actionid << 1
   15                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
   16           006E      .pActor = $6e
   17           00E0      .targetStatusCache = $e0
   18           00F0      .actorStatusCache = $f0
   19  35:B8F0  20 1E 9A          jsr isTargetActor
   20  35:B8F3  D0 12             bne .ok
   21                             ;target == actor. confuse it as player
   22  35:B8F5  20 6D AA                  jsr setupNoMotionType01
   23  35:B8F8  A9 60                     lda #$52+$0e    ;こんらん
   24  35:B8FA  8D D7 78                  sta actionName
   25  35:B8FD  20 B4 9F                  jsr setXtoActorIndex16
   26  35:B900  B5 F1                     lda <.actorStatusCache+1,x
   27  35:B902  09 28                     ora #$28        ;こんらん (remain1)
   28  35:B904  95 F1                     sta <.actorStatusCache+1,x
   29  35:B906  60                        rts
   30  35:B907            .ok:
   31  35:B907  A9 04             lda #4
   32  35:B909  8D C2 7E          sta effectHandlerIndex
   33  35:B90C  A0 2E             ldy #$2e
   34  35:B90E  91 6E             sta [.pActor],y
   35  35:B910  20 FC B6          jsr cmdx_initDamageCache
   36                             ;
   37  35:B913  A0 0F             ldy #$0f
   38  35:B915  B1 6E             lda [.pActor],y
   39  35:B917  4A                lsr a
   40  35:B918  4A                lsr a
   41  35:B919  4A                lsr a
   42  35:B91A  18                clc
   43  35:B91B  69 08             adc #$08
   44  35:B91D  A0 27             ldy #$27
   45  35:B91F  91 6E             sta [.pActor],y
   46                     
   47  35:B921  20 04 A1          jsr command_fight
   48  35:B924  20 C3 9C          jsr updateTargetStatusByCache
   49  35:B927  20 27 9A          jsr isTargetActive
   50  35:B92A  90 2D             bcc .sumDamages
   51                     ;               jsr isTargetActor
   52                     ;               beq .sumDamages
   53                     
   54  35:B92C  A9 5E                     lda #EXMSG_RAID_MESSAGE
   55  35:B92E  20 BF 9F                  jsr addBattleMessage
   56                     
   57  35:B931  AD E1 7E                  lda play_segmentedGroup
   58  35:B934  48                        pha
   59  35:B935  AD D7 78                  lda actionName
   60  35:B938  48                        pha
   61  35:B939  20 DE 9F                  jsr swapHitCounts
   62                     
   63  35:B93C  20 59 B9                  jsr .sumDamages
   64  35:B93F  20 EF 9F                  jsr initAllDamages
   65                     
   66  35:B942  20 95 A2                  jsr command_fight_counter
   67  35:B945  20 AD 9F                  jsr setXtoActorIndex
   68  35:B948  20 E6 A2                  jsr setupWeaponId
   69  35:B94B  20 DE 9F                  jsr swapHitCounts
   70                     
   71  35:B94E  68                        pla
   72  35:B94F  8D D7 78                  sta actionName
   73  35:B952  68                        pla
   74  35:B953  8D E1 7E                  sta play_segmentedGroup
   75                     
   76  35:B956  20 CA 9F                  jsr swapDamages
   77                     
   78  35:B959            .sumDamages:
   79  35:B959  20 A6 9F          jsr setXtoTargetIndex
   80  35:B95C  4C 8A B8          jmp cmdx_sumDamagesOfTargetAndActor
   81                     
   82  35:B95F            cmdx_raid_end:
   83                             VERIFY_PC ff3_magic_window_free_end
       35:B95F                    .verify_pc_00116:
                0000              .if (.verify_pc_00116 > ff3_magic_window_free_end)
                                  .endif
   84                     ;======================================================================================================
   85                             RESTORE_PC ff3_cmdx_raid_begin
                0035              .bank   BANK(ff3_cmdx_raid_begin)
                B8F0              .org    ff3_cmdx_raid_begin
#[3]   ff3_hack_master.asm
   61                                     ;v0.6.1:
#[4]   ff3_present_scene.asm
   62                                     .include "ff3_present_scene.asm"
    1                     ; ff3_present_scene.asm
    2                     ;
    3                     ;description:
    4                     ;       replaces presentScene()
    5                     ;
    6                     ;version:
    7                     ;       0.01 (2006-10-28)
    8                     ;
    9                     ;======================================================================================================
   10  35:B8F0            ff3_present_scene_begin:
   11                     
   12                     ;       [in] u8 A : commandId (00-25h)
   13                     ;               01 : さがる(char:$52)
   14                     ;               02 : 指示するキャラが前に出る(char:$52)
   15                     ;               03 : playEffect_05 (back(03) )
   16                     ;               04 : playEffect_04 (forward(02) )
   17                     ;               07 : playEffect_0e(死亡・味方)
   18                     ;               08 : $b38e 行動中のキャラを示す(一定のラインまで前に出る)
   19                     ;               09 : $b38b 行動終了したキャラを元の位置まで戻す
   20                     ;               0a : playEffect_0e(死亡・敵 $7e=死亡bit(各bitが敵1体に相当) )
   21                     ;               0b : playEffect_0e
   22                     ;                       (蘇生? bitが立っている敵の枠に敵がいたならグラ復活
   23                     ;                        生存かつ非表示の敵がいたとき $7e=生存bit で呼ばれる)
   24                     ;               0C : 敵生成(召還・分裂・増殖) playEffect_0F (disp_0C)
   25                     ;               0d : playEffect_0c (escape(06/07) : $7e9a(sideflag) < 0)
   26                     ;               0e :
   27                     ;               
   28                     ;               0F : prize($35:bb49)
   29                     ;               10 : 対象選択
   30                     ;               12 : 打撃モーション&エフェクト(char:$52)
   31                     ;               13 : presentCharacter($34:8185)
   32                     ;               14 : playEffect_00 (fight/sing 被弾モーション?)
   33                     ;               15 : playEffect_06 (defend(05) )
   34                     ;               16 : playEffect_09 (charge(0f) 通常)
   35                     ;               17 : playEffect_09 (charge(0f) ためすぎ)
   36                     ;               18 : playEffect_07 (jump(08) )
   37                     ;               19 : playEffect_08 (landing(09) )
   38                     ;               1a : playEffect_0a (intimidate(11) )
   39                     ;               1b : playEffect_0b (cheer(12) )
   40                     ;               1c : playEffect_0F (disp_0C) ダメージ表示?
   41                     ;               1d : playEffect_01 (command13/ cast/item)
   42                     ;               1f : playEffect_00 行動する敵が点滅
   43                     ;               20 : playEffect_00 (fight/sing 敵の打撃エフェクト?)
   44                     ;               21 : playEffect_0d (escape(06/07) : $7e9a(effectside) >= 0)
   45                     ;               22 : playEffect_01 (magicparam+06 == #07)
   46                     ;               23 : playEffect_01 (magicparam+06 == #0d)
   47                     ;               24 : playEffect_0c (command15)
   48                     ;       [in] u8 X : actorIndex
   49                     ;       [out] u8 $7d7d : 0
   50                             INIT_PATCH $2f,$af4e,$afc0
                002F              .bank   $2f
                AF4E              .org    $af4e
       2F:AF4E                    .ds             (($afc0) - ($af4e))
                AF4E              .org    $af4e
   51                     
   52  2F:AF4E            presentScene:
   53                     ;.handlers = $af74
   54  2F:AF4E  86 95             stx <$95
   55  2F:AF50  0A                asl a
   56  2F:AF51  18                clc
   57  2F:AF52  69 6A             adc #LOW(.handlers)
   58  2F:AF54  85 93             sta <$93
   59  2F:AF56  A9 AF             lda #HIGH(.handlers)
   60  2F:AF58  85 94             sta <$94
   61  2F:AF5A  A9 6C             lda #$6c
   62  2F:AF5C  85 92             sta <$92
   63  2F:AF5E  98                tya
   64  2F:AF5F  48                pha
   65  2F:AF60  8A                txa
   66  2F:AF61  48                pha
   67  2F:AF62  20 92 00          jsr $0092
   68  2F:AF65  68                pla
   69  2F:AF66  AA                tax
   70  2F:AF67  68                pla
   71  2F:AF68  A8                tay
   72  2F:AF69  60                rts
   73                     ;$2f:af74 $af4e_funcTable;
   74  2F:AF6A            .handlers:
   75  2F:AF6A  69 B4             .dw $b469, $b3c7, $b3cd, $b42a
       2F:AF6C  C7 B3     
       2F:AF6E  CD B3     
       2F:AF70  2A B4     
   76  2F:AF72  43 B4             .dw $b443, $b3f6, $b3d9, $b3d3
       2F:AF74  F6 B3     
       2F:AF76  D9 B3     
       2F:AF78  D3 B3     
   77  2F:AF7A  8B B3             .dw $b38b, $b38e, $b33e, $b343
       2F:AF7C  8E B3     
       2F:AF7E  3E B3     
       2F:AF80  43 B3     
   78  2F:AF82  48 B3             .dw $b348, $b34d, $b304, $b2eb
       2F:AF84  4D B3     
       2F:AF86  04 B3     
       2F:AF88  EB B2     
   79                     
   80  2F:AF8A  FA B2             .dw $b2fa, $b260, $b24f, $b24c
       2F:AF8C  60 B2     
       2F:AF8E  4F B2     
       2F:AF90  4C B2     
   81  2F:AF92  01 B2             .dw $b201, $b246, $b1d8, $b1e0
       2F:AF94  46 B2     
       2F:AF96  D8 B1     
       2F:AF98  E0 B1     
   82  2F:AF9A  CF B1             .dw $b1cf, $b1c1, $b1b5, $b1af
       2F:AF9C  C1 B1     
       2F:AF9E  B5 B1     
       2F:AFA0  AF B1     
   83  2F:AFA2  AC B1             .dw $b1ac, $b15e, $b050, $b024
       2F:AFA4  5E B1     
       2F:AFA6  50 B0     
       2F:AFA8  24 B0     
   84                     
   85  2F:AFAA  05 B0             .dw $b005, $af24, $afff, $afe7
       2F:AFAC  24 AF     
       2F:AFAE  FF AF     
       2F:AFB0  E7 AF     
   86  2F:AFB2  44 AF             .dw $af44, $afd8
       2F:AFB4  D8 AF     
   87                             ;extra
   88                             ;$26
   89  2F:AFB6  97 B3             .dw psx_blowOnly
   90  2F:AFB8  A0 B3             .dw psx_abyss
   91                     ;------------------------------------------------------------------------------------------------------
   92                     ;$2f:b352 moveCharacterBack
   93                             INIT_PATCH $2f,$b352,$b388
                002F              .bank   $2f
                B352              .org    $b352
       2F:B352                    .ds             (($b388) - ($b352))
                B352              .org    $b352
   94                     
   95  2F:B352            moveCharacterBack:
   96                     ;       [in] x : actorIndex
   97           7D7F      .goals = $7d7f
   98  2F:B352  20 64 B3          jsr getMoveOffset
   99  2F:B355  18                clc
  100                     ;fall through
  101  2F:B356            moveCharacter_addAndStoreGoal:
  102           7D7F      .goals = $7d7f
  103  2F:B356  30 03             bmi .confused
  104  2F:B358  EE 7D 7D                  inc $7d7d
  105  2F:B35B            .confused:
  106  2F:B35B  7D 7F 7D          adc .goals,x
  107  2F:B35E  9D 7F 7D          sta .goals,x
  108  2F:B361  4C 5C B4          jmp $b45c       ;
  109                     
  110  2F:B364            getMoveOffset:
  111                     ;[out] u8 a,$7e : offset
  112  2F:B364  A9 00             lda #0
  113  2F:B366  8D 7D 7D          sta $7d7d
  114  2F:B369  8A                txa
  115  2F:B36A  0A                asl a
  116  2F:B36B  A8                tay
  117  2F:B36C  B9 9B 7D          lda $7d9b,y
  118  2F:B36F  29 08             and #$08
  119  2F:B371  F0 04             beq .not_confused
  120                     ;backattack
  121  2F:B373  A9 F0                     lda #$f0
  122  2F:B375  D0 09                     bne .store_and_set_x
  123  2F:B377            .not_confused:
  124  2F:B377  BD 8F 7D                  lda $7d8f,x
  125  2F:B37A  4A                        lsr a
  126  2F:B37B  A9 10                     lda #$10
  127  2F:B37D  90 01                     bcc .at_front_line
  128  2F:B37F  0A                                asl a
  129  2F:B380                    .at_front_line:
  130  2F:B380            .store_and_set_x:
  131  2F:B380  85 7E             sta <$7e
  132  2F:B382  60                rts
  133                     ;------------------------------------------------------------------------------------------------------
  134                     ;$2f:b38e moveCharacterForward
  135                             INIT_PATCH $2f,$b38e,$b3c7
                002F              .bank   $2f
                B38E              .org    $b38e
       2F:B38E                    .ds             (($b3c7) - ($b38e))
                B38E              .org    $b38e
  136                     
  137  2F:B38E            moveCharacterForward:
  138                     ;       [in] x : actorIndex
  139           7D7F      .goals = $7d7f
  140  2F:B38E  20 64 B3          jsr getMoveOffset
  141  2F:B391  49 FF             eor #$ff
  142  2F:B393  38                sec
  143  2F:B394  4C 56 B3          jmp moveCharacter_addAndStoreGoal
  144                     ;------------------------------------------------------------------------------------------------------
  145                     
  146  2F:B397            psx_blowOnly:
  147  2F:B397  20 CF A9          jsr $a9cf       ;$a9cf();       
  148  2F:B39A  20 EA A8          jsr $a8ea       ;loadBlowEffectParams();        // $a8ea();
  149  2F:B39D  4C F0 AE          jmp $aef0       ;dispatchEffectFunction_04();   //$aef0();      //打撃モーション
  150                             
  151  2F:B3A0            psx_abyss:
  152  2F:B3A0  20 8E B3          jsr moveCharacterForward
  153                             ;presentScene_16 (charge)
  154  2F:B3A3  A9 00             lda #0
  155  2F:B3A5  8D 19 7E          sta $7e19       ;charge motion flag
  156  2F:B3A8  20 CF A9          jsr $a9cf;
  157  2F:B3AB  20 B1 A9          jsr $a9b1;
  158  2F:B3AE  20 FC AE          jsr $aefc;      dispatchEffectFunction_07();
  159                             ;jsr psx_blowOnly       ;destorys x
  160  2F:B3B1  20 CF A9          jsr $a9cf
  161  2F:B3B4  20 14 AF          jsr $af14       ;dispatchEffectFunction_0d
  162  2F:B3B7  A9 06             lda #6
  163  2F:B3B9  20 B3 A1          jsr $a1b3       ;clear sprites
  164  2F:B3BC  A6 95             ldx <$95        ;index
  165  2F:B3BE  4C C7 B3          jmp $b3c7       ;backAndUpdatePpu
  166                     ;$b3c7:
  167                     ;======================================================================================================
  168                             RESTORE_PC ff3_present_scene_begin
                0035              .bank   BANK(ff3_present_scene_begin)
                B8F0              .org    ff3_present_scene_begin
#[3]   ff3_hack_master.asm
   63                                     ;v0.7.0:
#[4]   ff3_doFight.asm
   64                                     .include "ff3_doFight.asm"
    1                     ; ff3_doFight.asm
    2                     ;
    3                     ;description:
    4                     ;       replaces calculation for command 'fight'
    5                     ;
    6                     ;version:
    7                     ;       0.04 (2006-11-11)
    8                     ;======================================================================================================
    9  35:B8F0            ff3_battle_calc_begin:
   10                     
   11                             ;INIT_PATCH $31,$a000,$a2b5
   12                             INIT_PATCH $31,$a000,$a290
                0031              .bank   $31
                A000              .org    $a000
       31:A000                    .ds             (($a290) - ($a000))
                A000              .org    $a000
   13                             INIT_PATCH $30,$9e8a,$a000
                0030              .bank   $30
                9E8A              .org    $9e8a
       30:9E8A                    .ds             (($a000) - ($9e8a))
                9E8A              .org    $9e8a
   14                     
   15                     DEF_DO_FIGHT_VARS       .macro
   16                     .atkHigh = $2b
   17                     .atkLow = $25
   18                     .def = $26
   19                     .criticalBonus = $28
   20                     .criticalCount = $29
   21                     .damageDivider = $2a
   22                     .pActor = $6e
   23                     .pTarget = $70
   24                     .escapeCount = $74
   25                     .isGuarding = $7ce4
   26                     .isFarTarget = $7ce9
   27                     ;[out]
   28                     .hitCount_1st = $7c
   29                     .hitCount_2nd = $7d
   30                     .protectFlag = $7edf
   31                     ;[out] shared with checkSegment()
   32                     .hitCountForBlow_1st = $bb
   33                     .hitCountForBlow_2nd = $bc
   34                     ;locals:
   35                     .targetHp = $3c
   36                     .actorHp = $40
   37                     .doubleArmed = $741e
   38                     .handCount = $741f
   39                     .attackProps = $7440
   40                     .defProps = $742a
   41                     ;shared with cacheStatus()
   42                     .iActorCache = $62
   43                     .iTargetCache = $64
   44                     .iActor = $66
   45                     .iTarget = $68
   46                     .actorStatusCache = $f0
   47                     .targetStatusCache = $e0
   48                     ;shared with sumDamage()
   49                     .damageForDisplay = $6a
   50                     .damage = $78
   51                             .endm   ;DEF_DO_FIGHT_VARS
   52  30:9E8A            doFight:
   53                             DEF_DO_FIGHT_VARS
                002B      .atkHigh = $2b
                0025      .atkLow = $25
                0026      .def = $26
                0028      .criticalBonus = $28
                0029      .criticalCount = $29
                002A      .damageDivider = $2a
                006E      .pActor = $6e
                0070      .pTarget = $70
                0074      .escapeCount = $74
                7CE4      .isGuarding = $7ce4
                7CE9      .isFarTarget = $7ce9
                          ;[out]
                007C      .hitCount_1st = $7c
                007D      .hitCount_2nd = $7d
                7EDF      .protectFlag = $7edf
                          ;[out] shared with checkSegment()
                00BB      .hitCountForBlow_1st = $bb
                00BC      .hitCountForBlow_2nd = $bc
                          ;locals:
                003C      .targetHp = $3c
                0040      .actorHp = $40
                741E      .doubleArmed = $741e
                741F      .handCount = $741f
                7440      .attackProps = $7440
                742A      .defProps = $742a
                          ;shared with cacheStatus()
                0062      .iActorCache = $62
                0064      .iTargetCache = $64
                0066      .iActor = $66
                0068      .iTarget = $68
                00F0      .actorStatusCache = $f0
                00E0      .targetStatusCache = $e0
                          ;shared with sumDamage()
                006A      .damageForDisplay = $6a
                0078      .damage = $78
   54                     ;------------------------------------------------------------------------------------------------------
   55  30:9E8A  20 BA A2          jsr cacheStatus
   56  30:9E8D  A6 64             ldx <.iTargetCache
   57  30:9E8F  B5 E0             lda <.targetStatusCache,x
   58  30:9E91  30 08             bmi .bad_target
   59  30:9E93  0A                asl a
   60  30:9E94  30 05             bmi .bad_target
   61                             
   62  30:9E96  B5 E1             lda <.targetStatusCache+1,x
   63  30:9E98  4A                lsr a   ;jumping
   64  30:9E99  90 2B             bcc .begin_calc
   65                     
   66  30:9E9B            .bad_target:
   67           0022      .pTargetSideBase = $22
   68                     
   69  30:9E9B  A9 75             lda #$75
   70  30:9E9D  85 22             sta <.pTargetSideBase
   71  30:9E9F  85 23             sta <.pTargetSideBase+1
   72  30:9EA1  A0 30             ldy #$30
   73  30:9EA3  B1 6E             lda [.pActor],y
   74  30:9EA5  30 15             bmi .target_enemy
   75                     ;.target_player:
   76  30:9EA7  A9 03                     lda #3
   77  30:9EA9  20 00 A3                  jsr getRandomTarget
   78  30:9EAC  A5 69                     lda <$69
   79  30:9EAE  F0 13                     beq .cache_status
   80                     ;.no_valid_target:
   81  30:9EB0  A2 00                             ldx #0
   82  30:9EB2  8E C2 7E                          stx effectHandlerIndex  ;7ec2
   83  30:9EB5  CA                                dex
   84  30:9EB6  8E D8 78                          stx targetName  ;78d8
   85                                             ;bug!! jmp $a264        ;post calc
   86  30:9EB9  4C B5 A2                          jmp b31_getActor2C      
   87  30:9EBC            .target_enemy:
   88  30:9EBC  E6 23                     inc <.pTargetSideBase+1
   89  30:9EBE  A9 07                     lda #7
   90  30:9EC0  20 00 A3                  jsr getRandomTarget     ;a300
   91  30:9EC3            .cache_status:
   92  30:9EC3  20 BA A2          jsr cacheStatus
   93                     
   94  30:9EC6            .begin_calc:
   95  30:9EC6  A2 FF             ldx #$ff
   96  30:9EC8  8E E1 7E          stx play_segmentedGroup
   97  30:9ECB  E8                inx
   98  30:9ECC  8E E9 7C          stx $7ce9
   99  30:9ECF  86 7C             stx <.hitCount_1st
  100  30:9ED1  86 7D             stx <.hitCount_2nd
  101  30:9ED3  86 6A             stx <$6a
  102  30:9ED5  86 6B             stx <$6b
  103  30:9ED7  86 42             stx <$42
  104  30:9ED9  8E 1E 74          stx .doubleArmed
  105  30:9EDC  E8                inx
  106  30:9EDD  8E 1F 74          stx .handCount
  107                     
  108  30:9EE0  A0 04             ldy #4
  109  30:9EE2            .save_hp:
  110  30:9EE2  B1 70                     lda [.pTarget],y
  111  30:9EE4  95 3C                     sta <.targetHp,x
  112  30:9EE6  B1 6E                     lda [.pActor],y
  113  30:9EE8  95 40                     sta <.actorHp,x
  114  30:9EEA  88                        dey
  115  30:9EEB  CA                        dex
  116  30:9EEC  10 F4                     bpl .save_hp
  117                     
  118  30:9EEE  20 B5 A2          jsr b31_getActor2C
  119  30:9EF1  10 12             bpl .actor_player
  120                     ;actor_enemy
  121  30:9EF3  B1 70                     lda [.pTarget],y        ;y = 2c
  122  30:9EF5  30 21                     bmi .cache_props
  123                                             ;actor_enemy && target_player
  124  30:9EF7  A5 74                             lda <.escapeCount
  125  30:9EF9  F0 1D                             beq .cache_props
  126  30:9EFB  A0 27                                     ldy #$27
  127  30:9EFD  B1 70                                     lda [.pTarget],y
  128  30:9EFF  09 80                                     ora #$80        ;tag
  129  30:9F01  91 70                                     sta [.pTarget],y
  130  30:9F03  30 13                                     bmi .cache_props        ;always
  131  30:9F05            .actor_player:
  132  30:9F05  A0 31                     ldy #$31
  133  30:9F07  B1 6E                     lda [.pActor],y
  134  30:9F09  C9 02                     cmp #2
  135  30:9F0B  B0 0B                     bcs .cache_props
  136  30:9F0D  C8                        iny
  137  30:9F0E  51 6E                     eor [.pActor],y
  138  30:9F10  D0 06                     bne .cache_props
  139                                             ;両手が素手or両手が片手武器
  140  30:9F12  EE 1F 74                          inc .handCount
  141  30:9F15  EE 1E 74                          inc .doubleArmed
  142                     
  143  30:9F18            .cache_props:   ;$9f40
  144                     ;.attackProps = $7440
  145                     ;.defProps = $742a
  146                     
  147  30:9F18  A0 24             ldy #$24
  148  30:9F1A  A2 04             ldx #$04
  149  30:9F1C            .cache_defs:
  150  30:9F1C  B1 70                     lda [.pTarget],y
  151  30:9F1E  9D 2A 74                  sta .defProps,x
  152  30:9F21  88                        dey
  153  30:9F22  CA                        dex
  154  30:9F23  10 F7                     bpl .cache_defs
  155                             ;ldy #$1f
  156  30:9F25  A2 09             ldx #$09
  157  30:9F27            .cache_attacks:
  158  30:9F27  B1 6E                     lda [.pActor],y
  159  30:9F29  9D 20 74                  sta $7420,x
  160  30:9F2C  9D 40 74                  sta .attackProps,x
  161  30:9F2F  88                        dey
  162  30:9F30  CA                        dex
  163  30:9F31  10 F4                     bpl .cache_attacks
  164  30:9F33  A0 29             ldy #$29
  165  30:9F35  A2 02             ldx #$02
  166  30:9F37            .cache_criticals:
  167  30:9F37  B1 6E                     lda [.pActor],y
  168  30:9F39  9D 2F 74                  sta $742f,x
  169  30:9F3C  88                        dey
  170  30:9F3D  CA                        dex
  171  30:9F3E  10 F7                     bpl .cache_criticals
  172                     
  173  30:9F40            doFight_calc_damage_for_hand:   ;9f6a
  174                             DEF_DO_FIGHT_VARS
                002B      .atkHigh = $2b
                0025      .atkLow = $25
                0026      .def = $26
                0028      .criticalBonus = $28
                0029      .criticalCount = $29
                002A      .damageDivider = $2a
                006E      .pActor = $6e
                0070      .pTarget = $70
                0074      .escapeCount = $74
                7CE4      .isGuarding = $7ce4
                7CE9      .isFarTarget = $7ce9
                          ;[out]
                007C      .hitCount_1st = $7c
                007D      .hitCount_2nd = $7d
                7EDF      .protectFlag = $7edf
                          ;[out] shared with checkSegment()
                00BB      .hitCountForBlow_1st = $bb
                00BC      .hitCountForBlow_2nd = $bc
                          ;locals:
                003C      .targetHp = $3c
                0040      .actorHp = $40
                741E      .doubleArmed = $741e
                741F      .handCount = $741f
                7440      .attackProps = $7440
                742A      .defProps = $742a
                          ;shared with cacheStatus()
                0062      .iActorCache = $62
                0064      .iTargetCache = $64
                0066      .iActor = $66
                0068      .iTarget = $68
                00F0      .actorStatusCache = $f0
                00E0      .targetStatusCache = $e0
                          ;shared with sumDamage()
                006A      .damageForDisplay = $6a
                0078      .damage = $78
  175           0024      .count = $24
  176           0025      .rate = $25
  177                     
  178  30:9F40  AD 41 74          lda .attackProps+1
  179  30:9F43  85 24             sta <.count
  180  30:9F45  AD 42 74          lda .attackProps+2
  181  30:9F48  85 25             sta <.rate
  182                             
  183  30:9F4A  A6 62             ldx <.iActorCache
  184  30:9F4C  B5 F0             lda <.actorStatusCache,x
  185  30:9F4E  29 04             and #$04
  186  30:9F50  F0 02             beq .not_blind
  187  30:9F52  46 25                     lsr <.rate
  188  30:9F54            .not_blind:
  189  30:9F54  A0 33             ldy #$33
  190  30:9F56  B1 6E             lda [.pActor],y
  191  30:9F58  29 04             and #$04        ;04:両手遠距離フラグ(竪琴か矢がある弓ならset)
  192  30:9F5A  D0 1D             bne .get_attack_count
  193  30:9F5C  20 B5 A2                  jsr b31_getActor2C
  194  30:9F5F  30 05                     bmi .check_actor_line
  195  30:9F61  20 97 A3                          jsr isRangedWeapon      ;a397
  196  30:9F64  B0 13                             bcs .get_attack_count
  197  30:9F66                    .check_actor_line:
  198  30:9F66  A0 33                     ldy #$33
  199  30:9F68  B1 6E                     lda [.pActor],y
  200  30:9F6A  4A                        lsr a
  201  30:9F6B  90 02                     bcc .check_target_line
  202  30:9F6D  46 25                             lsr <.rate
  203  30:9F6F                    .check_target_line:
  204  30:9F6F  B1 70                     lda [.pTarget],y
  205  30:9F71  4A                        lsr a
  206  30:9F72  90 05                     bcc .get_attack_count
  207  30:9F74  EE E9 7C                          inc .isFarTarget
  208  30:9F77  46 25                             lsr <.rate
  209                     
  210  30:9F79            .get_attack_count:      ;$9fa6:
  211  30:9F79  20 28 BB          jsr getNumberOfRandomSuccess
  212  30:9F7C  85 7C             sta <.hitCount_1st
  213                     
  214  30:9F7E  AD 2B 74          lda .defProps+1
  215  30:9F81  85 24             sta <.count
  216  30:9F83  AD 2C 74          lda .defProps+2
  217  30:9F86  85 25             sta <.rate
  218                     
  219  30:9F88  A6 64             ldx <.iTargetCache
  220  30:9F8A  B5 E0             lda <.targetStatusCache,x
  221  30:9F8C  48                pha
  222  30:9F8D  29 04             and #$04
  223  30:9F8F  F0 02             beq .target_not_blind
  224  30:9F91  46 25                     lsr <.rate
  225  30:9F93            .target_not_blind:      ;$9fbf:
  226  30:9F93  68                pla
  227  30:9F94  A2 01             ldx #1
  228  30:9F96  29 28             and #$28        ;toad | minimum
  229  30:9F98  D0 06             bne .cannot_defend
  230  30:9F9A  A0 27             ldy #$27
  231  30:9F9C  B1 70             lda [.pTarget],y
  232  30:9F9E  F0 03             beq .get_evade_count
  233  30:9FA0            .cannot_defend:
  234  30:9FA0  CA                        dex
  235  30:9FA1  86 25                     stx <.rate
  236                     
  237  30:9FA3            .get_evade_count:
  238  30:9FA3  8A                txa
  239  30:9FA4  48                pha     ;can't defend flag
  240                     
  241  30:9FA5  20 28 BB          jsr getNumberOfRandomSuccess
  242  30:9FA8  AD E9 7C          lda .isFarTarget
  243  30:9FAB  F0 02             beq .calc_hit_count
  244  30:9FAD  E6 30                     inc <$30
  245                     ;$9fd9:
  246  30:9FAF            .calc_hit_count:
  247  30:9FAF  A5 7C             lda <.hitCount_1st
  248  30:9FB1  38                sec
  249  30:9FB2  E5 30             sbc <$30
  250  30:9FB4  B0 02             bcs .store_hit_count
  251  30:9FB6  A9 00                     lda #0
  252  30:9FB8            .store_hit_count:
  253  30:9FB8  85 24             sta <.count
  254  30:9FBA  85 7C             sta <.hitCount_1st
  255  30:9FBC  D0 04             bne .attack_hit
  256  30:9FBE  68                        pla     ;undefendable flag
  257  30:9FBF  4C B9 A0                  jmp doFight_next_hand
  258                     
  259  30:9FC2            .attack_hit:    ;$9ff1
  260           0027      .attrMultiplier = $27
  261  30:9FC2  A2 04             ldx #4
  262  30:9FC4  AD 40 74          lda .attackProps
  263  30:9FC7  A0 12             ldy #$12        ;weakattr
  264  30:9FC9  31 70             and [.pTarget],y
  265  30:9FCB  D0 0F             bne .store_attr_multi
  266                             ;
  267  30:9FCD  A2 02             ldx #2
  268  30:9FCF  AD 2A 74          lda .defProps
  269  30:9FD2  C9 02             cmp #$02
  270  30:9FD4  F0 05             beq .target_strong
  271  30:9FD6  2D 40 74                  and .attackProps
  272  30:9FD9  F0 01                     beq .store_attr_multi
  273  30:9FDB            .target_strong:
  274  30:9FDB  CA                dex
  275  30:9FDC            .store_attr_multi:
  276  30:9FDC  86 27             stx <.attrMultiplier
  277                     
  278  30:9FDE  A2 00             ldx #0
  279  30:9FE0  86 2B             stx <.atkHigh
  280  30:9FE2  86 29             stx <.criticalCount
  281  30:9FE4  E8                inx
  282  30:9FE5  86 2A             stx <.damageDivider
  283  30:9FE7  AD 31 74          lda $7431       ; $6e[y = #29]
  284  30:9FEA  85 28             sta <.criticalBonus
  285  30:9FEC  AD 43 74          lda $7443
  286  30:9FEF  85 25             sta <.atkLow
  287                             
  288  30:9FF1  20 B5 A2          jsr b31_getActor2C
  289  30:9FF4  30 09             bmi .store_def
  290  30:9FF6  A0 38                     ldy #$38
  291  30:9FF8  20 89 A3                  jsr addValueAtOffsetToAttack
  292  30:9FFB  C8                        iny
  293  30:9FFC  20 89 A3                  jsr addValueAtOffsetToAttack
  294                     
  295  30:9FFF            .store_def:
  296  30:9FFF  EA                nop
  297                     
  298                     
  299           0031              .bank $31
  300           A000              .org $a000
  301                     
  302  31:A000            doFight_setupProps:
  303                             DEF_DO_FIGHT_VARS
                002B      .atkHigh = $2b
                0025      .atkLow = $25
                0026      .def = $26
                0028      .criticalBonus = $28
                0029      .criticalCount = $29
                002A      .damageDivider = $2a
                006E      .pActor = $6e
                0070      .pTarget = $70
                0074      .escapeCount = $74
                7CE4      .isGuarding = $7ce4
                7CE9      .isFarTarget = $7ce9
                          ;[out]
                007C      .hitCount_1st = $7c
                007D      .hitCount_2nd = $7d
                7EDF      .protectFlag = $7edf
                          ;[out] shared with checkSegment()
                00BB      .hitCountForBlow_1st = $bb
                00BC      .hitCountForBlow_2nd = $bc
                          ;locals:
                003C      .targetHp = $3c
                0040      .actorHp = $40
                741E      .doubleArmed = $741e
                741F      .handCount = $741f
                7440      .attackProps = $7440
                742A      .defProps = $742a
                          ;shared with cacheStatus()
                0062      .iActorCache = $62
                0064      .iTargetCache = $64
                0066      .iActor = $66
                0068      .iTarget = $68
                00F0      .actorStatusCache = $f0
                00E0      .targetStatusCache = $e0
                          ;shared with sumDamage()
                006A      .damageForDisplay = $6a
                0078      .damage = $78
  304                     
  305  31:A000  AD 2D 74          lda .defProps+3
  306  31:A003  85 26             sta <.def
  307  31:A005  20 25 BC          jsr b31_getTarget2C
  308  31:A008  30 10             bmi .check_target_defendable
  309  31:A00A  29 07                     and #7
  310  31:A00C  AA                        tax
  311  31:A00D  BD E4 7C                  lda .isGuarding,x
  312  31:A010  F0 08                     beq .check_target_defendable
  313  31:A012  06 26                             asl <.def
  314  31:A014  90 04                             bcc .check_target_defendable
  315  31:A016  A9 FF                                     lda #$ff
  316  31:A018  85 26                                     sta <.def
  317                     
  318  31:A01A            .check_target_defendable:
  319  31:A01A  68                pla     ;defendable flag
  320  31:A01B  D0 06             bne .check_actor_toad_minimum
  321  31:A01D  85 26                     sta <.def
  322  31:A01F  06 25                     asl <.atkLow
  323  31:A021  26 2B                     rol <.atkHigh
  324                     
  325  31:A023            .check_actor_toad_minimum:      ;a055
  326  31:A023  A6 62             ldx <.iActorCache
  327  31:A025  B5 F0             lda <.actorStatusCache,x
  328  31:A027  29 28             and #$28
  329  31:A029  F0 06             beq .apply_charge
  330  31:A02B  A9 01                     lda #$01
  331  31:A02D  85 25                     sta <.atkLow
  332  31:A02F  D0 11                     bne .get_damage
  333  31:A031            .apply_charge:
  334           0001              .ifdef BOOST_CHARGE
  335  31:A031  20 C0 A1                  jsr applyCharge
  336                             .endif;BOOST_CHARGE
  337  31:A034            .randomize_critical:
  338  31:A034  A9 63             lda #99
  339  31:A036  20 B4 BE          jsr b31_getBattleRandom ;beb4
  340  31:A039  CD 30 74          cmp $7430       ;$6e[#28]
  341  31:A03C  B0 04             bcs .get_damage
  342                                     ;critical
  343  31:A03E  E6 29                     inc <.criticalCount
  344  31:A040  E6 CB                     inc <$cb
  345                     
  346  31:A042            .get_damage:    ;$a093:
  347  31:A042  20 44 BB          jsr calcDamage  ;bb44
  348  31:A045  A5 29             lda <.criticalCount
  349  31:A047  F0 05             beq .setup_effect_and_message
  350  31:A049  A9 34                     lda #$34        ;"クリティカルヒット！"
  351  31:A04B  20 B6 A1                  jsr b31_queueBattleMessage
  352                     
  353  31:A04E            .setup_effect_and_message:
  354           0024      .pCalc = $24
  355  31:A04E  20 BC BD          jsr set24ToTarget
  356                     
  357  31:A051  A5 1C             lda <$1c
  358  31:A053  85 78             sta <.damage
  359  31:A055  A5 1D             lda <$1d
  360  31:A057  85 79             sta <.damage+1
  361  31:A059  05 1C             ora <$1c
  362  31:A05B  D0 02             bne .check_absorb
  363  31:A05D  E6 78                     inc <.damage
  364                     
  365  31:A05F            .check_absorb:
  366           0026      .deadFlag = $26
  367                             ;ldy #$12
  368  31:A05F  AD 40 74          lda .attackProps
  369  31:A062  4A                lsr a
  370  31:A063  90 1C             bcc .attr_not_absorb
  371  31:A065  20 E2 BB                  jsr isTargetWeakToHoly
  372  31:A068  B0 03                     bcs .check_is_target_actor
  373  31:A06A  20 68 A3                          jsr sumDamage
  374  31:A06D                    .check_is_target_actor:
  375  31:A06D  20 B5 A2                  jsr b31_getActor2C
  376  31:A070  51 70                     eor [.pTarget],y
  377  31:A072  29 87                     and #$87
  378  31:A074  F0 12                     beq .do_damage
  379                                             ;target != actor
  380  31:A076  20 67 BD                          jsr spoilHp     ;bd67
  381  31:A079  A5 26                             lda <.deadFlag
  382  31:A07B  F0 24                             beq .both_alive
  383  31:A07D  30 18                             bmi .actor_dead
  384  31:A07F  10 0C                             bpl .target_dead
  385  31:A081            .attr_not_absorb:
  386  31:A081  A9 00             lda #0
  387  31:A083  85 26             sta <.deadFlag
  388  31:A085  20 68 A3          jsr sumDamage
  389  31:A088            .do_damage:
  390  31:A088  20 D2 BC          jsr damageHp
  391  31:A08B  B0 14             bcs .both_alive
  392  31:A08D            .target_dead:
  393  31:A08D  A6 64                     ldx <.iTargetCache
  394  31:A08F  B5 E0                     lda <.targetStatusCache,x
  395  31:A091  09 80                     ora #$80
  396  31:A093  95 E0                     sta <.targetStatusCache,x
  397  31:A095  30 22                     bmi .next_hand
  398  31:A097            .actor_dead:
  399  31:A097  A6 62                     ldx <.iActorCache
  400  31:A099  B5 F0                     lda <.actorStatusCache,x
  401  31:A09B  09 80                     ora #$80
  402  31:A09D  95 F0                     sta <.actorStatusCache,x
  403  31:A09F  30 18                     bmi .next_hand
  404  31:A0A1            .both_alive:
  405  31:A0A1  AD D8 7E          lda battleMode
  406  31:A0A4  30 13             bmi .next_hand  ;ボス戦なら追加効果判定をしない
  407  31:A0A6  A0 01                     ldy #1
  408  31:A0A8  B1 6E                     lda [.pActor],y
  409  31:A0AA  29 28                     and #$28
  410  31:A0AC  D0 0B                     bne .next_hand  ;攻撃者が蛙か小人なら判定しない
  411                                             ;fix --->
  412  31:A0AE  A6 64                             ldx <.iTargetCache
  413  31:A0B0  B5 E0                             lda <.targetStatusCache,x
  414  31:A0B2  29 E8                             and #$e8        ;dead|stone|toad|minimum
  415  31:A0B4  D0 03                             bne .next_hand  ;対象が↑の状態なら判定しない(敵なら既に死亡扱い)
  416                                             ;<--- fix
  417  31:A0B6  20 14 BE                          jsr checkEnchantedStatus        ;be14 追加効果判定
  418                     
  419  31:A0B9            .next_hand:
  420  31:A0B9            doFight_next_hand:      ;$a139: //hit数0(=ミス)ならここまで飛んでくる
  421                             DEF_DO_FIGHT_VARS
                002B      .atkHigh = $2b
                0025      .atkLow = $25
                0026      .def = $26
                0028      .criticalBonus = $28
                0029      .criticalCount = $29
                002A      .damageDivider = $2a
                006E      .pActor = $6e
                0070      .pTarget = $70
                0074      .escapeCount = $74
                7CE4      .isGuarding = $7ce4
                7CE9      .isFarTarget = $7ce9
                          ;[out]
                007C      .hitCount_1st = $7c
                007D      .hitCount_2nd = $7d
                7EDF      .protectFlag = $7edf
                          ;[out] shared with checkSegment()
                00BB      .hitCountForBlow_1st = $bb
                00BC      .hitCountForBlow_2nd = $bc
                          ;locals:
                003C      .targetHp = $3c
                0040      .actorHp = $40
                741E      .doubleArmed = $741e
                741F      .handCount = $741f
                7440      .attackProps = $7440
                742A      .defProps = $742a
                          ;shared with cacheStatus()
                0062      .iActorCache = $62
                0064      .iTargetCache = $64
                0066      .iActor = $66
                0068      .iTarget = $68
                00F0      .actorStatusCache = $f0
                00E0      .targetStatusCache = $e0
                          ;shared with sumDamage()
                006A      .damageForDisplay = $6a
                0078      .damage = $78
  422                     
  423  31:A0B9  CE 1F 74          dec .handCount
  424  31:A0BC  F0 19             beq .setup_damages
  425  31:A0BE  A2 04                     ldx #4
  426  31:A0C0                    .update_props_to_another_hand:
  427  31:A0C0  BD 25 74                          lda $7425,x
  428  31:A0C3  9D 40 74                          sta $7440,x
  429  31:A0C6  CA                                dex
  430  31:A0C7  10 F7                             bpl .update_props_to_another_hand
  431                     
  432  31:A0C9  A5 7C                     lda <.hitCount_1st
  433  31:A0CB  85 7D                     sta <.hitCount_2nd
  434  31:A0CD  E8                        inx     ;0
  435  31:A0CE  86 7C                     stx <.hitCount_1st
  436  31:A0D0  86 78                     stx <.damage
  437  31:A0D2  86 79                     stx <.damage+1
  438  31:A0D4  4C 40 9F                  jmp doFight_calc_damage_for_hand        ;9f6a
  439                     
  440  31:A0D7            .setup_damages:
  441  31:A0D7  A0 27             ldy #$27
  442  31:A0D9  B1 70             lda [.pTarget],y
  443  31:A0DB  29 7F             and #$7f        ;clear undefendable tag
  444  31:A0DD  91 70             sta [.pTarget],y
  445                     
  446  31:A0DF  A9 00             lda #0
  447  31:A0E1  91 6E             sta [.pActor],y ;clear charge count
  448                     
  449  31:A0E3  AD 1E 74          lda .doubleArmed
  450  31:A0E6  F0 08             beq .store_damages
  451  31:A0E8  A5 7C                     lda <.hitCount_1st
  452  31:A0EA  A6 7D                     ldx <.hitCount_2nd
  453  31:A0EC  86 7C                     stx <.hitCount_1st
  454  31:A0EE  85 7D                     sta <.hitCount_2nd
  455  31:A0F0            .store_damages:
  456  31:A0F0  A4 64             ldy <.iTargetCache
  457  31:A0F2  A5 7C             lda <.hitCount_1st
  458  31:A0F4  85 BB             sta <.hitCountForBlow_1st
  459  31:A0F6  05 7D             ora <.hitCount_2nd
  460  31:A0F8  D0 0D             bne .not_miss
  461  31:A0FA  85 BC                     sta <.hitCountForBlow_2nd
  462  31:A0FC  99 4F 7E                  sta play_damages,y
  463  31:A0FF  A9 40                     lda #$40        ;miss
  464  31:A101  99 50 7E                  sta play_damages+1,y
  465  31:A104  4C 9B A1                  jmp .add_cannot_defend_message
  466  31:A107            .not_miss:
  467  31:A107  A5 7D                     lda <.hitCount_2nd
  468  31:A109  85 BC                     sta <.hitCountForBlow_2nd
  469                     
  470  31:A10B  A9 00                     lda #0
  471  31:A10D  85 43                     sta <$43
  472                     
  473  31:A10F  A0 03                     ldy #3
  474  31:A111  B1 6E                     lda [.pActor],y
  475  31:A113  85 78                     sta <.damage
  476  31:A115  C8                        iny
  477  31:A116  B1 6E                     lda [.pActor],y
  478  31:A118  85 79                     sta <.damage+1
  479                                     
  480  31:A11A  20 B5 A2                  jsr b31_getActor2C
  481  31:A11D  51 70                     eor [.pTarget],y
  482  31:A11F  29 87                     and #$87
  483  31:A121  F0 55                     beq .no_message ;a203 => a216
  484                     
  485  31:A123  A6 62                     ldx <.iActorCache
  486  31:A125  38                        sec
  487  31:A126  A5 40                     lda <.actorHp
  488  31:A128  E5 78                     sbc <.damage
  489  31:A12A  9D 5F 7E                  sta play_damages+$10,x
  490  31:A12D  A5 41                     lda <.actorHp+1
  491  31:A12F  E5 79                     sbc <.damage+1
  492  31:A131  9D 60 7E                  sta play_damages+$11,x
  493  31:A134  90 1C                     bcc .actor_healed
  494                                             ;actorHpBeforeAttack >= actor.hp
  495  31:A136  1D 5F 7E                          ora play_damages+$10,x
  496  31:A139  D0 08                             bne .actually_healed
  497                                                     ;heal0pt
  498  31:A13B  DE 5F 7E                                  dec play_damages+$10,x
  499  31:A13E  DE 60 7E                                  dec play_damages+$11,x
  500  31:A141  30 35                                     bmi .no_message
  501  31:A143                            .actually_healed:
  502  31:A143  A0 16                             ldy #$16
  503  31:A145  B1 6E                             lda [.pActor],y
  504  31:A147  A0 1B                             ldy #$1b
  505  31:A149  11 6E                             ora [.pActor],y
  506  31:A14B  4A                                lsr a
  507  31:A14C  90 2A                             bcc .no_message
  508  31:A14E  A2 27                                     ldx #$27        ;"HPをぎゃくにすいとられた!"
  509  31:A150  D0 20                                     bne .add_absorb_message
  510  31:A152                    .actor_healed:
  511  31:A152  BD 60 7E                          lda play_damages+$11,x
  512  31:A155  49 7F                             eor #$7f
  513  31:A157  9D 60 7E                          sta play_damages+$11,x
  514                                             
  515  31:A15A  BD 5F 7E                          lda play_damages+$10,x
  516  31:A15D  49 FF                             eor #$ff
  517  31:A15F  A8                                tay
  518  31:A160  C8                                iny
  519  31:A161  D0 03                             bne .store_heal_low
  520  31:A163  FE 60 7E                                  inc play_damages+$11,x
  521  31:A166                            .store_heal_low:
  522  31:A166  98                                tya
  523  31:A167  9D 5F 7E                          sta play_damages+$10,x
  524                                                     
  525  31:A16A  A2 25                             ldx #$25
  526  31:A16C  20 B5 A2                          jsr b31_getActor2C
  527  31:A16F  10 01                             bpl .player_is_healed
  528  31:A171  E8                                        inx
  529  31:A172                    .player_is_healed:
  530  31:A172                    .add_absorb_message:
  531  31:A172  8A                        txa
  532  31:A173  20 B6 A1                  jsr b31_queueBattleMessage
  533  31:A176  E6 43                     inc <$43
  534  31:A178            .no_message:
  535  31:A178  A6 64             ldx <.iTargetCache
  536  31:A17A  A5 42             lda <$42
  537  31:A17C  F0 13             beq .store_target_damage
  538  31:A17E  A0 03                     ldy #3
  539  31:A180  38                        sec
  540  31:A181  B1 70                     lda [.pTarget],y
  541  31:A183  E5 3C                     sbc <.targetHp
  542  31:A185  9D 4F 7E                  sta play_damages,x
  543  31:A188  C8                        iny
  544  31:A189  B1 70                     lda [.pTarget],y
  545  31:A18B  E5 3D                     sbc <.targetHp+1
  546  31:A18D  09 80                     ora #$80
  547  31:A18F  D0 07                     bne .store_target_damage_high
  548  31:A191                    .store_target_damage:
  549  31:A191  A5 6A                     lda <$6a
  550  31:A193  9D 4F 7E                  sta play_damages,x
  551  31:A196  A5 6B                     lda <$6b
  552  31:A198            .store_target_damage_high:
  553  31:A198  9D 50 7E          sta play_damages+1,x
  554                     
  555  31:A19B            .add_cannot_defend_message:     ;$a264:
  556  31:A19B  20 B5 A2          jsr b31_getActor2C
  557  31:A19E  10 10             bpl .check_segment
  558                     
  559  31:A1A0  A5 74                     lda <.escapeCount
  560  31:A1A2  F0 09                     beq .finish
  561                     
  562  31:A1A4  A5 7C                     lda <.hitCount_1st
  563  31:A1A6  F0 05                     beq .finish
  564                     
  565  31:A1A8  A9 55                             lda #$55        ;"にげごしで ぼうぎょできなかった!"
  566  31:A1AA  20 B6 A1                          jsr b31_queueBattleMessage
  567  31:A1AD                    .finish:
  568  31:A1AD  4C B5 A2                  jmp b31_getActor2C
  569                     
  570  31:A1B0            .check_segment: ;a28d
  571  31:A1B0  20 53 BF          jsr checkSegment        ;bf53
  572  31:A1B3  4C 90 A2          jmp $a290
  573                     
  574  31:A1B6            b31_queueBattleMessage:
  575  31:A1B6  AE EE 78          ldx battleMessageCount
  576  31:A1B9  9D DA 78          sta battleMessages,x
  577  31:A1BC  EE EE 78          inc battleMessageCount
  578  31:A1BF  60                rts
  579                     
  580  31:A1C0            applyCharge:
  581           0025      .atkLow = $25
  582           002B      .atkHigh = $2b
  583           0018      .tempAtk = $18  ;
  584           006E      .pActor = $6e
  585  31:A1C0  A5 25             lda <.atkLow
  586  31:A1C2  85 18             sta <.tempAtk
  587  31:A1C4  A5 2B             lda <.atkHigh
  588  31:A1C6  85 19             sta <.tempAtk+1
  589                     
  590  31:A1C8  A2 04             ldx #4
  591  31:A1CA            .shift_left_atk:
  592  31:A1CA  06 25                     asl <.atkLow
  593  31:A1CC  26 2B                     rol <.atkHigh
  594  31:A1CE  CA                        dex
  595  31:A1CF  D0 F9                     bne .shift_left_atk
  596  31:A1D1  A0 27             ldy #$27
  597  31:A1D3  B1 6E             lda [.pActor],y
  598  31:A1D5  AA                tax
  599  31:A1D6  F0 10             beq .restore
  600  31:A1D8            .add_charge_bonus:
  601  31:A1D8  18                        clc
  602  31:A1D9  A5 25                     lda <.atkLow
  603  31:A1DB  65 18                     adc <.tempAtk
  604  31:A1DD  85 25                     sta <.atkLow
  605  31:A1DF  A5 2B                     lda <.atkHigh
  606  31:A1E1  65 19                     adc <.tempAtk+1
  607  31:A1E3  85 2B                     sta <.atkHigh
  608  31:A1E5  CA                        dex
  609  31:A1E6  D0 F0                     bne .add_charge_bonus
  610  31:A1E8            .restore:
  611  31:A1E8  A2 04             ldx #4
  612  31:A1EA            .shift_right_atk:
  613  31:A1EA  46 2B                     lsr <.atkHigh
  614  31:A1EC  66 25                     ror <.atkLow
  615  31:A1EE  CA                        dex
  616  31:A1EF  D0 F9                     bne .shift_right_atk
  617  31:A1F1  60                rts
  618                     
  619                             VERIFY_PC $a28d
       31:A1F2                    .verify_pc_00128:
                0000              .if (.verify_pc_00128 > $a28d)
                                  .endif
  620                     ;
  621                     ;$a28d:
  622                     ;       checkSegmentation();    //$bf53();
  623                     ;       //if ((a = $6e[y = #31]) >= 0) {        //bmi a29a
  624                     ;       //      if ((a & 1) == 0) { //bne a2a6
  625                     ;       if ((a = $6e[y = #31] < 0)
  626                     ;               || (a & 1) != 0)
  627                     ;       {
  628                     ;$a29a:
  629                     ;               if ($7d == 0) {
  630                     ;$a29e:
  631                     ;                       $bc = $7c;
  632                     ;                       $bb = 0;
  633                     ;               }
  634                     ;       }
  635                     ;$a2a6:
  636                     ;       a = $6e[y = #33] & 4;
  637                     ;       if (a != 0) {
  638                     ;               $bb = $7c + $7d;
  639                     ;       }
  640                     ;$a2b5:
  641                     ;       return getActor2C(); //fall through
  642                     ;}
  643                     ;------------------------------------------------------------------------------------------------------
  644                             INIT_PATCH $31,$bd67,$bdaa
                0031              .bank   $31
                BD67              .org    $bd67
       31:BD67                    .ds             (($bdaa) - ($bd67))
                BD67              .org    $bd67
  645                     ;$31:bd67 spoilHp
  646  31:BD67            spoilHp:
  647           0026      .deadFlag = $26
  648           0042      .undead = $42
  649           0078      .damage = $78
  650           0024      .pCalc = $24
  651           006E      .pActor = $6e
  652           0070      .pTarget = $70
  653                     ;
  654  31:BD67  A9 00             lda #0
  655  31:BD69  85 26             sta <.deadFlag
  656  31:BD6B  20 E2 BB          jsr isTargetWeakToHoly  ;bbe2
  657  31:BD6E  90 0F             bcc .normal_target
  658                             ;undead
  659  31:BD70  A5 70                     lda <.pTarget
  660  31:BD72  48                        pha
  661  31:BD73  A5 71                     lda <.pTarget+1
  662  31:BD75  48                        pha
  663  31:BD76  20 B3 BD                  jsr set24ToActor
  664  31:BD79  E6 42                     inc <.undead
  665  31:BD7B  A9 81                     lda #$81
  666  31:BD7D  D0 08                     bne .do_damage
  667  31:BD7F            .normal_target:
  668  31:BD7F  A5 6E                     lda <.pActor
  669  31:BD81  48                        pha
  670  31:BD82  A5 6F                     lda <.pActor+1
  671  31:BD84  48                        pha
  672  31:BD85  A9 01                     lda #$01
  673  31:BD87            .do_damage:
  674  31:BD87  48                pha
  675  31:BD88  20 D2 BC          jsr damageHp    ;bcd2
  676  31:BD8B  68                pla
  677  31:BD8C  B0 02             bcs .alive
  678                             ;dead
  679  31:BD8E  85 26                     sta <.deadFlag
  680  31:BD90            .alive:
  681  31:BD90  A0 2E             ldy #$2e
  682  31:BD92  B1 6E             lda [.pActor],y
  683  31:BD94  C9 04             cmp #$04        ;fight
  684  31:BD96  D0 03             bne .do_heal
  685  31:BD98  20 AA BD                  jsr shiftRightDamageBy2 ;bdaa
  686  31:BD9B            .do_heal:
  687  31:BD9B  68                pla
  688  31:BD9C  85 25             sta <.pCalc+1
  689  31:BD9E  68                pla
  690  31:BD9F  85 24             sta <.pCalc
  691  31:BDA1  4C 24 BD          jmp healHp
  692                     ;$bdaa
  693                     
  694                     ;------------------------------------------------------------------------------------------------------
  695                             INIT_PATCH $31,$bcc9,$bcd2
                0031              .bank   $31
                BCC9              .org    $bcc9
       31:BCC9                    .ds             (($bcd2) - ($bcc9))
                BCC9              .org    $bcc9
  696  31:BCC9            applyStatus_addStoneMessage:
  697  31:BCC9  A9 28             lda #$28
  698  31:BCCB  4C B6 A1          jmp b31_queueBattleMessage
  699                     
  700                     ;======================================================================================================
  701                             RESTORE_PC ff3_battle_calc_begin
                0035              .bank   BANK(ff3_battle_calc_begin)
                B8F0              .org    ff3_battle_calc_begin
#[3]   ff3_hack_master.asm
   65                                     ;v0.7.8:
#[4]   ff3_calcDamage.asm
   66                                     .include "ff3_calcDamage.asm"
    1                     ; ff3_calcDamage.asm
    2                     ;
    3                     ;description:
    4                     ;       replaces damage calculation function
    5                     ;
    6                     ;version:
    7                     ;       0.01 (2007-08-22)
    8                     ;======================================================================================================
    9  35:B8F0            ff3_calcDamage_begin:
   10                     
   11                             INIT_PATCH $31,$bb44,$bbe2
                0031              .bank   $31
                BB44              .org    $bb44
       31:BB44                    .ds             (($bbe2) - ($bb44))
                BB44              .org    $bb44
   12                     
   13  31:BB44            calcDamage:
   14                     ;       $1c,1d = ((($25*(1.0~1.5)*($27/2)+$28*$29)-$26)*$7c)/$2a
   15                     ;       [in] u16 $25,2b : attack power?
   16                     ;       [in] u8 $26 : defence power?
   17                     ;       [in] u8 $27 : attr multiplier
   18                     ;       [in] u8 $28 : additional damage (critical modifier)
   19                     ;       [in] u8 $29 : critical count(0/1)
   20                     ;       [in] u8 $2a : damage divider (target count)
   21                     ;       [in] u8 $007c : damage multiplier (hit count)
   22                     ;       [out] u16 $1c : final damage (0-9999)
   23           0025      .atkLow = $25
   24           002B      .atkHigh = $2b
   25           0026      .def = $26
   26           0027      .attrMultiplier = $27
   27           0028      .criticalBonus = $28
   28           0029      .criticalMultiplier = $29
   29           002A      .damageDivider = $2a
   30           007C      .damageMultiplier = $7c
   31           006E      .pActor = $6e
   32           0070      .pTarget = $70
   33                     
   34  31:BB44  A5 2B             lda <.atkHigh
   35  31:BB46  4A                lsr a
   36  31:BB47  A5 25             lda <.atkLow
   37  31:BB49  6A                ror a
   38  31:BB4A  20 B4 BE          jsr b31_getBattleRandom
   39  31:BB4D  18                clc
   40  31:BB4E  65 25             adc <.atkLow
   41  31:BB50  85 18             sta <$18
   42  31:BB52  A5 2B             lda <.atkHigh
   43  31:BB54  69 00             adc #0
   44  31:BB56  85 19             sta <$19
   45                     
   46  31:BB58  A5 27             lda <.attrMultiplier
   47  31:BB5A  4A                lsr a
   48  31:BB5B  D0 0B             bne .multiply_atk
   49                             ;
   50  31:BB5D  A5 19                     lda <$19
   51  31:BB5F  4A                        lsr a
   52  31:BB60  48                        pha     ;sta <$1d
   53  31:BB61  A5 18                     lda <$18
   54  31:BB63  6A                        ror a
   55  31:BB64  48                        pha     ;sta <$1c
   56  31:BB65  4C 77 BB                  jmp .apply_critical
   57  31:BB68            .multiply_atk:
   58  31:BB68  85 1A                     sta <$1a
   59  31:BB6A  A9 00                     lda #0
   60  31:BB6C  85 1B                     sta <$1b
   61  31:BB6E  20 F5 FC                  jsr mul_16x16
   62  31:BB71  A5 1D                     lda <$1d
   63  31:BB73  48                        pha
   64  31:BB74  A5 1C                     lda <$1c
   65  31:BB76  48                        pha
   66  31:BB77            .apply_critical:        ;$bb75:
   67  31:BB77  A5 29             lda <.criticalMultiplier
   68  31:BB79  A6 28             ldx <.criticalBonus
   69  31:BB7B  20 D6 FC          jsr mul_8x8             ;fcd6
   70  31:BB7E  18                clc
   71  31:BB7F  68                pla
   72  31:BB80  65 1A             adc <$1a
   73  31:BB82  85 18             sta <$18
   74  31:BB84  68                pla
   75  31:BB85  65 1B             adc <$1b
   76  31:BB87  85 19             sta <$19
   77  31:BB89  20 B5 A2          jsr b31_getActor2C      ;a2b5
   78  31:BB8C  A2 00             ldx #0
   79  31:BB8E  11 70             ora     [.pTarget],y
   80  31:BB90  10 11             bpl .player_to_player
   81  31:BB92  38                        sec
   82  31:BB93  A5 18                     lda <$18
   83  31:BB95  E5 26                     sbc <$26
   84  31:BB97  85 18                     sta <$18
   85  31:BB99  B0 08                     bcs .atk_positive
   86  31:BB9B  C6 19                             dec <$19
   87  31:BB9D  10 04                             bpl .atk_positive
   88  31:BB9F  86 19                                     stx <$19
   89  31:BBA1  86 18                                     stx <$18
   90  31:BBA3            .atk_positive:
   91  31:BBA3            .player_to_player:
   92                             ;here a = 0
   93  31:BBA3  86 1B             stx <$1b
   94  31:BBA5  A5 7C             lda <.damageMultiplier
   95  31:BBA7  85 1A             sta <$1a
   96  31:BBA9  20 F5 FC          jsr mul_16x16
   97                             
   98  31:BBAC  A5 1C             lda <$1c
   99  31:BBAE  85 18             sta <$18
  100  31:BBB0  A5 1D             lda <$1d
  101  31:BBB2  85 19             sta <$19
  102                     
  103  31:BBB4  A5 2A             lda <.damageDivider
  104  31:BBB6  85 1A             sta <$1a
  105  31:BBB8  A9 00             lda #0
  106  31:BBBA  85 1B             sta <$1b
  107  31:BBBC  20 92 FC          jsr div_16
  108                     
  109           0001              .ifdef CHARGE_BREAK_DAMAGE_LIMIT
  110  31:BBBF  A0 27                     ldy #BP_OFFSET_ATTACK_MULTIPLIER
  111  31:BBC1  B1 6E                     lda [.pActor],y
  112  31:BBC3  D0 13                     bne .finish
  113                             .endif
  114  31:BBC5  38                sec
  115  31:BBC6  A5 1C             lda <$1c
  116  31:BBC8  E9 0F             sbc #LOW(9999)
  117  31:BBCA  A5 1D             lda <$1d
  118  31:BBCC  E9 27             sbc #HIGH(9999)
  119  31:BBCE  90 08             bcc .finish
  120                                     INIT16 <$1c,#9999
       31:BBD0  A9 0F             lda #LOW(#9999)
       31:BBD2  85 1C             sta <$1c
       31:BBD4  A9 27             lda #HIGH(#9999)
       31:BBD6  85 1D             sta <$1c+1
  121  31:BBD8            .finish:
  122  31:BBD8  60                rts
  123                     
  124                             VERIFY_PC $bbe2
       31:BBD9                    .verify_pc_00134:
                0000              .if (.verify_pc_00134 > $bbe2)
                                  .endif
  125                     ;=====================================================================================================
  126                             RESTORE_PC ff3_calcDamage_begin
                0035              .bank   BANK(ff3_calcDamage_begin)
                B8F0              .org    ff3_calcDamage_begin
#[3]   ff3_hack_master.asm
   67                                     ;v0.7.3:
#[4]   ff3_field_window.asm
   68                                     .include "ff3_field_window.asm"
    1                     ; ff3_field_window.asm
    2                     ;
    3                     ; description:
    4                     ;       replaces field::drawWindow($3f:ed02) related codes
    5                     ;
    6                     ; version:
    7                     ;       0.01 (2006-11-09)
    8                     ;======================================================================================================
    9  35:B8F0            ff3_field_window_begin:
   10                     
   11           0000              .if 0
   88                             .endif  ;//field_drawWindowBox
   89                     ;$3f:edc6 field::drawWindowLine
   90                     ;{
   91                     ;       $90 = $3c;
   92                     ;       $c98f();        //field::loadWindowPalette?
   93                     ;       waitNmiBySetHandler();  //$ff00();
   94                     ;       $4014 = 2;
   95                     ;       putWindowTiles();       //$f6aa();
   96                     ;       field::setWindowPalette();      //$c9a9();
   97                     ;       field::setBgScrollTo0();        //$ede1();
   98                     ;       return field::callSoundDriver();
   99                     ;$ede1:
  100                     ;}
  101                     ;       push ( $3d - 2 );
  102                     ;       field::getWindowTilesForTop();  //$edf6();
  103                     ;       field::drawWindowLine();        //$edc6();
  104                     ;       a = pop - 2;
  105                     ;       if (a != 0) { //beq ed3b
  106                     ;$ed23:
  107                     ;               if (a < 0) { //bcs ed2a
  108                     ;$ed25:
  109                     ;                       $3b--;
  110                     ;                       //jmp $ed3b
  111                     ;               } else {
  112                     ;$ed2a:
  113                     ;                       do {
  114                     ;                               push a;
  115                     ;                               field::getWindowTilesForMiddle();       //$ee1d();
  116                     ;                               field::drawWindowLine();        //$edc6();
  117                     ;                               a = pop a - 2;
  118                     ;                               if (a == 0) goto $ed3b
  119                     ;                       } while (a >= 0); //bcs ed2a
  120                     ;$ed39:
  121                     ;                       $3b--;
  122                     ;               }
  123                     ;       }
  124                     ;$ed3b:
  125                     ;       field::getWindowTilesForBottom()//$ee3e();
  126                     ;       field::drawWindowLine();        //$edc6();
  127                     ;$ed41:
  128                     ;       $38++; $39++;
  129                     ;       $3c -= 2;
  130                     ;       $3d -= 2;
  131                     ;       return restoreBanksBy$57();     //jmp $ecf5();
  132                     ;$ed56:
  133                     ;}
  134                     ;       $3f:f692 field::drawStringInWindow
  135                     ;{
  136                     ;       push a;
  137                     ;       waitNmiBySetHandler();  //$ff00
  138                     ;       $f0++;
  139                     ;       pop a;
  140                     ;       putWindowTiles();       //$f6aa
  141                     ;$f69c
  142                     ;       field::setBgScrollTo0();        //$ede1();
  143                     ;       field::callSoundDriver();
  144                     ;       call_switchFirst2Banks(per8kbank:a = $93);      //$ff03
  145                     ;       return $f683(); //??? a= ($93+1)
  146                     ;$f6aa:
  147                     ;}
  148                     
  149                     ;       INIT_PATCH $3f,$f692,$f69c
  150                     ;field_drawStringInWindow:
  151                     ;       jmp field_drawStringInWindowEx
  152                     
  153                     ;------------------------------------------------------------------------------------------------------
  154                     ;$3f:f40a setVramAddrForWindow
  155                     ;//     [in] u8 $3a : x offset
  156                     ;//     [in] u8 $3b : y
  157                             INIT_PATCH $3f,$f40a,$f435
                003F              .bank   $3f
                F40A              .org    $f40a
       3F:F40A                    .ds             (($f435) - ($f40a))
                F40A              .org    $f40a
  158  3F:F40A            field_setVramAddrForWindow:
  159  3F:F40A  A4 3A             ldy <$3a
  160  3F:F40C            field_setVramAddrForWindowEx:
  161                     ;[in] a : widthInCurrentBg
  162                     ;[in] y : offsetX
  163                     ;[out] y : offsetX & #20 ^ #20
  164                     ;[in]
  165           003A      .offsetX = $3a
  166           003B      .offsetY = $3b
  167                     ;[ref]
  168           F4A1      .vramAddrLow = $f4a1
  169           F4C1      .vramAddrHigh = $f4c1
  170                     ;--------------------------------------
  171  3F:F40C  98                tya
  172  3F:F40D  48                pha
  173  3F:F40E  A4 3B             ldy <.offsetY
  174  3F:F410  29 20             and #$20
  175  3F:F412  AA                tax
  176  3F:F413  F0 02             beq .left_on_1st_bg
  177  3F:F415  A9 04                     lda #$04
  178  3F:F417            .left_on_1st_bg:
  179  3F:F417  19 C1 F4          ora .vramAddrHigh,y
  180  3F:F41A  8D 06 20          sta $2006
  181                     
  182  3F:F41D  68                pla
  183  3F:F41E  29 1F             and #$1f
  184  3F:F420  19 A1 F4          ora .vramAddrLow,y
  185  3F:F423  8D 06 20          sta $2006
  186                     
  187                     ;x = left & #20
  188  3F:F426  8A                txa
  189  3F:F427  49 20             eor #$20
  190  3F:F429  A8                tay
  191                     
  192  3F:F42A  60                rts
  193                     
  194                             VERIFY_PC $f435
       3F:F42B                    .verify_pc_00137:
                0000              .if (.verify_pc_00137 > $f435)
                                  .endif
  195                     
  196                     ;------------------------------------------------------------------------------------------------------
  197                     ;$3f:f6aa putWindowTiles
  198                     ;//     [in] u8 $38 : offset x
  199                     ;//     [in] u8 $39 : offset per 2 line
  200                     ;//     [in,out] u8 $3b : offset y (wrap-around)
  201                             INIT_PATCH      $3f,$f6aa,$f727
                003F              .bank   $3f
                F6AA              .org    $f6aa
       3F:F6AA                    .ds             (($f727) - ($f6aa))
                F6AA              .org    $f6aa
  202                     
  203  3F:F6AA            field_drawWindowContent:
  204                     ;[in]
  205           0038      .left = $38
  206           003C      .width = $3c
  207           003A      .offsetX = $3a
  208           003A      .offsetString = $3a
  209           003B      .offsetY = $3b
  210           0090      .iChar = $90
  211           0091      .widthIn1stBg = $91
  212           0780      .tileArray = $0780
  213           0780      .upperLineString = $0780
  214           07A0      .lowerLineString = $07a0
  215                     
  216                     ;-----------------------------------------
  217  3F:F6AA  C9 09             cmp #9
  218  3F:F6AC  F0 05             beq .draw_lower_line
  219  3F:F6AE  A9 00                     lda #0
  220  3F:F6B0  20 B5 F6                  jsr .draw_line
  221  3F:F6B3            .draw_lower_line:
  222  3F:F6B3  A9 20             lda #$20
  223  3F:F6B5            .draw_line:
  224                     ;[in] a  = index offset
  225  3F:F6B5  48                pha
  226  3F:F6B6  85 3A             sta <.offsetString
  227                     
  228  3F:F6B8  2C 02 20          bit $2002
  229  3F:F6BB  A5 91             lda <.widthIn1stBg
  230  3F:F6BD  A4 38             ldy <.left
  231  3F:F6BF  20 E0 F6          jsr .putTiles   ;[out] y = offsetX & #20 ^ #20, $3a = offsetString
  232                     
  233  3F:F6C2  18                clc
  234  3F:F6C3  68                pla
  235  3F:F6C4  65 3C             adc <.width
  236  3F:F6C6  38                sec
  237  3F:F6C7  E5 3A             sbc <.offsetString
  238  3F:F6C9  90 05             bcc .next_line
  239  3F:F6CB  F0 03             beq .next_line
  240  3F:F6CD  20 E0 F6                  jsr .putTiles
  241                     
  242  3F:F6D0            .next_line:
  243  3F:F6D0  A4 3B             ldy <.offsetY
  244  3F:F6D2  C8                iny
  245  3F:F6D3  C0 1E             cpy #30
  246  3F:F6D5  D0 02             bne .no_wrap
  247  3F:F6D7  A0 00                     ldy #0
  248  3F:F6D9            .no_wrap:
  249  3F:F6D9  84 3B             sty <.offsetY
  250  3F:F6DB  A9 00             lda #0
  251  3F:F6DD  85 90             sta <$90
  252  3F:F6DF  60                rts
  253                     
  254  3F:F6E0            .putTiles:
  255  3F:F6E0  48                pha
  256                     
  257  3F:F6E1  20 0C F4          jsr field_setVramAddrForWindowEx
  258           003A      .beginOffset = .offsetString
  259           003A      .endOffset = .beginOffset
  260  3F:F6E4  68                pla     ;widthInCurrentBg
  261  3F:F6E5  A6 3A             ldx <.offsetString
  262  3F:F6E7  48                pha
  263  3F:F6E8  18                clc
  264  3F:F6E9  65 3A             adc <.offsetString
  265  3F:F6EB  85 3A             sta <.endOffset
  266  3F:F6ED  68                pla
  267  3F:F6EE  4A                lsr a
  268  3F:F6EF  6A                ror a
  269  3F:F6F0  10 04             bpl .length_even
  270                     ;odd
  271  3F:F6F2            .length_odd:
  272  3F:F6F2  90 19             bcc .copy_loop_1
  273  3F:F6F4  B0 09             bcs .copy_loop_3
  274                     ;even
  275  3F:F6F6            .length_even:
  276  3F:F6F6  B0 0E             bcs .copy_loop_2
  277  3F:F6F8            .copy_loop_0:
  278  3F:F6F8  BD 80 07          lda .tileArray,x
  279  3F:F6FB  8D 07 20          sta $2007
  280  3F:F6FE  E8                inx
  281  3F:F6FF            .copy_loop_3:
  282  3F:F6FF  BD 80 07          lda .tileArray,x
  283  3F:F702  8D 07 20          sta $2007
  284  3F:F705  E8                inx
  285  3F:F706            .copy_loop_2:
  286  3F:F706  BD 80 07          lda .tileArray,x
  287  3F:F709  8D 07 20          sta $2007
  288  3F:F70C  E8                inx
  289  3F:F70D            .copy_loop_1:
  290  3F:F70D  BD 80 07          lda .tileArray,x
  291  3F:F710  8D 07 20          sta $2007
  292  3F:F713  E8                inx
  293                             
  294  3F:F714  E4 3A             cpx <.offsetString
  295  3F:F716  D0 E0             bne .copy_loop_0
  296                     
  297  3F:F718  60                rts
  298                     
  299                             VERIFY_PC $f727
       3F:F719                    .verify_pc_00139:
                0000              .if (.verify_pc_00139 > $f727)
                                  .endif
  300                     
  301                     ;======================================================================================================
  302                             RESTORE_PC ff3_field_window_begin
                0035              .bank   BANK(ff3_field_window_begin)
                B8F0              .org    ff3_field_window_begin
#[3]   ff3_hack_master.asm
   69                                     ;v0.7.9:
#[4]   ff3_floor_treasure.asm
   70                                     .include "ff3_floor_treasure.asm"
    1                     ; ff3_floor_treasure.asm
    2                     ;
    3                     ;description:
    4                     ;       implements treasure related functions
    5                     ;
    6                     ;version:
    7                     ;       0.02 (2007-08-31)
    8                     ;======================================================================================================
#[5]   ff3_floor.h
    9                             .include "ff3_floor.h"
    1                     ; ff3_floor.h
    2                     ;
    3                     ;description:
    4                     ;       definitions for floor related functions
    5                     ;
    6                     ;version:
    7                     ;       0.01 (2007-08-29)
    8                     ;======================================================================================================
    9                     
   10                     ;bank 3c
   11                     
   12           937E      floor_searchSpaceForItem = $937e
   13                     
   14                     ;bank 3f
   15                     
   16           E51C      floor_getChipEvent      = $e51c
   17                     ;floor_getTreasure = $f549
   18                     ;floor_getItemValue = $f5d4
#[4]   ff3_floor_treasure.asm
   10  35:B8F0            ff3_floor_treasure_begin:
   11                     
   12                             INIT_PATCH $3f,$e917,$e9bb
                003F              .bank   $3f
                E917              .org    $e917
       3F:E917                    .ds             (($e9bb) - ($e917))
                E917              .org    $e917
   13                     
   14                     ;e917
   15  3F:E917            floor_processChipEvent:
   16                     ;[in]
   17           0049      .isTreasureGil = $49
   18           0078      .worldId = $78
   19           0080      .pFloorChips = $80
   20           0710      .treasureIdList = $0710
   21           600E      .leaderOffset = $600e
   22           6040      .treasureFlags = $6040
   23                     ;[local/params for functions]
   24           0044      .chipAttributes = $44
   25           0045      .eventParams = $45
   26           00BA      .isTreasureNaked = $ba
   27                     ;--------------------------------------------
   28                     
   29  3F:E917  20 1C E5          jsr floor_getChipEvent  ;$e51c() [out] y = chipid
   30  3F:E91A  A5 44             lda <.chipAttributes
   31  3F:E91C  10 10             bpl .no_event
   32  3F:E91E            .has_event:
   33  3F:E91E  C0 90             cpy #$90
   34  3F:E920  90 0C             bcc .no_event
   35  3F:E922  C0 A0             cpy #$a0
   36  3F:E924  90 0A             bcc .door_event
   37  3F:E926  C0 D0             cpy #$d0
   38  3F:E928  90 04             bcc .no_event
   39  3F:E92A  C0 F0             cpy #$f0
   40  3F:E92C  90 1C             bcc .treasure_event
   41  3F:E92E            .no_event:
   42  3F:E92E  18                clc
   43  3F:E92F  60                rts
   44                     
   45  3F:E930            .door_event:    ;[90 <= chipid < a0]
   46                     ;$e968:
   47  3F:E930  AE 0E 60          ldx .leaderOffset       ;600e
   48  3F:E933  BD 00 61          lda playerBaseParams,x  ;6100
   49  3F:E936  C9 08             cmp #JOB_THIEF  ;08
   50  3F:E938  F0 04             beq .door_is_unlocked
   51  3F:E93A  A9 03                     lda #$03
   52  3F:E93C  38                        sec
   53  3F:E93D  60                        rts
   54  3F:E93E            .door_is_unlocked:
   55  3F:E93E  AD 21 60          lda $6021
   56  3F:E941  09 40             ora #$40
   57  3F:E943  8D 21 60          sta $6021
   58  3F:E946  A9 7A             lda #$7a
   59  3F:E948  38                sec
   60  3F:E949  60                rts
   61                     
   62  3F:E94A            .treasure_event:        ;[d0 <= chipid < f0]
   63  3F:E94A  A2 00             ldx #0
   64  3F:E94C  C0 E0             cpy #$e0
   65  3F:E94E  90 01             bcc .store_naked
   66  3F:E950  CA                        dex
   67  3F:E951            .store_naked:
   68  3F:E951  86 BA             stx <.isTreasureNaked
   69                             
   70  3F:E953  20 97 E9          jsr floor_getTreasureFlagMaskAndIndex
   71  3F:E956  39 40 60          and .treasureFlags,y
   72  3F:E959  F0 D3             beq .no_event
   73                     ;has treasure
   74  3F:E95B  A9 BF             lda #$3f | $80
   75  3F:E95D  8D 49 7F          sta soundDriver_effectId
   76                     
   77  3F:E960  A5 BA             lda <.isTreasureNaked
   78  3F:E962  30 03             bmi .fetch_treasure
   79  3F:E964  20 F0 E6                  jsr $e6f0       ;unk
   80  3F:E967            .fetch_treasure:
   81  3F:E967  A5 80             lda <$80
   82  3F:E969  48                pha
   83  3F:E96A  A5 81             lda <$81
   84  3F:E96C  48                pha
   85                             
   86  3F:E96D  20 49 F5          jsr floor_getTreasure   ;f549 [out] a = message id
   87                             
   88  3F:E970  AA                tax
   89  3F:E971  68                pla
   90  3F:E972  85 81             sta <$81
   91  3F:E974  68                pla
   92  3F:E975  85 80             sta <$80
   93                     
   94  3F:E977  A0 00             ldy #0
   95  3F:E979  E0 50             cpx #$50        ;message ("もちものがいっぱいです")
   96  3F:E97B  D0 06             bne .got_treasure
   97  3F:E97D  84 44                     sty <.chipAttributes
   98  3F:E97F  84 0D                     sty <$0d
   99  3F:E981  F0 08                     beq .finish     ;
  100  3F:E983            .got_treasure:
  101  3F:E983  A5 BA             lda <.isTreasureNaked
  102  3F:E985  30 04             bmi .finish
  103  3F:E987  A9 7D                     lda #CHIPID_OPENED_TREASURE_BOX ;7d
  104  3F:E989  91 80                     sta [.pFloorChips],y
  105  3F:E98B            .finish:
  106  3F:E98B  8A                txa
  107  3F:E98C  38                sec
  108  3F:E98D  60                rts
  109                     
  110  3F:E98E            floor_getTreasureId:
  111                     ;[in]
  112           0045      .eventParams = $45
  113           0710      .treasureIdList = $0710
  114                     ;[out]
  115                     ;       a : treasureId
  116                     ;       x : list index
  117  3F:E98E  A5 45             lda <.eventParams
  118  3F:E990  29 0F             and #$0f
  119  3F:E992  AA                tax
  120  3F:E993  BD 10 07          lda .treasureIdList,x
  121  3F:E996  60                rts
  122                     
  123  3F:E997            floor_getTreasureFlagMaskAndIndex:
  124                     ;[in]
  125           0045      .eventParams = $45
  126           0078      .worldId = $78
  127           0710      .treasureIdList = $0710
  128           6040      .treasureFlags = $6040
  129                     ;[out]
  130                     ;       a : mask value
  131                     ;       x : bit index
  132                     ;       y : byte index
  133  3F:E997  20 8E E9          jsr floor_getTreasureId
  134  3F:E99A  48                pha
  135  3F:E99B  29 07             and #$07        ;mask to bit index
  136  3F:E99D  AA                tax
  137  3F:E99E  68                pla
  138  3F:E99F  4A                lsr a
  139  3F:E9A0  4A                lsr a
  140  3F:E9A1  4A                lsr a
  141  3F:E9A2  A4 78             ldy <.worldId
  142  3F:E9A4  F0 03             beq .test_flag
  143  3F:E9A6  18                        clc
  144  3F:E9A7  69 20                     adc #$20
  145  3F:E9A9            .test_flag:
  146  3F:E9A9  A8                tay
  147  3F:E9AA  BD AE E9          lda floor_setBitMask,x
  148  3F:E9AD  60                rts
  149                     
  150  3F:E9AE            floor_setBitMask:
  151  3F:E9AE  01 02 04          .db $01,$02,$04,$08,$10,$20,$40,$80
       3F:E9B1  08 10 20  
       3F:E9B4  40 80     
  152                     ;e9bb
  153                             VERIFY_PC $e9bb
       3F:E9B6                    .verify_pc_00142:
                0000              .if (.verify_pc_00142 > $e9bb)
                                  .endif
  154                     ;-----------------------------------------------------------------------------------------------------
  155                     ; treasure functions
  156                     ;
  157                             INIT_PATCH $3f,$f549,$f670
                003F              .bank   $3f
                F549              .org    $f549
       3F:F549                    .ds             (($f670) - ($f549))
                F549              .org    $f549
  158                     ;$3f:f549 getTreasure
  159                     ;//     [in] u8 $0710[0x10] : treasureIds
  160                     ;//     [in] u8 $45 : eventParam
  161                     ;//     [in] u8 $49 : warpparam.+01 & 0x20
  162                     ;//     [in] u8 $ba : 00: chipId=d0-df, FF: chipId=e0-ef
  163                     ;//             chipId:D0-DF = staticChipId:7C(宝箱)
  164                     ;//     [out] a : messageId
  165  3F:F549            floor_getTreasure:
  166                     ;[in]
  167           0045      .eventParams = $45
  168           0049      .isTreasureGil = $49
  169           0078      .worldId = $78
  170           008F      .treasureId = $8f
  171           00AB      .eventFlag = $ab
  172           006A      .encounterId = $6a
  173           00BA      .isTreasureNaked = $ba
  174           00BB      .messageParam = $bb
  175           0080      .treasureItem = $80     ;u24
  176           0081      .treasureItemCount = $81
  177           0710      .treasureIdList = $0710
  178           9C00      .treasureParams = $9c00 ;512params
  179                     ;------------------------------------------
  180  3F:F549  20 8E E9          jsr floor_getTreasureId
  181  3F:F54C  85 8F             sta <.treasureId
  182  3F:F54E  AA                tax
  183  3F:F54F            .getTreasureParam:
  184  3F:F54F  A9 01             lda #$01
  185  3F:F551  20 06 FF          jsr call_switch1stBank  ;ff06
  186  3F:F554  BD 00 9C          lda .treasureParams,x
  187  3F:F557  A4 78             ldy <.worldId
  188  3F:F559  F0 03             beq .got_param
  189  3F:F55B  BD 00 9D                  lda .treasureParams+$100,x
  190  3F:F55E            .got_param:
  191  3F:F55E  AA                tax
  192  3F:F55F  86 BB             stx <.messageParam
  193                     
  194  3F:F561  A5 BA             lda <.isTreasureNaked
  195  3F:F563  D0 04             bne .treasure_is_item
  196  3F:F565  A5 49             lda <.isTreasureGil
  197  3F:F567  D0 4B             bne .treasure_is_gil
  198  3F:F569            .treasure_is_item:
  199  3F:F569  86 80                     stx <.treasureItem
  200                     
  201  3F:F56B  A9 01                     lda #$01
  202  3F:F56D  E0 57                     cpx #$57        ;leather shield
  203  3F:F56F  B0 06                     bcs .store_increment
  204  3F:F571  E0 4F                             cpx #$4f        ;wooden arrow
  205  3F:F573  90 02                             bcc .store_increment
  206  3F:F575  A9 14                                     lda #20
  207  3F:F577                    .store_increment:
  208  3F:F577  85 81                     sta <.treasureItemCount
  209                     
  210  3F:F579  20 27 F7                  jsr switchBanksTo3c3d   ;f727
  211                                     
  212                                     ;lda <.treasureParam
  213                                     ;sta <.messageParam     ;$bb
  214                                     
  215  3F:F57C  20 7E 93                  jsr floor_searchSpaceForItem    ;3c:937e [out] x = index to put
  216  3F:F57F  90 03                     bcc .put_item
  217                                             ;item_full
  218  3F:F581  A9 50                             lda #$50        ;"もちものがいっぱいです"
  219  3F:F583  60                                rts
  220  3F:F584                    .put_item:
  221  3F:F584  A5 80                     lda <.treasureItem
  222  3F:F586  9D C0 60                  sta backpackItems,x
  223  3F:F589  BD E0 60                  lda backpackItems+$20,x ;count
  224  3F:F58C  18                        clc
  225  3F:F58D  65 81                     adc <.treasureItemCount
  226  3F:F58F  C9 64                     cmp #100
  227  3F:F591  90 02                     bcc .store_item_count
  228  3F:F593  A9 63                             lda #99
  229  3F:F595                    .store_item_count:
  230  3F:F595  9D E0 60                  sta backpackItems+$20,x
  231                     
  232  3F:F598  20 C0 F5                  jsr floor_invertTreasureFlag
  233                     
  234  3F:F59B  A5 BA                     lda <.isTreasureNaked
  235  3F:F59D  F0 03                     beq .treasure_in_box
  236  3F:F59F  A9 76                             lda #$76        ;"こんなところにxxが！"
  237  3F:F5A1  60                                rts
  238  3F:F5A2                    .treasure_in_box:
  239  3F:F5A2  A5 8F                     lda <.treasureId
  240  3F:F5A4  C9 E0                     cmp #TREASURE_WITH_ENCOUNTER_BASE       ;$e0
  241  3F:F5A6  B0 03                     bcs .encounter
  242  3F:F5A8  A9 59                             lda #$59        ;"たからばこのなかから..."
  243  3F:F5AA  60                                rts
  244  3F:F5AB                    .encounter:
  245  3F:F5AB  85 6A                     sta <.encounterId
  246  3F:F5AD  A9 20                     lda #EVENT_FLAG_ENCOUNTER       ;$20
  247  3F:F5AF  85 AB                     sta <.eventFlag
  248  3F:F5B1  A9 02                     lda #$02        ;"たからばこの...とつぜんモンスターが..."
  249  3F:F5B3  60                        rts
  250  3F:F5B4            .treasure_is_gil:
  251                             ;here x ==  (itemid)
  252  3F:F5B4  20 CA F5          jsr floor_getItemValue  ;f5d4
  253  3F:F5B7  20 F4 F5          jsr floor_incrementPartyGil
  254  3F:F5BA  20 C0 F5          jsr floor_invertTreasureFlag
  255  3F:F5BD  A9 01             lda #$01        ;"たからばこの...ぎるてにいれた"
  256  3F:F5BF  60                rts
  257                     
  258                     ;$3f:f640 invertTreasureFlag
  259  3F:F5C0            floor_invertTreasureFlag:
  260                     ;[in]
  261           0045      .eventParams = $45
  262           0078      .worldId = $78
  263           0710      .treasureIdList = $0710
  264           6040      .treasureFlags = $6040
  265  3F:F5C0  20 97 E9          jsr floor_getTreasureFlagMaskAndIndex
  266  3F:F5C3  59 40 60          eor .treasureFlags,y
  267  3F:F5C6  99 40 60          sta .treasureFlags,y
  268  3F:F5C9  60                rts
  269                     
  270                             VERIFY_PC $f5d4
       3F:F5CA                    .verify_pc_00144:
                0000              .if (.verify_pc_00144 > $f5d4)
                                  .endif
  271                     ;-------------------------------------------------------------------------------------------------
  272                     ;$3f:f5d4 getItemValue ;getTreasureGil
  273                     ;       [in] x : itemid
  274                     ;       [out] u24 $80 : = $10:9e00[x]
  275                     ;caller:
  276                     ;       $3d:b230 @ floor::shop::getItemValues
  277                     ;       $3d:b271 @ floor::shop::getItemValue
  278                     ;       $3f:ef73 @ field::decodeString 
  279                     ;       $3f:f5b8 @ floor::getTreasure
  280                     ;       caller expects y has been unchanged
  281  3F:F5CA            floor_getItemValue:
  282           0080      .value = $80
  283           9E00      .itemValues = $9e00
  284                     ;------------------------
  285  3F:F5CA  A9 10             lda #$10
  286  3F:F5CC  20 06 FF          jsr call_switch1stBank
  287                     
  288  3F:F5CF  8A                txa
  289  3F:F5D0  0A                asl a
  290  3F:F5D1  AA                tax
  291  3F:F5D2  B0 0A             bcs .item_80_to_ff
  292  3F:F5D4  BD 00 9E                  lda .itemValues,x
  293  3F:F5D7  85 80                     sta <.value
  294  3F:F5D9  BD 01 9E                  lda .itemValues+1,x
  295  3F:F5DC  90 08                     bcc .store_value
  296  3F:F5DE            .item_80_to_ff:
  297  3F:F5DE  BD 00 9F                  lda .itemValues+$100,x
  298  3F:F5E1  85 80                     sta <.value
  299  3F:F5E3  BD 01 9F                  lda .itemValues+$101,x
  300  3F:F5E6            .store_value:
  301  3F:F5E6  85 81             sta <.value+1
  302  3F:F5E8  A9 00             lda #0
  303  3F:F5EA  85 82             sta <.value+2
  304  3F:F5EC  8A                txa
  305  3F:F5ED  4A                lsr a
  306  3F:F5EE  AA                tax
  307                     
  308  3F:F5EF  A9 3C             lda #$3c
  309  3F:F5F1  4C 06 FF          jmp call_switch1stBank
  310                     ;--------------------------------------------------------------------------------------------------
  311                     ;$3f:f5ff incrementGil
  312                     ;//     [in] u24 $80 : gil
  313                     ;       INIT_PATCH $3f,$f5ff,$f670
  314                     
  315  3F:F5F4            floor_incrementPartyGil:
  316                     ;[in]
  317           0080      .gil = $80
  318           601C      .partyGil = $601c
  319  3F:F5F4  A2 00             ldx #0
  320  3F:F5F6  8A                txa
  321  3F:F5F7            .add24:
  322  3F:F5F7  6A                        ror a
  323  3F:F5F8  BD 1C 60                  lda .partyGil,x
  324  3F:F5FB  75 80                     adc <.gil,x
  325  3F:F5FD  9D 1C 60                  sta .partyGil,x
  326  3F:F600  2A                        rol     a;save carry
  327  3F:F601  E8                        inx
  328  3F:F602  E0 03                     cpx #3
  329  3F:F604  D0 F1                     bne .add24
  330                     
  331  3F:F606  A2 FD             ldx #$fd
  332  3F:F608  38                sec
  333  3F:F609            .cmp24:
  334  3F:F609  BD 1F 5F                  lda .partyGil-$fd,x
  335  3F:F60C  FD 23 F5                  sbc .maxGil-$fd,x
  336  3F:F60F  E8                        inx
  337  3F:F610  D0 F7                     bne .cmp24
  338                     
  339  3F:F612  90 0B             bcc .finish
  340                     
  341                     ;here x == 0
  342  3F:F614  A2 02             ldx #2
  343  3F:F616            .init24:
  344  3F:F616  BD 20 F6                  lda .maxGil,x
  345  3F:F619  9D 1C 60                  sta .partyGil,x
  346  3F:F61C  CA                        dex
  347  3F:F61D  10 F7                     bpl .init24
  348  3F:F61F            .finish:
  349  3F:F61F  60                rts
  350  3F:F620            .maxGil:
  351  3F:F620  7F 96 98          .db $7f,$96,$98 ;9999999
  352                             
  353                             VERIFY_PC $f670
       3F:F623                    .verify_pc_00145:
                0000              .if (.verify_pc_00145 > $f670)
                                  .endif
  354                     
  355                     ;------------------------------------------------------------------------------------------------------
  356                     ;quick fixes
  357           003D              .bank   $3d
  358           B230              .org    $b230
  359  3D:B230  20 CA F5          jsr floor_getItemValue
  360           B271              .org    $b271
  361  3D:B271  20 CA F5          jsr floor_getItemValue
  362                             
  363           003F              .bank   $3f
  364           EF73              .org    $ef73
  365  3F:EF73  20 CA F5          jsr floor_getItemValue
  366                     
  367           003D              .bank   $3d
  368           B1C2              .org    $b1c2
  369  3D:B1C2  20 F4 F5          jsr floor_incrementPartyGil
  370                     ;=====================================================================================================
  371                             RESTORE_PC ff3_floor_treasure_begin
                0035              .bank   BANK(ff3_floor_treasure_begin)
                B8F0              .org    ff3_floor_treasure_begin
#[3]   ff3_hack_master.asm
   71                     
   72           0000                      .ifdef EXPERIMENTAL
   74                                     .endif  ;EXPERIMENTAL
   75                             .endif  ;BETA
   76                     
   77                             ;.include "ff3_battle_calc.asm"
   78                     ;==========================================================================================================
#[2]   ff3_hack_beta.asm
#[1]   ff3_hack_another.asm
