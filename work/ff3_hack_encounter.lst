#[1]   ff3_hack_encounter.asm
   15                     ;----------------------------------------------------------------------------------------------------------
   16  00:E000                    .incbin "ff3_hack_base.nes"     ;header must be stripped
#[4]   ff3_asm.h
   17                             .include "ff3_asm.h"
    1                     ; ff3_asm.h
    2                     ;
    3                     ; include file for hackcodes
    4                     ;======================================================================================================
    5                     ;proc addrs
#[5]   ff3_30-31.h
    6                             .include "ff3_30-31.h"
    1                     ; ff3_30-31.h
    2                     ;
    3                     ;description:
    4                     ;       include file for bank $30,$31
    5                     ;
    6                     ;version:
    7                     ;       v0.03 (2006-10-31)
    8                     ;
    9                     ;======================================================================================================
   10                     ;$30-31
   11           A2B5      b31_getActor2C                          = $a2b5 ;2c:index & flag
   12           A2BA      cacheStatus                                     = $a2ba
   13           A482      loadPlayerParam                         = $a482
   14           A4F6      loadEnemyParam                          = $a4f6
   15           A91B      decideEnemyActionTarget         = $a91b
   16           A9F7      isValidTarget                           = $a9f7 ;[out] bool zero :valid
   17           AA16      recalcPlayerParam                       = $aa16
   18           AF77      calcAction                                      = $af77
   19           B9AB      segmentate                                      = $b9ab
   20           BB28      getRandomSucceededCount         = $bb28 ;$24:count, $25:rate, [out] $30:succeededCount
   21           BB44      calcDamage                                      = $bb44 ;[out] $1c,1d : damage
   22           BBE2      isTargetWeakToHoly                      = $bbe2 ;[out] $27: 2=weak
   23           BC25      b31_getTarget2C                         = $bc25
   24                     ;applyDamage                                    = $bcd2
   25           BCD2      damageHp                                        = $bcd2
   26           BD24      healHp                                          = $bd24
   27           BDAA      shiftRightDamageBy2                     = $bdaa
   28           BDB3      set24ToActor                            = $bdb3
   29           BDBC      set24ToTarget                           = $bdbc
   30           BE90      b31_updatePlayerOffset          = $be90
   31           BE98      b31_setYtoOffsetOf                      = $be98
   32           BE9D      calcDataAddress                         = $be9d
   33           BEB4      b31_getBattleRandom                     = $beb4
   34           BF53      checkSegmentation                       = $bf53
#[4]   ff3_asm.h
#[5]   ff3_32-33.h
    7                             .include "ff3_32-33.h"
    1                     ; ff3_32-33.h
    2                     ;
    3                     ;description:
    4                     ;       include file for bank $32,33
    5                     ;
    6                     ;version:
    7                     ;       v0.02 (2006-10-23)
    8                     ;
    9                     ;======================================================================================================
   10                     ;$32-33
   11           8AE6      incrementSwingFrame                     = $8ae6 ;a = ++$b6
   12           A059      beginSwingFrame                         = $a059 ;$b6 = 0
   13           A094      blowEffect_limitHitCount        = $a094
   14           A0C0      effect_playerBlow                       = $a0c0 ;[effectFunction_04]
   15           A245      getSwingCountOfCurrentHand      = $a245
   16           A44F      getSys0Random_00_ff                     = $a44f
#[4]   ff3_asm.h
#[5]   ff3_34-35.h
    8                             .include "ff3_34-35.h"
    1                     ; ff3_34-35.h
    2                     ;
    3                     ;description:
    4                     ;       label definition for bank $34-35
    5                     ;
    6                     ;version:
    7                     ;       0.03 (2006-10-19)
    8                     ;
    9                     ;======================================================================================================
   10                     ;$34-35
   11           801E      dispatchBattleFunction_03       = $801e
   12           8026      dispatchBattleFunction_05       = $8026
   13           802A      dispatchBattleFunction_06       = $802a
   14           802E      dispatchBattleFunction_07       = $802e
   15           8185      presentCharacter                        = $8185
   16                     ;playEffect                                     = $8411 ;hacked
   17           8532      set52toIndexFromActorBit        = $8532 ;[in] $7e98 : target indicator bits?,
   18           8545      dispatchPresentScene_1f         = $8545
   19           86AB      targetBitToCharIndex            = $86ab ;[in] x = side? [out] y = index
   20           892E      tileSprites2x2                          = $892e
   21           8966      loadCursor                                      = $8966
   22           899E      getInputAndUpdateCursorWithSound = $899e
   23           8ADF      clearSprites2x2                         = $8adf
   24                     
   25           8B38      draw8LineWindow                         = $8b38 ;[in] $18:left, $19:right, $1a:borderFlag, $7ac0:tilePtr
   26           8D03      setBackgroundProperty           = $8d03 ;
   27           8D1B      draw1LineWindow                         = $8d1b ;[in] $18:windowkind
   28           8EB0      eraseWindow                                     = $8eb0
   29           8F0B      eraseFromLeftBottom0Bx0A        = $8f0b
   30           91CE      setNoTargetMessage                      = $91ce
   31           95BD      setBaseAddrTo_8a40                      = $95bd
   32           95C6      setBaseAddrTo_8c40                      = $95c6
   33           95E1      itoa_16                                         = $95e1
   34           966A      strToTileArray                          = $966a
   35                     ;initTileArrayStorage           = $9754 ;hacked (fill $7200[0x200] and set $4e to point $7200)
   36                     ;getCommandInput_next           = $99fd ;hacked
   37           9A69      createCommandWindow                     = $9a69
   38           9AE7      putCanceledItem                         = $9ae7
   39           9B79      requestSoundEffect18                    = $9b79 ;setCA_18_and_incC9
   40           9B7D      requestSoundEffect05                    = $9b7d ;setCA_05_and_incC9
   41           9B81      requestSoundEffect06                    = $9b81 ;setCA_06_and_incC9
   42           9B88      setYtoOffsetOf                          = $9b88 ;y = $5f + a
   43           9B8D      setYtoOffset03                          = $9b8d
   44           9B94      setYtoOffset2F                          = $9b94 ;target indicator
   45           9B9B      setYtoOffset2E                          = $9b9b ;action id
   46           9BA2      drawInfoWindow                          = $9ba2
   47           9D1D      cachePlayerStatus                       = $9d1d
   48           9D9E      drawEnemyNamesWindow            = $9d9e
   49           9F7B      setActorActionAndClearMode      = $9f7b
   50           9F87      setActionTargetToSelf           = $9f87
   51                     ;getIndexOfGreatest                     = $a30f ;hacked [in] u16 $1a[4] : values ,$24[4] : indices [out] x : index
   52           A353      consumeEquippedItem                     = $a353 ;x unchanges
   53           A42E      getActor2C                                      = $a42e
   54           A541      getPlayerOffset                         = $a541
   55           A549      initString                                      = $a549 ;fill x bytes at $7ad7 #$00ff (null terminated)
   56           A558      offsetTilePtr                           = $a558
   57           A564      getSys1Random                           = $a564
   58           A609      loadString                                      = $a609
   59                     ;itemWindowInputLoop            = $aeaa ;hacked
   60                     ;endItemWindow                          = $b1b0 ;hacked
   61                     ;itemWindow_OnB                         = $b198 ;hacked
   62                     ;loadTileArrayForItemWindowColumn = $b48b
   63                     ;moveCursor                                     = $b4d4 ;hacked
   64                     ;itemWindow_OnUse                       = $b4f7 ;hacked
   65                     ;drawEquipWindow                        = $b419 ;hacked
   66                     ;drawEquipWindowNoErase         = $b5f9 ;hacked
   67                     ;isPlayerAllowedToUseItem       = $b8fd ;hacked
   68           B979      setActionTargetByParam          = $b979
   69           BA3A      loadTo7400FromBank30            = $ba3a
#[4]   ff3_asm.h
    9                     ;$3e-3f
   10           F8B0      updateDmaPpuScrollSyncNmiEx = $f8b0
   11           F8C5      updateDmaPpuScrollSyncNmi       = $f8c5 ;(y is unchanged)
   12           F8E0      setVramAddr                                     = $f8e0 ;[in] a:high, x:low
   13           F8EA      mul_8x8_reg                                     = $f8ea ;a,x = a * x
   14           FA0E      call_2e_9d53                            = $fa0e
   15           FA26      doBattle                                        = $fa26
   16           FB80      waitNmi                                         = $fb80 ;wait on $05 clear
   17           FB87      switchFirst2Banks                       = $fb87 ;[in] a : per16k bank index
   18           FBAA      getPad1Input                            = $fbaa ;[out] $12 : inputFlags
   19           FBEF      getBattleRandom                         = $fbef ;[out] a : rand [min:x - max:a] max included
   20           FC27      initBattleRandom                        = $fc27
   21           FC92      div_16                                          = $fc92 ;$1c = $18,19 / $1a,1b; $1d = $18,19 % $1a,1b
   22           FCD6      mul_8x8                                         = $fcd6 ;$1a,1b = a * x
   23           FCF5      mul_16x16                                       = $fcf5 ;$1c,1d,1e,1f = $18,19 * $1a,1b
   24           FD20      flagTargetBit                           = $fd20
   25           FD2C      clearTargetBit                          = $fd2c
   26           FD38      maskTargetBit                           = $fd38
   27           FD3C      shiftLeft6                                      = $fd3c
   28           FD43      shiftRight6                                     = $fd43
   29           FD4A      loadStringWorker                        = $fd4a
   30           FD60      get2byteAtBank18                        = $fd60
   31           FDA6      loadTo7400Ex                            = $fda6
   32           FDDC      copyTo7400                                      = $fddc
   33                     ;call_30_9e58                           = $fdf3
   34           FDF3      invoke_b30_battleFunction       = $fdf3
   35                     ;----------------------------------------------------------------------------------------------------------
   36                     ;well known vars
   37           0101      pNmiHandler                     = $0101 ;$0100 jmp xxxx
   38           0104      pIrqHandler                     = $0104 ;$0103 jmp xxxx
   39           0005      nmiFlag                         = $05
   40           0006      ppuCtrl1SetOnNmi        = $06
   41           0008      ppuCtrl1SetOnIrq        = $08
   42           0009      ppuCtrl2SetOnNmi        = $09
   43           000C      scrollXSetOnNmi         = $0c
   44           000D      scrollYSetOnNmi         = $0d
   45           0010      scrollXSetOnIrq         = $10
   46           0011      scrollYSetOnIrq         = $11
   47           0012      inputBits                       = $12
   48           00B3      selectTarget_behavior           = $b3   ;param of presentSceneFunction10($2e:9d53)
   49           00B4      selectTarget_selectedBits       = $b4
   50           00B5      selectTarget_targetFlag         = $b5
   51           00C0      playerX                         = $c0   ;*4
   52           00C4      playerY                         = $c4   ;*4
   53           00C9      playSoundEffect         = $c9   ;1=play
   54           00CA      soundEffectId           = $ca   ; played on irq if $c9 != 0
   55           00E0      targetStatusCache       = $e0   ;in process battle phase
   56           00F0      actorStatusCache        = $f0   ;
   57           78D5      presentActionParams     = $78d5 ;?,actor,action,targetflag,effectmsg,messages
   58           78D5      battleProcessType       = $78d5
   59           78D7      actionName                      = $78d7
   60           78D8      targetName                      = $78d8
   61           78D9      effectMessage           = $78d9
   62           78DA      battleMessages          = $78da
   63           78EE      battleMessageCount      = $78ee
   64                     ;pTileArray                     = $7ac0
   65           7AC7      selectedMagicLv         = $7ac7 ;[4]
   66           7AD7      stringCache                     = $7ad7
   67           7BE3      battleRandoms           = $7be3
   68           7CED      encounterId                     = $7ced
   69           7CF3      isRendering                     = $7cf3
   70                     
   71           7D6B      groupToEnemyIdMap       = $7d6b ;*4
   72                     ;;indexToGroupMap               = $7da7
   73           7DD7      enemyPos                        = $7dd7 ;{x,y}*8
   74                     ;param for playing (magic) effect
   75           7E1F      play_weaponRight                = $7e1f
   76           7E20      play_weaponLeft                 = $7e20
   77           7E4F      play_damages                    = $7e4f
   78           7E6F      play_damageTarget               = $7e6f ;0=player
   79           7E98      play_actorBits                  = $7e98
   80           7E96      play_arrowTarget                = $7e96
   81           7E99      play_castTargetBits             = $7e99 ;battle
   82           7E9A      play_effectTargetSide   = $7e9a ;80:actor enemy 40:target enemy
   83           7E9B      play_effectTargetBits   = $7e9b ;param of presentActionEffect($33:b68d)
   84           7E9D      play_magicType                  = $7e9d
   85           7EB8      play_reflectedTargetBits= $7eb8 ;param of presentEffectAtTarget($33:b64f)
   86                     
   87           7EC2      effectHandlerIndex      = $7ec2 ;
   88           7EC3      effectHandlerFlag       = $7ec3
   89           7EC4      effect_enemyStatus      = $7ec4
   90           7ECD      indexToGroupMap         = $7ecd ;*8
   91           7ED8      battleMode                      = $7ed8 ; 80:boss? 20:fireCannon(invincible) 10:disallowEnlarge 08:? 01:disallowEscape
   92           7EDF      play_protectionTargetBits = $7edf
   93           7EE1      play_segmentatedGroup = $7ee1
   94                     
   95           7F40      soundDriver_playingMusicId = $7f40
   96           7F41      soundDriver_lastMusicId = $7f41
   97           7F42      soundDriver_control     = $7f42 ;01:playNew(7f43) 02:playLast(7f41,saved when 01) 04:stop 80:playOn
   98           7F43      soundDriver_musicId     = $7f43
   99           7F49      soundDriver_effectId= $7f49     ;msb should be 1
  100                     ;----------------------------------------------------------------------------------------------------------
  101                     ;in memory structs
  102           60C0      backpackItems           = $60c0
  103           6100      playerBaseParams        = $6100
  104           6200      playerEquips            = $6200
  105           7575      playerBattleParams      = $7575 ;$40*4
  106           7675      enemyBattleParams       = $7675 ;$40*8
  107                     ;----------------------------------------------------------------------------------------------------------
  108                     ;in rom structs
  109           0900      userFlags                       = $00900
  110           0000      stringPtrTable          = $30000
  111           0000      monsterBaseParams       = $60000        ;8*256
  112           1000      monsterBattleParams = $61000
  113           1400      itemBaseParams          = $61400
  114           3B88      initialMps                      = $73b88
  115           AD59      lvupParamPtrTable       = $7ad59
  116                     ;handler tables
  117           83F8      commandIdToEffectMap    = $683f8
  118           843E      commandEffectHandlers   = $6843e
  119           9A16      commandWindowHandlers   = $69a16
  120           9FAC      commandHandlers                 = $69fac
  121                     ;------------------------------------------------------------------------------------------------------
  122           7900      TEMP_RAM = $7900        ;we cannot use stack regeon due to dugeon's floor save
  123                     ;------------------------------------------------------------------------------------------------------
  124           001E      EXSTATUS_OFFSET_PARAM   = $1e
  125           001F      EXSTATUS_OFFSET_TYPE    = $1f
  126                     
  127           003C      EXTRA_ABILITY_OFFSET    = $3c
  128                     
  129           00F0      PASSIVE_ABILITY_MASK    = $F0
  130           0080      PASSIVE_COUNTER                 = $80
  131           0040      PASSIVE_DOUBLE_ITEM_EFFECT = $40
  132           0020      PASSIVE_PROTECT                 = $20
  133           0010      PASSIVE_SUMMON_FUSION   = $10
  134                     
  135           0019      EFFECT_PROVOKE  = $19
  136           001A      EFFECT_ABYSS    = $1a
  137                     
  138           0016      CMDX_ID_BEGIN           = $16
  139           0016      CMDX_PROVOKE            = $16
  140           0017      CMDX_DISORDERED_SHOT= $17
  141           0018      CMDX_ABYSS                      = $18
  142           0019      CMDX_ID_END                     = $19
  143                     
  144           0006      BATTLE_PROCESS_EX_DISORDERED_SHOT = $06
  145                     
  146           0026      PRESENT_SCENE_EX_BLOWONLY = $26
  147           0027      PRESENT_SCENE_EX_ABYSS = $27
  148                     
  149           000A      BF_PICK_RANDOM_TARGET = $0a
  150           000B      BF_GET_RANDOM_SUCCEEDED_COUNT = $0b
  151           000C      BF_CALC_DAMAGE = $0c
  152                     ;------------------------------------------------------------------------------------------------------
  153                     ;macros
  154                     INIT16  .macro  ;addr,val
  155                             lda #LOW(\2)
  156                             sta \1
  157                             lda #HIGH(\2)
  158                             sta \1+1
  159                                     .endm
  160                     
  161                     INIT16_x        .macro  ;addr,val
  162                             ldx #LOW(\2)
  163                             stx \1
  164                             ldx #HIGH(\2)
  165                             stx \1+1
  166                                     .endm
  167                                             
  168                     ADD16   .macro  ;addr,val               
  169                             lda \1
  170                             clc
  171                             adc #LOW(\2)
  172                             sta \1
  173                             lda \1+1
  174                             adc #HIGH(\2)
  175                             sta \1+1
  176                                     .endm
  177                                                     
  178                     SUB16   .macro  ;addr,val               
  179                             lda \1
  180                             sec
  181                             sbc #LOW(\2)
  182                             sta \1
  183                             lda \1+1
  184                             sbc #HIGH(\2)
  185                             sta \1+1
  186                                     .endm
  187                                     
  188                     FILEORG .macro
  189                             .bank   (\1) >> 13
  190                             .org    ($8000 | ((\1) & $7fff))
  191                                     .endm
  192                                     
  193                     RESTORE_PC      .macro
  194                             .bank   BANK(\1)
  195                             .org    \1
  196                                     .endm
  197                                     
  198                     INIT_PATCH      .macro
  199                             .bank   \1
  200                             .org    \2
  201                             .ds             ((\3) - (\2))
  202                             .org    \2
  203                                     .endm
  204                     
  205           0000              .ifdef RESPECT_ORIGINAL_ADDR
  209                             .else
  210                     ORIGINAL_ADDR   .macro
  211                                     .endm
  212                             .endif
  213                             
  214                     ALIGN_EVEN      .macro  ;value to align
  215                             .check_align_\@:
  216                             .if (.check_align_\@ & 1) != 0
  217                                     nop     ;pad
  218                             .endif
  219                             .endm   ;ALIGN_EVEN
#[3]   ff3_hack_master.asm
   18           0000              .bank   $00
   19           8000              .org    $8000
#[4]   ff3_string.asm
   20                             .include "ff3_string.asm"
    1                     ; ff3_string.asm
    2                     ;
    3                     ; string related codes in bank $34-35
    4                     ;
    5                     ;version:
    6                     ;       0.03 (2006-10-13)
    7                     ;======================================================================================================
    8  00:8000            ff3_string_begin:
    9                     ;$34:95e1 itoa_16
   10                     ;//     [in]    u16 $18 : value
   11                     ;//     [out]   u8 $1a[5] : tileArray (higher digit first)
   12                     ;{
   13                     ;       for (a = #80,x = 3;x >= 0;x--) {
   14                     ;$95e5:         $1a.x = a;      //#80 = '0'
   15                     ;       }
   16                     ;       $1f = x;
   17                     ;       $20 = #2710; countAndDecrementUntil0(); //$34:9648();
   18                     ;       $20 = #03e8; countAndDecrementUntil0(); //$34:9648();
   19                     ;       $20 = #0064; countAndDecrementUntil0(); //$34:9648();
   20                     ;       $20 = #000a; countAndDecrementUntil0(); //$34:9648();
   21                     ;$9618: 
   22                     ;       $1e = $18 + #80;
   23                     ;
   24                     ;       if (#80 != (a = $1a)) return;
   25                     ;$9625: $1a = #ff;
   26                     ;       //以下$1b,1c,1dも同様の処理(0ならスペースに置換)
   27                     ;$9647:
   28                     ;}
   29                     
   30                     ;$34:9648 countAndDecrementUntil0
   31                     ;//     [in] u16 $20 : decrementBy
   32                     ;{
   33                     ;       x++;
   34                     ;       do {
   35                     ;$9649:         $18,19 -= $20,21;
   36                     ;               $1a.x++;
   37                     ;       } while ($18,19 >= 0);
   38                     ;       $18,19 += $20,21;
   39                     ;       $1a.x--;
   40                     ;$966a:
   41                     ;}
   42                     
   43                     ;======================================================================================================
   44                     ;strToTileArray
   45                     ; 意外にもフィールドのルーチンからも呼ばれる模様
   46           0001              .ifdef ENABLE_strToTileArray
   47           0034              .bank   $34
   48           966A              .org    $966a
   49                             
   50  34:966A            strToTileArray:
   51           0018      .cchLine        = $18
   52           001C      .char           = $1c
   53           001E      .pUpperLine     = $1e
   54           004E      .pTileArray     = $4e
   55           7AD7      .pString        = $7ad7
   56  34:966A  A5 4E             lda <.pTileArray
   57  34:966C  85 1E             sta <.pUpperLine
   58  34:966E  A5 4F             lda <.pTileArray+1
   59  34:9670  85 1F             sta <.pUpperLine+1
   60  34:9672  A5 18             lda <.cchLine
   61  34:9674  20 58 A5          jsr offsetTilePtr
   62                             
   63  34:9677  A0 00             ldy #0
   64  34:9679  A2 00             ldx #0
   65  34:967B            .decode_loop:
   66  34:967B  8A                txa
   67  34:967C  48                pha
   68  34:967D  BD D7 7A          lda .pString,x
   69  34:9680  F0 4D             beq .return
   70  34:9682  C9 01             cmp #1
   71  34:9684  F0 4F             beq .force_linefeed
   72  34:9686  C9 02             cmp #2
   73  34:9688  F0 53             beq .space_run
   74  34:968A  C4 18             cpy <.cchLine
   75  34:968C  90 07             bcc .decode
   76                                     ;.linefeed
   77  34:968E  48                        pha
   78  34:968F  A5 18                     lda <.cchLine
   79  34:9691  20 BC 96                  jsr .do_feed
   80  34:9694  68                        pla
   81  34:9695            .decode:
   82  34:9695  38                sec
   83  34:9696  E9 29             sbc #$29
   84  34:9698  C9 33             cmp #$5c-$29
   85  34:969A  B0 16             bcs .put_tile
   86                                     ;original code 29-5f reaches here
   87  34:969C  85 1C                     sta <.char
   88  34:969E  AA                        tax
   89  34:969F  BD E8 96                  lda .offsetAndFlags,x
   90  34:96A2  4A                        lsr a
   91  34:96A3  48                        pha
   92  34:96A4  A9 C0                     lda #$c0
   93  34:96A6  69 00                     adc #0
   94  34:96A8  91 1E                     sta [.pUpperLine],y
   95  34:96AA  68                        pla
   96  34:96AB  F0 24                     beq .put_he
   97  34:96AD  69 60                     adc #$60
   98  34:96AF  65 1C                     adc <.char
   99  34:96B1  38                        sec
  100  34:96B2            .put_tile:
  101  34:96B2  69 28             adc #$28        ;carry
  102  34:96B4            .put_only:      
  103  34:96B4  91 4E             sta [.pTileArray],y
  104  34:96B6  C8                iny
  105  34:96B7            .next:
  106  34:96B7  68                pla
  107  34:96B8  AA                tax
  108  34:96B9            .next_nopop:    
  109  34:96B9  E8                inx
  110  34:96BA  D0 BF             bne .decode_loop
  111  34:96BC            .do_feed:
  112  34:96BC  A0 00             ldy #0
  113  34:96BE  48                pha
  114  34:96BF  20 58 A5          jsr offsetTilePtr
  115  34:96C2  18                clc
  116  34:96C3  68                pla
  117  34:96C4  65 1E             adc <.pUpperLine
  118  34:96C6  85 1E             sta <.pUpperLine
  119  34:96C8  A9 00             lda #0
  120  34:96CA  65 1F             adc <.pUpperLine+1
  121  34:96CC  85 1F             sta <.pUpperLine+1
  122  34:96CE  60                rts
  123  34:96CF            .return:
  124  34:96CF  68                pla     ;dummy
  125  34:96D0  60                rts     
  126  34:96D1            .put_he:
  127  34:96D1  A9 A6             lda #$a6
  128  34:96D3  D0 DF             bne .put_only
  129  34:96D5            .force_linefeed:
  130  34:96D5  A5 18             lda <.cchLine
  131  34:96D7  0A                asl a
  132  34:96D8  20 BC 96          jsr .do_feed    
  133  34:96DB  D0 DA             bne .next       ;always satisfied
  134  34:96DD            .space_run:
  135  34:96DD  68                pla
  136  34:96DE  E8                inx
  137  34:96DF  98                tya
  138  34:96E0  18                clc
  139  34:96E1  7D D7 7A          adc .pString,x
  140  34:96E4  A8                tay
  141  34:96E5  4C B9 96          jmp .next_nopop
  142  34:96E8            .offsetAndFlags:
  143                                     ;code (after #$29 subtracted)
  144                                     ;               
  145                                     ;00-0E  +66 0b がぎぐげござじずぜぞだぢづでど (29 => 8f)
  146                                     ;0F-13  +6b 0b ばびぶべぼ 12+89 (38 => a3)
  147                                     ;14-18  +66 06 ぱぴぷぺぽ 17+89 (3d => a3)
  148                                     ;19             +8a 2a ヴ (42 => cc)
  149                                     ;1a-28  +8c 2c ガギグゲゴザジズゼゾダヂヅデト (43 => cf)
  150                                     ;29-2d  +91 31 バビブベボ 2c+89 (ヘ: => a6)
  151                                     ;2e-32  +8c 2c パピプペポ 31+89
  152                                     ;bit0 indicates 1='Handakuten'
  153                                     ;offset 0 is special;means 'he'
  154                                     ;higher bits are offset,subtracted by $60
  155  34:96E8  0C 0C 0C                  .db $0c,$0c,$0c,$0c,$0c, $0c,$0c,$0c,$0c,$0c, $0c,$0c,$0c,$0c,$0c ;$06*2
       34:96EB  0C 0C 0C  
       34:96EE  0C 0C 0C  
       34:96F1  0C 0C 0C  
       34:96F4  0C 0C 0C  
  156  34:96F7  16 16 16                  .db $16,$16,$16,$16,$16 ;$0b*2
       34:96FA  16 16     
  157  34:96FC  0D 0D 0D                  .db $0d,$0d,$0d,$0d,$0d ;$06*2 | 1
       34:96FF  0D 0D     
  158  34:9701  54                        .db $54 ;$2a*2
  159  34:9702  58 58 58                  .db $58,$58,$58,$58,$58, $58,$58,$58,$58,$58, $58,$58,$58,$58,$58 ;$2c*2
       34:9705  58 58 58  
       34:9708  58 58 58  
       34:970B  58 58 58  
       34:970E  58 58 58  
  160  34:9711  62 62 62                  .db $62,$62,$62,$00,$62 ;$31*2
       34:9714  00 62     
  161  34:9716  59 59 59                  .db $59,$59,$59,$01,$59 ;$2c*2 | 1
       34:9719  01 59     
  162                             .endif  ;ENABLE_strToTileArray
  163                     ;======================================================================================================
  164                     ;$96f8:
  165                     ;
  166                     ;$34:9754 initTileArrayStorage
  167                     ;//fill_7200to73ff_ff
  168                     ;//     [out] u16 $4e,$7ac0 : #7200
  169                     ;{
  170                     ;       $7ac0 = $18 = $4e = #$7200;
  171                     ;       memset($18,0xff,0x200);
  172                     ;$9777:
  173                     ;}
  174           9754              .org $9754
  175  34:9754            initTileArrayStorage:
  176  34:9754  A2 72             ldx #$72
  177  34:9756  8E 4F 00          stx $4f
  178  34:9759  8E C1 7A          stx $7ac1
  179  34:975C  A2 00             ldx #$00
  180  34:975E  8E 4E 00          stx $4e
  181  34:9761  8E C0 7A          stx $7ac0
  182  34:9764  A9 FF             lda #$ff
  183  34:9766            .loop:
  184  34:9766  9D 00 72          sta $7200,x
  185  34:9769  9D 00 73          sta $7300,x
  186  34:976C  E8                inx
  187  34:976D  D0 F7             bne .loop
  188  34:976F  60                rts
  189                     ;======================================================================================================
  190           0035              .bank   $35
  191           A609              .org    $a609
  192  35:A609                    .ds             $a66c - $a609
  193           A609              .org    $a609
  194  35:A609            loadString:
  195                     ;$35:a609 loadString
  196                     ;       [in] u16 $18 : tableBase
  197                     ;       [in] u8 A : index
  198                     ;       [in,out] u8 X : destOffset
  199           0018      .pTableBase = $18
  200           0018      .offset = $18
  201           001A      .index = $1a
  202                     ;----------------------------
  203  35:A609  85 1A             sta <.index
  204  35:A60B  8A                txa
  205  35:A60C  48                pha
  206  35:A60D  20 60 FD          jsr get2byteAtBank18    ;get2byteAtBank18($1a) $fd60
  207  35:A610  68                pla
  208  35:A611  AA                tax
  209  35:A612  A5 19             lda <.offset+1
  210  35:A614  48                pha
  211  35:A615  29 3F             and #$3f
  212  35:A617  09 80             ora #$80
  213  35:A619  85 19             sta <.offset+1
  214  35:A61B  68                pla
  215  35:A61C  20 43 FD          jsr shiftRight6 ;$fd43
  216  35:A61F  18                clc
  217  35:A620  69 0C             adc #$0c
  218  35:A622  4C 4A FD          jmp loadStringWorker    ;$3f:fd4a
  219                     ;$a66c:
  220                     ;======================================================================================================
  221  35:A625            itoa_8:
  222                     ;       [in] u8 a : value
  223                     ;       [out] u8 $1a[3] : tileArray (higher first)
  224           001A      .result = $1a
  225  35:A625  A2 00             ldx #0
  226  35:A627            .digit_loop:    
  227  35:A627  A0 FF                     ldy #$ff
  228  35:A629                    .subtraction_loop:      
  229  35:A629  C8                                iny
  230  35:A62A  38                                sec
  231  35:A62B  FD 50 A6                          sbc .digits,x
  232  35:A62E  B0 F9                             bcs .subtraction_loop
  233  35:A630  7D 50 A6                  adc .digits,x
  234  35:A633  48                        pha
  235  35:A634  98                        tya
  236  35:A635  D0 04                     bne .has_digit
  237  35:A637  A9 FF                             lda #$ff
  238  35:A639  D0 02                             bne .store
  239  35:A63B                    .has_digit:
  240  35:A63B  09 80                             ora #$80
  241  35:A63D                    .store:
  242  35:A63D  95 1A                     sta <.result,x
  243  35:A63F  68                        pla
  244  35:A640  E8                        inx
  245  35:A641  E0 03                     cpx #3
  246  35:A643  D0 E2             bne .digit_loop
  247  35:A645  A5 1C             lda <.result+2
  248  35:A647  C9 FF             cmp #$ff
  249  35:A649  D0 04             bne .return
  250  35:A64B  A9 80             lda #$80
  251  35:A64D  85 1C             sta <.result+2
  252  35:A64F            .return:        
  253  35:A64F  60                rts
  254  35:A650  64 0A 01  .digits .db     100,10,1
  255                     ;======================================================================================================
  256                             RESTORE_PC      ff3_string_begin
                0000              .bank   BANK(ff3_string_begin)
                8000              .org    ff3_string_begin
#[3]   ff3_hack_master.asm
#[4]   ff3_command_string.asm
   21                             .include "ff3_command_string.asm"
    1                     ; ff3_command_string.asm
    2                     ;
    3                     ;description:
    4                     ;       defines extra strings
    5                     ;
    6                     ;version:
    7                     ;       0.04 (2006-10-24)
    8                     ;
    9                     ;======================================================================================================
   10  00:8000            ff3_command_string_begin:
   11                             ;extra strings (reuse free space)
   12                             FILEORG $3cbbd
                001E              .bank   ($3cbbd) >> 13
                CBBD              .org    ($8000 | (($3cbbd) & $7fff))
   13  1E:CBBD                    command_provoke_fail:
   14  1E:CBBD  8A 8B 9C                  .db     $8a,$8b,$9c,$9f,$94,$b3,$9e,$8f,$7c,$99,$c4,$00
       1E:CBC0  9F 94 B3  
       1E:CBC3  9E 8F 7C  
       1E:CBC6  99 C4 00  
   15                                     
   16                             ;FILEORG        $3de12
   17  1E:CBC9                    command_provoke_success:
   18  1E:CBC9  9C 90 29                  .db $9c,$90,$29,$8e,$93,$7c,$99,$c4,$00
       1E:CBCC  8E 93 7C  
       1E:CBCF  99 C4 00  
   19                             
   20                             FILEORG $3a4f4
                001D              .bank   ($3a4f4) >> 13
                A4F4              .org    ($8000 | (($3a4f4) & $7fff))
   21  1D:A4F4                    command_provoke:        ;ちょうはつ
   22  1D:A4F4  9A 7F 8C                  .db $9a,$7f,$8c,$a3,$9b,$00     ;
       1D:A4F7  A3 9B 00  
   23  1D:A4FA                    command_disordered_shot:        ;みだれうち
   24  1D:A4FA  A9 33 B3                  .db $a9,$33,$b3,$8c,$9a,$00
       1D:A4FD  8C 9A 00  
   25  1D:A500                    command_abyss:                  ;あんこく
   26  1D:A500  8A B6 93                  .db $8a,$b6,$93,$91,$00
       1D:A503  91 00     
   27  1D:A505                    command_ready:                          ;かまえる
   28  1D:A505  8F A8 8D                  .db $8f,$a8,$8d,$b2,$00
       1D:A508  B2 00     
   29  1D:A50A                    command_counter_message:        ;カウンター!!
   30  1D:A50A  CF CC F6                  .db $cf,$cc,$f6,$d9,$c2,$c4,$c4,$00
       1D:A50D  D9 C2 C4  
       1D:A510  C4 00     
   31  1D:A512                    command_abyss_message:  ;やみのちからが からだをむしばむ
   32  1D:A512  AD A9 A2                  .db $ad,$a9,$a2,$9a,$8f,$b0,$29,$ff,$8f,$b0,$33,$7b,$aa,$95,$38,$aa,$00
       1D:A515  9A 8F B0  
       1D:A518  29 FF 8F  
       1D:A51B  B0 33 7B  
       1D:A51E  AA 95 38  
       1D:A521  AA 00     
   33                             FILEORG $3dabd  ;string for command 0A (original:$3dafd)
                001E              .bank   ($3dabd) >> 13
                DABD              .org    ($8000 | (($3dabd) & $7fff))
   34                     
   35                             ;----------------------------------------------------------------------------------------       
   36           0018              .bank   stringPtrTable >> 13
   37           8C40              .org    $8000 + (stringPtrTable & $7fff) + $0c40; + ($87 * 2)
   38                             
   39  18:8C40                    battleMessageOffsets:
   40           DE21      .nullstr = $de21
   41           0057      EXTRA_BATTLE_MESSAGE_BEGIN = $57        ;87d
   42           8C54              .org    battleMessageOffsets + ($0a * 2)        ;string ptr for command 0A
   43  18:8C54  F4 A4                     .dw (command_provoke & $ffff)
   44           8CEE              .org    battleMessageOffsets + (EXTRA_BATTLE_MESSAGE_BEGIN * 2) ;message
   45  18:8CEE  C9 CB                     .dw (command_provoke_success & $ffff)           ;57
   46  18:8CF0  BD CB                     .dw     (command_provoke_fail & $ffff);58
   47  18:8CF2  0A A5                     .dw (command_counter_message & $ffff); 59
   48  18:8CF4  FA A4                     .dw (command_disordered_shot & $ffff); 5a
   49  18:8CF6  00 A5                     .dw     (command_abyss & $ffff) ;5b
   50  18:8CF8  05 A5                     .dw (command_ready & $ffff)     ;5c
   51  18:8CFA  12 A5                     .dw     (command_abyss_message & $ffff) ;5d
   52  18:8CFC  21 DE                     .dw .nullstr    ;5e
   53                                     ;5f = "HPかいふく!"
   54                     ;------------------------------------------------------------------------------------------------------
   55           0057              .rsset EXTRA_BATTLE_MESSAGE_BEGIN
   56           0057      EXMSG_PROVOKE_SUCCESS   .rs 1
   57           0058      EXMSG_PROVOKE_FAIL              .rs 1
   58           0059      EXMSG_COUNTER                   .rs 1
   59           005A      EXMSG_DISORDERED_SHOT   .rs 1
   60           005B      EXMSG_ABYSS                             .rs 1
   61           005C      EXMSG_STAND_READY               .rs 1
   62           005D      EXMSG_ABYSS_MESSAGE             .rs 1
   63                     ;======================================================================================================
   64                             RESTORE_PC ff3_command_string_begin
                0000              .bank   BANK(ff3_command_string_begin)
                8000              .org    ff3_command_string_begin
#[3]   ff3_hack_master.asm
#[4]   ff3_rand.asm
   22                             .include "ff3_rand.asm"
    1                     ; ff3_rand.asm
    2                     ;
    3                     ; description:
    4                     ;       small patch for pseudorandom generator for battle
    5                     ;
    6                     ; version:
    7                     ;       0.01 (2006-10-12)
    8                     ;
    9                     ;======================================================================================================
   10  00:8000            ff3_rand_begin:
   11           003F              .bank   $3f
   12           FC27              .org    $fc27
   13  3F:FC27            initBattleRandom:
   14           FC37              .org    $fc37
   15                             
   16  3F:FC37  69 0B             adc #RANDOM_LCG_A       ;original:3
   17                     ;======================================================================================================
   18                             RESTORE_PC ff3_rand_begin
                0000              .bank   BANK(ff3_rand_begin)
                8000              .org    ff3_rand_begin
#[3]   ff3_hack_master.asm
#[4]   ff3_fix.asm
   23                             .include "ff3_fix.asm"
    1                     ; ff3_fix.asm
    2                     ;
    3                     ;description:
    4                     ;       small fixes
    5                     ;
    6                     ;version:
    7                     ;       0.06 (2006-11-07)
    8                     ;
    9                     ;======================================================================================================
   10  00:8000            ff3_fix_begin:
   11                     
   12           0001              .ifdef FIX_ATTR_BOOST
   13           0031                      .bank   $31
   14           AB62                      .org    $ab62
   15  31:AB62                    resetAttributeBoostAndFormation:
   16  31:AB62  29 01                     and #$01        ;original : $f9 (this improperly keeps previous attr-boost value,seems to be bug)
   17           AF18                      .org    $af18
   18  31:AF18                    storeAttributeBoostAndFormation:
   19  31:AF18  29 F9                     and #$f9        ;original: 1 (this masks attr-boost out, seems to be bug)
   20                             .endif  ;FIX_ATTR_BOOST
   21                     ;------------------------------------------------------------------------------------------------------
   22           0001              .ifdef FIX_HP_GROW
   23           0035                      .bank   $35
   24           BEC3                      .org    $bec3
   25  35:BEC3            prize_doLevelUp:
   26           0032      .lvBefore = $32
   27           0024      .hpGrowth = $24
   28           0057      .pBaseParam = $57
   29                             ;a = lvAfter
   30                             ;x = lvAfter
   31                             ;y = offset01 (lv)
   32  35:BEC3  91 57                     sta [.pBaseParam],y
   33  35:BEC5  0A                        asl a
   34  35:BEC6  85 24                     sta <.hpGrowth
   35  35:BEC8  A9 14                     lda #$14
   36  35:BECA  20 88 9B                  jsr setYtoOffsetOf
   37  35:BECD  B1 57                     lda [.pBaseParam],y     ;vit
   38  35:BECF  4A                        lsr a
   39  35:BED0  20 64 A5                  jsr getSys1Random       ;a564 (y is unchanged)
   40  35:BED3  18                        clc
   41  35:BED4  71 57                     adc [.pBaseParam],y
   42                                     ;carry should be clear (99+48)
   43  35:BED6  18                        clc
   44  35:BED7  65 24                     adc <.hpGrowth
   45  35:BED9  85 24                     sta <.hpGrowth
   46  35:BEDB  A9 00                     lda #0
   47  35:BEDD  69 00                     adc #0
   48  35:BEDF  48                        pha
   49  35:BEE0  A9 0E                     lda #$0e
   50  35:BEE2  20 88 9B                  jsr setYtoOffsetOf      ;9b88
   51  35:BEE5  18                        clc
   52  35:BEE6  B1 57                     lda [.pBaseParam],y     ;maxHp
   53  35:BEE8  65 24                     adc <.hpGrowth
   54  35:BEEA  91 57                     sta [.pBaseParam],y
   55  35:BEEC  C8                        iny
   56  35:BEED  68                        pla
   57  35:BEEE  71 57                     adc [.pBaseParam],y
   58  35:BEF0  91 57                     sta [.pBaseParam],y
   59  35:BEF2  88                        dey     ;set y to maxHp.low
   60  35:BEF3  EA                        nop
   61  35:BEF4  EA                        nop
   62  35:BEF5  EA                        nop
   63                     ;$bef6:         
   64                             .endif  ;FIX_HP_GROW
   65                     ;------------------------------------------------------------------------------------------------------
   66           0001              .ifdef FIX_ITEM99
   67           0035                      .bank   $35
   68           BFC7                      .org    $bfc7
   69  35:BFC7                    branchIfItemOverflow:
   70  35:BFC7  B0 25                     bcs $bfee
   71                             .endif  ;FIX_ITEM99
   72                     ;------------------------------------------------------------------------------------------------------
   73           0001              .ifdef FIX_255X_DAMAGE
   74           0030                      .bank   $30
   75           9F15                      .org    $9f15
   76  30:9F15                    doFight_tagEscape:
   77                                     ;original adc #01
   78  30:9F15  09 80                     ora #$80
   79                     
   80           0031                      .bank   $31
   81           A275                      .org    $a275
   82  31:A275                    doFight_removeEscapeTag:
   83  31:A275  29 7F                     and #$7f
   84                             
   85                             .endif ;FIX_255X_DAMAGE
   86                     ;------------------------------------------------------------------------------------------------------
   87           0001              .ifdef FIX_DUNGEON_FLOOR_SAVE
   88           003F                      .bank   $3f
   89           E299                      .org    $e299
   90  3F:E299                    dungeon_checkStackPointer:
   91  3F:E299  BA                        tsx
   92  3F:E29A  E0 4B                     cpx #$4b        ;original:$20
   93                             .endif ;FIX_DUNGEON_FLOOR_SAVE
   94                     ;======================================================================================================
   95                             RESTORE_PC ff3_fix_begin
                0000              .bank   BANK(ff3_fix_begin)
                8000              .org    ff3_fix_begin
#[3]   ff3_hack_master.asm
   24                     
   25           0001              .ifdef BETA
#[4]   ff3_enemy_target.asm
   26                                     .include "ff3_enemy_target.asm" ;save
    1                     ; ff3_enemy_target.asm
    2                     ;
    3                     ;description:
    4                     ;       replaces enemy's action related codes
    5                     ;
    6                     ;version:
    7                     ;       0.03 (2006-10-25)
    8                     ;
    9                     ;======================================================================================================
   10  00:8000            ff3_enemy_target_begin:
   11                             INIT_PATCH $31,$a732,$a8c8
                0031              .bank   $31
                A732              .org    $a732
       31:A732                    .ds             (($a8c8) - ($a732))
                A732              .org    $a732
   12                             
   13  31:A732            battleFunction_02:
   14  31:A732            decideEnemyAction:
   15                     ;[in]
   16           005B      .pPlayer = $5b
   17           7BE2      .barrierChangeFlag = $7be2
   18                     ;groupToIdMap = $7d6b
   19           7DA7      .indexToGroupMap = $7da7
   20           7ED8      .battleMode = $7ed8
   21                     ;[in,out]
   22           78B7      .sequence = $78b7
   23                     ;[local]
   24           0053      .confused = $53
   25           0024      .pEnemy = $24
   26           004A      .iEnemy = $4a
   27                     ;-------------------------------------------------
   28  31:A732  A2 00             ldx #0
   29  31:A734  86 69             stx <$69
   30  31:A736            .for_each_enemy:
   31  31:A736  86 4A                     stx <.iEnemy
   32  31:A738  86 18                     stx <$18
   33  31:A73A  A9 40                     lda #$40
   34  31:A73C  85 1A                     sta <$1a
   35                                     INIT16 <$20,$7675
       31:A73E  A9 75             lda #LOW($7675)
       31:A740  85 20             sta <$20
       31:A742  A9 76             lda #HIGH($7675)
       31:A744  85 21             sta <$20+1
   36  31:A746  20 9D BE                  jsr calcDataAddress
   37  31:A749  A5 1C                     lda <$1c
   38  31:A74B  85 24                     sta <.pEnemy
   39  31:A74D  A5 1D                     lda <$1d
   40  31:A74F  85 25                     sta <.pEnemy+1
   41  31:A751  20 C8 A8                  jsr $a8c8       ;get2c
   42  31:A754  29 EF                     and #$ef        ;clear action mode
   43  31:A756  91 24                     sta [.pEnemy],y
   44  31:A758  A9 00                     lda #0
   45  31:A75A  A0 2F                     ldy #$2f        ;target
   46  31:A75C  91 24                     sta [.pEnemy],y
   47  31:A75E  C8                        iny                     ;target mode
   48  31:A75F  91 24                     sta [.pEnemy],y
   49  31:A761  85 53                     sta <.confused
   50  31:A763  AA                        tax
   51  31:A764  A0 01                     ldy #1
   52  31:A766  B1 24                     lda [.pEnemy],y
   53  31:A768  29 E8                     and #$e8        ;dead|stone|toad|minimum
   54  31:A76A  F0 05                     beq .check_status_2nd
   55                                             ;can't move
   56  31:A76C  A9 00                             lda #0
   57  31:A76E  4C 2E A8                          jmp .next               ;a8b9
   58  31:A771                    .check_status_2nd:
   59  31:A771  C8                        iny
   60  31:A772  B1 24                     lda [.pEnemy],y
   61  31:A774  29 20                     and #$20        ;confuse
   62  31:A776  D0 09                     bne .status_confused
   63  31:A778  29 C0                     and #$c0        ;paralyzed|sleeping
   64  31:A77A  F0 0B                     beq .status_good
   65                             ;paralyzed|sleeping
   66  31:A77C  A9 01                             lda #1
   67  31:A77E  4C 2E A8                          jmp .next               ;a8b9
   68  31:A781                    .status_confused:
   69  31:A781  A9 80                     lda #$80
   70  31:A783  85 53                     sta <.confused
   71  31:A785  D0 34                     bne .select_action      ;a7c5
   72  31:A787                    .status_good:
   73  31:A787  AD D8 7E                  lda .battleMode
   74  31:A78A  30 2F                     bmi .select_action      ;a7c5
   75  31:A78C  4A                        lsr a
   76  31:A78D  B0 2C                     bcs .select_action      ;a7c5   if (($7ed8 & 1) != 0) $a7c5; //bne
   77                                             ;
   78  31:A78F  A0 00                             ldy #0
   79           0028      .lv = $28
   80  31:A791                            .cache_lv:
   81  31:A791  B1 5B                                     lda [.pPlayer],y        ;lv
   82  31:A793  95 28                                     sta <.lv,x
   83  31:A795  E8                                        inx
   84  31:A796  98                                        tya
   85  31:A797  18                                        clc
   86  31:A798  69 40                                     adc #$40
   87  31:A79A  A8                                        tay
   88  31:A79B  D0 F4                                     bne .cache_lv
   89  31:A79D  B1 24                     lda [.pEnemy],y ;y=0
   90  31:A79F  18                        clc
   91  31:A7A0  69 0F                     adc #15
   92  31:A7A2  48                        pha
   93  31:A7A3  20 EC A8                  jsr $a8ec       ;getLeastLvInPlayerParty
   94  31:A7A6  68                        pla
   95  31:A7A7  C5 28                     cmp <.lv
   96  31:A7A9  B0 10                     bcs .select_action
   97                                             ;try to escape
   98  31:A7AB  A9 64                             lda #100
   99  31:A7AD  20 B4 BE                          jsr b31_getBattleRandom ;beb4
  100  31:A7B0  A0 22                             ldy #$22
  101  31:A7B2  D1 24                             cmp [.pEnemy],y ;evade
  102  31:A7B4  90 05                             bcc .select_action
  103  31:A7B6  A9 06                                     lda #6
  104  31:A7B8  4C 2E A8                                  jmp .next
  105  31:A7BB                    .select_action: ;$a7c5
  106  31:A7BB  A6 4A                     ldx <.iEnemy
  107  31:A7BD  AD A7 7D                  lda .indexToGroupMap
  108  31:A7C0  AA                        tax
  109  31:A7C1  BD 6B 7D                  lda groupToEnemyIdMap,x
  110  31:A7C4  C9 D2                     cmp #$d2        ;d2:まどうしハイン
  111  31:A7C6  F0 04                     beq .check_barrier_change
  112  31:A7C8  C9 B4                     cmp #$b4        ;b4:アモン
  113  31:A7CA  D0 13                     bne .check_special
  114  31:A7CC                    .check_barrier_change:
  115  31:A7CC  AD E2 7B                          lda .barrierChangeFlag
  116  31:A7CF  C9 02                             cmp #2
  117  31:A7D1  D0 0C                             bne .check_special
  118  31:A7D3  20 C8 A8                                  jsr $a8c8
  119  31:A7D6  09 10                                     ora #$10
  120  31:A7D8  91 24                                     sta [.pEnemy],y
  121  31:A7DA  A9 4D                                     lda #$4d        ;4d:barrier-change
  122  31:A7DC  4C 2E A8                                  jmp .next
  123  31:A7DF                    .check_special: ;a7e9
  124  31:A7DF  A0 37                     ldy #$37
  125  31:A7E1  B1 24                     lda [.pEnemy],y
  126  31:A7E3  F0 09                     beq .decide_to_fight
  127  31:A7E5  A9 64                             lda #100
  128  31:A7E7  20 B4 BE                          jsr b31_getBattleRandom
  129  31:A7EA  D1 24                             cmp [.pEnemy],y
  130  31:A7EC  90 1B                             bcc .select_special
  131  31:A7EE                    .decide_to_fight:       ;a7fd
  132  31:A7EE  A5 53                     lda <.confused
  133  31:A7F0  F0 08                     beq .select_fight_target
  134  31:A7F2  20 CD A8                          jsr $a8cd       ;?
  135  31:A7F5  A9 04                             lda #4
  136  31:A7F7  4C 2E A8                          jmp .next       ;a8b9
  137  31:A7FA                    .select_fight_target:
  138                                     ;select valid target (must not be dead/stone/jumping)
  139                                     ;if there no valid target,then action0 (do nothing)
  140  31:A7FA  A9 04                     lda #4
  141                                     ;pha
  142  31:A7FC  85 46                     sta <$46
  143  31:A7FE  A9 00                     lda #0
  144  31:A800  20 38 A9                  jsr decideEnemyTarget
  145  31:A803  F0 44                     beq .fail_to_target
  146                                     ;pla
  147  31:A805  A9 04                     lda #4
  148  31:A807  D0 25                     bne .next
  149  31:A809                    .select_special:        ;$a85f
  150  31:A809  20 C8 A8                  jsr $a8c8       ;get24_2c
  151  31:A80C  09 10                     ora #$10
  152  31:A80E  91 24                     sta [.pEnemy],y
  153  31:A810  AD D8 7E                  lda .battleMode
  154  31:A813  10 27                     bpl .select_randomly
  155                             ;sequencial     
  156  31:A815  AD B7 78                          lda .sequence
  157  31:A818  18                                clc
  158  31:A819  69 37                             adc #$37
  159  31:A81B  20 54 A8                          jsr .setTarget
  160  31:A81E  D0 29                             bne .fail_to_target     ;$a8ad
  161  31:A820  AC B7 78                          ldy .sequence
  162  31:A823  C8                                iny
  163  31:A824  C0 09                             cpy #9
  164  31:A826  D0 02                             bne .update_sequence
  165  31:A828  A0 01                                     ldy #1
  166  31:A82A                            .update_sequence:
  167  31:A82A  8C B7 78                          sty .sequence
  168  31:A82D                    .id_and_next:
  169  31:A82D  8A                        txa
  170  31:A82E                    .next:  ;$a8b9
  171  31:A82E  A0 2E                     ldy #$2e
  172  31:A830  91 24                     sta [.pEnemy],y
  173  31:A832  A6 4A                     ldx <.iEnemy
  174  31:A834  E8                        inx
  175  31:A835  E0 08                     cpx #8
  176  31:A837  F0 2B                     beq .finish     ;$a8c8  ;get24_2c
  177  31:A839  4C 36 A7                  jmp .for_each_enemy
  178                                     ;bne .for_each_enemy    ;$a8c8;.finish
  179                                     ;       jmp $a8c8       ;finish
  180  31:A83C                    .select_randomly:       ;$a896
  181  31:A83C  A9 07                             lda #7
  182  31:A83E  20 B4 BE                          jsr b31_getBattleRandom
  183  31:A841  18                                clc
  184  31:A842  69 38                             adc #$38
  185  31:A844  20 54 A8                          jsr .setTarget  ;if failed, ZF = 0
  186  31:A847  F0 E4                             beq .id_and_next
  187  31:A849                    .fail_to_target:
  188  31:A849  20 C8 A8                          jsr $a8c8       ;get24_2c
  189  31:A84C  29 EF                             and #$ef
  190  31:A84E  91 24                             sta [.pEnemy],y
  191  31:A850  A9 00                             lda #0
  192  31:A852  F0 DA                             beq .next
  193  31:A854                    .setTarget:
  194  31:A854  A8                                tay
  195  31:A855  B1 24                             lda [.pEnemy],y
  196  31:A857  29 7F                             and #$7f
  197  31:A859  48                                pha
  198  31:A85A  B1 24                             lda [.pEnemy],y
  199  31:A85C  20 1B A9                          jsr decideEnemyActionTarget     ;a91b
  200  31:A85F  68                                pla
  201  31:A860  AA                                tax
  202  31:A861  A5 69                             lda <$69
  203  31:A863  60                                rts
  204  31:A864            .finish:
  205  31:A864  4C C8 A8          jmp $a8c8
  206                     ;======================================================================================================
  207                     ;ex battle function
  208  31:A867            pickRandomTargetFromEnemyParty:
  209                     ;[in]
  210                     ;[out] u8 $62 : targetbit; x = index
  211           0062      .targetBit = $62
  212           0064      .candidateCount = $64
  213           0070      .pTarget = $70
  214  31:A867  A9 08             lda #8
  215  31:A869  A2 04             ldx #4
  216  31:A86B  20 AE A9          jsr buildTargetCandidateList
  217  31:A86E  20 9B A8          jsr verifyCandidatesByStatusCache
  218  31:A871  A5 64             lda <.candidateCount
  219  31:A873  F0 25             beq .no_valid_target_there
  220  31:A875  20 D6 A9                  jsr pickOneOfCandidate
  221                                     ;convert target bit to index
  222  31:A878  A5 62                     lda <.targetBit
  223  31:A87A  A2 07                     ldx #7
  224  31:A87C                    .to_index:
  225  31:A87C  4A                                lsr a
  226  31:A87D  B0 03                             bcs .calc_addr
  227  31:A87F  CA                                dex
  228  31:A880  10 FA                             bpl .to_index
  229  31:A882                    .calc_addr:
  230  31:A882  8A                        txa
  231  31:A883  48                        pha
  232                                     
  233  31:A884  86 1A                     stx <$1a        ;index
  234  31:A886  A9 40                     lda #$40
  235  31:A888  20 D6 FC                  jsr mul_8x8
  236                                     ;$1a,1b = offset to enemy
  237  31:A88B  18                        clc
  238  31:A88C  A5 1A                     lda <$1a
  239  31:A88E  69 75                     adc #$75
  240  31:A890  85 70                     sta <.pTarget
  241  31:A892  A5 1B                     lda <$1b
  242  31:A894  69 76                     adc #$76
  243  31:A896  85 71                     sta <.pTarget+1
  244                                     
  245  31:A898  68                        pla
  246  31:A899  AA                        tax
  247  31:A89A            .no_valid_target_there:
  248  31:A89A  60                rts
  249                     ;------------------------------------------------------------------------------------------------------
  250  31:A89B            verifyCandidatesByStatusCache:
  251           0064      .candidateCount = $64
  252           0062      .candidateBits = $62
  253           00E0      .targetStatusCache = $e0
  254  31:A89B  A2 07             ldx #7
  255  31:A89D            .verify:
  256  31:A89D  8A                        txa
  257  31:A89E  0A                        asl a
  258  31:A89F  A8                        tay
  259  31:A8A0  B9 E0 00                  lda .targetStatusCache,y
  260  31:A8A3  29 E9                     and #$e9        ;dead|stone|toad|minimum|jumping
  261  31:A8A5  F0 09                     beq .ok
  262  31:A8A7  C6 64                             dec <.candidateCount
  263  31:A8A9  A5 62                             lda <.candidateBits
  264  31:A8AB  20 2C FD                          jsr clearTargetBit
  265  31:A8AE  85 62                             sta <.candidateBits
  266  31:A8B0                    .ok:
  267  31:A8B0  CA                        dex
  268  31:A8B1  10 EA                     bpl .verify
  269  31:A8B3  60                rts
  270                     ;$a8c8
  271                     ;======================================================================================================
  272                             ;.org   $a91b
  273                             INIT_PATCH $31,$a91b,$a9f7
                0031              .bank   $31
                A91B              .org    $a91b
       31:A91B                    .ds             (($a9f7) - ($a91b))
                A91B              .org    $a91b
  274  31:A91B            decideEnemyActionTarget:
  275           0046      .actionId = $46
  276           7400      .actionParams = $7400
  277  31:A91B  85 46             sta <.actionId
  278  31:A91D  29 7F             and #$7f
  279  31:A91F  85 18             sta <$18
  280  31:A921  A9 08             lda #8
  281  31:A923  85 1A             sta <$1a
  282                             INIT16 <$20,$98c0
       31:A925  A9 C0             lda #LOW($98c0)
       31:A927  85 20             sta <$20
       31:A929  A9 98             lda #HIGH($98c0)
       31:A92B  85 21             sta <$20+1
  283  31:A92D  A9 18             lda #$18
  284  31:A92F  A8                tay
  285  31:A930  A2 00             ldx #0
  286  31:A932  20 A6 FD          jsr loadTo7400Ex        ;fda6
  287  31:A935  AD 05 74          lda .actionParams+5
  288                             ;fall through
  289  31:A938            decideEnemyTarget:
  290           0024      .pEnemy = $24
  291           0053      .confused = $53 ;$80:confused
  292                     ;[out]
  293           0069      .failed = $69
  294                     ;local
  295           0046      .actionId = $46
  296           0062      .targetBits = $62
  297           0063      .targetFlags = $63
  298           0064      .candidateCount = $64
  299  31:A938  48                pha
  300  31:A939  05 53             ora <.confused  ;eor is ideal, but some enemy specials are intended to target enemy party even when confused
  301  31:A93B  10 14             bpl .select_from_player_party
  302  31:A93D            .select_from_enemy_party:
  303  31:A93D  A9 08                     lda #8
  304  31:A93F  A2 04                     ldx #4
  305  31:A941  20 AE A9                  jsr buildTargetCandidateList
  306  31:A944  A5 64                     lda <.candidateCount
  307  31:A946  F0 5A                     beq .no_valid_target_there
  308  31:A948  A2 FF                     ldx #$ff
  309  31:A94A  68                        pla
  310  31:A94B  29 40                     and #$40
  311  31:A94D  09 80                     ora #$80
  312  31:A94F  30 10                     bmi .set_target
  313  31:A951            .select_from_player_party:
  314                                     ;build candidate list
  315  31:A951  A9 04                     lda #4
  316  31:A953  A2 00                     ldx #0
  317  31:A955  20 AE A9                  jsr buildTargetCandidateList
  318  31:A958  A5 64                     lda <.candidateCount
  319  31:A95A  F0 46                     beq .no_valid_target_there
  320  31:A95C  A2 F0                     ldx #$f0
  321  31:A95E  68                        pla
  322  31:A95F  29 40                     and #$40
  323  31:A961            .set_target:
  324  31:A961  85 63             sta <.targetFlags
  325  31:A963  24 63             bit <.targetFlags
  326  31:A965  70 2D             bvs .target_multiple
  327  31:A967  A5 46             lda <.actionId
  328  31:A969  30 29             bmi .target_multiple
  329  31:A96B            .target_single:
  330           0001              .ifdef TAG_PROVOKE_EFFECT
  331  31:A96B  A0 1F                     ldy #$1f        ;enchanted status(lefthand)
  332  31:A96D  B1 24                     lda [.pEnemy],y
  333  31:A96F  29 1F                     and #$1f
  334  31:A971  F0 1C                     beq .do_usual
  335  31:A973  38                                sec
  336  31:A974  E9 01                             sbc #1
  337  31:A976  91 24                             sta [.pEnemy],y
  338  31:A978  29 0F                             and #$0f
  339  31:A97A  D0 0A                             bne .change_target
  340                                                     ;clear effects
  341  31:A97C  91 24                                     sta [.pEnemy],y
  342  31:A97E  A0 28                                     ldy #$28
  343  31:A980  A9 05                                     lda #5
  344  31:A982  91 24                                     sta [.pEnemy],y ;critical rate
  345  31:A984  D0 09                                     bne .do_usual
  346  31:A986                            .change_target:
  347  31:A986  88                                dey
  348  31:A987  B1 24                             lda [.pEnemy],y
  349  31:A989  F0 04                             beq .do_usual
  350  31:A98B  85 62                             sta <.targetBits
  351  31:A98D  D0 07                             bne .store_result
  352  31:A98F                    .do_usual:
  353                             .endif  ;TAG_PROVOKE_EFFECT
  354  31:A98F  20 D6 A9                  jsr pickOneOfCandidate
  355  31:A992  D0 02                     bne .store_result       ;always (a = targetbit
  356  31:A994            .target_multiple:
  357  31:A994  86 62                     stx <.targetBits
  358  31:A996            .store_result:
  359  31:A996  A0 30             ldy #$30
  360  31:A998  A5 63             lda <.targetFlags
  361  31:A99A  91 24             sta [.pEnemy],y
  362  31:A99C  88                dey
  363  31:A99D  A5 62             lda <.targetBits
  364  31:A99F  91 24             sta [.pEnemy],y
  365  31:A9A1  60                rts
  366  31:A9A2            .no_valid_target_there:
  367  31:A9A2  68                pla     ;dispose (actionParam[5] )
  368  31:A9A3  A2 00             ldx #0
  369  31:A9A5  86 62             stx <.targetBits
  370  31:A9A7  86 63             stx <.targetFlags
  371  31:A9A9  E8                inx
  372  31:A9AA  86 69             stx <.failed
  373  31:A9AC  D0 E8             bne .store_result
  374                     ;------------------------------------------------------------------------------------------------------
  375  31:A9AE            buildTargetCandidateList:
  376                     ;[in]
  377                     ;a = count
  378                     ;x = indexOffset
  379           0065      .indexOffset = $65      ;enemy = 4
  380                     ;[out]
  381           0064      .candidateCount = $64
  382           0062      .candidateBits = $62
  383                     ;
  384           0063      .candidateLast = $63
  385  31:A9AE  85 63             sta <.candidateLast
  386  31:A9B0  86 65             stx <.indexOffset
  387  31:A9B2  A2 00             ldx #0
  388  31:A9B4  86 62             stx <.candidateBits
  389  31:A9B6  86 64             stx <.candidateCount
  390  31:A9B8            .build_candidates:
  391  31:A9B8  8A                        txa
  392  31:A9B9  48                        pha
  393  31:A9BA  18                        clc
  394  31:A9BB  65 65                     adc <.indexOffset
  395  31:A9BD  20 F7 A9                  jsr isValidTarget       ;a9f7
  396  31:A9C0  D0 0C                     bne .build_next
  397  31:A9C2  E6 64                             inc <.candidateCount
  398  31:A9C4  68                                pla
  399  31:A9C5  48                                pha
  400  31:A9C6  AA                                tax
  401  31:A9C7  A5 62                             lda <.candidateBits
  402  31:A9C9  20 20 FD                          jsr flagTargetBit
  403  31:A9CC  85 62                             sta <.candidateBits
  404  31:A9CE                    .build_next:
  405  31:A9CE  68                        pla
  406  31:A9CF  AA                        tax
  407  31:A9D0  E8                        inx
  408  31:A9D1  E4 63                     cpx <.candidateLast
  409  31:A9D3  D0 E3                     bne .build_candidates
  410  31:A9D5  60                rts     
  411                     ;------------------------------------------------------------------------------------------------------
  412  31:A9D6            pickOneOfCandidate:
  413           0062      .candidateBits = $62
  414           0064      .candidateCount = $64
  415  31:A9D6  A5 64             lda <.candidateCount
  416  31:A9D8  38                sec 
  417  31:A9D9  E9 01             sbc #1
  418  31:A9DB  20 B4 BE          jsr b31_getBattleRandom ;beb4
  419  31:A9DE  A8                tay
  420  31:A9DF  C8                iny
  421                             ;y = (0-count]
  422                             ;lda <.candidateBits
  423  31:A9E0  A2 00             ldx #0
  424  31:A9E2            .find_nth_set:
  425  31:A9E2  06 62                     asl <.candidateBits
  426  31:A9E4  E8                        inx
  427  31:A9E5  90 FB                     bcc .find_nth_set
  428  31:A9E7  88                        dey
  429  31:A9E8  D0 F8                     bne .find_nth_set
  430                             ;x = bit index(reversed) of Nth set
  431  31:A9EA  CA                dex
  432  31:A9EB  A9 00             lda #0
  433  31:A9ED  20 20 FD          jsr flagTargetBit
  434  31:A9F0  85 62             sta <.candidateBits
  435  31:A9F2  60                rts
  436                     ;$a9f7  
  437                     ;======================================================================================================
  438                             RESTORE_PC      ff3_enemy_target_begin
                0000              .bank   BANK(ff3_enemy_target_begin)
                8000              .org    ff3_enemy_target_begin
#[3]   ff3_hack_master.asm
#[4]   ff3_calc_player_param.asm
   27                                     .include "ff3_calc_player_param.asm"    ;save
    1                     ; ff3_calc_player_param.asm
    2                     ;
    3                     ;description:
    4                     ;       replaces code for player parameter calculation
    5                     ;       adds 'extra job ability' feature
    6                     ;
    7                     ;version:
    8                     ;       0.04 (2006-10-25)
    9                     ;
   10                     ;======================================================================================================
   11  00:8000            ff3_calc_player_param_begin:
   12                             INIT_PATCH $31,$aa16,$ab0a
                0031              .bank   $31
                AA16              .org    $aa16
       31:AA16                    .ds             (($ab0a) - ($aa16))
                AA16              .org    $aa16
   13  31:AA16            battleFunction05:
   14  31:AA16            calcPlayerParam:
   15                     ;[in]
   16           0052      .iPlayer = $52
   17           0057      .pBaseParam = $57
   18           0059      .pEquips = $59
   19           005B      .pBattleParam = $5b
   20                     ;locals
   21           0027      .equipId_right = $27
   22           0028      .equipId_left = $28
   23           002C      .baseParams = $2c               ;str,agi,vit,int,men
   24           7400      .equipParams = $7400    ;[8][5]
   25           742F      .equipIds = $742f       ;{head,body,wrest,righthand,count,lefthand}
   26           0032      .equipTraitFlag = $32
   27           0048      .equipFlag_right = $48  ;=> pBattleParam[31]
   28           0049      .equipFlag_left = $49   ;=> +32
   29                     ;------------------------------------------------------------------------
   30  31:AA16  20 90 BE          jsr b31_updatePlayerOffset      ;be90
   31  31:AA19  A8                tay
   32  31:AA1A  A2 00             ldx #0
   33  31:AA1C            .load_equips:
   34  31:AA1C  B1 59                     lda [.pEquips],y
   35  31:AA1E  9D 2F 74                  sta .equipIds,x
   36  31:AA21  95 24                     sta <$24,x
   37  31:AA23  C8                        iny
   38  31:AA24  E8                        inx
   39  31:AA25  E0 06                     cpx #6
   40  31:AA27  D0 F3                     bne .load_equips
   41  31:AA29  A2 02             ldx #2
   42  31:AA2B            .replace_empty_armor:
   43  31:AA2B  B5 24                     lda <$24,x
   44  31:AA2D  D0 04                     bne .replace_next
   45  31:AA2F  A9 57                             lda #$57
   46  31:AA31  95 24                             sta <$24,x
   47  31:AA33                    .replace_next:
   48  31:AA33  CA                        dex
   49  31:AA34  10 F5                     bpl .replace_empty_armor
   50  31:AA36  A5 29             lda <$24+5
   51  31:AA38  85 28             sta <$24+4
   52  31:AA3A  8D 33 74          sta .equipIds+4
   53                             
   54  31:AA3D  A5 27             lda <.equipId_right
   55  31:AA3F  20 94 AA          jsr idToKindFlag        ;extra
   56  31:AA42  85 48             sta <.equipFlag_right
   57                             
   58  31:AA44  A5 28             lda <.equipId_left
   59  31:AA46  20 94 AA          jsr idToKindFlag        ;extra
   60  31:AA49  85 49             sta <.equipFlag_left
   61  31:AA4B  F0 04             beq .empty_either
   62  31:AA4D  A5 48                     lda <.equipFlag_right
   63  31:AA4F  D0 1A                     bne .set_traits
   64  31:AA51            .empty_either:
   65                                     ;at least lefthand or righthand is empty (or invalid item)
   66  31:AA51  A5 48                     lda <.equipFlag_right
   67  31:AA53  29 06                     and #6
   68  31:AA55  F0 06                     beq .check_left
   69                                             ;bow or arrow
   70  31:AA57  A9 00                             lda #0
   71  31:AA59  85 27                             sta <$24+3
   72  31:AA5B  F0 0A                             beq .clear_flags
   73  31:AA5D                    .check_left:
   74  31:AA5D  A5 49                     lda <.equipFlag_left
   75  31:AA5F  29 06                     and #6
   76  31:AA61  F0 08                     beq .set_traits
   77                                             ;bow or arrow
   78  31:AA63  A9 00                             lda #0
   79  31:AA65  85 28                             sta <$24+4
   80  31:AA67                            .clear_flags:
   81  31:AA67  85 48                             sta <.equipFlag_right
   82  31:AA69  85 49                             sta <.equipFlag_left
   83  31:AA6B            .set_traits:
   84  31:AA6B  A5 48             lda <.equipFlag_right
   85  31:AA6D  05 49             ora <.equipFlag_left
   86                             ;00:both bare fist or bow/arrow with other empty
   87                             ;01:onehanded weapon
   88                             ;06:bow(2) & arrow(4) set
   89                             ;08:harp
   90                             ;80:shield
   91  31:AA6F  F0 0D             beq .finish     ;$ab0a  ;both barefist
   92  31:AA71  C9 06             cmp #6
   93  31:AA73  F0 09             beq .finish     ;$ab0a  ;bow_arrow_set
   94  31:AA75  C9 08             cmp #8
   95  31:AA77  D0 03             bne .others
   96                     ;harp   
   97  31:AA79  4A                lsr a
   98  31:AA7A  D0 02             bne .finish
   99  31:AA7C            .others:
  100  31:AA7C  A9 02             lda #2
  101  31:AA7E            .finish:
  102           0001              .ifdef ENABLE_EXTRA_ABILITY_TAG
  103  31:AA7E  48                        pha
  104                                     
  105  31:AA7F  20 90 BE                  jsr b31_updatePlayerOffset
  106  31:AA82  A8                        tay
  107  31:AA83  B1 57                     lda [.pBaseParam],y
  108  31:AA85  AA                        tax     ;job
  109  31:AA86  A9 3C                     lda #EXTRA_ABILITY_OFFSET
  110  31:AA88  20 98 BE                  jsr b31_setYtoOffsetOf
  111  31:AA8B  BD B0 AA                  lda extraAbilityFlags,x
  112  31:AA8E  91 5B                     sta [.pBattleParam],y
  113                                     
  114  31:AA90  68                        pla
  115  31:AA91  4C 0A AB                  jmp $ab0a
  116                             .else
  118                             .endif  ;ENABLE_EXTRA_ABILITY_TAG
  119                     ;-------------------------------------------------------------------------------------------------------
  120  31:AA94            idToKindFlag:   ;[in] a = id [out] x = resultKind,a = flagValue
  121  31:AA94  A2 05             ldx #5
  122  31:AA96            .loop:
  123  31:AA96  DD A3 AA                  cmp .bounds,x
  124  31:AA99  B0 03                     bcs .return
  125  31:AA9B  CA                        dex
  126  31:AA9C  10 F8             bpl .loop
  127  31:AA9E            .return:
  128  31:AA9E  E8                inx
  129  31:AA9F  BD A9 AA          lda .kindToFlag,x
  130  31:AAA2  60                rts
  131  31:AAA3            .bounds:
  132  31:AAA3  01 46 4A          .db     $01,$46,$4a,$4f,$58,$65
       31:AAA6  4F 58 65  
  133  31:AAA9            .kindToFlag
  134  31:AAA9  00 01 08          .db     $00,$01,$08,$02,$04,$80,$00
       31:AAAC  02 04 80  
       31:AAAF  00        
  135                     ;-------------------------------------------------------------------------------------------------------
  136  31:AAB0            calc_player_param_free_begin:
  137           AB0A      calc_player_param_free_end = $ab0a
  138                     ;=======================================================================================================
  139  31:AAB0            ff3_calc_player_param_end:      
  140                             RESTORE_PC ff3_calc_player_param_begin
                0000              .bank   BANK(ff3_calc_player_param_begin)
                8000              .org    ff3_calc_player_param_begin
#[3]   ff3_hack_master.asm
#[4]   ff3_blow_effect.asm
   28                                     .include "ff3_blow_effect.asm"  ;save
    1                     ; ff3_blow_effect.asm
    2                     ;
    3                     ; description:
    4                     ;       replaces blow-effect playing code
    5                     ;       
    6                     ; version:
    7                     ;       0.03 (2006-10-23)
    8                     ;======================================================================================================
    9  00:8000            ff3_blow_effect_begin:
   10                     ;======================================================================================================
   11                             INIT_PATCH      $32,$98d1,$991f
                0032              .bank   $32
                98D1              .org    $98d1
       32:98D1                    .ds             (($991f) - ($98d1))
                98D1              .org    $98d1
   12  32:98D1            showBlowSprite_02:      ;
   13  32:98D1  A9 12             lda #$12
   14  32:98D3  D0 02             bne randomizePosAndShow
   15                             
   16  32:98D5            showBlowSprite_01:      ;type 0(fist) ,2(bell,book,rod,cane) ,4(harp),9(claw)
   17  32:98D5  A9 10             lda #$10
   18                             ;fall through
   19  32:98D7            randomizePosAndShow:
   20           00B6      .frameCount = $b6
   21           008C      .spriteX = $8c
   22           008D      .spriteY = $8d
   23           00BE      .randX = $be
   24           00BF      .randY = $bf
   25           00B8      .target = $b8
   26           00CD      .hand = $cd
   27  32:98D7  48                pha
   28                     ;$98e8:
   29  32:98D8  A6 BF             ldx <.randY
   30  32:98DA  A5 B6             lda <.frameCount
   31           0001              .ifdef VARIABLE_SWING_FRAMES
   32  32:98DC  20 C1 A3                  jsr blowEffect_isFrameCountSatisfied    ;a unchanged
   33                                     ;x = range index
   34                                     ;a = frame count
   35  32:98DF  0A                        asl a
   36  32:98E0  38                        sec
   37  32:98E1  FD D9 A3                  sbc blowEffect_frameBounds,x
   38  32:98E4  4A                        lsr a
   39  32:98E5  4A                        lsr a
   40  32:98E6  B0 21                     bcs .no_update
   41                             .else
   44                             .endif  ;VARIABLE_SWING_FRAMES
   45                     
   46  32:98E8  A5 B8                     lda <.target
   47  32:98EA  0A                        asl a
   48  32:98EB  A8                        tay
   49  32:98EC  B9 D7 7D                  lda enemyPos,y
   50  32:98EF  85 BE                     sta <.randX
   51  32:98F1  B9 D8 7D                  lda enemyPos+1,y
   52  32:98F4  85 BF                     sta <.randY
   53                     
   54  32:98F6  20 4F A4                  jsr getSys0Random_00_ff
   55  32:98F9  29 1F                     and #$1f
   56  32:98FB  18                        clc
   57  32:98FC  65 BE                     adc <.randX
   58  32:98FE  85 BE                     sta <.randX
   59                                     
   60  32:9900  20 4F A4                  jsr getSys0Random_00_ff
   61  32:9903  29 1F                     and #$1f
   62  32:9905  18                        clc
   63  32:9906  65 BF                     adc <.randY
   64  32:9908  AA                        tax
   65  32:9909            .no_update:
   66                     ;$9912:
   67                             ;lda <.randY
   68  32:9909  86 8D             stx <.spriteY
   69  32:990B  A5 BE             lda <.randX
   70  32:990D  85 8C             sta <.spriteX
   71  32:990F  A9 00             lda #0
   72  32:9911  85 8F             sta <$8f
   73                             ;fall through
   74                     ;$991f
   75                     ;$32:98d6
   76  32:9913  68                pla
   77  32:9914  A8                tay
   78  32:9915  A5 CD             lda <.hand
   79  32:9917  F0 01             beq .show
   80  32:9919  C8                        iny
   81  32:991A            .show:
   82  32:991A  84 8E             sty <$8e
   83  32:991C  4C 57 93          jmp $9357
   84                     ;$991f
   85           97DF              .org    $97df
   86  32:97DF            blowSpriteHandlers:
   87                     ;1F 99 E0 98 D1 98 1C 98 15 98 EB 97
   88  32:97DF  1F 99             .dw     $991f   ;type 1
   89  32:97E1  D5 98             .dw     showBlowSprite_01       ;$98e0  ;type 0,2,4,9
   90  32:97E3  D1 98             .dw showBlowSprite_02   ;$98d1
   91  32:97E5  1C 98             .dw $981c
   92  32:97E7  15 98             .dw $9815
   93  32:97E9  EB 97             .dw $97eb
   94                     ;======================================================================================================
   95                             INIT_PATCH      $33,$a1ef,$a245
                0033              .bank   $33
                A1EF              .org    $a1ef
       33:A1EF                    .ds             (($a245) - ($a1ef))
                A1EF              .org    $a1ef
   96                             
   97  33:A1EF            blowEffect_init:
   98  33:A1EF  20 1C A1          jsr $a11c
   99  33:A1F2  A6 95             ldx <$95
  100  33:A1F4  4C F9 A3          jmp $a3f9
  101  33:A1F7            blowEffect_type07       ;shuriken       
  102           00CD      .hand = $cd
  103           00B6      .frameCount = $b6
  104  33:A1F7  20 EF A1          jsr blowEffect_init
  105                             
  106  33:A1FA  20 59 A0          jsr beginSwingFrame     ;a059
  107  33:A1FD  A9 AF             lda #$af
  108  33:A1FF  8D 49 7F          sta soundDriver_effectId
  109                     ;$a1ff:
  110  33:A202            .frame_loop:
  111  33:A202  20 5E A0                  jsr $a05e       ;;fill_A0hBytes_f0_at$0200andSet$c8_0
  112  33:A205  A5 B6                     lda <.frameCount
  113  33:A207  20 C1 A3                  jsr blowEffect_isFrameCountSatisfied
  114  33:A20A  A5 CD                     lda <.hand
  115  33:A20C  B0 0E                     bcs .frame_2nd_half
  116  33:A20E  F0 06                             beq .frame_1st_right
  117  33:A210  A2 07                                     ldx #$07
  118  33:A212  A9 1E                                     lda #$1e
  119  33:A214  D0 12                                     bne .show_hand
  120  33:A216                            .frame_1st_right:
  121  33:A216  A2 05                                     ldx #$05
  122  33:A218  A9 18                                     lda #$18
  123  33:A21A  D0 0C                                     bne .show_hand
  124  33:A21C                    .frame_2nd_half:
  125  33:A21C  F0 06                             beq .frame_2nd_right
  126  33:A21E  A2 06                                     ldx #$06
  127  33:A220  A9 1F                                     lda #$1f
  128  33:A222  D0 04                                     bne .show_hand
  129  33:A224                            .frame_2nd_right:
  130  33:A224  A2 01                                     ldx #$01
  131  33:A226  A9 19                                     lda #$19
  132  33:A228                            .show_hand:
  133  33:A228  20 6E A0                          jsr $a06e
  134  33:A22B                    .next_frame:
  135  33:A22B  20 B0 F8                  jsr updateDmaPpuScrollSyncNmiEx ;f8b0
  136  33:A22E  20 E6 8A                  jsr incrementSwingFrame ;8ae6
  137  33:A231  4A                        lsr a
  138  33:A232  20 C1 A3                  jsr blowEffect_isFrameCountSatisfied
  139  33:A235  90 CB                     bcc .frame_loop
  140  33:A237  20 FE A5          jsr $a5fe
  141  33:A23A  4C 35 AC          jmp $ac35
  142                     ;$a245
  143                     ;------------------------------------------------------------------------------------------------------
  144                             ;INIT_PATCH     $33,$a2fb,$a365
  145                             ;INIT_PATCH     $33,$a379,$a3dd
  146                             INIT_PATCH $33,$a2fb,$a3dd
                0033              .bank   $33
                A2FB              .org    $a2fb
       33:A2FB                    .ds             (($a3dd) - ($a2fb))
                A2FB              .org    $a2fb
  147                             
  148  33:A2FB            blowEffect_doSwing_type09:      ;09=claw also 00(fist),08(arrow)
  149           00CD      .hand = $cd
  150           00BD      .swingCount = $bd
  151           00B6      .frameCount = $b6
  152                     
  153                             ;jsr $a11c
  154                             ;ldx <$95
  155                             ;jsr $a3f9
  156  33:A2FB  20 EF A1          jsr blowEffect_init
  157  33:A2FE            .swing_loop:
  158  33:A2FE  20 59 A0                  jsr beginSwingFrame     ;a059
  159  33:A301  A9 8A                     lda #$8a
  160  33:A303  8D 49 7F                  sta soundDriver_effectId        ;$7f49
  161  33:A306                    .frame_loop:
  162  33:A306  20 5E A0                          jsr     $a05e   ;fill_A0hBytes_f0_at$0200andSet$c8_0
  163  33:A309  A5 CD                             lda <.hand
  164  33:A30B  F0 09                             beq     .righthand
  165                     ;$a312
  166  33:A30D  A9 06                                     lda #$06
  167  33:A30F  20 35 A3                                  jsr .showFist
  168  33:A312  A9 0D                                     lda #$0d
  169  33:A314  D0 07                                     bne .show_blow
  170  33:A316                                    .righthand:
  171  33:A316  A9 05                                     lda #$05
  172  33:A318  20 35 A3                                  jsr .showFist
  173  33:A31B  A9 04                                     lda #$04
  174  33:A31D                            .show_blow:
  175  33:A31D  48                                pha
  176  33:A31E  20 CF A2                          jsr $a2cf
  177  33:A321  D0 05                             bne .play_blow
  178  33:A323  68                                        pla
  179  33:A324  48                                        pha
  180  33:A325  20 A1 92                                  jsr $92a1
  181  33:A328                            .play_blow:
  182  33:A328  68                                pla
  183  33:A329  A9 02                             lda #2
  184  33:A32B  20 B2 97                          jsr $97b2
  185  33:A32E                            .next_frame:
  186  33:A32E  20 47 A3                          jsr blowEffect_advanceFrameOrFinish
  187  33:A331  90 D3                             bcc .frame_loop
  188  33:A333  B0 C9                             bcs .swing_loop
  189  33:A335            .showFist:
  190  33:A335  20 D9 A2          jsr $a2d9
  191  33:A338  20 4F A4          jsr     $a44f
  192  33:A33B  29 01             and #1
  193  33:A33D  85 7E             sta <$7e
  194  33:A33F  20 4F A4          jsr $a44f
  195  33:A342  29 01             and #1
  196  33:A344  85 7F             sta <$7f
  197  33:A346            blowEffect_doReturn_00:
  198  33:A346  60                rts
  199                     ;------------------------------------------------------------------------------------------------------ 
  200  33:A347            blowEffect_advanceFrameOrFinish:
  201           00BD      .swingCount = $bd
  202                     ;[out] bool carry: do next frame(0),do next swing(1)
  203  33:A347  20 B0 F8          jsr updateDmaPpuScrollSyncNmiEx ;$f8b0
  204  33:A34A  20 E6 8A          jsr incrementSwingFrame                 ;$8ae6
  205  33:A34D  20 C1 A3          jsr blowEffect_isFrameCountSatisfied
  206  33:A350  90 F4             bcc blowEffect_doReturn_00 ;.return
  207  33:A352  C6 BD             dec <.swingCount
  208  33:A354  30 02             bmi .finish
  209  33:A356  D0 EE             bne blowEffect_doReturn_00      ;beq .finish
  210                     ;.return:
  211                     ;               rts
  212  33:A358            .finish:
  213  33:A358  68                pla     ;retaddr
  214  33:A359  68                pla     ;retaddr
  215  33:A35A  4C 35 AC          jmp $ac35
  216                     ;------------------------------------------------------------------------------------------------------ 
  217                             ;.org   $a365
  218  33:A35D            blowEffect_type01:
  219  33:A35D  20 45 A2          jsr getSwingCountOfCurrentHand  ;a245
  220  33:A360  A9 00             lda #$00
  221  33:A362  F0 05             beq blowEffect_storeBlow
  222                     ;------------------------------------------------------------------------------------------------------         
  223                             ;.org   $a36f
  224  33:A364            blowEffect_type02:
  225  33:A364  20 45 A2          jsr getSwingCountOfCurrentHand  ;a245
  226  33:A367  A9 01             lda #$01
  227  33:A369            blowEffect_storeBlow
  228  33:A369  85 BA             sta <$ba
  229                             ;jmp blowEffect_doSwing_type0102
  230                             ;bne blowEffect_doSwing_type0102
  231                     ;------------------------------------------------------------------------------------------------------ 
  232                     
  233  33:A36B            blowEffect_doSwing_type0102:
  234                     ;[in]
  235           00BA      .blowSprite = $ba
  236           00BD      .swingCount = $bd
  237           00CD      .hand = $cd     ;right=0 left=1
  238                     ;locals
  239           00B6      .frameCount = $b6       ;shared
  240                     ;locals (extra)
  241                     ;---------------------------------------
  242  33:A36B  20 38 A4          jsr $a438       ;getWeaponSprite
  243  33:A36E  20 0F A4          jsr $a40f       ;copySpriteProps
  244  33:A371  A6 95             ldx <$95
  245  33:A373  20 F9 A3          jsr $a3f9       ;clearWeaponSprite
  246                     
  247  33:A376            .swing_loop:    ;$a384:
  248  33:A376  20 59 A0                  jsr beginSwingFrame     ;$a059
  249  33:A379  85 B9                     sta <$b9
  250  33:A37B  A9 B6                     lda #$b6
  251  33:A37D  8D 49 7F                  sta soundDriver_effectId        ;$7f49
  252  33:A380                    .frame_loop:    ;$a38e:
  253  33:A380  20 5E A0                          jsr $a05e       ;fill_A0hBytes_f0_at$0200andSet$c8_0();
  254  33:A383  A5 B6                             lda <.frameCount
  255  33:A385  0A                                asl a
  256  33:A386  20 C1 A3                          jsr blowEffect_isFrameCountSatisfied
  257  33:A389  A5 CD                             lda <.hand
  258  33:A38B  B0 16                             bcs .frame_2nd_half
  259                                                     ;前半(4フレーム)
  260  33:A38D  F0 0A                                     beq .righthand_1st
  261  33:A38F  A9 07                                             lda #7
  262  33:A391  A2 02                                             ldx #2
  263  33:A393  20 65 A0                                          jsr $a065
  264  33:A396  4C BA A3                                          jmp .next_frame
  265                                                             ;
  266  33:A399                                    .righthand_1st:
  267  33:A399  A2 05                                             ldx #5
  268  33:A39B  A9 00                                             lda #0
  269  33:A39D  20 6E A0                                          jsr $a06e
  270  33:A3A0  4C BA A3                                          jmp .next_frame
  271  33:A3A3                            .frame_2nd_half:
  272                                                     ;後半
  273  33:A3A3  F0 0A                                     beq .righthand_2nd
  274  33:A3A5  A9 06                                             lda #6
  275  33:A3A7  A2 03                                             ldx #3
  276  33:A3A9  20 65 A0                                          jsr $a065
  277  33:A3AC  4C B5 A3                                          jmp .show_blow
  278  33:A3AF                                    .righthand_2nd:
  279  33:A3AF  A9 01                                             lda #1
  280  33:A3B1  AA                                                tax
  281  33:A3B2  20 6E A0                                          jsr $a06e
  282  33:A3B5                            .show_blow:
  283  33:A3B5  A5 BA                             lda <.blowSprite
  284  33:A3B7  20 B2 97                          jsr $97b2
  285  33:A3BA                    .next_frame:
  286  33:A3BA  20 47 A3                  jsr blowEffect_advanceFrameOrFinish
  287  33:A3BD  90 C1                     bcc .frame_loop
  288  33:A3BF  B0 B5                     bcs .swing_loop
  289                     ;               a,x
  290                     ;r/1st  0,5
  291                     ;l/1st  7,2
  292                     ;r/2nd  1,1
  293                     ;l/2nd  6,3     
  294  33:A3C1            blowEffect_isFrameCountSatisfied:
  295                     ;[in] a : frameCount
  296                     ;[out] bool carry : 1:satisfied ( frame >= limit)
  297           00CD      .hand = $cd
  298           00BB      .swingCounts = $bb
  299           0001              .ifdef VARIABLE_SWING_FRAMES
  300  33:A3C1  48                        pha
  301  33:A3C2  A6 CD                     ldx <.hand
  302  33:A3C4  B5 BB                     lda <.swingCounts,x
  303  33:A3C6  A2 03                     ldx #3
  304  33:A3C8                    .find_range:
  305  33:A3C8  DD D5 A3                          cmp .bounds,x
  306  33:A3CB  B0 03                             bcs .found
  307  33:A3CD  CA                                dex
  308  33:A3CE  10 F8                             bpl .find_range
  309  33:A3D0                    .found:
  310                                     ;x=index
  311  33:A3D0  68                        pla
  312  33:A3D1  DD D9 A3                  cmp blowEffect_frameBounds,x
  313  33:A3D4  60                        rts
  314  33:A3D5                    .bounds:
  315  33:A3D5  00 05 0B                  .db $00,$05,$0b,$10
       33:A3D8  10        
  316  33:A3D9            blowEffect_frameBounds:
  317  33:A3D9  08 06 04                  .db $08,$06,$04,$02
       33:A3DC  02        
  318                             .else
  321                             .endif  ;VARIABLE_SWING_FRAMES
  322                     ;original: $a3dd        
  323                     ;------------------------------------------------------------------------------------------------------
  324           0033              .bank   $33
  325           A077              .org    $a077
  326  33:A077            swingCountBounds:
  327                                                     ;original
  328  33:A077  11                .db     $11             ;07 fist = 0
  329  33:A078  11                .db     $11             ;05 axe = 1, spear = 1, sword = 1,
  330  33:A079  11                .db     $11             ;05 rod = 2, book = 2, bell = 2,
  331  33:A07A  11                .db     $11             ;07 bow = 3,
  332  33:A07B  05                .db     $05             ;05 harp = 4,
  333  33:A07C  07                .db     $07             ;07 boomerang = 5,
  334  33:A07D  07                .db     $07             ;07 ring = 6,
  335  33:A07E  07                .db     $07             ;07 shuriken = 7,
  336  33:A07F  11                .db     $11             ;07 arrow = 8,
  337                             ;       claw = 9 (oops)
  338                     ;------------------------------------------------------------------------------------------------------
  339           0033              .bank   $33
  340           A080              .org    $a080
  341  33:A080            blowEffectHandlers:
  342  33:A080  F2 A2             .dw     $a2f2   ;fist
  343  33:A082  5D A3             .dw     blowEffect_type01       ;$a365  ;axe
  344  33:A084  64 A3             .dw     blowEffect_type02       ;$a36f  ;rod,book,bell
  345  33:A086  51 A2             .dw     $a251   ;bow
  346  33:A088  A5 A1             .dw     $a1a5   ;harp
  347  33:A08A  2C A1             .dw     $a12c   ;boomerang
  348  33:A08C  25 A1             .dw     $a125   ;engeturin
  349  33:A08E  F7 A1             .dw     blowEffect_type07       ;$a1ef  ;shuriken
  350  33:A090  F2 A2             .dw     $a2f2   ;arrow
  351  33:A092  FB A2             .dw     $a2fb   ;claw
  352                     ;======================================================================================================
  353                             RESTORE_PC      ff3_blow_effect_begin
                0000              .bank   BANK(ff3_blow_effect_begin)
                8000              .org    ff3_blow_effect_begin
#[3]   ff3_hack_master.asm
   29                                     ;
#[4]   ff3_present_battle.asm
   30                                     .include "ff3_present_battle.asm"       ;save
    1                     ; ff3_present_battle.asm
    2                     ;
    3                     ; description:
    4                     ;       replaces presentBattle ($34:8ff7) related codes
    5                     ;
    6                     ; version:
    7                     ;       0.05 (2006-10-27)
    8                     ;======================================================================================================
    9  00:8000            ff3_present_battle_begin:
   10                     
   11                             INIT_PATCH $34,$8ff7,$9474
                0034              .bank   $34
                8FF7              .org    $8ff7
       34:8FF7                    .ds             (($9474) - ($8ff7))
                8FF7              .org    $8ff7
   12                             ;$93cd
   13                             
   14  34:8FF7            presentBattle:
   15                     ;[in]
   16           7EC2      .situation = $7ec2      ; usually commandId (set by commandHandler); toadsAction=18,prizeMessage=2
   17           78D5      .presentMode = $78d5; (commandChainId) (0-5: 0=attack 1=action 2,4=prize)
   18                     ;[shared]
   19           004B      .commandId = $4b
   20           0062      .pCommandList = $62
   21           0064      .iCommand = $64
   22                     ;--------------------------------------------------------------
   23  34:8FF7  AD C2 7E          lda .situation
   24  34:8FFA  F0 39             beq .finish
   25  34:8FFC  AD D5 78                  lda .presentMode
   26  34:8FFF  0A                        asl a
   27  34:9000  AA                        tax
   28  34:9001  BD FA 94                  lda pb_commandLists,x
   29  34:9004  85 62                     sta <.pCommandList
   30  34:9006  BD FB 94                  lda pb_commandLists+1,x
   31  34:9009  85 63                     sta <.pCommandList+1
   32  34:900B  A2 00                     ldx #0
   33  34:900D  8E EE 78                  stx battleMessageCount ;fromhere meaning changes to 'message index'
   34  34:9010  8E EF 78                  stx $78ef
   35  34:9013  86 64                     stx <.iCommand
   36  34:9015                    .command_loop:
   37  34:9015  20 3A 90                          jsr pb_initString
   38  34:9018  A4 64                             ldy <.iCommand
   39  34:901A  B1 62                             lda [.pCommandList],y
   40  34:901C  85 4B                             sta <.commandId ;00-0e
   41                                             ;cmp #$ff
   42                                             ;beq .finish
   43  34:901E  30 15                             bmi .finish
   44  34:9020  0A                                asl a
   45  34:9021  18                                clc
   46  34:9022  69 42                             adc #LOW(pb_handlers) ;#$4d
   47  34:9024  85 19                             sta <$19
   48  34:9026  A9 95                             lda #HIGH(pb_handlers) ;#$95
   49                                             ;adc #$00
   50  34:9028  85 1A                             sta <$1a
   51  34:902A  A9 6C                             lda #$6c        ;jmp (ptr)
   52  34:902C  85 18                             sta <$18
   53                                             ;0018: jmp ($954d + commandId<<1)
   54                                             ;jmp $0018
   55  34:902E  20 18 00                          jsr $0018
   56  34:9031  E6 64                             inc <.iCommand
   57  34:9033  D0 E0                             bne .command_loop
   58                     ;$9051:
   59                     ;       .org $9051
   60                     ;               rts
   61  34:9035            .finish: ;$9056:
   62  34:9035  A9 25             lda #$25
   63  34:9037  4C 0E FA          jmp call_2e_9d53        ;fa0e
   64                     ;$905b:
   65  34:903A            pb_initString:
   66  34:903A  A9 00             lda #0
   67  34:903C  A2 13             ldx #$13
   68  34:903E            .init_string:
   69  34:903E  9D D7 7A                  sta stringCache,x
   70  34:9041  CA                        dex
   71  34:9042  10 FA                     bpl .init_string
   72                             ;rts
   73  34:9044  4C 54 97          jmp initTileArrayStorage        ;9754
   74                     ;------------------------------------------------------------------------------------------------------
   75                     ;       .org    $905b
   76                     
   77  34:9047            pb_loadName:
   78           0057      .pPlayer = $57
   79                     ;indexToGroup = $7ecd
   80                     ;[in] a : charIndex
   81  34:9047  30 14             bmi .index_means_enemy
   82  34:9049  20 3C FD                  jsr shiftLeft6
   83  34:904C  18                        clc
   84  34:904D  69 0B                     adc #$0b
   85  34:904F  A8                        tay
   86  34:9050  A2 05                     ldx #5
   87  34:9052                    .load_player_name:
   88  34:9052  B1 57                             lda [.pPlayer],y
   89  34:9054  9D D7 7A                          sta stringCache,x
   90  34:9057  88                                dey
   91  34:9058  CA                                dex
   92  34:9059  10 F7                             bpl .load_player_name
   93  34:905B  30 24                             bmi .finish
   94  34:905D            .index_means_enemy:
   95  34:905D  29 7F                     and #$7f
   96  34:905F  C9 08                     cmp #8
   97  34:9061  D0 0A                     bne .single_target
   98  34:9063  20 C6 95                          jsr setBaseAddrTo_8c40
   99  34:9066  A9 16                             lda #$16
  100  34:9068  85 1A                             sta <$1a
  101  34:906A  4C 7A 90                          jmp .load
  102  34:906D                    .single_target:
  103  34:906D  AA                                tax
  104  34:906E  BD CD 7E                          lda indexToGroupMap,x
  105  34:9071  AA                                tax
  106  34:9072  BD 6B 7D                          lda groupToEnemyIdMap,x
  107  34:9075  85 1A                             sta <$1a
  108  34:9077  20 BD 95                          jsr setBaseAddrTo_8a40
  109  34:907A                    .load:
  110  34:907A  A2 00                     ldx #0
  111  34:907C  A5 1A                     lda <$1a
  112  34:907E  20 09 A6                  jsr loadString
  113  34:9081            .finish:
  114  34:9081  60                rts
  115                     
  116  34:9082            pb_checkNoMessage:
  117  34:9082  C9 FF             cmp #$ff
  118  34:9084  D0 02             bne .ok
  119  34:9086  68                        pla     ;retaddr
  120  34:9087  68                        pla     ;retaddr
  121  34:9088            .ok:
  122  34:9088  60                rts
  123                     ;------------------------------------------------------------------------------------------------------
  124  34:9089            pb_showActorName:       ;command05
  125           78D6      .actor = $78d6
  126  34:9089  AD D6 78          lda .actor
  127  34:908C  20 82 90          jsr pb_checkNoMessage
  128  34:908F  20 47 90          jsr pb_loadName
  129  34:9092  A9 00             lda #0
  130  34:9094  F0 25             beq pb_drawWindow
  131                     ;$90a0:
  132                     ;------------------------------------------------------------------------------------------------------
  133                     ;       .org $9177
  134  34:9096            pb_showTargetName:      ;command07
  135           78D8      .target = $78d8 ;charIndex
  136  34:9096  AD D8 78          lda .target
  137  34:9099  20 82 90          jsr pb_checkNoMessage
  138  34:909C  20 47 90          jsr pb_loadName
  139  34:909F  A9 02             lda #2
  140  34:90A1  D0 18             bne pb_drawWindow
  141                     ;$91ce:
  142                     ;------------------------------------------------------------------------------------------------------
  143                     ;       .org    $91d4
  144  34:90A3            pb_showEffectMessage:   ;command08
  145           78D9      .effect = $78d9
  146  34:90A3  AD D9 78          lda .effect
  147  34:90A6  20 82 90          jsr pb_checkNoMessage
  148  34:90A9  18                clc
  149  34:90AA  69 0C             adc #$0c
  150  34:90AC  85 1A             sta <$1a
  151  34:90AE  A2 82             ldx #$82
  152  34:90B0  86 19             stx <$19
  153  34:90B2  A2 00             ldx #0
  154  34:90B4  86 18             stx <$18
  155  34:90B6  20 09 A6          jsr loadString
  156  34:90B9  A9 03             lda #3
  157                             ;bne pb_drawWindow
  158  34:90BB            pb_drawWindow:
  159  34:90BB  48                pha
  160  34:90BC  A2 08             ldx #8
  161  34:90BE  86 18             stx <$18
  162  34:90C0  20 6A 96          jsr strToTileArray
  163  34:90C3  68                pla
  164  34:90C4  4C 1B 8D          jmp draw1LineWindow
  165                             ;jmp $9051      
  166                     ;------------------------------------------------------------------------------------------------------
  167                     ;       .org    $90a0
  168  34:90C7            pb_showActionName:      ;command06
  169           0072      .isItem = $72
  170           78D7      .messageId = $78d7
  171           7AC0      .pTileArray = $7ac0
  172  34:90C7  A5 72             lda <.isItem
  173  34:90C9  F0 1D             beq .not_item
  174                     ;item
  175  34:90CB  A2 00                     ldx #0
  176  34:90CD  86 18                     stx <$18
  177  34:90CF  A9 88                     lda #$88
  178  34:90D1  85 19                     sta <$19
  179  34:90D3  AD D7 78                  lda .messageId
  180  34:90D6  20 09 A6                  jsr loadString
  181  34:90D9  A2 F7                     ldx #$f7        ;-9
  182  34:90DB                    .shift_itemstr:
  183  34:90DB  BD E1 79                          lda stringCache-$f6,x
  184  34:90DE  9D E0 79                          sta stringCache-$f7,x
  185  34:90E1  E8                                inx
  186  34:90E2  D0 F7                             bne .shift_itemstr
  187  34:90E4  A9 01                     lda #1
  188  34:90E6  D0 D3                     bne pb_drawWindow
  189  34:90E8            .not_item:
  190  34:90E8  AD D7 78          lda .messageId
  191  34:90EB  20 82 90          jsr pb_checkNoMessage
  192  34:90EE  A0 05             ldy #5
  193  34:90F0            .map_to_kind:
  194  34:90F0  D9 35 91                  cmp .bounds,y
  195  34:90F3  B0 03                     bcs .mapped
  196  34:90F5  88                        dey
  197  34:90F6  10 F8                     bpl .map_to_kind
  198  34:90F8            .mapped:
  199                             ;y = kind
  200  34:90F8  A2 00             ldx #0
  201  34:90FA  C0 01             cpy #1  ;01 <= msgid <= 20 'n times hit'
  202  34:90FC  D0 15             bne .not_hit_message
  203  34:90FE  85 18                     sta <$18
  204  34:9100  86 19                     stx <$19        ;0
  205  34:9102  20 E1 95                  jsr itoa_16
  206  34:9105  A2 02                     ldx #2
  207  34:9107                    .store_count_digits:
  208  34:9107  B5 1D                             lda <$1d,x
  209  34:9109  9D D7 7A                          sta stringCache,x
  210  34:910C  CA                                dex
  211  34:910D  10 F8                             bpl .store_count_digits
  212  34:910F  A2 02                     ldx #2
  213  34:9111  A9 13                     lda #$13
  214  34:9113            .not_hit_message:
  215  34:9113            .load_base:
  216  34:9113  48                pha
  217  34:9114  98                tya
  218  34:9115  0A                asl a
  219  34:9116  A8                tay
  220  34:9117  B9 3B 91          lda .baseOffsets,y
  221  34:911A  85 18             sta <$18
  222  34:911C  B9 3C 91          lda .baseOffsets+1,y
  223  34:911F  85 19             sta <$19
  224  34:9121  68                pla
  225  34:9122  C0 06             cpy #(3*2)
  226  34:9124  D0 08             bne .load_string
  227                                             ;action
  228  34:9126  38                                sec
  229  34:9127  E9 39                             sbc #$39
  230           0001              .ifdef ENABLE_EXTRA_ABILITY
  231  34:9129  20 B0 9C                          jsr getExtraAbilityNameId
  232                             .endif  ;ENABLE_EXTRA_ABILITY
  233  34:912C  A2 00                             ldx #0
  234  34:912E            .load_string:
  235  34:912E  20 09 A6          jsr loadString
  236  34:9131  A9 01             lda #1
  237  34:9133  D0 86             bne pb_drawWindow
  238                     ;       msg             base    msgToIndex      meaning
  239                     ;       00:             8c40    =09             miss
  240                     ;       01-20:  8c40    =13             fight
  241                     ;       21-38:  8a40    +c6             summon
  242                     ;       39-51:  8c40    -39             action
  243                     ;       52-7f:  8200    -46             status
  244                     ;       80-fe:  8990    -80             special
  245                     ;       ff: no message
  246  34:9135            .bounds:
  247  34:9135  00 01 21          .db $00,$01,$21,$39,$52,$80
       34:9138  39 52 80  
  248                     ;.messageOffsets:
  249                     ;       .db $09,$00,$c6,$c7,$ba,$80
  250  34:913B            .baseOffsets:
  251  34:913B  52 8C             .dw     $8c40 + $09*2
  252  34:913D  40 8C             .dw     $8c40
  253  34:913F  CC 8B             .dw     $8a40 + $c6*2
  254  34:9141  40 8C             .dw $8c40; - $39*2
  255  34:9143  74 81             .dw $8200 - $46*2
  256  34:9145  90 88             .dw $8990 - $80*2
  257                     ;$9177:
  258                     ;------------------------------------------------------------------------------------------------------
  259  34:9147            pb_showInfoMessage:     ;command09
  260                     ;.messages = $78da
  261                     ;.messageCount = $78ee
  262           78E4      .messageParams = $78e4
  263           78EF      .iMessageParam = $78ef
  264           9575      pb_showInfoMessage_subCommands = $9575
  265  34:9147  AE EE 78          ldx battleMessageCount
  266  34:914A  BD DA 78          lda battleMessages,x
  267  34:914D  20 82 90          jsr pb_checkNoMessage
  268  34:9150  4A                lsr a
  269  34:9151  AA                tax
  270  34:9152  BD 75 95          lda pb_showInfoMessage_subCommands,x
  271                             ;carry still remains
  272  34:9155  B0 03             bcs .even_index
  273  34:9157  20 45 FD                  jsr $fd45       ;shiftright4
  274  34:915A            .even_index:
  275  34:915A  29 0F             and #$0f
  276  34:915C  0A                asl a
  277  34:915D  18                clc
  278  34:915E  69 64             adc #LOW(pb_showInfoMessage_handlers) ;#$6b
  279  34:9160  85 19             sta <$19
  280  34:9162  A9 95             lda #HIGH(pb_showInfoMessage_handlers) ;#$95
  281  34:9164  69 00             adc #0
  282  34:9166  85 1A             sta <$1a
  283  34:9168  A9 6C             lda #$6c        ;jmp (xxxx)
  284  34:916A  85 18             sta <$18
  285  34:916C  20 18 00          jsr $0018
  286                     ;$9236  
  287  34:916F  EE EE 78          inc battleMessageCount
  288  34:9172  60                rts
  289                     ;$923c
  290                     ;------------------------------------------------------------------------------------------------------
  291  34:9173            pb_loadInfoMessage:
  292  34:9173  48                pha
  293  34:9174  20 C6 95          jsr setBaseAddrTo_8c40
  294  34:9177  68                pla
  295  34:9178  AA                tax
  296  34:9179  AC EE 78          ldy battleMessageCount
  297  34:917C  B9 DA 78          lda battleMessages,y
  298  34:917F  4C 09 A6          jmp loadString
  299  34:9182            pb_showInfoMessage_00:
  300  34:9182  A9 00             lda #0
  301                             ;fall through
  302  34:9184            pb_loadInfoMessageAndDraw:
  303  34:9184  20 73 91          jsr pb_loadInfoMessage
  304  34:9187            pb_drawInfoWindow:
  305  34:9187  A2 11             ldx #$11
  306  34:9189  86 18             stx <$18
  307  34:918B  20 6A 96          jsr strToTileArray
  308  34:918E  A9 04             lda #4
  309  34:9190  4C 1B 8D          jmp draw1LineWindow     ;8d1b
  310                     ;------------------------------------------------------------------------------------------------------
  311  34:9193            pb_loadInfoMessageAndDrawWithWait:
  312  34:9193            pb_showInfoMessage_01:
  313  34:9193  A9 00             lda #0
  314  34:9195  20 84 91          jsr pb_loadInfoMessageAndDraw
  315                             ;jmp waitForPad1AButtonDown
  316  34:9198            waitForPad1AButtonDown:
  317  34:9198            .wait_loop:
  318  34:9198  20 AA FB                  jsr getPad1Input
  319  34:919B  A5 12                     lda <inputBits  ;$12
  320  34:919D  29 01                     and #1
  321  34:919F  F0 F7                     beq .wait_loop
  322  34:91A1  60                rts
  323                     ;------------------------------------------------------------------------------------------------------
  324  34:91A2            pb_printHp:
  325                     ;.destEnd = $24
  326  34:91A2  48                pha
  327  34:91A3  20 B4 91          jsr pb_getMessageParam16
  328  34:91A6  A2 04             ldx #4
  329  34:91A8  68                pla
  330  34:91A9  A8                tay
  331  34:91AA            .copy:
  332  34:91AA  B5 1A                     lda <$1a,x
  333  34:91AC  99 D7 7A                  sta stringCache,y
  334  34:91AF  88                        dey
  335  34:91B0  CA                        dex
  336  34:91B1  10 F7                     bpl .copy
  337  34:91B3  60                rts
  338                     ;------------------------------------------------------------------------------------------------------
  339  34:91B4            pb_getMessageParam16:
  340           78EF      .iParam = $78ef
  341           78E4      .battleMessageParams = $78e4
  342  34:91B4  AE EF 78          ldx .iParam
  343  34:91B7  BD E4 78          lda .battleMessageParams,x
  344  34:91BA  85 18             sta <$18
  345  34:91BC  E8                inx
  346  34:91BD  BD E4 78          lda .battleMessageParams,x
  347  34:91C0  85 19             sta <$19
  348  34:91C2  E8                inx
  349  34:91C3  8E EF 78          stx .iParam
  350  34:91C6  4C E1 95          jmp itoa_16
  351                     ;------------------------------------------------------------------------------------------------------
  352                     ;$34:91ce setNoTargetMessage
  353           91CE              .org    $91ce
  354  34:91CE            setNoTargetMessage:
  355  34:91CE  A9 FF             lda #$ff
  356  34:91D0  8D D8 78          sta $78d8
  357  34:91D3  60                rts
  358                     ;------------------------------------------------------------------------------------------------------
  359  34:91D4            pb_showInfoMessage_02_message:  ;"HP_?????/?????"
  360  34:91D4  77 79 FF          .db     $77,$79,$ff,$c5,$c5,$c5,$c5,$c5,$c7,$c5,$c5,$c5,$c5,$c5
       34:91D7  C5 C5 C5  
       34:91DA  C5 C5 C7  
       34:91DD  C5 C5 C5  
       34:91E0  C5 C5     
  361                     ;------------------------------------------------------------------------------------------------------
  362                             ;.org   $91d4
  363  34:91E2            pb_showInfoMessage_02:
  364           006E      .pActor = $6e   ;
  365  34:91E2  A2 0D             ldx #$0d
  366  34:91E4            .init_string:
  367                                     ; 0123456789abcd
  368                                     ;"HP_?????/?????"
  369  34:91E4  BD D4 91                  lda pb_showInfoMessage_02_message,x
  370  34:91E7  9D D7 7A                  sta stringCache,x
  371  34:91EA  CA                        dex
  372  34:91EB  10 F7                     bpl .init_string
  373  34:91ED  A0 30             ldy #$30
  374  34:91EF  B1 6E             lda [.pActor],y
  375  34:91F1  10 05             bpl .get_hp
  376  34:91F3  AD D8 7E          lda battleMode
  377  34:91F6  30 0A             bmi .show
  378  34:91F8            .get_hp:
  379  34:91F8  A9 07                     lda #$07
  380                                     ;sta <$24
  381  34:91FA  20 A2 91                  jsr pb_printHp
  382  34:91FD  A9 0D                     lda #$0d
  383                                     ;sta <$24
  384  34:91FF  20 A2 91                  jsr pb_printHp
  385  34:9202            .show:
  386                             ;fall through
  387  34:9202            pb_drawAndWait:
  388  34:9202  20 87 91          jsr pb_drawInfoWindow
  389  34:9205  4C 98 91          jmp waitForPad1AButtonDown
  390                     ;$92b5
  391                     ;------------------------------------------------------------------------------------------------------
  392                     ;$92db:
  393  34:9208            pb_showInfoMessage_03:
  394                     ;       %u + message
  395  34:9208  20 B4 91          jsr pb_getMessageParam16
  396  34:920B  A2 00             ldx #0
  397  34:920D  A0 00             ldy #0
  398  34:920F            .copy:
  399  34:920F  B5 1A                     lda <$1a,x
  400  34:9211  C9 FF                     cmp #$ff
  401  34:9213  F0 04                     beq .next
  402  34:9215  99 D7 7A                          sta stringCache,y
  403  34:9218  C8                                iny
  404  34:9219                    .next:
  405  34:9219  E8                        inx
  406  34:921A  E0 05                     cpx #5
  407  34:921C  D0 F1                     bne .copy
  408  34:921E  98                tya
  409  34:921F  20 84 91          jsr pb_loadInfoMessageAndDraw
  410  34:9222  4C 98 91          jmp waitForPad1AButtonDown
  411                     ;------------------------------------------------------------------------------------------------------
  412                     ;$932b
  413  34:9225            pb_showInfoMessage_04:
  414  34:9225  A9 00             lda #0
  415  34:9227  20 73 91          jsr pb_loadInfoMessage
  416                             ;stx <$2a
  417                             INIT16 <$18,$8800
       34:922A  A9 00             lda #LOW($8800)
       34:922C  85 18             sta <$18
       34:922E  A9 88             lda #HIGH($8800)
       34:9230  85 19             sta <$18+1
  418  34:9232  AD E4 78          lda $78e4
  419                             ;ldx <$2a
  420  34:9235  20 09 A6          jsr loadString
  421  34:9238  A9 FF             lda #$ff
  422  34:923A  8D DC 7A          sta stringCache+5
  423                             ;jmp pb_drawAndWait
  424  34:923D  D0 C3             bne pb_drawAndWait
  425                     ;$934e
  426                     ;------------------------------------------------------------------------------------------------------
  427                     ;$34:934e dispCommand_0B
  428  34:923F            pb_showDamage:  ;command0C
  429  34:923F  A9 17             lda #$17
  430                             ;fall through
  431  34:9241            pb_storeAndPlayEffect:
  432  34:9241  8D C2 7E          sta $7ec2
  433                             ;fall through
  434  34:9244            pb_playEffect:
  435  34:9244  4C F8 83          jmp playEffect  ;8411
  436                     ;------------------------------------------------------------------------------------------------------
  437  34:9247            pb_showDyingEffect:     ;command0D
  438           006E      .pActor = $6e
  439                     ;       [in] u8 $78d3 : ?
  440  34:9247  AD D3 78          lda $78d3
  441  34:924A  29 02             and #2
  442  34:924C  D0 2D             bne pb_doReturn
  443                     ;actor:         player                  enemy
  444                     ;target:
  445                     ; player        f0/93cd-e0/93cd f0/9408-e0/93cd
  446                     ; enemy         f0/93cd-e0/9408 f0/9408-e0/9408
  447  34:924E  20 D8 95          jsr $95d8       ;$18 = $00f0
  448  34:9251  20 2E A4          jsr getActor2C  ;a42e
  449  34:9254  30 06             bmi .actor_is_enemy     
  450  34:9256  20 85 92                  jsr pb_updatePlayerStatus       ;$93cd
  451  34:9259  4C 5F 92                  jmp .update_target
  452  34:925C            .actor_is_enemy:
  453  34:925C  20 B4 92                  jsr pb_updateEnemyStatus        ;$9408
  454  34:925F            .update_target:
  455                             ;todo: check actor != target 
  456  34:925F  20 CF 95          jsr $95cf       ;$18 = $00e0
  457  34:9262  A0 30             ldy #$30
  458  34:9264  B1 6E             lda [.pActor],y
  459  34:9266  30 06             bmi .target_is_enemy
  460  34:9268  20 85 92                  jsr pb_updatePlayerStatus       ;$93cd
  461  34:926B  4C 71 92                  jmp .show_effect
  462  34:926E            .target_is_enemy:
  463  34:926E  20 B4 92                  jsr pb_updateEnemyStatus        ;$9408
  464  34:9271            .show_effect:
  465  34:9271  20 74 94          jsr $9474
  466  34:9274  20 06 9D          jsr $9d06
  467  34:9277            pb_setEffect16:
  468  34:9277  A9 16             lda #$16
  469  34:9279  D0 C6             bne pb_storeAndPlayEffect
  470  34:927B            pb_doReturn:
  471  34:927B  60                rts
  472                     ;------------------------------------------------------------------------------------------------------
  473                     ;$34:93c4 dispCommand_0E
  474  34:927C            pb_updateTargetCache:   ;command0E
  475  34:927C  20 CF 95          jsr $95cf
  476  34:927F  20 B4 92          jsr pb_updateEnemyStatus        ;$9408
  477  34:9282  4C 77 92          jmp pb_setEffect16
  478                     ;$93cd
  479                     ;------------------------------------------------------------------------------------------------------
  480                     ;$34:93cd updatePlayerStatus
  481  34:9285            pb_updatePlayerStatus:
  482           0018      .pCache = $18
  483           0052      .iPlayer = $52
  484           005B      .pBattleParam = $5b
  485           005F      .offset = $5f
  486                     
  487  34:9285  A2 03             ldx #3
  488  34:9287            .for_each_player:
  489  34:9287  86 52                     stx <.iPlayer
  490  34:9289  20 41 A5                  jsr getPlayerOffset     ;a541
  491                     
  492  34:928C  A5 52                     lda <.iPlayer
  493  34:928E  0A                        asl a
  494  34:928F  AA                        tax
  495  34:9290  A8                        tay
  496  34:9291  B1 18                     lda [.pCache],y ;y = player * 2
  497  34:9293  A4 5F                     ldy <.offset
  498  34:9295  C8                        iny
  499  34:9296  11 5B                     ora [.pBattleParam],y   ;y = offset 01
  500  34:9298  91 5B                     sta [.pBattleParam],y
  501  34:929A  10 04                     bpl .player_alive
  502                                             ;lda [.pBattleParam],y
  503  34:929C  29 FE                             and #$fe
  504  34:929E  30 0C                             bmi .next       ;always satisfied
  505  34:92A0                    .player_alive:
  506  34:92A0  C8                                iny
  507  34:92A1  84 1A                             sty <$1a
  508  34:92A3  8A                                txa
  509  34:92A4  A8                                tay
  510  34:92A5  C8                                iny
  511  34:92A6  B1 18                             lda [.pCache],y
  512  34:92A8  A4 1A                             ldy <$1a
  513  34:92AA  11 5B                             ora [.pBattleParam],y
  514  34:92AC                    .next:
  515  34:92AC  91 5B                     sta [.pBattleParam],y
  516  34:92AE  A6 52                     ldx <.iPlayer
  517  34:92B0  CA                        dex
  518  34:92B1  10 D4                     bpl .for_each_player
  519  34:92B3  60                rts
  520                     ;------------------------------------------------------------------------------------------------------
  521                     ;$34:9408 updateEnemyStatus
  522  34:92B4            pb_updateEnemyStatus:
  523           0018      .pCache = $18
  524           001E      .pEnemy = $1e
  525           7EC4      .status = $7ec4
  526                     
  527                             INIT16 <.pEnemy,$7835
       34:92B4  A9 35             lda #LOW($7835)
       34:92B6  85 1E             sta <.pEnemy
       34:92B8  A9 78             lda #HIGH($7835)
       34:92BA  85 1F             sta <.pEnemy+1
  528  34:92BC  A2 07             ldx #7
  529  34:92BE            .for_each_enemy:
  530  34:92BE  8A                        txa
  531  34:92BF  0A                        asl a
  532  34:92C0  48                        pha
  533                                     
  534  34:92C1  A8                        tay
  535  34:92C2  B1 18                     lda [.pCache],y
  536  34:92C4  A0 01                     ldy #1
  537  34:92C6  11 1E                     ora [.pEnemy],y
  538  34:92C8  91 1E                     sta [.pEnemy],y
  539  34:92CA  29 E8                     and #$e8        ;dead|stone|toad|minimum
  540  34:92CC  F0 07                     beq .enemy_alive
  541  34:92CE  09 80                             ora #$80
  542  34:92D0  91 1E                             sta [.pEnemy],y
  543  34:92D2  9D C4 7E                          sta .status,x
  544  34:92D5                    .enemy_alive:
  545  34:92D5  68                        pla
  546  34:92D6  A8                        tay
  547  34:92D7  C8                        iny
  548  34:92D8  B1 18                     lda [.pCache],y
  549  34:92DA  A0 02                     ldy #2
  550  34:92DC  11 1E                     ora [.pEnemy],y
  551  34:92DE  91 1E                     sta [.pEnemy],y
  552                                     
  553                                     SUB16 <.pEnemy,$0040
       34:92E0  A5 1E             lda <.pEnemy
       34:92E2  38                sec
       34:92E3  E9 40             sbc #LOW($0040)
       34:92E5  85 1E             sta <.pEnemy
       34:92E7  A5 1F             lda <.pEnemy+1
       34:92E9  E9 00             sbc #HIGH($0040)
       34:92EB  85 1F             sta <.pEnemy+1
  554  34:92ED  CA                        dex
  555  34:92EE  10 CE                     bpl .for_each_enemy
  556  34:92F0  60                rts
  557                     ;$9450:
  558                     ;======================================================================================================
  559                     ;       .org    $9450
  560                             ;$34:9450 dispCommand_0A //[waitForAButtonDownOrMessageTimeOut]
  561  34:92F1            pb_waitConfirmOrTimeout:        ;command0A
  562           6010      .messageSpeed = $6010
  563           0024      .timeout = $24
  564  34:92F1  A9 08             lda #8
  565  34:92F3  38                sec
  566  34:92F4  ED 10 60          sbc .messageSpeed
  567  34:92F7  0A                asl a
  568  34:92F8  0A                asl a
  569  34:92F9  0A                asl a
  570  34:92FA  85 24             sta <.timeout
  571  34:92FC  F0 10             beq .finish
  572  34:92FE            .wait_loop:
  573  34:92FE  20 85 81                  jsr presentCharacter
  574  34:9301  20 AA FB                  jsr getPad1Input
  575  34:9304  A5 12                     lda <inputBits
  576  34:9306  29 01                     and #1
  577  34:9308  D0 04                     bne .finish
  578  34:930A  C6 24                     dec <.timeout
  579  34:930C  D0 F0                     bne .wait_loop
  580  34:930E            .finish:
  581  34:930E  60                rts
  582                     ;$9474
  583  34:930F            pb_free_begin:
  584           9474      pb_free_end = $9474
  585                     ;------------------------------------------------------------------------------------------------------
  586                             ;.org   $94d6
  587                             INIT_PATCH $34,$94d6,$9575
                0034              .bank   $34
                94D6              .org    $94d6
       34:94D6                    .ds             (($9575) - ($94d6))
                94D6              .org    $94d6
  588  34:94D6            pb_closeWindow: ;command00,01,02,04
  589           004B      .commandId = $4b
  590           78D6      .params = $78d6
  591  34:94D6  A6 4B             ldx <.commandId
  592  34:94D8  BD D6 78          lda .params,x
  593  34:94DB  20 82 90          jsr pb_checkNoMessage
  594  34:94DE  8A                txa
  595  34:94DF  4C 14 8E          jmp $8e14
  596                     ;$94e7:
  597                     ;------------------------------------------------------------------------------------------------------
  598  34:94E2            pb_backCommand: ;command03
  599           0064      .iCommand = $64
  600  34:94E2  AE EE 78          ldx battleMessageCount
  601  34:94E5  BD DA 78          lda battleMessages,x
  602  34:94E8  C9 FF             cmp #$ff
  603  34:94EA  F0 EA             beq pb_closeWindow
  604                     
  605  34:94EC  A2 04             ldx #4
  606  34:94EE  AD D5 78          lda battleProcessType
  607  34:94F1  F0 01             beq .decrement
  608  34:94F3  E8                        inx
  609  34:94F4            .decrement:
  610  34:94F4  C6 64                     dec <.iCommand
  611  34:94F6  CA                        dex
  612  34:94F7  D0 FB                     bne .decrement
  613  34:94F9            .finish:
  614  34:94F9  60                rts
  615                     ;$950d:
  616                     
  617                     ;======================================================================================================
  618                     ;       .org    $950d
  619                             ;INIT_PATCH $34,$950d,$9575
  620  34:94FA            pb_commandLists:
  621  34:94FA  08 95             .dw     pb_processType_00
  622  34:94FC  17 95             .dw     pb_processType_01
  623  34:94FE  26 95             .dw     pb_processType_02
  624  34:9500  2A 95             .dw     pb_processType_03
  625  34:9502  31 95             .dw     pb_processType_04
  626  34:9504  37 95             .dw     pb_processType_05
  627  34:9506  3C 95             .dw pb_processEx_00
  628                     ;       .org    $9519
  629  34:9508            pb_processType_00:
  630  34:9508  05 07 0B          .db $05,$07,$0B,$06,$0C,$08,$0D,$09,$0A,$04,$03,$01,$02,$00,$FF
       34:950B  06 0C 08  
       34:950E  0D 09 0A  
       34:9511  04 03 01  
       34:9514  02 00 FF  
  631  34:9517            pb_processType_01:
  632  34:9517  05 06 07          .db $05,$06,$07,$0B,$0C,$08,$09,$0D,$0A,$04,$03,$02,$01,$00,$FF
       34:951A  0B 0C 08  
       34:951D  09 0D 0A  
       34:9520  04 03 02  
       34:9523  01 00 FF  
  633  34:9526            pb_processType_02:
  634  34:9526  09 0A 04          .db $09,$0A,$04,$FF
       34:9529  FF        
  635  34:952A            pb_processType_03:      ;fire cannon
  636  34:952A  09 0B 0C          .db $09,$0B,$0C,$0E,$0A,$04,$FF
       34:952D  0E 0A 04  
       34:9530  FF        
  637  34:9531            pb_processType_04:
  638  34:9531  05 09 0A          .db $05,$09,$0A,$04,$00,$FF
       34:9534  04 00 FF  
  639  34:9537            pb_processType_05:
  640  34:9537  09 0C 0A          .db $09,$0C,$0A,$04,$FF
       34:953A  04 FF     
  641  34:953C            pb_processEx_00:
  642  34:953C  05                .db $05
  643  34:953D  06                .db $06
  644  34:953E  0F                .db $0f ;processDisorderedShot (ex)
  645           0000              .ifndef SHOW_INFO_ON_DISORDERED_SHOT
  649                             .endif  ;SHOW_INFO_ON_DISORDERED_SHOT
  650  34:953F  01                .db $01
  651  34:9540  00                .db $00
  652  34:9541  FF                .db $FF ;end
  653                     
  654                     ;       .org    $954d
  655  34:9542            pb_handlers:
  656  34:9542  D6 94             .dw     pb_closeWindow  ;00 $94d6
  657  34:9544  D6 94             .dw     pb_closeWindow  ;01 $94d6
  658  34:9546  D6 94             .dw pb_closeWindow      ;02 $94d6
  659  34:9548  E2 94             .dw pb_backCommand      ;03 $94e7
  660  34:954A  D6 94             .dw pb_closeWindow      ;04 $94d6
  661  34:954C  89 90             .dw pb_showActorName            ;05 905b
  662  34:954E  C7 90             .dw     pb_showActionName               ;06 90a0
  663  34:9550  96 90             .dw     pb_showTargetName               ;07 9177
  664  34:9552  A3 90             .dw     pb_showEffectMessage    ;08 91d4
  665  34:9554  47 91             .dw pb_showInfoMessage          ;09 $91fe
  666  34:9556  F1 92             .dw pb_waitConfirmOrTimeout     ;0a $9450
  667  34:9558  44 92             .dw pb_playEffect                       ;0b $934e
  668  34:955A  3F 92             .dw pb_showDamage                       ;0c $9354
  669  34:955C  47 92             .dw pb_showDyingEffect          ;0d $935f
  670  34:955E  7C 92             .dw pb_updateTargetCache        ;0e $93c4
  671  34:9560            pb_handlers_ex:
  672  34:9560  00 00             .dw 0   ;0f extenstion
  673  34:9562  00 00             .dw 0   ;10
  674                     ;       .org    $956b
  675  34:9564            pb_showInfoMessage_handlers:
  676  34:9564  82 91             .dw pb_showInfoMessage_00
  677  34:9566  93 91             .dw pb_showInfoMessage_01
  678  34:9568  E2 91             .dw pb_showInfoMessage_02
  679  34:956A  08 92             .dw pb_showInfoMessage_03
  680  34:956C  25 92             .dw pb_showInfoMessage_04
  681                     ;$9575:
  682                     ;======================================================================================================
  683                             RESTORE_PC ff3_present_battle_begin
                0000              .bank   BANK(ff3_present_battle_begin)
                8000              .org    ff3_present_battle_begin
#[3]   ff3_hack_master.asm
#[4]   ff3_info_window.asm
   31                                     .include "ff3_info_window.asm"          ;save
    1                     ; ff3_info_window
    2                     ;
    3                     ;description:
    4                     ;       replaces code for information window (larger window on the bottom right)
    5                     ;
    6                     ;version:
    7                     ;       0.01 (2006-10-24)
    8                     ;
    9                     ;======================================================================================================
   10  00:8000            ff3_info_window_begin:
   11                     
   12                             INIT_PATCH      $34,$9ba2,$9ce3
                0034              .bank   $34
                9BA2              .org    $9ba2
       34:9BA2                    .ds             (($9ce3) - ($9ba2))
                9BA2              .org    $9ba2
   13  34:9BA2            drawInfoWindow:
   14           0052      .iPlayer = $52
   15           0057      .pBaseParam = $57
   16           005B      .pBattleParam = $5b
   17           78CF      .commandIds = $78cf
   18                     
   19  34:9BA2  AD EB 7C          lda $7ceb
   20  34:9BA5  F0 06             beq .continue_process
   21  34:9BA7  A9 00                     lda #0
   22  34:9BA9  8D EB 7C                  sta $7ceb
   23  34:9BAC  60                        rts
   24  34:9BAD            .continue_process:
   25  34:9BAD  20 54 97          jsr initTileArrayStorage
   26                             INIT16 $720a,$7977
       34:9BB0  A9 77             lda #LOW($7977)
       34:9BB2  8D 0A 72          sta $720a
       34:9BB5  A9 79             lda #HIGH($7977)
       34:9BB7  8D 0B 72          sta $720a+1
   27  34:9BBA  A5 52             lda <.iPlayer
   28  34:9BBC  48                pha
   29  34:9BBD  A2 00             ldx #0
   30  34:9BBF            .for_each_player:
   31  34:9BBF  86 52                     stx <.iPlayer
   32  34:9BC1  A2 12                     ldx #$12
   33  34:9BC3  20 49 A5                  jsr initString
   34                                     ;$7ae3 = #c7;
   35  34:9BC6  20 41 A5                  jsr getPlayerOffset     ;a541
   36  34:9BC9  18                        clc
   37  34:9BCA  69 0B                     adc #$0b
   38  34:9BCC  A8                        tay
   39  34:9BCD  A2 06                     ldx #6
   40  34:9BCF                    .copy_name:
   41  34:9BCF  B1 57                             lda [.pBaseParam],y
   42  34:9BD1  9D D7 7A                          sta stringCache,x
   43  34:9BD4  88                                dey
   44  34:9BD5  CA                                dex
   45  34:9BD6  D0 F7                             bne .copy_name
   46                                             
   47  34:9BD8  A2 0B                     ldx #7+4
   48  34:9BDA  A9 03                     lda #3
   49  34:9BDC  20 8D 9C                  jsr getStringFromValueAt        ;ex
   50                     
   51                                     ;lda #0
   52                                     ;sta <$24
   53  34:9BDF  20 1D 9D                  jsr cachePlayerStatus   ;9d1d
   54  34:9BE2  AD E8 7C                  lda $7ce8
   55  34:9BE5  C9 FF                     cmp #$ff
   56  34:9BE7  F0 5A                     beq .show_maxhp
   57                     
   58  34:9BE9  A6 52                             ldx <.iPlayer
   59  34:9BEB  BD CF 78                          lda .commandIds,x
   60  34:9BEE  C9 FF                             cmp #$ff
   61  34:9BF0  F0 1F                             beq .check_status
   62                     
   63  34:9BF2  C9 C8                                     cmp #$c8
   64  34:9BF4  90 0C                                     bcc .not_magic
   65  34:9BF6                                    .action_is_magic:
   66                                                             INIT16_x <$18, ($8990 - $c8 * 2)
       34:9BF6  A2 00             ldx #LOW(($8990 - $c8 * 2))
       34:9BF8  86 18             stx <$18
       34:9BFA  A2 88             ldx #HIGH(($8990 - $c8 * 2))
       34:9BFC  86 19             stx <$18+1
   67  34:9BFE  A2 0C                                             ldx #$0c
   68  34:9C00  D0 3B                                             bne .load_string
   69  34:9C02                                    .not_magic:
   70           0001              .ifdef ENABLE_EXTRA_ABILITY
   71  34:9C02  20 B0 9C                                          jsr getExtraAbilityNameId
   72                             .endif ;ENABLE_EXTRA_ABILITY
   73                                                             INIT16_x <$18, $8c40
       34:9C05  A2 40             ldx #LOW($8c40)
       34:9C07  86 18             stx <$18
       34:9C09  A2 8C             ldx #HIGH($8c40)
       34:9C0B  86 19             stx <$18+1
   74  34:9C0D  A2 0D                                             ldx #$0d
   75  34:9C0F  D0 2C                                             bne .load_string
   76  34:9C11                            .check_status:
   77  34:9C11  A5 1B                             lda <$1b
   78  34:9C13  05 1A                             ora <$1a
   79  34:9C15  F0 2C                             beq .show_maxhp
   80  34:9C17  A5 1B                                     lda <$1b
   81  34:9C19  29 20                                     and #$20
   82  34:9C1B  F0 0A                                     beq .status_bit_to_index
   83  34:9C1D  A5 1B                                             lda <$1b
   84  34:9C1F  29 DF                                             and #$df
   85  34:9C21  85 1B                                             sta <$1b
   86  34:9C23  05 1A                                             ora <$1a
   87  34:9C25  F0 1C                                             beq .show_maxhp
   88  34:9C27                                    .status_bit_to_index:
   89  34:9C27  A0 00                                     ldy #0
   90  34:9C29                                    .find_index:
   91  34:9C29  06 1B                                             asl <$1b
   92  34:9C2B  26 1A                                             rol <$1a
   93  34:9C2D  B0 03                                             bcs .got_index
   94  34:9C2F  C8                                                iny
   95  34:9C30  90 F7                                             bcc .find_index
   96  34:9C32                                    .got_index:
   97                                                     INIT16_x <$18,$822c
       34:9C32  A2 2C             ldx #LOW($822c)
       34:9C34  86 18             stx <$18
       34:9C36  A2 82             ldx #HIGH($822c)
       34:9C38  86 19             stx <$18+1
   98  34:9C3A  98                                        tya
   99  34:9C3B  A2 0D                                     ldx #$0d
  100                                                     ;bne .load_string
  101  34:9C3D                            .load_string:
  102  34:9C3D  20 09 A6                          jsr loadString
  103  34:9C40  4C 60 9C                          jmp .to_tiles
  104                     ;$9c7f:
  105  34:9C43                            .show_maxhp:
  106  34:9C43  AD E8 7C                          lda $7ce8
  107  34:9C46  C9 FF                             cmp #$ff
  108  34:9C48  F0 0F                             beq .get_maxhp
  109  34:9C4A  AD E1 7B                                  lda $7be1
  110  34:9C4D  A6 52                                     ldx <.iPlayer
  111  34:9C4F  20 38 FD                                  jsr maskTargetBit
  112  34:9C52  F0 05                                     beq .get_maxhp
  113  34:9C54  BD CF 78                                          lda .commandIds,x
  114  34:9C57  D0 9D                                             bne .action_is_magic
  115  34:9C59                            .get_maxhp:
  116  34:9C59  A2 10                             ldx #$10
  117  34:9C5B  A9 05                             lda #5
  118  34:9C5D  20 8D 9C                          jsr getStringFromValueAt
  119                     ;$9cba:
  120                                     ;$7ae3 = #c7;
  121  34:9C60                    .to_tiles:
  122  34:9C60  A9 C7                     lda #$c7
  123  34:9C62  8D E3 7A                  sta stringCache+$0c
  124  34:9C65  A9 12                     lda #$12
  125  34:9C67  85 18                     sta <$18
  126  34:9C69  20 6A 96                  jsr strToTileArray
  127  34:9C6C  A9 12                     lda #$12
  128  34:9C6E  20 58 A5                  jsr offsetTilePtr
  129  34:9C71  A6 52                     ldx <.iPlayer
  130  34:9C73  E8                        inx
  131  34:9C74  E0 04                     cpx #4
  132  34:9C76  F0 03                     beq .finish
  133  34:9C78  4C BF 9B                  jmp .for_each_player
  134                     ;$9cd1:
  135  34:9C7B            .finish:
  136  34:9C7B  68                pla
  137  34:9C7C  85 52             sta <.iPlayer
  138  34:9C7E  A9 0B             lda #$0b
  139  34:9C80  85 18             sta <$18
  140  34:9C82  A9 1E             lda #$1e
  141  34:9C84  85 19             sta <$19
  142  34:9C86  A9 03             lda #$03
  143  34:9C88  85 1A             sta <$1a
  144  34:9C8A  4C 38 8B          jmp draw8LineWindow
  145                     ;------------------------------------------------------------------------------------------------------
  146  34:9C8D            getStringFromValueAt:
  147                     ;[in] x = dest end offset
  148                     ;[in] a = offset to value
  149           005B      .pBattleParam = $5b
  150  34:9C8D  20 88 9B          jsr setYtoOffsetOf
  151  34:9C90  B1 5B             lda [.pBattleParam],y
  152  34:9C92  85 18             sta <$18
  153  34:9C94  C8                iny
  154  34:9C95  B1 5B             lda [.pBattleParam],y
  155  34:9C97  85 19             sta <$19
  156  34:9C99  8A                txa
  157  34:9C9A  48                pha
  158  34:9C9B  20 E1 95          jsr itoa_16     ;95e1
  159  34:9C9E  68                pla
  160  34:9C9F  A8                tay
  161  34:9CA0  A2 03             ldx #3
  162  34:9CA2            .copy:
  163  34:9CA2  B5 1B                     lda <$1b,x
  164  34:9CA4  99 D7 7A                  sta stringCache,y
  165  34:9CA7  88                        dey
  166  34:9CA8  CA                        dex
  167  34:9CA9  10 F7                     bpl .copy
  168  34:9CAB  60                rts
  169                     
  170  34:9CAC            infoWindow_free_begin:
  171           9CE3      infoWindow_free_end = $9ce3
  172                     ;------------------------------------------------------------------------------------------------------
  173                     ;$9ce3
  174                     ;======================================================================================================
  175                             RESTORE_PC ff3_info_window_begin
                0000              .bank   BANK(ff3_info_window_begin)
                8000              .org    ff3_info_window_begin
#[3]   ff3_hack_master.asm
#[4]   ff3_executeAction.asm
   32                                     .include "ff3_executeAction.asm"        ;save
    1                     ; ff3_executeAction.asm
    2                     ;
    3                     ;description:
    4                     ;       replaces executeAction()
    5                     ;
    6                     ;version:
    7                     ;       0.01 (2006-10-26)
    8                     ;
    9                     ;======================================================================================================
   10  00:8000            ff3_executeAction_begin:
   11                     
   12                             ;INIT_PATCH $34,$9de4,$9fac
   13           0034              .bank   $34
   14           9DE4              .org    $9de4
   15  34:9DE4            executeAction:
   16                     ;[in]
   17           7AC2      .currentActor = $7ac2
   18           7ACB      .ordinalToIndex = $7acb
   19                     ;[local]
   20           006E      .pActor = $6e
   21           0070      .pTarget = $70
   22                     
   23  34:9DE4  AE C2 7A          ldx .currentActor
   24  34:9DE7  BD CB 7A          lda .ordinalToIndex,x
   25  34:9DEA  48                pha
   26                             
   27  34:9DEB  10 05             bpl .actor_is_player_char
   28  34:9DED  18                        clc
   29  34:9DEE  29 7F                     and #$7f
   30  34:9DF0  69 04                     adc #4
   31  34:9DF2            .actor_is_player_char:
   32                     ;$9df3:
   33  34:9DF2  85 18             sta <$18
   34  34:9DF4  85 26             sta <$26
   35                             
   36  34:9DF6  A9 40             lda #$40
   37  34:9DF8  85 1A             sta <$1a
   38                             INIT16 <$20,$7575
       34:9DFA  A9 75             lda #LOW($7575)
       34:9DFC  85 20             sta <$20
       34:9DFE  A9 75             lda #HIGH($7575)
       34:9E00  85 21             sta <$20+1
   39                             
   40  34:9E02  20 2E 80          jsr dispatchBattleFunction_07   ;802e => calcDataAddress
   41                     
   42  34:9E05  A5 1C             lda <$1c
   43  34:9E07  85 6E             sta <.pActor
   44  34:9E09  A5 1D             lda <$1d
   45  34:9E0B  85 6F             sta <.pActor+1
   46                     
   47  34:9E0D  A5 26             lda <$26
   48  34:9E0F  C9 0C             cmp #$0c
   49  34:9E11  90 03             bcc .actor_valid
   50                                     ;?
   51  34:9E13  68                        pla
   52  34:9E14  D0 39                     bne .check_status       ;$9e5f
   53  34:9E16            .actor_valid:
   54  34:9E16  68                pla
   55  34:9E17  A8                tay
   56  34:9E18  29 87             and #$87
   57  34:9E1A  8D D6 78          sta $78d6       ;actor name
   58  34:9E1D  29 7F             and #$7f
   59  34:9E1F  AA                tax
   60                             ;lda #0
   61                             ;jsr flagTargetBit
   62  34:9E20  20 AD 9F          jsr flagSingleTarget
   63  34:9E23  8D 98 7E          sta $7e98
   64  34:9E26  98                tya     ;actor index|flag
   65                     
   66  34:9E27  10 26             bpl .check_status
   67                                     ;actor enemy
   68  34:9E29  AD 9A 7E                  lda $7e9a
   69  34:9E2C  09 80                     ora #$80
   70  34:9E2E  8D 9A 7E                  sta $7e9a
   71                                     
   72                                     ;a = $7ced;
   73                                     ;if( ((#55 == $7ced) && ($7cee == 0))
   74                                     ;       || ( ((#79 == $7ced) || (#90 == $7ced)) && ($7cee != 0) ) )
   75  34:9E31  AD ED 7C                  lda $7ced
   76  34:9E34  AE EE 7C                  ldx $7cee
   77  34:9E37  D0 06                     bne ._7cee_not_0
   78  34:9E39  C9 55                             cmp #$55
   79  34:9E3B  D0 12                             bne .check_status
   80  34:9E3D  F0 08                             beq .heal_hp
   81  34:9E3F                    ._7cee_not_0:
   82  34:9E3F  C9 79                             cmp #$79
   83  34:9E41  F0 04                             beq .heal_hp
   84  34:9E43  C9 90                             cmp #$90
   85  34:9E45  D0 08                             bne .check_status
   86  34:9E47                    .heal_hp:
   87  34:9E47  A0 06                             ldy #6
   88  34:9E49  B1 6E                             lda [.pActor],y
   89  34:9E4B  A0 04                             ldy #4
   90  34:9E4D  91 6E                             sta [.pActor],y
   91  34:9E4F            .check_status:  ;$9e5f:
   92  34:9E4F  A0 01             ldy #1
   93  34:9E51  B1 6E             lda [.pActor],y
   94  34:9E53  29 C0             and #$c0        ;dead|stone
   95  34:9E55  D0 68             bne .actor_status_bad
   96                                     ;check more
   97  34:9E57  C8                        iny
   98  34:9E58  B1 6E                     lda [.pActor],y
   99  34:9E5A  29 C0                     and #$c0        ;paralyzed | sleeping
  100  34:9E5C  F0 0B                     beq .actor_status_ok
  101  34:9E5E  A9 01                             lda #1
  102  34:9E60  20 7B 9F                          jsr setActorActionAndClearMode  ;$9f7b
  103  34:9E63  20 CE 91                          jsr setNoTargetMessage  ;$91ce
  104  34:9E66  20 87 9F                          jsr setActionTargetToSelf       ;$9f87
  105                     ;$9e93:
  106  34:9E69                    .actor_status_ok:
  107  34:9E69  A0 2F                     ldy #$2f
  108  34:9E6B  B1 6E                     lda [.pActor],y
  109  34:9E6D  8D 99 7E                  sta $7e99
  110  34:9E70  8D 9B 7E                  sta $7e9b
  111  34:9E73  D0 03                     bne .target_valid
  112  34:9E75  20 87 9F                          jsr setActionTargetToSelf
  113  34:9E78                    .target_valid:
  114  34:9E78  A2 00                     ldx #0
  115  34:9E7A                    .target_bit_to_index:
  116  34:9E7A  0A                                asl a
  117  34:9E7B  B0 03                             bcs .got_index
  118  34:9E7D  E8                                inx
  119  34:9E7E  D0 FA                             bne .target_bit_to_index
  120  34:9E80                    .got_index:
  121  34:9E80  8A                        txa
  122  34:9E81  48                        pha
  123                                     
  124  34:9E82  C8                        iny
  125  34:9E83  B1 6E                     lda [.pActor],y ;+30
  126  34:9E85  A8                        tay
  127                                     
  128  34:9E86  10 11                     bpl .target_player
  129  34:9E88  AD 9A 7E                          lda play_effectTargetSide       ;$7e9a
  130  34:9E8B  09 40                             ora #$40
  131  34:9E8D  8D 9A 7E                          sta play_effectTargetSide       ;$7e9a
  132                                             
  133  34:9E90  68                                pla
  134  34:9E91  09 80                             ora #$80
  135  34:9E93  48                                pha     ;sta $78d8
  136                     
  137  34:9E94  18                                clc
  138  34:9E95  8A                                txa
  139  34:9E96  69 04                             adc #4
  140  34:9E98  AA                                tax
  141                                             ;bne .set_target_name
  142  34:9E99                    .target_player:
  143  34:9E99                    .set_target_name:
  144  34:9E99  86 18                     stx <$18        ;actor ordinal
  145  34:9E9B  68                        pla     ;target index
  146  34:9E9C  AA                        tax
  147                                     
  148  34:9E9D  98                        tya     ;target flag
  149  34:9E9E  0A                        asl a
  150  34:9E9F  10 02                     bpl .target_single
  151  34:9EA1  A2 88                             ldx #$88
  152  34:9EA3                    .target_single:
  153  34:9EA3  8E D8 78                  stx $78d8
  154                     
  155  34:9EA6  A9 40                     lda #$40
  156  34:9EA8  85 1A                     sta <$1a
  157                                     INIT16 <$20,$7575
       34:9EAA  A9 75             lda #LOW($7575)
       34:9EAC  85 20             sta <$20
       34:9EAE  A9 75             lda #HIGH($7575)
       34:9EB0  85 21             sta <$20+1
  158  34:9EB2  20 2E 80                  jsr dispatchBattleFunction_07   ;$802e
  159                                     
  160  34:9EB5  A5 1C                     lda <$1c
  161  34:9EB7  85 70                     sta <.pTarget
  162  34:9EB9  A5 1D                     lda <$1d
  163  34:9EBB  85 71                     sta <.pTarget+1
  164  34:9EBD  D0 15                     bne .check_action_mode  ;target address should be $75xx-$77xx
  165                                     ;bne
  166  34:9EBF            .actor_status_bad
  167  34:9EBF  88                        dey
  168  34:9EC0  98                        tya
  169  34:9EC1  8C C2 7E                  sty effectHandlerIndex  ;$7ec2
  170  34:9EC4  8C 98 7E                  sty $7e98
  171  34:9EC7  88                        dey
  172  34:9EC8  8C EB 7C                  sty $7ceb
  173  34:9ECB  8C D8 78                  sty $78d8
  174  34:9ECE  8C D6 78                  sty $78d6
  175  34:9ED1  20 7B 9F                  jsr setActorActionAndClearMode  ;$9f7b
  176                     ;$9eec:
  177                     ;-----------------------------
  178  34:9ED4            .check_action_mode:
  179           001A      .actionId = $1a
  180  34:9ED4  A0 2E             ldy #$2e
  181  34:9ED6  B1 6E             lda [.pActor],y
  182  34:9ED8  85 1A             sta <.actionId  ;actionid
  183                             
  184  34:9EDA  20 2E A4          jsr getActor2C
  185  34:9EDD  AA                tax
  186  34:9EDE  29 10             and #$10        ;special
  187  34:9EE0  D0 36             bne .special_attack     ;$9f5a
  188  34:9EE2  8A                txa
  189  34:9EE3  29 08             and #$08
  190  34:9EE5  D0 0A             bne .use_item   ;$9f19
  191                     ;$9f0b:
  192  34:9EE7  A5 1A             lda <.actionId
  193           0001              .ifdef ENABLE_EXTRA_ABILITY
  194  34:9EE9  C9 19                     cmp #CMDX_ID_END
  195                             .else
  197                             .endif
  198  34:9EEB  90 2D             bcc .dispatch
  199  34:9EED  C9 46             cmp #$46
  200  34:9EEF  B0 04             bcs .check_caster
  201                             ;invalid action id
  202  34:9EF1            .use_item:
  203  34:9EF1  A9 13             lda #$13
  204  34:9EF3  D0 25             bne .dispatch
  205  34:9EF5            .check_caster:
  206                             ;jsr getActor2C
  207  34:9EF5  8A                txa
  208  34:9EF6  30 20             bmi .special_attack
  209                     ;decrement mp
  210           0052      .iPlayer = $52
  211  34:9EF8  29 07                     and #7
  212  34:9EFA  AA                        tax
  213  34:9EFB  BD C7 7A                  lda selectedMagicLv,x
  214  34:9EFE  18                        clc
  215  34:9EFF  69 07                     adc #7
  216  34:9F01  A8                        tay
  217  34:9F02  38                        sec
  218  34:9F03  B1 6E                     lda [.pActor],y ;mp
  219  34:9F05  E9 01                     sbc #1
  220  34:9F07  91 6E                     sta [.pActor],y
  221                                     
  222  34:9F09  A5 1A                     lda <.actionId
  223  34:9F0B  A2 07                     ldx #7
  224  34:9F0D                    .check_summon_id:
  225  34:9F0D  DD 2C 9F                          cmp .summonMagicIds,x
  226  34:9F10  D0 03                             bne .check_summon_next
  227  34:9F12  4C 00 A0                                  jmp executeAction_summon
  228  34:9F15                            .check_summon_next:
  229  34:9F15  CA                                dex
  230  34:9F16  10 F5                             bpl .check_summon_id
  231  34:9F18            .special_attack:        ;$9f5a
  232  34:9F18  A9 14             lda #$14
  233  34:9F1A            .dispatch:      ;$9f5c
  234  34:9F1A  8D C2 7E          sta effectHandlerIndex  ;$7ec2
  235                     
  236  34:9F1D  0A                asl a
  237  34:9F1E  AA                tax
  238  34:9F1F  BD 34 9F          lda executeAction_handlers,x
  239  34:9F22  85 18             sta <$18
  240  34:9F24  BD 35 9F          lda executeAction_handlers+1,x
  241  34:9F27  85 19             sta <$19
  242  34:9F29  6C 18 00          jmp [$0018]
  243  34:9F2C            .summonMagicIds:
  244  34:9F2C  CE D5 DC          .db $ce,$d5,$dc,$e3,$ea,$f1,$f8,$ff
       34:9F2F  E3 EA F1  
       34:9F32  F8 FF     
  245  34:9F34            executeAction_end:
  246                     ;======================================================================================================
  247           9FA8      command_none            = $9fa8
  248           A68A      command_01                      = $a68a
  249                     ;command_forward        = $a7df
  250                     ;command_back           = $a7ea
  251                     ;command_fight          = $a104
  252                     ;command_guard          = $a881
  253                     ;command_escape         = $a8bf
  254                     ;command_sneakAway      = $a93b
  255                     ;command_jump           = $a9d8
  256                     ;command_land           = $aa11
  257                     ;command_0A                     = $a89f
  258                     ;command_geomance       = $aa5d
  259                     ;command_inspect        = $ab73
  260                     ;command_detect         = $ab0c
  261                     ;command_steal          = $aba4
  262                     ;command_charge         = $ac6f
  263                     ;command_sing           = $acd5
  264                     ;command_intimidate     = $ad16
  265                     ;command_cheer          = $ad75
  266           A3BB      command_item            = $a3bb
  267           A367      command_magic           = $a367
  268                     ;------------------------------------------------------------------------------------------------------
  269                     ;       .org    $9fac
  270                             INIT_PATCH $34,$9fac,$9fac+($02*$15)
                0034              .bank   $34
                9FAC              .org    $9fac
       34:9FAC                    .ds             (($9fac+($02*$15)) - ($9fac))
                9FAC              .org    $9fac
  271                             RESTORE_PC executeAction_end
                0034              .bank   BANK(executeAction_end)
                9F34              .org    executeAction_end
  272                     
  273  34:9F34            executeAction_handlers: ;$9fac: //function table
  274  34:9F34  A8 9F             .dw     command_none            ;$9fa8
  275  34:9F36  8A A6             .dw command_01                  ;$a68a
  276  34:9F38  33 A8             .dw command_forward             ;$a7df
  277  34:9F3A  33 A8             .dw command_back                ;$a7ea
  278  34:9F3C  04 A1             .dw command_fight               ;$a104
  279  34:9F3E  65 A8             .dw command_guard               ;$a881
  280  34:9F40  7C A8             .dw command_escape              ;$a8bf
  281  34:9F42  09 A9             .dw command_sneakAway   ;$a93b
  282  34:9F44  35 A9             .dw command_jump                ;$a9d8
  283  34:9F46  61 A9             .dw command_land                ;$aa11
  284  34:9F48  A8 9F             .dw command_none                ;$9fa8
  285  34:9F4A  72 A9             .dw command_geomance    ;$aa5d
  286  34:9F4C  5E AA             .dw command_inspect             ;$ab73
  287  34:9F4E  24 AA             .dw command_detect              ;$ab0c
  288  34:9F50  85 AA             .dw command_steal               ;$aba4
  289  34:9F52  1A AB             .dw command_charge              ;$ac6f
  290  34:9F54  66 AB             .dw command_sing                ;$acd5
  291  34:9F56  84 AB             .dw command_intimidate  ;$ad16
  292  34:9F58  C3 AB             .dw command_cheer               ;$ad75
  293  34:9F5A  BB A3             .dw command_item                ;$a3bb
  294  34:9F5C  67 A3             .dw command_magic               ;$a367
  295                             ;extension to original
  296  34:9F5E  00 00             .dw 0   ;dummy
  297  34:9F60  4E B6             .dw cmdx_provoke
  298  34:9F62  30 B7             .dw cmdx_disorderedShot
  299  34:9F64  FF B8             .dw cmdx_abyss
  300  34:9F66            executeAction_free_begin:
  301                     ;$9f7b
  302                     ;======================================================================================================
  303                     ;$34:9f7b setActorCommandIdAndClearMode
  304                     
  305                     ;$34:9f87 setActionTargetToSelf //setActionTargetBitAndFlags
  306                     
  307                     ;$34:9fa8 handleCommand00_0a //do nothing
  308                     ;======================================================================================================
  309                             INIT_PATCH $34,$9fa6,$a000
                0034              .bank   $34
                9FA6              .org    $9fa6
       34:9FA6                    .ds             (($a000) - ($9fa6))
                9FA6              .org    $9fa6
  310  34:9FA6            setXtoActorIndex:
  311  34:9FA6  20 2E A4          jsr getActor2C
  312  34:9FA9  29 07             and #7
  313  34:9FAB  AA                tax
  314  34:9FAC  60                rts
  315  34:9FAD            flagSingleTarget:
  316                     ;[in] x = targetIndex
  317  34:9FAD  A9 00             lda #0
  318  34:9FAF  4C 20 FD          jmp flagTargetBit
  319                             ;rts
  320                     ;------------------------------------------------------------------------------------------------------
  321                             INIT_PATCH $35,$a000,$a104
                0035              .bank   $35
                A000              .org    $a000
       35:A000                    .ds             (($a104) - ($a000))
                A000              .org    $a000
  322                     
  323  35:A000            executeAction_summon:
  324           0018      .magicParamsCache = $18
  325                     ;.actionId = $26
  326                     ;.targetBit = $27
  327                     ;.targetFlag = $28
  328           0030      .summonType = $30
  329           0052      .iPlayer = $52
  330           006E      .pActor = $6e
  331                     
  332  35:A000  A2 3F             ldx #$3f
  333  35:A002  A9 00             lda #0
  334  35:A004  8D 93 7E          sta $7e93
  335  35:A007            .init_char_struct:
  336  35:A007  9D 75 78                  sta $7875,x
  337  35:A00A  CA                        dex
  338  35:A00B  10 FA                     bpl .init_char_struct
  339  35:A00D  A9 02             lda #2
  340  35:A00F  85 30             sta <.summonType
  341                     ;original checks job == #13 || #14
  342  35:A011  A0 3C             ldy #EXTRA_ABILITY_OFFSET
  343  35:A013  B1 6E             lda [.pActor],y
  344  35:A015  29 10             and #PASSIVE_SUMMON_FUSION
  345  35:A017  D0 0D             bne .summon_fusion
  346                     ;$9ffc:
  347  35:A019  A9 63                     lda #99
  348  35:A01B  20 64 A5                  jsr getSys1Random       ;a564
  349  35:A01E  C9 32                     cmp #50
  350  35:A020  B0 02                     bcs .summon_black
  351  35:A022  C6 30                             dec <.summonType
  352  35:A024                    .summon_black:
  353  35:A024  C6 30                     dec <.summonType
  354  35:A026            .summon_fusion:
  355                     ;$a009:
  356                             ;.bank $35
  357                             
  358                             ;jsr getActor2C
  359                             ;and #7
  360                             ;sta <.iPlayer
  361                             ;tax
  362  35:A026  20 A6 9F          jsr setXtoActorIndex
  363  35:A029  BD C7 7A          lda selectedMagicLv,x
  364  35:A02C  48                pha
  365                             
  366  35:A02D  20 3E FD          jsr $fd3e       ;a<<=4
  367  35:A030  05 30             ora <.summonType
  368  35:A032  8D 94 7E          sta $7e94
  369                     
  370                     ;       INIT16 <.pActor,$7875
  371                     ;       setYtoOffsetOf(a = #0f);        //$9b88
  372  35:A035  A0 0F             ldy #$0f
  373  35:A037  A2 02             ldx #2
  374  35:A039            .load_params:
  375  35:A039  B1 6E                     lda [.pActor],y
  376  35:A03B  0A                        asl a
  377  35:A03C  95 18                     sta <.magicParamsCache,x
  378  35:A03E  C8                        iny
  379  35:A03F  CA                        dex
  380  35:A040  10 F7                     bpl .load_params
  381                     
  382  35:A042  A0 01             ldy #1
  383  35:A044  B1 6E             lda [.pActor],y
  384  35:A046  29 30             and #$30        ;toad|sealed
  385  35:A048  48                pha
  386                             
  387                             INIT16 <.pActor,$7875
       35:A049  A9 75             lda #LOW($7875)
       35:A04B  85 6E             sta <.pActor
       35:A04D  A9 78             lda #HIGH($7875)
       35:A04F  85 6F             sta <.pActor+1
  388                     
  389  35:A051  68                pla
  390  35:A052  91 6E             sta [.pActor],y
  391                             ;
  392  35:A054  88                dey
  393  35:A055  A5 1A             lda <.magicParamsCache+2        ;joblv
  394  35:A057  91 6E             sta [.pActor],y
  395                     
  396  35:A059  A0 0F             ldy #$0f
  397  35:A05B  A2 02             ldx #2
  398  35:A05D            .store_params:
  399  35:A05D  B5 18                     lda <.magicParamsCache,x
  400  35:A05F  91 6E                     sta [.pActor],y
  401  35:A061  C8                        iny
  402  35:A062  CA                        dex
  403  35:A063  10 F8                     bpl .store_params
  404  35:A065  A0 03             ldy #3
  405  35:A067  98                tya
  406  35:A068  91 6E             sta [.pActor],y ;hp
  407                             
  408  35:A06A  AE C2 7A          ldx $7ac2
  409  35:A06D  A9 88             lda #$88
  410  35:A06F  9D CB 7A          sta $7acb,x
  411                     
  412                             ;$6e[y] = getActor2C() | #90;
  413  35:A072  A0 2C             ldy #$2c
  414  35:A074  A9 90             lda #$90
  415  35:A076  91 6E             sta [.pActor],y
  416                     ;$a065:
  417  35:A078  68                pla     ;selectedMagicLv
  418  35:A079  85 18             sta <$18
  419  35:A07B  0A                asl a
  420  35:A07C  18                clc
  421  35:A07D  65 18             adc <$18
  422  35:A07F  65 30             adc <.summonType
  423  35:A081  AA                tax     ; a = selectedMagicLv*3 + summonType
  424                     
  425  35:A082  18                clc
  426  35:A083  69 78             adc #$78
  427  35:A085  8D DA 78          sta battleMessages
  428                             
  429  35:A088  8A                txa
  430  35:A089  18                clc
  431  35:A08A  69 21             adc #$21
  432  35:A08C  8D D9 78          sta effectMessage
  433                     
  434  35:A08F  8A                txa
  435  35:A090  69 5B             adc #$5b
  436  35:A092  85 18             sta <$18
  437  35:A094  48                pha     ;sta <.actionId
  438                             
  439  35:A095  A9 08             lda #8
  440  35:A097  85 1A             sta <$1a
  441                             INIT16 <$20,$98c0
       35:A099  A9 C0             lda #LOW($98c0)
       35:A09B  85 20             sta <$20
       35:A09D  A9 98             lda #HIGH($98c0)
       35:A09F  85 21             sta <$20+1
  442  35:A0A1  A2 00             ldx #0
  443  35:A0A3  20 3A BA          jsr loadTo7400FromBank30        ;$ba3a
  444                             
  445           7400      .actionParams = $7400
  446                             
  447  35:A0A6  2C 05 74          bit .actionParams+5
  448  35:A0A9  10 07             bpl .target_enemy
  449  35:A0AB  A9 F0                     lda #$f0
  450  35:A0AD  48                        pha
  451  35:A0AE  A9 40                     lda #$40
  452  35:A0B0  D0 11                     bne .store_action_params
  453  35:A0B2            .target_enemy:
  454  35:A0B2  50 07                     bvc .target_single
  455  35:A0B4  A9 FF                             lda #$ff
  456  35:A0B6  48                                pha
  457  35:A0B7                    .target_all:
  458  35:A0B7  A9 C0                             lda #$c0
  459  35:A0B9  D0 08                             bne .store_action_params
  460  35:A0BB                    .target_single:
  461                             
  462           0062      .targetBit = $62
  463                     
  464  35:A0BB  20 DA A0                          jsr invokePickRandomTarget
  465  35:A0BE  A5 62                             lda <.targetBit
  466  35:A0C0  48                                pha
  467  35:A0C1  A9 80                             lda #$80
  468  35:A0C3            .store_action_params:
  469  35:A0C3  A0 30             ldy #$30
  470  35:A0C5  91 6E             sta [.pActor],y ;target flag
  471  35:A0C7  88                dey
  472  35:A0C8  68                pla
  473  35:A0C9  91 6E             sta [.pActor],y ;target bit
  474  35:A0CB  88                dey
  475  35:A0CC  68                pla
  476  35:A0CD  91 6E             sta [.pActor],y ;action id
  477                     
  478                             INIT16 <$5d,$7675
       35:A0CF  A9 75             lda #LOW($7675)
       35:A0D1  85 5D             sta <$5d
       35:A0D3  A9 76             lda #HIGH($7675)
       35:A0D5  85 5E             sta <$5d+1
  479                     ;$a0ea:
  480  35:A0D7  4C E4 9D          jmp executeAction
  481                             ;jmp $9de4      ;executeAction
  482                     ;------------------------------------------------------------------------------------------------------
  483  35:A0DA            invokePickRandomTarget:
  484           004C      .battleFunctionId = $4c
  485  35:A0DA  A9 0A             lda #BF_PICK_RANDOM_TARGET
  486  35:A0DC  85 4C             sta <.battleFunctionId
  487  35:A0DE  4C F3 FD          jmp invoke_b30_battleFunction
  488                     ;$a104:
  489                     
  490                     ;======================================================================================================
  491                             RESTORE_PC ff3_executeAction_begin
                0000              .bank   BANK(ff3_executeAction_begin)
                8000              .org    ff3_executeAction_begin
#[3]   ff3_hack_master.asm
   33                                     
#[4]   ff3_command_window.asm
   34                                     .include "ff3_command_window.asm"
    1                     ; ff3_command_window.asm
    2                     ;
    3                     ;description:
    4                     ;       command window related codes
    5                     ;       implements 'extra ability' feature ready mechanism
    6                     ;
    7                     ;version:
    8                     ;       0.14 (2006-11-01)
    9                     ;======================================================================================================
   10  00:8000            ff3_commandWindow_begin:
   11                             INIT_PATCH $34,$986c,$99fd
                0034              .bank   $34
                986C              .org    $986c
       34:986C                    .ds             (($99fd) - ($986c))
                986C              .org    $986c
   12                     
   13           0001              .ifdef BETA
   14                     RET_TO_GET_COMMAND_INPUT        .macro
   15                             rts
   16                             .endm
   17                             
   18                             .else
   23                             .endif  ;beta
   24                     
   25           0001              .ifdef BETA
   26  34:986C            getPlayerCommandInput:
   27           0052      .iPlayer = $52
   28           0055      .cursorId = $55
   29           005B      .pPlayer = $5b
   30           005F      .playerOffset = $5f
   31           78BA      .beginningMode = $78ba  ;08:backattack 01:escapable? 80:enemy surprise attack
   32           78CF      .selectedCommands = $78cf       ;[4]
   33           7ED8      .battleMode = $7ed8
   34                     ;-------------------------------------
   35  34:986C  20 9E 9D          jsr drawEnemyNamesWindow        ;9d9e
   36  34:986F            .input_next:    
   37  34:986F  A6 52             ldx <.iPlayer
   38  34:9871  E0 04             cpx #4
   39  34:9873  F0 28             beq .drawHpWindow
   40  34:9875  AD E1 7B                  lda $7be1
   41  34:9878  20 2C FD                  jsr clearTargetBit      ;$fd2c
   42  34:987B  8D E1 7B                  sta $7be1
   43  34:987E  20 41 A5                  jsr getPlayerOffset
   44  34:9881  A8                        tay
   45  34:9882  C8                        iny
   46  34:9883  C8                        iny
   47  34:9884  B1 5B                     lda [.pPlayer],y
   48  34:9886  4A                        lsr a
   49  34:9887  90 0A                     bcc .not_jumping
   50  34:9889  20 94 9B                          jsr setYtoOffset2F
   51  34:988C  B1 5B                             lda [.pPlayer],y
   52  34:988E  9D 0F 7E                          sta $7e0f,x
   53  34:9891  D0 0A                             bne .drawHpWindow
   54  34:9893                    .not_jumping:
   55  34:9893  A9 FF                     lda #$ff
   56  34:9895  9D CF 78                  sta .selectedCommands,x
   57  34:9898  A9 00                     lda #0
   58  34:989A  9D 0F 7E                  sta $7e0f,x
   59  34:989D            .drawHpWindow:
   60  34:989D  20 A2 9B          jsr drawInfoWindow      ;9ba2
   61  34:98A0  20 33 A4          jsr $a433       ;endCommandInputIfDone
   62  34:98A3  20 41 A5          jsr getPlayerOffset     ;a541
   63  34:98A6  A6 52             ldx <.iPlayer
   64  34:98A8  BD E4 7C          lda $7ce4,x
   65  34:98AB  F0 0E             beq .check_status0
   66  34:98AD  48                        pha
   67  34:98AE  A9 23                     lda #$23
   68  34:98B0  20 88 9B                  jsr setYtoOffsetOf
   69  34:98B3  68                        pla
   70  34:98B4  91 5B                     sta [.pPlayer],y
   71  34:98B6  A9 00                     lda #0
   72  34:98B8  9D E4 7C                  sta $7ce4,x
   73  34:98BB            .check_status0: ;98bd
   74  34:98BB  A4 5F             ldy <.playerOffset
   75  34:98BD  C8                iny
   76  34:98BE  B1 5B             lda [.pPlayer],y
   77  34:98C0  29 C0             and #$c0        ;dead|stone
   78  34:98C2  F0 08             beq .check_status1
   79  34:98C4  E6 52                     inc <.iPlayer
   80  34:98C6  EE EB 7C                  inc $7ceb
   81  34:98C9  4C 6F 98                  jmp .input_next
   82  34:98CC            .check_status1: ;98ce
   83  34:98CC  C8                iny
   84  34:98CD  B1 5B             lda [.pPlayer],y
   85  34:98CF  4A                lsr a
   86  34:98D0  29 70             and #$70        ; (paralyze | sleep | confuse) >> 1
   87  34:98D2  F0 03             beq .check_jumping
   88  34:98D4  4C 6C A6                  jmp $a66c
   89  34:98D7            .check_jumping: ;98d8
   90  34:98D7  90 04             bcc .create_commandWindow
   91  34:98D9  E6 52                     inc <.iPlayer
   92  34:98DB  D0 92                     bne .input_next
   93  34:98DD            .create_commandWindow:  ;$98e3
   94  34:98DD  20 69 9A          jsr createCommandWindow ; $9a69
   95  34:98E0  20 9B 9B          jsr setYtoOffset2E      ;$9b9b
   96  34:98E3  A9 00             lda #0
   97  34:98E5  A2 03             ldx #3
   98  34:98E7            .init_action_params:
   99  34:98E7  91 5B             sta [.pPlayer],y
  100  34:98E9  C8                iny
  101  34:98EA  CA                dex
  102  34:98EB  D0 FA             bne .init_action_params
  103                             
  104  34:98ED  A9 2C             lda #$2c
  105  34:98EF  20 88 9B          jsr setYtoOffsetOf
  106  34:98F2  B1 5B             lda [.pPlayer],y
  107  34:98F4  29 F7             and #$f7
  108  34:98F6  91 5B             sta [.pPlayer],y
  109  34:98F8  98                tya
  110  34:98F9  18                clc
  111  34:98FA  69 13             adc #$13
  112  34:98FC  A8                tay
  113  34:98FD  B1 5B             lda [.pPlayer],y        ;y:+3f
  114  34:98FF  F0 03             beq .check_redraw_enemy_names
  115  34:9901  20 E7 9A                  jsr putCanceledItem     ;$9ae7
  116  34:9904            .check_redraw_enemy_names:
  117  34:9904  AD F3 7C          lda $7cf3
  118  34:9907  D0 25             bne .move_character
  119                                     ;1st phase
  120  34:9909  20 9E 9D                  jsr drawEnemyNamesWindow        ;9d9e
  121  34:990C  A9 00                     lda #0
  122  34:990E  20 0E FA                  jsr call_2e_9d53
  123  34:9911  AD D8 7E                  lda .battleMode
  124  34:9914  29 20                     and #$20
  125  34:9916  F0 06                     beq .check_surprise_attack
  126  34:9918  20 0B A5                          jsr $a50b
  127  34:991B  4C 6C 98                          jmp getPlayerCommandInput
  128  34:991E                    .check_surprise_attack:
  129  34:991E  AD BA 78                  lda .beginningMode ;$78ba
  130  34:9921  10 01                     bpl .wait_any_button
  131  34:9923  60                                rts
  132  34:9924                    .wait_any_button:
  133  34:9924  20 AA FB                          jsr getPad1Input
  134  34:9927  A5 12                             lda <inputBits
  135  34:9929  F0 F9                             beq .wait_any_button
  136  34:992B  20 69 9A                  jsr createCommandWindow
  137  34:992E            .move_character:        ;9940
  138  34:992E  A9 02             lda #2
  139  34:9930  20 0E FA          jsr call_2e_9d53        ;fa0e
  140  34:9933  A5 52             lda <.iPlayer
  141  34:9935  85 53             sta <$53
  142  34:9937  A9 00             lda #0
  143  34:9939  85 55             sta <.cursorId
  144  34:993B  85 24             sta <$24
  145  34:993D  85 25             sta <$25
  146  34:993F  85 1A             sta <$1a
  147  34:9941  20 66 89          jsr loadCursor  ;8966
  148                     
  149  34:9944            .input_wait:;9958
  150  34:9944  A0 03             ldy #3  ;to keep input accepted in 3 frames interval 
  151  34:9946            .wait_loop:     
  152  34:9946  20 80 FB                  jsr waitNmi
  153  34:9949  88                        dey
  154  34:994A  D0 FA                     bne .wait_loop
  155  34:994C  A9 00             lda #0
  156  34:994E  85 1B             sta <$1b
  157  34:9950  A9 03             lda #3
  158  34:9952  85 46             sta <$46        
  159                     
  160  34:9954  20 9E 89          jsr getInputAndUpdateCursorWithSound    ;899e
  161           0050      .inputCopy = $50
  162                     ;.invert = $18
  163           0023      .row = $23
  164                     
  165  34:9957  A9 01             lda #1
  166  34:9959  24 50             bit <.inputCopy
  167  34:995B  D0 42             bne .OnA
  168  34:995D  A9 02             lda #2
  169  34:995F  24 50             bit <.inputCopy
  170  34:9961  D0 10             bne .OnB
  171  34:9963  70 19             bvs .OnLeft
  172  34:9965  10 DD             bpl .input_wait
  173  34:9967            .OnRight:
  174  34:9967  A0 00                     ldy #0
  175  34:9969  A6 25                     ldx <$25
  176  34:996B  D0 1E                     bne .change_position
  177  34:996D  84 24                             sty <$24
  178  34:996F  E6 25                             inc <$25
  179  34:9971  10 D1                             bpl .input_wait
  180  34:9973            .OnB:
  181  34:9973  A5 52             lda <.iPlayer
  182  34:9975  F0 03             beq .back_input_char
  183  34:9977  20 42 9A                  jsr $9a42
  184  34:997A            .back_input_char:
  185  34:997A  A9 01             lda #1
  186  34:997C  D0 50             bne .go_next_char
  187                             ;jmp getCommandInput_next
  188  34:997E            .OnLeft:
  189  34:997E  A0 01                     ldy #1
  190  34:9980  A6 24                     ldx <$24
  191  34:9982  D0 07                     bne .change_position
  192  34:9984  84 24                             sty <$24
  193  34:9986  88                                dey
  194  34:9987  84 25                             sty <$25
  195  34:9989  F0 B9                             beq .input_wait
  196  34:998B                    .change_position:
  197  34:998B  A9 08                     lda #8
  198  34:998D  2C BA 78                  bit $78ba       ;backattack flag
  199  34:9990  F0 04                     beq .back
  200  34:9992  A9 04                             lda #4
  201  34:9994  D0 02                             bne .store_command
  202  34:9996                    .back:
  203  34:9996  A9 05                             lda #5
  204  34:9998                    .store_command:
  205  34:9998  85 23                     sta <.row
  206  34:999A  98                        tya
  207  34:999B  45 23                     eor <.row
  208  34:999D  85 23                     sta <.row
  209  34:999F            .OnA:   ;99c6
  210  34:999F  20 7D 9B          jsr requestSoundEffect05        ;9b7d
  211                             ;v0.6.2 fix
  212  34:99A2  A9 00             lda #0
  213  34:99A4  85 18             sta <$18
  214                             ;<--
  215  34:99A6  20 DF 8A          jsr clearSprites2x2             ;8adf
  216                             
  217  34:99A9  A6 23             ldx <.row
  218  34:99AB  BD 00 74          lda $7400,x
  219  34:99AE  48                pha
  220  34:99AF  A6 52             ldx <.iPlayer
  221  34:99B1  9D CF 78          sta .selectedCommands,x
  222  34:99B4  A5 23             lda <.row
  223  34:99B6  9D C3 7A          sta $7ac3,x
  224  34:99B9  68                pla             ;commandId
  225                             ;v0.6.3 --->
  226  34:99BA  AA                tax
  227                             ;<---
  228  34:99BB  0A                asl a
  229  34:99BC  18                clc
  230  34:99BD  69 E8             adc #LOW(commandWindow_handlers)
  231  34:99BF  85 19             sta <$19
  232  34:99C1  A9 00             lda #0
  233  34:99C3  69 99             adc #HIGH(commandWindow_handlers)
  234  34:99C5  85 1A             sta <$1a
  235  34:99C7  A9 6C             lda #$6c        ;jmp (addr)
  236  34:99C9  85 18             sta <$18
  237  34:99CB  20 18 00          jsr $0018       ;invoke commandWindowHandler (x = handlerIndex = commandId)
  238                     ;$99fd
  239                     ;getCommandInput_next:
  240  34:99CE            .go_next_char:
  241  34:99CE  48                pha
  242  34:99CF  A5 52             lda <.iPlayer
  243  34:99D1  48                pha
  244  34:99D2  A5 53             lda <$53
  245  34:99D4  85 52             sta <.iPlayer
  246  34:99D6  A9 01             lda #1
  247  34:99D8  20 0E FA          jsr call_2e_9d53
  248  34:99DB  68                pla
  249  34:99DC  85 52             sta <.iPlayer
  250  34:99DE  68                pla
  251  34:99DF  F0 03             beq .redraw
  252  34:99E1  4C 6F 98                  jmp getPlayerCommandInput+3     ;986f
  253  34:99E4            .redraw:
  254  34:99E4  4C 6C 98          jmp getPlayerCommandInput       ;986c
  255                     ;$9a16
  256                     ;=======================================================================================================
  257                     ;original addresses
  258                     ;commandWindow_nop      = $9a68
  259                     ;01
  260                     ;commandWindow_OnForward        = $a71c
  261                     ;commandWindow_OnBack   = $a750
  262                     ;commandWindow_OnFight  = $a843
  263                     ;commandWindow_OnGuard  = $a877
  264                     ;commandWindow_OnEscape = $a8ab
  265                     ;commandWindow_OnSneakAway      = $a8b5
  266                     ;commandWindow_OnJump   = $a9ab
  267                     ;09
  268                     ;commandWindow_OnA      ;hacked
  269                     ;commandWindow_OnGeomance       = $aa22
  270                     ;commandWindow_OnInspect                = $ab6e
  271                     ;commandWindow_OnDetect         = $ab07
  272                     ;commandWindow_OnSteal          = $ab9f
  273                     ;commandWindow_OnCharge         = $ac65
  274                     ;commandWindow_OnSing           = $acd0
  275                     ;commandWindow_OnIntimidate     = $ad0c
  276                     ;commandWindow_OnCheer          = $ad6b
  277                     ;13
  278                     ;commandWindow_OnItem   = $adaf ;14
  279                     ;commandWindow_OnMagic  = $b646 ;15
  280                     ;------------------------------------------------------------------------------------------------------
  281                     ;       .org $9a16
  282                             ALIGN_EVEN
       34:99E7                    .check_align_00042:
                0001              .if (.check_align_00042 & 1) != 0
       34:99E7  EA                        nop     ;pad
                                  .endif
  283                     
  284  34:99E8            commandWindow_handlers:
  285  34:99E8  B3 A7             .dw     commandWindow_nop       ;$9a68
  286  34:99EA  B3 A7             .dw     commandWindow_nop       ;$9a68
  287  34:99EC  45 A7             .dw commandWindow_OnForward     ;$a71c
  288  34:99EE  57 A7             .dw commandWindow_OnBack        ;$a750
  289  34:99F0  C1 A7             .dw commandWindow_OnFight       ;$a843
  290  34:99F2  D7 A7             .dw commandWindow_OnGuard       ;$a877
  291  34:99F4  D7 A7             .dw commandWindow_OnEscape      ;$a8ab
  292  34:99F6  D7 A7             .dw commandWindow_OnSneakAway   ;$a8b5
  293  34:99F8  E2 A7             .dw commandWindow_OnJump        ;$a9ab
  294  34:99FA  B3 A7             .dw commandWindow_nop   ;$9a68
  295  34:99FC  B3 A7             .dw commandWindow_nop   ;$9a68
  296  34:99FE  EF A7             .dw commandWindow_OnGeomance    ;$aa22
  297  34:9A00  C1 A7             .dw commandWindow_OnInspect             ;$ab6e
  298  34:9A02  C1 A7             .dw commandWindow_OnDetect              ;$ab07
  299  34:9A04  C1 A7             .dw commandWindow_OnSteal               ;$ab9f
  300  34:9A06  D7 A7             .dw commandWindow_OnCharge              ;$ac65
  301  34:9A08  C1 A7             .dw commandWindow_OnSing                ;$acd0
  302  34:9A0A  D7 A7             .dw commandWindow_OnIntimidate  ;$ad0c
  303  34:9A0C  D7 A7             .dw commandWindow_OnCheer               ;$ad6b
  304  34:9A0E  B3 A7             .dw commandWindow_nop           ;$9a68
  305  34:9A10  E9 AB             .dw commandWindow_OnItem        ;$adaf
  306  34:9A12  E0 B2             .dw commandWindow_OnMagic       ;$b646
  307                             ;extra
  308                             ;容量以外に制限無し
  309  34:9A14  B6 A7             .dw commandWindow_OnProvoke     ;extra
  310  34:9A16  D7 A7             .dw commandWindow_OnDisorderedShot      ;extra
  311  34:9A18  B6 A7             .dw commandWindow_OnAbyss       ;abyss
  312                     ;$9a40
  313                     ;=======================================================================================================
  314  34:9A1A            getCommandInput_end:
  315                     ;=======================================================================================================
  316                             INIT_PATCH $34,$9a69,$9ae7
                0034              .bank   $34
                9A69              .org    $9a69
       34:9A69                    .ds             (($9ae7) - ($9a69))
                9A69              .org    $9a69
  317  34:9A69            createCommandWindow:
  318                     ;[in]
  319           0006      .width = COMMAND_WINDOW_WIDTH   ;original:5
  320           0057      .pPlayerBaseParam = $57
  321           005F      .playerOffset = $5f
  322           78BA      .beginningMode = $78ba
  323           9B21      .jobCommandList = $9b21
  324                     ;[out]
  325           0038      .emptyCount = $38
  326           7400      .commandIdList = $7400
  327                     ;---------------------------------------------------
  328  34:9A69  A2 02             ldx #2
  329  34:9A6B  8E 04 74          stx .commandIdList+4
  330  34:9A6E  E8                inx
  331  34:9A6F  8E 05 74          stx .commandIdList+5
  332  34:9A72  A4 5F             ldy <.playerOffset
  333  34:9A74  B1 57             lda [.pPlayerBaseParam],y
  334  34:9A76  0A                asl a
  335  34:9A77  0A                asl a
  336  34:9A78  A8                tay
  337  34:9A79  A2 FC             ldx #$fc
  338  34:9A7B            .load_loop:
  339  34:9A7B  B9 21 9B                  lda .jobCommandList,y
  340  34:9A7E  9D 04 73                  sta .commandIdList - $fc,x
  341  34:9A81  C8                        iny
  342  34:9A82  E8                        inx
  343  34:9A83  D0 F6                     bne .load_loop
  344  34:9A85  20 54 97          jsr initTileArrayStorage
  345                     ;.counter = $2d
  346  34:9A88  86 38             stx <.emptyCount
  347                             ;stx <.counter
  348  34:9A8A  A9 FC             lda #$fc
  349  34:9A8C            .create_tiles:
  350  34:9A8C  48                        pha
  351  34:9A8D  A2 06                     ldx #.width
  352  34:9A8F  20 49 A5                  jsr initString
  353  34:9A92  68                        pla
  354  34:9A93  AA                        tax
  355  34:9A94  BD 04 73                  lda .commandIdList - $fc,x
  356  34:9A97  E8                        inx
  357                                     ;cmp #$ff
  358                                     ;bne .load_command_name
  359                                     ;       inc <.emptyCount
  360                                     ;       lda #0
  361  34:9A98                    .load_command_name:
  362                             
  363  34:9A98  A8                        tay
  364  34:9A99  8A                        txa
  365  34:9A9A  48                        pha
  366                                     INIT16 <$18,$8c40
       34:9A9B  A9 40             lda #LOW($8c40)
       34:9A9D  85 18             sta <$18
       34:9A9F  A9 8C             lda #HIGH($8c40)
       34:9AA1  85 19             sta <$18+1
  367  34:9AA3  98                        tya
  368           0001              .ifdef ENABLE_EXTRA_ABILITY
  369  34:9AA4  20 B0 9C                  jsr getExtraAbilityNameId
  370                             .endif
  371  34:9AA7  A2 01                     ldx #1
  372  34:9AA9  20 09 A6                  jsr loadString
  373  34:9AAC  A2 06                     ldx #.width
  374  34:9AAE  86 18                     stx <$18
  375  34:9AB0  20 6A 96                  jsr strToTileArray
  376  34:9AB3  A9 06                     lda #.width
  377  34:9AB5  20 58 A5                  jsr offsetTilePtr
  378                     
  379  34:9AB8  68                        pla     ;counter
  380  34:9AB9  D0 D1                     bne .create_tiles
  381  34:9ABB  A9 03             lda #($0a - (.width + 1))
  382  34:9ABD  85 18             sta <$18
  383  34:9ABF  A9 0A             lda #$0a
  384  34:9AC1  85 19             sta <$19
  385  34:9AC3  A9 03             lda #3
  386  34:9AC5  85 1A             sta <$1a
  387  34:9AC7  4C 38 8B          jmp draw8LineWindow
  388                     ;$9ae7:
  389                             .endif ;beta
  390                     ;------------------------------------------------------------------------------------------------------
  391                             ;FILEORG        $68b00
  392           8B00              .org    $8b00
  393  34:8B00            commandWindow_cursorPos:
  394           0020      .cursorX = ($50 - ($08 * COMMAND_WINDOW_WIDTH))
  395  34:8B00  A8 20                     .db     $a8, .cursorX
  396  34:8B02  B8 20                     .db     $b8, .cursorX
  397  34:8B04  C8 20                     .db     $c8, .cursorX
  398  34:8B06  D8 20                     .db     $d8, .cursorX
  399                             RESTORE_PC ff3_commandWindow_begin
                0000              .bank   BANK(ff3_commandWindow_begin)
                8000              .org    ff3_commandWindow_begin
#[3]   ff3_hack_master.asm
   35                     
#[4]   ff3_commands.asm
   36                                     .include "ff3_commands.asm"     ;saving a lot
    1                     ; ff3_commands.asm
    2                     ;
    3                     ; description:
    4                     ;       replaces command handlers
    5                     ;
    6                     ; version:
    7                     ;       0.05 (2006-11-07)
    8                     ;
    9                     ; note:
   10                     ;       'ff3_executeAction.asm' and 'ff3_command_window.asm' must be included before this file
   11                     ;======================================================================================================
   12  00:8000            ff3_commands_begin:
   13                     
   14                             INIT_PATCH $35,$a71c,$adaf
                0035              .bank   $35
                A71C              .org    $a71c
       35:A71C                    .ds             (($adaf) - ($a71c))
                A71C              .org    $a71c
   15                             ;INIT_PATCH $35,$a71c,$a7df
   16                             
   17                     DECLARE_COMMAND_VARS    .macro
   18                     .iPlayer = $52
   19                     .pBaseParam = $57
   20                     .pEquips = $59
   21                     .pBattleParam = $5b
   22                     .pTargetBase = $5d
   23                     .offset = $5f
   24                             .endm
   25                     
   26                     DECLARE_BATTLE_PTR      .macro
   27                     .pActor = $6e
   28                     .pTareget = $70
   29                             .endm
   30                     ;======================================================================================================
   31  35:A71C            selectSingleTargetAndSetYto2F:
   32                     ;out a : targetbit
   33                     ;out y : #2f
   34           00B3      .targetMode = $b3
   35           00B4      .selectedTarget = $b4
   36  35:A71C  A9 00             lda #0 ;single sel
   37  35:A71E  85 B3             sta <.targetMode
   38  35:A720  A9 10             lda #$10        ;select target
   39  35:A722  20 0E FA          jsr call_2e_9d53
   40  35:A725  20 94 9B          jsr setYtoOffset2F
   41  35:A728  A5 B4             lda <.selectedTarget
   42  35:A72A  60                rts
   43                     
   44  35:A72B            getPlayerLine:
   45           0059      .pEquips = $59
   46  35:A72B  A9 0F             lda #$0f
   47  35:A72D  20 88 9B          jsr setYtoOffsetOf
   48  35:A730  B1 59             lda [.pEquips],y
   49  35:A732  4A                lsr a
   50  35:A733  60                rts
   51                     
   52                     ;$35:a7cd initMoveArrowSprite
   53  35:A734            initMoveArrowSprite:
   54           0052      .iPlayer = $52
   55  35:A734  A9 00             lda #0
   56  35:A736  85 18             sta <$18
   57  35:A738  20 DF 8A          jsr clearSprites2x2     ;$8adf
   58  35:A73B  A9 5D             lda #$5d        ;arrow
   59  35:A73D  8D 21 02          sta $0221       ;sprite.tileIndex
   60  35:A740  A5 52             lda <.iPlayer
   61  35:A742  0A                asl a
   62  35:A743  0A                asl a
   63  35:A744  60                rts
   64                     ;------------------------------------------------------------------------------------------------------
   65                     ;ぜんしん(02)
   66                     ;$35:a71c commandWindow_OnForwardSelected
   67  35:A745            commandWindow_OnForward:
   68                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
   69  35:A745  20 2B A7          jsr getPlayerLine
   70  35:A748  90 66             bcc commandWindow_beepAndCancel
   71  35:A74A            .ok:
   72  35:A74A  20 34 A7          jsr initMoveArrowSprite
   73  35:A74D  AA                tax
   74                     
   75  35:A74E  A9 80             lda #$80 ;rightkey
   76  35:A750  48                pha ;sta $18
   77  35:A751  A0 43             ldy #$43 ;sta $0222
   78                     
   79  35:A753  A9 02             lda #$02
   80  35:A755  D0 12             bne commandWindow_setupMove
   81                     ;$a750:
   82                     
   83                     ;command 03
   84                     ;$35:a750 commandWindow_OnBack
   85  35:A757            commandWindow_OnBack:
   86                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
   87                     
   88  35:A757  20 2B A7          jsr getPlayerLine
   89  35:A75A  B0 54             bcs commandWindow_beepAndCancel
   90                     
   91  35:A75C  20 34 A7          jsr initMoveArrowSprite
   92  35:A75F  18                clc
   93  35:A760  69 02             adc #2
   94  35:A762  AA                tax
   95                     
   96  35:A763  A9 40             lda #$40 ;left
   97  35:A765  48                pha
   98  35:A766  A0 03             ldy #$03 ;sta $0222
   99  35:A768  98                tya
  100                     
  101                     ;fall through
  102  35:A769            commandWindow_setupMove:
  103  35:A769  85 19             sta <$19
  104                     
  105  35:A76B  BD 13 A8          lda commandWindow_arrowCoords,x
  106  35:A76E  8D 20 02          sta $0220       ;y
  107  35:A771  BD 14 A8          lda commandWindow_arrowCoords+1,x
  108  35:A774  8D 23 02          sta $0223       ;x
  109                     
  110                     ;$35:a784 showArrowAndDecideCommand
  111  35:A777            showArrowAndDecide:
  112                     ;[in] y : spriteFlag
  113                     ;[in] sp+0 : cancelKey
  114           78BA      .beginningFlag = $78ba
  115           0018      .cancelKey = $18
  116           0019      .commandId = $19
  117  35:A777  AD BA 78          lda .beginningFlag
  118  35:A77A  29 08             and #$08
  119  35:A77C  F0 0E             beq .normal
  120                     ;backattack!
  121  35:A77E  98                        tya
  122  35:A77F  49 40                     eor #$40
  123  35:A781  A8                        tay
  124  35:A782  BD 24 A8                  lda commandWindow_arrowCoords_backattack+1,x
  125  35:A785  8D 23 02                  sta $0223
  126                                     
  127  35:A788  68                        pla ;cancel key
  128  35:A789  49 C0                     eor #%11000000  ;$80 => 40 / 40 => 80
  129  35:A78B  48                        pha
  130  35:A78C            .normal:
  131  35:A78C  8C 22 02          sty $0222
  132  35:A78F  68                pla     ;cancel key
  133  35:A790  85 18             sta <.cancelKey
  134  35:A792            .get_input:     ;$a7a4:
  135  35:A792  20 85 81                  jsr presentCharacter
  136  35:A795  20 AA FB                  jsr getPad1Input
  137  35:A798  A5 12                     lda <inputBits
  138  35:A79A  F0 F6                     beq .get_input
  139                                     
  140  35:A79C  AA                        tax
  141  35:A79D  4A                        lsr a
  142  35:A79E  B0 09                     bcs .OnA
  143  35:A7A0  4A                        lsr a
  144  35:A7A1  B0 10                     bcs commandWindow_cancelReturn
  145  35:A7A3  E4 18                     cpx <.cancelKey
  146  35:A7A5  D0 EB                     bne .get_input
  147  35:A7A7  F0 0A                     beq commandWindow_cancelReturn
  148  35:A7A9            .OnA:
  149  35:A7A9  20 7D 9B          jsr requestSoundEffect05
  150  35:A7AC  A6 19             ldx <.commandId
  151  35:A7AE  D0 27             bne commandWindow_decideReturn
  152  35:A7B0            commandWindow_beepAndCancel:
  153  35:A7B0  20 81 9B          jsr requestSoundEffect06
  154  35:A7B3            commandWindow_nop:
  155  35:A7B3            commandWindow_cancelReturn:
  156  35:A7B3  A9 01             lda #1
  157  35:A7B5  60                rts
  158  35:A7B6            commandWindow_decideToTargetAll:
  159                     ;x = commandId
  160  35:A7B6  20 94 9B          jsr setYtoOffset2F
  161  35:A7B9  A9 C0             lda #$c0        ;target flag
  162  35:A7BB  85 B5             sta <$b5
  163  35:A7BD  A9 FF             lda #$ff        ;target bit
  164  35:A7BF  D0 0F             bne commandWindow_setTargetAndCommand
  165                     ;------------------------------------------------------------------------------------------------------
  166                     ;//04:たたかう
  167                     ;$35:a843 commandWindow_OnFight
  168                     ;       .org $a843
  169                     ;commandWindow_OnFight:
  170                     ;       lda #$04
  171                     ;       ;fall through
  172  35:A7C1            commandWindow_OnFight:
  173  35:A7C1            commandWindow_selectSingleTargetAndNext:
  174                     ;[in] u8 x : commandId
  175           00B4      .selectedTarget = $b4
  176  35:A7C1  8A                txa
  177  35:A7C2  48                pha
  178  35:A7C3  20 1C A7          jsr selectSingleTargetAndSetYto2F
  179  35:A7C6  D0 04             bne .ok
  180  35:A7C8  68                        pla
  181  35:A7C9  A9 01                     lda #1
  182  35:A7CB  60                        rts
  183  35:A7CC            .ok:
  184  35:A7CC  68                pla
  185  35:A7CD  AA                tax
  186  35:A7CE  A5 B4             lda <.selectedTarget
  187                             ;fall through
  188  35:A7D0            commandWindow_setTargetAndCommand:
  189                     ;[in] u8 a : targetBit
  190                     ;[in] u8 x : commandId
  191                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
  192           00B5      .targetFlag = $b5
  193  35:A7D0  91 5B             sta [.pBattleParam],y   ;2f
  194                                     
  195  35:A7D2  C8                iny
  196  35:A7D3  A5 B5             lda <.targetFlag
  197  35:A7D5  91 5B             sta [.pBattleParam],y   ;30
  198                             ;fall through
  199  35:A7D7            commandWindow_decideReturn:
  200                     ;[in] u8 X : commandId
  201                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
  202                     
  203                             ;pha    ;commandId
  204  35:A7D7  20 9B 9B          jsr setYtoOffset2E      ;9b9b
  205                             ;pla
  206  35:A7DA  8A                txa
  207  35:A7DB  91 5B             sta [.pBattleParam],y
  208  35:A7DD  E6 52             inc <.iPlayer
  209  35:A7DF  A9 01             lda #1
  210  35:A7E1  60                rts
  211                     ;------------------------------------------------------------------------------------------------------
  212                     ;//05:ぼうぎょ
  213                     ;$35:a877 commandWindow_OnGuard
  214                     ;commandWindow_OnGuard:
  215                     ;       lda #$05
  216                     ;       bne commandWindow_decideReturn
  217           A7D7      commandWindow_OnGuard = commandWindow_decideReturn
  218                     ;------------------------------------------------------------------------------------------------------
  219                     ;//06:にげる
  220                     ;$35:a8ab commandWindow_OnEscapeSelected
  221                     ;       .org $a8ab
  222                     ;commandWindow_OnEscape:
  223                     ;       lda #$06
  224                     ;       bne commandWindow_decideReturn
  225           A7D7      commandWindow_OnEscape = commandWindow_decideReturn
  226                     ;------------------------------------------------------------------------------------------------------
  227                     ;//07:とんずら
  228                     ;$35:a8b5 commandWindow_OnSneakAway
  229                     ;commandWindow_OnSneakAway:
  230                     ;       lda #$07
  231                     ;       bne commandWindow_decideReturn
  232           A7D7      commandWindow_OnSneakAway = commandWindow_decideReturn
  233                     ;------------------------------------------------------------------------------------------------------
  234                     ;//08:ジャンプ
  235                     ;$35:a9ab commandWindow_OnJump
  236                     ;       .org $a9ab
  237  35:A7E2            commandWindow_OnJump:
  238           00B4      .selectedTarget = $b4
  239           00B5      .targetFlag = $b5
  240  35:A7E2  20 1C A7          jsr selectSingleTargetAndSetYto2F
  241  35:A7E5  F0 CC             beq commandWindow_cancelReturn
  242  35:A7E7  A5 B5             lda <.targetFlag
  243  35:A7E9  10 F7             bpl commandWindow_OnJump
  244                             
  245  35:A7EB  A2 08             ldx #$08
  246  35:A7ED  D0 E1             bne commandWindow_setTargetAndCommand
  247                     ;------------------------------------------------------------------------------------------------------
  248                     ;//0d:みやぶる
  249                     ;$35:ab07 commandWindow_OnDetect
  250                     ;       .org $ab07
  251                     ;commandWindow_OnDetect:
  252                     ;       lda #$0d
  253                     ;       bne commandWindow_selectSingleTargetAndNext
  254           A7C1      commandWindow_OnDetect = commandWindow_selectSingleTargetAndNext
  255                     ;------------------------------------------------------------------------------------------------------
  256                     ;//0c:しらべる
  257                     ;$35:ab6e commandWindow_OnInspect
  258                     ;       .org $ab6e
  259                     ;commandWindow_OnInspect:
  260                     ;       lda #$0c
  261                     ;       bne commandWindow_selectSingleTargetAndNext
  262           A7C1      commandWindow_OnInspect = commandWindow_selectSingleTargetAndNext
  263                     ;------------------------------------------------------------------------------------------------------
  264                     ;//0E:ぬすむ
  265                     ;$35:ab9f commandWindow_OnSteal
  266                     ;       .org $ab9f
  267                     ;commandWindow_OnSteal:
  268                     ;       lda #$0e
  269                     ;       bne commandWindow_selectSingleTargetAndNext
  270           A7C1      commandWindow_OnSteal = commandWindow_selectSingleTargetAndNext
  271                     ;------------------------------------------------------------------------------------------------------
  272                     ;//0F:ためる
  273                     ;$35:ac65 commandWindow_OnChargeSelected
  274                     ;       .org $ac65
  275                     ;commandWindow_OnCharge:
  276                     ;       lda #$0f
  277                     ;       bne commandWindow_decideReturn
  278           A7D7      commandWindow_OnCharge = commandWindow_decideReturn
  279                     ;------------------------------------------------------------------------------------------------------
  280                     ;//10:うたう
  281                     ;$35:acd0 commandWindow_OnSing  
  282                     ;       .org $acd0
  283                     ;commandWindow_OnSing:
  284                     ;       lda #$10
  285                     ;       bne commandWindow_selectSingleTargetAndNext
  286           A7C1      commandWindow_OnSing = commandWindow_selectSingleTargetAndNext
  287                     ;------------------------------------------------------------------------------------------------------
  288                     ;//11:おどかす
  289                     ;$35:ad0c commandWindow_OnIntimidate    
  290                     ;       .org $ad0c
  291                     ;commandWindow_OnIntimidate:
  292                     ;       lda #$11
  293                     ;       bne commandWindow_decideReturn
  294           A7D7      commandWindow_OnIntimidate = commandWindow_decideReturn
  295                     ;------------------------------------------------------------------------------------------------------
  296                     ;//12:おうえん
  297                     ;$35:ad6b commandWindow_OnCheer
  298                     ;       .org $ad6b
  299                     ;commandWindow_OnCheer:
  300                     ;       lda #$12
  301                     ;       bne commandWindow_decideReturn
  302           A7D7      commandWindow_OnCheer = commandWindow_decideReturn
  303                     ;------------------------------------------------------------------------------------------------------
  304                     ;//0b:ちけい
  305                     ;$35:aa22 commandWindow_0b
  306                     ;       .org $aa22
  307           0000              .ifdef EXTEND_GEOMANCE
  309                             .else
  310  35:A7EF            commandWindow_OnGeomance:
  311           007A      .geomanceTargetFlag = $7a;$35:ab06 .db $7a      //???
  312  35:A7EF  20 E9 A9          jsr getCurrentTerrain
  313  35:A7F2  AA                tax
  314  35:A7F3  E8                inx
  315                     
  316  35:A7F4  A9 7A             lda #.geomanceTargetFlag
  317  35:A7F6            .shift_loop:
  318  35:A7F6  0A                        asl a
  319  35:A7F7  CA                        dex
  320  35:A7F8  D0 FC                     bne .shift_loop
  321  35:A7FA  90 0A             bcc .target_all
  322  35:A7FC  20 2A 80                  jsr dispatchBattleFunction_06   ;802a
  323  35:A7FF  AE 99 7E                  ldx $7e99
  324  35:A802  A9 80                     lda #$80
  325  35:A804  30 03                     bmi .store
  326  35:A806            .target_all:
  327  35:A806  CA                        dex
  328  35:A807  A9 C0                     lda #$c0
  329  35:A809            .store:
  330           00B5      .targetFlag = $b5
  331  35:A809  85 B5             sta <.targetFlag
  332  35:A80B  20 94 9B          jsr setYtoOffset2F
  333  35:A80E  8A                txa
  334  35:A80F  A2 0B             ldx #$0b
  335  35:A811  D0 BD             bne commandWindow_setTargetAndCommand
  336                             .endif  ;EXTEND_GEOMANCE
  337                     ;======================================================================================================
  338                     ;a823
  339  35:A813            commandWindow_arrowCoords:
  340  35:A813  34 B4 34          .db $34,$B4,$34,$D4, $50,$B4,$50,$D4, $6C,$B4,$6C,$D4, $88,$B4,$88,$D4
       35:A816  D4 50 B4  
       35:A819  50 D4 6C  
       35:A81C  B4 6C D4  
       35:A81F  88 B4 88  
       35:A822  D4        
  341                     ;a833
  342  35:A823            commandWindow_arrowCoords_backattack:
  343  35:A823  34 44 34          .db $34,$44,$34,$24, $50,$44,$50,$24, $6C,$44,$6C,$24, $88,$44,$88,$24
       35:A826  24 50 44  
       35:A829  50 24 6C  
       35:A82C  44 6C 24  
       35:A82F  88 44 88  
       35:A832  24        
  344                     ;$a7df:
  345                     ;======================================================================================================
  346                     ;//02:ぜんしん
  347                     ;$35:a7df command_forward
  348                     ;       .org $a7df
  349  35:A833            command_forward:
  350                     ;       ldx #$39+$02
  351                     ;       bne command_move
  352  35:A833            command_back:
  353                     ;       ldx #$39+$03
  354  35:A833            command_move:
  355                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
  356           006E      .pActor = $6e
  357                     
  358  35:A833  A0 33             ldy #$33
  359  35:A835  B1 6E             lda [.pActor],y
  360  35:A837  49 01             eor #$01        ;invert line flag
  361  35:A839  91 6E             sta [.pActor],y
  362  35:A83B  20 5B A8          jsr getPlayerOffsetFromActor
  363  35:A83E  18                clc
  364  35:A83F  69 0F             adc #$0f
  365  35:A841  A8                tay
  366  35:A842  B1 59             lda [.pEquips],y
  367  35:A844  49 01             eor #$01
  368  35:A846  91 59             sta [.pEquips],y
  369                             ;fall through
  370  35:A848            setupNullTargetActionType01:
  371                     ;[in] x : actionId * 2
  372  35:A848  A9 FF             lda #$ff
  373  35:A84A  8D D8 78          sta targetName  ;78d8
  374                             ;fall through
  375  35:A84D            setupActionType01:
  376                     ;[in] x : actionId * 2
  377  35:A84D  8A                txa
  378  35:A84E  4A                lsr a
  379  35:A84F  18                clc
  380  35:A850  69 39             adc #$39        ;convert actionid to actionNameId
  381  35:A852  8D D7 78          sta actionName  ;78d7
  382  35:A855  A9 01             lda #1
  383  35:A857  8D D5 78          sta battleProcessType
  384  35:A85A  60                rts
  385                     ;$a816:
  386  35:A85B            getPlayerOffsetFromActor:
  387                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
  388  35:A85B  20 2E A4          jsr getActor2C
  389  35:A85E  29 07             and #7
  390  35:A860  85 52             sta <.iPlayer
  391  35:A862  4C 41 A5          jmp getPlayerOffset
  392                     
  393                     ;$a881
  394                     ;$35:a881 command_guard
  395  35:A865            command_guard:
  396                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
  397           006E      .pActor = $6e
  398  35:A865  20 48 A8          jsr setupNullTargetActionType01
  399                     
  400  35:A868  20 A6 9F          jsr setXtoActorIndex
  401  35:A86B  A0 23             ldy #$23
  402  35:A86D  B1 6E             lda [.pActor],y
  403  35:A86F  9D E4 7C          sta $7ce4,x
  404  35:A872  10 04             bpl .def_under_80
  405  35:A874  A9 FF                     lda #$ff
  406  35:A876  D0 01                     bne .store
  407  35:A878            .def_under_80:
  408  35:A878  0A                        asl a
  409  35:A879            .store:
  410  35:A879  91 6E             sta [.pActor],y
  411  35:A87B  60                rts
  412                     ;======================================================================================================
  413                     ;$35:a8bf command_escape //06
  414  35:A87C            command_escape:
  415                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
  416           006E      .pActor = $6e
  417           0024      .rate = $24
  418                             ;ldx #$39+$06
  419  35:A87C  20 48 A8          jsr setupNullTargetActionType01
  420                             
  421  35:A87F  A9 64             lda #100
  422  35:A881  20 64 A5          jsr getSys1Random
  423  35:A884  48                pha     ;rand
  424                             
  425  35:A885  20 2E A4          jsr getActor2C
  426  35:A888  30 5E             bmi command_escape_enemy
  427  35:A88A            .actor_is_player:
  428           0024      .pEnemy = $24
  429  35:A88A  A2 00             ldx #0
  430  35:A88C  8A                txa
  431  35:A88D  A8                tay
  432  35:A88E  86 18             stx <$18
  433  35:A890  86 19             stx <$19
  434  35:A892  86 1A             stx <$1a
  435  35:A894  86 1B             stx <$1b
  436                             INIT16 <.pEnemy,$7835
       35:A896  A9 35             lda #LOW($7835)
       35:A898  85 24             sta <.pEnemy
       35:A89A  A9 78             lda #HIGH($7835)
       35:A89C  85 25             sta <.pEnemy+1
  437  35:A89E  A2 07             ldx #7
  438  35:A8A0            .sum_enemy_lv:
  439  35:A8A0  BD A7 7D                  lda $7da7,x     ;group
  440  35:A8A3  30 0F                     bmi .next
  441  35:A8A5  18                                clc
  442  35:A8A6  B1 24                             lda [.pEnemy],y
  443  35:A8A8  65 18                             adc <$18
  444  35:A8AA  85 18                             sta <$18
  445  35:A8AC  A9 00                             lda #0
  446  35:A8AE  65 19                             adc <$19
  447  35:A8B0  85 19                             sta <$19
  448  35:A8B2  E6 1A                             inc <$1a
  449  35:A8B4                    .next:
  450                                     SUB16 <.pEnemy,$0040
       35:A8B4  A5 24             lda <.pEnemy
       35:A8B6  38                sec
       35:A8B7  E9 40             sbc #LOW($0040)
       35:A8B9  85 24             sta <.pEnemy
       35:A8BB  A5 25             lda <.pEnemy+1
       35:A8BD  E9 00             sbc #HIGH($0040)
       35:A8BF  85 25             sta <.pEnemy+1
  451  35:A8C1  CA                        dex
  452  35:A8C2  10 DC                     bpl .sum_enemy_lv
  453                     
  454  35:A8C4  20 92 FC          jsr div_16
  455  35:A8C7  A0 2A             ldy #$2a
  456  35:A8C9  B1 6E             lda [.pActor],y
  457  35:A8CB  18                clc
  458  35:A8CC  69 19             adc #25
  459  35:A8CE  38                sec
  460  35:A8CF  E5 1C             sbc <$1c        ;average lv of enemies
  461  35:A8D1  B0 02             bcs .rate_plus
  462  35:A8D3  A9 00                     lda #0
  463  35:A8D5            .rate_plus:
  464           78BA      .beginningMode = $78ba
  465  35:A8D5  85 24             sta <.rate
  466  35:A8D7  68                pla     ;rand
  467  35:A8D8  C5 24             cmp <.rate
  468  35:A8DA  90 30             bcc command_escape_possible
  469  35:A8DC  AD BA 78          lda .beginningMode
  470  35:A8DF  4A                lsr a   ;party surprise attack
  471  35:A8E0  B0 2A             bcs command_escape_possible
  472                     ;.fail:
  473  35:A8E2            command_escape_fail:
  474  35:A8E2  A9 1F             lda #$1f        ;"にげられない！"
  475  35:A8E4  8D DA 78          sta battleMessages
  476  35:A8E7  60                rts
  477                     ;enemy:
  478                     ;a978
  479  35:A8E8            command_escape_enemy:
  480           006E      .pActor = $6e
  481  35:A8E8  68                pla     ;rand
  482  35:A8E9  A0 22             ldy #$22
  483  35:A8EB  D1 6E             cmp [.pActor],y
  484  35:A8ED  B0 F3             bcs command_escape_fail
  485                     
  486  35:A8EF  A9 1E             lda #$1e
  487  35:A8F1  8D DA 78          sta battleMessages
  488  35:A8F4  20 A6 9F          jsr setXtoActorIndex
  489  35:A8F7  A9 00             lda #0
  490  35:A8F9  20 20 FD          jsr flagTargetBit
  491  35:A8FC  48                pha ;sta $78d4
  492  35:A8FD  8A                txa
  493  35:A8FE  0A                asl a
  494  35:A8FF  AA                tax
  495  35:A900  B5 F0             lda <$f0,x
  496  35:A902  09 80             ora #$80
  497  35:A904  95 F0             sta <$f0,x
  498                             ;rts
  499  35:A906  68                pla
  500  35:A907  D0 23             bne command_escape_succeeded
  501                     ;//07
  502                     ;$35:a93b command_sneakAway     //[sneak away]
  503  35:A909            command_sneakAway:
  504                             ;ldx #$39+$07
  505  35:A909  20 48 A8          jsr setupNullTargetActionType01
  506  35:A90C            command_escape_possible:
  507                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
  508                     
  509  35:A90C  AD D8 7E          lda battleMode  ;7ed8
  510  35:A90F  4A                lsr a   ;escape forbidden flag
  511  35:A910  B0 D0             bcs command_escape_fail
  512                     
  513  35:A912  A2 03             ldx #3
  514  35:A914            .check_confused_member:
  515  35:A914  86 52                     stx <.iPlayer
  516  35:A916  20 41 A5                  jsr getPlayerOffset
  517  35:A919  A8                        tay
  518  35:A91A  C8                        iny
  519  35:A91B  C8                        iny
  520  35:A91C  B1 5B                     lda [.pBattleParam],y
  521  35:A91E  29 20                     and #$20
  522  35:A920  D0 C0                     bne command_escape_fail
  523  35:A922  CA                        dex
  524  35:A923  10 EF                     bpl .check_confused_member
  525                     ;ok
  526  35:A925  A9 02             lda #2
  527  35:A927  8D D3 78          sta $78d3
  528  35:A92A  A9 F0             lda #$f0
  529  35:A92C            command_escape_succeeded:
  530  35:A92C  8D D4 78          sta $78d4
  531  35:A92F  A9 1E             lda #$1e        ;"にげだした････"
  532  35:A931  8D DA 78          sta battleMessages
  533  35:A934  60                rts
  534                     ;======================================================================================================
  535                     ;$a9d8
  536                     ;$35:a9d8 command_jump
  537  35:A935            command_jump:
  538                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
  539           006E      .pActor = $6e
  540                             ;ldx #$39+$08
  541  35:A935  20 4D A8          jsr setupActionType01
  542                     
  543  35:A938  A0 01             ldy #$01
  544  35:A93A  B1 6E             lda [.pActor],y
  545  35:A93C  29 28             and #$28
  546  35:A93E  F0 08             beq .ok
  547                     ;fail
  548  35:A940  A9 18                     lda #$18
  549  35:A942  8D C2 7E                  sta effectHandlerIndex
  550  35:A945  4C 58 AA                  jmp command_setNoEffectAndReturn
  551  35:A948            .ok:
  552                     ;$a9f6:
  553  35:A948  A0 27             ldy #$27
  554  35:A94A  A9 02             lda #2
  555  35:A94C  91 6E             sta [.pActor],y ;charge count
  556  35:A94E  20 A6 9F          jsr setXtoActorIndex
  557  35:A951  0A                asl a
  558  35:A952  AA                tax
  559  35:A953  E8                inx
  560  35:A954  B5 F0             lda <$f0,x
  561  35:A956  09 01             ora #$01
  562  35:A958  95 F0             sta <$f0,x
  563  35:A95A  C8                iny
  564  35:A95B  C8                iny
  565  35:A95C  A9 09             lda #$09
  566  35:A95E  91 6E             sta [.pActor],y ;2e
  567  35:A960  60                rts
  568                     ;
  569                     ;$35:aa11 command_09 //landing
  570  35:A961            command_land:
  571           006E      .pActor = $6e
  572  35:A961  A0 02             ldy #2
  573  35:A963  B1 6E             lda [.pActor],y
  574  35:A965  29 FE             and #$fe
  575  35:A967  91 6E             sta [.pActor],y
  576  35:A969  A0 27             ldy #$27
  577  35:A96B  A9 02             lda #2
  578  35:A96D  91 6E             sta [.pActor],y
  579  35:A96F  4C 1E 80          jmp dispatchBattleFunction_03   ;801e
  580                     ;$aa22:
  581                     ;======================================================================================================
  582                     
  583                     ;$aa5d:
  584                     ;$35:aa5d command_0b
  585                     
  586                     
  587           0000              .ifdef EXTEND_GEOMANCE
  675                             .else ;EXTEND_GEOMANCE
  676                     
  677  35:A972            command_geomance:
  678                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
  679           006E      .pActor = $6e
  680  35:A972  20 2E A4          jsr getActor2C
  681  35:A975  09 10             ora #$10
  682  35:A977  91 6E             sta [.pActor],y
  683  35:A979  20 E9 A9          jsr getCurrentTerrain   ;aac3
  684  35:A97C  18                clc
  685  35:A97D  69 50             adc #$50
  686                     
  687                             .endif ;EXTEND_GEOMANCE
  688                     
  689  35:A97F  A0 2E             ldy #$2e
  690  35:A981  91 6E             sta [.pActor],y
  691  35:A983  85 1A             sta <$1a
  692           0001              .ifdef BOOST_GEOMANCER
  693  35:A985  A0 00                     ldy #$0
  694  35:A987  B1 6E                     lda [.pActor],y
  695  35:A989  48                        pha
  696  35:A98A  A0 0F                     ldy #$0f
  697  35:A98C  18                        clc
  698  35:A98D  71 6E                     adc [.pActor],y
  699  35:A98F  A0 00                     ldy #0
  700  35:A991  91 6E                     sta [.pActor],y
  701  35:A993  20 67 A3                  jsr command_magic
  702  35:A996  68                        pla
  703  35:A997  A0 00                     ldy #$0
  704  35:A999  91 6E                     sta [.pActor],y
  705                             .else
  707                             .endif  ;BOOST_GEOMANCER
  708  35:A99B  E6 CC             inc <$cc
  709  35:A99D  A9 14             lda #$14
  710  35:A99F  8D C2 7E          sta effectHandlerIndex
  711                             
  712  35:A9A2  AD 9B 7E          lda play_effectTargetBits       ;7e9b
  713  35:A9A5  D0 41             bne command_doReturn
  714                     ;failed. nature bites player
  715  35:A9A7  A9 03             lda #3
  716  35:A9A9  85 54             sta <$54
  717                     ;$aac3:
  718  35:A9AB            damageActorByQuoterHalf:
  719                     ;[out] x : cacheIndex
  720           0018      .maxhp = $18
  721           006E      .pActor = $6e
  722           00F0      .actorStatusCache = $f0
  723  35:A9AB  20 A6 9F          jsr setXtoActorIndex
  724  35:A9AE  0A                asl a
  725  35:A9AF  AA                tax
  726                     
  727  35:A9B0  A0 05             ldy #5
  728  35:A9B2  B1 6E             lda [.pActor],y
  729  35:A9B4  9D 5F 7E          sta $7e5f,x
  730  35:A9B7  C8                iny
  731  35:A9B8  B1 6E             lda [.pActor],y
  732  35:A9BA  4A                lsr a
  733  35:A9BB  7E 5F 7E          ror $7e5f,x
  734  35:A9BE  4A                lsr a
  735  35:A9BF  9D 60 7E          sta $7e60,x
  736  35:A9C2  7E 5F 7E          ror $7e5f,x
  737                     
  738  35:A9C5  A0 03             ldy #3
  739  35:A9C7  38                sec
  740  35:A9C8  B1 6E             lda [.pActor],y
  741  35:A9CA  FD 5F 7E          sbc $7e5f,x
  742  35:A9CD  91 6E             sta [.pActor],y
  743  35:A9CF  C8                iny
  744  35:A9D0  B1 6E             lda [.pActor],y
  745  35:A9D2  FD 60 7E          sbc $7e60,x
  746  35:A9D5  91 6E             sta [.pActor],y
  747  35:A9D7  88                dey
  748  35:A9D8  11 6E             ora [.pActor],y
  749  35:A9DA  F0 02             beq .result_dead
  750  35:A9DC  B0 0A             bcs .finish
  751  35:A9DE            .result_dead:
  752  35:A9DE  A9 80                     lda #$80
  753  35:A9E0  95 F0                     sta <.actorStatusCache,x
  754  35:A9E2  0A                        asl a
  755  35:A9E3  91 6E                     sta [.pActor],y
  756  35:A9E5  C8                        iny
  757  35:A9E6  91 6E                     sta [.pActor],y
  758  35:A9E8            .finish:
  759  35:A9E8            command_doReturn:
  760  35:A9E8  60                rts
  761                     ;$35:aac3 getCurrentTerrain
  762  35:A9E9            getCurrentTerrain:
  763  35:A9E9  AD E3 7C          lda $7ce3
  764  35:A9EC  C9 08             cmp #$08
  765  35:A9EE  90 2F             bcc .finish
  766  35:A9F0  C9 12                     cmp #$12
  767  35:A9F2  D0 03                     bne .load_param
  768                                             ;lda #$55
  769  35:A9F4  A9 05                             lda #$05
  770  35:A9F6  60                                rts
  771  35:A9F7                    .load_param:
  772  35:A9F7  18                        clc
  773  35:A9F8  AD C8 74                  lda $74c8       ;field $48
  774  35:A9FB  69 4E                     adc #$4e
  775  35:A9FD  85 46                     sta <$46
  776  35:A9FF  A9 00                     lda #0
  777  35:AA01  69 A2                     adc #$a2
  778  35:AA03  85 47                     sta <$47
  779                                     
  780  35:AA05  A9 1A                     lda #$1a        
  781  35:AA07  85 4A                     sta <$4a        ;bank
  782  35:AA09  A9 01                     lda #1
  783  35:AA0B  85 4B                     sta <$4b        ;size
  784  35:AA0D  A9 00                     lda #0
  785  35:AA0F  20 DC FD                  jsr copyTo7400
  786                     
  787  35:AA12  AE 00 74                  ldx $7400
  788  35:AA15  AD D8 7E                  lda battleMode  ;$7ed8
  789  35:AA18  29 08                     and #8
  790                     
  791  35:AA1A  D0 04                     bne .use_high
  792  35:AA1C  8A                                txa
  793  35:AA1D  29 0F                             and #$0f
  794  35:AA1F                    .finish:
  795  35:AA1F  60                                rts
  796  35:AA20                    .use_high:
  797  35:AA20  8A                        txa
  798  35:AA21  4C 45 FD                  jmp $fd45       ;a>>4
  799                     ;$35:ab06 .db $7a       //???
  800                     ;======================================================================================================
  801                     ;setEffectHandlerTo18 = $ab66
  802                     ;$35:ab0c command_detect
  803  35:AA24            command_detect:
  804           0070      .pTarget = $70
  805                             ;ldx #$39+$0d
  806  35:AA24  20 7A AA          jsr setupNoMotionType01
  807                     
  808  35:AA27  A0 01             ldy #1
  809  35:AA29  B1 70             lda [.pTarget],y
  810  35:AA2B  30 2B             bmi command_setNoEffectAndReturn
  811  35:AA2D            .ok:
  812                     ;$ab27:
  813           0018      .count = $18
  814  35:AA2D  A0 12             ldy #$12
  815  35:AA2F  B1 70             lda [.pTarget],y
  816                     
  817  35:AA31  A0 00             ldy #0
  818  35:AA33  AE EE 78          ldx battleMessageCount
  819  35:AA36  84 18             sty <.count
  820  35:AA38            .queue_weak_points:
  821  35:AA38  0A                        asl a
  822  35:AA39  90 0E                     bcc .next
  823  35:AA3B  E6 18                             inc <.count
  824  35:AA3D  48                                pha
  825  35:AA3E  98                                tya
  826                                             ;clc (always set)
  827  35:AA3F  69 47                             adc #$47
  828  35:AA41  9D DA 78                          sta battleMessages,x
  829  35:AA44  68                                pla
  830  35:AA45  E8                                inx
  831  35:AA46  8E EE 78                          stx battleMessageCount
  832  35:AA49                    .next:
  833  35:AA49  C8                        iny
  834  35:AA4A  C0 07                     cpy #7
  835  35:AA4C  D0 EA                     bne .queue_weak_points
  836  35:AA4E  A5 18             lda <.count
  837  35:AA50  D0 05             bne .finish
  838  35:AA52  A9 43                     lda #$43
  839  35:AA54  9D DA 78                  sta battleMessages,x
  840  35:AA57            .finish:
  841  35:AA57  60                rts
  842                     
  843  35:AA58            command_setNoEffectAndReturn:
  844  35:AA58  A2 3B             ldx #$3b
  845  35:AA5A  8E DA 78          stx battleMessages
  846  35:AA5D  60                rts
  847                     ;======================================================================================================
  848                     ;$35:ab73 command_inspect
  849  35:AA5E            command_inspect:
  850           0070      .pTarget = $70
  851                             ;jsr setEffectHandlerTo18
  852  35:AA5E  A0 06             ldy #6
  853  35:AA60  A2 03             ldx #3
  854  35:AA62            .copy_hp:
  855  35:AA62  B1 70                     lda [.pTarget],y
  856  35:AA64  9D E4 78                  sta $78e4,x
  857  35:AA67  88                        dey
  858  35:AA68  CA                        dex
  859  35:AA69  10 F7                     bpl .copy_hp
  860                             
  861  35:AA6B  A0 01             ldy #1
  862  35:AA6D  A2 3F             ldx #$3f
  863  35:AA6F  B1 70             lda [.pTarget],y
  864  35:AA71  10 02             bpl .ok
  865  35:AA73  A2 3B                     ldx #$3b
  866  35:AA75            .ok:
  867  35:AA75  8E DA 78          stx battleMessages
  868  35:AA78  A2 18             ldx #$0c*2
  869                             ;fall through
  870  35:AA7A            setupNoMotionType01:
  871                     ;[in] x : actionId * 2 (initial value on handler entry)
  872  35:AA7A  20 4D A8          jsr setupActionType01
  873  35:AA7D            setEffectHandlerTo18    ;18=do nothing
  874  35:AA7D  A9 18             lda #$18
  875  35:AA7F  8D C2 7E          sta effectHandlerIndex
  876  35:AA82  E6 CC             inc <$cc
  877  35:AA84  60                rts
  878                     ;======================================================================================================
  879                     ;$35:aba4 command_steal
  880  35:AA85            command_steal:
  881           006E      .pActor = $6e
  882           0070      .pTarget = $70
  883                             ;ldx #$39+$0E
  884  35:AA85  20 7A AA          jsr setupNoMotionType01
  885                     
  886  35:AA88  A0 2C             ldy #$2c
  887  35:AA8A  B1 70             lda [.pTarget],y
  888  35:AA8C  30 06             bmi .target_is_enemy
  889  35:AA8E            .fail:
  890  35:AA8E  A9 35                     lda #$35 ;"ぬすみそこなった"
  891  35:AA90  8D DA 78                  sta battleMessages
  892  35:AA93  60                        rts
  893  35:AA94            .target_is_enemy:
  894  35:AA94  A0 01             ldy #1
  895  35:AA96  B1 70             lda [.pTarget],y
  896  35:AA98  29 E8             and #$e8
  897  35:AA9A  D0 F2             bne .fail
  898                     
  899           0024      .rate = $24
  900  35:AA9C  18                clc
  901  35:AA9D  88                dey
  902  35:AA9E  B1 6E             lda [.pActor],y
  903  35:AAA0  A0 0F             ldy #$0f
  904  35:AAA2  71 6E             adc [.pActor],y
  905  35:AAA4  85 24             sta <.rate
  906  35:AAA6  A9 FF             lda #$ff
  907  35:AAA8  20 64 A5          jsr getSys1Random
  908  35:AAAB  C5 24             cmp <.rate
  909  35:AAAD  B0 DF             bcs .fail
  910                     
  911           0018      .dropTableIndex = $18
  912  35:AAAF  A0 36             ldy #$36
  913  35:AAB1  B1 70             lda [.pTarget],y
  914  35:AAB3  29 1F             and #$1f
  915  35:AAB5  85 18             sta <.dropTableIndex
  916                             ;
  917  35:AAB7  A9 08             lda #$08
  918  35:AAB9  85 1A             sta <$1a
  919                             INIT16 <$20,$9b80
       35:AABB  A9 80             lda #LOW($9b80)
       35:AABD  85 20             sta <$20
       35:AABF  A9 9B             lda #HIGH($9b80)
       35:AAC1  85 21             sta <$20+1
  920  35:AAC3  A9 08             lda #$08
  921  35:AAC5  A2 00             ldx #$00
  922  35:AAC7  A0 1A             ldy #$1a
  923  35:AAC9  20 A6 FD          jsr loadTo7400Ex
  924           7400      .dropList = $7400
  925  35:AACC  A9 FF             lda #$ff
  926  35:AACE  20 64 A5          jsr getSys1Random
  927  35:AAD1  A2 03             ldx #3
  928  35:AAD3            .get_index:
  929  35:AAD3  DD 16 AB                  cmp .bounds,x
  930  35:AAD6  B0 03                     bcs .found_index
  931  35:AAD8  CA                        dex
  932  35:AAD9  10 F8                     bpl .get_index
  933  35:AADB            .found_index:
  934  35:AADB  BD 00 74          lda .dropList,x
  935  35:AADE  A8                tay
  936  35:AADF  F0 AD             beq .fail
  937                     
  938  35:AAE1  20 09 AB          jsr .findItem
  939  35:AAE4  30 07             bmi .put_drop
  940  35:AAE6  A9 00             lda #0
  941  35:AAE8  20 09 AB          jsr .findItem
  942  35:AAEB  10 A1             bpl .fail
  943  35:AAED            .put_drop:
  944  35:AAED  FE 01 60          inc backpackItems-$c0+1,x
  945  35:AAF0  BD 01 60          lda backpackItems-$c0+1,x
  946  35:AAF3  C9 64             cmp #100
  947  35:AAF5  90 05             bcc .store_id
  948  35:AAF7  A9 63                     lda #99
  949  35:AAF9  9D 01 60                  sta backpackItems-$c0+1,x
  950  35:AAFC            .store_id:
  951  35:AAFC  98                tya     ;itemid
  952  35:AAFD  9D 00 60          sta backpackItems-$c0,x
  953  35:AB00            .finish:
  954  35:AB00  8D E4 78          sta $78e4
  955  35:AB03  A9 29             lda #$29
  956  35:AB05  8D DA 78          sta battleMessages
  957  35:AB08  60                rts
  958  35:AB09            .findItem:
  959                     ;[in] a : itemid to find
  960  35:AB09  A2 C0             ldx #$c0
  961  35:AB0B            .find_loop:
  962  35:AB0B  DD 00 60                  cmp backpackItems-$c0,x
  963  35:AB0E  F0 04                     beq .found
  964  35:AB10  E8                        inx
  965  35:AB11  E8                        inx
  966  35:AB12  D0 F7                     bne .find_loop
  967  35:AB14            .found:
  968  35:AB14  8A                txa
  969  35:AB15  60                rts
  970  35:AB16            .bounds:
  971  35:AB16  00 30 60          .db $00,$30,$60,$90
       35:AB19  90        
  972                     ;$ac65
  973                     ;======================================================================================================
  974                     ;$35:ac6f command_charge //0F
  975  35:AB1A            command_charge:
  976           006E      .pActor = $6e
  977                             ;ldx #$39+$0f
  978  35:AB1A  20 4D A8          jsr setupActionType01
  979                     
  980  35:AB1D  A2 3B             ldx #$3b ;"こうかがなかった"
  981  35:AB1F  A0 01             ldy #1
  982  35:AB21  B1 6E             lda [.pActor],y
  983  35:AB23  29 28             and #$28
  984  35:AB25  D0 3B             bne .fail
  985  35:AB27  A0 27                     ldy #$27
  986  35:AB29  B1 6E                     lda [.pActor],y
  987  35:AB2B  AA                        tax
  988  35:AB2C  E8                        inx
  989  35:AB2D  E0 03                     cpx #3
  990  35:AB2F  B0 09                     bcs .bomb
  991                                     ;ok
  992  35:AB31  8A                                txa
  993  35:AB32  91 6E                             sta [.pActor],y
  994  35:AB34  A9 00                             lda #0
  995  35:AB36  8D 93 7E                          sta $7e93
  996  35:AB39  60                                rts
  997  35:AB3A            .bomb:
  998                                     ;bomb
  999  35:AB3A  A9 00                     lda #0
 1000  35:AB3C  91 6E                     sta [.pActor],y
 1001  35:AB3E  A0 04                     ldy #4
 1002  35:AB40  B1 6E                     lda [.pActor],y
 1003  35:AB42  4A                        lsr a
 1004  35:AB43  91 6E                     sta [.pActor],y
 1005  35:AB45  88                        dey
 1006  35:AB46  B1 6E                     lda [.pActor],y
 1007  35:AB48  6A                        ror a
 1008  35:AB49  91 6E                     sta [.pActor],y
 1009  35:AB4B  C8                        iny
 1010  35:AB4C  11 6E                     ora [.pActor],y
 1011  35:AB4E  D0 0B                     bne .bomb_alive
 1012  35:AB50  20 A6 9F                          jsr setXtoActorIndex
 1013  35:AB53  0A                                asl a
 1014  35:AB54  AA                                tax
 1015  35:AB55  B5 F0                             lda <$f0,x
 1016  35:AB57  09 80                             ora #$80
 1017  35:AB59  95 F0                             sta <$f0,x
 1018  35:AB5B                    .bomb_alive:
 1019  35:AB5B  A9 01                     lda #1
 1020  35:AB5D  8D 93 7E                  sta $7e93
 1021  35:AB60  A2 2F                     ldx #$2f        ;"ためすぎてじばくした!"
 1022  35:AB62            .fail:
 1023  35:AB62  8E DA 78          stx battleMessages
 1024  35:AB65  60                rts
 1025                     ;======================================================================================================
 1026                     ;$35:acd5 command_sing
 1027  35:AB66            command_sing:
 1028           006E      .pActor = $6e
 1029                     ;竪琴チェック オリジナルは装備欄のIDによる
 1030  35:AB66  A0 31             ldy #$31
 1031  35:AB68  B1 6E             lda [.pActor],y
 1032  35:AB6A  C8                iny
 1033  35:AB6B  11 6E             ora [.pActor],y
 1034  35:AB6D  29 08             and #$08        ;harp
 1035  35:AB6F  F0 03             beq .fail
 1036  35:AB71  4C 04 A1                  jmp command_fight
 1037  35:AB74            .fail:
 1038  35:AB74  A9 01             lda #1
 1039  35:AB76  8D D5 78          sta battleProcessType
 1040  35:AB79  A9 42             lda #$42        ;"たてごとがないのでうたえない"
 1041  35:AB7B  8D DA 78          sta battleMessages
 1042  35:AB7E  A9 18             lda #$18
 1043  35:AB80  8D C2 7E          sta effectHandlerIndex
 1044  35:AB83  60                rts
 1045                     ;======================================================================================================
 1046                     ;$35:ad16 command_intimidate
 1047  35:AB84            command_intimidate:
 1048                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
 1049                     
 1050  35:AB84  AD D8 7E          lda battleMode
 1051  35:AB87  4A                lsr a   ;escape forbidden
 1052  35:AB88  90 03             bcc .ok
 1053  35:AB8A  4C 58 AA                  jmp command_setNoEffectAndReturn
 1054  35:AB8D            .ok:
 1055  35:AB8D  A0 00             ldy #0
 1056                             
 1057           0001              .ifdef BOOST_INTIMIDATE
 1058  35:AB8F  A2 07                     ldx #7
 1059  35:AB91                    .set_lv:
 1060  35:AB91  B1 5D                             lda [.pTargetBase],y
 1061  35:AB93  4A                                lsr a
 1062  35:AB94  91 5D                             sta [.pTargetBase],y
 1063  35:AB96  4A                                lsr a
 1064  35:AB97  18                                clc
 1065  35:AB98  71 5D                             adc [.pTargetBase],y
 1066  35:AB9A  91 5D                             sta [.pTargetBase],y
 1067                                             ADD16 <.pTargetBase,$0040
       35:AB9C  A5 5D             lda <.pTargetBase
       35:AB9E  18                clc
       35:AB9F  69 40             adc #LOW($0040)
       35:ABA1  85 5D             sta <.pTargetBase
       35:ABA3  A5 5E             lda <.pTargetBase+1
       35:ABA5  69 00             adc #HIGH($0040)
       35:ABA7  85 5E             sta <.pTargetBase+1
 1068  35:ABA9  CA                                dex
 1069  35:ABAA  10 E5                             bpl .set_lv
 1070                             .else
 1085                             .endif  ;BOOST_INTIMIDATE
 1086                             
 1087                             INIT16 <.pTargetBase,$7675
       35:ABAC  A9 75             lda #LOW($7675)
       35:ABAE  85 5D             sta <.pTargetBase
       35:ABB0  A9 76             lda #HIGH($7675)
       35:ABB2  85 5E             sta <.pTargetBase+1
 1088  35:ABB4  A9 32             lda #$32
 1089  35:ABB6  8D DA 78          sta battleMessages
 1090  35:ABB9  A9 FF             lda #$ff
 1091  35:ABBB  8D D8 78          sta targetName  ;$78d8
 1092                             ;ldx #$39+$11
 1093  35:ABBE  A2 22             ldx #$11*2
 1094  35:ABC0  4C 4D A8          jmp setupActionType01
 1095                     
 1096                     ;$ad6b:
 1097                     ;}
 1098                     ;======================================================================================================
 1099                     ;$35:ad75 command_cheer
 1100  35:ABC3            command_cheer:
 1101                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
 1102  35:ABC3  A2 03             ldx #3
 1103  35:ABC5            .for_each_player:
 1104  35:ABC5  86 52                     stx <.iPlayer
 1105  35:ABC7  20 41 A5                  jsr getPlayerOffset
 1106  35:ABCA  18                        clc
 1107           0001              .ifdef BOOST_CHEER
 1108  35:ABCB  69 38                     adc #$38        ;bonus atk
 1109  35:ABCD  A8                        tay
 1110  35:ABCE  B1 5B                     lda [.pBattleParam],y
 1111  35:ABD0  18                        clc
 1112  35:ABD1  69 20                     adc #$20
 1113  35:ABD3  90 05                     bcc .next
 1114  35:ABD5  A9 FF                             lda #$ff
 1115  35:ABD7  8D D8 78                          sta targetName
 1116                             .else
 1125                             .endif  ;BOOST_CHEER
 1126  35:ABDA                    .next:
 1127  35:ABDA  91 5B                     sta [.pBattleParam],y
 1128  35:ABDC  CA                        dex
 1129  35:ABDD  10 E6                     bpl .for_each_player
 1130  35:ABDF  A2 31             ldx #$31
 1131  35:ABE1  8E DA 78          stx battleMessages
 1132                             ;ldx #$39+$12
 1133  35:ABE4  A2 24             ldx #$12*2
 1134  35:ABE6  4C 4D A8          jmp setupActionType01
 1135                     
 1136  35:ABE9            ff3_commands_end:
 1137                     ;======================================================================================================
 1138                     ;       RESTORE_PC ff3_commands_begin
#[3]   ff3_hack_master.asm
#[4]   ff3_command_ex.asm
   37                                     .include "ff3_command_ex.asm"; consume( infoWindow_free, calc_player_param_free )
    1                     ; ff3_command_ex.asm
    2                     ;
    3                     ; description:
    4                     ;       replaces originally unimplemented command ($0a)
    5                     ;       implements 'extra ability' feature
    6                     ;
    7                     ; version:
    8                     ;       0.05 (2006-10-29)
    9                     ;======================================================================================================
   10  35:ABE9            ff3_command_ex_begin:
   11                     ;replace tables
   12                     ;$34:9b21(file:69b31) actionId jobActionLists[4][22]
   13                             FILEORG $69b21
                0034              .bank   ($69b21) >> 13
                9B21              .org    ($8000 | (($69b21) & $7fff))
   14  34:9B21                    job_commands:
   15  34:9B21  04 05 06                  .db             $04,$05,$06,$14 ;00 onion
       34:9B24  14        
   16  34:9B25  04 05 06                  .db             $04,$05,$06,$14 ;01 fighter
       34:9B28  14        
   17  34:9B29  04 05 06                  .db             $04,$05,$06,$14 ;02 monk
       34:9B2C  14        
   18  34:9B2D  04 15 06                  .db             $04,$15,$06,$14 ;03 priest (white
       34:9B30  14        
   19  34:9B31  04 15 06                  .db             $04,$15,$06,$14 ;04 mage (black
       34:9B34  14        
   20  34:9B35  04 15 06                  .db             $04,$15,$06,$14 ;05 red
       34:9B38  14        
   21           0001              .ifdef GIVE_HUNTER_DISORDERED_SHOT
   22  34:9B39  04 17 15                          .db             $04,$17,$15,$14
       34:9B3C  14        
   23                             .else
   25                             .endif ;GIVE_HUNTER_DISORDERED_SHOT
   26  34:9B3D  04 05 06                  .db             $04,$05,$06,$14 ;07
       34:9B40  14        
   27  34:9B41  04 0E 07                  .db             $04,$0E,$07,$14 ;08
       34:9B44  14        
   28  34:9B45  04 0C 0D                  .db             $04,$0C,$0D,$14 ;09
       34:9B48  14        
   29  34:9B49  04 0B 05                  .db             $04,$0B,$05,$14 ;0a
       34:9B4C  14        
   30  34:9B4D  04 08 05                  .db             $04,$08,$05,$14 ;0b
       34:9B50  14        
   31           0001              .ifdef GIVE_VIKING_PROVOKE
   32  34:9B51  04 16 05                          .db             $04,$16,$05,$14 ;0c viking
       34:9B54  14        
   33                             .else
   35                             .endif  
   36  34:9B55  04 0F 05                  .db             $04,$0F,$05,$14 ;0d     martialist
       34:9B58  14        
   37           0001              .ifdef GIVE_EVILSWORDMAN_ABYSS
   38  34:9B59  04 18 15                  .db             $04,$18,$15,$14 ;0e
       34:9B5C  14        
   39                             .else
   41                             .endif
   42  34:9B5D  04 15 06                  .db             $04,$15,$06,$14 ;0f
       34:9B60  14        
   43  34:9B61  10 11 12                  .db             $10,$11,$12,$14 ;10     bard
       34:9B64  14        
   44  34:9B65  04 15 06                  .db             $04,$15,$06,$14 ;11
       34:9B68  14        
   45  34:9B69  04 15 06                  .db             $04,$15,$06,$14 ;12
       34:9B6C  14        
   46  34:9B6D  04 15 06                  .db             $04,$15,$06,$14 ;13
       34:9B70  14        
   47  34:9B71  04 15 06                  .db             $04,$15,$06,$14 ;14 sage
       34:9B74  14        
   48  34:9B75  04 05 06                  .db             $04,$05,$06,$14 ;15 ninja
       34:9B78  14        
   49                     ;------------------------------------------------------------------------------------------------------
   50           0001              .ifdef GIVE_VIKING_PROVOKE
   51                                     FILEORG $73b1a + ($0c * 5 + 4)  ;viking job param +04 (actionJobExp)
                0039              .bank   ($73b1a + ($0c * 5 + 4)) >> 13
                BB5A              .org    ($8000 | (($73b1a + ($0c * 5 + 4)) & $7fff))
   52  39:BB5A                            jobParams_viking_04:
   53  39:BB5A  FA                                .db %11111010   ;12 12 8 8
   54                             .endif  ;provoke
   55                                     
   56           0001              .ifdef GIVE_HUNTER_DISORDERED_SHOT
   57           BB3C                              .org    $bb1a + ($06 * 5 + 4)
   58  39:BB3C                            jobParams_hunter_04:
   59  39:BB3C  F9                                .db %11111001   ;12 12 8 4 ; original = $d9 (%11011001)
   60                             .endif  ;disordered_shot
   61                             
   62           0001              .ifdef GIVE_EVILSWORDMAN_ABYSS
   63           BB64                              .org    $bb1a + ($0e * 5 + 4)
   64  39:BB64  F9                                .db %11111001   ;12 12 8 4; original = $d9
   65                             .endif  ;abyss
   66                     ;======================================================================================================
   67                             RESTORE_PC infoWindow_free_begin
                0034              .bank   BANK(infoWindow_free_begin)
                9CAC              .org    infoWindow_free_begin
   68                     
   69  34:9CAC            extraAbilityNameIds:
   70  34:9CAC  0A                .db $0a
   71  34:9CAD  5A                .db EXMSG_DISORDERED_SHOT
   72  34:9CAE  5B                .db EXMSG_ABYSS
   73  34:9CAF  5C                .db EXMSG_STAND_READY
   74                     
   75  34:9CB0            getExtraAbilityNameId:
   76                     ;[in] u8 a : actionId
   77  34:9CB0  C9 16             cmp #CMDX_ID_BEGIN
   78  34:9CB2  90 04             bcc .normal_command
   79  34:9CB4  AA                        tax
   80  34:9CB5  BD 96 9C                  lda extraAbilityNameIds-CMDX_ID_BEGIN,x
   81  34:9CB8            .normal_command
   82  34:9CB8  60                rts
   83                     
   84                     
   85           0001              .ifdef FAST_DISORDERED_SHOT
   86                     ;v0.6.1
   87  34:9CB9            setIndexAndCallPresentScene:
   88           0052      .iPlayer = $52
   89  34:9CB9  48                pha
   90  34:9CBA  20 A6 9F          jsr setXtoActorIndex
   91  34:9CBD  86 52             stx <.iPlayer
   92  34:9CBF  68                pla
   93  34:9CC0  4C 0E FA          jmp call_2e_9d53
   94                             .endif ;FAST_DISORDERED_SHOT
   95                     ;======================================================================================================
   96                             RESTORE_PC calc_player_param_free_begin
                0031              .bank   BANK(calc_player_param_free_begin)
                AAB0              .org    calc_player_param_free_begin
   97  31:AAB0            extraAbilityFlags:
   98  31:AAB0  00                .db $00
   99  31:AAB1  00                .db $00
  100  31:AAB2  80                .db $80 ;monk
  101  31:AAB3  00                .db $00
  102  31:AAB4  00                .db $00
  103  31:AAB5  00                .db $00
  104  31:AAB6  00                .db $00 ;hunter
  105  31:AAB7  20                .db $20 ;knight
  106  31:AAB8  00                .db $00
  107  31:AAB9  40                .db $40 ;scholar
  108  31:AABA  00 00 00          .db $00,$00,$00,$00,$00,$00
       31:AABD  00 00 00  
  109  31:AAC0  00 00 00          .db $00,$00,$00
  110  31:AAC3  10                .db $10 ;summoner
  111  31:AAC4  10                .db $10 ;sage
  112  31:AAC5  00                .db     $00     ;ninja
  113                     ;======================================================================================================
  114                             RESTORE_PC ff3_command_ex_begin
                0035              .bank   BANK(ff3_command_ex_begin)
                ABE9              .org    ff3_command_ex_begin
#[3]   ff3_hack_master.asm
   38                     
#[4]   ff3_item_window.asm
   39                                     .include "ff3_item_window.asm"  ;save
    1                     ; ff3_item_window.asm
    2                     ;
    3                     ; description:
    4                     ;       replaces entire item-window related codes
    5                     ;
    6                     ; version:
    7                     ;       0.11 (2006-10-29)
    8                     ;
    9                     ;======================================================================================================
   10  35:ABE9            ff3_itemWindow_begin:
   11                     
   12           ADAF      item_window_patch_begin = $adaf ;commandWindow_OnItemSelected
   13           B646      item_window_patch_end   = $b646 ;commandWindow_OnMagicSelected
   14                     
   15                             INIT_PATCH $35,item_window_patch_begin,item_window_patch_end
                0035              .bank   $35
                ADAF              .org    item_window_patch_begin
       35:ADAF                    .ds             ((item_window_patch_end) - (item_window_patch_begin))
                ADAF              .org    item_window_patch_begin
   16           ABE9              .org ff3_itemWindow_begin
   17                             ORIGINAL_ADDR item_window_patch_begin
   18                     ;----------------------------------------------------------------------------------------------------------     
   19                     ;global vars
   20                     ;shared with command window
   21           0052      iPlayer                 = $52   ;
   22           0059      pEquips                 = $59   ;
   23           005B      pPlayer                 = $5b   ;
   24           78CF      selectedAction  = $78cf ;
   25           7CE8      doesDrawActionName = $7ce8
   26                     ;------------------------------------------------------------------------------
   27           0062      row                             = $62
   28           0063      col                             = $63
   29           0066      windowLeft              = $66
   30           0067      mode                    = $67
   31           0068      lastRow                 = $68
   32           0069      lastCol                 = $69
   33           60C0      backpackItems   = $60c0
   34           7AF5      cachedItems             = $7af5
   35           7B3D      equipFlags              = $7b3d 
   36                     ;------------------------------------------------------------------------------
   37                     ;
   38           003E      removeId                = $3e           ;address must be $3e
   39           003F      removeCount             = $3f
   40           0040      equipId                 = $40           ;address must be $40
   41           0041      equipCount              = $41
   42           0042      removeIndex             = $42
   43           0043      equipIndex              = $43
   44           0044      removeFlag              = $44
   45           0045      equipFlag               = $45
   46                     ;==========================================================================================================
   47                     ;$35:adaf commandWindow_OnItemSelected()
   48                     ;       [in,out] u8 $52 : playerIndex
   49                     ;uses:
   50                     ;       u8 $62 : cursor row index (0-3), init : 0
   51                     ;       u8 $63 : cursor col index (0-7), init : 1
   52                     ;       u8 $65 : background no (used in scrolling function), init : 0
   53                     ;       u8 $66 : current window left (col index,equipWindow = 0), init : 1
   54                     ;       u8 $67 : indicates Nth selection  (0-1)
   55                     ;       u8 $68 : row index of 1st selection 
   56                     ;       u8 $69 : col index of 1st selection
   57                     ;       u8 $7afd[0x40] : items {id,count}
   58                     ;       u8 $7b3d[0x40] : equipflags (0 = cannot use/equip,mark 'x' next to name)
   59                     ;commandWindow_OnItemSelected:
   60  35:ABE9            commandWindow_OnItem:
   61           0010      .scrollX = $10
   62           0043      .counter = $43
   63  35:ABE9  20 C5 F8          jsr updateDmaPpuScrollSyncNmi
   64  35:ABEC  A9 00             lda #0
   65  35:ABEE  85 3D             sta <$3d        ;erase flag
   66  35:ABF0  20 B0 8E          jsr eraseWindow
   67                     
   68  35:ABF3  A9 78             lda #$78
   69  35:ABF5  85 10             sta <.scrollX
   70  35:ABF7  20 C5 F8          jsr updateDmaPpuScrollSyncNmi
   71                             
   72  35:ABFA  A9 00             lda #0
   73  35:ABFC  8D 73 75          sta $7573       ;erase flag
   74  35:ABFF  20 33 B1          jsr drawEquipWindow
   75                     
   76  35:AC02  20 8D 9B          jsr setYtoOffset03
   77  35:AC05  A2 00             ldx #0
   78  35:AC07            .init_hands:
   79  35:AC07  B1 59             lda [pEquips],y
   80  35:AC09  9D F5 7A          sta $7af5,x
   81  35:AC0C  9D F7 7A          sta $7af7,x
   82  35:AC0F  C8                iny
   83  35:AC10  B1 59             lda [pEquips],y
   84  35:AC12  9D F6 7A          sta $7af6,x
   85  35:AC15  9D F8 7A          sta $7af8,x
   86  35:AC18  C8                iny
   87  35:AC19  E8                inx
   88  35:AC1A  E8                inx
   89  35:AC1B  E8                inx
   90  35:AC1C  E8                inx
   91  35:AC1D  E0 08             cpx #8
   92  35:AC1F  D0 E6             bne .init_hands
   93                             
   94  35:AC21  A2 23             ldx #$23
   95  35:AC23  A9 01             lda #1
   96  35:AC25            .init_flags:
   97  35:AC25  9D 3D 7B          sta equipFlags,x
   98  35:AC28  CA                dex
   99  35:AC29  10 FA             bpl .init_flags 
  100                             
  101  35:AC2B  E8                inx     ;0
  102  35:AC2C            .init_items:
  103  35:AC2C  A9 00                     lda #0
  104  35:AC2E  85 20                     sta <$20
  105  35:AC30  A9 94                     lda #$94
  106  35:AC32  85 21                     sta <$21
  107  35:AC34  86 43                     stx <.counter
  108  35:AC36  BD C1 60                  lda backpackItems+1,x   ;count
  109  35:AC39  9D FE 7A                  sta cachedItems+9,x
  110  35:AC3C  BD C0 60                  lda backpackItems,x             ;id
  111  35:AC3F  9D FD 7A                  sta cachedItems+8,x
  112                                     
  113  35:AC42  C9 62                     cmp #$62        ;leather cap
  114  35:AC44  90 0A                     bcc .check_equip_valid_for_job
  115  35:AC46  C9 98                     cmp #$98        ;magical key
  116  35:AC48  90 0F                     bcc .cannot_use
  117  35:AC4A  C9 C8                     cmp #$c8        ;magic 'flare'
  118  35:AC4C  B0 0B                     bcs .cannot_use
  119  35:AC4E  90 10                     bcc .next
  120  35:AC50                    .check_equip_valid_for_job:
  121                                             ;weapon or shield
  122  35:AC50  85 18                             sta <$18
  123  35:AC52  20 1C B5                          jsr isPlayerAllowedToUseItem    ;$b8fd
  124  35:AC55  A5 1C                             lda <$1c
  125  35:AC57  D0 07                             bne .next
  126  35:AC59                    .cannot_use:    
  127  35:AC59  A5 43                     lda <.counter
  128  35:AC5B  4A                        lsr a
  129  35:AC5C  AA                        tax
  130  35:AC5D  DE 41 7B                  dec equipFlags+4,x
  131  35:AC60                    .next:
  132  35:AC60  A6 43                     ldx <.counter
  133  35:AC62  E8                        inx
  134  35:AC63  E8                        inx
  135  35:AC64  E0 40                     cpx #$40
  136  35:AC66  D0 C4                     bne .init_items
  137                             
  138  35:AC68  A2 00             ldx #0
  139  35:AC6A  86 3D             stx <$3d
  140  35:AC6C            .init_window:
  141  35:AC6C  86 43             stx <.counter
  142  35:AC6E  20 9F B1          jsr loadTileArrayForItemWindowColumn
  143  35:AC71  A6 43             ldx <.counter
  144  35:AC73  BD 40 AD          lda initWindowParams,x
  145  35:AC76  85 18             sta <$18
  146  35:AC78  E8                inx
  147  35:AC79  BD 40 AD          lda initWindowParams,x
  148  35:AC7C  85 19             sta <$19
  149  35:AC7E  E8                inx
  150  35:AC7F  BD 40 AD          lda initWindowParams,x
  151  35:AC82  85 1A             sta <$1a
  152  35:AC84  E8                inx
  153  35:AC85  86 43             stx <.counter
  154  35:AC87  20 38 8B          jsr draw8LineWindow
  155  35:AC8A  A6 43             ldx <.counter
  156  35:AC8C  E0 09             cpx #$9
  157  35:AC8E  D0 DC             bne .init_window
  158                             
  159  35:AC90  A9 02             lda #2
  160  35:AC92  85 55             sta <$55
  161  35:AC94  A9 01             lda #1
  162  35:AC96  85 1A             sta <$1a
  163  35:AC98  20 66 89          jsr loadCursor
  164                             
  165  35:AC9B  A9 01             lda #1
  166  35:AC9D  85 1A             sta <$1a
  167  35:AC9F  A9 F0             lda #$f0
  168  35:ACA1  85 1C             sta <$1c
  169  35:ACA3  85 1D             sta <$1d
  170  35:ACA5  20 2E 89          jsr tileSprites2x2
  171                             
  172  35:ACA8  A9 02             lda #2
  173  35:ACAA  85 55             sta <$55
  174  35:ACAC  A9 00             lda #0
  175  35:ACAE  85 1A             sta <$1a
  176  35:ACB0  20 66 89          jsr loadCursor
  177                     
  178  35:ACB3  A2 00             ldx #0
  179  35:ACB5  86 62             stx <$62        ;row
  180                             ;stx <$65       ;scroll toggle
  181  35:ACB7  86 67             stx <$67        ;mode
  182  35:ACB9  E8                inx
  183  35:ACBA  86 63             stx <$63        ;col
  184  35:ACBC  86 66             stx <$66        ;left
  185                     
  186  35:ACBE            itemWindowInputLoop:
  187  35:ACBE  20 85 81          jsr presentCharacter
  188  35:ACC1  20 AA FB          jsr getPad1Input
  189  35:ACC4  A5 12             lda <inputBits
  190  35:ACC6  F0 F6             beq itemWindowInputLoop
  191  35:ACC8  48                pha
  192  35:ACC9  20 79 9B          jsr requestSoundEffect18        ;9b79
  193  35:ACCC  68                pla
  194                     ;itemWindow_dispatchInput:
  195  35:ACCD  A6 63                     ldx <col
  196  35:ACCF  A4 62                     ldy <row
  197  35:ACD1  0A                        asl a
  198  35:ACD2  B0 4A                     bcs .OnRight
  199  35:ACD4  0A                        asl a
  200  35:ACD5  B0 30                     bcs .OnLeft
  201  35:ACD7  0A                        asl a
  202  35:ACD8  B0 1D                     bcs .OnDown
  203  35:ACDA  0A                        asl a
  204  35:ACDB  B0 0D                     bcs .OnUp
  205  35:ACDD  0A                        asl a
  206                                     ;bcs start
  207  35:ACDE  0A                        asl a
  208                                     ;bcs select
  209  35:ACDF  0A                        asl a
  210  35:ACE0  B0 05                     bcs .OnB
  211  35:ACE2  0A                        asl a
  212  35:ACE3  90 D9                     bcc itemWindowInputLoop ;($aeaa)
  213  35:ACE5            .OnA:
  214                                     ;jmp itemWindow_OnA
  215  35:ACE5  B0 62                     bcs itemWindow_OnA
  216  35:ACE7            .OnB:
  217  35:ACE7  4C FB AE                  jmp itemWindow_OnB
  218  35:ACEA            .OnUp:  
  219  35:ACEA  98                        tya
  220  35:ACEB  F0 D1                     beq itemWindowInputLoop ;($aeaa)
  221  35:ACED  E0 00                     cpx #$00
  222  35:ACEF  D0 03                     bne .nocheck_up
  223  35:ACF1  88                        dey
  224  35:ACF2  F0 CA                     beq itemWindowInputLoop
  225  35:ACF4                    .nocheck_up:
  226  35:ACF4  88                        dey
  227  35:ACF5  10 3D                     bpl .update             
  228  35:ACF7            .OnDown:
  229  35:ACF7  C0 03                     cpy #$03
  230  35:ACF9  F0 C3                     beq itemWindowInputLoop ;($aeaa)
  231  35:ACFB  E0 00                     cpx #$00
  232  35:ACFD  D0 05                     bne .nocheck_down
  233  35:ACFF  C8                        iny
  234  35:AD00  C0 04                     cpy #$04
  235  35:AD02  F0 BA                     beq itemWindowInputLoop ;($aeaa)
  236  35:AD04                    .nocheck_down:
  237  35:AD04  C8                        iny
  238  35:AD05  10 2D                     bpl .update
  239  35:AD07            .OnLeft:
  240  35:AD07  8A                        txa
  241  35:AD08  F0 B4                     beq itemWindowInputLoop
  242  35:AD0A  C5 66                     cmp <$66
  243  35:AD0C  D0 07                     bne .noscroll_left
  244  35:AD0E  20 66 B0                  jsr itemWindow_scrollLeft       ;$b362
  245  35:AD11  A6 63                     ldx <col
  246  35:AD13  A4 62                     ldy <row
  247  35:AD15                    .noscroll_left:
  248  35:AD15  CA                        dex
  249  35:AD16  D0 04                     bne .nocheck_left
  250  35:AD18  98                        tya
  251  35:AD19  09 01                     ora #1
  252  35:AD1B  A8                        tay
  253  35:AD1C                    .nocheck_left:
  254  35:AD1C  D0 16                     bne .update     
  255  35:AD1E            .OnRight:
  256  35:AD1E  E0 08                     cpx #$08
  257  35:AD20  F0 9C                     beq itemWindowInputLoop
  258  35:AD22  A5 66                     lda <$66
  259  35:AD24  C9 07                     cmp #$07
  260  35:AD26  F0 0B                     beq .noscroll_right
  261  35:AD28  C5 63                     cmp <col
  262  35:AD2A  F0 07                     beq .noscroll_right
  263  35:AD2C  20 3A B0                  jsr itemWindow_scrollRight      ;$b2a7
  264  35:AD2F  E6 63                     inc <col
  265  35:AD31  D0 07                     bne .moveOnly
  266  35:AD33                    .noscroll_right:
  267  35:AD33  E8                        inx
  268  35:AD34            .update:
  269  35:AD34  8A                        txa
  270  35:AD35  85 63                     sta <col
  271  35:AD37  98                        tya
  272  35:AD38  85 62                     sta <row
  273  35:AD3A            .moveOnly:
  274  35:AD3A  20 DE B1                  jsr itemWindow_moveCursor
  275  35:AD3D  4C BE AC                  jmp itemWindowInputLoop
  276                     ;----------------------------------------------------------------------------------------------------------
  277  35:AD40  10 1E 01  initWindowParams:       DB      $10,$1e,1,      $1f,$8d,0,      $8e,$9c,0
       35:AD43  1F 8D 00  
       35:AD46  8E 9C 00  
  278                     ;==========================================================================================================
  279                     ;itemWindow_OnA
  280                     ;------------------------------------------------------------------------------
  281                     ;       .org    $af4c
  282  35:AD49            itemWindow_OnA:
  283  35:AD49  A5 67             lda <mode
  284  35:AD4B  D0 29             bne .second_item
  285  35:AD4D  E6 67                     inc <mode
  286  35:AD4F  A5 62                     lda <row
  287  35:AD51  85 68                     sta <lastRow
  288  35:AD53  A5 63                     lda <col
  289  35:AD55  85 69                     sta <lastCol
  290  35:AD57  20 DE B1                  jsr itemWindow_moveCursor
  291  35:AD5A  A5 1D                     lda <$1d
  292  35:AD5C  18                        clc
  293  35:AD5D  69 04                     adc #4
  294  35:AD5F  85 1D                     sta <$1d
  295  35:AD61  A9 01                     lda #1
  296  35:AD63  85 1A                     sta <$1a
  297  35:AD65  20 2E 89                  jsr tileSprites2x2
  298  35:AD68  20 7D 9B                  jsr requestSoundEffect05        ;9b7d
  299  35:AD6B  A2 10                     ldx #$10
  300  35:AD6D            .present_loop:
  301  35:AD6D  20 85 81                          jsr presentCharacter
  302  35:AD70  CA                                dex
  303  35:AD71  D0 FA                             bne .present_loop
  304  35:AD73  4C BE AC                  jmp itemWindowInputLoop
  305  35:AD76            .second_item:
  306  35:AD76  A6 63             ldx <col
  307  35:AD78  A4 62             ldy <row
  308  35:AD7A  E4 69             cpx <lastCol
  309  35:AD7C  D0 07             bne .exchange_item
  310  35:AD7E  C4 68             cpy <lastRow
  311  35:AD80  D0 03             bne .exchange_item
  312  35:AD82  4C FA B1                  jmp itemWindow_OnUse
  313  35:AD85            .exchange_item:
  314  35:AD85  8A                txa
  315  35:AD86  D0 06             bne .check_lastcol
  316  35:AD88  A5 69             lda <lastCol
  317  35:AD8A  D0 0C             bne .exchange_ok
  318  35:AD8C  F0 04             beq .cannot_exchange
  319  35:AD8E            .check_lastcol:
  320  35:AD8E  A5 69             lda <lastCol
  321  35:AD90  F0 06             beq .exchange_ok
  322  35:AD92            .cannot_exchange:
  323  35:AD92  20 81 9B          jsr $9b81
  324  35:AD95  4C BE AC          jmp itemWindowInputLoop
  325  35:AD98            .exchange_ok:
  326  35:AD98  A9 00             lda #0
  327  35:AD9A  8D 08 74          sta $7408
  328  35:AD9D  A9 01             lda #1
  329  35:AD9F  8D 09 74          sta $7409
  330  35:ADA2  E4 69             cpx <lastCol
  331  35:ADA4  90 09             bcc .no_swap
  332  35:ADA6  20 22 AF                  jsr swap_current_and_last
  333  35:ADA9  EE 08 74                  inc $7408
  334  35:ADAC  CE 09 74                  dec $7409
  335  35:ADAF            .no_swap:
  336  35:ADAF  A5 69             lda <lastCol
  337  35:ADB1  0A                asl a
  338  35:ADB2  0A                asl a
  339  35:ADB3  18                clc             ;not neccesary
  340  35:ADB4  65 68             adc <lastRow
  341  35:ADB6  85 45             sta <equipFlag
  342  35:ADB8  0A                asl a
  343  35:ADB9  85 43             sta <equipIndex
  344  35:ADBB  A6 45             ldx <equipFlag
  345  35:ADBD  BD 3D 7B          lda equipFlags,x
  346  35:ADC0  D0 0E             bne .exchangeable
  347  35:ADC2            .fail:
  348  35:ADC2  20 81 9B                  jsr $9b81
  349  35:ADC5  AD 08 74                  lda $7408
  350  35:ADC8  F0 03                     beq .no_swap_restore
  351  35:ADCA  20 22 AF                          jsr swap_current_and_last
  352  35:ADCD            .no_swap_restore:
  353  35:ADCD  4C BE AC                  jmp itemWindowInputLoop
  354  35:ADD0            .exchangeable:
  355  35:ADD0  A6 43             ldx <equipIndex
  356  35:ADD2  BD F5 7A          lda cachedItems,x
  357  35:ADD5  B0 EB             bcs .fail
  358  35:ADD7  85 40             sta <equipId
  359  35:ADD9  E8                inx
  360  35:ADDA  BD F5 7A          lda cachedItems,x
  361  35:ADDD  85 41             sta <equipCount
  362                             
  363  35:ADDF  A5 63             lda <col
  364  35:ADE1  0A                asl a
  365  35:ADE2  0A                asl a
  366  35:ADE3  18                clc
  367  35:ADE4  65 62             adc <row
  368  35:ADE6  85 44             sta <removeFlag
  369  35:ADE8  0A                asl a
  370  35:ADE9  85 42             sta <removeIndex
  371                             
  372  35:ADEB  AA                tax
  373  35:ADEC  BD F5 7A          lda cachedItems,x
  374  35:ADEF  85 3E             sta <removeId
  375  35:ADF1  E8                inx
  376  35:ADF2  BD F5 7A          lda cachedItems,x
  377  35:ADF5  85 3F             sta <removeCount
  378                     
  379                             ;jsr $b242      ;checks 2-handed weapon?
  380  35:ADF7  20 05 B0          jsr isHandFreeForItem
  381  35:ADFA  B0 C6             bcs .fail
  382  35:ADFC  A5 40             lda <equipId
  383  35:ADFE  C5 3E             cmp <removeId
  384  35:AE00  D0 2C             bne .different_item
  385  35:AE02  C9 00                     cmp #0
  386  35:AE04  F0 BC                     beq .fail
  387  35:AE06  A9 00                     lda #0
  388  35:AE08  A6 42                     ldx <removeIndex
  389  35:AE0A  9D F5 7A                  sta cachedItems,x
  390  35:AE0D  E8                        inx
  391  35:AE0E  9D F5 7A                  sta cachedItems,x
  392  35:AE11  A6 44                     ldx <removeFlag
  393  35:AE13  A9 01                     lda #1
  394  35:AE15  9D 3D 7B                  sta equipFlags,x
  395  35:AE18  A6 43                     ldx <equipIndex
  396  35:AE1A  E8                        inx
  397  35:AE1B  18                        clc
  398  35:AE1C  A5 3F                     lda <removeCount
  399  35:AE1E  65 41                     adc <equipCount
  400  35:AE20  C9 64                     cmp #100
  401  35:AE22  90 02                     bcc .under_100
  402  35:AE24  A9 63                             lda #99
  403  35:AE26            .under_100:
  404  35:AE26  9D F5 7A                  sta cachedItems,x
  405  35:AE29  8A                        txa
  406  35:AE2A  48                        pha
  407  35:AE2B  4C 67 AE                  jmp .copyback    
  408  35:AE2E            .different_item:
  409  35:AE2E  A4 41             ldy <equipCount
  410  35:AE30  C9 00             cmp #0
  411  35:AE32  F0 2F             beq .pick_result_empty
  412  35:AE34  C9 4F             cmp #$4f        ;wooden arrow
  413  35:AE36  90 0C             bcc .not_arrow
  414  35:AE38  C9 57             cmp #$57        ;medusa arrow
  415  35:AE3A  B0 08             bcs .not_arrow
  416  35:AE3C            .arrow:
  417                             ;min(equipcount,20)
  418  35:AE3C  C0 15             cpy #21
  419  35:AE3E  90 23             bcc .pick_result_empty
  420  35:AE40  A0 14             ldy #20
  421  35:AE42  D0 06             bne .exchange
  422  35:AE44            .not_arrow:
  423  35:AE44  C0 01             cpy #1
  424  35:AE46  F0 1B             beq .pick_result_empty
  425  35:AE48  A0 01             ldy #1
  426  35:AE4A            .exchange:
  427  35:AE4A  A6 3E             ldx <removeId
  428  35:AE4C  F0 15             beq .pick_result_empty
  429           0025      .count = $25
  430  35:AE4E  84 25             sty <.count
  431  35:AE50  20 89 AF          jsr getIndexToPutRemovedItem
  432  35:AE53  90 03             bcc .can_put
  433  35:AE55  4C C2 AD          jmp .fail
  434  35:AE58            .can_put:       
  435  35:AE58  A5 40             lda <equipId
  436  35:AE5A  A4 25             ldy <.count
  437  35:AE5C  20 11 AF          jsr doExchange
  438  35:AE5F  48                pha     ;col index
  439  35:AE60  4C 67 AE          jmp .copyback
  440  35:AE63            .pick_result_empty:
  441                             ;here already a = equipid,y = count
  442  35:AE63  20 11 AF          jsr doExchange
  443  35:AE66  48                pha     ;col index
  444  35:AE67            .swap_flag:
  445           0000              .IFNDEF CONTINUE_ON_EQUIP_CHANGE
  456                             .ENDIF
  457                     ;here originally $b131          
  458                     ;       .org $b131
  459  35:AE67            .copyback:      
  460  35:AE67  A2 3F             ldx #$3f
  461  35:AE69                    .copyloop:
  462  35:AE69  BD FD 7A                  lda cachedItems+8,x
  463  35:AE6C  9D C0 60                  sta backpackItems,x
  464  35:AE6F  CA                        dex
  465  35:AE70  10 F7                     bpl .copyloop
  466                     
  467                     ;$b13e:         
  468  35:AE72  20 8D 9B          jsr $9b8d       ;set y to offset 3
  469  35:AE75  AD F7 7A          lda $7af7
  470  35:AE78  91 59             sta [pEquips],y
  471  35:AE7A  C8                iny
  472  35:AE7B  AD F8 7A          lda $7af8
  473  35:AE7E  91 59             sta [pEquips],y
  474  35:AE80  C8                iny
  475                             
  476  35:AE81  AD FB 7A          lda $7afb
  477  35:AE84  91 59             sta [pEquips],y
  478  35:AE86  C8                iny
  479  35:AE87  AD FC 7A          lda $7afc
  480  35:AE8A  91 59             sta [pEquips],y
  481  35:AE8C  C8                iny
  482  35:AE8D  20 7D 9B          jsr requestSoundEffect05
  483  35:AE90  AD 08 74          lda $7408
  484  35:AE93  F0 03             beq .no_swap_restore_req
  485  35:AE95  20 22 AF                  jsr swap_current_and_last
  486  35:AE98            .no_swap_restore_req:
  487  35:AE98  68                pla     ;updated col index
  488  35:AE99  4A                lsr a
  489  35:AE9A  4A                lsr a
  490  35:AE9B  4A                lsr a
  491  35:AE9C  48                pha
  492                             
  493  35:AE9D  A6 63             ldx <col
  494  35:AE9F  D0 10             bne .not_in_equipWindow
  495  35:AEA1  20 2E B1                  jsr drawEquipWindowNoErase      ;$35:b5f9
  496  35:AEA4  68                        pla
  497  35:AEA5  C9 03                     cmp #3
  498  35:AEA7  B0 27                     bcs .finish
  499  35:AEA9  AA                                tax
  500  35:AEAA  CA                                dex
  501  35:AEAB  20 94 B0                          jsr drawItemWindowColumn        ;subsituate jsr $b601
  502  35:AEAE  4C D0 AE                          jmp .finish     
  503  35:AEB1            .not_in_equipWindow:
  504  35:AEB1  CA                        dex     ;based equip-window => based item0
  505  35:AEB2  20 94 B0                  jsr drawItemWindowColumn
  506  35:AEB5  68                        pla
  507  35:AEB6  AA                        tax     ;updated col
  508  35:AEB7  18                        clc
  509  35:AEB8  69 02                     adc #2
  510  35:AEBA  38                        sec
  511  35:AEBB  E5 66                     sbc <windowLeft ;a = (col - 1) - left + 3
  512  35:AEBD  30 08                     bmi .check_equip_redraw ; (col + 2) - left < 0 : col < left - 2
  513  35:AEBF  C9 05                     cmp #5
  514  35:AEC1  B0 04                     bcs .check_equip_redraw ; col + 2 - left - 5 >= 0  col >= left + 3
  515  35:AEC3  CA                                dex     
  516  35:AEC4  20 94 B0                          jsr drawItemWindowColumn        ;subsituate jsr $b601
  517  35:AEC7                    .check_equip_redraw:
  518  35:AEC7  A5 63                     lda <col
  519  35:AEC9  C9 03                     cmp #3
  520  35:AECB  B0 03                     bcs .finish
  521  35:AECD  20 2E B1                          jsr drawEquipWindowNoErase
  522                     
  523  35:AED0            .finish:
  524  35:AED0  20 26 80          jsr dispatchBattleFunction_05   ;$8026 => recalcParams
  525           E000              .IF CONTINUE_ON_EQUIP_CHANGE
  526  35:AED3  4C FF AE                  jmp itemWindow_cancel2nd                        
  527                             .ENDIF  
  528                     
  529                     ; itemWindow_OnB will jump to here
  530  35:AED6            itemWindow_closeAndKeepCurrentPlayer:   
  531  35:AED6  C6 52             dec <iPlayer
  532                     ; useItem will jump to here
  533                     ;$b198
  534  35:AED8            closeItemWindow:
  535  35:AED8  20 B0 8E          jsr eraseWindow ;$34:8eb0();
  536  35:AEDB  A9 00             lda #0
  537  35:AEDD  85 10             sta <$10
  538  35:AEDF  A5 08             lda <$08
  539  35:AEE1  29 FE             and #$fe
  540  35:AEE3  85 08             sta <$08
  541  35:AEE5  20 C5 F8          jsr updateDmaPpuScrollSyncNmi ;$3f:f8c5();
  542  35:AEE8  A9 00             lda #0
  543  35:AEEA  85 18             sta <$18
  544  35:AEEC  20 DF 8A          jsr clearSprites2x2      ;
  545  35:AEEF  A9 01             lda #1
  546  35:AEF1  85 18             sta <$18
  547  35:AEF3  20 DF 8A          jsr clearSprites2x2
  548  35:AEF6  E6 52             inc <iPlayer
  549                             ;causes window-erase bug
  550                             ;$b1d0: dispatchBattleCommand(5); ;$34:8026();  
  551  35:AEF8  A9 00             lda #0
  552                             RET_TO_GET_COMMAND_INPUT
       35:AEFA  60                rts
  553                             ;jmp getCommandInput_next       ;$99fd
  554                     
  555                     ;$b198:
  556                     ;[in,out] u8 $67 : mode (0 = 1st,1=2nd selection)
  557  35:AEFB            itemWindow_OnB:
  558  35:AEFB  A5 67             lda <mode
  559  35:AEFD  F0 D7             beq itemWindow_closeAndKeepCurrentPlayer
  560  35:AEFF            itemWindow_cancel2nd:   
  561  35:AEFF  C6 67                     dec <mode
  562  35:AF01  A9 01                     lda #1
  563  35:AF03  85 1A                     sta <$1a
  564  35:AF05  A9 F0                     lda #$f0
  565  35:AF07  85 1C                     sta <$1c
  566  35:AF09  85 1D                     sta <$1d
  567  35:AF0B  20 2E 89                  jsr tileSprites2x2
  568  35:AF0E  4C BE AC                  jmp itemWindowInputLoop ;$aeaa
  569                     ;----------------------------------------------------------------------------------------------------------
  570                     ;utilities
  571  35:AF11            doExchange:
  572                     ;[in] y = counttopick, a = id
  573                     ;[out] a = offset to removed item's count
  574  35:AF11  20 37 AF          jsr pickAndEquipItem
  575  35:AF14  20 89 AF          jsr getIndexToPutRemovedItem
  576  35:AF17  B0 08             bcs .itemfull
  577  35:AF19  A5 3E             lda <removeId
  578  35:AF1B  A4 3F             ldy <removeCount
  579  35:AF1D  20 61 AF          jsr putItem
  580  35:AF20  8A                txa
  581  35:AF21            .itemfull:      
  582  35:AF21  60                rts
  583  35:AF22            swap_current_and_last:
  584  35:AF22  A5 62             lda <row
  585  35:AF24  48                pha
  586  35:AF25  A5 68             lda <lastRow
  587  35:AF27  85 62             sta <row
  588  35:AF29  68                pla
  589  35:AF2A  85 68             sta <lastRow
  590  35:AF2C            swap_col:
  591  35:AF2C  A5 63             lda <col
  592  35:AF2E  48                pha
  593  35:AF2F  A5 69             lda <lastCol
  594  35:AF31  85 63             sta <col
  595  35:AF33  68                pla
  596  35:AF34  85 69             sta <lastCol
  597  35:AF36  60                rts
  598                     ;----------------------------------------------------------------------------------------------------------     
  599  35:AF37            pickAndEquipItem:       ;y : countToPick
  600  35:AF37  A6 43             ldx <equipIndex
  601                             ;dey
  602  35:AF39  98                tya
  603  35:AF3A  49 FF             eor #$ff        ;NOT
  604  35:AF3C  18                clc
  605  35:AF3D  65 41             adc <equipCount
  606                             ;here A = equipCount - pickCount - 1
  607  35:AF3F  90 08             bcc .pickAll    
  608  35:AF41  E8                inx
  609  35:AF42  69 00             adc #0  ;add carry (here always 1)
  610                             ;iny
  611  35:AF44  9D F5 7A          sta cachedItems,x       ;update count
  612  35:AF47  10 0B             bpl .putEquip
  613  35:AF49            .pickAll:
  614  35:AF49  A9 00             lda #0
  615  35:AF4B  9D F5 7A          sta cachedItems,x
  616  35:AF4E  E8                inx
  617  35:AF4F  9D F5 7A          sta cachedItems,x
  618           0000              .IF UPDATE_FLAGS
  622                             .ENDIF
  623  35:AF52  A4 41             ldy <equipCount
  624  35:AF54            .putEquip:
  625  35:AF54  A6 42             ldx <removeIndex
  626  35:AF56  A5 40             lda <equipId    
  627  35:AF58  9D F5 7A          sta cachedItems,x
  628  35:AF5B  E8                inx
  629  35:AF5C  98                tya     ;count
  630  35:AF5D  9D F5 7A          sta cachedItems,x
  631  35:AF60  60                rts
  632                     ;----------------------------------------------------------------------------------------------------------     
  633  35:AF61            putItem:
  634                     ;[in] a:itemid, x:index, y:count
  635                     ;[out] x : offset to put item's count
  636  35:AF61  DD F5 7A          cmp cachedItems,x
  637  35:AF64  D0 08             bne .putToFree
  638                             ;there is same item,stack it
  639  35:AF66  E8                inx
  640  35:AF67  98                tya
  641  35:AF68  18                clc
  642  35:AF69  7D F5 7A          adc cachedItems,x
  643  35:AF6C  10 05             bpl .storeCount
  644  35:AF6E            .putToFree
  645  35:AF6E  9D F5 7A          sta cachedItems,x       ;id
  646           0000              .IF UPDATE_FLAGS
  655                             .ENDIF
  656  35:AF71  E8                inx
  657  35:AF72  98                tya
  658  35:AF73            .storeCount:
  659  35:AF73  9D F5 7A          sta cachedItems,x       ;count
  660  35:AF76  60                rts
  661                     ;----------------------------------------------------------------------------------------------------------
  662           0048      findItem_notFound = $48 
  663  35:AF77            findItem:       ;a : findId     
  664           0024      .idToFind = $24
  665  35:AF77  A2 08             ldx #8
  666  35:AF79  85 24             sta <.idToFind
  667  35:AF7B            .find_loop:
  668  35:AF7B  BD F5 7A                  lda cachedItems,x
  669  35:AF7E  C5 24                     cmp <.idToFind
  670  35:AF80  F0 06                     beq .found
  671  35:AF82  E8                        inx
  672  35:AF83  E8                        inx
  673  35:AF84  E0 48                     cpx #findItem_notFound 
  674  35:AF86  D0 F3                     bne .find_loop
  675  35:AF88            .found:         
  676  35:AF88  60                rts
  677                     ;----------------------------------------------------------------------------------------------------------
  678  35:AF89            getIndexToPutRemovedItem:
  679                     ;[out] bool carry : 0=putable ,x = index
  680  35:AF89  A5 3E             lda <removeId
  681  35:AF8B  20 77 AF          jsr findItem
  682  35:AF8E  E0 48             cpx #findItem_notFound
  683  35:AF90  D0 08             bne .checkCount
  684  35:AF92            .tryFreeSpace:  
  685  35:AF92  A9 00             lda #0
  686  35:AF94  20 77 AF          jsr findItem
  687  35:AF97  E0 48             cpx #findItem_notFound
  688  35:AF99  60                rts
  689  35:AF9A            .checkCount:
  690  35:AF9A  E8                inx
  691  35:AF9B  A5 3F             lda <removeCount
  692  35:AF9D  18                clc
  693  35:AF9E  7D F5 7A          adc cachedItems,x
  694  35:AFA1  CA                dex
  695  35:AFA2  C9 64             cmp #100
  696  35:AFA4  60                rts
  697                     ;==========================================================================================================
  698                     ;       .org $b1d8
  699                     ;       .incbin "ff3_$35_b1d8-b4f6.bin"
  700                     ;       .org $b1d8
  701                     
  702  35:AFA5            loadTileArrayOfItemProps:       
  703                     ;       [in] u8 $34[2][4] : items
  704                     ;       [in] u16 $43 : ptrToDestTileArray
  705           0034      .items = $34
  706           003C      .counter = $3c
  707  35:AFA5  20 54 97          jsr initTileArrayStorage        ;$9754  ;fill_7200to73ff_ff();
  708  35:AFA8  A9 00             lda #0
  709  35:AFAA  85 3C             sta <.counter
  710  35:AFAC            .loop:
  711  35:AFAC  A2 0D                     ldx #$0d
  712  35:AFAE  20 49 A5                  jsr initString  ;$35:a549
  713  35:AFB1  A6 3C                     ldx <.counter
  714  35:AFB3  B5 34                     lda <.items,x
  715  35:AFB5  C9 FF                     cmp #$ff
  716  35:AFB7  D0 04                     bne .check_string
  717  35:AFB9  A9 1A                             lda #$0d * 2
  718  35:AFBB  D0 3A                             bne .offset_line
  719  35:AFBD                    .check_string:
  720  35:AFBD  85 1A                     sta <$1a
  721  35:AFBF  BD 00 74                  lda $7400,x
  722  35:AFC2  D0 05                     bne .load_string
  723  35:AFC4  A9 73                             lda #$73
  724  35:AFC6  8D D7 7A                          sta stringCache ;$7ad7
  725  35:AFC9                    .load_string:
  726  35:AFC9  A9 88                     lda #$88
  727  35:AFCB  85 19                     sta <$19
  728  35:AFCD  B5 35                     lda <.items+1,x
  729  35:AFCF  48                        pha
  730  35:AFD0  A9 00                     lda #0
  731  35:AFD2  AA                        tax
  732  35:AFD3  E8                        inx
  733  35:AFD4  85 18                     sta <$18
  734  35:AFD6  A5 1A                     lda <$1a
  735  35:AFD8  20 09 A6                  jsr loadString
  736                                     
  737  35:AFDB  A9 C8                     lda #$c8
  738  35:AFDD  8D E1 7A                  sta stringCache+10
  739           0000              .IFNDEF USE_ITOA8       
  749                             .ELSE
  750  35:AFE0  68                        pla     ;count
  751  35:AFE1  20 25 A6                  jsr itoa_8
  752  35:AFE4  A5 1B                     lda <$1b
  753  35:AFE6  8D E2 7A                  sta stringCache+11
  754  35:AFE9  A5 1C                     lda <$1c
  755  35:AFEB  8D E3 7A                  sta stringCache+12
  756                             .ENDIF  
  757  35:AFEE  A9 0D                     lda #$0d
  758  35:AFF0  85 18                     sta <$18
  759  35:AFF2  20 6A 96                  jsr strToTileArray
  760  35:AFF5  A9 0D                     lda #$0d
  761  35:AFF7                    .offset_line:
  762  35:AFF7  20 58 A5                  jsr offsetTilePtr       ;$35:a559
  763  35:AFFA  E6 3C                     inc <.counter
  764  35:AFFC  E6 3C                     inc <.counter
  765  35:AFFE  A5 3C                     lda <.counter
  766  35:B000  C9 08                     cmp #8
  767  35:B002  D0 A8             bne .loop
  768  35:B004  60                rts
  769                     ;==========================================================================================================
  770                     ;$35:b242 isHandFreeForItem
  771                     ;       [in] itemid $3e : toRemove
  772                     ;       [in] itemid $40 : toEquip
  773                     ;       [in] itemid $7af5 : righthand
  774                     ;       [in] itemid $7af9 : lefthand
  775                     ;       [out] bool carry : 0:ok 1:bad combination
  776                     ;       original:65h bytes      
  777                     ;(id)
  778                     ;00             o       o       o       o       o       o
  779                     ;01-45          o       x       x       x       o
  780                     ;46-49                  x       x       x       x
  781                     ;4a-4e                          x       o       x
  782                     ;4f-57                                  x       x
  783                     ;58-64                                          o
  784                     ;       .ORG $b242
  785                     ;       .DS $65+$172            ;init original region
  786                     ;
  787  35:B005            isHandFreeForItem:
  788           003E      .toRemove = $3e
  789           0040      .toEquip = $40
  790           7AF7      .right = $7af5+2        ;original version uses $7af5,but it is not updated through equip change
  791           7AFB      .left = $7af9+2         ;
  792  35:B005  AD F7 7A          lda .right
  793  35:B008  C5 3E             cmp <.toRemove
  794  35:B00A  D0 03             bne .get_mask
  795  35:B00C  AD FB 7A                  lda .left
  796  35:B00F            .get_mask:
  797  35:B00F  20 28 B0          jsr idToKind
  798  35:B012  BD 21 B0          lda .masks,x
  799  35:B015  48                pha
  800  35:B016  A5 40             lda <.toEquip
  801  35:B018  20 28 B0          jsr idToKind
  802  35:B01B  68                pla
  803  35:B01C            .shift_loop:
  804  35:B01C  0A                        asl a
  805  35:B01D  CA                        dex
  806  35:B01E  10 FC             bpl .shift_loop
  807  35:B020  60                rts
  808  35:B021            .masks: ;0=ok 1:no
  809  35:B021  03                .DB             %00000011       ;00
  810  35:B022  3B                .DB             %00111011       ;01-45
  811  35:B023  7F                .DB             %01111111       ;46-49
  812  35:B024  77                .DB             %01110111       ;4a-4e
  813  35:B025  6F                .DB             %01101111       ;4f-57
  814  35:B026  3B                .DB             %00111011       ;58-64
  815  35:B027  FF                .DB             %11111111       ;65-
  816                     ;---------------------------------------------------------------------------------------------------------
  817  35:B028            idToKind:       ;a = id,x = result
  818  35:B028  A2 05             ldx #5
  819  35:B02A            .loop:
  820  35:B02A  DD 34 B0                  cmp .bounds,x
  821  35:B02D  B0 03                     bcs .return
  822  35:B02F  CA                        dex
  823  35:B030  10 F8             bpl .loop
  824  35:B032            .return:
  825  35:B032  E8                inx
  826  35:B033  60                rts
  827  35:B034            .bounds:
  828  35:B034  01 46 4A          .db     $01,$46,$4a,$4f,$58,$65
       35:B037  4F 58 65  
  829                     ;==========================================================================================================
  830                     ;original:$b2a7
  831                     ;scrolling functions
  832                     ;       [in,out] u8 $65 : background no
  833                     ;       [in,out] u8 $66 : left(colIndex,0-7)
  834                     ;       [in] u8 $69 : col index of 1st selection (if avail)
  835                     ;       [in] u8 $67 : mode
  836                     ;       .ORG $b2a7
  837           0078      itemWindowScrollX       = 120
  838           0028      itemWindowDx            = 120/3 ;orig : $14
  839  35:B03A            itemWindow_scrollRight
  840  35:B03A  A5 66             lda <windowLeft
  841  35:B03C  C9 06             cmp #6
  842  35:B03E  B0 0F             bcs .do_scroll
  843  35:B040  69 02                     adc #2
  844  35:B042  48                        pha
  845  35:B043  C9 07                     cmp #7
  846  35:B045  90 03                     bcc .draw_next_column
  847  35:B047  20 0B 8F                          jsr eraseFromLeftBottom0Bx0A    ;//$34:8f0b
  848  35:B04A            .draw_next_column:      
  849  35:B04A  68                        pla
  850  35:B04B  AA                        tax
  851  35:B04C  20 94 B0                  jsr drawItemWindowColumn
  852  35:B04F            .do_scroll:
  853  35:B04F  A5 66             lda <windowLeft
  854  35:B051  C9 07             cmp #7
  855  35:B053  F0 09             beq .update_cursor
  856  35:B055  E6 66                     inc <windowLeft
  857  35:B057  A9 78                     lda #itemWindowScrollX
  858  35:B059  A0 28                     ldy #itemWindowDx
  859  35:B05B  20 CF B0                  jsr scrollItemWindow
  860  35:B05E            .update_cursor:
  861  35:B05E  A5 67             lda <mode
  862  35:B060  F0 03             beq .return
  863  35:B062  20 F9 B0                  jsr update1stCursor
  864  35:B065            .return:
  865  35:B065  60                rts
  866                     ;---------------------------------------------------------------------------------------------------------      
  867                     ;original:$b362
  868                     ;       .ORG $b362
  869  35:B066            itemWindow_scrollLeft:
  870                     ;       [in,out] u8 $65 : background no
  871                     ;       [in,out] u8 $66 : left(colIndex,0-7)
  872                     ;       [in] u8 $69 : col index of 1st selection (if avail)
  873                     ;       [in] u8 $67 : mode
  874  35:B066  A5 66             lda <windowLeft
  875  35:B068  C9 02             cmp #2
  876  35:B06A  90 13             bcc .do_scroll
  877  35:B06C  D0 0B             bne .draw_next_column
  878  35:B06E  A9 00                     lda #0
  879  35:B070  8D 73 75                  sta $7573
  880  35:B073  20 33 B1                  jsr drawEquipWindow
  881  35:B076  4C 7F B0                  jmp .do_scroll
  882  35:B079            .draw_next_column:      
  883                                     ;always sec
  884  35:B079  E9 03                     sbc #3
  885  35:B07B  AA                        tax
  886  35:B07C  20 94 B0                  jsr drawItemWindowColumn
  887  35:B07F            .do_scroll:
  888  35:B07F  A5 66             lda <windowLeft
  889  35:B081  F0 09             beq .update_cursor
  890  35:B083  C6 66                     dec <windowLeft
  891  35:B085  A9 88                     lda #-itemWindowScrollX
  892  35:B087  A0 D8                     ldy #-itemWindowDx
  893  35:B089  20 CF B0                  jsr scrollItemWindow
  894  35:B08C            .update_cursor:
  895  35:B08C  A5 67             lda <mode
  896  35:B08E  F0 03             beq .return
  897  35:B090  20 F9 B0                  jsr update1stCursor
  898  35:B093            .return:
  899  35:B093  60                rts                             
  900                     ;---------------------------------------------------------------------------------------------------------
  901  35:B094            drawItemWindowColumn:
  902                     ;       [in] x : colIndex (equip=-1)
  903           0018      .left = $18
  904           0019      .right = $19
  905           001A      .drawFlag = $1a
  906           003D      .firstItemOffset = $3d
  907                     ;.windowPos = $b636
  908  35:B094  8A                txa
  909  35:B095  0A                asl a
  910  35:B096  48                pha
  911  35:B097  0A                asl a
  912  35:B098  0A                asl a
  913  35:B099  85 3D             sta <.firstItemOffset
  914  35:B09B  20 9F B1          jsr loadTileArrayForItemWindowColumn    ;$34:b48b
  915  35:B09E  68                pla
  916  35:B09F  AA                tax
  917  35:B0A0  F0 08             beq .left_required
  918                     ;check right
  919  35:B0A2  E0 0E             cpx #14 ;7*2
  920  35:B0A4  F0 08             beq .right_required
  921  35:B0A6  A9 00             lda #0
  922  35:B0A8  F0 06             beq .store_flag
  923  35:B0AA            .left_required:
  924  35:B0AA  A9 01             lda #1
  925  35:B0AC  D0 02             bne .store_flag
  926  35:B0AE            .right_required:        
  927  35:B0AE  A9 02             lda #2
  928  35:B0B0            .store_flag
  929  35:B0B0  85 1A             sta <.drawFlag          
  930  35:B0B2  BD BF B0          lda .windowPos,x
  931  35:B0B5  85 18             sta <.left
  932  35:B0B7  BD C0 B0          lda .windowPos+1,x
  933  35:B0BA  85 19             sta <.right
  934                             
  935  35:B0BC  4C 38 8B          jmp draw8LineWindow     ;$8b38
  936  35:B0BF            .windowPos:
  937  35:B0BF  10 1E             .db     $10,$1E
  938  35:B0C1  1F 8D             .db     $1F,$8D
  939  35:B0C3  8E 9C             .db     $8E,$9C
  940  35:B0C5  9D 0B             .db $9D,$0B
  941  35:B0C7  0C 1A             .db $0C,$1A
  942  35:B0C9  1B 89             .db $1B,$89
  943  35:B0CB  8A 98             .db $8A,$98
  944  35:B0CD  99 07             .db $99,$07     
  945                     ;---------------------------------------------------------------------------------------------------------      
  946  35:B0CF            scrollItemWindow:
  947                     ;       [in] s8 a : scrollX
  948                     ;       [in] s8 y : dx
  949           0064      .scrollTo = $64
  950           0065      .invert = $65
  951                     ;.windowLeft = $66
  952           0008      .ppuFlag1 = $08
  953           0010      .currentX = $10
  954  35:B0CF  AA                tax
  955  35:B0D0  30 04             bmi .scroll_left
  956  35:B0D2  A9 00             lda #%00000000
  957  35:B0D4  F0 02             beq .store_invert
  958  35:B0D6            .scroll_left:
  959  35:B0D6  A9 01             lda #%00000001
  960  35:B0D8            .store_invert:
  961  35:B0D8  85 65             sta <.invert
  962  35:B0DA  8A                txa
  963  35:B0DB  18                clc
  964  35:B0DC  65 10             adc <.currentX
  965  35:B0DE  85 64             sta <.scrollTo
  966  35:B0E0            .scroll_loop:
  967  35:B0E0  20 C5 F8                  jsr updateDmaPpuScrollSyncNmi   ;$3f:f8c5 (y is unchanged)
  968  35:B0E3  98                        tya
  969  35:B0E4  18                        clc
  970  35:B0E5  65 10                     adc <.currentX
  971  35:B0E7  85 10                     sta <.currentX
  972  35:B0E9  2A                        rol     a       ;take carry
  973  35:B0EA  29 01                     and #1  ;mask
  974  35:B0EC  45 65                     eor <.invert    ;invert if scroll to left
  975                                     ;a = 01 if overflow
  976  35:B0EE  45 08                     eor <.ppuFlag1
  977  35:B0F0  85 08                     sta <.ppuFlag1
  978  35:B0F2  A5 10                     lda <.currentX
  979  35:B0F4  C5 64                     cmp <.scrollTo
  980  35:B0F6  D0 E8             bne .scroll_loop
  981  35:B0F8  60                rts
  982                     ;---------------------------------------------------------------------------------------------------------
  983  35:B0F9            update1stCursor:
  984                             ;if (lastCol == left || lastCol == left + 1)
  985  35:B0F9  A6 66             ldx <windowLeft
  986  35:B0FB  E4 69             cpx <lastCol
  987  35:B0FD  F0 09             beq .move_cursor
  988  35:B0FF  E8                inx
  989  35:B100  E4 69             cpx <lastCol
  990  35:B102  D0 18             bne .hide_cursor
  991  35:B104  A9 84             lda #$84
  992  35:B106  D0 02             bne .store_x
  993  35:B108            .move_cursor:
  994  35:B108  A9 0C             lda #$0c
  995  35:B10A            .store_x:       
  996  35:B10A  85 1D             sta <$1d        ;#$84 or #0c
  997  35:B10C  A5 68             lda <lastRow
  998  35:B10E  20 3E FD          jsr $fd3e       ;asl * 4
  999  35:B111  69 A8             adc #$a8
 1000  35:B113  85 1C             sta <$1c
 1001  35:B115  A9 01             lda #1
 1002  35:B117  85 1A             sta <$1a
 1003  35:B119  4C 2E 89          jmp tileSprites2x2
 1004                             ;jsr tileSprites2x2
 1005                             ;rts
 1006  35:B11C            .hide_cursor:   
 1007  35:B11C  A5 1C             lda <$1c
 1008  35:B11E  48                pha
 1009  35:B11F  A9 F0             lda #$f0
 1010  35:B121  85 1C             sta <$1c
 1011  35:B123  A9 01             lda #1
 1012  35:B125  85 1A             sta <$1a
 1013  35:B127  20 2E 89          jsr tileSprites2x2
 1014  35:B12A  68                pla
 1015  35:B12B  85 1C             sta <$1c
 1016  35:B12D  60                rts     
 1017                     ;$b419:
 1018                     ;==========================================================================================================
 1019                     ;$35:b5f9 drawEquipWindowNoErase
 1020  35:B12E            drawEquipWindowNoErase:
 1021           7573      .eraseFlag = $7573      
 1022  35:B12E  A9 FF             lda #$ff
 1023  35:B130  8D 73 75          sta .eraseFlag
 1024                             ;jmp drawEquipWindow
 1025                     ;==========================================================================================================
 1026                     ;$35:b419 drawEquipWindow
 1027                     ;       [in] u16 $59 : ptrToEquips ($6200)
 1028                     ;       [in] bool $7573 : eraseFlag 
 1029  35:B133            drawEquipWindow:
 1030           0034      .items = $34
 1031  35:B133  A2 07             ldx #7
 1032  35:B135            .initloop:
 1033  35:B135  A9 01                     lda #1
 1034  35:B137  9D 00 74                  sta $7400,x
 1035  35:B13A  A9 FF                     lda #$ff
 1036  35:B13C  95 34                     sta <.items,x
 1037  35:B13E  CA                        dex
 1038  35:B13F  10 F4                     bpl .initloop
 1039  35:B141  20 41 A5          jsr getPlayerOffset
 1040  35:B144  69 03             adc #3
 1041  35:B146  A8                tay     
 1042                     
 1043  35:B147  B1 59             lda [pEquips],y
 1044  35:B149  85 36             sta <.items+2
 1045  35:B14B  C8                iny
 1046  35:B14C  B1 59             lda [pEquips],y
 1047  35:B14E  85 37             sta <.items+3
 1048  35:B150  C8                iny
 1049  35:B151  B1 59             lda [pEquips],y
 1050  35:B153  85 3A             sta <.items+6
 1051  35:B155  C8                iny
 1052  35:B156  B1 59             lda [pEquips],y
 1053  35:B158  85 3B             sta <.items+7
 1054                     
 1055  35:B15A  20 A5 AF          jsr loadTileArrayOfItemProps
 1056                             
 1057  35:B15D  A9 C0             lda #$c0
 1058  35:B15F  8D 01 72          sta $7201
 1059  35:B162  8D 35 72          sta $7235
 1060  35:B165  A9 9C             lda #$9c
 1061  35:B167  8D 0F 72          sta $720f
 1062  35:B16A  8D 44 72          sta $7244
 1063  35:B16D  A9 A9             lda #$a9
 1064  35:B16F  8D 0D 72          sta $720d
 1065  35:B172  A9 90             lda #$90
 1066  35:B174  8D 0E 72          sta $720e
 1067  35:B177  A9 A4             lda #$a4
 1068  35:B179  8D 41 72          sta $7241
 1069  35:B17C  A9 99             lda #$99
 1070  35:B17E  8D 42 72          sta $7242
 1071  35:B181  A9 B1             lda #$b1
 1072  35:B183  8D 43 72          sta $7243
 1073                     
 1074  35:B186  AD 73 75          lda $7573
 1075  35:B189  C9 FF             cmp #$ff
 1076  35:B18B  F0 03             beq .draw
 1077  35:B18D  20 0B 8F                  jsr eraseFromLeftBottom0Bx0A
 1078  35:B190            .draw:  
 1079  35:B190  A9 01             lda #1
 1080  35:B192  85 18             sta <$18        ;left
 1081  35:B194  A9 0F             lda #$0f
 1082  35:B196  85 19             sta <$19        ;right
 1083  35:B198  A9 03             lda #$03
 1084  35:B19A  85 1A             sta <$1a
 1085  35:B19C  4C 38 8B          jmp draw8LineWindow
 1086                     ;$b48b
 1087                     ;==========================================================================================================
 1088                     ;$35:b48b loadTileArrayForItemWindowColumn()
 1089                     ;       [in,out] u8 $3d : firstItemOffset, incremented by 8 per call
 1090  35:B19F            loadTileArrayForItemWindowColumn:
 1091           003D      .firstItem = $3d
 1092           0034      .items = $34
 1093  35:B19F  A9 07             lda #7
 1094  35:B1A1  AA                tax
 1095  35:B1A2  18                clc
 1096  35:B1A3  65 3D             adc <.firstItem
 1097  35:B1A5  A8                tay
 1098  35:B1A6            .init_loop:
 1099  35:B1A6  A9 01                     lda #1
 1100  35:B1A8  9D 00 74                  sta $7400,x
 1101  35:B1AB  B9 C0 60                  lda $60c0,y
 1102  35:B1AE  9D 34 00                  sta .items,x
 1103  35:B1B1  88                        dey
 1104  35:B1B2  CA                        dex
 1105  35:B1B3  10 F1                     bpl .init_loop
 1106                             
 1107  35:B1B5  E8                inx     ;x => 0
 1108  35:B1B6  A5 3D             lda <.firstItem
 1109  35:B1B8  4A                lsr a
 1110  35:B1B9  A8                tay
 1111  35:B1BA            .replace_loop:
 1112  35:B1BA  BD 34 00                  lda .items,x
 1113  35:B1BD  D0 05                     bne .check_flag
 1114  35:B1BF  A9 57                             lda #$57        ;bare fist
 1115  35:B1C1  9D 34 00                          sta .items,x
 1116  35:B1C4                    .check_flag:
 1117  35:B1C4  B9 41 7B                  lda $7b41,y
 1118  35:B1C7  D0 03                     bne .next
 1119  35:B1C9  DE 00 74                          dec $7400,x
 1120  35:B1CC                    .next:
 1121  35:B1CC  C8                        iny
 1122  35:B1CD  E8                        inx
 1123  35:B1CE  E8                        inx
 1124  35:B1CF  E0 08                     cpx #8
 1125  35:B1D1  D0 E7                     bne .replace_loop
 1126                             
 1127  35:B1D3  18                clc
 1128  35:B1D4  A5 3D             lda <.firstItem
 1129  35:B1D6  69 08             adc #8
 1130  35:B1D8  85 3D             sta <.firstItem
 1131  35:B1DA  A8                tay
 1132  35:B1DB  4C A5 AF          jmp loadTileArrayOfItemProps
 1133                     ;$b4d4:
 1134                     ;==========================================================================================================
 1135                     ;$35:b4d4 itemWindow_moveCursor
 1136  35:B1DE            itemWindow_moveCursor:
 1137  35:B1DE  A5 62             lda <row
 1138  35:B1E0  20 3E FD          jsr $fd3e       ;a <<= 4
 1139  35:B1E3  69 A8             adc #$a8
 1140  35:B1E5  85 1C             sta <$1c
 1141  35:B1E7  A9 08             lda #8
 1142  35:B1E9  A6 63             ldx <col
 1143  35:B1EB  E4 66             cpx <windowLeft
 1144  35:B1ED  F0 02             beq .store_x
 1145  35:B1EF  A9 80                     lda #$80
 1146  35:B1F1            .store_x:
 1147  35:B1F1  85 1D             sta <$1d
 1148  35:B1F3  A9 00             lda #0
 1149  35:B1F5  85 1A             sta <$1a
 1150  35:B1F7  4C 2E 89          jmp tileSprites2x2
 1151                     ;==========================================================================================================
 1152                     ;$b4f7  
 1153                     ;       .ORG $b4f7
 1154  35:B1FA            itemWindow_OnUse:
 1155           0026      .index = $26
 1156           0027      .itemId = $27
 1157           7478      .itemParams = $7478
 1158  35:B1FA  A5 63             lda <col
 1159  35:B1FC  0A                asl a
 1160  35:B1FD  0A                asl a
 1161  35:B1FE  18                clc
 1162  35:B1FF  65 62             adc <row
 1163  35:B201  85 26             sta <.index
 1164  35:B203  AA                tax
 1165  35:B204  BD 3D 7B          lda equipFlags,x
 1166  35:B207  F0 09             beq .fail
 1167  35:B209  06 26             asl <.index
 1168  35:B20B  A6 26             ldx <.index
 1169  35:B20D  BD F5 7A          lda cachedItems,x
 1170  35:B210  D0 0D             bne .use_ok
 1171  35:B212            .fail:  
 1172  35:B212  20 9B 9B                  jsr setYtoOffset2E      ;$9b9b
 1173  35:B215  A9 00                     lda #0
 1174  35:B217  91 5B                     sta [pPlayer],y
 1175  35:B219  20 81 9B                  jsr requestSoundEffect06        ;9b81
 1176  35:B21C  4C BE AC                  jmp itemWindowInputLoop
 1177  35:B21F            .use_ok:
 1178  35:B21F  85 27             sta <.itemId            
 1179  35:B221  AA                tax
 1180  35:B222  20 7D 9B          jsr requestSoundEffect05        ;9b7d
 1181  35:B225  20 9B 9B          jsr setYtoOffset2E      ;$9b9b
 1182  35:B228  8A                txa
 1183  35:B229  91 5B             sta [pPlayer],y
 1184  35:B22B  C9 A6             cmp #$a6
 1185  35:B22D  90 09             bcc .not_heal
 1186  35:B22F  C9 A9             cmp #$a9
 1187  35:B231  B0 05             bcs .not_heal
 1188  35:B233  A9 FF             lda #$ff
 1189  35:B235  8D E8 7C          sta $7ce8
 1190  35:B238            .not_heal:      
 1191  35:B238  88                dey
 1192  35:B239  88                dey
 1193  35:B23A  A9 08             lda #8
 1194  35:B23C  11 5B             ora [pPlayer],y
 1195  35:B23E  91 5B             sta [pPlayer],y
 1196                             ;here x = id
 1197                             ;[00-56] ok
 1198                             ;[57-97]
 1199                             ;[98-c7] ok
 1200                             ;[c8-ff]
 1201  35:B240  E0 57             cpx #$57
 1202  35:B242  90 2E             bcc .use_equip
 1203  35:B244  E0 98             cpx #$98
 1204  35:B246  90 CA             bcc .fail
 1205  35:B248  E0 C8             cpx #$c8
 1206  35:B24A  B0 C6             bcs .fail
 1207                             ;[98-c7] $b564:
 1208  35:B24C  AD 00 74                  lda $7400
 1209  35:B24F  48                        pha
 1210  35:B250  8A                        txa     ;id
 1211                                     ;clc here always clear
 1212  35:B251  69 08                     adc #8          ;$46 = #$91a0 + (a - #$98)
 1213  35:B253  85 46                     sta <$46
 1214  35:B255  A9 00                     lda #0
 1215  35:B257  69 91                     adc #$91
 1216  35:B259  85 47                     sta <$47
 1217  35:B25B  A9 01                     lda #1
 1218  35:B25D  85 4B                     sta <$4b
 1219  35:B25F  A9 1A                     lda #$1a
 1220  35:B261  85 4A                     sta <$4a
 1221  35:B263  A9 17                     lda #$17
 1222  35:B265  20 DC FD                  jsr $fddc       ;copyTo7400(bank:a = #17 base:$46 = #91a0 + (a - #98), size:$4b = 1, restore:$4a = #1a):        ;$fd
 1223  35:B268  AC 00 74                  ldy $7400
 1224  35:B26B  68                        pla
 1225  35:B26C  8D 00 74                  sta $7400
 1226  35:B26F  18                        clc
 1227  35:B270  90 17                     bcc .check_flag
 1228  35:B272            .use_equip:             
 1229                             ;itemid:[00-56]
 1230  35:B272  8A                        txa     ;id
 1231  35:B273  85 18                     sta <$18
 1232  35:B275  A9 08                     lda #8
 1233  35:B277  85 1A                     sta <$1a
 1234  35:B279  A9 00                     lda #$00
 1235  35:B27B  85 20                     sta <$20
 1236  35:B27D  A9 94                     lda #$94
 1237  35:B27F  85 21                     sta <$21
 1238  35:B281  A2 78                     ldx #$78
 1239  35:B283  20 3A BA                  jsr $ba3a       ;loadTo7400FromBank30(index:$18 = a,size:$1a = 8,base:$20 = #9400,dest:x = #78);        ;$ba3a
 1240                                     
 1241  35:B286  AC 7C 74                  ldy .itemParams+4 ;$747c
 1242  35:B289            .check_flag
 1243                             ;here y: effect type? $b58b
 1244                             ;ldx <.index
 1245                             ;lda equipFlags,x
 1246                             ;beq .fail
 1247  35:B289  C0 7F             cpy #$7f
 1248  35:B28B  D0 07             bne .load_param
 1249  35:B28D  A9 09                     lda #9
 1250  35:B28F  8D 7D 74                  sta .itemParams+5
 1251  35:B292  D0 13                     bne .select_target
 1252  35:B294            .load_param:
 1253  35:B294  84 18                     sty <$18
 1254  35:B296  A9 08                     lda #8
 1255  35:B298  85 1A                     sta <$1a
 1256  35:B29A  A9 C0                     lda #$c0
 1257  35:B29C  85 20                     sta <$20
 1258  35:B29E  A9 98                     lda #$98
 1259  35:B2A0  85 21                     sta <$21
 1260  35:B2A2  A2 78                     ldx #$78
 1261  35:B2A4  20 3A BA                  jsr $ba3a
 1262  35:B2A7            .select_target:
 1263  35:B2A7  20 79 B9          jsr $b979 ;     ;対象選択? (2 == cancel)
 1264  35:B2AA  C9 02             cmp #2
 1265  35:B2AC  D0 03             bne .consume
 1266                                     ;dec <iPlayer
 1267                                     ;jmp closeItemWindow
 1268  35:B2AE  4C D6 AE                  jmp itemWindow_closeAndKeepCurrentPlayer
 1269  35:B2B1            .consume:
 1270  35:B2B1  A9 3F             lda #$3f
 1271  35:B2B3  20 88 9B          jsr $9b88
 1272  35:B2B6  A5 27             lda <.itemId
 1273  35:B2B8  91 5B             sta [pPlayer],y
 1274  35:B2BA  A5 63             lda <col
 1275  35:B2BC  D0 05             bne .not_equip
 1276  35:B2BE  88                        dey
 1277  35:B2BF  A9 01                     lda #1
 1278  35:B2C1  91 5B                     sta [pPlayer],y
 1279  35:B2C3            .not_equip:
 1280  35:B2C3  A6 26             ldx <.index
 1281  35:B2C5  E8                inx
 1282  35:B2C6  DE F5 7A          dec cachedItems,x
 1283  35:B2C9  BD F5 7A          lda cachedItems,x
 1284  35:B2CC  D0 04             bne .copyback
 1285                                     ;as cosumed,item count reached 0.so clear id
 1286  35:B2CE  CA                        dex
 1287  35:B2CF  9D F5 7A                  sta cachedItems,x
 1288  35:B2D2            .copyback:              
 1289  35:B2D2  A2 3F             ldx #$3f
 1290  35:B2D4            .copyloop:      
 1291  35:B2D4  BD FD 7A                  lda cachedItems+8,x
 1292  35:B2D7  9D C0 60                  sta backpackItems,x
 1293  35:B2DA  CA                        dex
 1294  35:B2DB  10 F7                     bpl .copyloop
 1295  35:B2DD  4C D8 AE          jmp closeItemWindow
 1296                     ;==========================================================================================================
 1297                     ;$b601
 1298                     ;$35:b601 redrawColumn
 1299                     ;//     [in] u8 x : col
 1300                     ;==========================================================================================================
 1301                     ;$b636
 1302  35:B2E0            ff3_itemWindow_end:
 1303           06F7      ff3_itemWindow_size = ff3_itemWindow_end - ff3_itemWindow_begin
 1304                     
#[3]   ff3_hack_master.asm
#[4]   ff3_magic_window.asm
   40                                     .include "ff3_magic_window.asm" ;save
    1                     ; ff3_magic_window.asm
    2                     ;
    3                     ;description:
    4                     ;       replaces magic-selection-window 
    5                     ;
    6                     ;version:
    7                     ;       0.06 (2006-10-29)
    8                     ;
    9                     ;======================================================================================================
   10  35:B2E0            ff3_magic_window_begin:
   11                     ;------------------------------------------------------------------------------------------------------
   12                             INIT_PATCH $35,$b646,$b979
                0035              .bank   $35
                B646              .org    $b646
       35:B646                    .ds             (($b979) - ($b646))
                B646              .org    $b646
   13           B2E0              .org ff3_magic_window_begin
   14                     ;------------------------------------------------------------------------------------------------------
   15                     ;commandWindow_OnMagicSelected:
   16  35:B2E0            commandWindow_OnMagic:
   17           0057      .pPlayerBaseParam = $57 ;[in]
   18           0059      .pPlayerEquips = $59    ;[in]
   19           005B      .pPlayer = $5b                  ;[in]
   20           0018      .magicIdOffset = $18
   21           0024      .magicSlot = $24
   22           0026      .magicIndex = $26
   23           0027      .currentMagicLv = $27
   24           0046      .maxMagicLv = $46
   25                     ;---------------------------------------
   26  35:B2E0  2C D8 7E          bit $7ed8       ;status_2?
   27  35:B2E3  50 06             bvc     .castable       ;bit6 is clear
   28  35:B2E5  20 81 9B                  jsr requestSoundEffect06
   29  35:B2E8  A9 01                     lda #1
   30                                     RET_TO_GET_COMMAND_INPUT
       35:B2EA  60                rts
   31                                     ;jmp getCommandInput_next
   32  35:B2EB            .castable:              
   33  35:B2EB  A2 17             ldx #$17
   34  35:B2ED  A9 FF             lda #$ff
   35  35:B2EF            .init_7400:
   36  35:B2EF  9D 00 74                  sta $7400,x
   37  35:B2F2  CA                        dex
   38  35:B2F3  10 FA                     bpl .init_7400
   39  35:B2F5  A9 3F             lda #$3f
   40  35:B2F7  20 88 9B          jsr setYtoOffsetOf
   41  35:B2FA  A2 07             ldx #7
   42  35:B2FC            .find_max_lv:   
   43  35:B2FC  B1 57                     lda [.pPlayerBaseParam],y
   44  35:B2FE  D0 05                     bne .found_lv
   45  35:B300  CA                        dex
   46  35:B301  88                        dey
   47  35:B302  88                        dey
   48  35:B303  D0 F7                     bne .find_max_lv        ;y shouldn't be 0
   49  35:B305            .found_lv:              
   50  35:B305  86 27             stx <.currentMagicLv
   51  35:B307  86 46             stx <.maxMagicLv
   52                             ;txa
   53                             ;pha
   54  35:B309  A9 07             lda #7
   55  35:B30B  38                sec
   56  35:B30C  E5 27             sbc <.currentMagicLv
   57                             ;$18 = (7- currentMagicLv)*7
   58  35:B30E  85 18             sta <.magicIdOffset
   59  35:B310  0A                asl a
   60  35:B311  0A                asl a
   61  35:B312  0A                asl a
   62  35:B313  38                sec
   63  35:B314  E5 18             sbc <.magicIdOffset
   64  35:B316  85 18             sta <.magicIdOffset
   65  35:B318  A9 00             lda #0
   66  35:B31A  85 26             sta <.magicIndex
   67  35:B31C            .getMagicIds:
   68  35:B31C  85 24                     sta <.magicSlot
   69  35:B31E  48                        pha     ;magicslot
   70  35:B31F  A9 07                     lda #7
   71  35:B321  AA                        tax     ;x:index
   72  35:B322  18                        clc
   73  35:B323  65 27                     adc <.currentMagicLv
   74  35:B325  20 88 9B                  jsr setYtoOffsetOf
   75  35:B328  B1 59                     lda [.pPlayerEquips],y
   76  35:B32A                    .find_equipped_magic:   ;$b69e
   77  35:B32A  4A                                lsr a
   78  35:B32B  90 0B                             bcc .find_equipped_next
   79  35:B32D  48                                        pha
   80  35:B32E  A4 24                                     ldy <.magicSlot
   81  35:B330  A5 18                                     lda <.magicIdOffset
   82  35:B332  99 00 74                                  sta $7400,y
   83  35:B335  E6 24                                     inc <.magicSlot
   84  35:B337  68                                        pla
   85  35:B338                            .find_equipped_next:
   86  35:B338  E6 18                             inc <.magicIdOffset
   87  35:B33A  CA                                dex
   88  35:B33B  D0 ED                             bne .find_equipped_magic
   89  35:B33D  68                        pla     ;magicslot
   90  35:B33E  18                        clc
   91  35:B33F  69 03                     adc #3
   92  35:B341  C6 27                     dec <.currentMagicLv
   93  35:B343  A6 27                     ldx <.currentMagicLv
   94  35:B345  10 D5                     bpl .getMagicIds
   95                     ;$b6cc:
   96           0024      .magicLv = $24
   97  35:B347  20 54 97          jsr initTileArrayStorage        ;$9754
   98  35:B34A  A6 46             ldx <.maxMagicLv
   99  35:B34C  86 24             stx <.magicLv
  100                     ;$b6dc:
  101  35:B34E            .loadMagicNames:
  102           0027      .dest = $27
  103  35:B34E  A2 1C                     ldx #$1c
  104  35:B350  20 49 A5                  jsr initString  ;a549
  105  35:B353  A9 08                     lda #8
  106  35:B355  85 27                     sta <.dest
  107  35:B357  A9 81                     lda #$81        ;'1'
  108  35:B359  18                        clc
  109  35:B35A  65 24                     adc <.magicLv
  110  35:B35C  8D D7 7A                  sta stringCache+0
  111  35:B35F  A9 C7                     lda #$c7
  112  35:B361  8D DB 7A                  sta stringCache+4
  113  35:B364  A9 07                     lda #7
  114                                     ;clc always clear
  115  35:B366  65 24                     adc <.magicLv
  116  35:B368  20 88 9B                  jsr setYtoOffsetOf      ;9b88
  117  35:B36B  B1 5B                     lda [pPlayer],y ;currentMp
  118  35:B36D  20 25 A6                  jsr itoa_8
  119  35:B370  A5 1B                     lda <$1b
  120  35:B372  8D D9 7A                  sta stringCache+2
  121  35:B375  A5 1C                     lda <$1c
  122  35:B377  8D DA 7A                  sta stringCache+3
  123                                     ;
  124  35:B37A  A5 24                     lda <.magicLv
  125  35:B37C  0A                        asl a
  126                                     ;clc always cleared (0 <= magicLv < 8)
  127  35:B37D  69 31                     adc #$31
  128  35:B37F  20 88 9B                  jsr setYtoOffsetOf      ;9b88
  129  35:B382  B1 57                     lda [.pPlayerBaseParam],y       ;maxMp
  130  35:B384  20 25 A6                  jsr itoa_8
  131  35:B387  A5 1B                     lda <$1b
  132  35:B389  8D DC 7A                  sta stringCache+5
  133  35:B38C  A5 1C                     lda <$1c
  134  35:B38E  8D DD 7A                  sta stringCache+6
  135                     ;$b734
  136  35:B391  A9 03                     lda #3
  137  35:B393                    .loadMagicNamesOfCurrentLv:
  138  35:B393  48                                pha     ;index (means slot)
  139  35:B394  A6 26                             ldx <.magicIndex
  140  35:B396  BD 00 74                          lda $7400,x
  141  35:B399  C9 FF                             cmp #$ff        ;empty
  142  35:B39B  F0 2F                             beq .load_next
  143                     ;$b73f:
  144  35:B39D  85 18                                     sta <$18
  145  35:B39F  48                                        pha     ;magic id
  146                                                     INIT16 <$20,$98c0
       35:B3A0  A9 C0             lda #LOW($98c0)
       35:B3A2  85 20             sta <$20
       35:B3A4  A9 98             lda #HIGH($98c0)
       35:B3A6  85 21             sta <$20+1
  147  35:B3A8  20 1C B5                                  jsr isPlayerAllowedToUseItem    ;$b8fd
  148  35:B3AB  A5 1C                                     lda <$1c
  149  35:B3AD  D0 0E                                     bne .load_name
  150  35:B3AF  A6 27                                             ldx <.dest
  151  35:B3B1  A9 73                                             lda #$73        ;'x'
  152  35:B3B3  9D D7 7A                                          sta stringCache,x
  153  35:B3B6  A6 26                                             ldx <.magicIndex
  154  35:B3B8  A9 FF                                             lda #$ff
  155  35:B3BA  9D 00 74                                          sta $7400,x
  156  35:B3BD                                    .load_name:
  157  35:B3BD  A6 27                                     ldx <.dest
  158  35:B3BF  E8                                        inx
  159                                                     INIT16 <$18,$8990
       35:B3C0  A9 90             lda #LOW($8990)
       35:B3C2  85 18             sta <$18
       35:B3C4  A9 89             lda #HIGH($8990)
       35:B3C6  85 19             sta <$18+1
  160  35:B3C8  68                                        pla     ;magic id
  161  35:B3C9  20 09 A6                                  jsr loadString  ;a609 loadString(index:a, dest:x, src:$18 )
  162  35:B3CC                            .load_next:
  163  35:B3CC  A5 27                             lda <.dest
  164  35:B3CE  18                                clc
  165  35:B3CF  69 07                             adc #7
  166  35:B3D1  85 27                             sta <.dest
  167  35:B3D3  E6 26                             inc <.magicIndex
  168  35:B3D5  68                                pla     ;index (means slot)
  169                                             ;sec    always clear (dest < 6 * 3)
  170  35:B3D6  E9 00                             sbc #0
  171  35:B3D8  D0 B9                             bne .loadMagicNamesOfCurrentLv
  172                     ;$b77e:
  173  35:B3DA  A9 1C                     lda #$1c
  174  35:B3DC  85 18                     sta <$18
  175  35:B3DE  20 6A 96                  jsr strToTileArray      ;966a
  176  35:B3E1  A9 1C                     lda #$1c
  177  35:B3E3  20 58 A5                  jsr offsetTilePtr
  178  35:B3E6  C6 24                     dec <.magicLv
  179  35:B3E8  A5 24                     lda <.magicLv
  180  35:B3EA  30 03                     bmi .create_window
  181  35:B3EC  4C 4E B3                          jmp .loadMagicNames
  182                     ;$b793:
  183  35:B3EF            .create_window:
  184  35:B3EF  20 B0 8E          jsr eraseWindow
  185  35:B3F2  A9 01             lda #1
  186  35:B3F4  85 18             sta <$18
  187  35:B3F6  85 55             sta <$55        ;cursor id
  188  35:B3F8  A9 1E             lda #$1e
  189  35:B3FA  85 19             sta <$19
  190  35:B3FC  A9 03             lda #$3 ;left|right
  191  35:B3FE  85 1A             sta <$1a
  192  35:B400  20 38 8B          jsr draw8LineWindow     ;draw8LineWindow(left = 1, right = #$1e, border = #3); //$34:8b38
  193  35:B403  A9 00             lda #0
  194  35:B405  85 1A             sta <$1a
  195  35:B407  20 66 89          jsr loadCursor  ;8966
  196                     ;---------------------------
  197  35:B40A            magicWindow_getInput:
  198           001A      .cursorId = $1a
  199           0024      .row = $24
  200           0025      .cursorRow = $25
  201           0026      .col = $26
  202           0046      .rowMax = $46
  203  35:B40A  A2 00             ldx #0
  204  35:B40C  86 24             stx <.row
  205  35:B40E  86 25             stx <.cursorRow
  206  35:B410  86 26             stx <.col
  207                     ;$b7b8
  208  35:B412            .magicWindow_inputLoop:
  209           BA2A      .magicWindow_inputHandlerTable = $ba2a
  210  35:B412  A2 00             ldx #0
  211  35:B414  86 38             stx <$38
  212  35:B416  86 1A             stx <.cursorId
  213  35:B418  A9 02             lda #2
  214  35:B41A  85 1B             sta <$1b
  215  35:B41C  20 9E 89          jsr getInputAndUpdateCursorWithSound    ;commandWindow_dispatchInput    ;899e
  216                             INIT16 <$1e, .magicWindow_inputHandlerTable
       35:B41F  A9 2A             lda #LOW(.magicWindow_inputHandlerTable)
       35:B421  85 1E             sta <$1e
       35:B423  A9 BA             lda #HIGH(.magicWindow_inputHandlerTable)
       35:B425  85 1F             sta <$1e+1
  217  35:B427  A5 12             lda <inputBits
  218                     ;getInputAndUpdateCursorWithSound processes input bit from lsb
  219  35:B429  A6 26             ldx <.col
  220  35:B42B  A4 24             ldy <.row
  221                     
  222  35:B42D  4A                lsr a
  223  35:B42E  90 03             bcc .not_a
  224  35:B430  4C B2 B4                  jmp .magicWindow_OnA
  225  35:B433            .not_a:
  226  35:B433  4A                lsr a
  227  35:B434  B0 73             bcs .magicWindow_OnB
  228  35:B436  4A                lsr a   ;sel
  229  35:B437  4A                lsr a   ;start
  230  35:B438  4A                lsr a
  231  35:B439  B0 18             bcs .magicWindow_OnUp
  232  35:B43B  4A                lsr a
  233  35:B43C  B0 34             bcs .magicWindow_OnDown
  234  35:B43E  4A                lsr a
  235  35:B43F  B0 0B             bcs .magicWindow_OnLeft
  236  35:B441  4A                lsr a
  237                             ;bcs .magicWindow_OnRight
  238  35:B442  90 CE             bcc .magicWindow_inputLoop
  239                     ;------------------------------------------------------------------------------------------------------
  240  35:B444            .magicWindow_OnRight:
  241  35:B444  E0 02             cpx #2
  242  35:B446  F0 CA             beq .magicWindow_inputLoop
  243  35:B448  E6 26             inc <.col
  244  35:B44A  10 C6             bpl .magicWindow_inputLoop
  245                     ;------------------------------------------------------------------------------------------------------ 
  246  35:B44C            .magicWindow_OnLeft:
  247  35:B44C  8A                txa
  248  35:B44D  F0 C3             beq .magicWindow_inputLoop
  249  35:B44F  C6 26             dec <.col
  250  35:B451  10 BF             bpl .magicWindow_inputLoop
  251                     ;------------------------------------------------------------------------------------------------------ 
  252  35:B453            .magicWindow_OnUp:
  253  35:B453  98                tya
  254  35:B454  F0 BC             beq .magicWindow_inputLoop
  255  35:B456  C6 24             dec <.row
  256  35:B458  C6 25             dec <.cursorRow
  257  35:B45A  10 B6             bpl .magicWindow_inputLoop
  258  35:B45C  E6 25             inc <.cursorRow ;keep 0
  259                             SUB16 $7ac0,$0038
       35:B45E  AD C0 7A          lda $7ac0
       35:B461  38                sec
       35:B462  E9 38             sbc #LOW($0038)
       35:B464  8D C0 7A          sta $7ac0
       35:B467  AD C1 7A          lda $7ac0+1
       35:B46A  E9 00             sbc #HIGH($0038)
       35:B46C  8D C1 7A          sta $7ac0+1
  260  35:B46F  4C 97 B4          jmp .magicWindow_redraw
  261                     ;------------------------------------------------------------------------------------------------------ 
  262  35:B472            .magicWindow_OnDown:    
  263  35:B472  C0 07             cpy #7
  264  35:B474  F0 9C             beq .magicWindow_inputLoop
  265  35:B476  C4 46             cpy <.rowMax
  266  35:B478  F0 98             beq .magicWindow_inputLoop
  267  35:B47A  E6 24             inc <.row
  268  35:B47C  E6 25             inc <.cursorRow
  269  35:B47E  A5 25             lda <.cursorRow
  270  35:B480  C9 04             cmp #4
  271  35:B482  90 8E             bcc .magicWindow_inputLoop
  272  35:B484  C6 25             dec <.cursorRow ;keep 3
  273                             ADD16 $7ac0,$0038
       35:B486  AD C0 7A          lda $7ac0
       35:B489  18                clc
       35:B48A  69 38             adc #LOW($0038)
       35:B48C  8D C0 7A          sta $7ac0
       35:B48F  AD C1 7A          lda $7ac0+1
       35:B492  69 00             adc #HIGH($0038)
       35:B494  8D C1 7A          sta $7ac0+1
  274  35:B497            .magicWindow_redraw:    
  275  35:B497  A9 01             lda #1
  276  35:B499  85 18             sta <$18
  277  35:B49B  A9 1E             lda #$1e
  278  35:B49D  85 19             sta <$19
  279  35:B49F  A9 03             lda #3
  280  35:B4A1  85 1A             sta <$1a
  281  35:B4A3  20 38 8B          jsr draw8LineWindow
  282  35:B4A6  4C 12 B4          jmp .magicWindow_inputLoop
  283                     ;------------------------------------------------------------------------------------------------------
  284  35:B4A9            .magicWindow_OnB:
  285  35:B4A9            .magicWindow_close:
  286  35:B4A9  20 DF 8A          jsr clearSprites2x2     ;$8adf
  287  35:B4AC  20 B0 8E          jsr eraseWindow
  288  35:B4AF  A9 00             lda #0  ;redraw
  289                             RET_TO_GET_COMMAND_INPUT
       35:B4B1  60                rts
  290                             ;jmp getCommandInput_next
  291                     ;------------------------------------------------------------------------------------------------------ 
  292  35:B4B2            .magicWindow_OnA:
  293           7400      .magicIdList = $7400
  294                     ;.col = $26     ;x
  295                     ;.row = $24     ;y
  296           0046      .maxLv = $46
  297           0047      .lv = $47
  298           0052      .iPlayer = $52
  299           005B      .pPlayer = $5b
  300           005F      .playerOffset = $5f
  301  35:B4B2  98                tya
  302  35:B4B3  0A                asl a
  303  35:B4B4  65 24             adc <.row
  304  35:B4B6  65 26             adc <.col
  305  35:B4B8  AA                tax
  306  35:B4B9  BD 00 74          lda .magicIdList,x
  307  35:B4BC  C9 FF             cmp #$ff
  308  35:B4BE  F0 25             beq .bad_selection
  309                             
  310  35:B4C0  48                pha
  311  35:B4C1  AD D8 7E          lda $7ed8
  312  35:B4C4  29 10             and #$10
  313  35:B4C6  F0 06             beq .check_mp
  314                             
  315  35:B4C8  68                pla
  316  35:B4C9  C9 2F             cmp #$2f
  317  35:B4CB  F0 18             beq .bad_selection      
  318  35:B4CD  48                pha
  319                             
  320  35:B4CE            .check_mp:
  321  35:B4CE  A5 46             lda <.maxLv
  322  35:B4D0  38                sec
  323  35:B4D1  E5 24             sbc <.row
  324  35:B4D3  85 47             sta <.lv
  325                             ;pha
  326  35:B4D5  A6 52             ldx <.iPlayer
  327  35:B4D7  9D C7 7A          sta $7ac7,x
  328                             ;pla
  329  35:B4DA  18                clc
  330  35:B4DB  69 07             adc #7
  331  35:B4DD  65 5F             adc <.playerOffset      ;offset
  332  35:B4DF  A8                tay
  333  35:B4E0  B1 5B             lda [.pPlayer],y        ;mp
  334  35:B4E2  D0 07             bne .cast_allowed
  335  35:B4E4            .bad_selection_pop:     
  336  35:B4E4  68                        pla     ;magic id
  337  35:B4E5            .bad_selection:
  338  35:B4E5  20 81 9B                  jsr requestSoundEffect06        ;9b81
  339  35:B4E8  4C 12 B4                  jmp .magicWindow_inputLoop
  340                     ;$b8bb
  341  35:B4EB            .cast_allowed:
  342  35:B4EB  20 7D 9B          jsr requestSoundEffect05        ;9b7d
  343  35:B4EE  68                pla
  344  35:B4EF  48                pha
  345  35:B4F0  20 55 B5          jsr getMagicTarget      ;$b953  ;get target?
  346  35:B4F3  AA                tax
  347  35:B4F4  F0 07             beq .store_command
  348  35:B4F6  68                        pla
  349  35:B4F7  E0 01                     cpx #1
  350  35:B4F9  F0 EA                     beq .bad_selection
  351  35:B4FB  D0 AC                     bne .magicWindow_close
  352  35:B4FD            .store_command:
  353  35:B4FD  20 9B 9B          jsr setYtoOffset2E      ;9b9b
  354  35:B500  A6 52             ldx <.iPlayer
  355  35:B502  68                pla
  356  35:B503  18                clc
  357  35:B504  69 C8             adc #$c8
  358  35:B506  9D CF 78          sta $78cf,x
  359  35:B509  91 5B             sta [pPlayer],y
  360  35:B50B  C9 FF             cmp #$ff
  361  35:B50D  D0 09             bne .finish
  362  35:B50F  AD E1 7B                  lda $7be1
  363  35:B512  20 20 FD                  jsr flagTargetBit       ;$fd20
  364  35:B515  8D E1 7B                  sta $7be1
  365  35:B518            .finish:
  366  35:B518  E6 52             inc <.iPlayer
  367  35:B51A  D0 8D             bne .magicWindow_close
  368                     ;======================================================================================================
  369  35:B51C            ff3_misc_begin:
  370           0035              .bank   $35
  371           B8FD              .org    $b8fd
  372  35:B8FD                    .ds             $b953 - $b8fd
  373                             ;.org   $b8fd
  374           B51C              .org    ff3_misc_begin
  375  35:B51C            isPlayerAllowedToUseItem:
  376                     ;       [in] u8 $18 : itemid
  377                     ;       [in] u16 $20 : ? itemDataBase = #$9400
  378                     ;       [out] u8 $1c : allowed (1:ok 0:not)
  379                     ;uses:
  380                     ;       u8 $7478[8] : itemParams
  381           0018      .itemId = $18
  382           0020      .baseAddress = $20
  383           001C      .allowed = $1c
  384           7478      .itemParam = $7478
  385           0038      .userType = $38
  386           003B      .userFlags = $3b
  387           0057      .pPlayerBaseParam = $57
  388  35:B51C  A9 08             lda #8
  389  35:B51E  85 1A             sta <$1a
  390  35:B520  A2 78             ldx #$78
  391  35:B522  20 3A BA          jsr loadTo7400FromBank30        ;$ba3a
  392  35:B525  AD 7F 74          lda .itemParam+7
  393  35:B528  29 7F             and #$7f
  394  35:B52A  85 38             sta <.userType
  395  35:B52C  0A                asl a
  396                             ;clc always clearted (&7f ed)
  397  35:B52D  65 38             adc <.userType
  398  35:B52F  AA                tax
  399  35:B530  20 8B FD          jsr $fd8b       ;loadUserFlags
  400  35:B533  20 41 A5          jsr getPlayerOffset     ;$a541
  401  35:B536  A8                tay
  402  35:B537  B1 57             lda [.pPlayerBaseParam],y       ;job
  403                             ;$b93e();
  404  35:B539  48                pha
  405  35:B53A  4A                lsr a
  406  35:B53B  4A                lsr a
  407  35:B53C  4A                lsr a
  408  35:B53D  85 38             sta <$38
  409  35:B53F  A9 02             lda #2
  410  35:B541  38                sec
  411  35:B542  E5 38             sbc <$38
  412  35:B544  AA                tax
  413  35:B545  68                pla
  414  35:B546  29 07             and #7
  415  35:B548  A8                tay
  416  35:B549  B5 3B             lda <.userFlags,x
  417  35:B54B            .move_flag:     
  418  35:B54B  4A                        lsr a
  419  35:B54C  88                        dey
  420  35:B54D  10 FC                     bpl .move_flag
  421  35:B54F  2A                rol a
  422  35:B550  29 01             and #1
  423  35:B552  85 1C             sta <.allowed
  424  35:B554  60                rts
  425                     ;$b93e:
  426                     ;$b953
  427                     ;======================================================================================================
  428                     ;$35:b953 setMagicTarget
  429  35:B555            getMagicTarget:
  430                     ;[in] a
  431           7478      .magicParams = $7478
  432  35:B555  38                sec     ;??
  433  35:B556  85 18             sta <$18
  434  35:B558  8D E8 7C          sta $7ce8
  435                             INIT16 <$20,$98c0
       35:B55B  A9 C0             lda #LOW($98c0)
       35:B55D  85 20             sta <$20
       35:B55F  A9 98             lda #HIGH($98c0)
       35:B561  85 21             sta <$20+1
  436  35:B563  20 1C B5          jsr isPlayerAllowedToUseItem    ;b8fd
  437  35:B566  AE 7C 74          ldx .magicParams+4
  438  35:B569  CA                dex
  439  35:B56A  D0 04             bne .ok
  440  35:B56C  CA                        dex     
  441  35:B56D  8E E8 7C                  stx $7ce8 ;x = $ff
  442  35:B570            .ok:
  443  35:B570  A5 1C             lda <$1c
  444  35:B572  F0 03             beq .finish
  445  35:B574  4C 79 B9                  jmp setActionTargetByParam      ;b979
  446  35:B577            .finish 
  447  35:B577  A9 01             lda #1
  448  35:B579  60                rts
  449                             ;bne $ba29      ;do return
  450                     ;$b979
  451                     ;======================================================================================================
  452  35:B57A            ff3_magic_window_free_begin:
  453           B979      ff3_magic_window_free_end = $b979
  454                     ;------------------------------------------------------------------------------------------------------
  455                     ;quickfix
  456           0034              .bank   $34
  457           8064              .org    $8064
  458  34:8064  20 1C B5          jsr isPlayerAllowedToUseItem
  459                     ;======================================================================================================
  460                             RESTORE_PC ff3_magic_window_free_begin
                0035              .bank   BANK(ff3_magic_window_free_begin)
                B57A              .org    ff3_magic_window_free_begin
  461           029A      ff3_magic_window_size = ff3_magic_window_free_begin - ff3_magic_window_begin
#[3]   ff3_hack_master.asm
#[4]   ff3_window.asm
   41                                     .include "ff3_window.asm"               ;consume( origin )
    1                     ; ff3_window.asm
    2                     ;
    3                     ;       replaces window drawing functions
    4                     ;       performs faster than original
    5                     ;
    6                     ;version:
    7                     ;       0.11 (2006-11-07)
    8                     ;
    9                     ;       $1b,22,23,24,25,26 used in caller (so should be avoided)
   10                     ;
   11                     ;======================================================================================================
   12                     
   13  35:B57A            ff3_window_begin:
   14                     ;------------------------------------------------------------------------------------------------------
   15                     ;shared variables:
   16           0018      pLeftParts = $18
   17           001A      pRightParts = $1a
   18           001A      borderDrawFlags = $1a   ; [in] bit0:draw left, bit1:draw right
   19           001C      updateCounter = $1c             ;incremented by updateCount;if it overflows then stops drawing and waits for nmi
   20           001D      clockCount = $1d                ;indicates required cpu cycle count / 8 (approx.) for drawing line
   21           001E      borderPutFlags = $1e    ; [lrLRxxxx] R:put right border in 2ndBG,l: put left border in 1st BG
   22           001F      lineLen = $1f                   ;total line width without border
   23           0020      drawLen = $20                   ;line length for bg currently drawing
   24           002E      vram = $2e
   25           7AC0      pTileArray = $7ac0      ;see also initTileArrayStorage
   26                     ;------------------------------------------------------------------------------------------------------
   27           0034              .bank   $34
   28           8B38              .org    $8b38   ;-$8d03)
   29  34:8B38                    .ds             $8d03 - $8b38
   30           8B38              .org    $8b38
   31  34:8B38            draw8LineWindow:
   32                     ;args
   33           0018      .left = $18                     ; [in] unit = tiles, bit7 = bg select, border incl
   34           0019      .right = $19            ; [in] unit = tiles, bit7 = bg select, border excl
   35                     ;locals
   36           001C      .maskedLeft = $1c               ;temp
   37           001D      .maskedRight = $1d              ;temp
   38           001E      .crossFlag = $1e                ;temp
   39           78B8      .len_1st = $78b8        ;width without border
   40           78B9      .len_2nd = $78b9        ;width without border
   41           002A      .vram_1st = $2a
   42           002C      .vram_2nd = $2c
   43           0030      .line = $30
   44                     ;---------------------------------------
   45  34:8B38  A5 18             lda <.left
   46                             ;pha
   47  34:8B3A  29 1F             and #$1f
   48  34:8B3C  85 1C             sta <.maskedLeft
   49                             
   50  34:8B3E  A5 19             lda <.right
   51                             ;pha
   52  34:8B40  29 1F             and #$1f
   53  34:8B42  85 1D             sta <.maskedRight
   54                             
   55  34:8B44  A5 18             lda <.left
   56  34:8B46  45 19             eor <.right
   57  34:8B48  30 10             bmi .crosses_boundary
   58                             ;both are in same bg
   59  34:8B4A  A9 C0                     lda #$c0        ;left1st | right1st
   60  34:8B4C  85 1E                     sta <borderPutFlags
   61  34:8B4E  A5 19                     lda <.right
   62  34:8B50  18                        clc     ;to exclude border      
   63  34:8B51  E5 18                     sbc <.left
   64  34:8B53  8D B8 78                  sta .len_1st
   65                                     
   66  34:8B56  A9 00                     lda #0
   67  34:8B58  F0 0E                     beq .store_width
   68  34:8B5A            .crosses_boundary:
   69  34:8B5A  A9 90                     lda #$90        ;left1st | right2nd
   70  34:8B5C  85 1E                     sta <borderPutFlags
   71  34:8B5E  A9 1F                     lda #$1f
   72  34:8B60  38                        sec
   73  34:8B61  E5 1C                     sbc <.maskedLeft
   74  34:8B63  8D B8 78                  sta .len_1st
   75  34:8B66  A5 1D                     lda <.maskedRight
   76  34:8B68            .store_width:           
   77  34:8B68  8D B9 78          sta .len_2nd
   78                     ; --- init 1st bg addr
   79  34:8B6B  18                clc
   80  34:8B6C  A9 60             lda #$60
   81  34:8B6E  85 2C             sta <.vram_2nd          ;2nd bg also have $60 at low byte
   82  34:8B70  65 1C             adc <.maskedLeft
   83  34:8B72  85 2A             sta <.vram_1st
   84  34:8B74  A5 18             lda <.left
   85  34:8B76  30 04             bmi .left_starts_bg1
   86  34:8B78  A9 22                     lda #$22
   87  34:8B7A  D0 02                     bne .store_left_high
   88  34:8B7C            .left_starts_bg1:
   89  34:8B7C  A9 26                     lda #$26                
   90  34:8B7E            .store_left_high:
   91  34:8B7E  69 00             adc #0  ;carry still remains
   92  34:8B80  85 2B             sta <.vram_1st+1                
   93                     ; --- init 2nd bg addr
   94  34:8B82  A5 19             lda <.right
   95  34:8B84  30 04             bmi .right_ends_bg1
   96  34:8B86  A9 22                     lda #$22
   97  34:8B88  D0 02                     bne .store_right_high
   98  34:8B8A            .right_ends_bg1:
   99  34:8B8A  A9 26                     lda #$26        
  100  34:8B8C            .store_right_high:      
  101  34:8B8C  85 2D             sta <.vram_2nd+1
  102                     
  103  34:8B8E  20 54 8C          jsr getBorderParts
  104                     ;here still required vars:
  105                     ;       .vram_1st, .vram_2nd, .len_1st, .len_2nd
  106                     ;       lineLen
  107  34:8B91  AD B8 78          lda .len_1st
  108                     
  109  34:8B94  85 20             sta <drawLen
  110  34:8B96  18                clc
  111  34:8B97  6D B9 78          adc .len_2nd
  112  34:8B9A  85 1F             sta <lineLen
  113                     
  114  34:8B9C  20 7A B5          jsr generateCopyLoopCode
  115  34:8B9F  20 80 FB          jsr waitNmi
  116                     ; --- begin drawing     
  117  34:8BA2  A6 2A             ldx <.vram_1st          ;3
  118  34:8BA4  A5 2B             lda <.vram_1st+1        ;3
  119  34:8BA6  20 32 8C          jsr setVram             ;6+52
  120                             
  121  34:8BA9  AD B8 78          lda .len_1st            ;3
  122  34:8BAC  38                sec                                     ;2
  123  34:8BAD  E5 1F             sbc <lineLen            ;3
  124  34:8BAF  20 D4 8B          jsr .drawOnCurrent      ;6 80
  125                             
  126  34:8BB2  AD B9 78          lda .len_2nd
  127  34:8BB5  D0 01             bne .draw_2nd
  128  34:8BB7  60                        rts
  129  34:8BB8            .draw_2nd:      
  130  34:8BB8  48                        pha     ; len_2nd
  131  34:8BB9  85 20                     sta <drawLen
  132  34:8BBB  06 1E                     asl <borderPutFlags
  133  34:8BBD  06 1E                     asl <borderPutFlags
  134  34:8BBF  20 7A B5                  jsr generateCopyLoopCode
  135                     
  136  34:8BC2  20 80 FB                  jsr waitNmi
  137  34:8BC5  A6 2C                     ldx <.vram_2nd          ;3
  138  34:8BC7  A5 2D                     lda <.vram_2nd+1        ;3
  139  34:8BC9  20 32 8C                  jsr setVram             ;6+52
  140                                     
  141  34:8BCC  68                        pla     ; len_2nd               ;4
  142  34:8BCD  38                        sec                                     ;2
  143  34:8BCE  E5 1F                     sbc <lineLen            ;3
  144  34:8BD0  18                        clc                                     ;2
  145  34:8BD1  6D B8 78                  adc .len_1st            ;4 79
  146                                     ;jmp .drawOnCurrent
  147  34:8BD4            .drawOnCurrent:
  148                     ;[in]   a : initialOffset
  149                     ;.len = $18
  150  34:8BD4  48                pha                                     ;2
  151  34:8BD5  A9 04             lda #4                          ;2      (25>>3)
  152  34:8BD7  85 1C             sta <updateCounter      ;3
  153                             
  154  34:8BD9  A9 F8             lda #$f8        ;topline;2
  155  34:8BDB  A6 20             ldx <drawLen                    ;3
  156  34:8BDD  A0 00             ldy #0                          ;2
  157  34:8BDF  20 FA 8B          jsr putTopBottom        ;6+x
  158  34:8BE2  A2 08             ldx #8                          ;2
  159  34:8BE4  86 30             stx <.line                      ;3
  160                             ;
  161  34:8BE6  68                pla     ;initialOffset  ;4
  162  34:8BE7  A8                tay                                     ;2
  163  34:8BE8            .putLines:
  164                                     ;       1loop:102 + genCode
  165                                     ;genCode:
  166                                     ;       26+76-84/8pixel 16+10  vblank is about 2266clk worth
  167                                     ; 128+9*(cx&7)+11*(cx>>3)
  168  34:8BE8  20 01 79                  jsr genCodeBase ;6+ 78-86/8pixel + ?
  169                     
  170  34:8BEB  20 17 8C                  jsr checkUpdateAndOffsetVram;86 = 6+(28+6+12+34)
  171                                     
  172  34:8BEE  C6 30                     dec <.line              ;4
  173  34:8BF0  A5 30                     lda <.line              ;3
  174  34:8BF2  D0 F4                     bne .putLines   ;3
  175                     ;------
  176  34:8BF4  A9 FD             lda #$fd        ;bottomline
  177  34:8BF6  A6 20             ldx <drawLen
  178  34:8BF8  A0 06             ldy #6
  179                             ;jmp putTopBottom
  180                     ;------------------------------------------------------------------------------------------------------
  181                     ;helpers
  182  34:8BFA            putTopBottom:
  183                     ;[in] a : centerPartTile
  184                     ;[in] x : len_current
  185                     ;[in] y : top(0) or bottom(6)
  186  34:8BFA  48                pha
  187  34:8BFB  24 1E             bit <borderPutFlags
  188  34:8BFD  10 05             bpl .putCenter  ;bpl: bit7 is clear
  189  34:8BFF  B1 18                     lda [pLeftParts],y
  190  34:8C01  8D 07 20                  sta $2007
  191  34:8C04            .putCenter:
  192  34:8C04  68                pla
  193  34:8C05  CA                dex
  194  34:8C06  30 06             bmi .put_right
  195  34:8C08            .putCenter_loop:
  196  34:8C08  8D 07 20                  sta $2007
  197  34:8C0B  CA                        dex
  198  34:8C0C  10 FA                     bpl .putCenter_loop
  199  34:8C0E            .put_right:             
  200  34:8C0E  24 1E             bit <borderPutFlags
  201  34:8C10  50 05             bvc .finish                     ;bvc: bit6 is clear
  202  34:8C12  B1 1A                     lda [pRightParts],y
  203  34:8C14  8D 07 20                  sta $2007
  204  34:8C17            .finish:
  205                             ;jmp checkUpdateAndOffsetVram
  206                     ;-----------------------------------------------------------------------------------------------------
  207  34:8C17            checkUpdateAndOffsetVram:       ;52+28clk(if update skipped)
  208  34:8C17  A5 1C             lda <updateCounter      ;3
  209  34:8C19  18                clc                                     ;2
  210  34:8C1A  65 1D             adc <clockCount ;3
  211  34:8C1C  90 08             bcc .store_counter      ;2+1
  212  34:8C1E  20 3F 8C                  jsr updatePpu   ;6+46
  213  34:8C21  20 80 FB                  jsr waitNmi             ;
  214  34:8C24  A9 00                     lda #0                  ;       (62>>3+1)
  215  34:8C26            .store_counter:
  216  34:8C26  85 1C             sta <updateCounter      ;3
  217                             
  218  34:8C28  A5 2E             lda <vram               ;3
  219  34:8C2A  18                clc                             ;3
  220  34:8C2B  69 20             adc #$20                ;2
  221  34:8C2D  AA                tax                             ;2
  222  34:8C2E  A5 2F             lda <vram+1     ;3
  223  34:8C30  69 00             adc #0                  ;2
  224                             ;fall through
  225  34:8C32            setVram:                ;52clk = 6+12+34
  226  34:8C32  85 2F             sta <vram+1
  227  34:8C34  86 2E             stx <vram
  228  34:8C36            setVramAndInitPpu:      ;+12
  229  34:8C36  2C 02 20          bit $2002       ;reset flip-flop        ;4
  230  34:8C39  8D 06 20          sta $2006       ;vram addr high         ;4
  231  34:8C3C  8E 06 20          stx $2006       ;vram addr low          ;4
  232  34:8C3F            updatePpu:      ;7*4+6  34
  233  34:8C3F  A5 06             lda <ppuCtrl1SetOnNmi                   ;3
  234  34:8C41  8D 00 20          sta $2000       ;ppu ctrl                       ;4
  235  34:8C44  A5 09             lda <ppuCtrl2SetOnNmi
  236  34:8C46  8D 01 20          sta $2001
  237  34:8C49  A5 0C             lda <scrollXSetOnNmi
  238  34:8C4B  8D 05 20          sta $2005
  239  34:8C4E  A5 0D             lda <scrollYSetOnNmi
  240  34:8C50  8D 05 20          sta $2005
  241  34:8C53            doReturn:       
  242  34:8C53  60                rts
  243                     ;------------------------------------------------------------------------------------------------------
  244  34:8C54            getBorderParts:
  245  34:8C54  A5 1A             lda <borderDrawFlags
  246  34:8C56  48                pha
  247  34:8C57  A9 72             lda #LOW(.borderParts)
  248  34:8C59  85 18             sta <pLeftParts
  249  34:8C5B  18                clc
  250  34:8C5C  69 02             adc #2
  251  34:8C5E  85 1A             sta <pRightParts
  252  34:8C60  A9 8C             lda #HIGH(.borderParts)
  253  34:8C62  85 19             sta <pLeftParts+1
  254  34:8C64  85 1B             sta <pRightParts+1
  255                             
  256  34:8C66  68                pla
  257  34:8C67  4A                lsr a
  258  34:8C68  B0 02             bcs .check_right
  259  34:8C6A  E6 18                     inc <pLeftParts ;no border
  260  34:8C6C            .check_right:
  261  34:8C6C  4A                lsr a
  262  34:8C6D  B0 02             bcs .finish
  263  34:8C6F  C6 1A                     dec <pRightParts
  264  34:8C71            .finish:                
  265  34:8C71  60                rts
  266  34:8C72            .borderParts:
  267  34:8C72  F7 F8 F9          .db $f7,$f8,$f9
  268  34:8C75  FA FF FB          .db $fa,$ff,$fb
  269  34:8C78  FC FD FE          .db $fc,$fd,$fe 
  270                     ;------------------------------------------------------------------------------------------------------
  271  34:8C7B            genCode_begin:
  272  34:8C7B            genCode_put_left:
  273  34:8C7B  A9 00             lda #00         ;2
  274  34:8C7D  8D 07 20          sta $2007       ;4
  275  34:8C80            genCode_copyLoop:       
  276  34:8C80  98                tya                     ;2
  277  34:8C81  18                clc                     ;2
  278  34:8C82            genCode_adc_offset:     
  279  34:8C82  69 00             adc #0          ;2 alignOffset + (totalWidth - width)
  280  34:8C84  18                clc                     ;2
  281  34:8C85  A8                tay                     ;2
  282  34:8C86                    genCode_ldx_counter:    
  283  34:8C86  A2 00                     ldx #0  ;2 #(.width_for_bg>>3+1)
  284  34:8C88                    genCode_bne_next:       
  285  34:8C88  D0 1E                     bne genCode_loop_begin  ;3 +alignOffset
  286                             ;here total 15+6(left-border)
  287  34:8C8A            genCode_next:
  288  34:8C8A  98                tya             ;2
  289                             ;clc
  290  34:8C8B  69 08             adc #$8 ;2
  291  34:8C8D  A8                tay             ;2
  292  34:8C8E  90 18             bcc genCode_go_next     ;3
  293                                     ;jsr genCode_updateCode
  294  34:8C90                    genCode_updateCode:
  295  34:8C90  8A                        txa
  296  34:8C91  48                        pha     
  297  34:8C92  AD 00 79                  lda genCode_loopOffset
  298                                     ;clc    always set (as Y was overflowed)
  299  34:8C95  69 2F                     adc #(8*6)-1
  300  34:8C97  AA                        tax
  301  34:8C98                    .update_loop:   
  302  34:8C98  FE 24 79                          inc genCodeBase + (genCode_loop_begin - genCode_copyLoop) + (1 - 6),x
  303  34:8C9B  8A                                txa
  304  34:8C9C  38                                sec
  305  34:8C9D  E9 06                             sbc #6
  306  34:8C9F  AA                                tax
  307  34:8CA0  EC 00 79                          cpx genCode_loopOffset
  308  34:8CA3  D0 F3                             bne .update_loop
  309  34:8CA5  68                        pla
  310  34:8CA6  AA                        tax
  311  34:8CA7  18                        clc     ;to keep carry cleared while loop runs
  312  34:8CA8            genCode_go_next:
  313  34:8CA8            genCode_loop_begin:     ;(4+4)*8
  314  34:8CA8  B9 00 72          lda $7200,y
  315  34:8CAB  8D 07 20          sta $2007
  316                     ;       lda $7201,y
  317                     ;       sta $2007
  318                     ;       lda $7202,y
  319                     ;       sta $2007
  320                     ;       lda $7203,y
  321                     ;       sta $2007
  322                     ;       lda $7204,y
  323                     ;       sta $2007
  324                     ;       lda $7205,y
  325                     ;       sta $2007
  326                     ;       lda $7206,y
  327                     ;       sta $2007
  328                     ;       lda $7207,y
  329                     ;       sta $2007
  330  34:8CAE            genCode_dex:
  331  34:8CAE  CA                dex                     ;2
  332  34:8CAF  D0 AF             bne genCode_next-42     ;3
  333  34:8CB1            genCode_put_right:
  334  34:8CB1  A9 00             lda #00         ;2
  335  34:8CB3  8D 07 20          sta $2007       ;4
  336  34:8CB6            genCode_finish_line:    
  337  34:8CB6  60                rts                     ;6
  338  34:8CB7            genCode_end:    ;21(prolog/epilog)+6(left)+6(right)+ 64~72(loop)+5+7(loop overhead)
  339                     ;------------------------------------------------------------------------------------------------------
  340                     ;here original:$8d03    
  341                     ;------------------------------------------------------------------------------------------------------
  342           0035              .bank BANK(ff3_window_begin)
  343           B57A              .org ff3_window_begin ;$8000 + (ff3_window_begin & $7fff)
  344                     ;------------------------------------------------------------------------------------------------------
  345                     ;genCodeBase = $0121
  346           7901      genCodeBase = TEMP_RAM+1
  347  35:B57A            generateCopyLoopCode:
  348                     ;       [out] clockCount
  349           0021      .alignOffset = $21
  350           7900      genCode_loopOffset = genCodeBase - 1
  351                     ;-----------------------------------
  352  35:B57A  A5 20             lda <drawLen
  353                             ; alignOffset = (7 - width)+1 & 7
  354  35:B57C  49 FF             eor #$ff
  355  35:B57E  18                clc
  356  35:B57F  69 01             adc #1
  357  35:B581  29 07             and #7
  358  35:B583  85 21             sta <.alignOffset
  359                             ;calc required cpu cycle count
  360                             ; 
  361                             ;128+9*(drawLen & 7)+11*(drawLen>>3)
  362  35:B585  A5 20             lda <drawLen
  363  35:B587  85 1D             sta <clockCount
  364  35:B589  0A                asl a
  365                             ;clc    always clear ( drawlen < 3e )
  366  35:B58A  65 1D             adc <clockCount
  367  35:B58C  4A                lsr a
  368  35:B58D  4A                lsr a
  369  35:B58E  4A                lsr a
  370  35:B58F  18                clc
  371  35:B590  65 1D             adc <clockCount
  372  35:B592  69 12             adc #18 ;(128)/8+3
  373  35:B594  85 1D             sta <clockCount
  374                             ;-----------------------------
  375  35:B596  A0 03             ldy #3
  376  35:B598  B1 1A             lda [pRightParts],y
  377  35:B59A  48                pha
  378  35:B59B  B1 18             lda [pLeftParts],y
  379  35:B59D  48                pha
  380                             ;-----------------------------
  381                             ;from here,Y is reserved to 'dest index'
  382  35:B59E  A0 00             ldy #0
  383  35:B5A0  24 1E             bit <borderPutFlags
  384  35:B5A2  10 0E             bpl .copy_loop_code     ;bpl: bit7 is clear
  385  35:B5A4  E6 1D                     inc <clockCount
  386  35:B5A6  A9 05                     lda #(genCode_copyLoop - genCode_put_left)
  387  35:B5A8  A2 00                     ldx #0
  388  35:B5AA  20 3A B6                  jsr copyCodeBytes
  389  35:B5AD  68                        pla
  390  35:B5AE  48                        pha
  391  35:B5AF  8D 02 79                  sta genCodeBase + 1     ;lda #xx
  392  35:B5B2            .copy_loop_code:
  393  35:B5B2  68                pla     ;dummy
  394  35:B5B3  98                tya
  395  35:B5B4  8D 00 79          sta genCode_loopOffset
  396  35:B5B7  A5 20             lda <drawLen
  397  35:B5B9  F0 68             beq .no_center_tiles
  398  35:B5BB  A9 28                     lda #(genCode_loop_begin - genCode_copyLoop)
  399  35:B5BD  A2 05                     ldx #(genCode_copyLoop - genCode_begin)
  400  35:B5BF  20 3A B6                  jsr copyCodeBytes
  401                                     ;--------------------------------------------------------------
  402                                     ;branch target =
  403                                     ; alignOffset*6 from .loop_begin
  404  35:B5C2  A5 21                     lda <.alignOffset
  405  35:B5C4  0A                        asl a
  406                                     ;clc    always clear
  407  35:B5C5  65 21                     adc <.alignOffset
  408  35:B5C7  0A                        asl a
  409                                     ;sec    always clear
  410  35:B5C8  E9 E1                     sbc #((genCode_bne_next+2)-genCode_loop_begin)-1
  411  35:B5CA  99 E2 78                  sta genCodeBase - (genCode_loop_begin - genCode_bne_next) + 1,y
  412                                     ;--------------------------------------------------------------
  413                                     ; loop count =
  414                                     ; (len-1)>>3+1
  415  35:B5CD  A5 20                     lda <drawLen
  416                                     ;sec    always clear (by prev sbc)
  417  35:B5CF  E9 00                     sbc #0
  418  35:B5D1  4A                        lsr a
  419  35:B5D2  4A                        lsr a
  420  35:B5D3  4A                        lsr a
  421  35:B5D4  18                        clc
  422  35:B5D5  69 01                     adc #1
  423  35:B5D7  99 E0 78                  sta genCodeBase - (genCode_loop_begin - genCode_ldx_counter) + 1,y
  424                                     ;--------------------------------------------------------------
  425                                     ; offsetIndex =
  426                                     ; 8+(len-lenCurrent)-align
  427  35:B5DA  A9 09                     lda #8+1
  428                                     ;clc ;always clear (prev adc)
  429  35:B5DC  65 1F                     adc <lineLen
  430  35:B5DE  E5 20                     sbc <drawLen
  431                                     ;sec    ;always set (above sbc)
  432  35:B5E0  E5 21                     sbc <.alignOffset
  433  35:B5E2  99 DC 78                  sta genCodeBase - (genCode_loop_begin - genCode_adc_offset) + 1,y
  434                                     ;----------------------------------------------------------------
  435  35:B5E5  AD C0 7A                  lda pTileArray
  436                                     ;sec    ;always set (above sbc)
  437  35:B5E8  E9 08                     sbc #8
  438  35:B5EA  8D C0 7A                  sta pTileArray
  439  35:B5ED  AD C1 7A                  lda pTileArray+1
  440  35:B5F0  E9 00                     sbc #0
  441  35:B5F2  8D C1 7A                  sta pTileArray+1
  442                                     ;               
  443  35:B5F5  A9 08                     lda #8
  444  35:B5F7                            .unroll_loopBytes:
  445  35:B5F7  48                                pha
  446  35:B5F8  A9 06                             lda #6
  447  35:B5FA  A2 2D                             ldx #(genCode_loop_begin - genCode_begin)
  448  35:B5FC  20 3A B6                          jsr copyCodeBytes
  449                                             ; --- init address
  450  35:B5FF  AD C0 7A                          lda pTileArray
  451  35:B602  18                                clc
  452  35:B603  99 FC 78                          sta genCodeBase + (1 - 6),y
  453  35:B606  69 01                             adc #1  ;post increment
  454  35:B608  8D C0 7A                          sta pTileArray
  455                                             
  456  35:B60B  AD C1 7A                          lda pTileArray+1
  457  35:B60E  99 FD 78                          sta genCodeBase + (2 - 6),y
  458  35:B611  69 00                             adc #0
  459  35:B613  8D C1 7A                          sta pTileArray+1
  460                                             ;-----------------
  461  35:B616  68                                pla
  462  35:B617  38                                sec
  463  35:B618  E9 01                             sbc #1
  464  35:B61A  D0 DB                     bne .unroll_loopBytes
  465                                     
  466  35:B61C  A9 03                     lda #(genCode_put_right - genCode_dex)
  467  35:B61E  A2 33                     ldx #(genCode_dex - genCode_begin)
  468  35:B620  20 3A B6                  jsr copyCodeBytes
  469                                     ;jmp .copy_put_right_code
  470  35:B623            .no_center_tiles:
  471  35:B623            .copy_put_right_code:
  472  35:B623  24 1E             bit <borderPutFlags
  473  35:B625  50 0E             bvc .copy_last  ;bvc: bit6 is clear
  474  35:B627  E6 1D                     inc <clockCount
  475  35:B629  A9 05                     lda #(genCode_finish_line - genCode_put_right)
  476  35:B62B  A2 36                     ldx #(genCode_put_right - genCode_begin)
  477  35:B62D  20 3A B6                  jsr copyCodeBytes
  478  35:B630  68                        pla
  479  35:B631  48                        pha
  480  35:B632  99 FD 78                  sta genCodeBase - 4,y   ;lda #xx
  481  35:B635            .copy_last:
  482  35:B635  68                pla     ;dummy
  483  35:B636  A9 01             lda #(genCode_end - genCode_finish_line)
  484  35:B638  A2 3B             ldx #(genCode_finish_line - genCode_begin)
  485                             ;jmp .copyCodeBytes
  486  35:B63A            copyCodeBytes:
  487                     ;       [in] a : len
  488                     ;       [in] x : sourceOffset
  489                     ;       [in] y : destOffset     
  490           0030      .copyLast = $30
  491  35:B63A  84 30             sty <.copyLast
  492  35:B63C  18                clc
  493  35:B63D  65 30             adc <.copyLast
  494  35:B63F  85 30             sta <.copyLast
  495  35:B641            .copy:
  496  35:B641  BD 7B 8C          lda genCode_begin,x
  497  35:B644  99 01 79          sta genCodeBase,y
  498  35:B647  E8                inx
  499  35:B648  C8                iny
  500  35:B649  C4 30             cpy <.copyLast
  501  35:B64B  D0 F4             bne .copy
  502  35:B64D  60                rts
  503  35:B64E            ff3_window_last:        
  504                     ;------------------------------------------------------------------------------------------------------
  505                             INIT_PATCH $34,$8eb0,$8f0b
                0034              .bank   $34
                8EB0              .org    $8eb0
       34:8EB0                    .ds             (($8f0b) - ($8eb0))
                8EB0              .org    $8eb0
  506  34:8EB0            eraseWindow:
  507           2240      .vram1stBegin = $2240
  508           23A0      .vram1stEnd = $23a0     ;last line begins $2380
  509           2640      .vram2ndBegin = $2640
  510                             ;jsr waitNmi
  511  34:8EB0  20 85 81          jsr presentCharacter
  512  34:8EB3  A2 40             ldx #LOW(.vram1stBegin)
  513  34:8EB5  A9 22             lda #HIGH(.vram1stBegin)
  514  34:8EB7  20 C1 8E          jsr .erase
  515                             ;jsr waitNmi
  516  34:8EBA  20 85 81          jsr presentCharacter
  517  34:8EBD  A2 40             ldx #LOW(.vram2ndBegin)
  518  34:8EBF  A9 26             lda #HIGH(.vram2ndBegin)
  519                             ;fall through
  520  34:8EC1            .erase:
  521  34:8EC1  20 36 8C          jsr setVramAndInitPpu   ;6+52
  522  34:8EC4  A9 00             lda #0
  523  34:8EC6  A2 20             ldx #$20
  524  34:8EC8            .erase_loop:    ;fill 32*11 bytes
  525  34:8EC8  8D 07 20                  sta $2007
  526  34:8ECB  8D 07 20                  sta $2007
  527  34:8ECE  8D 07 20                  sta $2007
  528  34:8ED1  8D 07 20                  sta $2007
  529  34:8ED4  8D 07 20                  sta $2007
  530  34:8ED7  8D 07 20                  sta $2007
  531  34:8EDA  8D 07 20                  sta $2007
  532  34:8EDD  8D 07 20                  sta $2007
  533  34:8EE0  8D 07 20                  sta $2007
  534  34:8EE3  8D 07 20                  sta $2007
  535  34:8EE6  8D 07 20                  sta $2007
  536  34:8EE9  CA                        dex
  537  34:8EEA  D0 DC                     bne .erase_loop
  538  34:8EEC  60                rts
  539                     ;$8f0b
  540                     ;------------------------------------------------------------------------------------------------------
  541           0034              .bank   $34
  542           8F0B              .org    $8f0b
  543  34:8F0B            eraseFromLeftBottom0Bx0A:
  544           0018      .vram = $18
  545                             INIT16 <.vram,$2380
       34:8F0B  A9 80             lda #LOW($2380)
       34:8F0D  85 18             sta <.vram
       34:8F0F  A9 23             lda #HIGH($2380)
       34:8F11  85 19             sta <.vram+1
  546  34:8F13  20 80 FB          jsr waitNmi
  547  34:8F16  A0 0A             ldy #$0a
  548  34:8F18            .erase_loop:
  549  34:8F18  A6 18                     ldx <.vram
  550  34:8F1A  A5 19                     lda <.vram+1
  551  34:8F1C  20 36 8C                  jsr setVramAndInitPpu   ;6+52
  552  34:8F1F  A2 05                     ldx #5
  553  34:8F21  A9 00                     lda #0
  554  34:8F23                    .erase_line:    
  555  34:8F23  8D 07 20                          sta $2007
  556  34:8F26  8D 07 20                          sta $2007
  557  34:8F29  CA                                dex 
  558  34:8F2A  D0 F7                             bne .erase_line
  559  34:8F2C  8D 07 20                  sta $2007
  560                                     SUB16 <.vram,$0020
       34:8F2F  A5 18             lda <.vram
       34:8F31  38                sec
       34:8F32  E9 20             sbc #LOW($0020)
       34:8F34  85 18             sta <.vram
       34:8F36  A5 19             lda <.vram+1
       34:8F38  E9 00             sbc #HIGH($0020)
       34:8F3A  85 19             sta <.vram+1
  561  34:8F3C  88                        dey     
  562  34:8F3D  D0 D9                     bne .erase_loop
  563  34:8F3F  60                rts
  564                     ;=======================================================================================================        
  565                             RESTORE_PC      ff3_window_last
                0035              .bank   BANK(ff3_window_last)
                B64E              .org    ff3_window_last
#[3]   ff3_hack_master.asm
   42                     
#[4]   ff3_command_04.asm
   43                                     .include "ff3_command_04.asm"   ;consume( genCode_end, getCommandInput_end )
    1                     ; ff3_command_04.asm
    2                     ;
    3                     ;description:
    4                     ;       patches calculations for command 04 ('fight')
    5                     ;       implements 'counter attack' feature
    6                     ;
    7                     ;version:
    8                     ;       0.07 (2006-10-29)
    9                     ;
   10                     ;======================================================================================================
   11  35:B64E            ff3_command_04_begin:
   12                             ;INIT_PATCH $35,$a104,$a212
   13                             INIT_PATCH $35,$a104,$a353
                0035              .bank   $35
                A104              .org    $a104
       35:A104                    .ds             (($a353) - ($a104))
                A104              .org    $a104
   14  35:A104            command_fight:
   15           0018      .actorIndex = $18
   16           001A      .knightHps = $1a
   17           0022      .cHealthyKnight = $22
   18           0052      .iPlayer = $52
   19           0057      .pPlayerBaseParams = $57
   20           0059      .pEquips = $59
   21           005B      .pPlayerParams = $5b
   22           005F      .playerOffset = $5f
   23           006E      .pActor = $6e
   24           0070      .pTarget = $70
   25           7CEC      .nearlyDeadFlag = $7cec ;probably (not yet confirmed)
   26                     
   27  35:A104  20 2E A4          jsr getActor2C  ;a42e
   28                             ;bpl .actor_is_player_char
   29  35:A107  30 03             bmi .actor_is_enemy     
   30  35:A109  4C 9C A1          jmp .actor_is_player_char
   31  35:A10C            .actor_is_enemy 
   32                                     ;enemy
   33  35:A10C  B1 70                     lda [.pTarget],y
   34  35:A10E  29 07                     and #7
   35  35:A110  85 18                     sta <.actorIndex
   36  35:A112  AA                        tax
   37  35:A113  AD EC 7C                  lda .nearlyDeadFlag
   38  35:A116  20 38 FD                  jsr maskTargetBit
   39  35:A119  F0 4D                     beq .bump
   40                     
   41  35:A11B  A9 C0                     lda #$c0        ;dead|stone
   42  35:A11D  A2 21                     ldx #$21        ;confused|jumping
   43  35:A11F  20 27 9A                  jsr isTargetNotInStatus
   44  35:A122  90 72                     bcc .finish_protect_check
   45                                             ;ok
   46                                             ;a == 0 (naturally)
   47  35:A124  85 22                             sta <.cHealthyKnight
   48  35:A126                            .check_protect:
   49  35:A126  A2 03                             ldx #3
   50  35:A128  86 52                             stx <.iPlayer
   51  35:A12A                            .find_healthy_knight:
   52                                                     
   53  35:A12A  A5 52                                     lda <.iPlayer
   54  35:A12C  0A                                        asl a
   55  35:A12D  AA                                        tax
   56  35:A12E  95 24                                     sta <$24,x
   57  35:A130  A9 00                                     lda #0
   58  35:A132  95 1A                                     sta <.knightHps,x
   59  35:A134  95 1B                                     sta <.knightHps+1,x
   60                                                     
   61  35:A136  20 41 A5                                  jsr getPlayerOffset     ;a541   ;x,y unchanged
   62                     
   63  35:A139  A9 3C                                     lda #EXTRA_ABILITY_OFFSET
   64  35:A13B  20 88 9B                                  jsr setYtoOffsetOf
   65  35:A13E  B1 5B                                     lda [.pPlayerParams],y
   66  35:A140  29 20                                     and #PASSIVE_PROTECT
   67  35:A142  F0 1E                                     beq .find_next
   68                                                     
   69  35:A144  A9 01                                     lda #1
   70  35:A146  20 88 9B                                  jsr setYtoOffsetOf
   71                                                     ;iny    ;+01
   72  35:A149  B1 5B                                     lda [.pPlayerParams],y
   73  35:A14B  29 C1                                     and #$c1
   74  35:A14D  D0 13                                     bne .find_next
   75                                                     
   76  35:A14F  C8                                        iny     ;+02
   77  35:A150  B1 5B                                     lda [.pPlayerParams],y
   78  35:A152  29 E0                                     and #$e0
   79  35:A154  D0 0C                                     bne .find_next
   80                                                             ;ok
   81  35:A156  C8                                                iny     ;setYtoOffset03
   82  35:A157  B1 5B                                             lda [.pPlayerParams],y
   83  35:A159  95 1A                                             sta <.knightHps,x
   84  35:A15B  C8                                                iny
   85  35:A15C  B1 5B                                             lda [.pPlayerParams],y
   86  35:A15E  95 1B                                             sta <.knightHps+1,x
   87  35:A160  E6 22                                             inc <.cHealthyKnight
   88  35:A162                                    .find_next:
   89  35:A162  C6 52                                     dec <.iPlayer
   90  35:A164  10 C4                                     bpl .find_healthy_knight
   91                     ;$a175:
   92  35:A166  A5 22                             lda <.cHealthyKnight
   93  35:A168            .bump:
   94  35:A168  F0 2C                             beq .finish_protect_check
   95  35:A16A  20 B7 8C                                  jsr getIndexOfGreatest  ;a30f
   96                                                     ;lda #0
   97                                                     ;jsr flagTargetBit      ;fd20
   98  35:A16D  20 AD 9F                                  jsr flagSingleTarget
   99                                                     
  100  35:A170  8D 99 7E                                  sta $7e99
  101  35:A173  8D DF 7E                                  sta play_protectionTargetBits   ;$7edf
  102                                                     
  103  35:A176  A6 18                                     ldx <.actorIndex
  104                                                     ;lda #0
  105                                                     ;jsr flagTargetBit
  106  35:A178  20 AD 9F                                  jsr flagSingleTarget
  107  35:A17B  8D E0 7E                                  sta $7ee0
  108                                                     
  109  35:A17E  A5 5F                                     lda <.playerOffset
  110  35:A180  18                                        clc
  111  35:A181  69 75                                     adc #$75
  112  35:A183  85 70                                     sta <.pTarget
  113  35:A185  A9 00                                     lda #0
  114  35:A187  69 75                                     adc #$75
  115  35:A189  85 71                                     sta <.pTarget+1
  116                                                     
  117  35:A18B  A0 33                                     ldy #$33
  118  35:A18D  B1 70                                     lda [.pTarget],y
  119  35:A18F  8D E3 7C                                  sta $7ce3       ;save
  120  35:A192  29 FE                                     and #$fe        ;clear 'at backline' flag
  121  35:A194  91 70                                     sta [.pTarget],y
  122  35:A196            .finish_protect_check:
  123                                     ;extra
  124  35:A196  20 59 A2                  jsr checkCounter
  125  35:A199  90 06                     bcc command_fight_doCalc
  126  35:A19B  60                                rts
  127                     ;a1ac
  128  35:A19C            .actor_is_player_char:
  129  35:A19C            command_fight_setupWeaponParam:
  130           0052      .iPlayer = $52
  131  35:A19C  29 07             and #7  ;index
  132  35:A19E  20 EE A2          jsr setupWeaponId
  133                     ;a212:
  134  35:A1A1            command_fight_doCalc:
  135           0052      .iPlayer = $52
  136           006E      .pActor = $6e
  137           0070      .pTarget = $70
  138  35:A1A1  20 1E 80          jsr dispatchBattleFunction_03   ;801e
  139                     
  140  35:A1A4  AD DF 7E          lda play_protectionTargetBits
  141  35:A1A7  F0 0F             beq .sum_hit_count
  142  35:A1A9  AE EE 78                  ldx battleMessageCount  ;78ee
  143  35:A1AC  A9 52                     lda #$52        ;"ナイトが みをていして かばった！"
  144  35:A1AE  9D DA 78                  sta battleMessages,x
  145  35:A1B1  AD EA 7C                  lda $7cea
  146  35:A1B4  A0 33                     ldy #$33
  147  35:A1B6  91 70                     sta [.pTarget],y
  148                     
  149  35:A1B8            .sum_hit_count:
  150           007C      .hitCountRight = $7c
  151           007D      .hitCountLeft = $7d
  152           00E0      .targetStatusCache = $e0
  153           00F0      .actorStatusCache = $f0
  154  35:A1B8  18                clc
  155  35:A1B9  A5 7C             lda <.hitCountRight
  156  35:A1BB  65 7D             adc <.hitCountLeft
  157  35:A1BD  C9 21             cmp #33
  158  35:A1BF  90 02             bcc .store_count
  159  35:A1C1  A9 20                     lda #32
  160  35:A1C3            .store_count:
  161  35:A1C3  8D D7 78          sta actionName  ;78d7
  162                             
  163  35:A1C6  A6 64             ldx <$64
  164  35:A1C8  B5 E0             lda <.targetStatusCache,x
  165  35:A1CA  30 4E             bmi .target_is_dead
  166                             ;alive
  167  35:A1CC  AD D7 78          lda actionName  
  168  35:A1CF  F0 59             beq .consume_item       ;miss
  169                             ;alive && hit
  170  35:A1D1  E8                inx
  171  35:A1D2  B5 E0             lda <.targetStatusCache,x
  172  35:A1D4  A0 02             ldy #2
  173  35:A1D6  29 18             and #$18
  174                             ;beq .check_death       ;target is alive (already checked)
  175  35:A1D8  F0 50             beq .consume_item       ;status unchanged
  176                                     ;18 10 08
  177  35:A1DA  38                        sec
  178  35:A1DB  E9 08                     sbc #8
  179  35:A1DD  D0 30                     bne .update_status      ;a295
  180                     ;$a254:
  181  35:A1DF  B5 E0                             lda <.targetStatusCache,x
  182  35:A1E1  48                                pha
  183  35:A1E2  29 07                             and #7
  184  35:A1E4  95 E0                             sta <.targetStatusCache,x
  185  35:A1E6  91 70                             sta [.pTarget],y
  186  35:A1E8  20 1A 9A                          jsr isTargetActor
  187  35:A1EB  D0 08                             bne .get_status_name
  188  35:A1ED  B5 E0                                     lda <.targetStatusCache,x
  189  35:A1EF  95 F0                                     sta <.actorStatusCache,x
  190  35:A1F1  A0 02                                     ldy #2
  191  35:A1F3  91 6E                                     sta [.pActor],y
  192  35:A1F5                            .get_status_name:
  193  35:A1F5  68                                pla
  194  35:A1F6  A2 01                             ldx #$01
  195  35:A1F8                            .find_first_set:
  196  35:A1F8  E8                                        inx
  197  35:A1F9  0A                                        asl a
  198  35:A1FA  90 FC                                     bcc .find_first_set
  199                     ;a27e
  200  35:A1FC  8E D9 78                  stx effectMessage       ;78d9
  201                                     ;jsr clearTargetAction
  202  35:A1FF  A0 2C                             ldy #$2c
  203  35:A201  B1 70                             lda [.pTarget],y
  204  35:A203  29 E7                             and #$e7
  205  35:A205  91 70                             sta [.pTarget],y
  206  35:A207  C8                                iny
  207  35:A208  C8                                iny
  208  35:A209  A9 00                             lda #0
  209  35:A20B  91 70                             sta [.pTarget],y
  210  35:A20D  F0 1B                     beq .consume_item       ;always satisfied (cleartargetaction)
  211                     
  212  35:A20F                    .update_status: ;a295
  213  35:A20F  B5 E0                     lda <.targetStatusCache,x
  214  35:A211  38                        sec
  215  35:A212  E9 08                     sbc #8
  216  35:A214  95 E0                     sta <.targetStatusCache,x
  217  35:A216  91 70                     sta [.pTarget],y
  218  35:A218  B0 10                     bcs .consume_item       ;alwasy set
  219  35:A21A            .target_is_dead:
  220  35:A21A  A0 2C                     ldy #$2c
  221  35:A21C  A2 1A                     ldx #$1a        ;"しんでしまった!"
  222  35:A21E  B1 70                     lda [.pTarget],y
  223  35:A220  10 01                     bpl .store_death_message
  224  35:A222  E8                                inx             ;"てきをたおした!"
  225  35:A223                    .store_death_message:
  226  35:A223  8A                        txa
  227  35:A224  AE EE 78                  ldx battleMessageCount
  228  35:A227  9D DA 78                  sta battleMessages,x
  229                     
  230  35:A22A            .consume_item: ;a2b7
  231           0024      .recalcRequired = $24
  232  35:A22A  A9 00             lda #0
  233  35:A22C  8D D5 78          sta battleProcessType   ;78d5
  234  35:A22F  85 24             sta <.recalcRequired
  235  35:A231  20 2E A4          jsr getActor2C
  236  35:A234  30 22             bmi .finish
  237                     ;$a2c3  
  238  35:A236  29 07                     and #7
  239  35:A238  85 52                     sta <.iPlayer
  240  35:A23A  20 41 A5                  jsr getPlayerOffset
  241  35:A23D  A9 01                     lda #1
  242  35:A23F  20 32 A3                  jsr consumeIfArrow
  243  35:A242  A9 02                     lda #2
  244  35:A244  20 32 A3                  jsr consumeIfArrow
  245  35:A247  A9 03                     lda #3
  246  35:A249  20 44 A3                  jsr consumeIfShuriken
  247  35:A24C  A9 05                     lda #5
  248  35:A24E  20 44 A3                  jsr consumeIfShuriken
  249                     ;$a307:
  250  35:A251  A5 24                     lda <.recalcRequired
  251  35:A253  F0 03                     beq .finish
  252  35:A255  4C 26 80                          jmp dispatchBattleFunction_05
  253  35:A258            .finish:
  254  35:A258            command_fight_doReturn:
  255  35:A258  60                rts
  256                     ;$a30f
  257                     ;------------------------------------------------------------------------------------------------------
  258  35:A259            checkCounter:   ;extra
  259                     ;out] bool carry : (countered : 1)
  260           0018      .rand = $18
  261           0052      .iPlayer = $52
  262           0057      .pPlayerBaseParams = $57
  263           0059      .pEquips = $59
  264           005B      .pPlayerParams = $5b
  265           006E      .pActor = $6e
  266           0070      .pTarget = $70
  267  35:A259  20 23 9A          jsr isTargetActive
  268  35:A25C  90 FA             bcc command_fight_doReturn
  269  35:A25E  20 36 9A          jsr setXtoTargetIndex
  270  35:A261  A0 3C             ldy #EXTRA_ABILITY_OFFSET
  271  35:A263  B1 70             lda [.pTarget],y
  272                             ;and #PASSIVE_COUNTER = 80
  273  35:A265  18                clc
  274           0000              .ifdef TEST_COUNTER_ATTACK
  276                             .else
  277  35:A266  10 F0                     bpl command_fight_doReturn
  278  35:A268            .calc_rate:
  279  35:A268  8A                        txa
  280  35:A269  48                        pha
  281  35:A26A  A9 64                     lda #100
  282  35:A26C  20 64 A5                  jsr getSys1Random
  283  35:A26F  85 18                     sta <.rand
  284                                     ;%success = 25 + joblv>>1
  285  35:A271  68                        pla
  286  35:A272  AA                        tax     ;index
  287  35:A273  A0 0F                     ldy #$0f
  288  35:A275  B1 70                     lda [.pTarget],y        ;joblv
  289  35:A277  4A                        lsr a
  290  35:A278  18                        clc
  291  35:A279  69 19                     adc #25
  292  35:A27B  C5 18                     cmp <.rand
  293  35:A27D  90 6E                     bcc .finish
  294                             .endif ;TEST_COUNTER_ATTACK
  295                     
  296  35:A27F            .doCounter:
  297                             ;x = target index
  298  35:A27F  20 AD 9F          jsr flagSingleTarget
  299                             
  300  35:A282  8D 98 7E          sta play_actorBits
  301                             ;lda play_effectTargetSide
  302                             ;ora #$c1       ;original uses higher 2bit.
  303  35:A285  A9 41             lda #$41
  304  35:A287  8D 9A 7E          sta play_effectTargetSide
  305                                     
  306  35:A28A  20 DD A2          jsr .swapActorAndTarget
  307                             
  308  35:A28D  AC EE 78          ldy battleMessageCount
  309  35:A290  A9 59             lda #EXMSG_COUNTER
  310  35:A292  99 DA 78          sta battleMessages,y
  311  35:A295  C8                iny
  312  35:A296  8C EE 78          sty battleMessageCount
  313                             ;
  314  35:A299  20 36 9A          jsr setXtoTargetIndex
  315  35:A29C  20 AD 9F          jsr flagSingleTarget
  316  35:A29F  8D 9B 7E          sta play_effectTargetBits       ;damage
  317  35:A2A2  8D 99 7E          sta play_castTargetBits         ;blow
  318                     
  319  35:A2A5  A0 2F             ldy #$2f
  320  35:A2A7  B1 6E             lda [.pActor],y ;target bit
  321  35:A2A9  48                pha     
  322                     
  323  35:A2AA  C8                iny
  324  35:A2AB  B1 6E             lda [.pActor],y
  325  35:A2AD  48                pha
  326                     
  327  35:A2AE  A9 80             lda #$80        ;force enemy
  328  35:A2B0  91 6E             sta [.pActor],y
  329                     
  330  35:A2B2  A0 28             ldy #$28
  331  35:A2B4  B1 6E             lda [.pActor],y
  332  35:A2B6  48                pha
  333  35:A2B7  A9 32             lda #50
  334  35:A2B9  91 6E             sta [.pActor],y
  335                             
  336  35:A2BB  20 2E A4          jsr getActor2C
  337  35:A2BE  20 9C A1          jsr command_fight_setupWeaponParam;command_fight_doCalc
  338                             
  339  35:A2C1  68                pla
  340  35:A2C2  A0 28             ldy #$28
  341  35:A2C4  91 6E             sta [.pActor],y ;critical
  342                             
  343  35:A2C6  A0 30             ldy #$30
  344  35:A2C8  68                pla
  345  35:A2C9  91 6E             sta [.pActor],y ;target flag
  346                             
  347  35:A2CB  88                dey
  348  35:A2CC  68                pla
  349  35:A2CD  91 6E             sta [.pActor],y ;target bit
  350                     
  351  35:A2CF  A2 0F             ldx #$0f
  352  35:A2D1            .swap_status_cache:
  353  35:A2D1  B4 E0             ldy <$e0,x
  354  35:A2D3  B5 F0             lda <$f0,x
  355  35:A2D5  95 E0             sta <$e0,x
  356  35:A2D7  94 F0             sty <$f0,x
  357  35:A2D9  CA                dex
  358  35:A2DA  10 F5             bpl .swap_status_cache
  359  35:A2DC  38                sec     ;[out] countered
  360  35:A2DD            .swapActorAndTarget:
  361  35:A2DD  A6 6E             ldx <.pActor
  362  35:A2DF  A5 70             lda <.pTarget
  363  35:A2E1  86 70             stx <.pTarget
  364  35:A2E3  85 6E             sta <.pActor
  365  35:A2E5  A6 6F             ldx <.pActor+1
  366  35:A2E7  A5 71             lda <.pTarget+1
  367  35:A2E9  86 71             stx <.pTarget+1
  368  35:A2EB  85 6F             sta <.pActor+1
  369  35:A2ED            .finish:
  370  35:A2ED  60                rts
  371                     ;------------------------------------------------------------------------------------------------------
  372                     
  373  35:A2EE            setupWeaponId:
  374                     ;[in] u8 a : index
  375           0052      .iPlayer = $52
  376           0059      .pEquips = $59
  377           006E      .pActor = $6e
  378           0070      .pTarget = $70
  379                     ;[out]
  380           7E1F      .righthand = $7e1f
  381           7E20      .lefthand = $7e20
  382                     ;       and #7
  383  35:A2EE  85 52             sta <.iPlayer
  384  35:A2F0  A2 00             ldx #0
  385  35:A2F2  8E 20 7E          stx .lefthand
  386  35:A2F5  8E 1F 7E          stx .righthand
  387  35:A2F8  A0 01             ldy #1
  388  35:A2FA  B1 6E             lda [.pActor],y
  389  35:A2FC  29 28             and #$28
  390  35:A2FE  D0 31             bne .finish     ;toad | minimum
  391                                     ;ok
  392  35:A300  20 41 A5                  jsr getPlayerOffset     ;a541
  393  35:A303  20 8D 9B                  jsr setYtoOffset03
  394  35:A306  B1 59                     lda [.pEquips],y
  395  35:A308  20 DB 8C                  jsr filterShield
  396  35:A30B  8D 1F 7E                  sta .righthand
  397                     
  398  35:A30E  C8                        iny
  399  35:A30F  C8                        iny
  400  35:A310  B1 59                     lda [.pEquips],y
  401  35:A312  20 DB 8C                  jsr filterShield
  402  35:A315  8D 20 7E                  sta .lefthand
  403                                     
  404  35:A318  F0 05                     beq .either_empty
  405  35:A31A  AD 1F 7E                  lda .righthand
  406  35:A31D  D0 12                     bne .finish
  407  35:A31F            .either_empty:
  408                                             ;at least either lefthand or righthand is empty or shield
  409  35:A31F  AD 20 7E                          lda .lefthand
  410  35:A322  20 D7 8C                          jsr filterBowArrow
  411  35:A325  8D 20 7E                          sta .lefthand
  412  35:A328  AD 1F 7E                          lda .righthand
  413  35:A32B  20 D7 8C                          jsr filterBowArrow
  414  35:A32E  8D 1F 7E                          sta .righthand
  415  35:A331            .finish:
  416  35:A331  60                rts
  417                     ;------------------------------------------------------------------------------------------------------
  418  35:A332            consumeIfArrow:
  419                     ;a = 1 : right, 2 : left
  420           005B      .pPlayerParams = $5b
  421  35:A332  AA                tax
  422  35:A333  18                clc
  423  35:A334  69 30             adc #$30
  424  35:A336  20 88 9B          jsr setYtoOffsetOf
  425  35:A339  B1 5B             lda [.pPlayerParams],y
  426  35:A33B  29 04             and #$04        ;arrow flag
  427  35:A33D  F0 27             beq $a366       ;.finish
  428  35:A33F  E8                        inx
  429  35:A340  8A                        txa
  430  35:A341  0A                        asl a
  431  35:A342  D0 0F                     bne consumeEquippedItem
  432                     ;------------------------------------------------------------------------------------------------------
  433  35:A344            consumeIfShuriken:
  434           0059      .pEquips = $59
  435  35:A344  AA                tax
  436  35:A345  20 88 9B          jsr setYtoOffsetOf
  437  35:A348  B1 59             lda [.pEquips],y
  438  35:A34A  C9 41             cmp #$41        ;shuriken
  439  35:A34C  D0 18             bne $a366 ;.finish
  440  35:A34E  E8                        inx
  441  35:A34F  8A                        txa
  442  35:A350  D0 01                     bne consumeEquippedItem
  443                     ;$a353
  444                     ;------------------------------------------------------------------------------------------------------
  445                             RESTORE_PC      genCode_end
                0034              .bank   BANK(genCode_end)
                8CB7              .org    genCode_end
  446                     ;------------------------------------------------------------------------------------------------------
  447                             ;INIT_PATCH $35,$a30f,$a353
  448  34:8CB7            getIndexOfGreatest:     ;original:a30f
  449           001A      .values = $1a
  450           0024      .indices = $24
  451           0052      .iPlayer = $52
  452  34:8CB7  A0 05             ldy #5
  453  34:8CB9  A2 07             ldx #7
  454  34:8CBB            .find_max:
  455  34:8CBB  38                        sec
  456  34:8CBC  B5 19                     lda <.values-1,x
  457  34:8CBE  F9 19 00                  sbc .values-1,y
  458  34:8CC1  B5 1A                     lda <.values,x
  459  34:8CC3  F9 1A 00                  sbc .values,y
  460  34:8CC6  B0 02                     bcs .next
  461                                     ;16bit value at y is greater than value at x
  462  34:8CC8  98                                tya
  463  34:8CC9  AA                                tax
  464  34:8CCA                    .next:
  465  34:8CCA  88                        dey
  466  34:8CCB  88                        dey
  467  34:8CCC  10 ED                     bpl .find_max
  468                     ;now x is index of the greatest value
  469  34:8CCE  B5 23             lda <.indices-1,x
  470  34:8CD0  4A                lsr a
  471  34:8CD1  85 52             sta <.iPlayer
  472  34:8CD3  AA                tax
  473  34:8CD4  4C 41 A5          jmp getPlayerOffset
  474                     ;------------------------------------------------------------------------------------------------------
  475  34:8CD7            filterBowArrow:
  476  34:8CD7  A2 03             ldx #3
  477  34:8CD9  D0 02             bne filterByItemKind
  478  34:8CDB            filterShield:
  479  34:8CDB  A2 05             ldx #5  
  480  34:8CDD            filterByItemKind:
  481                     ;a :itemid
  482                     ;x : bound
  483           0018      .bound = $18
  484  34:8CDD  86 18             stx <.bound
  485  34:8CDF  48                pha
  486  34:8CE0  20 28 B0          jsr idToKind
  487  34:8CE3  E4 18             cpx <.bound
  488  34:8CE5  90 04             bcc .valid
  489  34:8CE7  68                        pla
  490  34:8CE8  A9 00                     lda #0
  491  34:8CEA  60                        rts
  492  34:8CEB            .valid:
  493  34:8CEB  68                pla
  494  34:8CEC  60                rts
  495                     ;------------------------------------------------------------------------------------------------------
  496  34:8CED            set52toEffectTargetIndex:
  497  34:8CED  A2 01             ldx #1
  498  34:8CEF  20 AB 86          jsr targetBitToCharIndex
  499  34:8CF2  84 52             sty <$52
  500  34:8CF4  60                rts     
  501                     ;------------------------------------------------------------------------------------------------------
  502                             RESTORE_PC      getCommandInput_end
                0034              .bank   BANK(getCommandInput_end)
                9A1A              .org    getCommandInput_end
  503  34:9A1A            isTargetActor:
  504           006E      .pActor = $6e
  505           0070      .pTarget = $70
  506                     ;.actor = $18
  507  34:9A1A  A0 2C             ldy #$2c
  508  34:9A1C  B1 6E             lda [.pActor],y
  509  34:9A1E  51 70             eor [.pTarget],y
  510  34:9A20  29 87             and #$87
  511  34:9A22  60                rts
  512                     ;------------------------------------------------------------------------------------------------------
  513  34:9A23            isTargetActive:
  514  34:9A23  A9 C0             lda #$c0        ;dead | stone
  515  34:9A25  A2 E1             ldx #$e1        ;paralyzed | sleeping | confused | jumping
  516  34:9A27            isTargetNotInStatus:
  517                     ;[in] a = status00, x = status01
  518                     ;[out] carry : 
  519           0070      .pTarget = $70
  520  34:9A27  18                clc
  521  34:9A28  A0 01             ldy #1
  522  34:9A2A  31 70             and [.pTarget],y
  523  34:9A2C  D0 07             bne .finish
  524                             
  525  34:9A2E  C8                iny
  526  34:9A2F  8A                txa
  527  34:9A30  31 70             and [.pTarget],y
  528  34:9A32  D0 01             bne .finish
  529  34:9A34  38                sec
  530  34:9A35            .finish:
  531  34:9A35  60                rts
  532                     ;------------------------------------------------------------------------------------------------------
  533  34:9A36            setXtoTargetIndex:
  534           0070      .pTarget = $70
  535  34:9A36  A0 2C             ldy #$2c
  536  34:9A38  B1 70             lda [.pTarget],y
  537  34:9A3A  29 07             and #$07
  538  34:9A3C  AA                tax
  539  34:9A3D  60                rts
  540                     ;$9a40
  541                     ;======================================================================================================
  542                             INIT_PATCH $34,$8613,$8689
                0034              .bank   $34
                8613              .org    $8613
       34:8613                    .ds             (($8689) - ($8613))
                8613              .org    $8613
  543  34:8613            playEffect_fight:       ;function00
  544  34:8613  A2 00             ldx #0
  545  34:8615  8E 96 7E          stx $7e96
  546  34:8618  20 AB 86          jsr targetBitToCharIndex        ;86ab
  547  34:861B  AD 9A 7E          lda play_effectTargetSide       ;7e9a
  548  34:861E  10 10             bpl .actor_is_player_char
  549  34:8620  20 45 85                  jsr dispatchPresentScene_1f     ;8545
  550  34:8623  A9 20                     lda #$20
  551  34:8625  20 6E 86                  jsr .showBlowEffect
  552  34:8628  20 ED 8C                  jsr set52toEffectTargetIndex
  553  34:862B            .show_hit_effect:
  554  34:862B  A9 14                     lda #$14
  555  34:862D  4C 0E FA                  jmp call_2e_9d53
  556  34:8630            .actor_is_player_char:  ;8647
  557  34:8630  84 52                     sty <$52
  558  34:8632  29 01                     and #1
  559  34:8634  F0 11                     beq .do_usually
  560  34:8636  AD 98 7E                          lda play_actorBits
  561  34:8639  48                                pha
  562  34:863A  AD 9B 7E                          lda play_effectTargetBits
  563  34:863D  8D 98 7E                          sta play_actorBits
  564  34:8640  20 45 85                          jsr dispatchPresentScene_1f     ;
  565  34:8643  68                                pla
  566  34:8644  8D 98 7E                          sta play_actorBits
  567  34:8647                    .do_usually:
  568  34:8647  A9 12                     lda #$12
  569  34:8649  20 6E 86                  jsr .showBlowEffect
  570                                     
  571  34:864C  EE 96 7E                  inc $7e96
  572  34:864F  A5 BB                     lda <$bb
  573  34:8651  48                        pha
  574  34:8652  A5 BC                     lda <$bc
  575  34:8654  48                        pha
  576  34:8655  A9 00                     lda #0
  577  34:8657  85 BB                     sta <$bb
  578  34:8659  85 BC                     sta <$bc
  579  34:865B  A9 12                     lda #$12
  580  34:865D  20 0E FA                  jsr call_2e_9d53
  581                                     
  582  34:8660  20 ED 8C                  jsr set52toEffectTargetIndex
  583                                     
  584  34:8663  68                        pla
  585  34:8664  85 BC                     sta <$bc
  586  34:8666  68                        pla
  587  34:8667  85 BB                     sta <$bb
  588  34:8669  05 BC                     ora <$bc
  589  34:866B  D0 BE                     bne .show_hit_effect
  590  34:866D  60                        rts
  591                     ;------------------------------------------------------------------------------------------------------
  592  34:866E            .showBlowEffect:
  593                     ;[in] a : type ( enemy = 20, player = 12
  594  34:866E  AE 6F 7E          ldx $7e6f
  595  34:8671  F0 0E             beq .finish
  596  34:8673  48                        pha
  597  34:8674  A2 01                     ldx #1
  598  34:8676  20 AB 86                  jsr targetBitToCharIndex        ;86ab
  599  34:8679  84 B8                     sty <$b8
  600  34:867B  68                        pla
  601  34:867C  20 0E FA                  jsr call_2e_9d53
  602  34:867F  68                        pla     ;retaddr
  603  34:8680  68                        pla     ;retaddr
  604  34:8681            .finish:
  605  34:8681  60                rts
  606                     ;$868a:
  607                     ;======================================================================================================
  608  34:8682            ff3_command_04_end:
  609                             RESTORE_PC ff3_command_04_begin
                0035              .bank   BANK(ff3_command_04_begin)
                B64E              .org    ff3_command_04_begin
#[3]   ff3_hack_master.asm
#[4]   ff3_command_13.asm
   44                                     .include "ff3_command_13.asm"   ;save
    1                     ; ff3_command_13.asm
    2                     ;
    3                     ; description:
    4                     ;       replaces command 13 (useItem)
    5                     ;
    6                     ; version:
    7                     ;       0.05 (2006-10-28)
    8                     ;======================================================================================================
    9  35:B64E            ff3_command_13_begin:
   10                             INIT_PATCH $31,$a65e,$a732
                0031              .bank   $31
                A65E              .org    $a65e
       31:A65E                    .ds             (($a732) - ($a65e))
                A65E              .org    $a65e
   11  31:A65E            setupItemCalculation:   ;$31:a65e useItem //dispid:04 [battleFunction04]
   12                     ;[in]
   13           001A      .actionId = $1a
   14           006E      .pActor = $6e
   15           0070      .pTarget = $70
   16                     ;---------------------------------------
   17  31:A65E  A0 01             ldy #1
   18  31:A660  8C D5 78          sty battleProcessType
   19  31:A663  85 72             sta <$72
   20  31:A665  85 4B             sta <$4b
   21  31:A667  A9 14             lda #$14
   22  31:A669  8D C2 7E          sta $7ec2
   23  31:A66C  A5 1A             lda <.actionId
   24  31:A66E  8D D7 78          sta actionName
   25  31:A671  C9 98             cmp #$98        ;magical key
   26  31:A673  B0 27             bcs .not_equip
   27           001A      .pItemParam = $1a
   28  31:A675  A2 08                     ldx #8
   29  31:A677  20 D6 FC                  jsr mul_8x8     ;y is unchanged
   30  31:A67A  18                        clc
   31  31:A67B  A5 1B                     lda <.pItemParam+1
   32  31:A67D  69 94                     adc #$94
   33  31:A67F  85 1B                     sta <.pItemParam+1
   34  31:A681  A0 04                     ldy #4
   35  31:A683  B1 1A                     lda [.pItemParam],y
   36  31:A685  29 7F                     and #$7f
   37  31:A687  C9 7F                     cmp #$7f
   38  31:A689  F0 06                     beq .no_effect  ;a722
   39  31:A68B  85 1A                     sta <.actionId
   40  31:A68D  A9 01                     lda #1
   41  31:A68F  D0 7E                     bne .take_effect        ;a71b
   42  31:A691            .no_effect:     ;a722
   43  31:A691  A9 18             lda #$18
   44  31:A693  8D C2 7E          sta $7ec2
   45  31:A696  A9 51             lda #$51        ;"なにも おこらなかった"
   46  31:A698  8D DA 78          sta battleMessages
   47  31:A69B  60                rts
   48  31:A69C            .not_equip:
   49  31:A69C  C9 C8             cmp #$c8
   50  31:A69E  B0 F1             bcs .no_effect  ;a722
   51           0046      .pItemEffect = $46
   52           001B      .effectId = $1b
   53                                     ;consumeable item
   54                                     ;$46,47 = (a - #98) + #91a0;
   55  31:A6A0  18                        clc
   56  31:A6A1  69 08                     adc #08
   57  31:A6A3  85 46                     sta <.pItemEffect
   58  31:A6A5  A9 00                     lda #0
   59  31:A6A7  69 91                     adc #$91
   60  31:A6A9  85 47                     sta <.pItemEffect+1
   61  31:A6AB  A9 18                     lda #$18
   62  31:A6AD  85 4A                     sta <$4a
   63                                     ;fix! v0.6.1
   64  31:A6AF  A9 01                     lda #1
   65  31:A6B1  85 4B                     sta <$4b
   66                                     ;
   67  31:A6B3  A9 17                     lda #$17
   68  31:A6B5  20 DC FD                  jsr copyTo7400  ;fddc
   69  31:A6B8  AD 00 74                  lda $7400
   70  31:A6BB  85 1B                     sta <.effectId
   71  31:A6BD  C9 7F                     cmp #$7f
   72  31:A6BF  F0 D0                     beq .no_effect  ;a722
   73                                     
   74  31:A6C1  AD D8 7E                  lda $7ed8
   75  31:A6C4  29 10                     and #$10
   76  31:A6C6  F0 06                     beq .consume_item
   77                                     
   78  31:A6C8  A5 1A                     lda <.actionId  ;also itemid
   79  31:A6CA  C9 AD                     cmp #$ad        ;うちでのこづち
   80  31:A6CC  F0 C3                     beq .no_effect  ;a722
   81  31:A6CE            .consume_item:
   82  31:A6CE  A2 00                             ldx #0
   83  31:A6D0                            .find_item:
   84  31:A6D0  BD C0 60                                  lda backpackItems,x
   85  31:A6D3  C5 1A                                     cmp <.actionId
   86  31:A6D5  F0 04                                     beq .found
   87  31:A6D7  E8                                        inx
   88  31:A6D8  E8                                        inx
   89  31:A6D9  D0 F5                                     bne .find_item
   90  31:A6DB                            .found: 
   91                                             ;ASSERT(x < 0x40)
   92  31:A6DB  E8                                inx
   93  31:A6DC  DE C0 60                          dec backpackItems,x
   94  31:A6DF  D0 06                             bne .get_cast_count
   95  31:A6E1  CA                                        dex
   96  31:A6E2  A9 00                                     lda #0
   97  31:A6E4  9D C0 60                                  sta backpackItems,x
   98  31:A6E7                            .get_cast_count:
   99  31:A6E7  A5 1A                             lda <.actionId
  100  31:A6E9  A6 1B                             ldx <.effectId
  101  31:A6EB  86 1A                             stx <.actionId
  102  31:A6ED  C9 A6                             cmp #$a6        ;potion
  103  31:A6EF  B0 04                             bcs .load_cast_count
  104  31:A6F1  A9 00                                     lda #0
  105  31:A6F3  F0 1A                                     beq .take_effect
  106  31:A6F5                            .load_cast_count:
  107           0046      .pItemHitCount = $46
  108                                             ;$46,47 = #a35e + (a - #a6);
  109  31:A6F5  18                                clc
  110  31:A6F6  69 B8                             adc #$b8
  111  31:A6F8  85 46                             sta <.pItemHitCount
  112  31:A6FA  A9 00                             lda #0
  113  31:A6FC  AA                                tax
  114  31:A6FD  69 A2                             adc #$a2
  115  31:A6FF  85 47                             sta <.pItemHitCount+1
  116  31:A701  A9 18                             lda #$18
  117  31:A703  85 4A                             sta <$4a
  118  31:A705  8A                                txa
  119  31:A706  E8                                inx
  120  31:A707  86 4B                             stx <$4b        ;1
  121  31:A709  20 DC FD                          jsr copyTo7400
  122                                             
  123  31:A70C  AD 00 74                          lda $7400
  124  31:A70F            .take_effect: ;a71b
  125           007C      .castCountFinal = $7c
  126           0030      .castCount = $30
  127           0001              .ifdef ENABLE_EXTRA_ABILITY_TAG
  128  31:A70F  AA                        tax
  129  31:A710  A9 3C                     lda #EXTRA_ABILITY_OFFSET
  130  31:A712  20 98 BE                  jsr b31_setYtoOffsetOf
  131  31:A715  B1 6E                     lda [.pActor],y
  132  31:A717  29 40                     and #PASSIVE_DOUBLE_ITEM_EFFECT
  133  31:A719  F0 03                     beq .effect_normal
  134  31:A71B  8A                                txa
  135  31:A71C  0A                                asl a
  136  31:A71D  AA                                tax
  137  31:A71E                    .effect_normal:
  138  31:A71E  86 30                     stx <.castCount
  139  31:A720  86 7C                     stx <.castCountFinal
  140                             .endif ;ENABLE_EXTRA_ABILITY_TAG
  141                     
  142  31:A722  4C 77 AF          jmp $af77       ;doSpecialAction
  143                     ;------------------------------------------------------------------------------------------------------
  144                     ;$a732
  145                     ;======================================================================================================
  146                             RESTORE_PC ff3_command_13_begin
                0035              .bank   BANK(ff3_command_13_begin)
                B64E              .org    ff3_command_13_begin
#[3]   ff3_hack_master.asm
   45                                             
#[4]   ff3_b34_play_effect.asm
   46                                     .include "ff3_b34_play_effect.asm"      ;save
    1                     ; ff3_b34_play_effect.asm
    2                     ;
    3                     ; description:
    4                     ;       replaces code for controling various effects
    5                     ;
    6                     ; version:
    7                     ;       0.04 (2006-10-30)
    8                     ;======================================================================================================
    9  35:B64E            ff3_b34_play_effect_begin:
   10                             ;INIT_PATCH $34,$8411,$843e
   11                             INIT_PATCH $34,$83f8,$8460
                0034              .bank   $34
                83F8              .org    $83f8
       34:83F8                    .ds             (($8460) - ($83f8))
                83F8              .org    $83f8
   12  34:83F8            playEffect:
   13                     ;[in]
   14                     ; u8 $7e9a :    action side flag (80:actor enemy 40:target enemy)
   15                     ; u8 $7ec2 : effectType; set by commandHandler, usually commandId
   16                     ; u8 $7ec3 : (0 or 1?)
   17                     ;playEffect_handlerIndices = $83f8
   18                     ;playEffect_handlers = $843e
   19  34:83F8  A2 00             ldx #0
   20  34:83FA  2C 9A 7E          bit play_effectTargetSide
   21  34:83FD  50 01             bvc .target_player
   22  34:83FF  E8                        inx
   23  34:8400            .target_player:
   24  34:8400  8E 6F 7E          stx play_damageTarget
   25                             
   26  34:8403  AC C2 7E          ldy effectHandlerIndex
   27  34:8406  B9 23 84          lda playEffect_handlerIndices,y
   28  34:8409  C9 01             cmp #1
   29  34:840B  D0 04             bne .not_handler_01
   30  34:840D  18                        clc
   31  34:840E  6D C3 7E                  adc effectHandlerFlag
   32  34:8411            .not_handler_01
   33  34:8411  8D 97 7E          sta $7e97
   34  34:8414  0A                asl a
   35  34:8415  A8                tay
   36  34:8416  B9 3E 84          lda playEffect_handlers,y
   37  34:8419  85 18             sta <$18
   38  34:841B  B9 3F 84          lda playEffect_handlers+1,y
   39  34:841E  85 19             sta <$19
   40  34:8420  6C 18 00          jmp [$0018]
   41  34:8423            playEffect_handlerIndices:
   42  34:8423  03 03 04          .db $03,$03,$04,$05,$00,$06,$0D,$0D
       34:8426  05 00 06  
       34:8429  0D 0D     
   43  34:842B  07 08 03          .db $07,$08,$03,$03,$03,$03,$03,$09
       34:842E  03 03 03  
       34:8431  03 09     
   44  34:8433  00 0A 0B          .db $00,$0A,$0B,$01,$01,$0C,$0E,$0F
       34:8436  01 01 0C  
       34:8439  0E 0F     
   45  34:843B  10                .db $10
   46                             ;extention to original
   47  34:843C  11                .db $11
   48  34:843D  12                .db $12
   49                     ;$843e
   50  34:843E            playEffect_handlers:
   51  34:843E  13 86             .dw $8613
   52  34:8440  77 85             .dw $8577
   53  34:8442  ED 85             .dw $85ed
   54  34:8444  76 85             .dw $8576       ;effect_for_command_00_01_0a_0b_0c_0d_0e        ;$8576
   55                     
   56  34:8446  3B 85             .dw $853b
   57  34:8448  40 85             .dw $8540
   58  34:844A  28 85             .dw $8528
   59  34:844C  2D 85             .dw $852d
   60                     
   61  34:844E  16 85             .dw $8516
   62  34:8450  0A 85             .dw $850a
   63  34:8452  05 85             .dw $8505
   64  34:8454  FB 84             .dw $84fb
   65                     
   66  34:8456  E5 84             .dw playEffect_0c               ;$84f6
   67  34:8458  C9 84             .dw playEffect_escape   ;$84d7
   68  34:845A  72 84             .dw playEffect_die              ;$8470
   69  34:845C  64 84             .dw playEffect_damage   ;$8460
   70                     
   71  34:845E  55 85             .dw $8555
   72  34:8460            playEffect_handlers_end:
   73                     ;$8460:
   74  34:8460  18 B7             .dw playEffect_provoke
   75  34:8462  E5 B8             .dw playEffect_abyss
   76                             ;.ds $04 ;reserve 4bytes
   77                     ;------------------------------------------------------------------------------------------------------
   78                             ;.org   (playEffect_handlers_end + 4)
   79                             
   80  34:8464            playEffect_damage       ;effect 0f
   81           7EE1      .segmentatedEnemyGroup = $7ee1
   82           006E      .pActor = $6e
   83  34:8464  20 8A 86          jsr $868a       ;showDamage
   84  34:8467            .do_usually:
   85  34:8467  AD E1 7E          lda .segmentatedEnemyGroup
   86                             ;cmp #$ff
   87  34:846A  30 23             bmi playEffect_doReturn_00
   88  34:846C  85 7E                     sta <$7e
   89  34:846E  A9 0C                     lda #$0c
   90  34:8470  D0 20                     bne playEffect_call_2e_9d53
   91                     
   92                     ;$34:8470 playEffect_0e
   93  34:8472            playEffect_die:
   94  34:8472  AD 9A 7E          lda play_effectTargetSide
   95  34:8475  10 06             bpl .actor_is_player
   96  34:8477  20 80 84                  jsr playEffect_0E_worker        ;$8481
   97  34:847A  4C 95 84                  jmp playEffect_8496
   98  34:847D            .actor_is_player:
   99  34:847D  20 95 84          jsr playEffect_8496
  100                             ;fall through
  101  34:8480            playEffect_0E_worker:
  102  34:8480  A2 00             ldx #0
  103                             ;ldx #$f8
  104  34:8482            .loop:
  105                                     ;lda $78bb - $f8,x
  106                                     ;cmp $7d9b - $f8,x
  107  34:8482  BD BB 78                  lda $78bb,x
  108  34:8485  DD 9B 7D                  cmp $7d9b,x
  109  34:8488  D0 06                     bne playEffect_present07
  110  34:848A  E8                        inx
  111  34:848B  E0 08                     cpx #8
  112  34:848D  D0 F3                     bne .loop
  113  34:848F            playEffect_doReturn_00:
  114  34:848F  60                rts
  115  34:8490            playEffect_present07:
  116  34:8490  A9 07             lda #$07
  117  34:8492            playEffect_call_2e_9d53:
  118  34:8492  4C 0E FA          jmp call_2e_9d53
  119                     ;------------------------------------------------------------------------------------------------------
  120                     ;$34:8496
  121  34:8495            playEffect_8496:
  122           7DA7      .enemyIds = $7da7
  123  34:8495  A2 07             ldx #7
  124  34:8497            .for_each_enemy:
  125  34:8497  BC A7 7D                  ldy .enemyIds,x
  126  34:849A  BD C4 7E                  lda effect_enemyStatus,x
  127  34:849D  30 10                     bmi .dead
  128  34:849F  C8                                iny
  129  34:84A0  D0 10                             bne .next
  130                                                     ;enemyId == #$ff
  131  34:84A2  20 BD 84                                  jsr playEffect_buildDeadBits
  132  34:84A5  A5 7E                                     lda <$7e
  133  34:84A7  49 FF                                     eor #$ff
  134  34:84A9  85 7E                                     sta <$7e
  135  34:84AB  A9 0B                                     lda #$0b
  136  34:84AD  D0 E3                                     bne playEffect_call_2e_9d53
  137  34:84AF                    .dead:
  138                                             ;cpy #$ff
  139                                             ;bne .do_die
  140  34:84AF  C8                                iny
  141  34:84B0  D0 04                             bne .do_die
  142  34:84B2                    .next:
  143  34:84B2  CA                        dex
  144  34:84B3  10 E2                     bpl .for_each_enemy
  145  34:84B5  60                rts
  146  34:84B6            .do_die:
  147  34:84B6  20 BD 84          jsr playEffect_buildDeadBits
  148  34:84B9  A9 0A             lda #$0a
  149  34:84BB  D0 D5             bne playEffect_call_2e_9d53
  150                             
  151  34:84BD            playEffect_buildDeadBits:       ;$84c7
  152           007E      .deadBits = $7e
  153  34:84BD  A2 07             ldx #7
  154  34:84BF            .loop:
  155  34:84BF  BD C4 7E                  lda effect_enemyStatus,x
  156  34:84C2  0A                        asl a
  157  34:84C3  66 7E                     ror <.deadBits
  158  34:84C5  CA                        dex
  159  34:84C6  10 F7                     bpl .loop
  160  34:84C8            playEffect_doReturn_01:
  161  34:84C8  60                rts
  162                     ;$84d7:
  163                     ;------------------------------------------------------------------------------------------------------
  164                     ;$34:84d7 playEffect_0d
  165  34:84C9            playEffect_escape:      ;0d
  166  34:84C9  AD 9A 7E          lda play_effectTargetSide
  167  34:84CC  30 09             bmi .actor_enemy
  168  34:84CE  AD D4 78                  lda $78d4
  169  34:84D1  F0 F5                     beq playEffect_doReturn_01
  170  34:84D3  A9 21                             lda #$21
  171  34:84D5  D0 BB                             bne playEffect_call_2e_9d53
  172  34:84D7            .actor_enemy:
  173  34:84D7  20 45 85                  jsr $8545 ;dispatchPresenetScene_1f();
  174  34:84DA  AD D4 78                  lda $78d4
  175  34:84DD  F0 E9                     beq playEffect_doReturn_01
  176  34:84DF  85 7E                             sta <$7e
  177  34:84E1  A9 0D                             lda #$0d
  178  34:84E3  D0 AD                             bne playEffect_call_2e_9d53
  179                     ;$84f6
  180                     ;------------------------------------------------------------------------------------------------------
  181                     ;$34:84f6 playEffect_0c
  182  34:84E5            playEffect_0c:
  183  34:84E5  A9 24             lda #$24
  184  34:84E7  D0 A9             bne playEffect_call_2e_9d53
  185                     
  186                     ;$84fb
  187                     ;------------------------------------------------------------------------------------------------------
  188                     ;quickfix
  189           0035              .bank   $35
  190           BAD5              .org    $bad5
  191  35:BAD5  20 F8 83                  jsr playEffect
  192                     ;======================================================================================================
  193                             RESTORE_PC ff3_b34_play_effect_begin
                0035              .bank   BANK(ff3_b34_play_effect_begin)
                B64E              .org    ff3_b34_play_effect_begin
#[3]   ff3_hack_master.asm
#[4]   ff3_b30_invokeBattleFunction.asm
   47                                     .include "ff3_b30_invokeBattleFunction.asm"
    1                     ; ff3_b30_invokeBattleFunction.asm
    2                     ;
    3                     ;description:
    4                     ;       replaces invokeBattleFunction()
    5                     ;
    6                     ;version:
    7                     ;       0.03 (2006-11-07)
    8                     ;
    9                     ;======================================================================================================
   10  35:B64E            ff3_b30_invokeBattleFunction_begin:
   11                             INIT_PATCH $30,$9e58,$9e8a
                0030              .bank   $30
                9E58              .org    $9e58
       30:9E58                    .ds             (($9e8a) - ($9e58))
                9E58              .org    $9e58
   12  30:9E58            invokeBattleFunction:
   13                     ;       least value of S = $12 = $20 - ($0a + $06) (original:$14)
   14                     ;               (dungeon_mainLoop - dungeon_mainLoop - beginBattle - call_doBattle - battleLoop)
   15                     ;                       +(presentBattle - pb_disorderedShot)
   16                     ;                       +(getPlayerCommandInput - commandWindow_OnItem)
   17                     ;                       +(executeAction>command_fight - doCounter - command_fight_doFight)
   18                     ;[in]
   19           004C      .functionId = $4c
   20                     ;.pFunctions = $9e76
   21                     ;note: $18,19,1a are reserved!
   22  30:9E58  A5 4C             lda <.functionId
   23  30:9E5A  0A                asl a
   24  30:9E5B  AA                tax
   25  30:9E5C  BD 69 9E          lda .pFunctions,x
   26  30:9E5F  85 4C             sta <$4c
   27  30:9E61  BD 6A 9E          lda .pFunctions+1,x
   28  30:9E64  85 4D             sta <$4d
   29  30:9E66  6C 4C 00          jmp [$004c]
   30                     ;9e76
   31  30:9E69            .pFunctions:
   32  30:9E69  77 AF             .dw $af77       ;00 doSpecial
   33  30:9E6B  00 A4             .dw $a400       ;01 
   34  30:9E6D  32 A7             .dw $a732       ;02 decideEnemyAction
   35  30:9E6F  8A 9E             .dw $9e8a       ;03 doFight
   36  30:9E71  5E A6             .dw $a65e       ;04 useItem
   37  30:9E73  16 AA             .dw $aa16       ;05 calcBattleParams
   38  30:9E75  E9 A2             .dw $a2e9       ;06
   39  30:9E77  9D BE             .dw $be9d       ;07 calcDataAddress
   40  30:9E79  BF BE             .dw $bebf       ;08 rebuildBackpackItems
   41  30:9E7B  17 BF             .dw $bf17       ;09
   42                             ; end of originally implemented
   43  30:9E7D  67 A8             .dw pickRandomTargetFromEnemyParty      ;0a extra
   44  30:9E7F  28 BB             .dw getRandomSucceededCount                     ;0b extra
   45  30:9E81  44 BB             .dw calcDamage                                          ;0c extra
   46                     ;$30:9e8a
   47                     ;======================================================================================================
   48                             RESTORE_PC ff3_b30_invokeBattleFunction_begin
                0035              .bank   BANK(ff3_b30_invokeBattleFunction_begin)
                B64E              .org    ff3_b30_invokeBattleFunction_begin
#[3]   ff3_hack_master.asm
   48                                     
#[4]   ff3_cmdx_provoke.asm
   49                                     .include "ff3_cmdx_provoke.asm"         ;consume( origin )
    1                     ; ff3_cmdx_provoke.asm
    2                     ;
    3                     ; description:
    4                     ;       implements 'provoke' command 
    5                     ;
    6                     ; version:
    7                     ;       0.14 (2006-10-30)
    8                     ;======================================================================================================
    9  35:B64E            ff3_cmdx_provoke_begin:
   10                     
   11                     ;======================================================================================================         
   12                     ;consumes space from origin
   13                     
   14           0000              .ifdef PROVOKE_TARGET_SINGLE
   16                             .else
   17           A7B6      commandWindow_OnProvoke = commandWindow_decideToTargetAll
   18                             .endif  
   19                     ;======================================================================================================
   20                     ;command handler
   21                     ;handleCommand_0a:
   22           0000              .ifdef PROVOKE_TARGET_SINGLE
  109                             .else   ;ifdef PROVOKE_TARGET_SINGLE
  110                     
  111  35:B64E            cmdx_provoke:
  112  35:B64E            doProvokeAll:
  113           006E      .pActor = $6e
  114           0070      .pTarget = $70
  115           0022      .message = $22
  116                     ;.rate = $23
  117           7E89      .effectApplyTarget = $7e89
  118           7E88      .actionIdForEffect = $7e88
  119  35:B64E  A2 58             ldx #EXMSG_PROVOKE_FAIL
  120  35:B650  86 22             stx <.message
  121                             ;clear target bit
  122  35:B652  A2 00             ldx #$0
  123                             ;stx play_castTargetBits
  124  35:B654  8E 9B 7E          stx play_effectTargetBits
  125  35:B657  8E B8 7E          stx play_reflectedTargetBits
  126  35:B65A            .do_provoke:    
  127                             ;init enemy ptr .pTarget = $7675 + #0200 - #40
  128  35:B65A  A9 35             lda #$35
  129  35:B65C  85 70             sta <.pTarget
  130  35:B65E  A9 78             lda #$78
  131  35:B660  85 71             sta <.pTarget+1
  132                             
  133  35:B662  A2 07             ldx #7
  134  35:B664            .change_target: 
  135  35:B664  8A                        txa
  136  35:B665  48                        pha
  137                     
  138  35:B666  BD CD 7E                  lda indexToGroupMap,x
  139  35:B669  30 3B                     bmi .next       ;#ff
  140                     
  141  35:B66B  20 23 9A                  jsr isTargetActive
  142  35:B66E  90 36                     bcc .next
  143                     
  144  35:B670  A0 30                     ldy #$30
  145  35:B672  B1 70                     lda [.pTarget],y
  146  35:B674  29 C0                     and #$c0        ;enemy | all
  147  35:B676  D0 2E                     bne .next
  148                                             ;ok
  149  35:B678  20 CA B6                  jsr isProvokeSuccess
  150  35:B67B  B0 29                     bcs .next
  151                     
  152  35:B67D  20 A6 9F                          jsr setXtoActorIndex
  153  35:B680  20 AD 9F                          jsr flagSingleTarget
  154                                             
  155  35:B683  A0 2F                             ldy #$2f        ;target bits
  156  35:B685  91 70                             sta [.pTarget],y
  157           0001              .ifdef TAG_PROVOKE_EFFECT
  158  35:B687  A0 1E                             ldy #EXSTATUS_OFFSET_PARAM      ;righthand atk (probably unused if .pTarget represents enemy)
  159  35:B689  91 70                             sta [.pTarget],y
  160  35:B68B  C8                                iny
  161  35:B68C  A9 11                             lda #$10 | PROVOKE_EFFECT_REMAIN
  162  35:B68E  91 70                             sta [.pTarget],y
  163                             .endif                          
  164  35:B690  A0 28                             ldy #$28        ;critical rate
  165  35:B692  A9 4B                             lda #75
  166  35:B694  91 70                             sta [.pTarget],y        ;75/100 critical!
  167  35:B696  A9 57                             lda #EXMSG_PROVOKE_SUCCESS
  168  35:B698  85 22                             sta <.message
  169                     
  170  35:B69A  68                                pla
  171  35:B69B  48                                pha
  172  35:B69C  AA                                tax
  173  35:B69D  AD 9B 7E                          lda play_effectTargetBits
  174  35:B6A0  20 20 FD                          jsr flagTargetBit
  175  35:B6A3  8D 9B 7E                          sta play_effectTargetBits
  176  35:B6A6                    .next:
  177                                     SUB16 <.pTarget,#$0040
       35:B6A6  A5 70             lda <.pTarget
       35:B6A8  38                sec
       35:B6A9  E9 40             sbc #LOW(#$0040)
       35:B6AB  85 70             sta <.pTarget
       35:B6AD  A5 71             lda <.pTarget+1
       35:B6AF  E9 00             sbc #HIGH(#$0040)
       35:B6B1  85 71             sta <.pTarget+1
  178  35:B6B3  68                        pla
  179  35:B6B4  AA                        tax
  180  35:B6B5  CA                        dex
  181  35:B6B6  10 AC                     bpl .change_target
  182                             ;setup params for display
  183  35:B6B8            .finish:
  184  35:B6B8  A5 22             lda <.message
  185  35:B6BA  AE EE 78          ldx $78ee
  186  35:B6BD  9D DA 78          sta $78da,x     ;message
  187                             
  188  35:B6C0  A9 19             lda #EFFECT_PROVOKE
  189  35:B6C2  8D C2 7E          sta effectHandlerIndex
  190  35:B6C5  A2 2C             ldx #CMDX_PROVOKE*2
  191  35:B6C7  4C 4D A8          jmp setupActionType01
  192                             .endif ;PROVOKE_TARGET_SINGLE
  193                     
  194  35:B6CA            isProvokeSuccess:
  195           0023      .penalty = $23
  196           0023      .rate = $23
  197           006E      .pActor = $6e
  198           0070      .pTarget = $70
  199                     
  200  35:B6CA  A0 0F             ldy #$0f
  201  35:B6CC  B1 6E             lda [.pActor],y ;joblv
  202  35:B6CE  A0 00             ldy #0
  203  35:B6D0  84 23             sty <.penalty
  204  35:B6D2  18                clc
  205  35:B6D3  71 6E             adc [.pActor],y ;lv
  206  35:B6D5  18                clc
  207  35:B6D6  69 4B             adc #75
  208  35:B6D8  90 02             bcc .calc_shield_penalty
  209  35:B6DA  A9 FF                     lda #$ff
  210  35:B6DC            .calc_shield_penalty:
  211  35:B6DC  48                pha
  212  35:B6DD  B1 70             lda [.pTarget],y        ;lv
  213  35:B6DF  48                pha
  214  35:B6E0  A0 31             ldy #$31
  215  35:B6E2  B1 6E             lda [.pActor],y ;righthand flag
  216  35:B6E4  10 04             bpl .check_left
  217  35:B6E6  A9 19                     lda #25
  218  35:B6E8  85 23                     sta <.penalty
  219  35:B6EA            .check_left:
  220  35:B6EA  A0 32             ldy #$32
  221  35:B6EC  B1 6E             lda [.pActor],y ;lefthand flag
  222  35:B6EE  18                clc
  223  35:B6EF  10 06             bpl .store_penalty
  224  35:B6F1  A5 23                     lda <.penalty
  225  35:B6F3  69 19                     adc #25
  226  35:B6F5  85 23                     sta <.penalty
  227  35:B6F7            .store_penalty: 
  228  35:B6F7  68                pla
  229  35:B6F8  65 23             adc <.penalty
  230  35:B6FA  85 23             sta <.penalty
  231  35:B6FC  68                pla
  232  35:B6FD  38                sec
  233  35:B6FE  E5 23             sbc <.penalty
  234  35:B700  B0 02             bcs .store_rate
  235  35:B702  A9 01                     lda #1
  236  35:B704            .store_rate:
  237  35:B704  85 23             sta <.rate
  238                             ;check for position
  239  35:B706  A0 33             ldy #$33
  240  35:B708  B1 6E             lda [.pActor],y
  241  35:B70A  29 01             and #1
  242  35:B70C  F0 02             beq .get_rand
  243  35:B70E  46 23                     lsr <.rate
  244  35:B710            .get_rand:              
  245  35:B710  A9 64             lda #100
  246  35:B712  20 64 A5          jsr getSys1Random
  247  35:B715  C5 23             cmp <.rate
  248  35:B717  60                rts
  249                     ;======================================================================================================
  250  35:B718            playEffect_provoke:
  251  35:B718  E6 CC             inc <$cc        ;prevent cast motion
  252                     
  253  35:B71A  A9 0F             lda #15         ;'yyyaaa'
  254  35:B71C  85 CA             sta <soundEffectId
  255  35:B71E  A9 20             lda #$20        ;'confuse'
  256  35:B720  8D 88 7E          sta $7e88       ;effect id
  257                             ;lda play_castTargetBits        
  258                             ;sta $7e89      ;target bits
  259  35:B723  A9 00             lda #0          ;effect type 0='normal (play on each target)'
  260  35:B725  8D 9D 7E          sta $7e9d
  261  35:B728  20 32 85          jsr set52toIndexFromActorBit    ;$8532
  262  35:B72B  A9 1D             lda #$1d        ;magic
  263  35:B72D  4C 0E FA          jmp call_2e_9d53
  264                     ;======================================================================================================
  265  35:B730            ff3_cmdx_provoke_end:
  266                     ;       RESTORE_PC ff3_cmdx_provoke_begin
#[3]   ff3_hack_master.asm
#[4]   ff3_cmdx_disordered_shot.asm
   50                                     .include "ff3_cmdx_disordered_shot.asm" ;consume( origin )
    1                     ; ff3_cmdx_disordered_shot.asm
    2                     ;
    3                     ; description:
    4                     ;       implements 'disordered shot' command 
    5                     ;
    6                     ; version:
    7                     ;       0.08 (2006-11-07)
    8                     ;======================================================================================================
    9  35:B730            ff3_cmdx_disorderedShot_begin:
   10                     
   11                     ;------------------------------------------------------------------------------------------------------
   12                             RESTORE_PC pb_handlers_ex
                0034              .bank   BANK(pb_handlers_ex)
                9560              .org    pb_handlers_ex
   13  34:9560  4A B7                     .dw pbx_doDisorderedShot
   14                     ;------------------------------------------------------------------------------------------------------
   15           7910      cmdx_ds_damages = TEMP_RAM+$10  ;$0110
   16                     ;cmdx_ds_missFlags = cmdx_ds_damages + $20
   17           790F      cmdx_ds_count = cmdx_ds_damages - 1
   18                     
   19                     ;------------------------------------------------------------------------------------------------------
   20                             RESTORE_PC ff3_cmdx_disorderedShot_begin
                0035              .bank   BANK(ff3_cmdx_disorderedShot_begin)
                B730              .org    ff3_cmdx_disorderedShot_begin
   21                     ;consumes space from origin
   22           A7D7      commandWindow_OnDisorderedShot = commandWindow_decideReturn
   23                             ;nothing to do
   24                     ;------------------------------------------------------------------------------------------------------
   25  35:B730            cmdx_disorderedShot:
   26                             ;setup action params
   27  35:B730  A9 06             lda #BATTLE_PROCESS_EX_DISORDERED_SHOT
   28  35:B732  8D D5 78          sta battleProcessType   ;$78d5
   29                             
   30  35:B735  A9 50             lda #$39+CMDX_DISORDERED_SHOT
   31  35:B737  8D D7 78          sta actionName  ;action name
   32                             
   33  35:B73A  A2 03             ldx #3
   34  35:B73C  8E 0F 79          stx cmdx_ds_count       ;count
   35  35:B73F  A9 00             lda #$00
   36  35:B741  A2 3F             ldx #($40-1)
   37  35:B743            .init_tag:
   38  35:B743  9D 10 79                  sta cmdx_ds_damages,x
   39  35:B746  CA                        dex
   40  35:B747  10 FA                     bpl .init_tag
   41  35:B749  60                rts
   42                     ;------------------------------------------------------------------------------------------------------
   43  35:B74A            pbx_doDisorderedShot:
   44           0064      .iCommand = $64
   45           0052      .index = $52
   46           006E      .pActor = $6e
   47                     
   48  35:B74A  A5 62             lda <$62
   49  35:B74C  48                pha
   50  35:B74D  A5 63             lda <$63
   51  35:B74F  48                pha
   52                     
   53  35:B750  A5 64             lda <.iCommand
   54  35:B752  48                pha
   55                     
   56  35:B753  A2 03             ldx #3
   57  35:B755            .reduce_atk_hit:
   58  35:B755  86 52             stx <.index
   59  35:B757  BD 4F B8          lda disorderedShot_offsets,x
   60                             ;weaken attack properties
   61  35:B75A  A8                        tay
   62  35:B75B  B1 6E                     lda [.pActor],y
   63  35:B75D  48                        pha
   64  35:B75E  AA                        tax
   65                                     
   66  35:B75F  98                        tya
   67  35:B760  48                        pha
   68  35:B761  A0 0F                     ldy #$0f        ;joblv
   69  35:B763  B1 6E                     lda [.pActor],y
   70  35:B765  4A                        lsr a
   71  35:B766  4A                        lsr a
   72  35:B767  18                        clc
   73  35:B768  69 46                     adc #70
   74  35:B76A  20 EA F8                  jsr mul_8x8_reg
   75  35:B76D  85 18                     sta <$18        ;low
   76  35:B76F  86 19                     stx <$19        ;high
   77  35:B771  A9 64                     lda #$64        ;
   78  35:B773  85 1A                     sta <$1a
   79  35:B775  A9 00                     lda #0
   80  35:B777  85 1B                     sta <$1b
   81  35:B779  20 92 FC                  jsr div_16
   82                                     ;$1c = value * (70 + joblv/4) / 100
   83  35:B77C  68                        pla
   84  35:B77D  A8                        tay
   85  35:B77E  A5 1C                     lda <$1c
   86  35:B780  91 6E                     sta [.pActor],y
   87                             ;
   88  35:B782  A6 52             ldx <.index
   89  35:B784  CA                dex
   90  35:B785  10 CE             bpl .reduce_atk_hit
   91                     
   92           0001              .ifdef FAST_DISORDERED_SHOT
   93                     ;v0.6.1
   94  35:B787  A9 09                     lda #$09
   95  35:B789  20 B9 9C                  jsr setIndexAndCallPresentScene
   96                             .endif ;FAST_DISORDERED_SHOT
   97                     
   98  35:B78C            disorderedShot_attackRandomTarget:
   99           006E      .pActor = $6e
  100           0062      .targetBit = $62
  101  35:B78C  20 DA B8          jsr initDamages ;workaround
  102                     
  103  35:B78F  A0 30             ldy #$30
  104  35:B791  A9 80             lda #$80        ;enemy
  105  35:B793  91 6E             sta [.pActor],y
  106                     
  107  35:B795  4A                lsr a   ;lda #$40       ;actor player | target enemy
  108  35:B796  8D 9A 7E          sta play_effectTargetSide
  109                             
  110  35:B799  88                dey
  111  35:B79A  88                dey
  112  35:B79B  A9 04             lda #$04        ;fight
  113  35:B79D  91 6E             sta [.pActor],y
  114                     
  115  35:B79F  20 A6 9F          jsr setXtoActorIndex
  116  35:B7A2  0A                asl a
  117  35:B7A3  AA                tax
  118  35:B7A4  B5 F0             lda <$f0,x
  119  35:B7A6  30 5E             bmi disorderedShot_finish
  120                     ;x=ff
  121  35:B7A8  20 DA A0          jsr invokePickRandomTarget
  122                     
  123  35:B7AB  A5 62             lda <.targetBit
  124  35:B7AD  F0 57             beq disorderedShot_finish
  125                     
  126  35:B7AF            .valid_target:
  127  35:B7AF  8A                txa
  128  35:B7B0  48                pha     ;target index
  129                     
  130  35:B7B1  20 04 A1          jsr command_fight
  131  35:B7B4  68                pla
  132  35:B7B5  48                pha     ;target index
  133  35:B7B6  20 53 B8          jsr disorderedShot_sumDamages
  134                             ;
  135  35:B7B9  20 A6 9F          jsr setXtoActorIndex
  136  35:B7BC  18                clc
  137  35:B7BD  69 08             adc #8
  138  35:B7BF  20 53 B8          jsr disorderedShot_sumDamages
  139  35:B7C2  90 08             bcc .done_hp
  140                                     ;actor's hp not varied
  141  35:B7C4  A9 FF                     lda #$ff
  142  35:B7C6  9D 50 7E                  sta play_damages+1,x
  143  35:B7C9  9D 4F 7E                  sta play_damages,x
  144  35:B7CC            .done_hp:
  145                     ;------------------------------------------------------------------------------------------------------
  146  35:B7CC            effect_disorderedShot:
  147                     ;[in]
  148                     ;.actorBits = $7e98
  149           0052      .iPlayer = $52
  150           00B8      .blowTarget = $b8
  151           00BB      .hitCount_right = $bb
  152           00BC      .hitCount_left = $bc
  153                     
  154  35:B7CC  A2 00             ldx #0
  155  35:B7CE  8E 96 7E          stx play_arrowTarget
  156                     
  157  35:B7D1  68                pla     ;target index
  158  35:B7D2  85 B8             sta <.blowTarget
  159                     
  160           0001              .ifdef FAST_DISORDERED_SHOT
  161  35:B7D4  A9 26                     lda #PRESENT_SCENE_EX_BLOWONLY
  162  35:B7D6  20 B9 9C                  jsr setIndexAndCallPresentScene
  163                             .else
  168                             .endif ;FAST_DISORDERED_SHOT
  169                     
  170                     ;------------------------------------------------------------------------------------------------------
  171  35:B7D9            pbx_loopDisorderedShot:
  172                     
  173  35:B7D9  AD E1 7E          lda play_segmentatedGroup
  174  35:B7DC  30 0C             bmi .not_segmentated
  175  35:B7DE  85 7E                     sta <$7e
  176  35:B7E0  A9 0C                     lda #$0c
  177  35:B7E2  20 0E FA                  jsr call_2e_9d53
  178  35:B7E5  A9 FF                     lda #$ff
  179  35:B7E7  8D E1 7E                  sta play_segmentatedGroup
  180                     
  181  35:B7EA            .not_segmentated:
  182  35:B7EA  AE 0F 79          ldx cmdx_ds_count
  183  35:B7ED  CA                dex
  184  35:B7EE  30 16             bmi disorderedShot_finish
  185  35:B7F0  8E 0F 79                  stx cmdx_ds_count
  186                     
  187  35:B7F3  AE EE 78                  ldx battleMessageCount
  188  35:B7F6                    .find_end_of_message:
  189  35:B7F6  BD DA 78                          lda battleMessages,x
  190  35:B7F9  C9 FF                             cmp #$ff
  191  35:B7FB  F0 03                             beq .message_ok
  192  35:B7FD  E8                                inx
  193  35:B7FE  D0 F6                             bne .find_end_of_message
  194  35:B800                    .message_ok:
  195  35:B800  8E EE 78                  stx battleMessageCount
  196  35:B803  4C 8C B7                  jmp disorderedShot_attackRandomTarget
  197                     
  198  35:B806            disorderedShot_finish:
  199           0064      .iCommand = $64
  200           004B      .commandId = $4b
  201           006E      .pActor = $6e
  202           0001              .ifdef FAST_DISORDERED_SHOT
  203  35:B806  A9 08                     lda #$08
  204  35:B808  20 B9 9C                  jsr setIndexAndCallPresentScene
  205                             .endif ;FAST_DISORDERED_SHOT
  206                     
  207  35:B80B  20 A3 90          jsr pb_showEffectMessage
  208                             
  209           0001              .ifdef SHOW_INFO_ON_DISORDERED_SHOT
  210                     
  211  35:B80E  20 3F 92          jsr pb_showDamage
  212  35:B811  20 47 92          jsr pb_showDyingEffect
  213  35:B814  A2 00             ldx #0
  214  35:B816  8E EE 78          stx battleMessageCount
  215  35:B819            .show_messages:
  216  35:B819  20 3A 90                  jsr pb_initString
  217  35:B81C  20 47 91                  jsr pb_showInfoMessage
  218  35:B81F  20 F1 92                  jsr pb_waitConfirmOrTimeout
  219                                     
  220  35:B822  A9 04                     lda #$04
  221  35:B824  85 4B                     sta <.commandId
  222  35:B826  20 D6 94                  jsr pb_closeWindow
  223                             
  224  35:B829  AE EE 78                  ldx battleMessageCount
  225  35:B82C  BD DA 78                  lda battleMessages,x
  226  35:B82F  C9 FF                     cmp #$ff
  227  35:B831  D0 E6             bne .show_messages
  228                     
  229  35:B833  A9 03             lda #$03
  230  35:B835  85 4B             sta <.commandId
  231  35:B837  20 D6 94          jsr pb_closeWindow
  232                     
  233                             .endif  ;SHOW_INFO_ON_DISORDERED_SHOT
  234                     ;restore
  235  35:B83A  A2 FC             ldx #$fc
  236  35:B83C            .restore_atk_hit:
  237  35:B83C  BC 53 B7                  ldy disorderedShot_offsets-$fc,x
  238  35:B83F  68                        pla
  239  35:B840  91 6E                     sta [.pActor],y
  240  35:B842  E8                        inx
  241  35:B843  D0 F7                     bne .restore_atk_hit
  242                     ;restore ptr
  243  35:B845  68                pla
  244  35:B846  85 64             sta <.iCommand
  245  35:B848  68                pla
  246  35:B849  85 63             sta <$63
  247  35:B84B  68                pla
  248  35:B84C  85 62             sta <$62
  249                     
  250  35:B84E  60                rts
  251                     ;$9474
  252                     ;======================================================================================================
  253  35:B84F            disorderedShot_offsets:
  254  35:B84F  18 19 1D          .db $18,$19,$1d,$1e
       35:B852  1E        
  255  35:B853            disorderedShot_sumDamages:      ;b8b2-b859
  256                     ;[in] a : index
  257                     ;[out] carry : 1=damage0 
  258           00E0      .statusCache = $e0
  259           0018      .low = $18
  260  35:B853  0A                asl a
  261  35:B854  AA                tax
  262                     
  263  35:B855  BD 4F 7E          lda play_damages,x
  264  35:B858  A8                tay
  265                     
  266  35:B859  BD 50 7E          lda play_damages+1,x
  267  35:B85C  48                pha
  268  35:B85D  C9 FF             cmp #$ff
  269  35:B85F  D0 05             bne .valid_damage
  270  35:B861  68                        pla
  271  35:B862  A9 00                     lda #0
  272  35:B864  A8                        tay
  273  35:B865  48                        pha
  274  35:B866            .valid_damage:
  275  35:B866  68                pla
  276  35:B867  29 BF             and #$bf        ;clear miss
  277  35:B869  10 03             bpl .not_heal
  278  35:B86B  20 CC B8                  jsr .neg15_y_a
  279  35:B86E            .not_heal:
  280  35:B86E  48                pha     ;high
  281  35:B86F  18                clc
  282  35:B870  98                tya
  283  35:B871  7D 10 79          adc cmdx_ds_damages,x
  284  35:B874  A8                tay     ;low
  285  35:B875  68                pla     ;high
  286  35:B876  7D 11 79          adc cmdx_ds_damages+1,x
  287  35:B879            .check_negative:
  288  35:B879  10 03             bpl .result_damage
  289                     ;healed
  290  35:B87B  20 CC B8                  jsr .neg15_y_a
  291  35:B87E            .result_damage:
  292  35:B87E  48                pha
  293  35:B87F  98                tya
  294  35:B880  38                sec
  295  35:B881  E9 10             sbc #LOW(10000)
  296  35:B883  68                pla
  297  35:B884  48                pha
  298  35:B885  29 7F             and #$7f
  299  35:B887  E9 27             sbc #HIGH(10000)
  300  35:B889  90 08             bcc .store_result
  301  35:B88B  A0 0F                     ldy #LOW(9999)
  302  35:B88D  68                        pla
  303  35:B88E  29 80                     and #$80
  304  35:B890  09 27                     ora #HIGH(9999)
  305  35:B892  48                        pha
  306  35:B893            .store_result:
  307  35:B893  98                tya
  308  35:B894  9D 4F 7E          sta play_damages,x
  309  35:B897  68                pla
  310  35:B898  48                pha
  311  35:B899  1D 4F 7E          ora play_damages,x
  312  35:B89C  18                clc
  313  35:B89D  D0 1A             bne .store_high
  314                                     ;result0. heal0 or miss
  315  35:B89F  1D 10 79                  ora cmdx_ds_damages,x
  316  35:B8A2  1D 11 79                  ora cmdx_ds_damages+1,x
  317  35:B8A5  1D 50 7E                  ora play_damages+1,x
  318  35:B8A8  29 BF                     and #$bf
  319  35:B8AA  D0 09                     bne .heal_0pt
  320  35:B8AC                    .miss:
  321  35:B8AC  38                                sec
  322  35:B8AD  A9 40                             lda #$40
  323  35:B8AF  9D 50 7E                          sta play_damages+1,x
  324  35:B8B2  68                                pla
  325  35:B8B3  F0 08                             beq .check_result_negative
  326  35:B8B5                    .heal_0pt:
  327                                             ;heal 0pt
  328  35:B8B5  68                                pla
  329  35:B8B6  A9 80                             lda #$80
  330  35:B8B8  48                                pha
  331  35:B8B9            .store_high:
  332  35:B8B9  68                pla
  333  35:B8BA  9D 50 7E          sta play_damages+1,x
  334  35:B8BD            .check_result_negative:
  335  35:B8BD  10 05             bpl .store_cache
  336  35:B8BF  20 CC B8                  jsr .neg15_y_a
  337  35:B8C2  09 80                     ora #$80
  338  35:B8C4            .store_cache:
  339  35:B8C4  9D 11 79          sta cmdx_ds_damages+1,x
  340  35:B8C7  98                tya
  341  35:B8C8  9D 10 79          sta cmdx_ds_damages,x
  342  35:B8CB  60                rts
  343  35:B8CC            .neg15_y_a:
  344                     ;[in] a : high, y: low
  345  35:B8CC  48                pha
  346  35:B8CD  98                tya
  347  35:B8CE  49 FF             eor #$ff
  348  35:B8D0  18                clc
  349  35:B8D1  69 01             adc #1
  350  35:B8D3  A8                tay
  351  35:B8D4  68                pla
  352  35:B8D5  49 7F             eor #$7f
  353  35:B8D7  69 00             adc #0
  354                             ;
  355                             ;ora #$80
  356  35:B8D9  60                rts
  357                     ;workaround for doFight behavior
  358  35:B8DA            initDamages:
  359  35:B8DA  A2 0F             ldx #$0f
  360  35:B8DC  A9 FF             lda #$ff
  361  35:B8DE            .fill:
  362  35:B8DE  9D 5F 7E                  sta play_damages+$10,x
  363  35:B8E1  CA                        dex
  364  35:B8E2  10 FA                     bpl .fill
  365  35:B8E4  60                rts
  366                     ;-------------------------------------------------------------------------------------------------------
  367                     ;$b979
  368  35:B8E5            ff3_cmdx_disorderedShot_end:
  369           0000              .if ff3_cmdx_disorderedShot_end > ff3_magic_window_free_end
  371                             .endif
#[3]   ff3_hack_master.asm
#[4]   ff3_cmdx_abyss.asm
   51                                     .include "ff3_cmdx_abyss.asm"   ;consume( origin )
    1                     ; ff3_cmdx_abyss.asm
    2                     ;
    3                     ; description:
    4                     ;       implements 'abyss' command 
    5                     ;
    6                     ; version:
    7                     ;       0.02 (2006-11-07)
    8                     ;======================================================================================================
    9  35:B8E5            ff3_cmdx_abyss_begin:
   10                     
   11           0001              .ifdef GIVE_EVILSWORDMAN_ABYSS
   12                     ;======================================================================================================
   13           A7B6      commandWindow_OnAbyss = commandWindow_decideToTargetAll
   14                     ;------------------------------------------------------------------------------------------------------
   15                     ;consumes space
   16                             RESTORE_PC pb_free_begin
                0034              .bank   BANK(pb_free_begin)
                930F              .org    pb_free_begin
   17                     
   18  34:930F            calcAbyss:
   19           006E      .pActor = $6e
   20           0070      .pTarget = $70  ;in,const
   21           007C      .count = $7c
   22           0024      .rate = $24
   23           0025      .try = $25
   24           0025      .atkLow = $25
   25           0026      .def = $26
   26           0027      .attr = $27
   27           0028      .bonus = $28
   28           0029      .bonusMul = $29
   29           002A      .divide = $2a
   30           002B      .atkHigh = $2b
   31           0030      .succeeded = $30
   32           00E0      .targetCache = $e0
   33                     
   34  34:930F  A0 13             ldy #$13        ;mevade count
   35  34:9311  B1 70             lda [.pTarget],y
   36  34:9313  85 25             sta <.try
   37  34:9315  C8                iny
   38  34:9316  B1 70             lda [.pTarget],y
   39  34:9318  85 24             sta <.rate
   40  34:931A  20 BA 93          jsr .callGetRandomSucceededCount
   41                     ;       威力 = 75 + 熟練度 + 精神
   42  34:931D  A0 0F             ldy #$0f
   43  34:931F  B1 6E             lda [.pActor],y
   44  34:9321  48                pha
   45  34:9322  18                clc
   46  34:9323  69 4B             adc #75
   47                             ;sta <.atkLow
   48                     
   49  34:9325  C8                iny
   50  34:9326  C8                iny
   51  34:9327  71 6E             adc [.pActor],y
   52  34:9329  90 02             bcc .store_atk
   53  34:932B  A9 FF                     lda #$ff
   54  34:932D            .store_atk
   55  34:932D  85 25             sta <.atkLow
   56                     ;       回数 = 1 + 熟練度/16 + 精神/8
   57  34:932F  B1 6E             lda [.pActor],y
   58  34:9331  4A                lsr a
   59  34:9332  4A                lsr a
   60  34:9333  4A                lsr a
   61  34:9334  85 7C             sta <.count
   62  34:9336  68                pla     ;joblv
   63  34:9337  4A                lsr a
   64  34:9338  4A                lsr a
   65  34:9339  4A                lsr a
   66  34:933A  4A                lsr a
   67  34:933B  38                sec
   68  34:933C  65 7C             adc <.count
   69                             ;adc #2
   70  34:933E  38                sec
   71  34:933F  E5 30             sbc <.succeeded
   72  34:9341  B0 02             bcs .store_count
   73  34:9343  A9 00                     lda #0
   74  34:9345            .store_count:
   75  34:9345  85 7C             sta <.count
   76                     ;
   77  34:9347  A0 15             ldy #$15
   78  34:9349  B1 70             lda [.pTarget],y
   79  34:934B  85 26             sta <.def
   80                     ;attr check
   81  34:934D  A2 00             ldx #0
   82  34:934F  86 28             stx <.bonus
   83  34:9351  86 29             stx <.bonusMul
   84  34:9353  86 2B             stx <.atkHigh
   85  34:9355  E8                inx
   86  34:9356  86 2A             stx <.divide    ;1
   87  34:9358  E8                inx
   88                     
   89  34:9359  A0 12             ldy #$12
   90  34:935B  B1 70             lda [.pTarget],y
   91  34:935D  29 02             and #$02        ;dark
   92  34:935F  F0 02             beq .not_weak
   93  34:9361  A2 04                     ldx #4
   94  34:9363            .not_weak:
   95  34:9363  A0 20             ldy #$20
   96  34:9365  B1 70             lda [.pTarget],y
   97  34:9367  29 02             and #$02        ;dark
   98  34:9369  F0 02             beq .not_strong
   99  34:936B  A2 01                     ldx #1
  100  34:936D            .not_strong:
  101                             ;x = 1(strong) 2(normal) 4(weak)
  102  34:936D  86 27             stx <.attr
  103                             ;calcDamage(hitcount:$7c, atk:$25,2b, def:$26, 
  104                             ;       attr:$27, bonus:$28, bonusMul:$29, divide:$2a);
  105  34:936F  20 BE 93          jsr .callCalcDamage
  106           001C      .resultDamage = $1c
  107  34:9372  20 36 9A          jsr setXtoTargetIndex
  108                     ;flag target
  109  34:9375  AD 9B 7E          lda play_effectTargetBits
  110  34:9378  20 20 FD          jsr flagTargetBit
  111  34:937B  8D 9B 7E          sta play_effectTargetBits
  112                     
  113  34:937E  8A                txa
  114  34:937F  0A                asl a
  115  34:9380  AA                tax
  116  34:9381  A5 1C             lda <.resultDamage
  117  34:9383  9D 4F 7E          sta play_damages,x
  118  34:9386  A5 1D             lda <.resultDamage+1
  119  34:9388  9D 50 7E          sta play_damages+1,x
  120                     ;apply damage
  121  34:938B  A0 03             ldy #3
  122  34:938D  38                sec
  123  34:938E  B1 70             lda [.pTarget],y
  124  34:9390  E5 1C             sbc <.resultDamage
  125  34:9392  91 70             sta [.pTarget],y
  126  34:9394  C8                iny
  127  34:9395  B1 70             lda [.pTarget],y
  128  34:9397  E5 1D             sbc <.resultDamage+1
  129  34:9399  91 70             sta [.pTarget],y
  130  34:939B  88                dey
  131  34:939C  11 70             ora [.pTarget],y
  132  34:939E  F0 02             beq .target_dead
  133  34:93A0  B0 0B             bcs .remove_segmenting_abiliy
  134  34:93A2            .target_dead:
  135                                     ;result minus (target dead)
  136  34:93A2  A9 00                     lda #0
  137  34:93A4  91 70                     sta [.pTarget],y
  138  34:93A6  C8                        iny
  139  34:93A7  91 70                     sta [.pTarget],y
  140  34:93A9  A9 80                     lda #$80
  141  34:93AB  95 E0                     sta <.targetCache,x
  142  34:93AD            .remove_segmenting_abiliy:
  143                             ;
  144  34:93AD  A0 38             ldy #$38
  145  34:93AF  B1 70             lda [.pTarget],y        ;actionId[0]
  146  34:93B1  C9 4F             cmp #$4f        ;4f:segmentate
  147  34:93B3  D0 04             bne .finish
  148                             ;remove target's segmentaing ability
  149  34:93B5  A9 34                     lda #$34        ;34: care
  150  34:93B7  91 70                     sta [.pTarget],y
  151  34:93B9            .finish:
  152  34:93B9  60                rts
  153  34:93BA            .callGetRandomSucceededCount:
  154  34:93BA  A9 0B             lda #BF_GET_RANDOM_SUCCEEDED_COUNT
  155  34:93BC  D0 02             bne .call
  156  34:93BE            .callCalcDamage:
  157  34:93BE  A9 0C             lda #BF_CALC_DAMAGE
  158  34:93C0            .call:
  159           004C      .functionId = $4c
  160  34:93C0  85 4C             sta <.functionId
  161  34:93C2  4C F3 FD          jmp invoke_b30_battleFunction   ;fdf3
  162  34:93C5            calcAbyss_end:
  163                     ;------------------------------------------------------------------------------------------------------
  164                     ;consumes space from origin
  165                             RESTORE_PC ff3_cmdx_abyss_begin
                0035              .bank   BANK(ff3_cmdx_abyss_begin)
                B8E5              .org    ff3_cmdx_abyss_begin
  166  35:B8E5            playEffect_abyss:
  167  35:B8E5  E6 CC             inc <$cc        ;prevent cast
  168                             ;inc <$cb       ;critical flag?
  169  35:B8E7  A9 0B             lda #$0b
  170                             ;lda #$00
  171  35:B8E9  8D 9D 7E          sta play_magicType      ;7e9d
  172                             ;lda #$10       ;'dimension'
  173  35:B8EC  A9 4A             lda #$4a        ;mega flare
  174                             ;lda #$68
  175  35:B8EE  8D 88 7E          sta $7e88       ;effect id
  176                     
  177                     
  178                             ;lda #$4a       ;wavecannon
  179                             ;lda #$11       ;death
  180  35:B8F1  A9 47             lda #$47        ;sound of dimension
  181                             ;lda #$22
  182  35:B8F3  85 CA             sta <soundEffectId
  183                             
  184  35:B8F5  A9 27             lda #PRESENT_SCENE_EX_ABYSS
  185  35:B8F7  20 B9 9C          jsr setIndexAndCallPresentScene
  186  35:B8FA  A9 00             lda #0
  187  35:B8FC  85 CC             sta <$cc
  188  35:B8FE  60                rts
  189                     ;------------------------------------------------------------------------------------------------------
  190  35:B8FF            cmdx_abyss:
  191           006E      .pActor = $6e
  192           00F0      .actorStatusCache = $f0
  193  35:B8FF  A9 1A             lda #EFFECT_ABYSS
  194  35:B901  8D C2 7E          sta effectHandlerIndex
  195  35:B904  20 4D A8          jsr setupActionType01
  196                     ;init effect params
  197  35:B907  A9 00             lda #0
  198  35:B909  8D 9B 7E          sta play_effectTargetBits
  199  35:B90C  8D B8 7E          sta play_reflectedTargetBits
  200                     ;main calcs
  201           0070      .pTarget = $70
  202                             INIT16 <.pTarget,$7835
       35:B90F  A9 35             lda #LOW($7835)
       35:B911  85 70             sta <.pTarget
       35:B913  A9 78             lda #HIGH($7835)
       35:B915  85 71             sta <.pTarget+1
  203  35:B917  A2 07             ldx #7
  204  35:B919            .for_each_enemy:
  205  35:B919  8A                        txa
  206  35:B91A  48                        pha
  207  35:B91B  A9 E8                     lda #$e8        ;dead | stone | toad | minimum
  208  35:B91D  A2 00                     ldx #$00
  209  35:B91F  20 27 9A                  jsr isTargetNotInStatus
  210  35:B922  90 03                     bcc .next
  211                                             ;ok
  212  35:B924  20 0F 93                          jsr calcAbyss
  213  35:B927                    .next:
  214                                     SUB16 <.pTarget,#$0040
       35:B927  A5 70             lda <.pTarget
       35:B929  38                sec
       35:B92A  E9 40             sbc #LOW(#$0040)
       35:B92C  85 70             sta <.pTarget
       35:B92E  A5 71             lda <.pTarget+1
       35:B930  E9 00             sbc #HIGH(#$0040)
       35:B932  85 71             sta <.pTarget+1
  215  35:B934  68                        pla
  216  35:B935  AA                        tax
  217  35:B936  CA                        dex
  218  35:B937  10 E0                     bpl .for_each_enemy
  219                     
  220  35:B939  20 AB A9          jsr damageActorByQuoterHalf     ;also set x to cache index
  221                     ;setup message and effect params
  222  35:B93C  A9 5D             lda #EXMSG_ABYSS_MESSAGE
  223  35:B93E  8D DA 78          sta battleMessages
  224                     ;       lda .actorStatusCache,x
  225                     ;       bpl .finish
  226                     ;               ldx #1
  227                     ;               stx battleMessageCount
  228                     ;               lda #$1a        ;"しんでしまった"
  229                     ;               sta battleMessages,x
  230  35:B941            .finish:
  231  35:B941  20 A6 9F          jsr setXtoActorIndex
  232  35:B944  4C EE A2          jmp setupWeaponId
  233                     
  234                     ;======================================================================================================         
  235  35:B947            ff3_cmdx_abyss_end:
  236           0000              .if ff3_cmdx_abyss_end >= ff3_magic_window_free_end
  238                             .endif
  239                             
  240                             .else   ;GIVE_EVILSWORDMAN_ABYSS
  247                             .endif  ;GIVE_EVILSWORDMAN_ABYSS
#[3]   ff3_hack_master.asm
   52                                     ;v0.6.1:
#[4]   ff3_present_scene.asm
   53                                     .include "ff3_present_scene.asm"
    1                     ; ff3_present_scene.asm
    2                     ;
    3                     ;description:
    4                     ;       replaces presentScene()
    5                     ;
    6                     ;version:
    7                     ;       0.01 (2006-10-28)
    8                     ;
    9                     ;======================================================================================================
   10  35:B947            ff3_present_scene_begin:
   11                     
   12                     ;       [in] u8 A : commandId (00-25h)
   13                     ;               01 : さがる(char:$52)
   14                     ;               02 : 指示するキャラが前に出る(char:$52)
   15                     ;               03 : playEffect_05 (back(03) )
   16                     ;               04 : playEffect_04 (forward(02) )
   17                     ;               07 : playEffect_0e(死亡・味方)
   18                     ;               08 : $b38e 行動中のキャラを示す(一定のラインまで前に出る)
   19                     ;               09 : $b38b 行動終了したキャラを元の位置まで戻す
   20                     ;               0a : playEffect_0e(死亡・敵 $7e=死亡bit(各bitが敵1体に相当) )
   21                     ;               0b : playEffect_0e
   22                     ;                       (蘇生? bitが立っている敵の枠に敵がいたならグラ復活
   23                     ;                        生存かつ非表示の敵がいたとき $7e=生存bit で呼ばれる)
   24                     ;               0C : 敵生成(召還・分裂・増殖) playEffect_0F (disp_0C)
   25                     ;               0d : playEffect_0c (escape(06/07) : $7e9a(sideflag) < 0)
   26                     ;               0e :
   27                     ;               
   28                     ;               0F : prize($35:bb49)
   29                     ;               10 : 対象選択
   30                     ;               12 : 打撃モーション&エフェクト(char:$52)
   31                     ;               13 : presentCharacter($34:8185)
   32                     ;               14 : playEffect_00 (fight/sing 被弾モーション?)
   33                     ;               15 : playEffect_06 (defend(05) )
   34                     ;               16 : playEffect_09 (charge(0f) 通常)
   35                     ;               17 : playEffect_09 (charge(0f) ためすぎ)
   36                     ;               18 : playEffect_07 (jump(08) )
   37                     ;               19 : playEffect_08 (landing(09) )
   38                     ;               1a : playEffect_0a (intimidate(11) )
   39                     ;               1b : playEffect_0b (cheer(12) )
   40                     ;               1c : playEffect_0F (disp_0C) ダメージ表示?
   41                     ;               1d : playEffect_01 (command13/ cast/item)
   42                     ;               1f : playEffect_00 行動する敵が点滅
   43                     ;               20 : playEffect_00 (fight/sing 敵の打撃エフェクト?)
   44                     ;               21 : playEffect_0d (escape(06/07) : $7e9a(effectside) >= 0)
   45                     ;               22 : playEffect_01 (magicparam+06 == #07)
   46                     ;               23 : playEffect_01 (magicparam+06 == #0d)
   47                     ;               24 : playEffect_0c (command15)
   48                     ;       [in] u8 X : actorIndex
   49                     ;       [out] u8 $7d7d : 0
   50                             INIT_PATCH $2f,$af4e,$afc0
                002F              .bank   $2f
                AF4E              .org    $af4e
       2F:AF4E                    .ds             (($afc0) - ($af4e))
                AF4E              .org    $af4e
   51                     
   52  2F:AF4E            presentScene:
   53                     ;.handlers = $af74
   54  2F:AF4E  86 95             stx <$95
   55  2F:AF50  0A                asl a
   56  2F:AF51  18                clc
   57  2F:AF52  69 6A             adc #LOW(.handlers)
   58  2F:AF54  85 93             sta <$93
   59  2F:AF56  A9 AF             lda #HIGH(.handlers)
   60  2F:AF58  85 94             sta <$94
   61  2F:AF5A  A9 6C             lda #$6c
   62  2F:AF5C  85 92             sta <$92
   63  2F:AF5E  98                tya
   64  2F:AF5F  48                pha
   65  2F:AF60  8A                txa
   66  2F:AF61  48                pha
   67  2F:AF62  20 92 00          jsr $0092
   68  2F:AF65  68                pla
   69  2F:AF66  AA                tax
   70  2F:AF67  68                pla
   71  2F:AF68  A8                tay
   72  2F:AF69  60                rts
   73                     ;$2f:af74 $af4e_funcTable;
   74  2F:AF6A            .handlers:
   75  2F:AF6A  69 B4             .dw $b469, $b3c7, $b3cd, $b42a
       2F:AF6C  C7 B3     
       2F:AF6E  CD B3     
       2F:AF70  2A B4     
   76  2F:AF72  43 B4             .dw $b443, $b3f6, $b3d9, $b3d3
       2F:AF74  F6 B3     
       2F:AF76  D9 B3     
       2F:AF78  D3 B3     
   77  2F:AF7A  8B B3             .dw $b38b, $b38e, $b33e, $b343
       2F:AF7C  8E B3     
       2F:AF7E  3E B3     
       2F:AF80  43 B3     
   78  2F:AF82  48 B3             .dw $b348, $b34d, $b304, $b2eb
       2F:AF84  4D B3     
       2F:AF86  04 B3     
       2F:AF88  EB B2     
   79                     
   80  2F:AF8A  FA B2             .dw $b2fa, $b260, $b24f, $b24c
       2F:AF8C  60 B2     
       2F:AF8E  4F B2     
       2F:AF90  4C B2     
   81  2F:AF92  01 B2             .dw $b201, $b246, $b1d8, $b1e0
       2F:AF94  46 B2     
       2F:AF96  D8 B1     
       2F:AF98  E0 B1     
   82  2F:AF9A  CF B1             .dw $b1cf, $b1c1, $b1b5, $b1af
       2F:AF9C  C1 B1     
       2F:AF9E  B5 B1     
       2F:AFA0  AF B1     
   83  2F:AFA2  AC B1             .dw $b1ac, $b15e, $b050, $b024
       2F:AFA4  5E B1     
       2F:AFA6  50 B0     
       2F:AFA8  24 B0     
   84                     
   85  2F:AFAA  05 B0             .dw $b005, $af24, $afff, $afe7
       2F:AFAC  24 AF     
       2F:AFAE  FF AF     
       2F:AFB0  E7 AF     
   86  2F:AFB2  44 AF             .dw $af44, $afd8
       2F:AFB4  D8 AF     
   87                             ;extra
   88                             ;$26
   89  2F:AFB6  97 B3             .dw psx_blowOnly
   90  2F:AFB8  A0 B3             .dw psx_abyss
   91                     ;------------------------------------------------------------------------------------------------------
   92                     ;$2f:b352 moveCharacterBack
   93                             INIT_PATCH $2f,$b352,$b388
                002F              .bank   $2f
                B352              .org    $b352
       2F:B352                    .ds             (($b388) - ($b352))
                B352              .org    $b352
   94                     
   95  2F:B352            moveCharacterBack:
   96                     ;       [in] x : actorIndex
   97           7D7F      .goals = $7d7f
   98  2F:B352  20 64 B3          jsr getMoveOffset
   99  2F:B355  18                clc
  100                     ;fall through
  101  2F:B356            moveCharacter_addAndStoreGoal:
  102           7D7F      .goals = $7d7f
  103  2F:B356  30 03             bmi .confused
  104  2F:B358  EE 7D 7D                  inc $7d7d
  105  2F:B35B            .confused:
  106  2F:B35B  7D 7F 7D          adc .goals,x
  107  2F:B35E  9D 7F 7D          sta .goals,x
  108  2F:B361  4C 5C B4          jmp $b45c       ;
  109                     
  110  2F:B364            getMoveOffset:
  111                     ;[out] u8 a,$7e : offset
  112  2F:B364  A9 00             lda #0
  113  2F:B366  8D 7D 7D          sta $7d7d
  114  2F:B369  8A                txa
  115  2F:B36A  0A                asl a
  116  2F:B36B  A8                tay
  117  2F:B36C  B9 9B 7D          lda $7d9b,y
  118  2F:B36F  29 08             and #$08
  119  2F:B371  F0 04             beq .not_confused
  120                     ;backattack
  121  2F:B373  A9 F0                     lda #$f0
  122  2F:B375  D0 09                     bne .store_and_set_x
  123  2F:B377            .not_confused:
  124  2F:B377  BD 8F 7D                  lda $7d8f,x
  125  2F:B37A  4A                        lsr a
  126  2F:B37B  A9 10                     lda #$10
  127  2F:B37D  90 01                     bcc .at_front_line
  128  2F:B37F  0A                                asl a
  129  2F:B380                    .at_front_line:
  130  2F:B380            .store_and_set_x:
  131  2F:B380  85 7E             sta <$7e
  132  2F:B382  60                rts
  133                     ;------------------------------------------------------------------------------------------------------
  134                     ;$2f:b38e moveCharacterForward
  135                             INIT_PATCH $2f,$b38e,$b3c7
                002F              .bank   $2f
                B38E              .org    $b38e
       2F:B38E                    .ds             (($b3c7) - ($b38e))
                B38E              .org    $b38e
  136                     
  137  2F:B38E            moveCharacterForward:
  138                     ;       [in] x : actorIndex
  139           7D7F      .goals = $7d7f
  140  2F:B38E  20 64 B3          jsr getMoveOffset
  141  2F:B391  49 FF             eor #$ff
  142  2F:B393  38                sec
  143  2F:B394  4C 56 B3          jmp moveCharacter_addAndStoreGoal
  144                     ;------------------------------------------------------------------------------------------------------
  145                     
  146  2F:B397            psx_blowOnly:
  147  2F:B397  20 CF A9          jsr $a9cf       ;$a9cf();       
  148  2F:B39A  20 EA A8          jsr $a8ea       ;loadBlowEffectParams();        // $a8ea();
  149  2F:B39D  4C F0 AE          jmp $aef0       ;dispatchEffectFunction_04();   //$aef0();      //打撃モーション
  150                             
  151  2F:B3A0            psx_abyss:
  152  2F:B3A0  20 8E B3          jsr moveCharacterForward
  153                             ;presentScene_16 (charge)
  154  2F:B3A3  A9 00             lda #0
  155  2F:B3A5  8D 19 7E          sta $7e19       ;charge motion flag
  156  2F:B3A8  20 CF A9          jsr $a9cf;
  157  2F:B3AB  20 B1 A9          jsr $a9b1;
  158  2F:B3AE  20 FC AE          jsr $aefc;      dispatchEffectFunction_07();
  159                             ;jsr psx_blowOnly       ;destorys x
  160  2F:B3B1  20 CF A9          jsr $a9cf
  161  2F:B3B4  20 14 AF          jsr $af14       ;dispatchEffectFunction_0d
  162  2F:B3B7  A9 06             lda #6
  163  2F:B3B9  20 B3 A1          jsr $a1b3       ;clear sprites
  164  2F:B3BC  A6 95             ldx <$95        ;index
  165  2F:B3BE  4C C7 B3          jmp $b3c7       ;backAndUpdatePpu
  166                     ;$b3c7:
  167                     ;======================================================================================================
  168                             RESTORE_PC ff3_present_scene_begin
                0035              .bank   BANK(ff3_present_scene_begin)
                B947              .org    ff3_present_scene_begin
#[3]   ff3_hack_master.asm
   54                                     ;v0.7.0:
#[4]   ff3_battle_calc.asm
   55                                     .include "ff3_battle_calc.asm"
    1                     ; ff3_battle_calc.asm
    2                     ;
    3                     ;description:
    4                     ;       replaces calculation for command 'fight'
    5                     ;
    6                     ;version:
    7                     ;       0.02 (2006-10-31)
    8                     ;======================================================================================================
    9  35:B947            ff3_battle_calc_begin:
   10                             ;.include "ff3_30-31.h"
   11                     ;       INIT_PATCH $30,$9e8a,$a2b5
   12                     ;       .bank   $30
   13                     ;       .org    $9e8a
   14                     ;processFight:
   15                     ;;arguments:
   16                     ;;      [in]
   17                     ;.pActor = $6e
   18                     ;.pTarget = $70
   19                     ;.escapeCount = $74
   20                     ;.defendFlags = $7ce4
   21                     ;;      [in,out]
   22                     ;.messageCount = $78ee
   23                     ;.message = $78da
   24                     ;;      [out]
   25                     ;.hitCount_1st = $7c
   26                     ;.hitCount_2nd = $7d
   27                     ;.protectFlag = $7edf
   28                     ;;locals:
   29                     ;.isTargetAtBackline = $7ce9
   30                     ;.targetHp = $3c
   31                     ;.actorHp = $40
   32                     ;.actor2c = $45 ;extra
   33                     ;.target2c = $46        ;extra
   34                     ;.handCount = $741f
   35                     ;;      shared with cacheStatus()
   36                     ;.actorIndexForCache = $62
   37                     ;.targetIndexForCache = $64
   38                     ;.actorIndex = $66
   39                     ;.targetIndex = $68
   40                     ;.actorStatusCache = $f0
   41                     ;.targetStatusCache = $e0
   42                     ;;      shared with sumDamage()
   43                     ;.damageForDisplay = $6a
   44                     ;.damage = $78
   45                     ;;      shared with checkSegmentation()
   46                     ;.hitCount_1st_2 = $bb
   47                     ;.hitCount_2nd_2 = $bc
   48                     ;;------------------------------------------------------------------------------------------------------
   49                     ;       lda <.actor2c
   50                     ;       pha
   51                     ;       lda <.target2c
   52                     ;       pha
   53                     ;       ldy #$2c
   54                     ;       lda [.pActor],y
   55                     ;       and #$87
   56                     ;       sta <.actor2c
   57                     ;       lda [.pTarget],y
   58                     ;       and #$87
   59                     ;       sta <.target2c
   60                     ;       
   61                     ;       jsr $a2ba
   62                     ;       ldx .targetIndexForCache
   63                     ;       bit .targetStatusCache,x
   64                     ;       bvs .dead_stone_jump
   65                     ;       bmi .dead_stone_jump
   66                     ;               inx
   67                     ;               lda #1
   68                     ;               bit .targetStatusCache,x
   69                     ;               bne .init
   70                     ;.dead_stone_jump:
   71                     ;       ldy #$30
   72                     ;       lda [.pActor],y
   73                     ;       bmi .target_is_enemy
   74                     ;               INIT16 <$22,$7575
   75                     ;               lda #3
   76                     ;               jsr $a300
   77                     ;               lda <$69
   78                     ;               beq .cache_and_init
   79                     ;                       ldx #0
   80                     ;                       stx $7ec2
   81                     ;                       dex
   82                     ;                       stx $7ed8
   83                     ;                       jmp .set_messages
   84                     ;.target_is_enemy:
   85                     ;               INIT16 <$22,$7675
   86                     ;               lda #7
   87                     ;               jsr $a300
   88                     ;.cache_and_init:
   89                     ;       jsr $a2ba       ;cacheStatus
   90                     ;.init:
   91                     ;       ldx #$ff
   92                     ;       stx $7ee1
   93                     ;       inx
   94                     ;       stx $741e
   95                     ;       stx $7ce9
   96                     ;       stx <.hitCount_1st
   97                     ;       stx <.hitCount_2nd
   98                     ;       stx <.damageForDisplay
   99                     ;       stx <.damageForDisplay+1
  100                     ;       stx <$42
  101                     ;       inx
  102                     ;       stx .handCount
  103                     ;       
  104                     ;       ldy #3
  105                     ;       lda [.pActor],y
  106                     ;       sta <.actorHp
  107                     ;       lda [.pTarget],y
  108                     ;       sta <.targetHp
  109                     ;       iny
  110                     ;       lda [.pActor],y
  111                     ;       sta <.actorHp+1
  112                     ;       lda [.pTarget],y
  113                     ;       sta <.targetHp+1
  114                     ;
  115                     ;       bit <.actor2c
  116                     ;       bpl .actor_is_player_char
  117                     ;               ;enemy
  118                     ;               lda <.escapeCount
  119                     ;               beq .cache_params
  120                     ;                       bit <.target2c
  121                     ;                       bmi .cache_params
  122                     ;                       
  123                     ;       //if ( getActor2C() < 0
  124                     ;       //      || (($74 != 0) && (getTarget2C() >= 0) && 
  125                     ;       if (getActor2C() < 0) { //msb==1
  126                     ;               //敵
  127                     ;               if (0 != (a = $74) ) {  //$74 = escape count
  128                     ;                       if (getTarget2C() >= 0) {//$31:bc25()
  129                     ;$9f10:
  130                     ;                               $70[y = #27] += 1;
  131                     ;                               if (a != 0) $9f40; // //bne $9f40
  132                     ;                       }
  133                     ;               }
  134                     ;       } else {
  135                     ;$9f1b:
  136                     ;               a = $6e[y = #31];
  137                     ;               if (a < 0) $9f37;       //bmi
  138                     ;$9f21:         if ((a & 1) == 0) $9f37; //beq
  139                     ;$9f25:
  140                     ;               a = $6e[++y];
  141                     ;               if (a < 0) $9f37;
  142                     ;               if ((a & 1) != 0) {     //beq $9f37;
  143                     ;$9f2e:
  144                     ;                       $741f++;
  145                     ;                       $741e++;
  146                     ;                       goto $9f40:
  147                     ;               }
  148                     ;$9f37:
  149                     ;               a = $6e[y = #31] | $6e[++y];
  150                     ;               if (a == 0) $9f2e;
  151                     ;       }
  152                     ;$9f40:
  153                     ;       y = #16;
  154                     ;       for (x = 0;x != 0xa;x++) {
  155                     ;               $7440.x = $7420.x = $6e[y++]; //atk (left/right)
  156                     ;       }
  157                     ;       for (x;x != 0xf;x++) {  //x:a-f
  158                     ;               $7420.x = $6e[y++];     //def
  159                     ;       }
  160                     ;       y = #27;
  161                     ;       for (x;x != 0x12;x++) { //x:f-12
  162                     ;               $7420.x = $6e[y++];     //$742f~7431 = 27,28,29
  163                     ;       }
  164                     ;$9f6a: //for($741f-;$741f!=0;$741f--){ //$a15a
  165                     ;       $24,25 = $7441,7442;
  166                     ;       x = $62;        //attackerIndex*2
  167                     ;       a = $f0.x & 4;  //4=status.blind
  168                     ;       if (a != 0) {
  169                     ;               $25 >>= 1;
  170                     ;       }
  171                     ;$9f7e:
  172                     ;       if (0 == (a = $6e[y = #33]) & 4) {
  173                     ;               a = $6e[y = #2c];
  174                     ;               if (a >= 0) {
  175                     ;                       //味方
  176                     ;                       $31:a397();
  177                     ;                       if (carry) goto $9fa6;
  178                     ;               }
  179                     ;$9f91:
  180                     ;               a = $6e[y = #33] & 1;   //後列判定?
  181                     ;               if (0 != a) {
  182                     ;                       $25 >>= 1;
  183                     ;               }
  184                     ;$9f9b:
  185                     ;               a = $70[y] & 1;         //後列判定?
  186                     ;               if (0 != a) {
  187                     ;                       $7ce9++;
  188                     ;                       $25 >>= 1;
  189                     ;               }
  190                     ;       }
  191                     ;$9fa6:
  192                     ;       $7c = getRandomSucceededCount(try:$24, rate:$25);       //$31:bb28(); $24=回数,$25成功率
  193                     ;//
  194                     ;       $24,25 = $742b,742c;    //def,evade
  195                     ;       x = $64;                //attackerIndex*2
  196                     ;       a = $e0.x & 4;          //target.status0.blind
  197                     ;       if (a != 0) { //beq 9fbf
  198                     ;               $25 >>= 1;
  199                     ;       }
  200                     ;$9fbf:
  201                     ;       //if (($e0.x & #28) == 0) {//bne 9fcb
  202                     ;       //      if ($70[y = #27] == 0) beq 9fcf
  203                     ;       //}
  204                     ;       if (($e0.x & #28) != 0 || $70[y = #27] != 0) {
  205                     ;$9fcb:
  206                     ;               $24 = 0;        //蛙か小人か対象が溜めている
  207                     ;       }
  208                     ;$9fcf:
  209                     ;       getRandomSucceededCount(try:$24, rate:$25 );    //$bb28();
  210                     ;       if ((a = $7ce9) != 0) { //beq $9fd9;
  211                     ;               $30++;  //防御側が後列なら防御成功回数1回保証
  212                     ;       }
  213                     ;$9fd9:
  214                     ;       $7c = $24 = a = atkCount - defCount > 0 ? atkCount - defCount : 0;//$7c=atkcount $30=defcount
  215                     ;       if (a == 0) {   //miss!
  216                     ;               $6e[y = #27] = 0;
  217                     ;               goto $31:a139;
  218                     ;       }
  219                     ;$9ff1: //hit!
  220                     ;       a = $70[y = #12] & $7440;       //$70[12]:防御側弱点属性 $7440:攻撃属性
  221                     ;       if (0 != a) {
  222                     ;               a = 4;
  223                     ;       } else {
  224                     ;$9ffe:
  225                     ;               a = $742a;      //$742a:耐性属性
  226                     ;               if (a != 2) {
  227                     ;                       a &= $7440;
  228                     ;                       if (a == 0) {
  229                     ;$a00e:
  230                     ;                               a = 2;
  231                     ;                               goto $a010;
  232                     ;                       }
  233                     ;               }
  234                     ;$a00a:
  235                     ;               a = 1;
  236                     ;       }
  237                     ;$a010:
  238                     ;       $27 = a;        //耐:1 普:2 弱:4
  239                     ;       $2b = x = 0;
  240                     ;       $2a = ++x;      //=1
  241                     ;       $28 = $7431;    //=$6e[#29]
  242                     ;       $29 = a = 0;
  243                     ;       $25 = $7443;    //atk
  244                     ;$a027:
  245                     ;       if (getActor2C() >= 0) { //$a2b5
  246                     ;               addToAttackOffsetOf(y = #38);   //y = #38; $a389();
  247                     ;               addToAttackOffsetOf(++y);       //y++; $a389();
  248                     ;       }
  249                     ;$a035:
  250                     ;       $26 = $742d;    //def
  251                     ;       if (getTarget2C() >= 0) {       //$bc25
  252                     ;$a03f:
  253                     ;               x = a & 7;
  254                     ;               //防御中なら$26(防御)2倍(128以上なら255)
  255                     ;               if ($7ce4.x != 0) { //beq a055
  256                     ;$a047:
  257                     ;                       if ($26 >= #80) { //bcc $a053
  258                     ;$a04d:
  259                     ;                               $26 = #ff;
  260                     ;                       } else {
  261                     ;$a053:
  262                     ;                               $26 <<= 1;
  263                     ;                       }
  264                     ;               }
  265                     ;       }
  266                     ;$a055:
  267                     ;       a = $f0.(x = $62) & #28; //actor.status0 & toad|minimum
  268                     ;       if (a != 0) { //beq a061
  269                     ;               $25 = 1;
  270                     ;       }
  271                     ;$a061:
  272                     ;       a = $e0.(x = $64) & #28; //target.status0 & toad|minimum
  273                     ;       if (a != 0 || $70[y = #27] != 0) {
  274                     ;$a06f:
  275                     ;               $25,2b <<= 1;
  276                     ;               $26 = 0;
  277                     ;       }
  278                     ;$a077:
  279                     ;       getRandom(#63);//$beb4()
  280                     ;       if (a < $7430) { //$7430 = $6e[#28]
  281                     ;               $29++; $cb++;
  282                     ;       }
  283                     ;$a085:
  284                     ;       x = $62;
  285                     ;       a = $f0.x & 0x28;
  286                     ;       if (0 != a) {
  287                     ;               $cb = $29 = 0;
  288                     ;       }
  289                     ;$a093:
  290                     ;       calcDamage();   //$31:bb44(); result:$1c,1d
  291                     ;       if ($29 != 0) {
  292                     ;               x = $78ee;
  293                     ;               $78da.x = #34;  //critical hit!
  294                     ;               $78ee++;
  295                     ;       }
  296                     ;$a0a5:
  297                     ;       a = $6e[y = #27];
  298                     ;       if (0 != a) {
  299                     ;               x = a;x++;
  300                     ;               $18 = x;
  301                     ;               $19 = $6e[y] = a = 0;
  302                     ;               $1a,1b = $1c,1d;
  303                     ;               mul16x16();     //$3f:fcf5
  304                     ;       }
  305                     ;$a0c0:
  306                     ;       if ($1c,1d == 0) { $1c++; }
  307                     ;$a0c8:
  308                     ;       $78,79 = $1c,1d;
  309                     ;       $24,25 = $70,71;
  310                     ;       y = #12; a = $7440 & 1;
  311                     ;       if (a != 0) { //吸収属性あり
  312                     ;               isTargetWeakAtHoly();   //$bbe2();
  313                     ;               if (!carry) { 
  314                     ;                       sumDamageForDisplay(damage:$78);        //$a368();
  315                     ;               }
  316                     ;               getTarget2C();  //$bc25();
  317                     ;               $18 = a & 0x87;
  318                     ;               getActor2C();   //$a2b5();
  319                     ;               a &= 0x87;
  320                     ;$a0f7:
  321                     ;               if (a != $18) { //target!=actor
  322                     ;$a0f9:
  323                     ;                       $bd67();
  324                     ;                       goto $a10d;
  325                     ;$a10d:
  326                     ;                       a = $26;
  327                     ;                       if (a == 0) goto $a129;
  328                     ;                       else if (a < 0) goto $a11e;
  329                     ;                       goto $a113;
  330                     ;               }
  331                     ;       } else {
  332                     ;$a0ff:
  333                     ;               $26 = 0;
  334                     ;               sumDamageForDisplay();//$a368();
  335                     ;       }
  336                     ;$a106:
  337                     ;       applyDamage();  //$bcd2();
  338                     ;       if (!carry) {
  339                     ;$a113:         //dead
  340                     ;               $e0.(x = $64) |= #80;
  341                     ;               goto $a139;
  342                     ;$a11e:
  343                     ;               $f0.(x = $62) |= #80;
  344                     ;               goto $a139;
  345                     ;       } else {
  346                     ;$a129:         //alive
  347                     ;               a = $7ed8;
  348                     ;               if (a >= 0) {
  349                     ;                       a = $6e[y = 1] & 0x28;
  350                     ;                       if (0 == a) {
  351                     ;                               checkStatusEffect();//$31:be14();
  352                     ;                       }
  353                     ;               }
  354                     ;       }
  355                     ;$a139: //hit数0(=ミス)ならここまで飛んでくる
  356                     ;       a = --$741f;
  357                     ;       if (0 != a) {
  358                     ;               for (x = 0;x != 5;x++) {
  359                     ;                       $7440.x = $7425.x;
  360                     ;               }
  361                     ;               $7d = $7c; 
  362                     ;               $79 = $78 = $7c = 0;
  363                     ;               goto $9f6a;
  364                     ;       }
  365                     ;$a15d:
  366                     ;       a = $741e;
  367                     ;       if (0 != a) {
  368                     ;               push (a = $7c);
  369                     ;               $7c = a = $7d;
  370                     ;               $7d = pop a;
  371                     ;       }
  372                     ;$a16c:
  373                     ;       y = $64;
  374                     ;       $bb = a = $7c;  //hit count (1st hand)
  375                     ;       a |= $7d;
  376                     ;       if (a == 0) { //bne a184
  377                     ;               $7e4f.y = $bc = a;
  378                     ;               y++;
  379                     ;               $7e4f.y = #40;
  380                     ;               //goto $a264;
  381                     ;       } else {
  382                     ;$a184:
  383                     ;               $bc = $7d;      //hit count (2nd)
  384                     ;               $78,79 = $6e[y = #3],$6e[++y];  //actor.hp
  385                     ;               x = $62;
  386                     ;               getActor2C();   //$a2b5();
  387                     ;               $18 = a & #87;
  388                     ;               if (($70[y] & #87) == $18) beq $a203;
  389                     ;$a1a4:
  390                     ;               if ($40,41 >= $78,79) { //bcc $a1da;    //actorHpBeforeAttack >= actor.hp
  391                     ;$a1af:
  392                     ;                       $7e5f.x = ($40,41 - $78,79);
  393                     ;                       a = ($6e[y = #16] | $6e[y = #1b]) & 1;  //左手と右手の攻撃属性
  394                     ;                       if (a == 0) beq $a1d7;
  395                     ;$a1cf:
  396                     ;                       $78da.(x = $78ee) = #27;        //"HPをぎゃくにすいとられた!"
  397                     ;$a1d7:
  398                     ;                       //goto $a203;
  399                     ;               } else {
  400                     ;$a1da:                 //攻撃者のHPが攻撃前より増えている
  401                     ;                       $7e5f.x = ($78,79 - $40,41) | #8000;
  402                     ;$a1ec:
  403                     ;                       getActor2C();   //$a2b5();
  404                     ;                       if (a >= 0) { //bmi $a1fb
  405                     ;                               $78da.(x = $78ee) = #25; //"HPをきゅうしゅうした!"
  406                     ;                       } else {
  407                     ;$a1fb:
  408                     ;                               $78da.(x = $78ee) = #26; //"HPをすいとられた!"
  409                     ;                       }
  410                     ;$a203:         }
  411                     ;               $43 = 0;
  412                     ;               a = $78da.(x = $78ee);
  413                     ;               if (a != #ff) {
  414                     ;                       $43++; $78ee++;
  415                     ;               }
  416                     ;$a216:
  417                     ;               x = $62;
  418                     ;               a = ($7e5f.(++x) & #7f) | $7e5f.(--x);
  419                     ;               if (a == 0) { //bne $a23c
  420                     ;$a224:
  421                     ;                       $7e5f.x = #ffff;
  422                     ;                       if ($43 != 0) {
  423                     ;                               x = --$78ee;
  424                     ;                               $78da.x = #ff;
  425                     ;                       }
  426                     ;               }
  427                     ;$a23c:
  428                     ;               x = $64;
  429                     ;               if ($42 != 0) { //beq $a259
  430                     ;                       $7e4f.x = ($70[y = 3,4] - $3c,3d) | #8000;      //$3c: targetHpBeforeAttack
  431                     ;                       //bne a264 (always satisfied)
  432                     ;               } else {
  433                     ;$a259:
  434                     ;                       $7e4f.x = $6a,6b
  435                     ;               }
  436                     ;       } //$7c | $7d == 0 (whether miss or not)
  437                     ;$a264:
  438                     ;       //$74:count of char who try to escape
  439                     ;       if ($74 != 0) { //beq a288
  440                     ;               if (getActor2C() < 0) { //bpl a288
  441                     ;                       $70[y = #27] -= 1;
  442                     ;                       if ($7c != 0) { //beq a288
  443                     ;                               $78da.(x = $78ee) = #55; //"にげごしで ぼうぎょできなかった!"
  444                     ;                               $78ee++;
  445                     ;                       }
  446                     ;               }
  447                     ;       }
  448                     ;$a288: 
  449                     ;       if (getActor2C() < 0) return getActor2C();//bmi a2b5
  450                     ;$a28d:
  451                     ;       checkSegmentation();    //$bf53();
  452                     ;       //if ((a = $6e[y = #31]) >= 0) {        //bmi a29a
  453                     ;       //      if ((a & 1) == 0) { //bne a2a6
  454                     ;       if ((a = $6e[y = #31] < 0)
  455                     ;               || (a & 1) != 0)
  456                     ;       {
  457                     ;$a29a:
  458                     ;               if ($7d == 0) {
  459                     ;$a29e:
  460                     ;                       $bc = $7c;
  461                     ;                       $bb = 0;
  462                     ;               }
  463                     ;       }
  464                     ;$a2a6:
  465                     ;       a = $6e[y = #33] & 4;
  466                     ;       if (a != 0) {
  467                     ;               $bb = $7c + $7d;
  468                     ;       }
  469                     ;$a2b5:
  470                     ;       return getActor2C(); //fall through
  471                     ;}
  472                     ;------------------------------------------------------------------------------------------------------
  473                             INIT_PATCH $31,$bd67,$bdaa
                0031              .bank   $31
                BD67              .org    $bd67
       31:BD67                    .ds             (($bdaa) - ($bd67))
                BD67              .org    $bd67
  474                     ;$31:bd67 spoilHp
  475  31:BD67            spoilHp:
  476           0026      .deadFlag = $26
  477           0042      .undead = $42
  478           0078      .damage = $78
  479           0024      .pCalc = $24
  480           006E      .pActor = $6e
  481           0070      .pTarget = $70
  482                     ;
  483  31:BD67  A9 00             lda #0
  484  31:BD69  85 26             sta <.deadFlag
  485  31:BD6B  20 E2 BB          jsr isTargetWeakToHoly  ;bbe2
  486  31:BD6E  90 0F             bcc .normal_target
  487                             ;undead
  488  31:BD70  A5 70                     lda <.pTarget
  489  31:BD72  48                        pha
  490  31:BD73  A5 71                     lda <.pTarget+1
  491  31:BD75  48                        pha
  492  31:BD76  20 B3 BD                  jsr set24ToActor
  493  31:BD79  E6 42                     inc <.undead
  494  31:BD7B  A9 81                     lda #$81
  495  31:BD7D  D0 08                     bne .do_damage
  496  31:BD7F            .normal_target:
  497  31:BD7F  A5 6E                     lda <.pActor
  498  31:BD81  48                        pha
  499  31:BD82  A5 6F                     lda <.pActor+1
  500  31:BD84  48                        pha
  501  31:BD85  A9 01                     lda #$01
  502  31:BD87            .do_damage:
  503  31:BD87  48                pha
  504  31:BD88  20 D2 BC          jsr damageHp    ;bcd2
  505  31:BD8B  68                pla
  506  31:BD8C  B0 02             bcs .alive
  507                             ;dead
  508  31:BD8E  85 26                     sta <.deadFlag
  509  31:BD90            .alive:
  510  31:BD90  A0 2E             ldy #$2e
  511  31:BD92  B1 6E             lda [.pActor],y
  512  31:BD94  C9 04             cmp #$04        ;fight
  513  31:BD96  D0 03             bne .do_heal
  514  31:BD98  20 AA BD                  jsr shiftRightDamageBy2 ;bdaa
  515  31:BD9B            .do_heal:
  516  31:BD9B  68                pla
  517  31:BD9C  85 25             sta <.pCalc+1
  518  31:BD9E  68                pla
  519  31:BD9F  85 24             sta <.pCalc
  520  31:BDA1  4C 24 BD          jmp healHp
  521                     ;$bdaa
  522                     
  523                     ;======================================================================================================
  524                             RESTORE_PC ff3_battle_calc_begin
                0035              .bank   BANK(ff3_battle_calc_begin)
                B947              .org    ff3_battle_calc_begin
#[3]   ff3_hack_master.asm
   56                     
   57           0001                      .ifdef EXPERIMENTAL
#[4]   ff3_experimental.asm
   58                                             .include "ff3_experimental.asm"
    1                     ; ff3_experimental.asm
    2                     ;
    3                     ;       experimental code
    4                     ;
    5                     ;       to invoke,push [select] button in command-window
    6                     ;       code must reurn to 'returnAddress'
    7                     ;======================================================================================================
    8  35:B947            ff3_experimental_begin:
    9                     ;EXPERIMENT_IMPL = 4
   10                     ;3 = measure draw8linewindow performance
   11                     ;4 = SE test
   12                     ;------------------------------------------------------------------------------------------------------
   13           0034              .bank   $68acf >> 13
   14           8AD3              .org    ($8000 + ($68acf & $7fff)) + ($02 * 2)
   15  34:8AD3                    commandWindowInputHandlers_02:
   16  34:8AD3  C5 93                     .dw commandWindow_OnSelect      ;original: $8abe
   17                     ;-----------------------------------------------------------------------------------------------------
   18                             RESTORE_PC calcAbyss_end
                0034              .bank   BANK(calcAbyss_end)
                93C5              .org    calcAbyss_end
   19  34:93C5            commandWindow_OnSelect:
   20                     ;------------------------------------------------------------------------------------------------------
   21           0000              .if EXPERIMENT_IMPL = 1
   61                             .endif  ;EXPERIMENT_IMPL
   62           0000              .if EXPERIMENT_IMPL = 2
   85                             .endif  ;EXPERIMENT_IMPL
   86           0000              .if EXPERIMENT_IMPL = 3
  198                             .ENDIF  ;EXPERIMENT_IMPL = 3
  199           0000              .if EXPERIMENT_IMPL = 4
  304                             .ENDIF
  305           0001              .if EXPERIMENT_IMPL = 5
  306                                     ;encounter select
  307  34:93C5                    selectEncounterId:
  308  34:93C5  A2 03                     ldx #3
  309  34:93C7                    .wait_loop:
  310  34:93C7  20 80 FB                          jsr waitNmi
  311  34:93CA  CA                                dex
  312  34:93CB  D0 FA                             bne .wait_loop
  313  34:93CD  AC ED 7C                  ldy encounterId
  314  34:93D0                    .show_current_id:
  315  34:93D0  98                        tya
  316  34:93D1  48                        pha
  317                     
  318  34:93D2  A2 08                     ldx #8
  319  34:93D4  20 49 A5                  jsr initString
  320  34:93D7  20 54 97                  jsr initTileArrayStorage
  321  34:93DA  68                        pla
  322  34:93DB  48                        pha
  323  34:93DC  20 25 A6                  jsr itoa_8
  324  34:93DF  A2 02                     ldx #2
  325  34:93E1                    .copy_number:   
  326  34:93E1  B5 1A                             lda <$1a,x
  327  34:93E3  9D DB 7A                          sta stringCache+4,x
  328  34:93E6  CA                                dex
  329  34:93E7  10 F8                             bpl .copy_number
  330  34:93E9  A9 08                     lda #8
  331  34:93EB  85 18                     sta <$18
  332  34:93ED  20 6A 96                  jsr strToTileArray
  333  34:93F0  A9 03                     lda #3
  334  34:93F2  20 1B 8D                  jsr draw1LineWindow
  335  34:93F5  68                        pla
  336  34:93F6  A8                        tay
  337  34:93F7                    .input_handler:
  338  34:93F7  98                                tya
  339  34:93F8  48                                pha
  340  34:93F9  20 AA FB                          jsr getPad1Input
  341  34:93FC  AA                                tax
  342  34:93FD  68                                pla
  343  34:93FE  A8                                tay     ;index
  344  34:93FF  8A                                txa
  345                     
  346  34:9400  4A                                lsr a
  347  34:9401  B0 29                             bcs .OnA
  348  34:9403  4A                                lsr a
  349  34:9404  B0 2A                             bcs .OnB
  350  34:9406  4A                                lsr a
  351  34:9407  B0 4E                             bcs .OnSelect
  352  34:9409  4A                                lsr a
  353  34:940A  4A                                lsr a
  354  34:940B  B0 11                             bcs .OnUp
  355  34:940D  4A                                lsr a
  356  34:940E  B0 19                             bcs .OnDown
  357  34:9410  4A                                lsr a
  358  34:9411  B0 0E                             bcs .OnLeft
  359  34:9413  4A                                lsr a
  360  34:9414  90 E1                             bcc .input_handler
  361  34:9416                            .OnRight:
  362  34:9416  98                                tya
  363  34:9417  18                                clc
  364  34:9418  69 0A                             adc #10
  365  34:941A  A8                                tay
  366  34:941B  4C D0 93                          jmp .show_current_id
  367  34:941E                            .OnUp:
  368  34:941E  C8                                iny
  369  34:941F  B0 AF                             bcs .show_current_id
  370  34:9421                            .OnLeft:
  371  34:9421  98                                tya
  372  34:9422  38                                sec
  373  34:9423  E9 0A                             sbc #10
  374  34:9425  A8                                tay
  375  34:9426  4C D0 93                          jmp .show_current_id
  376  34:9429                            .OnDown:
  377  34:9429  88                                dey
  378  34:942A  B0 A4                             bcs .show_current_id
  379  34:942C                            .OnA:
  380  34:942C  A9 00                             lda #0
  381  34:942E  F0 02                             beq .reencounter
  382  34:9430                            .OnB:
  383  34:9430  A9 01                             lda #1
  384  34:9432                            .reencounter:
  385  34:9432  48                                pha
  386  34:9433  98                                tya
  387  34:9434  48                                pha
  388  34:9435  20 73 FA                          jsr $fa73       ;post battleLoop
  389  34:9438  68                                pla
  390  34:9439  8D ED 7C                          sta encounterId
  391  34:943C  68                                pla
  392  34:943D  8D EE 7C                          sta encounterId+1
  393  34:9440  A2 06                             ldx #6  ;getInputAndUpdateCursorWithSound/getPlayerCommandInput/battleLoop/
  394  34:9442                            .pop_retaddrs:
  395  34:9442  68                                        pla
  396  34:9443  CA                                        dex
  397  34:9444  D0 FC                                     bne .pop_retaddrs
  398                                             
  399  34:9446  A9 81                             lda #$81
  400  34:9448  8D D8 7E                          sta battleMode
  401  34:944B  AD ED 7C                          lda encounterId
  402  34:944E  AE EE 7C                          ldx encounterId+1
  403  34:9451  AC EE 7C                          ldy encounterId+1       ;
  404  34:9454  4C 26 FA                          jmp doBattle
  405  34:9457                            .OnSelect:
  406  34:9457  A9 02                             lda #$02
  407  34:9459  85 50                             sta <$50
  408  34:945B  60                                rts
  409                             .endif
#[3]   ff3_hack_master.asm
   59                                     .endif  ;EXPERIMENTAL
   60                             .endif  ;BETA
   61                     
   62                             ;.include "ff3_battle_calc.asm"
   63                     ;==========================================================================================================
#[2]   ff3_hack_beta.asm
#[1]   ff3_hack_encounter.asm
