#[1]   ff3_hack_beta.asm
   15                     ;----------------------------------------------------------------------------------------------------------
   16           0000              .ifdef BALANCED_VERSION
   22                             .else
   23  00:0000                            .incbin "base-binary/ff3_hack_base.nes.noheader"        ;header must be stripped
   24                             .endif  ;BALANCED_VERSION
#[3]   ff3_asm.h
   25                             .include "ff3_asm.h"
    1                     ; ff3_asm.h
    2                     ;
    3                     ; include file for hackcodes
    4                     ;======================================================================================================
    5                     ;consts
#[4]   ff3_const.h
    6                             .include "ff3_const.h"
    1                     ; ff3_const.h
    2                     ;
    3                     ; various constant value definitions
    4                     ;--------------------------------------------------------------------------------
    5                     ; original consts
    6                     
    7                     ;--------------------------------------------------------------------------------
    8                     ;status flags
    9                     ;
   10           0001      STATUS_LITE_MASK        = $01
   11                     ; heavy
   12           0002      STATUS_POISON           = $02
   13           0004      STATUS_BLIND            = $04
   14           0008      STATUS_MINIMUM          = $08
   15           0010      STATUS_SEALED           = $10
   16           0020      STATUS_TOAD             = $20
   17           0040      STATUS_STONE            = $40
   18           0080      STATUS_DEAD             = $80
   19                     ; lite
   20           0001      STATUS_JUMPING          = $01   ; valid only in battle (cannot enchant)
   21           0006      STATUS_PETRIFY_MASK     = $06
   22           0018      STATUS_REMAIN_MASK      = $18
   23           0020      STATUS_CONFUSED         = $20
   24           0040      STATUS_SLEEPING         = $40
   25           0080      STATUS_PARALYZED        = $80
   26                     
   27                     ;--------------------------------------------------------------------------------
   28                     ;BattleChar related
   29                     ;
   30           0001      BP_OFFSET_STATUS_HEAVY          = $01
   31           0002      BP_OFFSET_STATUS_LITE           = $02
   32           001E      X_BP_OFFSET_PARAM                       = $1e
   33           001F      X_BP_OFFSET_TYPE                        = $1f
   34           0027      BP_OFFSET_ATTACK_MULTIPLIER = $27
   35           0028      BP_OFFSET_CRITICAL_RATE         = $28
   36           002C      BP_OFFSET_INDEX_AND_MODE        = $2c
   37           002E      BP_OFFSET_ACTION_ID             = $2e
   38           002F      BP_OFFSET_ACTION_TARGET = $2f
   39           0030      BP_OFFSET_TARGET_FLAG           = $30
   40           0037      BP_OFFSET_SPECIAL_RATE          = $37
   41                     
   42           0080      TARGET_ENEMY_PARTY      = $80
   43           0040      TARGET_MULTIPLE         = $40
   44                     
   45                     ;--------------------------------------------------------------------------------
   46                     ; action ids
   47                     ;
   48                     
   49           0000      ACTION_NOTHING  = $00
   50           0004      ACTION_FIGHT    = $04
   51           0006      ACTION_ESCAPE   = $06
   52                     
   53                     
   54                     ;--------------------------------------------------------------------------------
   55                     ; job ids
   56                     ;
   57                     
   58           0008      JOB_THIEF       = $08
   59                     
   60                     ;--------------------------------------------------------------------------------
   61                     ; chip ids
   62                     ;
   63                     
   64           007C      CHIPID_TREASURE_BOX = $7c
   65           007D      CHIPID_OPENED_TREASURE_BOX = $7d
   66                     
   67                     ;--------------------------------------------------------------------------------
   68                     ; treasure
   69                     
   70           00E0      TREASURE_WITH_ENCOUNTER_BASE = $e0
   71                     
   72                     ;--------------------------------------------------------------------------------
   73                     ; event flags
   74                     
   75           0020      EVENT_FLAG_ENCOUNTER = $20
   76                     
   77                     ;--------------------------------------------------------------------------------
   78                     ; extention to original
   79                     
   80                     ;EXSTATUS_OFFSET_PARAM  = $1e
   81                     ;EXSTATUS_OFFSET_TYPE   = $1f
   82                     
   83           0019      EFFECT_PROVOKE  = $19
   84           001A      EFFECT_ABYSS    = $1a
   85                     
   86           0016      CMDX_ID_BEGIN           = $16
   87           0016      CMDX_PROVOKE            = $16
   88           0017      CMDX_DISORDERED_SHOT= $17
   89           0018      CMDX_ABYSS                      = $18
   90           0019      CMDX_RAID                       = $19
   91           001A      CMDX_ID_END                     = $1a
   92                     
   93           0006      BATTLE_PROCESS_EX_DISORDERED_SHOT = $06
   94                     
   95           0026      PRESENT_SCENE_EX_BLOWONLY = $26
   96           0027      PRESENT_SCENE_EX_ABYSS = $27
   97                     
   98           000A      BF_PICK_RANDOM_TARGET = $0a
   99           000B      BF_GET_RANDOM_SUCCEEDED_COUNT = $0b
  100           000C      BF_CALC_DAMAGE = $0c
#[3]   ff3_asm.h
    7                     ;proc addrs
#[4]   ff3_30-31.h
    8                             .include "ff3_30-31.h"
    1                     ; ff3_30-31.h
    2                     ;
    3                     ;description:
    4                     ;       include file for bank $30,$31
    5                     ;
    6                     ;version:
    7                     ;       v0.05 (2007-08-21)
    8                     ;
    9                     ;======================================================================================================
   10                     ;$30-31
   11           22B5      b31_getActor2C                          = $a2b5 ;2c:index & flag
   12           22BA      cacheStatus                                     = $a2ba
   13           3300      getRandomTarget                         = $a300
   14           3368      sumDamage                                       = $a368
   15           3389      addValueAtOffsetToAttack        = $a389
   16           3397      isRangedWeapon                          = $a397
   17           4482      loadPlayerParam                         = $a482
   18           44F6      loadEnemyParam                          = $a4f6
   19           88C8      getActionMode                           = $a8c8 ;[in] $2c: battleChar* [out] y : #2c, a : $24.+2c
   20           88CD      setRandomTargetFromEnemyParty = $a8cd   ;[in] BattleChar* $24
   21           88EC      getLeastLvInPlayerParty         = $a8ec
   22           991B      decideEnemyActionTarget         = $a91b
   23           99F7      isValidTarget                           = $a9f7 ;[out] bool zero :valid
   24           AA16      recalcPlayerParam                       = $aa16
   25           FF77      calcAction                                      = $af77
   26           99AB      segmentate                                      = $b9ab
   27                     ;getRandomSucceededCount                = $bb28 ;$24:count, $25:rate, [out] $30:succeededCount
   28           BB28      getNumberOfRandomSuccess        = $bb28
   29           BB44      calcDamage                                      = $bb44 ;[out] $1c,1d : damage
   30           BBE2      isTargetWeakToHoly                      = $bbe2 ;[out] $27: 2=weak
   31           CC25      b31_getTarget2C                         = $bc25
   32                     ;applyDamage                                    = $bcd2
   33           CCD2      damageHp                                        = $bcd2
   34           DD24      healHp                                          = $bd24
   35           DDAA      shiftRightDamageBy2                     = $bdaa
   36           DDB3      set24ToActor                            = $bdb3
   37           DDBC      set24ToTarget                           = $bdbc
   38           EE14      checkEnchantedStatus            = $be14
   39           EE90      b31_updatePlayerOffset          = $be90
   40           EE98      b31_setYtoOffsetOf                      = $be98
   41           EE9D      calcDataAddress                         = $be9d
   42           EEB4      b31_getBattleRandom                     = $beb4
   43           FF53      checkSegment                            = $bf53
#[3]   ff3_asm.h
#[4]   ff3_32-33.h
    9                             .include "ff3_32-33.h"
    1                     ; ff3_32-33.h
    2                     ;
    3                     ;description:
    4                     ;       include file for bank $32,33
    5                     ;
    6                     ;version:
    7                     ;       v0.02 (2006-10-23)
    8                     ;
    9                     ;======================================================================================================
   10                     ;$32-33
   11           AAE6      incrementSwingFrame                     = $8ae6 ;a = ++$b6
   12           0059      beginSwingFrame                         = $a059 ;$b6 = 0
   13           0094      blowEffect_limitHitCount        = $a094
   14           00C0      effect_playerBlow                       = $a0c0 ;[effectFunction_04]
   15           2245      getSwingCountOfCurrentHand      = $a245
   16           444F      getSys0Random_00_ff                     = $a44f
#[3]   ff3_asm.h
#[4]   ff3_34-35.h
   10                             .include "ff3_34-35.h"
    1                     ; ff3_34-35.h
    2                     ;
    3                     ;description:
    4                     ;       label definition for bank $34-35
    5                     ;
    6                     ;version:
    7                     ;       0.03 (2006-10-19)
    8                     ;
    9                     ;======================================================================================================
   10                     ;$34-35
   11           001E      dispatchBattleFunction_03       = $801e
   12           0026      dispatchBattleFunction_05       = $8026
   13           002A      dispatchBattleFunction_06       = $802a
   14           002E      dispatchBattleFunction_07       = $802e
   15           1185      presentCharacter                        = $8185
   16                     ;playEffect                                     = $8411 ;hacked
   17                     ;set52toIndexFromActorBit       = $8532 ;[in] $7e98 : target indicator bits?,
   18           5545      dispatchPresentScene_1f         = $8545
   19           66AB      targetBitToCharIndex            = $86ab ;[in] x = side? [out] y = index
   20           992E      tileSprites2x2                          = $892e
   21           9966      loadCursor                                      = $8966
   22           999E      getInputAndUpdateCursorWithSound = $899e
   23           AADF      clearSprites2x2                         = $8adf
   24                     
   25           BB38      draw8LineWindow                         = $8b38 ;[in] $18:left, $19:right, $1a:borderFlag, $7ac0:tilePtr
   26           DD03      setBackgroundProperty           = $8d03 ;
   27           DD1B      draw1LineWindow                         = $8d1b ;[in] $18:windowkind
   28           EEB0      eraseWindow                                     = $8eb0
   29           FF0B      eraseFromLeftBottom0Bx0A        = $8f0b
   30           11CE      setNoTargetMessage                      = $91ce
   31           55BD      setBaseAddrTo_8a40                      = $95bd
   32           55C6      setBaseAddrTo_8c40                      = $95c6
   33           55CF      set18toTargetCache                      = $95cf
   34           55E1      itoa_16                                         = $95e1
   35           666A      strToTileArray                          = $966a
   36                     ;initTileArrayStorage           = $9754 ;hacked (fill $7200[0x200] and set $4e to point $7200)
   37                     ;getCommandInput_next           = $99fd ;hacked
   38           AA69      createCommandWindow                     = $9a69
   39           AAE7      putCanceledItem                         = $9ae7
   40           BB79      requestSoundEffect18                    = $9b79 ;setCA_18_and_incC9
   41           BB7D      requestSoundEffect05                    = $9b7d ;setCA_05_and_incC9
   42           BB81      requestSoundEffect06                    = $9b81 ;setCA_06_and_incC9
   43           BB88      setYtoOffsetOf                          = $9b88 ;y = $5f + a
   44           BB8D      setYtoOffset03                          = $9b8d
   45           BB94      setYtoOffset2F                          = $9b94 ;target indicator
   46           BB9B      setYtoOffset2E                          = $9b9b ;action id
   47           BBA2      drawInfoWindow                          = $9ba2
   48           DD1D      cachePlayerStatus                       = $9d1d
   49           DD9E      drawEnemyNamesWindow            = $9d9e
   50           FF7B      setActorActionAndClearMode      = $9f7b
   51           FF87      setActionTargetToSelf           = $9f87
   52                     ;getIndexOfGreatest                     = $a30f ;hacked [in] u16 $1a[4] : values ,$24[4] : indices [out] x : index
   53           3353      consumeEquippedItem                     = $a353 ;x unchanges
   54           442E      getActor2C                                      = $a42e
   55           5541      getPlayerOffset                         = $a541
   56           5549      initString                                      = $a549 ;fill x bytes at $7ad7 #$00ff (null terminated)
   57           5558      offsetTilePtr                           = $a558
   58           5564      getSys1Random                           = $a564
   59           6609      loadString                                      = $a609
   60                     ;itemWindowInputLoop            = $aeaa ;hacked
   61                     ;endItemWindow                          = $b1b0 ;hacked
   62                     ;itemWindow_OnB                         = $b198 ;hacked
   63                     ;loadTileArrayForItemWindowColumn = $b48b
   64                     ;moveCursor                                     = $b4d4 ;hacked
   65                     ;itemWindow_OnUse                       = $b4f7 ;hacked
   66                     ;drawEquipWindow                        = $b419 ;hacked
   67                     ;drawEquipWindowNoErase         = $b5f9 ;hacked
   68                     ;isPlayerAllowedToUseItem       = $b8fd ;hacked
   69           9979      setActionTargetByParam          = $b979
   70           AA3A      loadTo7400FromBank30            = $ba3a
#[3]   ff3_asm.h
   11                     ;$3e-3f
   12           7750      field_callSoundDriver           = $c750
   13           998F      field_updateTileAttrCache       = $c98f ;field_update_window_attr_buff = $c98f
   14           99A9      field_setTileAttrForWindow      = $c9a9
   15           AAB1      field_merge_bg_attr_with_buffer = $cab1
   16           BB6B      field_update_vram_by_07d0       = $cb6b ;[in] $07d0[16]: vram address low, $07e0[16]: vram high, $07f0[16]: vram value
   17           CC18      field_hide_sprites_around_window = $ec18
   18           CCF5      field_restore_bank                      = $ecf5 ;[in] $57: bank
   19           CCFA      field_draw_choose_dialog        = $ecfa ;fall through to field_draw_window_box
   20                     ;field_init_window_attr_buffer  = $ed56
   21                     ;field_getWindowMetrics         = $ed61 ;[in] u8 $96: window_id / [out] $38, $39, $3c, $3d
   22           DDE1      field_setBgScrollTo0            = $ede1
   23                     ;field_calc_draw_width_and_init_window_tile_buffer = $f670
   24                     ;field_init_window_tile_buffer = $f683 ;fill 0780..79d/07c0..7dd with 0xFF
   25           66AA      field_drawWindowContent         = $f6aa
   26           7727      switchBanksTo3c3d                       = $f727
   27           88AA      do_sprite_dma_from_0200         = $f8aa
   28           88B0      updateDmaPpuScrollSyncNmiEx = $f8b0
   29           88C5      updateDmaPpuScrollSyncNmi       = $f8c5 ;(y is unchanged)
   30           88CB      updatePpuScrollNoWait           = $f8cb
   31           88E0      setVramAddr                                     = $f8e0 ;[in] a:high, x:low
   32           88EA      mul_8x8_reg                                     = $f8ea ;a,x = a * x
   33           AA0E      call_2e_9d53                            = $fa0e
   34           AA26      doBattle                                        = $fa26
   35           BB80      waitNmi                                         = $fb80 ;wait on $05 clear
   36           BB87      switchFirst2Banks                       = $fb87 ;[in] a : per16k bank index
   37           BBAA      getPad1Input                            = $fbaa ;[out] $12 : inputFlags
   38           BBEF      getBattleRandom                         = $fbef ;[out] a : rand [min:x - max:a] max included
   39           CC27      initBattleRandom                        = $fc27
   40           CC92      div_16                                          = $fc92 ;$1c = $18,19 / $1a,1b; $1d = $18,19 % $1a,1b
   41           CCD6      mul_8x8                                         = $fcd6 ;$1a,1b = a * x
   42           CCF5      mul_16x16                                       = $fcf5 ;$1c,1d,1e,1f = $18,19 * $1a,1b
   43           DD20      flagTargetBit                           = $fd20
   44           DD2C      clearTargetBit                          = $fd2c
   45           DD38      maskTargetBit                           = $fd38
   46           DD3C      shiftLeft6                                      = $fd3c
   47           DD43      shiftRight6                                     = $fd43
   48           DD4A      loadStringWorker                        = $fd4a
   49           DD60      get2byteAtBank18                        = $fd60
   50           DDA6      loadTo7400Ex                            = $fda6
   51           DDDC      copyTo7400                                      = $fddc
   52                     ;call_30_9e58                           = $fdf3
   53           DDF3      invoke_b30_battleFunction       = $fdf3
   54           FF00      waitNmiBySetHandler                     = $ff00
   55           FF03      call_switch_2banks                      = $ff03 ; => jmp $ff17
   56           FF06      call_switch1stBank                      = $ff06 ; => jmp $ff0c
   57           FF09      call_switch2ndBank                      = $ff09 ; => jmp $ff1f
   58                     ;----------------------------------------------------------------------------------------------------------
   59                     ;well known vars
   60           1101      pNmiHandler                     = $0101 ;$0100 jmp xxxx, sometimes just rti :$0100 rti (0x40)
   61           1104      pIrqHandler                     = $0104 ;$0103 jmp xxxx, sometimes just rti :$0103 rti
   62           0000      irqFlag                         = $00
   63           0001      enableScanlineCounter = $01     ;mmc3's irq
   64           0003      irqCountDown            = $03
   65           0005      nmiFlag                         = $05
   66           0006      ppuCtrl1SetOnNmi        = $06
   67           0008      ppuCtrl1SetOnIrq        = $08
   68           0009      ppuCtrl2SetOnNmi        = $09
   69           000C      scrollXSetOnNmi         = $0c
   70           000D      scrollYSetOnNmi         = $0d
   71           0010      scrollXSetOnIrq         = $10
   72           0011      scrollYSetOnIrq         = $11
   73           0012      inputBits                       = $12
   74           00B3      selectTarget_behavior           = $b3   ;param of presentSceneFunction10($2e:9d53)
   75           00B4      selectTarget_selectedBits       = $b4
   76           00B5      selectTarget_targetFlag         = $b5
   77           00C0      playerX                         = $c0   ;*4
   78           00C4      playerY                         = $c4   ;*4
   79           00C9      playSoundEffect         = $c9   ;1=play
   80           00CA      soundEffectId           = $ca   ; played on irq if $c9 != 0
   81           00E0      targetStatusCache       = $e0   ;in process battle phase
   82           00F0      actorStatusCache        = $f0   ;
   83           00F0      field_frame_counter     = $f0   ;
   84           2200      field_sprite_attr_cache         = $0200
   85           3300      field_bg_attr_table_cache       = $0300 ;128bytes. exactly the same format as what stored in PPU
   86           88D5      presentActionParams     = $78d5 ;?,actor,action,targetflag,effectmsg,messages
   87           88D5      battleProcessType       = $78d5
   88           88D7      actionName                      = $78d7
   89           88D8      targetName                      = $78d8
   90           88D9      effectMessage           = $78d9
   91           88DA      battleMessages          = $78da
   92           88EE      battleMessageCount      = $78ee
   93                     ;pTileArray                     = $7ac0
   94           AAC7      selectedMagicLv         = $7ac7 ;[4]
   95           AAD7      stringCache                     = $7ad7
   96           BBE3      battleRandoms           = $7be3
   97           CCED      encounterId                     = $7ced
   98           CCF3      isRendering                     = $7cf3
   99                     
  100           DD6B      groupToEnemyIdMap       = $7d6b ;*4
  101                     ;;indexToGroupMap               = $7da7
  102           DDD7      enemyPos                        = $7dd7 ;{x,y}*8
  103                     ;param for playing (magic) effect
  104           EE1F      play_weaponRight                = $7e1f
  105           EE20      play_weaponLeft                 = $7e20
  106           EE4F      play_damages                    = $7e4f
  107           EE6F      play_damageTarget               = $7e6f ;0=player
  108           EE98      play_actorBits                  = $7e98
  109           EE96      play_arrowTarget                = $7e96
  110           EE99      play_castTargetBits             = $7e99 ;battle
  111           EE9A      play_effectTargetSide   = $7e9a ;80:actor enemy 40:target enemy
  112           EE9B      play_effectTargetBits   = $7e9b ;param of presentActionEffect($33:b68d)
  113           EE9D      play_magicType                  = $7e9d
  114           EEB8      play_reflectedTargetBits= $7eb8 ;param of presentEffectAtTarget($33:b64f)
  115                     
  116           EEC2      effectHandlerIndex      = $7ec2 ;
  117           EEC3      effectHandlerFlag       = $7ec3
  118           EEC4      effect_enemyStatus      = $7ec4
  119           EECD      indexToGroupMap         = $7ecd ;*8
  120           EED8      battleMode                      = $7ed8 ; 80:boss? 20:fireCannon(invincible) 10:disallowEnlarge 08:? 01:disallowEscape
  121           EEDF      play_protectionTargetBits = $7edf
  122           EEE1      play_segmentedGroup = $7ee1
  123                     
  124           FF40      soundDriver_playingMusicId = $7f40
  125           FF41      soundDriver_lastMusicId = $7f41
  126           FF42      soundDriver_control     = $7f42 ;01:playNew(7f43) 02:playLast(7f41,saved when 01) 04:stop 80:playOn
  127           FF43      soundDriver_musicId     = $7f43
  128           FF49      soundDriver_effectId= $7f49     ;msb should be 1
  129                     ;----------------------------------------------------------------------------------------------------------
  130                     ;in memory structs
  131           00C0      backpackItems           = $60c0
  132           1100      playerBaseParams        = $6100
  133           2200      playerEquips            = $6200
  134           5575      playerBattleParams      = $7575 ;$40*4
  135           6675      enemyBattleParams       = $7675 ;$40*8
  136                     ;----------------------------------------------------------------------------------------------------------
  137                     ;in rom structs
  138           9900      userFlags                       = $00900
  139           0000      stringPtrTable          = $30000
  140           0000      monsterBaseParams       = $60000        ;8*256
  141           0000      monsterBattleParams = $61000
  142           4400      itemBaseParams          = $61400
  143           BB88      initialMps                      = $73b88
  144           DD59      lvupParamPtrTable       = $7ad59
  145                     ;handler tables
  146           33F8      commandIdToEffectMap    = $683f8
  147           443E      commandEffectHandlers   = $6843e
  148           AA16      commandWindowHandlers   = $69a16
  149           FFAC      commandHandlers                 = $69fac
  150                     ;------------------------------------------------------------------------------------------------------
  151           9900      TEMP_RAM = $7900        ;we cannot use stack regeon due to dugeon's floor save
  152                     ;------------------------------------------------------------------------------------------------------
  153                     
  154                     ;------------------------------------------------------------------------------------------------------
  155                     ;macros
  156                     INIT16  .macro  ;addr,val
  157                             lda #LOW(\2)
  158                             sta \1
  159                             lda #HIGH(\2)
  160                             sta \1+1
  161                                     .endm
  162                     
  163                     INIT16_x        .macro  ;addr,val
  164                             ldx #LOW(\2)
  165                             stx \1
  166                             ldx #HIGH(\2)
  167                             stx \1+1
  168                                     .endm
  169                                             
  170                     ADD16   .macro  ;addr,val               
  171                             lda \1
  172                             clc
  173                             adc #LOW(\2)
  174                             sta \1
  175                             lda \1+1
  176                             adc #HIGH(\2)
  177                             sta \1+1
  178                                     .endm
  179                     
  180                     ADD16by8        .macro
  181                             lda \1
  182                             clc
  183                             adc \2
  184                             sta \1
  185                             bcc .add16by8_\@
  186                                     inc \1+1
  187                             .add16by8_\@:
  188                             .endm
  189                     
  190                     SUB16   .macro  ;addr,val               
  191                             lda \1
  192                             sec
  193                             sbc #LOW(\2)
  194                             sta \1
  195                             lda \1+1
  196                             sbc #HIGH(\2)
  197                             sta \1+1
  198                                     .endm
  199                     
  200                     SUB16by8        .macro  ;addr,val
  201                             lda \1
  202                             sec
  203                             sbc \2
  204                             sta \1
  205                             bcs .sub16by8_\@
  206                                     dec \1+1
  207                             .sub16by8_\@:
  208                             .endm
  209                     
  210                     FILEORG .macro
  211                             .bank   (\1) >> 13
  212                             .org    ($8000 | ((\1) & $7fff))
  213                                     .endm
  214                                     
  215                     RESTORE_PC      .macro
  216                             .bank   BANK(\1)
  217                             .org    \1
  218                                     .endm
  219                                     
  220                     INIT_PATCH      .macro
  221                             .bank   \1
  222                             .org    \2
  223                             .ds             ((\3) - (\2))
  224                             .org    \2
  225                                     .endm
  226                     
  227           0000              .ifdef RESPECT_ORIGINAL_ADDR
  231                             .else
  232                     ORIGINAL_ADDR   .macro
  233                                     .endm
  234                             .endif
  235                             
  236                     ALIGN_EVEN      .macro  ;value to align
  237                             .check_align_\@:
  238                             .if (.check_align_\@ & 1) != 0
  239                                     nop     ;pad
  240                             .endif
  241                             .endm   ;ALIGN_EVEN
  242                     
  243                     VERIFY_PC       .macro
  244                             .verify_pc_\@:
  245                             .if (.verify_pc_\@ > \1)
  246                                     .fail
  247                             .endif
  248                             .endm   ;VERIFY_PC
#[2]   ff3_hack_master.asm
   26           0000              .bank   $00
   27           0000              .org    $8000
#[3]   ff3_string.asm
   28                             .include "ff3_string.asm"
    1                     ; ff3_string.asm
    2                     ;
    3                     ; string related codes in bank $34-35
    4                     ;
    5                     ;version:
    6                     ;       0.05 (2006-11-12)
    7                     ;======================================================================================================
    8  00:0000            ff3_string_begin:
    9                     
   10           2220      TILE_ARRAY_BASE = $7200+$20;(1 << UNROLL_SHIFT)
   11                     ;======================================================================================================
   12                     ;strToTileArray
   13                     ; 意外にもフィールドのルーチンからも呼ばれる模様
   14           0001              .ifdef ENABLE_strToTileArray
   15                             ;.bank  $34
   16                             ;.org   $966a
   17                             INIT_PATCH $34,$966a,$9754
                0034              .bank   $34
                666A              .org    $966a
       34:666A                    .ds             (($9754) - ($966a))
                666A              .org    $966a
   18                             
   19  34:666A            strToTileArray:
   20           0018      .cchLine        = $18
   21           001C      .char           = $1c
   22           001E      .pUpperLine     = $1e
   23           004E      .pTileArray     = $4e
   24           AAD7      .pString        = $7ad7
   25  34:666A  A5 4E             lda <.pTileArray
   26  34:666C  85 1E             sta <.pUpperLine
   27  34:666E  A5 4F             lda <.pTileArray+1
   28  34:6670  85 1F             sta <.pUpperLine+1
   29  34:6672  A5 18             lda <.cchLine
   30  34:6674  20 58 A5          jsr offsetTilePtr
   31                             
   32  34:6677  A0 00             ldy #0
   33  34:6679  A2 00             ldx #0
   34  34:667B            .decode_loop:
   35  34:667B  8A                txa
   36  34:667C  48                pha
   37  34:667D  BD D7 7A          lda .pString,x
   38  34:6680  F0 54             beq .return
   39  34:6682  C9 01             cmp #1
   40  34:6684  F0 56             beq .force_linefeed
   41  34:6686  C9 02             cmp #2
   42  34:6688  F0 5A             beq .space_run
   43  34:668A  C4 18             cpy <.cchLine
   44  34:668C  90 07             bcc .decode
   45                                     ;.linefeed
   46  34:668E  48                        pha
   47  34:668F  A5 18                     lda <.cchLine
   48  34:6691  20 C3 96                  jsr .do_feed
   49  34:6694  68                        pla
   50  34:6695            .decode:
   51  34:6695  38                sec
   52  34:6696  E9 29             sbc #$29
   53  34:6698  C9 33             cmp #$5c-$29
   54  34:669A  B0 1D             bcs .put_tile
   55                                     ;original code 29-5f reaches here
   56  34:669C  85 1C                     sta <.char
   57                                     ;tax
   58                                     ;lda .offsetAndFlags,x
   59  34:669E  A2 00                     ldx #0
   60  34:66A0                    .find_char_type:
   61  34:66A0  DD EF 96                          cmp .codeBounds,x
   62  34:66A3  E8                                inx
   63  34:66A4  B0 FA                             bcs .find_char_type
   64                                     ;x = type + 1
   65  34:66A6  BD F9 96                  lda .offsetFlags-1,x
   66  34:66A9  4A                        lsr a
   67  34:66AA  48                        pha
   68  34:66AB  A9 C0                     lda #$c0
   69  34:66AD  69 00                     adc #0  ;take lsb as carry
   70  34:66AF  91 1E                     sta [.pUpperLine],y
   71  34:66B1  68                        pla
   72  34:66B2  F0 24                     beq .put_he
   73  34:66B4  69 60                     adc #$60
   74  34:66B6  65 1C                     adc <.char
   75  34:66B8  38                        sec
   76  34:66B9            .put_tile:
   77  34:66B9  69 28             adc #$28        ;carry
   78  34:66BB            .put_only:      
   79  34:66BB  91 4E             sta [.pTileArray],y
   80  34:66BD  C8                iny
   81  34:66BE            .next:
   82  34:66BE  68                pla
   83  34:66BF  AA                tax
   84  34:66C0            .next_nopop:    
   85  34:66C0  E8                inx
   86  34:66C1  D0 B8             bne .decode_loop
   87  34:66C3            .do_feed:
   88  34:66C3  A0 00             ldy #0
   89  34:66C5  48                pha
   90  34:66C6  20 58 A5          jsr offsetTilePtr
   91  34:66C9  18                clc
   92  34:66CA  68                pla
   93  34:66CB  65 1E             adc <.pUpperLine
   94  34:66CD  85 1E             sta <.pUpperLine
   95  34:66CF  A9 00             lda #0
   96  34:66D1  65 1F             adc <.pUpperLine+1
   97  34:66D3  85 1F             sta <.pUpperLine+1
   98  34:66D5  60                rts
   99  34:66D6            .return:
  100  34:66D6  68                pla     ;dummy
  101  34:66D7  60                rts     
  102  34:66D8            .put_he:
  103  34:66D8  A9 A6             lda #$a6
  104  34:66DA  D0 DF             bne .put_only
  105  34:66DC            .force_linefeed:
  106  34:66DC  A5 18             lda <.cchLine
  107  34:66DE  0A                asl a
  108  34:66DF  20 C3 96          jsr .do_feed    
  109  34:66E2  D0 DA             bne .next       ;always satisfied
  110  34:66E4            .space_run:
  111  34:66E4  68                pla
  112  34:66E5  E8                inx
  113  34:66E6  98                tya
  114  34:66E7  18                clc
  115  34:66E8  7D D7 7A          adc .pString,x
  116  34:66EB  A8                tay
  117  34:66EC  4C C0 96          jmp .next_nopop
  118  34:66EF            .codeBounds:
  119                                                             ;code (after subtracted by #$29 )
  120  34:66EF  0F                .db $0f                 ;00-0e  +66 06 がぎぐげござじずぜぞだぢづでど (29 => 8f)
  121  34:66F0  14                .db $14                 ;0f-13  +6b 0b ばびぶべぼ 12+89 (38 => a3)
  122  34:66F1  19                .db $19                 ;14-18  +66 06 ぱぴぷぺぽ 17+89 (3d => a3)
  123  34:66F2  1A                .db $1a                 ;19-19  +8a 2a ヴ (42 => cc)
  124  34:66F3  29                .db $29                 ;1a-28  +8c 2c ガギグゲゴザジズゼゾダヂヅデト (43 => cf)
  125  34:66F4  2C 2D 2E          .db $2c,$2d,$2e ;29-2d  +91 31 バビブベボ 2c+89 (ヘ: => a6)
  126  34:66F7  31 32 33          .db $31,$32,$33 ;2e-32  +8c 2c パピプペポ 31+89
  127  34:66FA            .offsetFlags:
  128                             ;bit0 indicates 1='Handakuten'
  129                             ;offset 0 is special;means 'he'
  130                             ;higher bits are offset,subtracted by $60
  131  34:66FA  0C                .db $0c
  132  34:66FB  16                .db $16
  133  34:66FC  0D                .db $0d
  134  34:66FD  54                .db $54
  135  34:66FE  58                .db $58
  136  34:66FF  62 00 62          .db $62,$00,$62
  137  34:7702  59 01 59          .db $59,$01,$59
  138                             ;9719
  139                             .endif  ;ENABLE_strToTileArray
  140                     ;9754
  141                     ;======================================================================================================
  142                     ;$96f8:
  143                     ;
  144                     ;$34:9754 initTileArrayStorage
  145                             INIT_PATCH $34,$9754,$9777
                0034              .bank   $34
                7754              .org    $9754
       34:7754                    .ds             (($9777) - ($9754))
                7754              .org    $9754
  146  34:7754            initTileArrayStorage:
  147  34:7754  A2 72             ldx #HIGH(TILE_ARRAY_BASE)      ;#$72
  148  34:7756  8E 4F 00          stx $4f
  149  34:7759  8E C1 7A          stx $7ac1
  150  34:775C  A2 20             ldx #LOW(TILE_ARRAY_BASE)       ;#$20   ;original: 00
  151  34:775E  8E 4E 00          stx $4e
  152  34:7761  8E C0 7A          stx $7ac0
  153  34:7764  A9 FF             lda #$ff
  154  34:7766  A2 00             ldx #0
  155  34:7768            .loop:
  156  34:7768  9D 00 72          sta $7200,x     ;TILE_ARRAY_BASEによらず常に7200-73FFを初期化
  157  34:776B  9D 00 73          sta $7300,x
  158  34:776E  E8                inx
  159  34:776F  D0 F7             bne .loop
  160  34:7771  60                rts
  161                     ;======================================================================================================
  162                             INIT_PATCH $35,$a609,$a66c
                0035              .bank   $35
                6609              .org    $a609
       35:6609                    .ds             (($a66c) - ($a609))
                6609              .org    $a609
  163  35:6609            loadString:
  164                     ;$35:a609 loadString
  165                     ;       [in] u16 $18 : tableBase
  166                     ;       [in] u8 A : index
  167                     ;       [in,out] u8 X : destOffset
  168           0018      .pTableBase = $18
  169           0018      .offset = $18
  170           001A      .index = $1a
  171                     ;----------------------------
  172  35:6609  85 1A             sta <.index
  173  35:660B  8A                txa
  174  35:660C  48                pha
  175  35:660D  20 60 FD          jsr get2byteAtBank18    ;get2byteAtBank18($1a) $fd60
  176  35:6610  68                pla
  177  35:6611  AA                tax
  178  35:6612  A5 19             lda <.offset+1
  179  35:6614  48                pha
  180  35:6615  29 3F             and #$3f
  181  35:6617  09 80             ora #$80
  182  35:6619  85 19             sta <.offset+1
  183  35:661B  68                pla
  184  35:661C  20 43 FD          jsr shiftRight6 ;$fd43
  185  35:661F  18                clc
  186  35:6620  69 0C             adc #$0c
  187  35:6622  4C 4A FD          jmp loadStringWorker    ;$3f:fd4a
  188                     ;$a66c:
  189                     ;======================================================================================================
  190  35:6625            itoa_8:
  191                     ;       [in] u8 a : value
  192                     ;       [out] u8 $1a[3] : tileArray (higher first)
  193           001A      .result = $1a
  194  35:6625  A2 00             ldx #0
  195  35:6627            .digit_loop:    
  196  35:6627  A0 FF                     ldy #$ff
  197  35:6629                    .subtraction_loop:      
  198  35:6629  C8                                iny
  199  35:662A  38                                sec
  200  35:662B  FD 50 A6                          sbc .digits,x
  201  35:662E  B0 F9                             bcs .subtraction_loop
  202  35:6630  7D 50 A6                  adc .digits,x
  203  35:6633  48                        pha
  204  35:6634  98                        tya
  205  35:6635  D0 04                     bne .has_digit
  206  35:6637  A9 FF                             lda #$ff
  207  35:6639  D0 02                             bne .store
  208  35:663B                    .has_digit:
  209  35:663B  09 80                             ora #$80
  210  35:663D                    .store:
  211  35:663D  95 1A                     sta <.result,x
  212  35:663F  68                        pla
  213  35:6640  E8                        inx
  214  35:6641  E0 03                     cpx #3
  215  35:6643  D0 E2             bne .digit_loop
  216  35:6645  A5 1C             lda <.result+2
  217  35:6647  C9 FF             cmp #$ff
  218  35:6649  D0 04             bne .return
  219  35:664B  A9 80             lda #$80
  220  35:664D  85 1C             sta <.result+2
  221  35:664F            .return:        
  222  35:664F  60                rts
  223  35:6650  64 0A 01  .digits .db     100,10,1
  224                     ;======================================================================================================
  225                             RESTORE_PC      ff3_string_begin
                0000              .bank   BANK(ff3_string_begin)
                0000              .org    ff3_string_begin
#[2]   ff3_hack_master.asm
#[3]   ff3_command_string.asm
   29                             .include "ff3_command_string.asm"
    1                     ; ff3_command_string.asm
    2                     ;
    3                     ;description:
    4                     ;       defines extra strings
    5                     ;
    6                     ;version:
    7                     ;       0.05 (2006-11-09)
    8                     ;
    9                     ;======================================================================================================
   10  00:0000            ff3_command_string_begin:
   11                             ;extra strings (reuse free space)
   12                             FILEORG $3cbbd
                001E              .bank   ($3cbbd) >> 13
                BBBD              .org    ($8000 | (($3cbbd) & $7fff))
   13  1E:BBBD                    cmdstr_provoke_fail:
   14  1E:BBBD  8A 8B 9C                  .db     $8a,$8b,$9c,$9f,$94,$b3,$9e,$8f,$7c,$99,$c4,$00
       1E:BBC0  9F 94 B3  
       1E:BBC3  9E 8F 7C  
       1E:BBC6  99 C4 00  
   15                                     
   16                             ;FILEORG        $3de12
   17  1E:BBC9                    cmdstr_provoke_success:
   18  1E:BBC9  9C 90 29                  .db $9c,$90,$29,$8e,$93,$7c,$99,$c4,$00
       1E:BBCC  8E 93 7C  
       1E:BBCF  99 C4 00  
   19                             
   20                             FILEORG $3a4f4
                001D              .bank   ($3a4f4) >> 13
                44F4              .org    ($8000 | (($3a4f4) & $7fff))
   21  1D:44F4                    cmdstr_provoke: ;ちょうはつ
   22  1D:44F4  9A 7F 8C                  .db $9a,$7f,$8c,$a3,$9b,$00     ;
       1D:44F7  A3 9B 00  
   23  1D:44FA                    cmdstr_disordered_shot: ;みだれうち
   24  1D:44FA  A9 33 B3                  .db $a9,$33,$b3,$8c,$9a,$00
       1D:44FD  8C 9A 00  
   25  1D:5500                    cmdstr_abyss:                   ;あんこく
   26  1D:5500  8A B6 93                  .db $8a,$b6,$93,$91,$00
       1D:5503  91 00     
   27  1D:5505                    cmdstr_raid:    ;ふみこむ
   28  1D:5505  A5 A9 93                  .db $a5,$a9,$93,$aa,$00
       1D:5508  AA 00     
   29  1D:550A                    cmdstr_counter_message: ;カウンター!!
   30  1D:550A  CF CC F6                  .db $cf,$cc,$f6,$d9,$c2,$c4,$c4,$00
       1D:550D  D9 C2 C4  
       1D:5510  C4 00     
   31  1D:5512                    cmdstr_abyss_message:   ;やみのちからが からだをむしばむ
   32  1D:5512  AD A9 A2                  .db $ad,$a9,$a2,$9a,$8f,$b0,$29,$ff,$8f,$b0,$33,$7b,$aa,$95,$38,$aa,$00
       1D:5515  9A 8F B0  
       1D:5518  29 FF 8F  
       1D:551B  B0 33 7B  
       1D:551E  AA 95 38  
       1D:5521  AA 00     
   33  1D:5523                    cmdstr_raid_message:    ;てきのはんげきをうけた!
   34  1D:5523  9C 90 A2                  .db $9c,$90,$a2,$a3,$b6,$2c,$90,$7b,$8c,$92,$99,$c4,$00
       1D:5526  A3 B6 2C  
       1D:5529  90 7B 8C  
       1D:552C  92 99 C4  
       1D:552F  00        
   35                             FILEORG $3dabd  ;string for command 0A (original:$3dafd)
                001E              .bank   ($3dabd) >> 13
                AABD              .org    ($8000 | (($3dabd) & $7fff))
   36                     
   37                             ;----------------------------------------------------------------------------------------       
   38           0018              .bank   stringPtrTable >> 13
   39           CC40              .org    $8000 + (stringPtrTable & $7fff) + $0c40; + ($87 * 2)
   40                             
   41  18:CC40                    battleMessageOffsets:
   42           EE21      .nullstr = $de21
   43           0057      EXTRA_BATTLE_MESSAGE_BEGIN = $57        ;87d
   44           CC54              .org    battleMessageOffsets + ($0a * 2)        ;string ptr for command 0A
   45  18:CC54  F4 A4                     .dw (cmdstr_provoke & $ffff)
   46           CCEE              .org    battleMessageOffsets + (EXTRA_BATTLE_MESSAGE_BEGIN * 2) ;message
   47  18:CCEE  C9 CB                     .dw (cmdstr_provoke_success & $ffff)            ;57
   48  18:CCF0  BD CB                     .dw     (cmdstr_provoke_fail & $ffff);58
   49  18:CCF2  0A A5                     .dw (cmdstr_counter_message & $ffff); 59
   50  18:CCF4  FA A4                     .dw (cmdstr_disordered_shot & $ffff); 5a
   51  18:CCF6  00 A5                     .dw     (cmdstr_abyss & $ffff)  ;5b
   52  18:CCF8  05 A5                     .dw (cmdstr_raid & $ffff)       ;5c
   53  18:CCFA  12 A5                     .dw     (cmdstr_abyss_message & $ffff)  ;5d
   54  18:CCFC  23 A5                     .dw (cmdstr_raid_message & $ffff)       ;5e
   55                                     ;5f = "HPかいふく!"
   56                     ;------------------------------------------------------------------------------------------------------
   57           0057              .rsset EXTRA_BATTLE_MESSAGE_BEGIN
   58           0057      EXMSG_PROVOKE_SUCCESS   .rs 1
   59           0058      EXMSG_PROVOKE_FAIL              .rs 1
   60           0059      EXMSG_COUNTER                   .rs 1
   61           005A      EXMSG_DISORDERED_SHOT   .rs 1
   62           005B      EXMSG_ABYSS                             .rs 1
   63           005C      EXMSG_RAID                              .rs 1
   64           005D      EXMSG_ABYSS_MESSAGE             .rs 1
   65           005E      EXMSG_RAID_MESSAGE              .rs 1
   66                     ;======================================================================================================
   67                             RESTORE_PC ff3_command_string_begin
                0000              .bank   BANK(ff3_command_string_begin)
                0000              .org    ff3_command_string_begin
#[2]   ff3_hack_master.asm
#[3]   ff3_rand.asm
   30                             .include "ff3_rand.asm"
    1                     ; ff3_rand.asm
    2                     ;
    3                     ; description:
    4                     ;       small patch for pseudorandom generator for battle
    5                     ;
    6                     ; version:
    7                     ;       0.01 (2006-10-12)
    8                     ;
    9                     ;======================================================================================================
   10  00:0000            ff3_rand_begin:
   11           003F              .bank   $3f
   12           CC27              .org    $fc27
   13  3F:CC27            initBattleRandom:
   14           CC37              .org    $fc37
   15                             
   16  3F:CC37  69 0B             adc #RANDOM_LCG_A       ;original:3
   17                     ;======================================================================================================
   18                             RESTORE_PC ff3_rand_begin
                0000              .bank   BANK(ff3_rand_begin)
                0000              .org    ff3_rand_begin
#[2]   ff3_hack_master.asm
#[3]   ff3_fix.asm
   31                             .include "ff3_fix.asm"
    1                     ; ff3_fix.asm
    2                     ;
    3                     ;description:
    4                     ;       small fixes
    5                     ;
    6                     ;version:
    7                     ;       0.06 (2006-11-07)
    8                     ;
    9                     ;======================================================================================================
   10  00:0000            ff3_fix_begin:
   11                     
   12           0001              .ifdef FIX_ATTR_BOOST
   13           0031                      .bank   $31
   14           BB62                      .org    $ab62
   15  31:BB62                    resetAttributeBoostAndFormation:
   16  31:BB62  29 01                     and #$01        ;original : $f9 (this improperly keeps previous attr-boost value,seems to be bug)
   17           FF18                      .org    $af18
   18  31:FF18                    storeAttributeBoostAndFormation:
   19  31:FF18  29 F9                     and #$f9        ;original: 1 (this masks attr-boost out, seems to be bug)
   20                             .endif  ;FIX_ATTR_BOOST
   21                     ;------------------------------------------------------------------------------------------------------
   22           0001              .ifdef FIX_HP_GROW
   23           0035                      .bank   $35
   24           EEC3                      .org    $bec3
   25  35:EEC3            prize_doLevelUp:
   26           0032      .lvBefore = $32
   27           0024      .hpGrowth = $24
   28           0057      .pBaseParam = $57
   29                             ;a = lvAfter
   30                             ;x = lvAfter
   31                             ;y = offset01 (lv)
   32  35:EEC3  91 57                     sta [.pBaseParam],y
   33  35:EEC5  0A                        asl a
   34  35:EEC6  85 24                     sta <.hpGrowth
   35  35:EEC8  A9 14                     lda #$14
   36  35:EECA  20 88 9B                  jsr setYtoOffsetOf
   37  35:EECD  B1 57                     lda [.pBaseParam],y     ;vit
   38  35:EECF  4A                        lsr a
   39  35:EED0  20 64 A5                  jsr getSys1Random       ;a564 (y is unchanged)
   40  35:EED3  18                        clc
   41  35:EED4  71 57                     adc [.pBaseParam],y
   42                                     ;carry should be cleared (99+48)
   43  35:EED6  18                        clc
   44  35:EED7  65 24                     adc <.hpGrowth
   45  35:EED9  85 24                     sta <.hpGrowth
   46  35:EEDB  A9 00                     lda #0
   47  35:EEDD  69 00                     adc #0
   48  35:EEDF  48                        pha
   49  35:EEE0  A9 0E                     lda #$0e
   50  35:EEE2  20 88 9B                  jsr setYtoOffsetOf      ;9b88
   51  35:EEE5  18                        clc
   52  35:EEE6  B1 57                     lda [.pBaseParam],y     ;maxHp
   53  35:EEE8  65 24                     adc <.hpGrowth
   54  35:EEEA  91 57                     sta [.pBaseParam],y
   55  35:EEEC  C8                        iny
   56  35:EEED  68                        pla
   57  35:EEEE  71 57                     adc [.pBaseParam],y
   58  35:EEF0  91 57                     sta [.pBaseParam],y
   59  35:EEF2  88                        dey     ;set y to maxHp.low
   60  35:EEF3  EA                        nop
   61  35:EEF4  EA                        nop
   62  35:EEF5  EA                        nop
   63                     ;$bef6:         
   64                             .endif  ;FIX_HP_GROW
   65                     ;------------------------------------------------------------------------------------------------------
   66           0001              .ifdef FIX_ITEM99
   67           0035                      .bank   $35
   68           FFC7                      .org    $bfc7
   69  35:FFC7                    branchIfItemOverflow:
   70  35:FFC7  B0 25                     bcs $bfee
   71                             .endif  ;FIX_ITEM99
   72                     ;------------------------------------------------------------------------------------------------------
   73           0000              .ifdef FIX_255X_DAMAGE
   88                             .endif ;FIX_255X_DAMAGE
   89                     ;------------------------------------------------------------------------------------------------------
   90           0001              .ifdef FIX_DUNGEON_FLOOR_SAVE
   91           003F                      .bank   $3f
   92           2299                      .org    $e299
   93  3F:2299                    dungeon_checkStackPointer:
   94  3F:2299  BA                        tsx
   95  3F:229A  E0 4B                     cpx #$4b        ;original:$20
   96                             .endif ;FIX_DUNGEON_FLOOR_SAVE
   97                     ;======================================================================================================
   98                             RESTORE_PC ff3_fix_begin
                0000              .bank   BANK(ff3_fix_begin)
                0000              .org    ff3_fix_begin
#[2]   ff3_hack_master.asm
   32                     
   33           0001              .ifdef BETA
#[3]   ff3_enemy_target.asm
   34                                     .include "ff3_enemy_target.asm" ;save
    1                     ; ff3_enemy_target.asm
    2                     ;
    3                     ;description:
    4                     ;       replaces enemy's action related codes
    5                     ;
    6                     ;version:
    7                     ;       0.04 (2007-08-17)
    8                     ;
    9                     ;======================================================================================================
   10  00:0000            ff3_enemy_target_begin:
   11                             INIT_PATCH $31,$a732,$a8c8
                0031              .bank   $31
                7732              .org    $a732
       31:7732                    .ds             (($a8c8) - ($a732))
                7732              .org    $a732
   12                             
   13  31:7732            battleFunction_02:
   14  31:7732            decideEnemyAction:
   15                     ;[in]
   16           005B      .pPlayer = $5b
   17           BBE2      .barrierChangeFlag = $7be2
   18                     ;groupToIdMap = $7d6b
   19           DDA7      .indexToGroupMap = $7da7
   20           EED8      .battleMode = $7ed8
   21                     ;[in,out]
   22           88B7      .sequence = $78b7
   23                     ;[local]
   24           0053      .confused = $53
   25           0024      .pEnemy = $24
   26           004A      .iEnemy = $4a
   27                     ;-------------------------------------------------
   28  31:7732  A2 00             ldx #0
   29  31:7734  86 69             stx <$69
   30  31:7736            .for_each_enemy:
   31  31:7736  86 4A                     stx <.iEnemy
   32  31:7738  86 18                     stx <$18
   33  31:773A  A9 40                     lda #$40
   34  31:773C  85 1A                     sta <$1a
   35                                     INIT16 <$20,$7675
       31:773E  A9 75             lda #LOW($7675)
       31:7740  85 20             sta <$20
       31:7742  A9 76             lda #HIGH($7675)
       31:7744  85 21             sta <$20+1
   36  31:7746  20 9D BE                  jsr calcDataAddress
   37  31:7749  A5 1C                     lda <$1c
   38  31:774B  85 24                     sta <.pEnemy
   39  31:774D  A5 1D                     lda <$1d
   40  31:774F  85 25                     sta <.pEnemy+1
   41  31:7751  20 C8 A8                  jsr getActionMode       ;$a8c8  ;get2c
   42  31:7754  29 EF                     and #$ef        ;clear action mode
   43  31:7756  91 24                     sta [.pEnemy],y
   44  31:7758  A9 00                     lda #0
   45  31:775A  A0 2F                     ldy #$2f        ;target
   46  31:775C  91 24                     sta [.pEnemy],y
   47  31:775E  C8                        iny                     ;target mode
   48  31:775F  91 24                     sta [.pEnemy],y
   49  31:7761  85 53                     sta <.confused
   50  31:7763  AA                        tax
   51  31:7764  A0 01                     ldy #1
   52  31:7766  B1 24                     lda [.pEnemy],y
   53  31:7768  29 E8                     and #$e8        ;dead|stone|toad|minimum
   54  31:776A  F0 05                     beq .check_status_2nd
   55                                             ;can't move
   56  31:776C  A9 00                             lda #0
   57  31:776E  4C 22 A8                          jmp .next               ;a8b9
   58  31:7771                    .check_status_2nd:
   59  31:7771  C8                        iny
   60  31:7772  B1 24                     lda [.pEnemy],y
   61  31:7774  29 20                     and #STATUS_CONFUSED    ;$20
   62  31:7776  D0 09                     bne .status_confused
   63  31:7778  29 C0                     and #STATUS_SLEEPING | STATUS_PARALYZED ;$c0
   64  31:777A  F0 0B                     beq .status_good
   65                             ;paralyzed|sleeping
   66  31:777C  A9 01                             lda #1
   67  31:777E  4C 22 A8                          jmp .next               ;a8b9
   68  31:7781                    .status_confused:
   69  31:7781  A9 80                     lda #$80
   70  31:7783  85 53                     sta <.confused
   71  31:7785  D0 34                     bne .select_action      ;always satisfied
   72  31:7787                    .status_good:
   73  31:7787  AD D8 7E                  lda .battleMode
   74  31:778A  30 2F                     bmi .select_action      ;a7c5
   75  31:778C  4A                        lsr a
   76  31:778D  B0 2C                     bcs .select_action      ;a7c5   if (($7ed8 & 1) != 0) $a7c5; //bne
   77                                             ;
   78  31:778F  A0 00                             ldy #0
   79           0028      .lv = $28
   80  31:7791                            .cache_lv:
   81  31:7791  B1 5B                                     lda [.pPlayer],y        ;lv
   82  31:7793  95 28                                     sta <.lv,x
   83  31:7795  E8                                        inx
   84  31:7796  98                                        tya
   85  31:7797  18                                        clc
   86  31:7798  69 40                                     adc #$40
   87  31:779A  A8                                        tay
   88  31:779B  D0 F4                                     bne .cache_lv
   89  31:779D  B1 24                     lda [.pEnemy],y ;y=0
   90  31:779F  18                        clc
   91  31:77A0  69 0F                     adc #15
   92  31:77A2  48                        pha
   93  31:77A3  20 EC A8                  jsr $a8ec       ;getLeastLvInPlayerParty
   94  31:77A6  68                        pla
   95  31:77A7  C5 28                     cmp <.lv
   96  31:77A9  B0 10                     bcs .select_action
   97                                             ;try to escape
   98  31:77AB  A9 64                             lda #100
   99  31:77AD  20 B4 BE                          jsr b31_getBattleRandom ;beb4
  100  31:77B0  A0 22                             ldy #$22
  101  31:77B2  D1 24                             cmp [.pEnemy],y ;evade
  102  31:77B4  90 05                             bcc .select_action
  103  31:77B6  A9 06                                     lda #ACTION_ESCAPE
  104  31:77B8  4C 22 A8                                  jmp .next
  105  31:77BB                    .select_action: ;$a7c5
  106  31:77BB  A6 4A                     ldx <.iEnemy
  107  31:77BD  BD A7 7D                  lda .indexToGroupMap,x  ;2007-08-21
  108  31:77C0  AA                        tax
  109  31:77C1  BD 6B 7D                  lda groupToEnemyIdMap,x
  110  31:77C4  C9 D2                     cmp #$d2        ;d2:まどうしハイン
  111  31:77C6  F0 04                     beq .check_barrier_change
  112  31:77C8  C9 B4                     cmp #$b4        ;b4:アモン
  113  31:77CA  D0 13                     bne .check_special
  114  31:77CC                    .check_barrier_change:
  115  31:77CC  AD E2 7B                          lda .barrierChangeFlag
  116  31:77CF  C9 02                             cmp #2
  117  31:77D1  D0 0C                             bne .check_special
  118  31:77D3  20 C8 A8                                  jsr getActionMode       ;$a8c8
  119  31:77D6  09 10                                     ora #$10
  120  31:77D8  91 24                                     sta [.pEnemy],y
  121  31:77DA  A9 4D                                     lda #$4d        ;4d:barrier-change
  122  31:77DC  4C 22 A8                                  jmp .next
  123  31:77DF                    .check_special: ;a7e9
  124  31:77DF  A0 37                     ldy #BP_OFFSET_SPECIAL_RATE     ;$37
  125  31:77E1  B1 24                     lda [.pEnemy],y
  126  31:77E3  F0 09                     beq .decide_to_fight
  127  31:77E5  A9 64                             lda #100
  128  31:77E7  20 B4 BE                          jsr b31_getBattleRandom
  129  31:77EA  D1 24                             cmp [.pEnemy],y
  130  31:77EC  90 0F                             bcc .select_special
  131  31:77EE                    .decide_to_fight:       ;a7fd
  132                                     ;new decideEnemyTarget implementation has proper handling for confused enemy
  133  31:77EE                    .select_fight_target:
  134                                     ;select valid target (must not be dead/stone/jumping)
  135                                     ;if there is no valid target,then decide to action0 (that do nothing)
  136  31:77EE  A9 04                     lda #ACTION_FIGHT       ;4
  137                                     ;pha
  138  31:77F0  85 46                     sta <$46
  139  31:77F2  A9 00                     lda #0
  140  31:77F4  20 38 A9                  jsr decideEnemyTarget   ;[out] a = target bit
  141  31:77F7  F0 44                     beq .fail_to_target
  142                                     ;pla
  143  31:77F9  A9 04                     lda #ACTION_FIGHT
  144  31:77FB  D0 25                     bne .next
  145  31:77FD                    .select_special:        ;$a85f
  146  31:77FD  20 C8 A8                  jsr getActionMode       ;$a8c8  ;get24_2c
  147  31:8800  09 10                     ora #$10
  148  31:8802  91 24                     sta [.pEnemy],y
  149  31:8804  AD D8 7E                  lda .battleMode
  150  31:8807  10 27                     bpl .select_randomly
  151                             ;sequencial     
  152                             ;assert( 1 <= .sequence <= 8 )
  153  31:8809  AD B7 78                          lda .sequence
  154  31:880C  18                                clc
  155  31:880D  69 37                             adc #$37
  156  31:880F  20 48 A8                          jsr .setTarget
  157  31:8812  D0 29                             bne .fail_to_target     ;$a8ad
  158  31:8814  AC B7 78                          ldy .sequence
  159  31:8817  C8                                iny
  160  31:8818  C0 09                             cpy #9
  161  31:881A  D0 02                             bne .update_sequence
  162  31:881C  A0 01                                     ldy #1
  163  31:881E                            .update_sequence:
  164  31:881E  8C B7 78                          sty .sequence
  165  31:8821                    .id_and_next:
  166  31:8821  8A                        txa
  167  31:8822                    .next:  ;$a8b9
  168  31:8822  A0 2E                     ldy #$2e
  169  31:8824  91 24                     sta [.pEnemy],y
  170  31:8826  A6 4A                     ldx <.iEnemy
  171  31:8828  E8                        inx
  172  31:8829  E0 08                     cpx #8
  173  31:882B  F0 2B                     beq .finish     ;$a8c8  ;get24_2c
  174  31:882D  4C 36 A7                  jmp .for_each_enemy
  175                                     ;bne .for_each_enemy    ;$a8c8;.finish
  176                                     ;       jmp $a8c8       ;finish
  177  31:8830                    .select_randomly:       ;$a896
  178  31:8830  A9 07                             lda #7
  179  31:8832  20 B4 BE                          jsr b31_getBattleRandom
  180  31:8835  18                                clc
  181  31:8836  69 38                             adc #$38
  182  31:8838  20 48 A8                          jsr .setTarget  ;if failed, ZF = 0
  183  31:883B  F0 E4                             beq .id_and_next
  184  31:883D                    .fail_to_target:
  185  31:883D  20 C8 A8                          jsr getActionMode       ;$a8c8  ;get24_2c
  186  31:8840  29 EF                             and #$ef
  187  31:8842  91 24                             sta [.pEnemy],y
  188  31:8844  A9 00                             lda #0
  189  31:8846  F0 DA                             beq .next
  190  31:8848                    .setTarget:
  191                             ;a = offset to selected command (in list)
  192                             ;[out] a : = $69, x : decided command
  193  31:8848  A8                                tay
  194  31:8849  B1 24                             lda [.pEnemy],y
  195                                             ;and #$7f
  196                                             ;pha
  197  31:884B  B1 24                             lda [.pEnemy],y
  198  31:884D  48                                pha
  199  31:884E  20 1B A9                          jsr decideEnemyActionTarget     ;a91b [out] $69 : failed
  200  31:8851  68                                pla
  201  31:8852  29 7F                             and #$7f
  202  31:8854  AA                                tax
  203  31:8855  A5 69                             lda <$69        ;failed flag
  204  31:8857  60                                rts
  205  31:8858            .finish:
  206  31:8858  4C C8 A8          jmp getActionMode       ;$a8c8
  207                     ;======================================================================================================
  208                     ;ex battle function
  209  31:885B            pickRandomTargetFromEnemyParty:
  210                     ;[in]
  211                     ;[out] u8 $62 : targetbit; x = index
  212           0062      .targetBit = $62
  213           0064      .candidateCount = $64
  214           0070      .pTarget = $70
  215  31:885B  A9 08             lda #8
  216  31:885D  A2 04             ldx #4
  217  31:885F  20 AE A9          jsr buildTargetCandidateList
  218                     ;       jsr verifyCandidatesByStatusCache
  219                     ;verifyCandidatesByStatusCache:
  220           00E0      .targetStatusCache = $e0
  221           0062      .candidateBits = $62
  222  31:8862  A2 07             ldx #7
  223  31:8864  A5 62             lda <.candidateBits
  224  31:8866  48                pha
  225  31:8867            .verify:
  226  31:8867  68                        pla
  227  31:8868  0A                        asl a
  228  31:8869  48                        pha
  229  31:886A  90 13                     bcc .verify_next
  230                     ;marked as candidate. verify status cache
  231  31:886C  8A                        txa
  232  31:886D  0A                        asl a
  233  31:886E  A8                        tay
  234  31:886F  B9 E0 00                  lda .targetStatusCache,y
  235  31:8872  29 E8                     and #$e8        ;dead|stone|toad|minimum
  236  31:8874  F0 09                     beq .verify_next
  237                     
  238  31:8876  C6 64                             dec <.candidateCount
  239  31:8878  A5 62                             lda <.candidateBits
  240  31:887A  20 2C FD                          jsr clearTargetBit
  241  31:887D  85 62                             sta <.candidateBits
  242  31:887F                    .verify_next:
  243  31:887F  CA                        dex
  244  31:8880  10 E5                     bpl .verify
  245  31:8882  68                        pla     ;dispose
  246                     
  247  31:8883  A5 64             lda <.candidateCount
  248  31:8885  F0 25             beq .no_valid_target_there
  249  31:8887  20 D6 A9                  jsr pickOneOfCandidate
  250                                     ;convert target bit to index
  251  31:888A  A5 62                     lda <.targetBit
  252  31:888C  A2 07                     ldx #7
  253  31:888E                    .to_index:
  254  31:888E  4A                                lsr a
  255  31:888F  B0 03                             bcs .calc_addr
  256  31:8891  CA                                dex
  257  31:8892  10 FA                             bpl .to_index
  258  31:8894                    .calc_addr:
  259  31:8894  8A                        txa
  260  31:8895  48                        pha
  261                                     
  262  31:8896  86 1A                     stx <$1a        ;index
  263  31:8898  A9 40                     lda #$40
  264  31:889A  20 D6 FC                  jsr mul_8x8
  265                                     ;$1a,1b = offset to enemy
  266  31:889D  18                        clc
  267  31:889E  A5 1A                     lda <$1a
  268  31:88A0  69 75                     adc #$75
  269  31:88A2  85 70                     sta <.pTarget
  270  31:88A4  A5 1B                     lda <$1b
  271  31:88A6  69 76                     adc #$76
  272  31:88A8  85 71                     sta <.pTarget+1
  273                                     
  274  31:88AA  68                        pla
  275  31:88AB  AA                        tax
  276  31:88AC            .no_valid_target_there:
  277  31:88AC  60                rts
  278                     ;------------------------------------------------------------------------------------------------------
  279                             VERIFY_PC $a8c8
       31:88AD                    .verify_pc_00013:
                0000              .if (.verify_pc_00013 > $a8c8)
                                  .endif
  280                     ;$a8c8
  281                     ;======================================================================================================
  282                             ;.org   $a91b
  283                             INIT_PATCH $31,$a91b,$a9f7
                0031              .bank   $31
                991B              .org    $a91b
       31:991B                    .ds             (($a9f7) - ($a91b))
                991B              .org    $a91b
  284  31:991B            decideEnemyActionTarget:
  285           0046      .actionId = $46
  286           4400      .actionParams = $7400
  287  31:991B  85 46             sta <.actionId
  288  31:991D  29 7F             and #$7f
  289  31:991F  85 18             sta <$18
  290  31:9921  A9 08             lda #8
  291  31:9923  85 1A             sta <$1a
  292                             INIT16 <$20,$98c0
       31:9925  A9 C0             lda #LOW($98c0)
       31:9927  85 20             sta <$20
       31:9929  A9 98             lda #HIGH($98c0)
       31:992B  85 21             sta <$20+1
  293  31:992D  A9 18             lda #$18
  294  31:992F  A8                tay
  295  31:9930  A2 00             ldx #0
  296  31:9932  20 A6 FD          jsr loadTo7400Ex        ;fda6
  297  31:9935  AD 05 74          lda .actionParams+5
  298                             ;fall through
  299  31:9938            decideEnemyTarget:
  300           0024      .pEnemy = $24
  301           0053      .confused = $53 ;$80:confused
  302                     ;[out]
  303           0069      .failed = $69
  304                     ;local
  305           0046      .actionId = $46
  306           0062      .targetBits = $62
  307           0063      .targetFlags = $63
  308           0064      .candidateCount = $64
  309  31:9938  48                pha
  310  31:9939  05 53             ora <.confused  ;eor is ideal, but some enemy specials are intended to target enemy party even when confused
  311  31:993B  10 14             bpl .select_from_player_party
  312  31:993D            .select_from_enemy_party:
  313  31:993D  A9 08                     lda #8
  314  31:993F  A2 04                     ldx #4
  315  31:9941  20 AE A9                  jsr buildTargetCandidateList
  316  31:9944  A5 64                     lda <.candidateCount
  317  31:9946  F0 5A                     beq .no_valid_target_there
  318  31:9948  A2 FF                     ldx #$ff
  319  31:994A  68                        pla
  320  31:994B  29 40                     and #TARGET_MULTIPLE    ;$40
  321  31:994D  09 80                     ora #TARGET_ENEMY_PARTY ;$80
  322  31:994F  30 10                     bmi .set_target
  323  31:9951            .select_from_player_party:
  324                                     ;build candidate list
  325  31:9951  A9 04                     lda #4
  326  31:9953  A2 00                     ldx #0
  327  31:9955  20 AE A9                  jsr buildTargetCandidateList
  328  31:9958  A5 64                     lda <.candidateCount
  329  31:995A  F0 46                     beq .no_valid_target_there
  330  31:995C  A2 F0                     ldx #$f0
  331  31:995E  68                        pla
  332  31:995F  29 40                     and #TARGET_MULTIPLE    ;$40
  333  31:9961            .set_target:
  334  31:9961  85 63             sta <.targetFlags
  335  31:9963  24 63             bit <.targetFlags
  336  31:9965  70 2D             bvs .target_multiple
  337  31:9967  A5 46             lda <.actionId
  338  31:9969  30 29             bmi .target_multiple
  339  31:996B            .target_single:
  340           0001              .ifdef TAG_PROVOKE_EFFECT
  341  31:996B  A0 1F                     ldy #X_BP_OFFSET_TYPE   ;$1f    ;enchanted status(lefthand)
  342  31:996D  B1 24                     lda [.pEnemy],y
  343  31:996F  29 1F                     and #$1f
  344  31:9971  F0 1C                     beq .do_usual
  345  31:9973  38                                sec
  346  31:9974  E9 01                             sbc #1
  347  31:9976  91 24                             sta [.pEnemy],y
  348  31:9978  29 0F                             and #$0f
  349  31:997A  D0 0A                             bne .change_target
  350                                                     ;clear effects
  351  31:997C  91 24                                     sta [.pEnemy],y
  352  31:997E  A0 28                                     ldy #$28
  353  31:9980  A9 05                                     lda #5
  354  31:9982  91 24                                     sta [.pEnemy],y ;critical rate
  355  31:9984  D0 09                                     bne .do_usual
  356  31:9986                            .change_target:
  357  31:9986  88                                dey
  358  31:9987  B1 24                             lda [.pEnemy],y
  359  31:9989  F0 04                             beq .do_usual
  360  31:998B  85 62                             sta <.targetBits
  361  31:998D  D0 07                             bne .store_result
  362  31:998F                    .do_usual:
  363                             .endif  ;TAG_PROVOKE_EFFECT
  364  31:998F  20 D6 A9                  jsr pickOneOfCandidate
  365  31:9992  D0 02                     bne .store_result       ;always (a = targetbit
  366  31:9994            .target_multiple:
  367  31:9994  86 62                     stx <.targetBits
  368  31:9996            .store_result:
  369  31:9996  A0 30             ldy #BP_OFFSET_TARGET_FLAG      ;$30
  370  31:9998  A5 63             lda <.targetFlags
  371  31:999A  91 24             sta [.pEnemy],y
  372  31:999C  88                dey
  373  31:999D  A5 62             lda <.targetBits
  374  31:999F  91 24             sta [.pEnemy],y
  375  31:99A1  60                rts
  376  31:99A2            .no_valid_target_there:
  377  31:99A2  68                pla     ;dispose (actionParam[5] )
  378  31:99A3  A2 00             ldx #0
  379  31:99A5  86 62             stx <.targetBits
  380  31:99A7  86 63             stx <.targetFlags
  381  31:99A9  E8                inx
  382  31:99AA  86 69             stx <.failed
  383  31:99AC  D0 E8             bne .store_result
  384                     ;------------------------------------------------------------------------------------------------------
  385  31:99AE            buildTargetCandidateList:
  386                     ;[in]
  387                     ;a = count
  388                     ;x = indexOffset
  389           0065      .indexOffset = $65      ;enemy = 4
  390                     ;[out]
  391           0064      .candidateCount = $64
  392           0062      .candidateBits = $62
  393                     ;
  394           0063      .candidateLast = $63
  395  31:99AE  85 63             sta <.candidateLast
  396  31:99B0  86 65             stx <.indexOffset
  397  31:99B2  A2 00             ldx #0
  398  31:99B4  86 62             stx <.candidateBits
  399  31:99B6  86 64             stx <.candidateCount
  400  31:99B8            .build_candidates:
  401  31:99B8  8A                        txa
  402  31:99B9  48                        pha
  403  31:99BA  18                        clc
  404  31:99BB  65 65                     adc <.indexOffset
  405  31:99BD  20 F7 A9                  jsr isValidTarget       ;a9f7
  406  31:99C0  D0 0C                     bne .build_next
  407  31:99C2  E6 64                             inc <.candidateCount
  408  31:99C4  68                                pla
  409  31:99C5  48                                pha
  410  31:99C6  AA                                tax
  411  31:99C7  A5 62                             lda <.candidateBits
  412  31:99C9  20 20 FD                          jsr flagTargetBit
  413  31:99CC  85 62                             sta <.candidateBits
  414  31:99CE                    .build_next:
  415  31:99CE  68                        pla
  416  31:99CF  AA                        tax
  417  31:99D0  E8                        inx
  418  31:99D1  E4 63                     cpx <.candidateLast
  419  31:99D3  D0 E3                     bne .build_candidates
  420  31:99D5  60                rts     
  421                     ;------------------------------------------------------------------------------------------------------
  422  31:99D6            pickOneOfCandidate:
  423           0062      .candidateBits = $62
  424           0064      .candidateCount = $64
  425  31:99D6  A5 64             lda <.candidateCount
  426  31:99D8  38                sec 
  427  31:99D9  E9 01             sbc #1
  428  31:99DB  20 B4 BE          jsr b31_getBattleRandom ;beb4
  429  31:99DE  A8                tay
  430  31:99DF  C8                iny
  431                             ;y = (0-count]
  432                             ;lda <.candidateBits
  433  31:99E0  A2 00             ldx #0
  434  31:99E2            .find_nth_set:
  435  31:99E2  06 62                     asl <.candidateBits
  436  31:99E4  E8                        inx
  437  31:99E5  90 FB                     bcc .find_nth_set
  438  31:99E7  88                        dey
  439  31:99E8  D0 F8                     bne .find_nth_set
  440                             ;x = bit index(reversed) of Nth set
  441  31:99EA  CA                dex
  442  31:99EB  A9 00             lda #0
  443  31:99ED  20 20 FD          jsr flagTargetBit
  444  31:99F0  85 62             sta <.candidateBits
  445  31:99F2  60                rts
  446                     ;$a9f7  
  447                     ;======================================================================================================
  448                             RESTORE_PC      ff3_enemy_target_begin
                0000              .bank   BANK(ff3_enemy_target_begin)
                0000              .org    ff3_enemy_target_begin
#[2]   ff3_hack_master.asm
#[3]   ff3_calc_player_param.asm
   35                                     .include "ff3_calc_player_param.asm"    ;save
    1                     ; ff3_calc_player_param.asm
    2                     ;
    3                     ;description:
    4                     ;       replaces code for player parameter calculation
    5                     ;       adds 'extra job ability' feature
    6                     ;
    7                     ;version:
    8                     ;       0.05 (2006-11-10)
    9                     ;
   10                     ;======================================================================================================
   11  00:0000            ff3_calc_player_param_begin:
   12                             INIT_PATCH $31,$aa16,$ab0a
                0031              .bank   $31
                AA16              .org    $aa16
       31:AA16                    .ds             (($ab0a) - ($aa16))
                AA16              .org    $aa16
   13  31:AA16            battleFunction05:
   14  31:AA16            calcPlayerParam:
   15                     ;[in]
   16           0052      .iPlayer = $52
   17           0057      .pBaseParam = $57
   18           0059      .pEquips = $59
   19           005B      .pBattleParam = $5b
   20                     ;locals
   21           0027      .equipId_right = $27
   22           0028      .equipId_left = $28
   23           002C      .baseParams = $2c               ;str,agi,vit,int,men
   24           4400      .equipParams = $7400    ;[8][5]
   25           442F      .equipIds = $742f       ;{head,body,wrest,righthand,count,lefthand}
   26           0032      .equipTraitFlag = $32
   27           0048      .equipFlag_right = $48  ;=> pBattleParam[31]
   28           0049      .equipFlag_left = $49   ;=> +32
   29                     ;------------------------------------------------------------------------
   30  31:AA16  20 90 BE          jsr b31_updatePlayerOffset      ;be90
   31  31:AA19  A8                tay
   32  31:AA1A  A2 00             ldx #0
   33  31:AA1C            .load_equips:
   34  31:AA1C  B1 59                     lda [.pEquips],y
   35  31:AA1E  9D 2F 74                  sta .equipIds,x
   36  31:AA21  95 24                     sta <$24,x
   37  31:AA23  C8                        iny
   38  31:AA24  E8                        inx
   39  31:AA25  E0 06                     cpx #6
   40  31:AA27  D0 F3                     bne .load_equips
   41  31:AA29  A2 02             ldx #2
   42  31:AA2B            .replace_empty_armor:
   43  31:AA2B  B5 24                     lda <$24,x
   44  31:AA2D  D0 04                     bne .replace_next
   45  31:AA2F  A9 57                             lda #$57
   46  31:AA31  95 24                             sta <$24,x
   47  31:AA33                    .replace_next:
   48  31:AA33  CA                        dex
   49  31:AA34  10 F5                     bpl .replace_empty_armor
   50  31:AA36  A5 29             lda <$24+5
   51  31:AA38  85 28             sta <$24+4
   52  31:AA3A  8D 33 74          sta .equipIds+4
   53                             
   54  31:AA3D  A5 27             lda <.equipId_right
   55  31:AA3F  20 94 AA          jsr idToKindFlag        ;extra
   56  31:AA42  85 48             sta <.equipFlag_right
   57                             
   58  31:AA44  A5 28             lda <.equipId_left
   59  31:AA46  20 94 AA          jsr idToKindFlag        ;extra
   60  31:AA49  85 49             sta <.equipFlag_left
   61  31:AA4B  F0 04             beq .empty_either
   62  31:AA4D  A5 48                     lda <.equipFlag_right
   63  31:AA4F  D0 1A                     bne .set_traits
   64  31:AA51            .empty_either:
   65                                     ;at least lefthand or righthand is empty (or invalid item)
   66  31:AA51  A5 48                     lda <.equipFlag_right
   67  31:AA53  29 06                     and #6
   68  31:AA55  F0 06                     beq .check_left
   69                                             ;bow or arrow
   70  31:AA57  A9 00                             lda #0
   71  31:AA59  85 27                             sta <$24+3
   72  31:AA5B  F0 0A                             beq .clear_flags
   73  31:AA5D                    .check_left:
   74  31:AA5D  A5 49                     lda <.equipFlag_left
   75  31:AA5F  29 06                     and #6
   76  31:AA61  F0 08                     beq .set_traits
   77                                             ;bow or arrow
   78  31:AA63  A9 00                             lda #0
   79  31:AA65  85 28                             sta <$24+4
   80  31:AA67                            .clear_flags:
   81  31:AA67  85 48                             sta <.equipFlag_right
   82  31:AA69  85 49                             sta <.equipFlag_left
   83  31:AA6B            .set_traits:
   84  31:AA6B  A5 48             lda <.equipFlag_right
   85  31:AA6D  05 49             ora <.equipFlag_left
   86                             ;00:both bare fist or bow/arrow with other empty
   87                             ;01:onehanded weapon
   88                             ;06:bow(2) & arrow(4) set
   89                             ;08:harp
   90                             ;80:shield
   91  31:AA6F  F0 0D             beq .finish     ;$ab0a  ;both barefist
   92  31:AA71  C9 06             cmp #6
   93  31:AA73  F0 09             beq .finish     ;$ab0a  ;bow_arrow_set
   94  31:AA75  C9 08             cmp #8
   95  31:AA77  D0 03             bne .others
   96                     ;harp   
   97  31:AA79  4A                lsr a
   98  31:AA7A  D0 02             bne .finish
   99  31:AA7C            .others:
  100  31:AA7C  A9 02             lda #2
  101  31:AA7E            .finish:
  102           0001              .ifdef ENABLE_EXTRA_ABILITY_TAG
  103  31:AA7E  48                        pha
  104                                     
  105  31:AA7F  20 90 BE                  jsr b31_updatePlayerOffset
  106  31:AA82  A8                        tay
  107  31:AA83  B1 57                     lda [.pBaseParam],y
  108  31:AA85  AA                        tax     ;job
  109  31:AA86  A9 3C                     lda #EXTRA_ABILITY_OFFSET
  110  31:AA88  20 98 BE                  jsr b31_setYtoOffsetOf
  111  31:AA8B  BD B0 AA                  lda extraAbilityFlags,x
  112  31:AA8E  91 5B                     sta [.pBattleParam],y
  113                                     
  114  31:AA90  68                        pla
  115  31:AA91  4C 0A AB                  jmp $ab0a
  116                             .else
  118                             .endif  ;ENABLE_EXTRA_ABILITY_TAG
  119                     ;-------------------------------------------------------------------------------------------------------
  120  31:AA94            idToKindFlag:   ;[in] a = id [out] x = resultKind,a = flagValue
  121  31:AA94  A2 05             ldx #5
  122  31:AA96            .loop:
  123  31:AA96  DD A3 AA                  cmp .bounds,x
  124  31:AA99  B0 03                     bcs .return
  125  31:AA9B  CA                        dex
  126  31:AA9C  10 F8             bpl .loop
  127  31:AA9E            .return:
  128  31:AA9E  E8                inx
  129  31:AA9F  BD A9 AA          lda .kindToFlag,x
  130  31:AAA2  60                rts
  131  31:AAA3            .bounds:
  132  31:AAA3  01 46 4A          .db     $01,$46,$4a,$4f,$58,$65
       31:AAA6  4F 58 65  
  133  31:AAA9            .kindToFlag
  134  31:AAA9  00 01 08          .db     $00,$01,$08,$02,$04,$80,$00
       31:AAAC  02 04 80  
       31:AAAF  00        
  135                     ;-------------------------------------------------------------------------------------------------------
  136  31:AAB0            calc_player_param_free_begin:
  137           BB0A      calc_player_param_free_end = $ab0a
  138                     ;-------------------------------------------------------------------------------------------------------
  139                             INIT_PATCH $31,$ac69,$aca2
                0031              .bank   $31
                CC69              .org    $ac69
       31:CC69                    .ds             (($aca2) - ($ac69))
                CC69              .org    $ac69
  140  31:CC69            calcPlayerParam_testWrestlingAbility:
  141           005B      .pBattleParam = $5b
  142           0032      .equipTraitFlag = $32
  143                     
  144  31:CC69  A9 3C             lda #EXTRA_ABILITY_OFFSET
  145  31:CC6B  20 98 BE          jsr b31_setYtoOffsetOf
  146  31:CC6E  B1 5B             lda [.pBattleParam],y
  147  31:CC70  29 08             and #PASSIVE_WRESTLING
  148  31:CC72  F0 2E             beq $aca2
  149                             
  150  31:CC74  A5 32             lda <.equipTraitFlag
  151  31:CC76  29 06             and #$06
  152  31:CC78  D0 28             bne $aca2
  153  31:CC7A  AD 28 74                  lda $7428
  154  31:CC7D  4A                        lsr a
  155  31:CC7E  4A                        lsr a
  156  31:CC7F  85 24                     sta <$24
  157                     
  158  31:CC81  AD 2E 74                  lda $742e
  159  31:CC84  4A                        lsr a
  160  31:CC85  18                        clc
  161  31:CC86  6D 2E 74                  adc $742e
  162  31:CC89  85 25                     sta <$25
  163                     
  164  31:CC8B  AD 2D 74                  lda $742d
  165  31:CC8E  4A                        lsr a
  166  31:CC8F  4A                        lsr a
  167  31:CC90  18                        clc
  168  31:CC91  65 24                     adc <$24
  169  31:CC93  65 25                     adc <$25
  170  31:CC95  69 02                     adc #$02
  171  31:CC97  85 3B                     sta <$3b
  172  31:CC99  85 40                     sta <$40
  173  31:CC9B  4C 3D AD                  jmp $ad3d
  174                     ;$ac69:
  175                     ;       if ( ($57[y = $5f] == #02 //beq ac76
  176                     ;               || $57[y] == #0d ) //bne aca2
  177                     ;$ac76:         &&  (($32 & #06) == 0) ) //bne aca2
  178                     ;       {       //モンクor空手家 and 素手
  179                     ;$ac7c:
  180                     ;               $24 = $7428 >> 2;       //fd47
  181                     ;               $25 = $742e >> 1 + $742e;
  182                     ;               $40 = $3b = $24 + $25 + $742d >> 2;     //fd47
  183                     ;               //jmp $ad3d
  184                     ;       } else {
  185                     ;$aca2:
  186                     ;=======================================================================================================
  187  31:CC9E            ff3_calc_player_param_end:      
  188                             RESTORE_PC ff3_calc_player_param_begin
                0000              .bank   BANK(ff3_calc_player_param_begin)
                0000              .org    ff3_calc_player_param_begin
#[2]   ff3_hack_master.asm
#[3]   ff3_blow_effect.asm
   36                                     .include "ff3_blow_effect.asm"  ;save
    1                     ; ff3_blow_effect.asm
    2                     ;
    3                     ; description:
    4                     ;       replaces blow-effect playing code
    5                     ;       
    6                     ; version:
    7                     ;       0.03 (2006-10-23)
    8                     ;======================================================================================================
    9  00:0000            ff3_blow_effect_begin:
   10                     ;======================================================================================================
   11                             INIT_PATCH      $32,$98d1,$991f
                0032              .bank   $32
                88D1              .org    $98d1
       32:88D1                    .ds             (($991f) - ($98d1))
                88D1              .org    $98d1
   12  32:88D1            showBlowSprite_02:      ;
   13  32:88D1  A9 12             lda #$12
   14  32:88D3  D0 02             bne randomizePosAndShow
   15                             
   16  32:88D5            showBlowSprite_01:      ;type 0(fist) ,2(bell,book,rod,cane) ,4(harp),9(claw)
   17  32:88D5  A9 10             lda #$10
   18                             ;fall through
   19  32:88D7            randomizePosAndShow:
   20           00B6      .frameCount = $b6
   21           008C      .spriteX = $8c
   22           008D      .spriteY = $8d
   23           00BE      .randX = $be
   24           00BF      .randY = $bf
   25           00B8      .target = $b8
   26           00CD      .hand = $cd
   27  32:88D7  48                pha
   28                     ;$98e8:
   29  32:88D8  A6 BF             ldx <.randY
   30  32:88DA  A5 B6             lda <.frameCount
   31           0001              .ifdef VARIABLE_SWING_FRAMES
   32  32:88DC  20 C1 A3                  jsr blowEffect_isFrameCountSatisfied    ;a unchanged
   33                                     ;x = range index
   34                                     ;a = frame count
   35  32:88DF  0A                        asl a
   36  32:88E0  38                        sec
   37  32:88E1  FD D9 A3                  sbc blowEffect_frameBounds,x
   38  32:88E4  4A                        lsr a
   39  32:88E5  4A                        lsr a
   40  32:88E6  B0 21                     bcs .no_update
   41                             .else
   44                             .endif  ;VARIABLE_SWING_FRAMES
   45                     
   46  32:88E8  A5 B8                     lda <.target
   47  32:88EA  0A                        asl a
   48  32:88EB  A8                        tay
   49  32:88EC  B9 D7 7D                  lda enemyPos,y
   50  32:88EF  85 BE                     sta <.randX
   51  32:88F1  B9 D8 7D                  lda enemyPos+1,y
   52  32:88F4  85 BF                     sta <.randY
   53                     
   54  32:88F6  20 4F A4                  jsr getSys0Random_00_ff
   55  32:88F9  29 1F                     and #$1f
   56  32:88FB  18                        clc
   57  32:88FC  65 BE                     adc <.randX
   58  32:88FE  85 BE                     sta <.randX
   59                                     
   60  32:9900  20 4F A4                  jsr getSys0Random_00_ff
   61  32:9903  29 1F                     and #$1f
   62  32:9905  18                        clc
   63  32:9906  65 BF                     adc <.randY
   64  32:9908  AA                        tax
   65  32:9909            .no_update:
   66                     ;$9912:
   67                             ;lda <.randY
   68  32:9909  86 8D             stx <.spriteY
   69  32:990B  A5 BE             lda <.randX
   70  32:990D  85 8C             sta <.spriteX
   71  32:990F  A9 00             lda #0
   72  32:9911  85 8F             sta <$8f
   73                             ;fall through
   74                     ;$991f
   75                     ;$32:98d6
   76  32:9913  68                pla
   77  32:9914  A8                tay
   78  32:9915  A5 CD             lda <.hand
   79  32:9917  F0 01             beq .show
   80  32:9919  C8                        iny
   81  32:991A            .show:
   82  32:991A  84 8E             sty <$8e
   83  32:991C  4C 57 93          jmp $9357
   84                     ;$991f
   85           77DF              .org    $97df
   86  32:77DF            blowSpriteHandlers:
   87                     ;1F 99 E0 98 D1 98 1C 98 15 98 EB 97
   88  32:77DF  1F 99             .dw     $991f   ;type 1
   89  32:77E1  D5 98             .dw     showBlowSprite_01       ;$98e0  ;type 0,2,4,9
   90  32:77E3  D1 98             .dw showBlowSprite_02   ;$98d1
   91  32:77E5  1C 98             .dw $981c
   92  32:77E7  15 98             .dw $9815
   93  32:77E9  EB 97             .dw $97eb
   94                     ;======================================================================================================
   95                             INIT_PATCH      $33,$a1ef,$a245
                0033              .bank   $33
                11EF              .org    $a1ef
       33:11EF                    .ds             (($a245) - ($a1ef))
                11EF              .org    $a1ef
   96                             
   97  33:11EF            blowEffect_init:
   98  33:11EF  20 1C A1          jsr $a11c
   99  33:11F2  A6 95             ldx <$95
  100  33:11F4  4C F9 A3          jmp $a3f9
  101  33:11F7            blowEffect_type07       ;shuriken       
  102           00CD      .hand = $cd
  103           00B6      .frameCount = $b6
  104  33:11F7  20 EF A1          jsr blowEffect_init
  105                             
  106  33:11FA  20 59 A0          jsr beginSwingFrame     ;a059
  107  33:11FD  A9 AF             lda #$af
  108  33:11FF  8D 49 7F          sta soundDriver_effectId
  109                     ;$a1ff:
  110  33:2202            .frame_loop:
  111  33:2202  20 5E A0                  jsr $a05e       ;;fill_A0hBytes_f0_at$0200andSet$c8_0
  112  33:2205  A5 B6                     lda <.frameCount
  113  33:2207  20 C1 A3                  jsr blowEffect_isFrameCountSatisfied
  114  33:220A  A5 CD                     lda <.hand
  115  33:220C  B0 0E                     bcs .frame_2nd_half
  116  33:220E  F0 06                             beq .frame_1st_right
  117  33:2210  A2 07                                     ldx #$07
  118  33:2212  A9 1E                                     lda #$1e
  119  33:2214  D0 12                                     bne .show_hand
  120  33:2216                            .frame_1st_right:
  121  33:2216  A2 05                                     ldx #$05
  122  33:2218  A9 18                                     lda #$18
  123  33:221A  D0 0C                                     bne .show_hand
  124  33:221C                    .frame_2nd_half:
  125  33:221C  F0 06                             beq .frame_2nd_right
  126  33:221E  A2 06                                     ldx #$06
  127  33:2220  A9 1F                                     lda #$1f
  128  33:2222  D0 04                                     bne .show_hand
  129  33:2224                            .frame_2nd_right:
  130  33:2224  A2 01                                     ldx #$01
  131  33:2226  A9 19                                     lda #$19
  132  33:2228                            .show_hand:
  133  33:2228  20 6E A0                          jsr $a06e
  134  33:222B                    .next_frame:
  135  33:222B  20 B0 F8                  jsr updateDmaPpuScrollSyncNmiEx ;f8b0
  136  33:222E  20 E6 8A                  jsr incrementSwingFrame ;8ae6
  137  33:2231  4A                        lsr a
  138  33:2232  20 C1 A3                  jsr blowEffect_isFrameCountSatisfied
  139  33:2235  90 CB                     bcc .frame_loop
  140  33:2237  20 FE A5          jsr $a5fe
  141  33:223A  4C 35 AC          jmp $ac35
  142                     ;$a245
  143                     ;------------------------------------------------------------------------------------------------------
  144                             ;INIT_PATCH     $33,$a2fb,$a365
  145                             ;INIT_PATCH     $33,$a379,$a3dd
  146                             INIT_PATCH $33,$a2fb,$a3dd
                0033              .bank   $33
                22FB              .org    $a2fb
       33:22FB                    .ds             (($a3dd) - ($a2fb))
                22FB              .org    $a2fb
  147                             
  148  33:22FB            blowEffect_doSwing_type09:      ;09=claw also 00(fist),08(arrow)
  149           00CD      .hand = $cd
  150           00BD      .swingCount = $bd
  151           00B6      .frameCount = $b6
  152                     
  153                             ;jsr $a11c
  154                             ;ldx <$95
  155                             ;jsr $a3f9
  156  33:22FB  20 EF A1          jsr blowEffect_init
  157  33:22FE            .swing_loop:
  158  33:22FE  20 59 A0                  jsr beginSwingFrame     ;a059
  159  33:3301  A9 8A                     lda #$8a
  160  33:3303  8D 49 7F                  sta soundDriver_effectId        ;$7f49
  161  33:3306                    .frame_loop:
  162  33:3306  20 5E A0                          jsr     $a05e   ;fill_A0hBytes_f0_at$0200andSet$c8_0
  163  33:3309  A5 CD                             lda <.hand
  164  33:330B  F0 09                             beq     .righthand
  165                     ;$a312
  166  33:330D  A9 06                                     lda #$06
  167  33:330F  20 35 A3                                  jsr .showFist
  168  33:3312  A9 0D                                     lda #$0d
  169  33:3314  D0 07                                     bne .show_blow
  170  33:3316                                    .righthand:
  171  33:3316  A9 05                                     lda #$05
  172  33:3318  20 35 A3                                  jsr .showFist
  173  33:331B  A9 04                                     lda #$04
  174  33:331D                            .show_blow:
  175  33:331D  48                                pha
  176  33:331E  20 CF A2                          jsr $a2cf
  177  33:3321  D0 05                             bne .play_blow
  178  33:3323  68                                        pla
  179  33:3324  48                                        pha
  180  33:3325  20 A1 92                                  jsr $92a1
  181  33:3328                            .play_blow:
  182  33:3328  68                                pla
  183  33:3329  A9 02                             lda #2
  184  33:332B  20 B2 97                          jsr $97b2
  185  33:332E                            .next_frame:
  186  33:332E  20 47 A3                          jsr blowEffect_advanceFrameOrFinish
  187  33:3331  90 D3                             bcc .frame_loop
  188  33:3333  B0 C9                             bcs .swing_loop
  189  33:3335            .showFist:
  190  33:3335  20 D9 A2          jsr $a2d9
  191  33:3338  20 4F A4          jsr     $a44f
  192  33:333B  29 01             and #1
  193  33:333D  85 7E             sta <$7e
  194  33:333F  20 4F A4          jsr $a44f
  195  33:3342  29 01             and #1
  196  33:3344  85 7F             sta <$7f
  197  33:3346            blowEffect_doReturn_00:
  198  33:3346  60                rts
  199                     ;------------------------------------------------------------------------------------------------------ 
  200  33:3347            blowEffect_advanceFrameOrFinish:
  201           00BD      .swingCount = $bd
  202                     ;[out] bool carry: do next frame(0),do next swing(1)
  203  33:3347  20 B0 F8          jsr updateDmaPpuScrollSyncNmiEx ;$f8b0
  204  33:334A  20 E6 8A          jsr incrementSwingFrame                 ;$8ae6
  205  33:334D  20 C1 A3          jsr blowEffect_isFrameCountSatisfied
  206  33:3350  90 F4             bcc blowEffect_doReturn_00 ;.return
  207  33:3352  C6 BD             dec <.swingCount
  208  33:3354  30 02             bmi .finish
  209  33:3356  D0 EE             bne blowEffect_doReturn_00      ;beq .finish
  210                     ;.return:
  211                     ;               rts
  212  33:3358            .finish:
  213  33:3358  68                pla     ;retaddr
  214  33:3359  68                pla     ;retaddr
  215  33:335A  4C 35 AC          jmp $ac35
  216                     ;------------------------------------------------------------------------------------------------------ 
  217                             ;.org   $a365
  218  33:335D            blowEffect_type01:
  219  33:335D  20 45 A2          jsr getSwingCountOfCurrentHand  ;a245
  220  33:3360  A9 00             lda #$00
  221  33:3362  F0 05             beq blowEffect_storeBlow
  222                     ;------------------------------------------------------------------------------------------------------         
  223                             ;.org   $a36f
  224  33:3364            blowEffect_type02:
  225  33:3364  20 45 A2          jsr getSwingCountOfCurrentHand  ;a245
  226  33:3367  A9 01             lda #$01
  227  33:3369            blowEffect_storeBlow
  228  33:3369  85 BA             sta <$ba
  229                             ;jmp blowEffect_doSwing_type0102
  230                             ;bne blowEffect_doSwing_type0102
  231                     ;------------------------------------------------------------------------------------------------------ 
  232                     
  233  33:336B            blowEffect_doSwing_type0102:
  234                     ;[in]
  235           00BA      .blowSprite = $ba
  236           00BD      .swingCount = $bd
  237           00CD      .hand = $cd     ;right=0 left=1
  238                     ;locals
  239           00B6      .frameCount = $b6       ;shared
  240                     ;locals (extra)
  241                     ;---------------------------------------
  242  33:336B  20 38 A4          jsr $a438       ;getWeaponSprite
  243  33:336E  20 0F A4          jsr $a40f       ;copySpriteProps
  244  33:3371  A6 95             ldx <$95
  245  33:3373  20 F9 A3          jsr $a3f9       ;clearWeaponSprite
  246                     
  247  33:3376            .swing_loop:    ;$a384:
  248  33:3376  20 59 A0                  jsr beginSwingFrame     ;$a059
  249  33:3379  85 B9                     sta <$b9
  250  33:337B  A9 B6                     lda #$b6
  251  33:337D  8D 49 7F                  sta soundDriver_effectId        ;$7f49
  252  33:3380                    .frame_loop:    ;$a38e:
  253  33:3380  20 5E A0                          jsr $a05e       ;fill_A0hBytes_f0_at$0200andSet$c8_0();
  254  33:3383  A5 B6                             lda <.frameCount
  255  33:3385  0A                                asl a
  256  33:3386  20 C1 A3                          jsr blowEffect_isFrameCountSatisfied
  257  33:3389  A5 CD                             lda <.hand
  258  33:338B  B0 16                             bcs .frame_2nd_half
  259                                                     ;前半(4フレーム)
  260  33:338D  F0 0A                                     beq .righthand_1st
  261  33:338F  A9 07                                             lda #7
  262  33:3391  A2 02                                             ldx #2
  263  33:3393  20 65 A0                                          jsr $a065
  264  33:3396  4C BA A3                                          jmp .next_frame
  265                                                             ;
  266  33:3399                                    .righthand_1st:
  267  33:3399  A2 05                                             ldx #5
  268  33:339B  A9 00                                             lda #0
  269  33:339D  20 6E A0                                          jsr $a06e
  270  33:33A0  4C BA A3                                          jmp .next_frame
  271  33:33A3                            .frame_2nd_half:
  272                                                     ;後半
  273  33:33A3  F0 0A                                     beq .righthand_2nd
  274  33:33A5  A9 06                                             lda #6
  275  33:33A7  A2 03                                             ldx #3
  276  33:33A9  20 65 A0                                          jsr $a065
  277  33:33AC  4C B5 A3                                          jmp .show_blow
  278  33:33AF                                    .righthand_2nd:
  279  33:33AF  A9 01                                             lda #1
  280  33:33B1  AA                                                tax
  281  33:33B2  20 6E A0                                          jsr $a06e
  282  33:33B5                            .show_blow:
  283  33:33B5  A5 BA                             lda <.blowSprite
  284  33:33B7  20 B2 97                          jsr $97b2
  285  33:33BA                    .next_frame:
  286  33:33BA  20 47 A3                  jsr blowEffect_advanceFrameOrFinish
  287  33:33BD  90 C1                     bcc .frame_loop
  288  33:33BF  B0 B5                     bcs .swing_loop
  289                     ;               a,x
  290                     ;r/1st  0,5
  291                     ;l/1st  7,2
  292                     ;r/2nd  1,1
  293                     ;l/2nd  6,3     
  294  33:33C1            blowEffect_isFrameCountSatisfied:
  295                     ;[in] a : frameCount
  296                     ;[out] bool carry : 1:satisfied ( frame >= limit)
  297           00CD      .hand = $cd
  298           00BB      .swingCounts = $bb
  299           0001              .ifdef VARIABLE_SWING_FRAMES
  300  33:33C1  48                        pha
  301  33:33C2  A6 CD                     ldx <.hand
  302  33:33C4  B5 BB                     lda <.swingCounts,x
  303  33:33C6  A2 03                     ldx #3
  304  33:33C8                    .find_range:
  305  33:33C8  DD D5 A3                          cmp .bounds,x
  306  33:33CB  B0 03                             bcs .found
  307  33:33CD  CA                                dex
  308  33:33CE  10 F8                             bpl .find_range
  309  33:33D0                    .found:
  310                                     ;x=index
  311  33:33D0  68                        pla
  312  33:33D1  DD D9 A3                  cmp blowEffect_frameBounds,x
  313  33:33D4  60                        rts
  314  33:33D5                    .bounds:
  315  33:33D5  00 05 0B                  .db $00,$05,$0b,$10
       33:33D8  10        
  316  33:33D9            blowEffect_frameBounds:
  317  33:33D9  08 06 04                  .db $08,$06,$04,$02
       33:33DC  02        
  318                             .else
  321                             .endif  ;VARIABLE_SWING_FRAMES
  322                     ;original: $a3dd        
  323                     ;------------------------------------------------------------------------------------------------------
  324           0033              .bank   $33
  325           0077              .org    $a077
  326  33:0077            swingCountBounds:
  327                                                     ;original
  328  33:0077  11                .db     $11             ;07 fist = 0
  329  33:0078  11                .db     $11             ;05 axe = 1, spear = 1, sword = 1,
  330  33:0079  11                .db     $11             ;05 rod = 2, book = 2, bell = 2,
  331  33:007A  11                .db     $11             ;07 bow = 3,
  332  33:007B  05                .db     $05             ;05 harp = 4,
  333  33:007C  07                .db     $07             ;07 boomerang = 5,
  334  33:007D  07                .db     $07             ;07 ring = 6,
  335  33:007E  07                .db     $07             ;07 shuriken = 7,
  336  33:007F  11                .db     $11             ;07 arrow = 8,
  337                             ;       claw = 9 (oops)
  338                     ;------------------------------------------------------------------------------------------------------
  339           0033              .bank   $33
  340           0080              .org    $a080
  341  33:0080            blowEffectHandlers:
  342  33:0080  F2 A2             .dw     $a2f2   ;fist
  343  33:0082  5D A3             .dw     blowEffect_type01       ;$a365  ;axe
  344  33:0084  64 A3             .dw     blowEffect_type02       ;$a36f  ;rod,book,bell
  345  33:0086  51 A2             .dw     $a251   ;bow
  346  33:0088  A5 A1             .dw     $a1a5   ;harp
  347  33:008A  2C A1             .dw     $a12c   ;boomerang
  348  33:008C  25 A1             .dw     $a125   ;engeturin
  349  33:008E  F7 A1             .dw     blowEffect_type07       ;$a1ef  ;shuriken
  350  33:0090  F2 A2             .dw     $a2f2   ;arrow
  351  33:0092  FB A2             .dw     $a2fb   ;claw
  352                     ;======================================================================================================
  353                             RESTORE_PC      ff3_blow_effect_begin
                0000              .bank   BANK(ff3_blow_effect_begin)
                0000              .org    ff3_blow_effect_begin
#[2]   ff3_hack_master.asm
   37                                     ;
#[3]   ff3_present_battle.asm
   38                                     .include "ff3_present_battle.asm"       ;save
    1                     ; ff3_present_battle.asm
    2                     ;
    3                     ; description:
    4                     ;       replaces presentBattle ($34:8ff7) related codes
    5                     ;
    6                     ; version:
    7                     ;       0.05 (2006-10-27)
    8                     ;======================================================================================================
    9  00:0000            ff3_present_battle_begin:
   10                     
   11                             INIT_PATCH $34,$8ff7,$9474
                0034              .bank   $34
                FFF7              .org    $8ff7
       34:FFF7                    .ds             (($9474) - ($8ff7))
                FFF7              .org    $8ff7
   12                             ;$93cd
   13                             
   14  34:FFF7            presentBattle:
   15                     ;[in]
   16           EEC2      .situation = $7ec2      ; usually commandId (set by commandHandler); toadsAction=18,prizeMessage=2
   17           88D5      .presentMode = $78d5; (commandChainId) (0-5: 0=attack 1=action 2,4=prize)
   18                     ;[shared]
   19           004B      .commandId = $4b
   20           0062      .pCommandList = $62
   21           0064      .iCommand = $64
   22                     ;--------------------------------------------------------------
   23  34:FFF7  AD C2 7E          lda .situation
   24  34:FFFA  F0 39             beq .finish
   25  34:FFFC  AD D5 78                  lda .presentMode
   26  34:FFFF  0A                        asl a
   27  34:0000  AA                        tax
   28  34:0001  BD FA 94                  lda pb_commandLists,x
   29  34:0004  85 62                     sta <.pCommandList
   30  34:0006  BD FB 94                  lda pb_commandLists+1,x
   31  34:0009  85 63                     sta <.pCommandList+1
   32  34:000B  A2 00                     ldx #0
   33  34:000D  8E EE 78                  stx battleMessageCount ;fromhere meaning changes to 'message index'
   34  34:0010  8E EF 78                  stx $78ef
   35  34:0013  86 64                     stx <.iCommand
   36  34:0015                    .command_loop:
   37  34:0015  20 3A 90                          jsr pb_initString
   38  34:0018  A4 64                             ldy <.iCommand
   39  34:001A  B1 62                             lda [.pCommandList],y
   40  34:001C  85 4B                             sta <.commandId ;00-0e
   41                                             ;cmp #$ff
   42                                             ;beq .finish
   43  34:001E  30 15                             bmi .finish
   44  34:0020  0A                                asl a
   45  34:0021  18                                clc
   46  34:0022  69 42                             adc #LOW(pb_handlers) ;#$4d
   47  34:0024  85 19                             sta <$19
   48  34:0026  A9 95                             lda #HIGH(pb_handlers) ;#$95
   49                                             ;adc #$00
   50  34:0028  85 1A                             sta <$1a
   51  34:002A  A9 6C                             lda #$6c        ;jmp (ptr)
   52  34:002C  85 18                             sta <$18
   53                                             ;0018: jmp ($954d + commandId<<1)
   54                                             ;jmp $0018
   55  34:002E  20 18 00                          jsr $0018
   56  34:0031  E6 64                             inc <.iCommand
   57  34:0033  D0 E0                             bne .command_loop
   58                     ;$9051:
   59                     ;       .org $9051
   60                     ;               rts
   61  34:0035            .finish: ;$9056:
   62  34:0035  A9 25             lda #$25
   63  34:0037  4C 0E FA          jmp call_2e_9d53        ;fa0e
   64                     ;$905b:
   65  34:003A            pb_initString:
   66  34:003A  A9 00             lda #0
   67  34:003C  A2 13             ldx #$13
   68  34:003E            .init_string:
   69  34:003E  9D D7 7A                  sta stringCache,x
   70  34:0041  CA                        dex
   71  34:0042  10 FA                     bpl .init_string
   72                             ;rts
   73  34:0044  4C 54 97          jmp initTileArrayStorage        ;9754
   74                     ;------------------------------------------------------------------------------------------------------
   75                     ;       .org    $905b
   76                     
   77  34:0047            pb_loadName:
   78           0057      .pPlayer = $57
   79                     ;indexToGroup = $7ecd
   80                     ;[in] a : charIndex
   81  34:0047  30 14             bmi .index_means_enemy
   82  34:0049  20 3C FD                  jsr shiftLeft6
   83  34:004C  18                        clc
   84  34:004D  69 0B                     adc #$0b
   85  34:004F  A8                        tay
   86  34:0050  A2 05                     ldx #5
   87  34:0052                    .load_player_name:
   88  34:0052  B1 57                             lda [.pPlayer],y
   89  34:0054  9D D7 7A                          sta stringCache,x
   90  34:0057  88                                dey
   91  34:0058  CA                                dex
   92  34:0059  10 F7                             bpl .load_player_name
   93  34:005B  30 24                             bmi .finish
   94  34:005D            .index_means_enemy:
   95  34:005D  29 7F                     and #$7f
   96  34:005F  C9 08                     cmp #8
   97  34:0061  D0 0A                     bne .single_target
   98  34:0063  20 C6 95                          jsr setBaseAddrTo_8c40
   99  34:0066  A9 16                             lda #$16
  100  34:0068  85 1A                             sta <$1a
  101  34:006A  4C 7A 90                          jmp .load
  102  34:006D                    .single_target:
  103  34:006D  AA                                tax
  104  34:006E  BD CD 7E                          lda indexToGroupMap,x
  105  34:0071  AA                                tax
  106  34:0072  BD 6B 7D                          lda groupToEnemyIdMap,x
  107  34:0075  85 1A                             sta <$1a
  108  34:0077  20 BD 95                          jsr setBaseAddrTo_8a40
  109  34:007A                    .load:
  110  34:007A  A2 00                     ldx #0
  111  34:007C  A5 1A                     lda <$1a
  112  34:007E  20 09 A6                  jsr loadString
  113  34:0081            .finish:
  114  34:0081  60                rts
  115                     
  116  34:0082            pb_checkNoMessage:
  117  34:0082  C9 FF             cmp #$ff
  118  34:0084  D0 02             bne .ok
  119  34:0086  68                        pla     ;retaddr
  120  34:0087  68                        pla     ;retaddr
  121  34:0088            .ok:
  122  34:0088  60                rts
  123                     ;------------------------------------------------------------------------------------------------------
  124  34:0089            pb_showActorName:       ;command05
  125           88D6      .actor = $78d6
  126  34:0089  AD D6 78          lda .actor
  127  34:008C  20 82 90          jsr pb_checkNoMessage
  128  34:008F  20 47 90          jsr pb_loadName
  129  34:0092  A9 00             lda #0
  130  34:0094  F0 25             beq pb_drawWindow
  131                     ;$90a0:
  132                     ;------------------------------------------------------------------------------------------------------
  133                     ;       .org $9177
  134  34:0096            pb_showTargetName:      ;command07
  135           88D8      .target = $78d8 ;charIndex
  136  34:0096  AD D8 78          lda .target
  137  34:0099  20 82 90          jsr pb_checkNoMessage
  138  34:009C  20 47 90          jsr pb_loadName
  139  34:009F  A9 02             lda #2
  140  34:00A1  D0 18             bne pb_drawWindow
  141                     ;$91ce:
  142                     ;------------------------------------------------------------------------------------------------------
  143                     ;       .org    $91d4
  144  34:00A3            pb_showEffectMessage:   ;command08
  145           88D9      .effect = $78d9
  146  34:00A3  AD D9 78          lda .effect
  147  34:00A6  20 82 90          jsr pb_checkNoMessage
  148  34:00A9  18                clc
  149  34:00AA  69 0C             adc #$0c
  150  34:00AC  85 1A             sta <$1a
  151  34:00AE  A2 82             ldx #$82
  152  34:00B0  86 19             stx <$19
  153  34:00B2  A2 00             ldx #0
  154  34:00B4  86 18             stx <$18
  155  34:00B6  20 09 A6          jsr loadString
  156  34:00B9  A9 03             lda #3
  157                             ;bne pb_drawWindow
  158  34:00BB            pb_drawWindow:
  159  34:00BB  48                pha
  160  34:00BC  A2 08             ldx #8
  161  34:00BE  86 18             stx <$18
  162  34:00C0  20 6A 96          jsr strToTileArray
  163  34:00C3  68                pla
  164  34:00C4  4C 1B 8D          jmp draw1LineWindow
  165                             ;jmp $9051      
  166                     ;------------------------------------------------------------------------------------------------------
  167                     ;       .org    $90a0
  168  34:00C7            pb_showActionName:      ;command06
  169           0072      .isItem = $72
  170           88D7      .messageId = $78d7
  171           AAC0      .pTileArray = $7ac0
  172  34:00C7  A5 72             lda <.isItem
  173  34:00C9  F0 1D             beq .not_item
  174                     ;item
  175  34:00CB  A2 00                     ldx #0
  176  34:00CD  86 18                     stx <$18
  177  34:00CF  A9 88                     lda #$88
  178  34:00D1  85 19                     sta <$19
  179  34:00D3  AD D7 78                  lda .messageId
  180  34:00D6  20 09 A6                  jsr loadString
  181  34:00D9  A2 F7                     ldx #$f7        ;-9
  182  34:00DB                    .shift_itemstr:
  183  34:00DB  BD E1 79                          lda stringCache-$f6,x
  184  34:00DE  9D E0 79                          sta stringCache-$f7,x
  185  34:00E1  E8                                inx
  186  34:00E2  D0 F7                             bne .shift_itemstr
  187  34:00E4  A9 01                     lda #1
  188  34:00E6  D0 D3                     bne pb_drawWindow
  189  34:00E8            .not_item:
  190  34:00E8  AD D7 78          lda .messageId
  191  34:00EB  20 82 90          jsr pb_checkNoMessage
  192  34:00EE  A0 05             ldy #5
  193  34:00F0            .map_to_kind:
  194  34:00F0  D9 35 91                  cmp .bounds,y
  195  34:00F3  B0 03                     bcs .mapped
  196  34:00F5  88                        dey
  197  34:00F6  10 F8                     bpl .map_to_kind
  198  34:00F8            .mapped:
  199                             ;y = kind
  200  34:00F8  A2 00             ldx #0
  201  34:00FA  C0 01             cpy #1  ;01 <= msgid <= 20 'n times hit'
  202  34:00FC  D0 15             bne .not_hit_message
  203  34:00FE  85 18                     sta <$18
  204  34:1100  86 19                     stx <$19        ;0
  205  34:1102  20 E1 95                  jsr itoa_16
  206  34:1105  A2 02                     ldx #2
  207  34:1107                    .store_count_digits:
  208  34:1107  B5 1D                             lda <$1d,x
  209  34:1109  9D D7 7A                          sta stringCache,x
  210  34:110C  CA                                dex
  211  34:110D  10 F8                             bpl .store_count_digits
  212  34:110F  A2 02                     ldx #2
  213  34:1111  A9 13                     lda #$13
  214  34:1113            .not_hit_message:
  215  34:1113            .load_base:
  216  34:1113  48                pha
  217  34:1114  98                tya
  218  34:1115  0A                asl a
  219  34:1116  A8                tay
  220  34:1117  B9 3B 91          lda .baseOffsets,y
  221  34:111A  85 18             sta <$18
  222  34:111C  B9 3C 91          lda .baseOffsets+1,y
  223  34:111F  85 19             sta <$19
  224  34:1121  68                pla
  225  34:1122  C0 06             cpy #(3*2)
  226  34:1124  D0 08             bne .load_string
  227                                             ;action
  228  34:1126  38                                sec
  229  34:1127  E9 39                             sbc #$39
  230           0001              .ifdef ENABLE_EXTRA_ABILITY
  231  34:1129  20 B0 9C                          jsr getExtraAbilityNameId
  232                             .endif  ;ENABLE_EXTRA_ABILITY
  233  34:112C  A2 00                             ldx #0
  234  34:112E            .load_string:
  235  34:112E  20 09 A6          jsr loadString
  236  34:1131  A9 01             lda #1
  237  34:1133  D0 86             bne pb_drawWindow
  238                     ;       msg             base    msgToIndex      meaning
  239                     ;       00:             8c40    =09             miss
  240                     ;       01-20:  8c40    =13             fight
  241                     ;       21-38:  8a40    +c6             summon
  242                     ;       39-51:  8c40    -39             action
  243                     ;       52-7f:  8200    -46             status
  244                     ;       80-fe:  8990    -80             special
  245                     ;       ff: no message
  246  34:1135            .bounds:
  247  34:1135  00 01 21          .db $00,$01,$21,$39,$52,$80
       34:1138  39 52 80  
  248                     ;.messageOffsets:
  249                     ;       .db $09,$00,$c6,$c7,$ba,$80
  250  34:113B            .baseOffsets:
  251  34:113B  52 8C             .dw     $8c40 + $09*2
  252  34:113D  40 8C             .dw     $8c40
  253  34:113F  CC 8B             .dw     $8a40 + $c6*2
  254  34:1141  40 8C             .dw $8c40; - $39*2
  255  34:1143  74 81             .dw $8200 - $46*2
  256  34:1145  90 88             .dw $8990 - $80*2
  257                     ;$9177:
  258                     ;------------------------------------------------------------------------------------------------------
  259  34:1147            pb_showInfoMessage:     ;command09
  260                     ;.messages = $78da
  261                     ;.messageCount = $78ee
  262           88E4      .messageParams = $78e4
  263           88EF      .iMessageParam = $78ef
  264           5575      pb_showInfoMessage_subCommands = $9575
  265  34:1147  AE EE 78          ldx battleMessageCount
  266  34:114A  BD DA 78          lda battleMessages,x
  267  34:114D  20 82 90          jsr pb_checkNoMessage
  268  34:1150  4A                lsr a
  269  34:1151  AA                tax
  270  34:1152  BD 75 95          lda pb_showInfoMessage_subCommands,x
  271                             ;carry still remains
  272  34:1155  B0 03             bcs .even_index
  273  34:1157  20 45 FD                  jsr $fd45       ;shiftright4
  274  34:115A            .even_index:
  275  34:115A  29 0F             and #$0f
  276  34:115C  0A                asl a
  277  34:115D  18                clc
  278  34:115E  69 64             adc #LOW(pb_showInfoMessage_handlers) ;#$6b
  279  34:1160  85 19             sta <$19
  280  34:1162  A9 95             lda #HIGH(pb_showInfoMessage_handlers) ;#$95
  281  34:1164  69 00             adc #0
  282  34:1166  85 1A             sta <$1a
  283  34:1168  A9 6C             lda #$6c        ;jmp (xxxx)
  284  34:116A  85 18             sta <$18
  285  34:116C  20 18 00          jsr $0018
  286                     ;$9236  
  287  34:116F  EE EE 78          inc battleMessageCount
  288  34:1172  60                rts
  289                     ;$923c
  290                     ;------------------------------------------------------------------------------------------------------
  291  34:1173            pb_loadInfoMessage:
  292  34:1173  48                pha
  293  34:1174  20 C6 95          jsr setBaseAddrTo_8c40
  294  34:1177  68                pla
  295  34:1178  AA                tax
  296  34:1179  AC EE 78          ldy battleMessageCount
  297  34:117C  B9 DA 78          lda battleMessages,y
  298  34:117F  4C 09 A6          jmp loadString
  299  34:1182            pb_showInfoMessage_00:
  300  34:1182  A9 00             lda #0
  301                             ;fall through
  302  34:1184            pb_loadInfoMessageAndDraw:
  303  34:1184  20 73 91          jsr pb_loadInfoMessage
  304  34:1187            pb_drawInfoWindow:
  305  34:1187  A2 11             ldx #$11
  306  34:1189  86 18             stx <$18
  307  34:118B  20 6A 96          jsr strToTileArray
  308  34:118E  A9 04             lda #4
  309  34:1190  4C 1B 8D          jmp draw1LineWindow     ;8d1b
  310                     ;------------------------------------------------------------------------------------------------------
  311  34:1193            pb_loadInfoMessageAndDrawWithWait:
  312  34:1193            pb_showInfoMessage_01:
  313  34:1193  A9 00             lda #0
  314  34:1195  20 84 91          jsr pb_loadInfoMessageAndDraw
  315                             ;jmp waitForPad1AButtonDown
  316  34:1198            waitForPad1AButtonDown:
  317  34:1198            .wait_loop:
  318  34:1198  20 AA FB                  jsr getPad1Input
  319  34:119B  A5 12                     lda <inputBits  ;$12
  320  34:119D  29 01                     and #1
  321  34:119F  F0 F7                     beq .wait_loop
  322  34:11A1  60                rts
  323                     ;------------------------------------------------------------------------------------------------------
  324  34:11A2            pb_printHp:
  325                     ;.destEnd = $24
  326  34:11A2  48                pha
  327  34:11A3  20 B4 91          jsr pb_getMessageParam16
  328  34:11A6  A2 04             ldx #4
  329  34:11A8  68                pla
  330  34:11A9  A8                tay
  331  34:11AA            .copy:
  332  34:11AA  B5 1A                     lda <$1a,x
  333  34:11AC  99 D7 7A                  sta stringCache,y
  334  34:11AF  88                        dey
  335  34:11B0  CA                        dex
  336  34:11B1  10 F7                     bpl .copy
  337  34:11B3  60                rts
  338                     ;------------------------------------------------------------------------------------------------------
  339  34:11B4            pb_getMessageParam16:
  340           88EF      .iParam = $78ef
  341           88E4      .battleMessageParams = $78e4
  342  34:11B4  AE EF 78          ldx .iParam
  343  34:11B7  BD E4 78          lda .battleMessageParams,x
  344  34:11BA  85 18             sta <$18
  345  34:11BC  E8                inx
  346  34:11BD  BD E4 78          lda .battleMessageParams,x
  347  34:11C0  85 19             sta <$19
  348  34:11C2  E8                inx
  349  34:11C3  8E EF 78          stx .iParam
  350  34:11C6  4C E1 95          jmp itoa_16
  351                     ;------------------------------------------------------------------------------------------------------
  352                     ;$34:91ce setNoTargetMessage
  353           11CE              .org    $91ce
  354  34:11CE            setNoTargetMessage:
  355  34:11CE  A9 FF             lda #$ff
  356  34:11D0  8D D8 78          sta $78d8
  357  34:11D3  60                rts
  358                     ;------------------------------------------------------------------------------------------------------
  359  34:11D4            pb_showInfoMessage_02_message:  ;"HP_?????/?????"
  360  34:11D4  77 79 FF          .db     $77,$79,$ff,$c5,$c5,$c5,$c5,$c5,$c7,$c5,$c5,$c5,$c5,$c5
       34:11D7  C5 C5 C5  
       34:11DA  C5 C5 C7  
       34:11DD  C5 C5 C5  
       34:11E0  C5 C5     
  361                     ;------------------------------------------------------------------------------------------------------
  362                             ;.org   $91d4
  363  34:11E2            pb_showInfoMessage_02:
  364           006E      .pActor = $6e   ;
  365  34:11E2  A2 0D             ldx #$0d
  366  34:11E4            .init_string:
  367                                     ; 0123456789abcd
  368                                     ;"HP_?????/?????"
  369  34:11E4  BD D4 91                  lda pb_showInfoMessage_02_message,x
  370  34:11E7  9D D7 7A                  sta stringCache,x
  371  34:11EA  CA                        dex
  372  34:11EB  10 F7                     bpl .init_string
  373  34:11ED  A0 30             ldy #$30
  374  34:11EF  B1 6E             lda [.pActor],y
  375  34:11F1  10 05             bpl .get_hp
  376  34:11F3  AD D8 7E          lda battleMode
  377  34:11F6  30 0A             bmi .show
  378  34:11F8            .get_hp:
  379  34:11F8  A9 07                     lda #$07
  380                                     ;sta <$24
  381  34:11FA  20 A2 91                  jsr pb_printHp
  382  34:11FD  A9 0D                     lda #$0d
  383                                     ;sta <$24
  384  34:11FF  20 A2 91                  jsr pb_printHp
  385  34:2202            .show:
  386                             ;fall through
  387  34:2202            pb_drawAndWait:
  388  34:2202  20 87 91          jsr pb_drawInfoWindow
  389  34:2205  4C 98 91          jmp waitForPad1AButtonDown
  390                     ;$92b5
  391                     ;------------------------------------------------------------------------------------------------------
  392                     ;$92db:
  393  34:2208            pb_showInfoMessage_03:
  394                     ;       %u + message
  395  34:2208  20 B4 91          jsr pb_getMessageParam16
  396  34:220B  A2 00             ldx #0
  397  34:220D  A0 00             ldy #0
  398  34:220F            .copy:
  399  34:220F  B5 1A                     lda <$1a,x
  400  34:2211  C9 FF                     cmp #$ff
  401  34:2213  F0 04                     beq .next
  402  34:2215  99 D7 7A                          sta stringCache,y
  403  34:2218  C8                                iny
  404  34:2219                    .next:
  405  34:2219  E8                        inx
  406  34:221A  E0 05                     cpx #5
  407  34:221C  D0 F1                     bne .copy
  408  34:221E  98                tya
  409  34:221F  20 84 91          jsr pb_loadInfoMessageAndDraw
  410  34:2222  4C 98 91          jmp waitForPad1AButtonDown
  411                     ;------------------------------------------------------------------------------------------------------
  412                     ;$932b
  413  34:2225            pb_showInfoMessage_04:
  414  34:2225  A9 00             lda #0
  415  34:2227  20 73 91          jsr pb_loadInfoMessage
  416                             ;stx <$2a
  417                             INIT16 <$18,$8800
       34:222A  A9 00             lda #LOW($8800)
       34:222C  85 18             sta <$18
       34:222E  A9 88             lda #HIGH($8800)
       34:2230  85 19             sta <$18+1
  418  34:2232  AD E4 78          lda $78e4
  419                             ;ldx <$2a
  420  34:2235  20 09 A6          jsr loadString
  421  34:2238  A9 FF             lda #$ff
  422  34:223A  8D DC 7A          sta stringCache+5
  423                             ;jmp pb_drawAndWait
  424  34:223D  D0 C3             bne pb_drawAndWait
  425                     ;$934e
  426                     ;------------------------------------------------------------------------------------------------------
  427                     ;$34:934e dispCommand_0B
  428  34:223F            pb_showDamage:  ;command0C
  429  34:223F  A9 17             lda #$17
  430                             ;fall through
  431  34:2241            pb_storeAndPlayEffect:
  432  34:2241  8D C2 7E          sta $7ec2
  433                             ;fall through
  434  34:2244            pb_playEffect:
  435  34:2244  4C 11 84          jmp playEffect  ;8411
  436                     ;------------------------------------------------------------------------------------------------------
  437  34:2247            pb_showDyingEffect:     ;command0D
  438           006E      .pActor = $6e
  439                     ;       [in] u8 $78d3 : ?
  440  34:2247  AD D3 78          lda $78d3
  441  34:224A  29 02             and #2
  442  34:224C  D0 2D             bne pb_doReturn
  443                     ;actor:         player                  enemy
  444                     ;target:
  445                     ; player        f0/93cd-e0/93cd f0/9408-e0/93cd
  446                     ; enemy         f0/93cd-e0/9408 f0/9408-e0/9408
  447  34:224E  20 D8 95          jsr $95d8       ;$18 = $00f0
  448  34:2251  20 2E A4          jsr getActor2C  ;a42e
  449  34:2254  30 06             bmi .actor_is_enemy     
  450  34:2256  20 88 92                  jsr pb_updatePlayerStatus       ;$93cd
  451  34:2259  4C 5F 92                  jmp .update_target
  452  34:225C            .actor_is_enemy:
  453  34:225C  20 B7 92                  jsr pb_updateEnemyStatus        ;$9408
  454  34:225F            .update_target:
  455                             ;todo: check actor != target 
  456  34:225F  20 CF 95          jsr $95cf       ;$18 = $00e0
  457  34:2262  A0 30             ldy #$30
  458  34:2264  B1 6E             lda [.pActor],y
  459  34:2266  30 06             bmi .target_is_enemy
  460  34:2268  20 88 92                  jsr pb_updatePlayerStatus       ;$93cd
  461  34:226B  4C 71 92                  jmp .show_effect
  462  34:226E            .target_is_enemy:
  463  34:226E  20 B7 92                  jsr pb_updateEnemyStatus        ;$9408
  464  34:2271            .show_effect:
  465  34:2271  20 74 94          jsr $9474
  466  34:2274  20 06 9D          jsr $9d06
  467  34:2277            pb_setEffect16:
  468  34:2277  A9 16             lda #$16
  469  34:2279  D0 C6             bne pb_storeAndPlayEffect
  470  34:227B            pb_doReturn:
  471  34:227B  60                rts
  472                     ;------------------------------------------------------------------------------------------------------
  473                     ;$34:93c4 dispCommand_0E
  474  34:227C            pb_updateTargetCache:   ;command0E
  475                             ;jsr $95cf
  476                             ;jsr pb_updateEnemyStatus       ;$9408
  477  34:227C  20 82 92          jsr updateEnemyStatusByTargetCache
  478  34:227F  4C 77 92          jmp pb_setEffect16
  479                     ;$93cd
  480  34:2282            updateEnemyStatusByTargetCache:
  481  34:2282  20 CF 95          jsr set18toTargetCache  ;$95cf
  482  34:2285  4C B7 92          jmp pb_updateEnemyStatus        ;$9408
  483                     ;------------------------------------------------------------------------------------------------------
  484                     ;$34:93cd updatePlayerStatus
  485  34:2288            pb_updatePlayerStatus:
  486           0018      .pCache = $18
  487           0052      .iPlayer = $52
  488           005B      .pBattleParam = $5b
  489           005F      .offset = $5f
  490                     
  491  34:2288  A2 03             ldx #3
  492  34:228A            .for_each_player:
  493  34:228A  86 52                     stx <.iPlayer
  494  34:228C  20 41 A5                  jsr getPlayerOffset     ;a541
  495                     
  496  34:228F  A5 52                     lda <.iPlayer
  497  34:2291  0A                        asl a
  498  34:2292  AA                        tax
  499  34:2293  A8                        tay
  500  34:2294  B1 18                     lda [.pCache],y ;y = player * 2
  501  34:2296  A4 5F                     ldy <.offset
  502  34:2298  C8                        iny
  503  34:2299  11 5B                     ora [.pBattleParam],y   ;y = offset 01
  504  34:229B  91 5B                     sta [.pBattleParam],y
  505  34:229D  10 04                     bpl .player_alive
  506                                             ;lda [.pBattleParam],y
  507  34:229F  29 FE                             and #$fe
  508  34:22A1  30 0C                             bmi .next       ;always satisfied
  509  34:22A3                    .player_alive:
  510  34:22A3  C8                                iny
  511  34:22A4  84 1A                             sty <$1a
  512  34:22A6  8A                                txa
  513  34:22A7  A8                                tay
  514  34:22A8  C8                                iny
  515  34:22A9  B1 18                             lda [.pCache],y
  516  34:22AB  A4 1A                             ldy <$1a
  517  34:22AD  11 5B                             ora [.pBattleParam],y
  518  34:22AF                    .next:
  519  34:22AF  91 5B                     sta [.pBattleParam],y
  520  34:22B1  A6 52                     ldx <.iPlayer
  521  34:22B3  CA                        dex
  522  34:22B4  10 D4                     bpl .for_each_player
  523  34:22B6  60                rts
  524                     ;------------------------------------------------------------------------------------------------------
  525                     ;$34:9408 updateEnemyStatus
  526  34:22B7            pb_updateEnemyStatus:
  527           0018      .pCache = $18
  528           001E      .pEnemy = $1e
  529           EEC4      .status = $7ec4
  530                     
  531                             INIT16 <.pEnemy,$7835
       34:22B7  A9 35             lda #LOW($7835)
       34:22B9  85 1E             sta <.pEnemy
       34:22BB  A9 78             lda #HIGH($7835)
       34:22BD  85 1F             sta <.pEnemy+1
  532  34:22BF  A2 07             ldx #7
  533  34:22C1            .for_each_enemy:
  534  34:22C1  8A                        txa
  535  34:22C2  0A                        asl a
  536  34:22C3  48                        pha
  537                                     
  538  34:22C4  A8                        tay
  539  34:22C5  B1 18                     lda [.pCache],y
  540  34:22C7  A0 01                     ldy #1
  541  34:22C9  11 1E                     ora [.pEnemy],y
  542  34:22CB  91 1E                     sta [.pEnemy],y
  543  34:22CD  29 E8                     and #$e8        ;dead|stone|toad|minimum
  544  34:22CF  F0 07                     beq .enemy_alive
  545  34:22D1  09 80                             ora #$80
  546  34:22D3  91 1E                             sta [.pEnemy],y
  547  34:22D5  9D C4 7E                          sta .status,x
  548  34:22D8                    .enemy_alive:
  549  34:22D8  68                        pla
  550  34:22D9  A8                        tay
  551  34:22DA  C8                        iny
  552  34:22DB  B1 18                     lda [.pCache],y
  553  34:22DD  A0 02                     ldy #2
  554  34:22DF  11 1E                     ora [.pEnemy],y
  555  34:22E1  91 1E                     sta [.pEnemy],y
  556                                     
  557                                     ;SUB16 <.pEnemy,$0040
  558                                     SUB16by8 <.pEnemy,#$40
       34:22E3  A5 1E             lda <.pEnemy
       34:22E5  38                sec
       34:22E6  E9 40             sbc #$40
       34:22E8  85 1E             sta <.pEnemy
       34:22EA  B0 02             bcs .sub16by8_00027
       34:22EC  C6 1F                     dec <.pEnemy+1
       34:22EE                    .sub16by8_00027:
  559  34:22EE  CA                        dex
  560  34:22EF  10 D0                     bpl .for_each_enemy
  561  34:22F1  60                rts
  562                     ;$9450:
  563                     ;======================================================================================================
  564                     ;       .org    $9450
  565                             ;$34:9450 dispCommand_0A //[waitForAButtonDownOrMessageTimeOut]
  566  34:22F2            pb_waitConfirmOrTimeout:        ;command0A
  567           0010      .messageSpeed = $6010
  568           0024      .timeout = $24
  569  34:22F2  A9 08             lda #8
  570  34:22F4  38                sec
  571  34:22F5  ED 10 60          sbc .messageSpeed
  572  34:22F8  0A                asl a
  573  34:22F9  0A                asl a
  574  34:22FA  0A                asl a
  575  34:22FB  85 24             sta <.timeout
  576  34:22FD  F0 10             beq .finish
  577  34:22FF            .wait_loop:
  578  34:22FF  20 85 81                  jsr presentCharacter
  579  34:3302  20 AA FB                  jsr getPad1Input
  580  34:3305  A5 12                     lda <inputBits
  581  34:3307  29 01                     and #1
  582  34:3309  D0 04                     bne .finish
  583  34:330B  C6 24                     dec <.timeout
  584  34:330D  D0 F0                     bne .wait_loop
  585  34:330F            .finish:
  586  34:330F  60                rts
  587                     ;$9474
  588  34:3310            pb_free_begin:
  589           4474      pb_free_end = $9474
  590                     ;------------------------------------------------------------------------------------------------------
  591                             ;.org   $94d6
  592                             INIT_PATCH $34,$94d6,$9575
                0034              .bank   $34
                44D6              .org    $94d6
       34:44D6                    .ds             (($9575) - ($94d6))
                44D6              .org    $94d6
  593  34:44D6            pb_closeWindow: ;command00,01,02,04
  594           004B      .commandId = $4b
  595           88D6      .params = $78d6
  596  34:44D6  A6 4B             ldx <.commandId
  597  34:44D8  BD D6 78          lda .params,x
  598  34:44DB  20 82 90          jsr pb_checkNoMessage
  599  34:44DE  8A                txa
  600  34:44DF  4C 14 8E          jmp $8e14
  601                     ;$94e7:
  602                     ;------------------------------------------------------------------------------------------------------
  603  34:44E2            pb_backCommand: ;command03
  604           0064      .iCommand = $64
  605  34:44E2  AE EE 78          ldx battleMessageCount
  606  34:44E5  BD DA 78          lda battleMessages,x
  607  34:44E8  C9 FF             cmp #$ff
  608  34:44EA  F0 EA             beq pb_closeWindow
  609                     
  610  34:44EC  A2 04             ldx #4
  611  34:44EE  AD D5 78          lda battleProcessType
  612  34:44F1  F0 01             beq .decrement
  613  34:44F3  E8                        inx
  614  34:44F4            .decrement:
  615  34:44F4  C6 64                     dec <.iCommand
  616  34:44F6  CA                        dex
  617  34:44F7  D0 FB                     bne .decrement
  618  34:44F9            .finish:
  619  34:44F9  60                rts
  620                     ;$950d:
  621                     
  622                     ;======================================================================================================
  623                     ;       .org    $950d
  624                             ;INIT_PATCH $34,$950d,$9575
  625  34:44FA            pb_commandLists:
  626  34:44FA  08 95             .dw     pb_processType_00
  627  34:44FC  17 95             .dw     pb_processType_01
  628  34:44FE  26 95             .dw     pb_processType_02
  629  34:5500  2A 95             .dw     pb_processType_03
  630  34:5502  31 95             .dw     pb_processType_04
  631  34:5504  37 95             .dw     pb_processType_05
  632  34:5506  3C 95             .dw pb_processEx_00
  633                     ;       .org    $9519
  634  34:5508            pb_processType_00:
  635  34:5508  05 07 0B          .db $05,$07,$0B,$06,$0C,$08,$0D,$09,$0A,$04,$03,$01,$02,$00,$FF
       34:550B  06 0C 08  
       34:550E  0D 09 0A  
       34:5511  04 03 01  
       34:5514  02 00 FF  
  636  34:5517            pb_processType_01:
  637  34:5517  05 06 07          .db $05,$06,$07,$0B,$0C,$08,$09,$0D,$0A,$04,$03,$02,$01,$00,$FF
       34:551A  0B 0C 08  
       34:551D  09 0D 0A  
       34:5520  04 03 02  
       34:5523  01 00 FF  
  638  34:5526            pb_processType_02:
  639  34:5526  09 0A 04          .db $09,$0A,$04,$FF
       34:5529  FF        
  640  34:552A            pb_processType_03:      ;fire cannon
  641  34:552A  09 0B 0C          .db $09,$0B,$0C,$0E,$0A,$04,$FF
       34:552D  0E 0A 04  
       34:5530  FF        
  642  34:5531            pb_processType_04:
  643  34:5531  05 09 0A          .db $05,$09,$0A,$04,$00,$FF
       34:5534  04 00 FF  
  644  34:5537            pb_processType_05:
  645  34:5537  09 0C 0A          .db $09,$0C,$0A,$04,$FF
       34:553A  04 FF     
  646  34:553C            pb_processEx_00:
  647  34:553C  05                .db $05
  648  34:553D  06                .db $06
  649  34:553E  0F                .db $0f ;processDisorderedShot (ex)
  650           0000              .ifndef SHOW_INFO_ON_DISORDERED_SHOT
  654                             .endif  ;SHOW_INFO_ON_DISORDERED_SHOT
  655  34:553F  01                .db $01
  656  34:5540  00                .db $00
  657  34:5541  FF                .db $FF ;end
  658                     
  659                     ;       .org    $954d
  660  34:5542            pb_handlers:
  661  34:5542  D6 94             .dw     pb_closeWindow  ;00 $94d6
  662  34:5544  D6 94             .dw     pb_closeWindow  ;01 $94d6
  663  34:5546  D6 94             .dw pb_closeWindow      ;02 $94d6
  664  34:5548  E2 94             .dw pb_backCommand      ;03 $94e7
  665  34:554A  D6 94             .dw pb_closeWindow      ;04 $94d6
  666  34:554C  89 90             .dw pb_showActorName            ;05 905b
  667  34:554E  C7 90             .dw     pb_showActionName               ;06 90a0
  668  34:5550  96 90             .dw     pb_showTargetName               ;07 9177
  669  34:5552  A3 90             .dw     pb_showEffectMessage    ;08 91d4
  670  34:5554  47 91             .dw pb_showInfoMessage          ;09 $91fe
  671  34:5556  F2 92             .dw pb_waitConfirmOrTimeout     ;0a $9450
  672  34:5558  44 92             .dw pb_playEffect                       ;0b $934e
  673  34:555A  3F 92             .dw pb_showDamage                       ;0c $9354
  674  34:555C  47 92             .dw pb_showDyingEffect          ;0d $935f
  675  34:555E  7C 92             .dw pb_updateTargetCache        ;0e $93c4
  676  34:5560            pb_handlers_ex:
  677  34:5560  00 00             .dw 0   ;0f extenstion
  678  34:5562  00 00             .dw 0   ;10
  679                     ;       .org    $956b
  680  34:5564            pb_showInfoMessage_handlers:
  681  34:5564  82 91             .dw pb_showInfoMessage_00
  682  34:5566  93 91             .dw pb_showInfoMessage_01
  683  34:5568  E2 91             .dw pb_showInfoMessage_02
  684  34:556A  08 92             .dw pb_showInfoMessage_03
  685  34:556C  25 92             .dw pb_showInfoMessage_04
  686                     ;$9575:
  687                     ;======================================================================================================
  688                             RESTORE_PC ff3_present_battle_begin
                0000              .bank   BANK(ff3_present_battle_begin)
                0000              .org    ff3_present_battle_begin
#[2]   ff3_hack_master.asm
#[3]   ff3_info_window.asm
   39                                     .include "ff3_info_window.asm"          ;save
    1                     ; ff3_info_window
    2                     ;
    3                     ;description:
    4                     ;       replaces code for information window (larger window on the bottom right)
    5                     ;
    6                     ;version:
    7                     ;       0.01 (2006-10-24)
    8                     ;
    9                     ;======================================================================================================
   10  00:0000            ff3_info_window_begin:
   11                     
   12                             INIT_PATCH      $34,$9ba2,$9ce3
                0034              .bank   $34
                BBA2              .org    $9ba2
       34:BBA2                    .ds             (($9ce3) - ($9ba2))
                BBA2              .org    $9ba2
   13  34:BBA2            drawInfoWindow:
   14           0052      .iPlayer = $52
   15           0057      .pBaseParam = $57
   16           005B      .pBattleParam = $5b
   17           88CF      .commandIds = $78cf
   18                     
   19  34:BBA2  AD EB 7C          lda $7ceb
   20  34:BBA5  F0 06             beq .continue_process
   21  34:BBA7  A9 00                     lda #0
   22  34:BBA9  8D EB 7C                  sta $7ceb
   23  34:BBAC  60                        rts
   24  34:BBAD            .continue_process:
   25  34:BBAD  20 54 97          jsr initTileArrayStorage
   26                             ;INIT16 $720a,$7977
   27                             INIT16 TILE_ARRAY_BASE+$0a,$7977        ;'H' 'P'
       34:BBB0  A9 77             lda #LOW($7977)
       34:BBB2  8D 2A 72          sta TILE_ARRAY_BASE+$0a
       34:BBB5  A9 79             lda #HIGH($7977)
       34:BBB7  8D 2B 72          sta TILE_ARRAY_BASE+$0a+1
   28  34:BBBA  A5 52             lda <.iPlayer
   29  34:BBBC  48                pha
   30  34:BBBD  A2 00             ldx #0
   31  34:BBBF            .for_each_player:
   32  34:BBBF  86 52                     stx <.iPlayer
   33  34:BBC1  A2 12                     ldx #$12
   34  34:BBC3  20 49 A5                  jsr initString
   35                                     ;$7ae3 = #c7;
   36  34:BBC6  20 41 A5                  jsr getPlayerOffset     ;a541
   37  34:BBC9  18                        clc
   38  34:BBCA  69 0B                     adc #$0b
   39  34:BBCC  A8                        tay
   40  34:BBCD  A2 06                     ldx #6
   41  34:BBCF                    .copy_name:
   42  34:BBCF  B1 57                             lda [.pBaseParam],y
   43  34:BBD1  9D D7 7A                          sta stringCache,x
   44  34:BBD4  88                                dey
   45  34:BBD5  CA                                dex
   46  34:BBD6  D0 F7                             bne .copy_name
   47                                             
   48  34:BBD8  A2 0B                     ldx #7+4
   49  34:BBDA  A9 03                     lda #3
   50  34:BBDC  20 8D 9C                  jsr getStringFromValueAt        ;ex
   51                     
   52                                     ;lda #0
   53                                     ;sta <$24
   54  34:BBDF  20 1D 9D                  jsr cachePlayerStatus   ;9d1d
   55  34:BBE2  AD E8 7C                  lda $7ce8
   56  34:BBE5  C9 FF                     cmp #$ff
   57  34:BBE7  F0 5A                     beq .show_maxhp
   58                     
   59  34:BBE9  A6 52                             ldx <.iPlayer
   60  34:BBEB  BD CF 78                          lda .commandIds,x
   61  34:BBEE  C9 FF                             cmp #$ff
   62  34:BBF0  F0 1F                             beq .check_status
   63                     
   64  34:BBF2  C9 C8                                     cmp #$c8
   65  34:BBF4  90 0C                                     bcc .not_magic
   66  34:BBF6                                    .action_is_magic:
   67                                                             INIT16_x <$18, ($8990 - $c8 * 2)
       34:BBF6  A2 00             ldx #LOW(($8990 - $c8 * 2))
       34:BBF8  86 18             stx <$18
       34:BBFA  A2 88             ldx #HIGH(($8990 - $c8 * 2))
       34:BBFC  86 19             stx <$18+1
   68  34:BBFE  A2 0C                                             ldx #$0c
   69  34:CC00  D0 3B                                             bne .load_string
   70  34:CC02                                    .not_magic:
   71           0001              .ifdef ENABLE_EXTRA_ABILITY
   72  34:CC02  20 B0 9C                                          jsr getExtraAbilityNameId
   73                             .endif ;ENABLE_EXTRA_ABILITY
   74                                                             INIT16_x <$18, $8c40
       34:CC05  A2 40             ldx #LOW($8c40)
       34:CC07  86 18             stx <$18
       34:CC09  A2 8C             ldx #HIGH($8c40)
       34:CC0B  86 19             stx <$18+1
   75  34:CC0D  A2 0D                                             ldx #$0d
   76  34:CC0F  D0 2C                                             bne .load_string
   77  34:CC11                            .check_status:
   78  34:CC11  A5 1B                             lda <$1b
   79  34:CC13  05 1A                             ora <$1a
   80  34:CC15  F0 2C                             beq .show_maxhp
   81  34:CC17  A5 1B                                     lda <$1b
   82  34:CC19  29 20                                     and #$20
   83  34:CC1B  F0 0A                                     beq .status_bit_to_index
   84  34:CC1D  A5 1B                                             lda <$1b
   85  34:CC1F  29 DF                                             and #$df
   86  34:CC21  85 1B                                             sta <$1b
   87  34:CC23  05 1A                                             ora <$1a
   88  34:CC25  F0 1C                                             beq .show_maxhp
   89  34:CC27                                    .status_bit_to_index:
   90  34:CC27  A0 00                                     ldy #0
   91  34:CC29                                    .find_index:
   92  34:CC29  06 1B                                             asl <$1b
   93  34:CC2B  26 1A                                             rol <$1a
   94  34:CC2D  B0 03                                             bcs .got_index
   95  34:CC2F  C8                                                iny
   96  34:CC30  90 F7                                             bcc .find_index
   97  34:CC32                                    .got_index:
   98                                                     INIT16_x <$18,$822c
       34:CC32  A2 2C             ldx #LOW($822c)
       34:CC34  86 18             stx <$18
       34:CC36  A2 82             ldx #HIGH($822c)
       34:CC38  86 19             stx <$18+1
   99  34:CC3A  98                                        tya
  100  34:CC3B  A2 0D                                     ldx #$0d
  101                                                     ;bne .load_string
  102  34:CC3D                            .load_string:
  103  34:CC3D  20 09 A6                          jsr loadString
  104  34:CC40  4C 60 9C                          jmp .to_tiles
  105                     ;$9c7f:
  106  34:CC43                            .show_maxhp:
  107  34:CC43  AD E8 7C                          lda $7ce8
  108  34:CC46  C9 FF                             cmp #$ff
  109  34:CC48  F0 0F                             beq .get_maxhp
  110  34:CC4A  AD E1 7B                                  lda $7be1
  111  34:CC4D  A6 52                                     ldx <.iPlayer
  112  34:CC4F  20 38 FD                                  jsr maskTargetBit
  113  34:CC52  F0 05                                     beq .get_maxhp
  114  34:CC54  BD CF 78                                          lda .commandIds,x
  115  34:CC57  D0 9D                                             bne .action_is_magic
  116  34:CC59                            .get_maxhp:
  117  34:CC59  A2 10                             ldx #$10
  118  34:CC5B  A9 05                             lda #5
  119  34:CC5D  20 8D 9C                          jsr getStringFromValueAt
  120                     ;$9cba:
  121                                     ;$7ae3 = #c7;
  122  34:CC60                    .to_tiles:
  123  34:CC60  A9 C7                     lda #$c7
  124  34:CC62  8D E3 7A                  sta stringCache+$0c
  125  34:CC65  A9 12                     lda #$12
  126  34:CC67  85 18                     sta <$18
  127  34:CC69  20 6A 96                  jsr strToTileArray
  128  34:CC6C  A9 12                     lda #$12
  129  34:CC6E  20 58 A5                  jsr offsetTilePtr
  130  34:CC71  A6 52                     ldx <.iPlayer
  131  34:CC73  E8                        inx
  132  34:CC74  E0 04                     cpx #4
  133  34:CC76  F0 03                     beq .finish
  134  34:CC78  4C BF 9B                  jmp .for_each_player
  135                     ;$9cd1:
  136  34:CC7B            .finish:
  137  34:CC7B  68                pla
  138  34:CC7C  85 52             sta <.iPlayer
  139  34:CC7E  A9 0B             lda #$0b
  140  34:CC80  85 18             sta <$18
  141  34:CC82  A9 1E             lda #$1e
  142  34:CC84  85 19             sta <$19
  143  34:CC86  A9 03             lda #$03
  144  34:CC88  85 1A             sta <$1a
  145  34:CC8A  4C 38 8B          jmp draw8LineWindow
  146                     ;------------------------------------------------------------------------------------------------------
  147  34:CC8D            getStringFromValueAt:
  148                     ;[in] x = dest end offset
  149                     ;[in] a = offset to value
  150           005B      .pBattleParam = $5b
  151  34:CC8D  20 88 9B          jsr setYtoOffsetOf
  152  34:CC90  B1 5B             lda [.pBattleParam],y
  153  34:CC92  85 18             sta <$18
  154  34:CC94  C8                iny
  155  34:CC95  B1 5B             lda [.pBattleParam],y
  156  34:CC97  85 19             sta <$19
  157  34:CC99  8A                txa
  158  34:CC9A  48                pha
  159  34:CC9B  20 E1 95          jsr itoa_16     ;95e1
  160  34:CC9E  68                pla
  161  34:CC9F  A8                tay
  162  34:CCA0  A2 03             ldx #3
  163  34:CCA2            .copy:
  164  34:CCA2  B5 1B                     lda <$1b,x
  165  34:CCA4  99 D7 7A                  sta stringCache,y
  166  34:CCA7  88                        dey
  167  34:CCA8  CA                        dex
  168  34:CCA9  10 F7                     bpl .copy
  169  34:CCAB  60                rts
  170                     
  171  34:CCAC            infoWindow_free_begin:
  172           CCE3      infoWindow_free_end = $9ce3
  173                     ;------------------------------------------------------------------------------------------------------
  174                     ;$9ce3
  175                     ;======================================================================================================
  176                             RESTORE_PC ff3_info_window_begin
                0000              .bank   BANK(ff3_info_window_begin)
                0000              .org    ff3_info_window_begin
#[2]   ff3_hack_master.asm
#[3]   ff3_executeAction.asm
   40                                     .include "ff3_executeAction.asm"        ;save
    1                     ; ff3_executeAction.asm
    2                     ;
    3                     ;description:
    4                     ;       replaces executeAction()
    5                     ;
    6                     ;version:
    7                     ;       0.01 (2006-10-26)
    8                     ;
    9                     ;======================================================================================================
   10  00:0000            ff3_executeAction_begin:
   11                     
   12                             ;INIT_PATCH $34,$9de4,$9fac
   13           0034              .bank   $34
   14           DDE4              .org    $9de4
   15  34:DDE4            executeAction:
   16                     ;[in]
   17           AAC2      .currentActor = $7ac2
   18           AACB      .ordinalToIndex = $7acb
   19                     ;[local]
   20           006E      .pActor = $6e
   21           0070      .pTarget = $70
   22                     
   23  34:DDE4  AE C2 7A          ldx .currentActor
   24  34:DDE7  BD CB 7A          lda .ordinalToIndex,x
   25  34:DDEA  48                pha
   26                             
   27  34:DDEB  10 05             bpl .actor_is_player_char
   28  34:DDED  18                        clc
   29  34:DDEE  29 7F                     and #$7f
   30  34:DDF0  69 04                     adc #4
   31  34:DDF2            .actor_is_player_char:
   32                     ;$9df3:
   33  34:DDF2  85 18             sta <$18
   34  34:DDF4  85 26             sta <$26
   35                             
   36  34:DDF6  A9 40             lda #$40
   37  34:DDF8  85 1A             sta <$1a
   38                             INIT16 <$20,$7575
       34:DDFA  A9 75             lda #LOW($7575)
       34:DDFC  85 20             sta <$20
       34:DDFE  A9 75             lda #HIGH($7575)
       34:EE00  85 21             sta <$20+1
   39                             
   40  34:EE02  20 2E 80          jsr dispatchBattleFunction_07   ;802e => calcDataAddress
   41                     
   42  34:EE05  A5 1C             lda <$1c
   43  34:EE07  85 6E             sta <.pActor
   44  34:EE09  A5 1D             lda <$1d
   45  34:EE0B  85 6F             sta <.pActor+1
   46                     
   47  34:EE0D  A5 26             lda <$26
   48  34:EE0F  C9 0C             cmp #$0c
   49  34:EE11  90 03             bcc .actor_valid
   50                                     ;?
   51  34:EE13  68                        pla
   52  34:EE14  D0 39                     bne .check_status       ;$9e5f
   53  34:EE16            .actor_valid:
   54  34:EE16  68                pla
   55  34:EE17  A8                tay
   56  34:EE18  29 87             and #$87
   57  34:EE1A  8D D6 78          sta $78d6       ;actor name
   58  34:EE1D  29 7F             and #$7f
   59  34:EE1F  AA                tax
   60                             ;lda #0
   61                             ;jsr flagTargetBit
   62  34:EE20  20 BA 9F          jsr flagSingleTarget
   63  34:EE23  8D 98 7E          sta $7e98
   64  34:EE26  98                tya     ;actor index|flag
   65                     
   66  34:EE27  10 26             bpl .check_status
   67                                     ;actor enemy
   68  34:EE29  AD 9A 7E                  lda $7e9a
   69  34:EE2C  09 80                     ora #$80
   70  34:EE2E  8D 9A 7E                  sta $7e9a
   71                                     
   72                                     ;a = $7ced;
   73                                     ;if( ((#55 == $7ced) && ($7cee == 0))
   74                                     ;       || ( ((#79 == $7ced) || (#90 == $7ced)) && ($7cee != 0) ) )
   75  34:EE31  AD ED 7C                  lda $7ced
   76  34:EE34  AE EE 7C                  ldx $7cee
   77  34:EE37  D0 06                     bne ._7cee_not_0
   78  34:EE39  C9 55                             cmp #$55
   79  34:EE3B  D0 12                             bne .check_status
   80  34:EE3D  F0 08                             beq .heal_hp
   81  34:EE3F                    ._7cee_not_0:
   82  34:EE3F  C9 79                             cmp #$79
   83  34:EE41  F0 04                             beq .heal_hp
   84  34:EE43  C9 90                             cmp #$90
   85  34:EE45  D0 08                             bne .check_status
   86  34:EE47                    .heal_hp:
   87  34:EE47  A0 06                             ldy #6
   88  34:EE49  B1 6E                             lda [.pActor],y
   89  34:EE4B  A0 04                             ldy #4
   90  34:EE4D  91 6E                             sta [.pActor],y
   91  34:EE4F            .check_status:  ;$9e5f:
   92  34:EE4F  A0 01             ldy #1
   93  34:EE51  B1 6E             lda [.pActor],y
   94  34:EE53  29 C0             and #$c0        ;dead|stone
   95  34:EE55  D0 68             bne .actor_status_bad
   96                                     ;check more
   97  34:EE57  C8                        iny
   98  34:EE58  B1 6E                     lda [.pActor],y
   99  34:EE5A  29 C0                     and #$c0        ;paralyzed | sleeping
  100  34:EE5C  F0 0B                     beq .actor_status_ok
  101  34:EE5E  A9 01                             lda #1
  102  34:EE60  20 7B 9F                          jsr setActorActionAndClearMode  ;$9f7b
  103  34:EE63  20 CE 91                          jsr setNoTargetMessage  ;$91ce
  104  34:EE66  20 87 9F                          jsr setActionTargetToSelf       ;$9f87
  105                     ;$9e93:
  106  34:EE69                    .actor_status_ok:
  107  34:EE69  A0 2F                     ldy #$2f
  108  34:EE6B  B1 6E                     lda [.pActor],y
  109  34:EE6D  8D 99 7E                  sta $7e99
  110  34:EE70  8D 9B 7E                  sta $7e9b
  111  34:EE73  D0 03                     bne .target_valid
  112  34:EE75  20 87 9F                          jsr setActionTargetToSelf
  113  34:EE78                    .target_valid:
  114  34:EE78  A2 00                     ldx #0
  115  34:EE7A                    .target_bit_to_index:
  116  34:EE7A  0A                                asl a
  117  34:EE7B  B0 03                             bcs .got_index
  118  34:EE7D  E8                                inx
  119  34:EE7E  D0 FA                             bne .target_bit_to_index
  120  34:EE80                    .got_index:
  121  34:EE80  8A                        txa
  122  34:EE81  48                        pha
  123                                     
  124  34:EE82  C8                        iny
  125  34:EE83  B1 6E                     lda [.pActor],y ;+30
  126  34:EE85  A8                        tay
  127                                     
  128  34:EE86  10 11                     bpl .target_player
  129  34:EE88  AD 9A 7E                          lda play_effectTargetSide       ;$7e9a
  130  34:EE8B  09 40                             ora #$40
  131  34:EE8D  8D 9A 7E                          sta play_effectTargetSide       ;$7e9a
  132                                             
  133  34:EE90  68                                pla
  134  34:EE91  09 80                             ora #$80
  135  34:EE93  48                                pha     ;sta $78d8
  136                     
  137  34:EE94  18                                clc
  138  34:EE95  8A                                txa
  139  34:EE96  69 04                             adc #4
  140  34:EE98  AA                                tax
  141                                             ;bne .set_target_name
  142  34:EE99                    .target_player:
  143  34:EE99                    .set_target_name:
  144  34:EE99  86 18                     stx <$18        ;actor ordinal
  145  34:EE9B  68                        pla     ;target index
  146  34:EE9C  AA                        tax
  147                                     
  148  34:EE9D  98                        tya     ;target flag
  149  34:EE9E  0A                        asl a
  150  34:EE9F  10 02                     bpl .target_single
  151  34:EEA1  A2 88                             ldx #$88
  152  34:EEA3                    .target_single:
  153  34:EEA3  8E D8 78                  stx $78d8
  154                     
  155  34:EEA6  A9 40                     lda #$40
  156  34:EEA8  85 1A                     sta <$1a
  157                                     INIT16 <$20,$7575
       34:EEAA  A9 75             lda #LOW($7575)
       34:EEAC  85 20             sta <$20
       34:EEAE  A9 75             lda #HIGH($7575)
       34:EEB0  85 21             sta <$20+1
  158  34:EEB2  20 2E 80                  jsr dispatchBattleFunction_07   ;$802e
  159                                     
  160  34:EEB5  A5 1C                     lda <$1c
  161  34:EEB7  85 70                     sta <.pTarget
  162  34:EEB9  A5 1D                     lda <$1d
  163  34:EEBB  85 71                     sta <.pTarget+1
  164  34:EEBD  D0 15                     bne .check_action_mode  ;target address should be $75xx-$77xx
  165                                     ;bne
  166  34:EEBF            .actor_status_bad
  167  34:EEBF  88                        dey
  168  34:EEC0  98                        tya
  169  34:EEC1  8C C2 7E                  sty effectHandlerIndex  ;$7ec2
  170  34:EEC4  8C 98 7E                  sty $7e98
  171  34:EEC7  88                        dey
  172  34:EEC8  8C EB 7C                  sty $7ceb
  173  34:EECB  8C D8 78                  sty $78d8
  174  34:EECE  8C D6 78                  sty $78d6
  175  34:EED1  20 7B 9F                  jsr setActorActionAndClearMode  ;$9f7b
  176                     ;$9eec:
  177                     ;-----------------------------
  178  34:EED4            .check_action_mode:
  179           001A      .actionId = $1a
  180  34:EED4  A0 2E             ldy #$2e
  181  34:EED6  B1 6E             lda [.pActor],y
  182  34:EED8  85 1A             sta <.actionId  ;actionid
  183                             
  184  34:EEDA  20 2E A4          jsr getActor2C
  185  34:EEDD  AA                tax
  186  34:EEDE  29 10             and #$10        ;special
  187  34:EEE0  D0 36             bne .special_attack     ;$9f5a
  188  34:EEE2  8A                txa
  189  34:EEE3  29 08             and #$08
  190  34:EEE5  D0 0A             bne .use_item   ;$9f19
  191                     ;$9f0b:
  192  34:EEE7  A5 1A             lda <.actionId
  193           0001              .ifdef ENABLE_EXTRA_ABILITY
  194  34:EEE9  C9 1A                     cmp #CMDX_ID_END
  195                             .else
  197                             .endif
  198  34:EEEB  90 2D             bcc .dispatch
  199  34:EEED  C9 46             cmp #$46
  200  34:EEEF  B0 04             bcs .check_caster
  201                             ;invalid action id
  202  34:EEF1            .use_item:
  203  34:EEF1  A9 13             lda #$13
  204  34:EEF3  D0 25             bne .dispatch
  205  34:EEF5            .check_caster:
  206                             ;jsr getActor2C
  207  34:EEF5  8A                txa
  208  34:EEF6  30 20             bmi .special_attack
  209                     ;decrement mp
  210           0052      .iPlayer = $52
  211  34:EEF8  29 07                     and #7
  212  34:EEFA  AA                        tax
  213  34:EEFB  BD C7 7A                  lda selectedMagicLv,x
  214  34:EEFE  18                        clc
  215  34:EEFF  69 07                     adc #7
  216  34:FF01  A8                        tay
  217  34:FF02  38                        sec
  218  34:FF03  B1 6E                     lda [.pActor],y ;mp
  219  34:FF05  E9 01                     sbc #1
  220  34:FF07  91 6E                     sta [.pActor],y
  221                                     
  222  34:FF09  A5 1A                     lda <.actionId
  223  34:FF0B  A2 07                     ldx #7
  224  34:FF0D                    .check_summon_id:
  225  34:FF0D  DD 2C 9F                          cmp .summonMagicIds,x
  226  34:FF10  D0 03                             bne .check_summon_next
  227  34:FF12  4C 00 A0                                  jmp executeAction_summon
  228  34:FF15                            .check_summon_next:
  229  34:FF15  CA                                dex
  230  34:FF16  10 F5                             bpl .check_summon_id
  231  34:FF18            .special_attack:        ;$9f5a
  232  34:FF18  A9 14             lda #$14
  233  34:FF1A            .dispatch:      ;$9f5c
  234  34:FF1A  8D C2 7E          sta effectHandlerIndex  ;$7ec2
  235                     
  236  34:FF1D  0A                asl a
  237  34:FF1E  AA                tax
  238  34:FF1F  BD 34 9F          lda executeAction_handlers,x
  239  34:FF22  85 18             sta <$18
  240  34:FF24  BD 35 9F          lda executeAction_handlers+1,x
  241  34:FF27  85 19             sta <$19
  242  34:FF29  6C 18 00          jmp [$0018]
  243  34:FF2C            .summonMagicIds:
  244  34:FF2C  CE D5 DC          .db $ce,$d5,$dc,$e3,$ea,$f1,$f8,$ff
       34:FF2F  E3 EA F1  
       34:FF32  F8 FF     
  245  34:FF34            executeAction_end:
  246                     ;======================================================================================================
  247           FFA8      command_none            = $9fa8
  248           668A      command_01                      = $a68a
  249                     ;command_forward        = $a7df
  250                     ;command_back           = $a7ea
  251                     ;command_fight          = $a104
  252                     ;command_guard          = $a881
  253                     ;command_escape         = $a8bf
  254                     ;command_sneakAway      = $a93b
  255                     ;command_jump           = $a9d8
  256                     ;command_land           = $aa11
  257                     ;command_0A                     = $a89f
  258                     ;command_geomance       = $aa5d
  259                     ;command_inspect        = $ab73
  260                     ;command_detect         = $ab0c
  261                     ;command_steal          = $aba4
  262                     ;command_charge         = $ac6f
  263                     ;command_sing           = $acd5
  264                     ;command_intimidate     = $ad16
  265                     ;command_cheer          = $ad75
  266           33BB      command_item            = $a3bb
  267           3367      command_magic           = $a367
  268                     ;------------------------------------------------------------------------------------------------------
  269                     ;       .org    $9fac
  270                             INIT_PATCH $34,$9fac,$9fac+($02*$15)
                0034              .bank   $34
                FFAC              .org    $9fac
       34:FFAC                    .ds             (($9fac+($02*$15)) - ($9fac))
                FFAC              .org    $9fac
  271                             RESTORE_PC executeAction_end
                0034              .bank   BANK(executeAction_end)
                FF34              .org    executeAction_end
  272                     
  273  34:FF34            executeAction_handlers: ;$9fac: //function table
  274  34:FF34  A8 9F             .dw     command_none            ;$9fa8
  275  34:FF36  8A A6             .dw command_01                  ;$a68a
  276  34:FF38  3D A8             .dw command_forward             ;$a7df
  277  34:FF3A  3D A8             .dw command_back                ;$a7ea
  278  34:FF3C  04 A1             .dw command_fight               ;$a104
  279  34:FF3E  6F A8             .dw command_guard               ;$a881
  280  34:FF40  86 A8             .dw command_escape              ;$a8bf
  281  34:FF42  10 A9             .dw command_sneakAway   ;$a93b
  282  34:FF44  3B A9             .dw command_jump                ;$a9d8
  283  34:FF46  5F A9             .dw command_land                ;$aa11
  284  34:FF48  A8 9F             .dw command_none                ;$9fa8
  285  34:FF4A  70 A9             .dw command_geomance    ;$aa5d
  286  34:FF4C  51 AA             .dw command_inspect             ;$ab73
  287  34:FF4E  1F AA             .dw command_detect              ;$ab0c
  288  34:FF50  78 AA             .dw command_steal               ;$aba4
  289  34:FF52  0B AB             .dw command_charge              ;$ac6f
  290  34:FF54  55 AB             .dw command_sing                ;$acd5
  291  34:FF56  73 AB             .dw command_intimidate  ;$ad16
  292  34:FF58  B0 AB             .dw command_cheer               ;$ad75
  293  34:FF5A  BB A3             .dw command_item                ;$a3bb
  294  34:FF5C  67 A3             .dw command_magic               ;$a367
  295                             ;extension to original
  296  34:FF5E  00 00             .dw 0   ;dummy
  297  34:FF60  18 B6             .dw cmdx_provoke
  298  34:FF62  E8 B6             .dw cmdx_disorderedShot
  299  34:FF64  B6 B8             .dw cmdx_abyss
  300  34:FF66  EB B8             .dw cmdx_raid
  301  34:FF68            executeAction_free_begin:
  302                     ;$9f7b
  303                     ;======================================================================================================
  304                     ;$34:9f7b setActorCommandIdAndClearMode
  305                     
  306                     ;$34:9f87 setActionTargetToSelf //setActionTargetBitAndFlags
  307                     
  308                     ;$34:9fa8 handleCommand00_0a //do nothing
  309                     ;======================================================================================================
  310                             INIT_PATCH $34,$9fa6,$a000
                0034              .bank   $34
                FFA6              .org    $9fa6
       34:FFA6                    .ds             (($a000) - ($9fa6))
                FFA6              .org    $9fa6
  311                     ;------------------------------------------------------------------------------------------------------
  312  34:FFA6            setXtoTargetIndex:
  313           0070      .pTarget = $70
  314  34:FFA6  A0 2C             ldy #$2c
  315  34:FFA8  B1 70             lda [.pTarget],y
  316  34:FFAA  4C B0 9F          jmp maskToIndex
  317                     ;       and #$07
  318                     ;       tax
  319                     ;       rts
  320                     
  321  34:FFAD            setXtoActorIndex:
  322  34:FFAD  20 2E A4          jsr getActor2C
  323  34:FFB0            maskToIndex:
  324  34:FFB0  29 07             and #7
  325  34:FFB2  AA                tax
  326  34:FFB3  60                rts
  327                     
  328  34:FFB4            setXtoActorIndex16:
  329  34:FFB4  20 AD 9F          jsr setXtoActorIndex
  330  34:FFB7  0A                asl a
  331  34:FFB8  AA                tax
  332  34:FFB9  60                rts
  333                     
  334  34:FFBA            flagSingleTarget:
  335                     ;[in] x = targetIndex
  336  34:FFBA  A9 00             lda #0
  337  34:FFBC  4C 20 FD          jmp flagTargetBit
  338                     
  339  34:FFBF            addBattleMessage:
  340                     ;[in] a : msg
  341                     ;[in,out] x : count
  342  34:FFBF  AE EE 78          ldx battleMessageCount
  343  34:FFC2  9D DA 78          sta battleMessages,x
  344  34:FFC5  E8                inx
  345  34:FFC6  8E EE 78          stx battleMessageCount
  346                             ;inc battleMessageCount
  347  34:FFC9  60                rts
  348                     
  349  34:FFCA            swapDamages:
  350  34:FFCA  A2 0F             ldx #$0f
  351  34:FFCC            .swap:
  352  34:FFCC  BD 4F 7E                  lda play_damages,x
  353  34:FFCF  48                        pha
  354  34:FFD0  BD 5F 7E                  lda play_damages+$10,x
  355  34:FFD3  9D 4F 7E                  sta play_damages,x
  356  34:FFD6  68                        pla
  357  34:FFD7  9D 5F 7E                  sta play_damages+$10,x
  358  34:FFDA  CA                        dex
  359  34:FFDB  10 EF                     bpl .swap
  360  34:FFDD  60                rts
  361                     
  362  34:FFDE            swapHitCounts:
  363           00BB      .hitCount = $bb
  364           9900      .temp = TEMP_RAM
  365  34:FFDE  A2 01             ldx #1
  366  34:FFE0            .save:
  367  34:FFE0  B4 BB                     ldy <.hitCount,x
  368  34:FFE2  BD 00 79                  lda .temp,x
  369  34:FFE5  95 BB                     sta <.hitCount,x
  370  34:FFE7  98                        tya
  371  34:FFE8  9D 00 79                  sta .temp,x
  372  34:FFEB  CA                        dex
  373  34:FFEC  10 F2                     bpl .save
  374  34:FFEE  60                rts
  375                     
  376                     ;workaround for doFight behavior
  377  34:FFEF            initAllDamages:
  378  34:FFEF  A2 E0             ldx #$e0
  379  34:FFF1  D0 02             bne initDamage
  380  34:FFF3            initActorDamages:
  381  34:FFF3  A2 F0             ldx #$f0
  382                             ;fall through
  383  34:FFF5            initDamage:
  384  34:FFF5  A9 FF             lda #$ff
  385  34:FFF7            .fill:
  386  34:FFF7  9D 6F 7D                  sta play_damages+$10-$f0,x
  387  34:FFFA  E8                        inx
  388  34:FFFB  D0 FA                     bne .fill
  389  34:FFFD  60                rts
  390                     ;------------------------------------------------------------------------------------------------------
  391                             INIT_PATCH $35,$a000,$a104
                0035              .bank   $35
                0000              .org    $a000
       35:0000                    .ds             (($a104) - ($a000))
                0000              .org    $a000
  392                     
  393  35:0000            executeAction_summon:
  394           0018      .magicParamsCache = $18
  395                     ;.actionId = $26
  396                     ;.targetBit = $27
  397                     ;.targetFlag = $28
  398           0030      .summonType = $30
  399           0052      .iPlayer = $52
  400           006E      .pActor = $6e
  401                     
  402  35:0000  A2 3F             ldx #$3f
  403  35:0002  A9 00             lda #0
  404  35:0004  8D 93 7E          sta $7e93
  405  35:0007            .init_char_struct:
  406  35:0007  9D 75 78                  sta $7875,x
  407  35:000A  CA                        dex
  408  35:000B  10 FA                     bpl .init_char_struct
  409  35:000D  A9 02             lda #2
  410  35:000F  85 30             sta <.summonType
  411                     ;original checks job == #13 || #14
  412  35:0011  A0 3C             ldy #EXTRA_ABILITY_OFFSET
  413  35:0013  B1 6E             lda [.pActor],y
  414  35:0015  29 10             and #PASSIVE_SUMMON_FUSION
  415  35:0017  D0 0D             bne .summon_fusion
  416                     ;$9ffc:
  417  35:0019  A9 63                     lda #99
  418  35:001B  20 64 A5                  jsr getSys1Random       ;a564
  419  35:001E  C9 32                     cmp #50
  420  35:0020  B0 02                     bcs .summon_black
  421  35:0022  C6 30                             dec <.summonType
  422  35:0024                    .summon_black:
  423  35:0024  C6 30                     dec <.summonType
  424  35:0026            .summon_fusion:
  425                     ;$a009:
  426                             ;.bank $35
  427                             
  428                             ;jsr getActor2C
  429                             ;and #7
  430                             ;sta <.iPlayer
  431                             ;tax
  432  35:0026  20 AD 9F          jsr setXtoActorIndex
  433  35:0029  BD C7 7A          lda selectedMagicLv,x
  434  35:002C  48                pha
  435                             
  436  35:002D  20 3E FD          jsr $fd3e       ;a<<=4
  437  35:0030  05 30             ora <.summonType
  438  35:0032  8D 94 7E          sta $7e94
  439                     
  440                     ;       INIT16 <.pActor,$7875
  441                     ;       setYtoOffsetOf(a = #0f);        //$9b88
  442  35:0035  A0 0F             ldy #$0f
  443  35:0037  A2 02             ldx #2
  444  35:0039            .load_params:
  445  35:0039  B1 6E                     lda [.pActor],y
  446  35:003B  0A                        asl a
  447  35:003C  95 18                     sta <.magicParamsCache,x
  448  35:003E  C8                        iny
  449  35:003F  CA                        dex
  450  35:0040  10 F7                     bpl .load_params
  451                     
  452  35:0042  A0 01             ldy #1
  453  35:0044  B1 6E             lda [.pActor],y
  454  35:0046  29 30             and #$30        ;toad|sealed
  455  35:0048  48                pha
  456                             
  457                             INIT16 <.pActor,$7875
       35:0049  A9 75             lda #LOW($7875)
       35:004B  85 6E             sta <.pActor
       35:004D  A9 78             lda #HIGH($7875)
       35:004F  85 6F             sta <.pActor+1
  458                     
  459  35:0051  68                pla
  460  35:0052  91 6E             sta [.pActor],y
  461                             ;
  462  35:0054  88                dey
  463  35:0055  A5 1A             lda <.magicParamsCache+2        ;joblv
  464  35:0057  91 6E             sta [.pActor],y
  465                     
  466  35:0059  A0 0F             ldy #$0f
  467  35:005B  A2 02             ldx #2
  468  35:005D            .store_params:
  469  35:005D  B5 18                     lda <.magicParamsCache,x
  470  35:005F  91 6E                     sta [.pActor],y
  471  35:0061  C8                        iny
  472  35:0062  CA                        dex
  473  35:0063  10 F8                     bpl .store_params
  474  35:0065  A0 03             ldy #3
  475  35:0067  98                tya
  476  35:0068  91 6E             sta [.pActor],y ;hp
  477                             
  478  35:006A  AE C2 7A          ldx $7ac2
  479  35:006D  A9 88             lda #$88
  480  35:006F  9D CB 7A          sta $7acb,x
  481                     
  482                             ;$6e[y] = getActor2C() | #90;
  483  35:0072  A0 2C             ldy #$2c
  484  35:0074  A9 90             lda #$90
  485  35:0076  91 6E             sta [.pActor],y
  486                     ;$a065:
  487  35:0078  68                pla     ;selectedMagicLv
  488  35:0079  85 18             sta <$18
  489  35:007B  0A                asl a
  490  35:007C  18                clc
  491  35:007D  65 18             adc <$18
  492  35:007F  65 30             adc <.summonType
  493  35:0081  AA                tax     ; a = selectedMagicLv*3 + summonType
  494                     
  495  35:0082  18                clc
  496  35:0083  69 78             adc #$78
  497  35:0085  8D DA 78          sta battleMessages
  498                             
  499  35:0088  8A                txa
  500  35:0089  18                clc
  501  35:008A  69 21             adc #$21
  502  35:008C  8D D9 78          sta effectMessage
  503                     
  504  35:008F  8A                txa
  505  35:0090  69 5B             adc #$5b
  506  35:0092  85 18             sta <$18
  507  35:0094  48                pha     ;sta <.actionId
  508                             
  509  35:0095  A9 08             lda #8
  510  35:0097  85 1A             sta <$1a
  511                             INIT16 <$20,$98c0
       35:0099  A9 C0             lda #LOW($98c0)
       35:009B  85 20             sta <$20
       35:009D  A9 98             lda #HIGH($98c0)
       35:009F  85 21             sta <$20+1
  512  35:00A1  A2 00             ldx #0
  513  35:00A3  20 3A BA          jsr loadTo7400FromBank30        ;$ba3a
  514                             
  515           4400      .actionParams = $7400
  516                             
  517  35:00A6  2C 05 74          bit .actionParams+5
  518  35:00A9  10 07             bpl .target_enemy
  519  35:00AB  A9 F0                     lda #$f0
  520  35:00AD  48                        pha
  521  35:00AE  A9 40                     lda #$40
  522  35:00B0  D0 11                     bne .store_action_params
  523  35:00B2            .target_enemy:
  524  35:00B2  50 07                     bvc .target_single
  525  35:00B4  A9 FF                             lda #$ff
  526  35:00B6  48                                pha
  527  35:00B7                    .target_all:
  528  35:00B7  A9 C0                             lda #$c0
  529  35:00B9  D0 08                             bne .store_action_params
  530  35:00BB                    .target_single:
  531                             
  532           0062      .targetBit = $62
  533                     
  534  35:00BB  20 DA A0                          jsr invokePickRandomTarget
  535  35:00BE  A5 62                             lda <.targetBit
  536  35:00C0  48                                pha
  537  35:00C1  A9 80                             lda #$80
  538  35:00C3            .store_action_params:
  539  35:00C3  A0 30             ldy #$30
  540  35:00C5  91 6E             sta [.pActor],y ;target flag
  541  35:00C7  88                dey
  542  35:00C8  68                pla
  543  35:00C9  91 6E             sta [.pActor],y ;target bit
  544  35:00CB  88                dey
  545  35:00CC  68                pla
  546  35:00CD  91 6E             sta [.pActor],y ;action id
  547                     
  548                             INIT16 <$5d,$7675
       35:00CF  A9 75             lda #LOW($7675)
       35:00D1  85 5D             sta <$5d
       35:00D3  A9 76             lda #HIGH($7675)
       35:00D5  85 5E             sta <$5d+1
  549                     ;$a0ea:
  550  35:00D7  4C E4 9D          jmp executeAction
  551                             ;jmp $9de4      ;executeAction
  552                     ;------------------------------------------------------------------------------------------------------
  553  35:00DA            invokePickRandomTarget:
  554           004C      .battleFunctionId = $4c
  555  35:00DA  A9 0A             lda #BF_PICK_RANDOM_TARGET
  556  35:00DC  85 4C             sta <.battleFunctionId
  557  35:00DE  4C F3 FD          jmp invoke_b30_battleFunction
  558                     ;$a104:
  559                     
  560                     ;======================================================================================================
  561                             RESTORE_PC ff3_executeAction_begin
                0000              .bank   BANK(ff3_executeAction_begin)
                0000              .org    ff3_executeAction_begin
#[2]   ff3_hack_master.asm
   41                                     
#[3]   ff3_command_window.asm
   42                                     .include "ff3_command_window.asm"
    1                     ; ff3_command_window.asm
    2                     ;
    3                     ;description:
    4                     ;       command window related codes
    5                     ;       implements 'extra ability' feature ready mechanism
    6                     ;
    7                     ;version:
    8                     ;       0.14 (2006-11-01)
    9                     ;======================================================================================================
   10  00:0000            ff3_commandWindow_begin:
   11                             INIT_PATCH $34,$986c,$99fd
                0034              .bank   $34
                886C              .org    $986c
       34:886C                    .ds             (($99fd) - ($986c))
                886C              .org    $986c
   12                     
   13           0001              .ifdef BETA
   14                     RET_TO_GET_COMMAND_INPUT        .macro
   15                             rts
   16                             .endm
   17                             
   18                             .else
   23                             .endif  ;beta
   24                     
   25           0001              .ifdef BETA
   26  34:886C            getPlayerCommandInput:
   27           0052      .iPlayer = $52
   28           0055      .cursorId = $55
   29           005B      .pPlayer = $5b
   30           005F      .playerOffset = $5f
   31           88BA      .beginningMode = $78ba  ;08:backattack 01:escapable? 80:enemy surprise attack
   32           88CF      .selectedCommands = $78cf       ;[4]
   33           EED8      .battleMode = $7ed8
   34                     ;-------------------------------------
   35  34:886C  20 9E 9D          jsr drawEnemyNamesWindow        ;9d9e
   36  34:886F            .input_next:    
   37  34:886F  A6 52             ldx <.iPlayer
   38  34:8871  E0 04             cpx #4
   39  34:8873  F0 28             beq .drawHpWindow
   40  34:8875  AD E1 7B                  lda $7be1
   41  34:8878  20 2C FD                  jsr clearTargetBit      ;$fd2c
   42  34:887B  8D E1 7B                  sta $7be1
   43  34:887E  20 41 A5                  jsr getPlayerOffset
   44  34:8881  A8                        tay
   45  34:8882  C8                        iny
   46  34:8883  C8                        iny
   47  34:8884  B1 5B                     lda [.pPlayer],y
   48  34:8886  4A                        lsr a
   49  34:8887  90 0A                     bcc .not_jumping
   50  34:8889  20 94 9B                          jsr setYtoOffset2F
   51  34:888C  B1 5B                             lda [.pPlayer],y
   52  34:888E  9D 0F 7E                          sta $7e0f,x
   53  34:8891  D0 0A                             bne .drawHpWindow
   54  34:8893                    .not_jumping:
   55  34:8893  A9 FF                     lda #$ff
   56  34:8895  9D CF 78                  sta .selectedCommands,x
   57  34:8898  A9 00                     lda #0
   58  34:889A  9D 0F 7E                  sta $7e0f,x
   59  34:889D            .drawHpWindow:
   60  34:889D  20 A2 9B          jsr drawInfoWindow      ;9ba2
   61  34:88A0  20 33 A4          jsr $a433       ;endCommandInputIfDone
   62  34:88A3  20 41 A5          jsr getPlayerOffset     ;a541
   63  34:88A6  A6 52             ldx <.iPlayer
   64  34:88A8  BD E4 7C          lda $7ce4,x
   65  34:88AB  F0 0E             beq .check_status0
   66  34:88AD  48                        pha
   67  34:88AE  A9 23                     lda #$23
   68  34:88B0  20 88 9B                  jsr setYtoOffsetOf
   69  34:88B3  68                        pla
   70  34:88B4  91 5B                     sta [.pPlayer],y
   71  34:88B6  A9 00                     lda #0
   72  34:88B8  9D E4 7C                  sta $7ce4,x
   73  34:88BB            .check_status0: ;98bd
   74  34:88BB  A4 5F             ldy <.playerOffset
   75  34:88BD  C8                iny
   76  34:88BE  B1 5B             lda [.pPlayer],y
   77  34:88C0  29 C0             and #$c0        ;dead|stone
   78  34:88C2  F0 08             beq .check_status1
   79  34:88C4  E6 52                     inc <.iPlayer
   80  34:88C6  EE EB 7C                  inc $7ceb
   81  34:88C9  4C 6F 98                  jmp .input_next
   82  34:88CC            .check_status1: ;98ce
   83  34:88CC  C8                iny
   84  34:88CD  B1 5B             lda [.pPlayer],y
   85  34:88CF  4A                lsr a
   86  34:88D0  29 70             and #$70        ; (paralyze | sleep | confuse) >> 1
   87  34:88D2  F0 03             beq .check_jumping
   88  34:88D4  4C 6C A6                  jmp $a66c
   89  34:88D7            .check_jumping: ;98d8
   90  34:88D7  90 04             bcc .create_commandWindow
   91  34:88D9  E6 52                     inc <.iPlayer
   92  34:88DB  D0 92                     bne .input_next
   93  34:88DD            .create_commandWindow:  ;$98e3
   94  34:88DD  20 69 9A          jsr createCommandWindow ; $9a69
   95  34:88E0  20 9B 9B          jsr setYtoOffset2E      ;$9b9b
   96  34:88E3  A9 00             lda #0
   97  34:88E5  A2 03             ldx #3
   98  34:88E7            .init_action_params:
   99  34:88E7  91 5B             sta [.pPlayer],y
  100  34:88E9  C8                iny
  101  34:88EA  CA                dex
  102  34:88EB  D0 FA             bne .init_action_params
  103                             
  104  34:88ED  A9 2C             lda #$2c
  105  34:88EF  20 88 9B          jsr setYtoOffsetOf
  106  34:88F2  B1 5B             lda [.pPlayer],y
  107  34:88F4  29 F7             and #$f7
  108  34:88F6  91 5B             sta [.pPlayer],y
  109  34:88F8  98                tya
  110  34:88F9  18                clc
  111  34:88FA  69 13             adc #$13
  112  34:88FC  A8                tay
  113  34:88FD  B1 5B             lda [.pPlayer],y        ;y:+3f
  114  34:88FF  F0 03             beq .check_redraw_enemy_names
  115  34:9901  20 E7 9A                  jsr putCanceledItem     ;$9ae7
  116  34:9904            .check_redraw_enemy_names:
  117  34:9904  AD F3 7C          lda $7cf3
  118  34:9907  D0 25             bne .move_character
  119                                     ;1st phase
  120  34:9909  20 9E 9D                  jsr drawEnemyNamesWindow        ;9d9e
  121  34:990C  A9 00                     lda #0
  122  34:990E  20 0E FA                  jsr call_2e_9d53
  123  34:9911  AD D8 7E                  lda .battleMode
  124  34:9914  29 20                     and #$20
  125  34:9916  F0 06                     beq .check_surprise_attack
  126  34:9918  20 0B A5                          jsr $a50b
  127  34:991B  4C 6C 98                          jmp getPlayerCommandInput
  128  34:991E                    .check_surprise_attack:
  129  34:991E  AD BA 78                  lda .beginningMode ;$78ba
  130  34:9921  10 01                     bpl .wait_any_button
  131  34:9923  60                                rts
  132  34:9924                    .wait_any_button:
  133  34:9924  20 AA FB                          jsr getPad1Input
  134  34:9927  A5 12                             lda <inputBits
  135  34:9929  F0 F9                             beq .wait_any_button
  136  34:992B  20 69 9A                  jsr createCommandWindow
  137  34:992E            .move_character:        ;9940
  138  34:992E  A9 02             lda #2
  139  34:9930  20 0E FA          jsr call_2e_9d53        ;fa0e
  140  34:9933  A5 52             lda <.iPlayer
  141  34:9935  85 53             sta <$53
  142  34:9937  A9 00             lda #0
  143  34:9939  85 55             sta <.cursorId
  144  34:993B  85 24             sta <$24
  145  34:993D  85 25             sta <$25
  146  34:993F  85 1A             sta <$1a
  147  34:9941  20 66 89          jsr loadCursor  ;8966
  148                     
  149  34:9944            .input_wait:;9958
  150  34:9944  A0 03             ldy #3  ;to keep input accepted in 3 frames interval 
  151  34:9946            .wait_loop:     
  152  34:9946  20 80 FB                  jsr waitNmi
  153  34:9949  88                        dey
  154  34:994A  D0 FA                     bne .wait_loop
  155  34:994C  A9 00             lda #0
  156  34:994E  85 1B             sta <$1b
  157  34:9950  A9 03             lda #3
  158  34:9952  85 46             sta <$46        
  159                     
  160  34:9954  20 9E 89          jsr getInputAndUpdateCursorWithSound    ;899e
  161           0050      .inputCopy = $50
  162                     ;.invert = $18
  163           0023      .row = $23
  164                     
  165  34:9957  A9 01             lda #1
  166  34:9959  24 50             bit <.inputCopy
  167  34:995B  D0 42             bne .OnA
  168  34:995D  A9 02             lda #2
  169  34:995F  24 50             bit <.inputCopy
  170  34:9961  D0 10             bne .OnB
  171  34:9963  70 19             bvs .OnLeft
  172  34:9965  10 DD             bpl .input_wait
  173  34:9967            .OnRight:
  174  34:9967  A0 00                     ldy #0
  175  34:9969  A6 25                     ldx <$25
  176  34:996B  D0 1E                     bne .change_position
  177  34:996D  84 24                             sty <$24
  178  34:996F  E6 25                             inc <$25
  179  34:9971  10 D1                             bpl .input_wait
  180  34:9973            .OnB:
  181  34:9973  A5 52             lda <.iPlayer
  182  34:9975  F0 03             beq .back_input_char
  183  34:9977  20 42 9A                  jsr $9a42
  184  34:997A            .back_input_char:
  185  34:997A  A9 01             lda #1
  186  34:997C  D0 4C             bne .go_next_char
  187                             ;jmp getCommandInput_next
  188  34:997E            .OnLeft:
  189  34:997E  A0 01                     ldy #1
  190  34:9980  A6 24                     ldx <$24
  191  34:9982  D0 07                     bne .change_position
  192  34:9984  84 24                             sty <$24
  193  34:9986  88                                dey
  194  34:9987  84 25                             sty <$25
  195  34:9989  F0 B9                             beq .input_wait
  196  34:998B                    .change_position:
  197  34:998B  A9 08                     lda #8
  198  34:998D  2C BA 78                  bit $78ba       ;backattack flag
  199  34:9990  F0 04                     beq .back
  200  34:9992  A9 04                             lda #4
  201  34:9994  D0 02                             bne .store_command
  202  34:9996                    .back:
  203  34:9996  A9 05                             lda #5
  204  34:9998                    .store_command:
  205  34:9998  85 23                     sta <.row
  206  34:999A  98                        tya
  207  34:999B  45 23                     eor <.row
  208  34:999D  85 23                     sta <.row
  209  34:999F            .OnA:   ;99c6
  210  34:999F  20 7D 9B          jsr requestSoundEffect05        ;9b7d
  211                             ;v0.6.2 fix
  212                             ;lda #0
  213                             ;sta <$18
  214                             ;<--
  215                             ;jsr clearSprites2x2            ;8adf
  216  34:99A2  20 E3 99          jsr clearCursor0
  217                             
  218  34:99A5  A6 23             ldx <.row
  219  34:99A7  BD 00 74          lda $7400,x
  220  34:99AA  48                pha
  221  34:99AB  A6 52             ldx <.iPlayer
  222  34:99AD  9D CF 78          sta .selectedCommands,x
  223  34:99B0  A5 23             lda <.row
  224  34:99B2  9D C3 7A          sta $7ac3,x
  225  34:99B5  68                pla             ;commandId
  226                             ;v0.6.3 --->
  227  34:99B6  AA                tax
  228                             ;<---
  229  34:99B7  0A                asl a
  230  34:99B8  18                clc
  231  34:99B9  69 EA             adc #LOW(commandWindow_handlers)
  232  34:99BB  85 19             sta <$19
  233  34:99BD  A9 00             lda #0
  234  34:99BF  69 99             adc #HIGH(commandWindow_handlers)
  235  34:99C1  85 1A             sta <$1a
  236  34:99C3  A9 6C             lda #$6c        ;jmp (addr)
  237  34:99C5  85 18             sta <$18
  238                     ;99c7:
  239  34:99C7  20 18 00          jsr $0018       ;invoke commandWindowHandler (x = handlerIndex = commandId)
  240                     ;$99fd
  241                     ;getCommandInput_next:
  242  34:99CA            .go_next_char:
  243  34:99CA  48                pha
  244  34:99CB  A5 52             lda <.iPlayer
  245  34:99CD  48                pha
  246  34:99CE  A5 53             lda <$53
  247  34:99D0  85 52             sta <.iPlayer
  248  34:99D2  A9 01             lda #1
  249  34:99D4  20 0E FA          jsr call_2e_9d53
  250  34:99D7  68                pla
  251  34:99D8  85 52             sta <.iPlayer
  252  34:99DA  68                pla
  253  34:99DB  F0 03             beq .redraw
  254  34:99DD  4C 6F 98                  jmp getPlayerCommandInput+3     ;986f
  255  34:99E0            .redraw:
  256  34:99E0  4C 6C 98          jmp getPlayerCommandInput       ;986c
  257  34:99E3            clearCursor0:
  258                             ;v0.6.2 fix
  259  34:99E3  A9 00             lda #0
  260  34:99E5  85 18             sta <$18
  261                             ;<--
  262  34:99E7  4C DF 8A          jmp clearSprites2x2             ;8adf
  263                     ;$9a16
  264                     ;=======================================================================================================
  265                     ;original addresses
  266                     ;commandWindow_nop      = $9a68
  267                     ;01
  268                     ;commandWindow_OnForward        = $a71c
  269                     ;commandWindow_OnBack   = $a750
  270                     ;commandWindow_OnFight  = $a843
  271                     ;commandWindow_OnGuard  = $a877
  272                     ;commandWindow_OnEscape = $a8ab
  273                     ;commandWindow_OnSneakAway      = $a8b5
  274                     ;commandWindow_OnJump   = $a9ab
  275                     ;09
  276                     ;commandWindow_OnA      ;hacked
  277                     ;commandWindow_OnGeomance       = $aa22
  278                     ;commandWindow_OnInspect                = $ab6e
  279                     ;commandWindow_OnDetect         = $ab07
  280                     ;commandWindow_OnSteal          = $ab9f
  281                     ;commandWindow_OnCharge         = $ac65
  282                     ;commandWindow_OnSing           = $acd0
  283                     ;commandWindow_OnIntimidate     = $ad0c
  284                     ;commandWindow_OnCheer          = $ad6b
  285                     ;13
  286                     ;commandWindow_OnItem   = $adaf ;14
  287                     ;commandWindow_OnMagic  = $b646 ;15
  288                     ;------------------------------------------------------------------------------------------------------
  289                     ;       .org $9a16
  290                             ALIGN_EVEN
       34:99EA                    .check_align_00047:
                0000              .if (.check_align_00047 & 1) != 0
                                  .endif
  291                     
  292  34:99EA            commandWindow_handlers:
  293  34:99EA  B3 A7             .dw     commandWindow_nop       ;$9a68
  294  34:99EC  B3 A7             .dw     commandWindow_nop       ;$9a68
  295  34:99EE  45 A7             .dw commandWindow_OnForward     ;$a71c
  296  34:99F0  57 A7             .dw commandWindow_OnBack        ;$a750
  297  34:99F2  C1 A7             .dw commandWindow_OnFight       ;$a843
  298  34:99F4  D7 A7             .dw commandWindow_OnGuard       ;$a877
  299  34:99F6  E2 A7             .dw commandWindow_OnEscape      ;$a8ab
  300  34:99F8  E2 A7             .dw commandWindow_OnSneakAway   ;$a8b5
  301  34:99FA  EA A7             .dw commandWindow_OnJump        ;$a9ab
  302  34:99FC  B3 A7             .dw commandWindow_nop   ;$9a68
  303  34:99FE  B3 A7             .dw commandWindow_nop   ;$9a68
  304  34:AA00  F9 A7             .dw commandWindow_OnGeomance    ;$aa22
  305  34:AA02  C1 A7             .dw commandWindow_OnInspect             ;$ab6e
  306  34:AA04  C1 A7             .dw commandWindow_OnDetect              ;$ab07
  307  34:AA06  C1 A7             .dw commandWindow_OnSteal               ;$ab9f
  308  34:AA08  D7 A7             .dw commandWindow_OnCharge              ;$ac65
  309  34:AA0A  C1 A7             .dw commandWindow_OnSing                ;$acd0
  310  34:AA0C  D7 A7             .dw commandWindow_OnIntimidate  ;$ad0c
  311  34:AA0E  D7 A7             .dw commandWindow_OnCheer               ;$ad6b
  312  34:AA10  B3 A7             .dw commandWindow_nop           ;$9a68
  313  34:AA12  D5 AB             .dw commandWindow_OnItem        ;$adaf
  314  34:AA14  C3 B2             .dw commandWindow_OnMagic       ;$b646
  315                             ;extra
  316                             ;容量以外に制限無し
  317  34:AA16  B6 A7             .dw commandWindow_OnProvoke     ;extra
  318  34:AA18  D7 A7             .dw commandWindow_OnDisorderedShot      ;extra
  319  34:AA1A  B6 A7             .dw commandWindow_OnAbyss       ;abyss
  320  34:AA1C  C1 A7             .dw commandWindow_OnRaid
  321                     ;$9a40
  322                     ;=======================================================================================================
  323  34:AA1E            getCommandInput_end:
  324           AA40      getCommandInput_free_end = $9a40
  325                     ;=======================================================================================================
  326                             INIT_PATCH $34,$9a69,$9ae7
                0034              .bank   $34
                AA69              .org    $9a69
       34:AA69                    .ds             (($9ae7) - ($9a69))
                AA69              .org    $9a69
  327  34:AA69            createCommandWindow:
  328                     ;[in]
  329           0006      .width = COMMAND_WINDOW_WIDTH   ;original:5
  330           0057      .pPlayerBaseParam = $57
  331           005F      .playerOffset = $5f
  332           88BA      .beginningMode = $78ba
  333           BB21      .jobCommandList = $9b21
  334                     ;[out]
  335           0038      .emptyCount = $38
  336           4400      .commandIdList = $7400
  337                     ;---------------------------------------------------
  338  34:AA69  A2 02             ldx #2
  339  34:AA6B  8E 04 74          stx .commandIdList+4
  340  34:AA6E  E8                inx
  341  34:AA6F  8E 05 74          stx .commandIdList+5
  342  34:AA72  A4 5F             ldy <.playerOffset
  343  34:AA74  B1 57             lda [.pPlayerBaseParam],y
  344  34:AA76  0A                asl a
  345  34:AA77  0A                asl a
  346  34:AA78  A8                tay
  347  34:AA79  A2 FC             ldx #$fc
  348  34:AA7B            .load_loop:
  349  34:AA7B  B9 21 9B                  lda .jobCommandList,y
  350  34:AA7E  9D 04 73                  sta .commandIdList - $fc,x
  351  34:AA81  C8                        iny
  352  34:AA82  E8                        inx
  353  34:AA83  D0 F6                     bne .load_loop
  354  34:AA85  20 54 97          jsr initTileArrayStorage
  355                     ;.counter = $2d
  356  34:AA88  86 38             stx <.emptyCount
  357                             ;stx <.counter
  358  34:AA8A  A9 FC             lda #$fc
  359  34:AA8C            .create_tiles:
  360  34:AA8C  48                        pha
  361  34:AA8D  A2 06                     ldx #.width
  362  34:AA8F  20 49 A5                  jsr initString
  363  34:AA92  68                        pla
  364  34:AA93  AA                        tax
  365  34:AA94  BD 04 73                  lda .commandIdList - $fc,x
  366  34:AA97  E8                        inx
  367                                     ;cmp #$ff
  368                                     ;bne .load_command_name
  369                                     ;       inc <.emptyCount
  370                                     ;       lda #0
  371  34:AA98                    .load_command_name:
  372                             
  373  34:AA98  A8                        tay
  374  34:AA99  8A                        txa
  375  34:AA9A  48                        pha
  376                                     INIT16 <$18,$8c40
       34:AA9B  A9 40             lda #LOW($8c40)
       34:AA9D  85 18             sta <$18
       34:AA9F  A9 8C             lda #HIGH($8c40)
       34:AAA1  85 19             sta <$18+1
  377  34:AAA3  98                        tya
  378           0001              .ifdef ENABLE_EXTRA_ABILITY
  379  34:AAA4  20 B0 9C                  jsr getExtraAbilityNameId
  380                             .endif
  381  34:AAA7  A2 01                     ldx #1
  382  34:AAA9  20 09 A6                  jsr loadString
  383  34:AAAC  A2 06                     ldx #.width
  384  34:AAAE  86 18                     stx <$18
  385  34:AAB0  20 6A 96                  jsr strToTileArray
  386  34:AAB3  A9 06                     lda #.width
  387  34:AAB5  20 58 A5                  jsr offsetTilePtr
  388                     
  389  34:AAB8  68                        pla     ;counter
  390  34:AAB9  D0 D1                     bne .create_tiles
  391  34:AABB  A9 03             lda #($0a - (.width + 1))
  392  34:AABD  85 18             sta <$18
  393  34:AABF  A9 0A             lda #$0a
  394  34:AAC1  85 19             sta <$19
  395  34:AAC3  A9 03             lda #3
  396  34:AAC5  85 1A             sta <$1a
  397  34:AAC7  4C 38 8B          jmp draw8LineWindow
  398                     ;$9ae7:
  399                             .endif ;beta
  400                     ;------------------------------------------------------------------------------------------------------
  401                             ;FILEORG        $68b00
  402           BB00              .org    $8b00
  403  34:BB00            commandWindow_cursorPos:
  404           0020      .cursorX = ($50 - ($08 * COMMAND_WINDOW_WIDTH))
  405  34:BB00  A8 20                     .db     $a8, .cursorX
  406  34:BB02  B8 20                     .db     $b8, .cursorX
  407  34:BB04  C8 20                     .db     $c8, .cursorX
  408  34:BB06  D8 20                     .db     $d8, .cursorX
  409                             RESTORE_PC ff3_commandWindow_begin
                0000              .bank   BANK(ff3_commandWindow_begin)
                0000              .org    ff3_commandWindow_begin
#[2]   ff3_hack_master.asm
   43                     
#[3]   ff3_commands.asm
   44                                     .include "ff3_commands.asm"     ;saving a lot
    1                     ; ff3_commands.asm
    2                     ;
    3                     ; description:
    4                     ;       replaces command handlers
    5                     ;
    6                     ; version:
    7                     ;       0.08 (2006-11-12)
    8                     ;
    9                     ; note:
   10                     ;       'ff3_executeAction.asm' and 'ff3_command_window.asm' must be included before this file
   11                     ;======================================================================================================
   12  00:0000            ff3_commands_begin:
   13                     
   14                             INIT_PATCH $35,$a71c,$adaf
                0035              .bank   $35
                771C              .org    $a71c
       35:771C                    .ds             (($adaf) - ($a71c))
                771C              .org    $a71c
   15                             ;INIT_PATCH $35,$a71c,$a7df
   16                             
   17                     DECLARE_COMMAND_VARS    .macro
   18                     .iPlayer = $52
   19                     .pBaseParam = $57
   20                     .pEquips = $59
   21                     .pBattleParam = $5b
   22                     .pTargetBase = $5d
   23                     .offset = $5f
   24                             .endm
   25                     
   26                     DECLARE_BATTLE_PTR      .macro
   27                     .pActor = $6e
   28                     .pTareget = $70
   29                             .endm
   30                     ;======================================================================================================
   31  35:771C            selectSingleTargetAndSetYto2F:
   32                     ;out a : targetbit
   33                     ;out y : #2f
   34           00B3      .targetMode = $b3
   35           00B4      .selectedTarget = $b4
   36  35:771C  A9 00             lda #0 ;single sel
   37  35:771E  85 B3             sta <.targetMode
   38  35:7720  A9 10             lda #$10        ;select target
   39  35:7722  20 0E FA          jsr call_2e_9d53
   40  35:7725  20 94 9B          jsr setYtoOffset2F
   41  35:7728  A5 B4             lda <.selectedTarget
   42  35:772A  60                rts
   43                     
   44  35:772B            getPlayerLine:
   45           0059      .pEquips = $59
   46  35:772B  A9 0F             lda #$0f
   47  35:772D  20 88 9B          jsr setYtoOffsetOf
   48  35:7730  B1 59             lda [.pEquips],y
   49  35:7732  4A                lsr a
   50  35:7733  60                rts
   51                     
   52                     ;$35:a7cd initMoveArrowSprite
   53  35:7734            initMoveArrowSprite:
   54           0052      .iPlayer = $52
   55  35:7734  A9 00             lda #0
   56  35:7736  85 18             sta <$18
   57  35:7738  20 DF 8A          jsr clearSprites2x2     ;$8adf
   58  35:773B  A9 5D             lda #$5d        ;arrow
   59  35:773D  8D 21 02          sta $0221       ;sprite.tileIndex
   60  35:7740  A5 52             lda <.iPlayer
   61  35:7742  0A                asl a
   62  35:7743  0A                asl a
   63  35:7744  60                rts
   64                     ;------------------------------------------------------------------------------------------------------
   65                     ;ぜんしん(02)
   66                     ;$35:a71c commandWindow_OnForwardSelected
   67  35:7745            commandWindow_OnForward:
   68                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
   69  35:7745  20 2B A7          jsr getPlayerLine
   70  35:7748  90 66             bcc commandWindow_beepAndCancel
   71  35:774A            .ok:
   72  35:774A  20 34 A7          jsr initMoveArrowSprite
   73  35:774D  AA                tax
   74                     
   75  35:774E  A9 80             lda #$80 ;rightkey
   76  35:7750  48                pha ;sta $18
   77  35:7751  A0 43             ldy #$43 ;sta $0222
   78                     
   79  35:7753  A9 02             lda #$02
   80  35:7755  D0 12             bne commandWindow_setupMove
   81                     ;$a750:
   82                     
   83                     ;command 03
   84                     ;$35:a750 commandWindow_OnBack
   85  35:7757            commandWindow_OnBack:
   86                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
   87                     
   88  35:7757  20 2B A7          jsr getPlayerLine
   89  35:775A  B0 54             bcs commandWindow_beepAndCancel
   90                     
   91  35:775C  20 34 A7          jsr initMoveArrowSprite
   92  35:775F  18                clc
   93  35:7760  69 02             adc #2
   94  35:7762  AA                tax
   95                     
   96  35:7763  A9 40             lda #$40 ;left
   97  35:7765  48                pha
   98  35:7766  A0 03             ldy #$03 ;sta $0222
   99  35:7768  98                tya
  100                     
  101                     ;fall through
  102  35:7769            commandWindow_setupMove:
  103  35:7769  85 19             sta <$19
  104                     
  105  35:776B  BD 1D A8          lda commandWindow_arrowCoords,x
  106  35:776E  8D 20 02          sta $0220       ;y
  107  35:7771  BD 1E A8          lda commandWindow_arrowCoords+1,x
  108  35:7774  8D 23 02          sta $0223       ;x
  109                     
  110                     ;$35:a784 showArrowAndDecideCommand
  111  35:7777            showArrowAndDecide:
  112                     ;[in] y : spriteFlag
  113                     ;[in] sp+0 : cancelKey
  114           88BA      .beginningFlag = $78ba
  115           0018      .cancelKey = $18
  116           0019      .commandId = $19
  117  35:7777  AD BA 78          lda .beginningFlag
  118  35:777A  29 08             and #$08
  119  35:777C  F0 0E             beq .normal
  120                     ;backattack!
  121  35:777E  98                        tya
  122  35:777F  49 40                     eor #$40
  123  35:7781  A8                        tay
  124  35:7782  BD 2E A8                  lda commandWindow_arrowCoords_backattack+1,x
  125  35:7785  8D 23 02                  sta $0223
  126                                     
  127  35:7788  68                        pla ;cancel key
  128  35:7789  49 C0                     eor #%11000000  ;$80 => 40 / 40 => 80
  129  35:778B  48                        pha
  130  35:778C            .normal:
  131  35:778C  8C 22 02          sty $0222
  132  35:778F  68                pla     ;cancel key
  133  35:7790  85 18             sta <.cancelKey
  134  35:7792            .get_input:     ;$a7a4:
  135  35:7792  20 85 81                  jsr presentCharacter
  136  35:7795  20 AA FB                  jsr getPad1Input
  137  35:7798  A5 12                     lda <inputBits
  138  35:779A  F0 F6                     beq .get_input
  139                                     
  140  35:779C  AA                        tax
  141  35:779D  4A                        lsr a
  142  35:779E  B0 09                     bcs .OnA
  143  35:77A0  4A                        lsr a
  144  35:77A1  B0 10                     bcs commandWindow_cancelReturn
  145  35:77A3  E4 18                     cpx <.cancelKey
  146  35:77A5  D0 EB                     bne .get_input
  147  35:77A7  F0 0A                     beq commandWindow_cancelReturn
  148  35:77A9            .OnA:
  149  35:77A9  20 7D 9B          jsr requestSoundEffect05
  150  35:77AC  A6 19             ldx <.commandId
  151  35:77AE  D0 27             bne commandWindow_decideReturn
  152  35:77B0            commandWindow_beepAndCancel:
  153  35:77B0  20 81 9B          jsr requestSoundEffect06
  154  35:77B3            commandWindow_nop:
  155  35:77B3            commandWindow_cancelReturn:
  156  35:77B3  A9 01             lda #1
  157  35:77B5  60                rts
  158  35:77B6            commandWindow_decideToTargetAll:
  159                     ;x = commandId
  160  35:77B6  20 94 9B          jsr setYtoOffset2F
  161  35:77B9  A9 C0             lda #$c0        ;target flag
  162  35:77BB  85 B5             sta <$b5
  163  35:77BD  A9 FF             lda #$ff        ;target bit
  164  35:77BF  D0 0F             bne commandWindow_setTargetAndCommand
  165                     ;------------------------------------------------------------------------------------------------------
  166                     ;//04:たたかう
  167                     ;$35:a843 commandWindow_OnFight
  168                     ;       .org $a843
  169                     ;commandWindow_OnFight:
  170                     ;       lda #$04
  171                     ;       ;fall through
  172  35:77C1            commandWindow_OnFight:
  173  35:77C1            commandWindow_selectSingleTargetAndNext:
  174                     ;[in] u8 x : commandId
  175           00B4      .selectedTarget = $b4
  176  35:77C1  8A                txa
  177  35:77C2  48                pha
  178  35:77C3  20 1C A7          jsr selectSingleTargetAndSetYto2F
  179  35:77C6  D0 04             bne .ok
  180  35:77C8  68                        pla
  181  35:77C9  A9 01                     lda #1
  182  35:77CB  60                        rts
  183  35:77CC            .ok:
  184  35:77CC  68                pla
  185  35:77CD  AA                tax
  186  35:77CE  A5 B4             lda <.selectedTarget
  187                             ;fall through
  188  35:77D0            commandWindow_setTargetAndCommand:
  189                     ;[in] u8 a : targetBit
  190                     ;[in] u8 x : commandId
  191                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
  192           00B5      .targetFlag = $b5
  193  35:77D0  91 5B             sta [.pBattleParam],y   ;2f
  194                                     
  195  35:77D2  C8                iny
  196  35:77D3  A5 B5             lda <.targetFlag
  197  35:77D5  91 5B             sta [.pBattleParam],y   ;30
  198                             ;fall through
  199  35:77D7            commandWindow_decideReturn:
  200                     ;[in] u8 X : commandId
  201                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
  202                     
  203                             ;pha    ;commandId
  204  35:77D7  20 9B 9B          jsr setYtoOffset2E      ;9b9b
  205                             ;pla
  206  35:77DA  8A                txa
  207  35:77DB  91 5B             sta [.pBattleParam],y
  208  35:77DD  E6 52             inc <.iPlayer
  209  35:77DF  A9 01             lda #1
  210  35:77E1  60                rts
  211                     ;------------------------------------------------------------------------------------------------------
  212                     ;//05:ぼうぎょ
  213                     ;$35:a877 commandWindow_OnGuard
  214                     ;commandWindow_OnGuard:
  215                     ;       lda #$05
  216                     ;       bne commandWindow_decideReturn
  217           77D7      commandWindow_OnGuard = commandWindow_decideReturn
  218                     ;------------------------------------------------------------------------------------------------------
  219                     ;//06:にげる
  220                     ;$35:a8ab commandWindow_OnEscapeSelected
  221                     ;       .org $a8ab
  222                     ;commandWindow_OnEscape:
  223                     ;       lda #$06
  224                     ;       bne commandWindow_decideReturn
  225                     ;commandWindow_OnEscape = commandWindow_decideReturn
  226                     ;------------------------------------------------------------------------------------------------------
  227                     ;//07:とんずら
  228                     ;$35:a8b5 commandWindow_OnSneakAway
  229                     ;commandWindow_OnSneakAway:
  230                     ;       lda #$07
  231                     ;       bne commandWindow_decideReturn
  232                     ;commandWindow_OnSneakAway = commandWindow_decideReturn
  233  35:77E2            commandWindow_OnEscape:
  234  35:77E2            commandWindow_OnSneakAway:
  235  35:77E2  AD D8 7E          lda battleMode
  236  35:77E5  4A                lsr a   ;escape flag
  237  35:77E6  90 EF             bcc commandWindow_decideReturn
  238  35:77E8  B0 C6             bcs commandWindow_beepAndCancel
  239                     ;------------------------------------------------------------------------------------------------------
  240                     ;//08:ジャンプ
  241                     ;$35:a9ab commandWindow_OnJump
  242                     ;       .org $a9ab
  243  35:77EA            commandWindow_OnJump:
  244           00B4      .selectedTarget = $b4
  245           00B5      .targetFlag = $b5
  246  35:77EA  20 1C A7          jsr selectSingleTargetAndSetYto2F
  247  35:77ED  F0 C4             beq commandWindow_cancelReturn
  248  35:77EF  A5 B5             lda <.targetFlag
  249  35:77F1  10 F7             bpl commandWindow_OnJump
  250                             
  251  35:77F3  A2 08             ldx #$08
  252  35:77F5  A5 B4             lda <.selectedTarget
  253  35:77F7  D0 D7             bne commandWindow_setTargetAndCommand
  254                     ;------------------------------------------------------------------------------------------------------
  255                     ;//0d:みやぶる
  256                     ;$35:ab07 commandWindow_OnDetect
  257                     ;       .org $ab07
  258                     ;commandWindow_OnDetect:
  259                     ;       lda #$0d
  260                     ;       bne commandWindow_selectSingleTargetAndNext
  261           77C1      commandWindow_OnDetect = commandWindow_selectSingleTargetAndNext
  262                     ;------------------------------------------------------------------------------------------------------
  263                     ;//0c:しらべる
  264                     ;$35:ab6e commandWindow_OnInspect
  265                     ;       .org $ab6e
  266                     ;commandWindow_OnInspect:
  267                     ;       lda #$0c
  268                     ;       bne commandWindow_selectSingleTargetAndNext
  269           77C1      commandWindow_OnInspect = commandWindow_selectSingleTargetAndNext
  270                     ;------------------------------------------------------------------------------------------------------
  271                     ;//0E:ぬすむ
  272                     ;$35:ab9f commandWindow_OnSteal
  273                     ;       .org $ab9f
  274                     ;commandWindow_OnSteal:
  275                     ;       lda #$0e
  276                     ;       bne commandWindow_selectSingleTargetAndNext
  277           77C1      commandWindow_OnSteal = commandWindow_selectSingleTargetAndNext
  278                     ;------------------------------------------------------------------------------------------------------
  279                     ;//0F:ためる
  280                     ;$35:ac65 commandWindow_OnChargeSelected
  281                     ;       .org $ac65
  282                     ;commandWindow_OnCharge:
  283                     ;       lda #$0f
  284                     ;       bne commandWindow_decideReturn
  285           77D7      commandWindow_OnCharge = commandWindow_decideReturn
  286                     ;------------------------------------------------------------------------------------------------------
  287                     ;//10:うたう
  288                     ;$35:acd0 commandWindow_OnSing  
  289                     ;       .org $acd0
  290                     ;commandWindow_OnSing:
  291                     ;       lda #$10
  292                     ;       bne commandWindow_selectSingleTargetAndNext
  293           77C1      commandWindow_OnSing = commandWindow_selectSingleTargetAndNext
  294                     ;------------------------------------------------------------------------------------------------------
  295                     ;//11:おどかす
  296                     ;$35:ad0c commandWindow_OnIntimidate    
  297                     ;       .org $ad0c
  298                     ;commandWindow_OnIntimidate:
  299                     ;       lda #$11
  300                     ;       bne commandWindow_decideReturn
  301           77D7      commandWindow_OnIntimidate = commandWindow_decideReturn
  302                     ;------------------------------------------------------------------------------------------------------
  303                     ;//12:おうえん
  304                     ;$35:ad6b commandWindow_OnCheer
  305                     ;       .org $ad6b
  306                     ;commandWindow_OnCheer:
  307                     ;       lda #$12
  308                     ;       bne commandWindow_decideReturn
  309           77D7      commandWindow_OnCheer = commandWindow_decideReturn
  310                     ;------------------------------------------------------------------------------------------------------
  311                     ;//0b:ちけい
  312                     ;$35:aa22 commandWindow_0b
  313                     ;       .org $aa22
  314           0000              .ifdef EXTEND_GEOMANCE
  316                             .else
  317  35:77F9            commandWindow_OnGeomance:
  318           007A      .geomanceTargetFlag = $7a;$35:ab06 .db $7a      //???
  319  35:77F9  20 E5 A9          jsr getCurrentTerrain
  320  35:77FC  AA                tax
  321  35:77FD  E8                inx
  322                     
  323  35:77FE  A9 7A             lda #.geomanceTargetFlag
  324  35:8800            .shift_loop:
  325  35:8800  0A                        asl a
  326  35:8801  CA                        dex
  327  35:8802  D0 FC                     bne .shift_loop
  328  35:8804  90 0A             bcc .target_all
  329  35:8806  20 2A 80                  jsr dispatchBattleFunction_06   ;802a
  330  35:8809  AE 99 7E                  ldx $7e99
  331  35:880C  A9 80                     lda #$80
  332  35:880E  30 03                     bmi .store
  333  35:8810            .target_all:
  334  35:8810  CA                        dex
  335  35:8811  A9 C0                     lda #$c0
  336  35:8813            .store:
  337           00B5      .targetFlag = $b5
  338  35:8813  85 B5             sta <.targetFlag
  339  35:8815  20 94 9B          jsr setYtoOffset2F
  340  35:8818  8A                txa
  341  35:8819  A2 0B             ldx #$0b
  342  35:881B  D0 B3             bne commandWindow_setTargetAndCommand
  343                             .endif  ;EXTEND_GEOMANCE
  344                     ;======================================================================================================
  345                     ;a823
  346  35:881D            commandWindow_arrowCoords:
  347  35:881D  34 B4 34          .db $34,$B4,$34,$D4, $50,$B4,$50,$D4, $6C,$B4,$6C,$D4, $88,$B4,$88,$D4
       35:8820  D4 50 B4  
       35:8823  50 D4 6C  
       35:8826  B4 6C D4  
       35:8829  88 B4 88  
       35:882C  D4        
  348                     ;a833
  349  35:882D            commandWindow_arrowCoords_backattack:
  350  35:882D  34 44 34          .db $34,$44,$34,$24, $50,$44,$50,$24, $6C,$44,$6C,$24, $88,$44,$88,$24
       35:8830  24 50 44  
       35:8833  50 24 6C  
       35:8836  44 6C 24  
       35:8839  88 44 88  
       35:883C  24        
  351                     ;$a7df:
  352                     ;======================================================================================================
  353                     ;//02:ぜんしん
  354                     ;$35:a7df command_forward
  355                     ;       .org $a7df
  356  35:883D            command_forward:
  357                     ;       ldx #$39+$02
  358                     ;       bne command_move
  359  35:883D            command_back:
  360                     ;       ldx #$39+$03
  361  35:883D            command_move:
  362                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
  363           006E      .pActor = $6e
  364                     
  365  35:883D  A0 33             ldy #$33
  366  35:883F  B1 6E             lda [.pActor],y
  367  35:8841  49 01             eor #$01        ;invert line flag
  368  35:8843  91 6E             sta [.pActor],y
  369  35:8845  20 65 A8          jsr getPlayerOffsetFromActor
  370  35:8848  18                clc
  371  35:8849  69 0F             adc #$0f
  372  35:884B  A8                tay
  373  35:884C  B1 59             lda [.pEquips],y
  374  35:884E  49 01             eor #$01
  375  35:8850  91 59             sta [.pEquips],y
  376                             ;fall through
  377  35:8852            setupNullTargetActionType01:
  378                     ;[in] x : actionId * 2
  379  35:8852  A9 FF             lda #$ff
  380  35:8854  8D D8 78          sta targetName  ;78d8
  381                             ;fall through
  382  35:8857            setupActionType01:
  383                     ;[in] x : actionId * 2
  384  35:8857  A9 01             lda #1
  385  35:8859  8D D5 78          sta battleProcessType
  386  35:885C            setupActionName:
  387                     ;[in] x : actionId * 2
  388  35:885C  8A                txa
  389  35:885D  4A                lsr a
  390  35:885E  18                clc
  391  35:885F  69 39             adc #$39        ;convert actionid to actionNameId
  392  35:8861  8D D7 78          sta actionName  ;78d7
  393  35:8864  60                rts
  394                     ;$a816:
  395  35:8865            getPlayerOffsetFromActor:
  396                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
  397  35:8865  20 2E A4          jsr getActor2C
  398  35:8868  29 07             and #7
  399  35:886A  85 52             sta <.iPlayer
  400  35:886C  4C 41 A5          jmp getPlayerOffset
  401                     
  402                     ;$a881
  403                     ;$35:a881 command_guard
  404  35:886F            command_guard:
  405                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
  406           006E      .pActor = $6e
  407  35:886F  20 52 A8          jsr setupNullTargetActionType01
  408                     
  409  35:8872  20 AD 9F          jsr setXtoActorIndex
  410  35:8875  A0 23             ldy #$23
  411  35:8877  B1 6E             lda [.pActor],y
  412  35:8879  9D E4 7C          sta $7ce4,x
  413  35:887C  10 04             bpl .def_under_80
  414  35:887E  A9 FF                     lda #$ff
  415  35:8880  D0 01                     bne .store
  416  35:8882            .def_under_80:
  417  35:8882  0A                        asl a
  418  35:8883            .store:
  419  35:8883  91 6E             sta [.pActor],y
  420  35:8885  60                rts
  421                     ;======================================================================================================
  422                     ;$35:a8bf command_escape //06
  423  35:8886            command_escape:
  424                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
  425           006E      .pActor = $6e
  426           0024      .rate = $24
  427                             ;ldx #$39+$06
  428  35:8886  20 52 A8          jsr setupNullTargetActionType01
  429                             
  430  35:8889  A9 64             lda #100
  431  35:888B  20 64 A5          jsr getSys1Random
  432  35:888E  48                pha     ;rand
  433                             
  434  35:888F  20 2E A4          jsr getActor2C
  435  35:8892  30 5B             bmi command_escape_enemy
  436  35:8894            .actor_is_player:
  437           0024      .pEnemy = $24
  438  35:8894  A2 00             ldx #0
  439  35:8896  8A                txa
  440  35:8897  A8                tay
  441  35:8898  86 18             stx <$18
  442  35:889A  86 19             stx <$19
  443  35:889C  86 1A             stx <$1a
  444  35:889E  86 1B             stx <$1b
  445                             INIT16 <.pEnemy,$7835
       35:88A0  A9 35             lda #LOW($7835)
       35:88A2  85 24             sta <.pEnemy
       35:88A4  A9 78             lda #HIGH($7835)
       35:88A6  85 25             sta <.pEnemy+1
  446  35:88A8  A2 07             ldx #7
  447  35:88AA            .sum_enemy_lv:
  448  35:88AA  BD A7 7D                  lda $7da7,x     ;group
  449  35:88AD  30 0F                     bmi .next
  450  35:88AF  18                                clc
  451  35:88B0  B1 24                             lda [.pEnemy],y
  452  35:88B2  65 18                             adc <$18
  453  35:88B4  85 18                             sta <$18
  454  35:88B6  A9 00                             lda #0
  455  35:88B8  65 19                             adc <$19
  456  35:88BA  85 19                             sta <$19
  457  35:88BC  E6 1A                             inc <$1a
  458  35:88BE                    .next:
  459                                     ;SUB16 <.pEnemy,$0040
  460                                     SUB16by8 <.pEnemy,#$40
       35:88BE  A5 24             lda <.pEnemy
       35:88C0  38                sec
       35:88C1  E9 40             sbc #$40
       35:88C3  85 24             sta <.pEnemy
       35:88C5  B0 02             bcs .sub16by8_00061
       35:88C7  C6 25                     dec <.pEnemy+1
       35:88C9                    .sub16by8_00061:
  461  35:88C9  CA                        dex
  462  35:88CA  10 DE                     bpl .sum_enemy_lv
  463                     
  464  35:88CC  20 92 FC          jsr div_16
  465  35:88CF  A0 2A             ldy #$2a
  466  35:88D1  B1 6E             lda [.pActor],y
  467  35:88D3  18                clc
  468  35:88D4  69 19             adc #25
  469  35:88D6  38                sec
  470  35:88D7  E5 1C             sbc <$1c        ;average lv of enemies
  471  35:88D9  B0 02             bcs .rate_plus
  472  35:88DB  A9 00                     lda #0
  473  35:88DD            .rate_plus:
  474           88BA      .beginningMode = $78ba
  475  35:88DD  85 24             sta <.rate
  476  35:88DF  68                pla     ;rand
  477  35:88E0  C5 24             cmp <.rate
  478  35:88E2  90 2F             bcc command_escape_possible
  479  35:88E4  AD BA 78          lda .beginningMode
  480  35:88E7  4A                lsr a   ;party surprise attack
  481  35:88E8  B0 29             bcs command_escape_possible
  482                     ;.fail:
  483  35:88EA            command_escape_fail:
  484  35:88EA  A9 1F             lda #$1f        ;"にげられない！"
  485                             ;sta battleMessages
  486                             ;rts
  487  35:88EC  4C BF 9F          jmp addBattleMessage
  488                     
  489                     ;enemy:
  490                     ;a978
  491  35:88EF            command_escape_enemy:
  492           006E      .pActor = $6e
  493  35:88EF  68                pla     ;rand
  494  35:88F0  A0 22             ldy #$22
  495  35:88F2  D1 6E             cmp [.pActor],y
  496  35:88F4  B0 F4             bcs command_escape_fail
  497                     
  498  35:88F6  A9 1E             lda #$1e
  499  35:88F8  8D DA 78          sta battleMessages
  500  35:88FB  20 AD 9F          jsr setXtoActorIndex
  501  35:88FE  A9 00             lda #0
  502  35:9900  20 20 FD          jsr flagTargetBit
  503  35:9903  48                pha ;sta $78d4
  504  35:9904  8A                txa
  505  35:9905  0A                asl a
  506  35:9906  AA                tax
  507  35:9907  B5 F0             lda <$f0,x
  508  35:9909  09 80             ora #$80
  509  35:990B  95 F0             sta <$f0,x
  510                             ;rts
  511  35:990D  68                pla
  512  35:990E  D0 23             bne command_escape_succeeded
  513                     ;//07
  514                     ;$35:a93b command_sneakAway     //[sneak away]
  515  35:9910            command_sneakAway:
  516                             ;ldx #$39+$07
  517  35:9910  20 52 A8          jsr setupNullTargetActionType01
  518  35:9913            command_escape_possible:
  519                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
  520                     
  521  35:9913  AD D8 7E          lda battleMode  ;7ed8
  522  35:9916  4A                lsr a   ;escape forbidden flag
  523  35:9917  B0 D1             bcs command_escape_fail
  524                     
  525  35:9919  A2 03             ldx #3
  526  35:991B            .check_confused_member:
  527  35:991B  86 52                     stx <.iPlayer
  528  35:991D  20 41 A5                  jsr getPlayerOffset
  529  35:9920  A8                        tay
  530  35:9921  C8                        iny
  531  35:9922  C8                        iny
  532  35:9923  B1 5B                     lda [.pBattleParam],y
  533  35:9925  29 20                     and #$20
  534  35:9927  D0 C1                     bne command_escape_fail
  535  35:9929  CA                        dex
  536  35:992A  10 EF                     bpl .check_confused_member
  537                     ;ok
  538  35:992C  A9 02             lda #2
  539  35:992E  8D D3 78          sta $78d3
  540  35:9931  A9 F0             lda #$f0
  541  35:9933            command_escape_succeeded:
  542  35:9933  8D D4 78          sta $78d4
  543  35:9936  A9 1E             lda #$1e        ;"にげだした････"
  544  35:9938  4C BF 9F          jmp addBattleMessage
  545                             ;sta battleMessages
  546                             ;rts
  547                     ;======================================================================================================
  548                     ;$a9d8
  549                     ;$35:a9d8 command_jump
  550  35:993B            command_jump:
  551                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
  552           006E      .pActor = $6e
  553                             ;ldx #$39+$08
  554  35:993B  20 57 A8          jsr setupActionType01
  555                     
  556  35:993E  A0 01             ldy #$01
  557  35:9940  B1 6E             lda [.pActor],y
  558  35:9942  29 28             and #$28
  559  35:9944  F0 08             beq .ok
  560                     ;fail
  561  35:9946  A9 18                     lda #$18
  562  35:9948  8D C2 7E                  sta effectHandlerIndex
  563  35:994B  4C 4C AA                  jmp command_setNoEffectAndReturn
  564  35:994E            .ok:
  565                     ;$a9f6:
  566  35:994E  20 B4 9F          jsr setXtoActorIndex16
  567  35:9951  E8                inx
  568  35:9952  B5 F0             lda <$f0,x
  569  35:9954  09 01             ora #$01
  570  35:9956  95 F0             sta <$f0,x
  571  35:9958  C8                iny
  572  35:9959  C8                iny
  573  35:995A  A9 09             lda #$09
  574  35:995C  91 6E             sta [.pActor],y ;2e
  575  35:995E  60                rts
  576                     ;
  577                     ;$35:aa11 command_09 //landing
  578  35:995F            command_land:
  579           006E      .pActor = $6e
  580  35:995F  A0 02             ldy #2
  581  35:9961  B1 6E             lda [.pActor],y
  582  35:9963  29 FE             and #$fe
  583  35:9965  91 6E             sta [.pActor],y
  584  35:9967  A0 27             ldy #$27
  585  35:9969  A9 18             lda #CHARGE_COUNT_JUMP
  586  35:996B  91 6E             sta [.pActor],y
  587  35:996D  4C 1E 80          jmp dispatchBattleFunction_03   ;801e
  588                     ;$aa22:
  589                     ;======================================================================================================
  590                     
  591                     ;$aa5d:
  592                     ;$35:aa5d command_0b
  593                     
  594                     
  595           0000              .ifdef EXTEND_GEOMANCE
  683                             .else ;EXTEND_GEOMANCE
  684                     
  685  35:9970            command_geomance:
  686                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
  687           006E      .pActor = $6e
  688  35:9970  20 2E A4          jsr getActor2C
  689  35:9973  09 10             ora #$10
  690  35:9975  91 6E             sta [.pActor],y
  691  35:9977  20 E5 A9          jsr getCurrentTerrain   ;aac3
  692  35:997A  18                clc
  693  35:997B  69 50             adc #$50
  694                     
  695                             .endif ;EXTEND_GEOMANCE
  696                     
  697  35:997D  A0 2E             ldy #$2e
  698  35:997F  91 6E             sta [.pActor],y
  699  35:9981  85 1A             sta <$1a
  700           0001              .ifdef BOOST_GEOMANCER
  701  35:9983  A0 00                     ldy #$0
  702  35:9985  B1 6E                     lda [.pActor],y
  703  35:9987  48                        pha
  704  35:9988  A0 0F                     ldy #$0f
  705  35:998A  18                        clc
  706  35:998B  71 6E                     adc [.pActor],y
  707  35:998D  A0 00                     ldy #0
  708  35:998F  91 6E                     sta [.pActor],y
  709  35:9991  20 67 A3                  jsr command_magic
  710  35:9994  68                        pla
  711  35:9995  A0 00                     ldy #$0
  712  35:9997  91 6E                     sta [.pActor],y
  713                             .else
  715                             .endif  ;BOOST_GEOMANCER
  716  35:9999  E6 CC             inc <$cc
  717  35:999B  A9 14             lda #$14
  718  35:999D  8D C2 7E          sta effectHandlerIndex
  719                             
  720  35:99A0  AD 9B 7E          lda play_effectTargetBits       ;7e9b
  721  35:99A3  D0 3F             bne command_doReturn
  722                     ;failed. nature bites player
  723  35:99A5  A9 03             lda #3
  724  35:99A7  85 54             sta <$54
  725                     ;$aac3:
  726  35:99A9            damageActorByQuoterHalf:
  727                     ;[out] x : cacheIndex
  728           0018      .maxhp = $18
  729           006E      .pActor = $6e
  730           00F0      .actorStatusCache = $f0
  731  35:99A9  20 B4 9F          jsr setXtoActorIndex16
  732                     
  733  35:99AC  A0 05             ldy #5
  734  35:99AE  B1 6E             lda [.pActor],y
  735  35:99B0  9D 5F 7E          sta $7e5f,x
  736  35:99B3  C8                iny
  737  35:99B4  B1 6E             lda [.pActor],y
  738  35:99B6  4A                lsr a
  739  35:99B7  7E 5F 7E          ror $7e5f,x
  740  35:99BA  4A                lsr a
  741  35:99BB  9D 60 7E          sta $7e60,x
  742  35:99BE  7E 5F 7E          ror $7e5f,x
  743                     
  744  35:99C1  A0 03             ldy #3
  745  35:99C3  38                sec
  746  35:99C4  B1 6E             lda [.pActor],y
  747  35:99C6  FD 5F 7E          sbc $7e5f,x
  748  35:99C9  91 6E             sta [.pActor],y
  749  35:99CB  C8                iny
  750  35:99CC  B1 6E             lda [.pActor],y
  751  35:99CE  FD 60 7E          sbc $7e60,x
  752  35:99D1  91 6E             sta [.pActor],y
  753  35:99D3  88                dey
  754  35:99D4  11 6E             ora [.pActor],y
  755                             ;a9d4
  756  35:99D6  F0 02             beq .result_dead
  757  35:99D8  B0 0A             bcs .finish
  758  35:99DA            .result_dead:
  759  35:99DA  A9 80                     lda #$80
  760  35:99DC  95 F0                     sta <.actorStatusCache,x
  761  35:99DE  0A                        asl a
  762  35:99DF  91 6E                     sta [.pActor],y
  763  35:99E1  C8                        iny
  764  35:99E2  91 6E                     sta [.pActor],y
  765  35:99E4            .finish:
  766  35:99E4            command_doReturn:
  767  35:99E4  60                rts
  768                     ;$35:aac3 getCurrentTerrain
  769  35:99E5            getCurrentTerrain:
  770  35:99E5  AD E3 7C          lda $7ce3
  771  35:99E8  C9 08             cmp #$08
  772  35:99EA  90 2E             bcc .finish
  773  35:99EC  A2 05                     ldx #$05
  774  35:99EE  C9 12                     cmp #$12
  775  35:99F0  F0 25                     beq .use_low
  776                                     ;bne .load_param
  777                                     ;       ;lda #$55
  778                                     ;       lda #$05
  779                                     ;       rts
  780  35:99F2                    .load_param:
  781  35:99F2  18                        clc
  782  35:99F3  AD C8 74                  lda $74c8       ;field $48
  783  35:99F6  69 4E                     adc #$4e
  784  35:99F8  85 46                     sta <$46
  785  35:99FA  A9 00                     lda #0
  786  35:99FC  69 A2                     adc #$a2
  787  35:99FE  85 47                     sta <$47
  788                                     
  789  35:AA00  A9 1A                     lda #$1a        
  790  35:AA02  85 4A                     sta <$4a        ;current bank
  791  35:AA04  A9 01                     lda #1
  792  35:AA06  85 4B                     sta <$4b        ;size
  793  35:AA08  A9 00                     lda #0          ;src bank
  794  35:AA0A  20 DC FD                  jsr copyTo7400
  795                     
  796  35:AA0D  AE 00 74                  ldx $7400
  797  35:AA10  AD D8 7E                  lda battleMode  ;$7ed8
  798  35:AA13  29 08                     and #8
  799                     
  800  35:AA15  D0 04                     bne .use_high
  801  35:AA17                    .use_low:
  802  35:AA17  8A                                txa
  803  35:AA18  29 0F                             and #$0f
  804  35:AA1A                    .finish:
  805  35:AA1A  60                                rts
  806  35:AA1B                    .use_high:
  807  35:AA1B  8A                        txa
  808  35:AA1C  4C 45 FD                  jmp $fd45       ;a>>4
  809                     ;$35:ab06 .db $7a       //???
  810                     ;======================================================================================================
  811                     ;setEffectHandlerTo18 = $ab66
  812                     ;$35:ab0c command_detect
  813  35:AA1F            command_detect:
  814           0070      .pTarget = $70
  815                             ;ldx #$39+$0d
  816  35:AA1F  20 6D AA          jsr setupNoMotionType01
  817                     
  818  35:AA22  A0 01             ldy #1
  819  35:AA24  B1 70             lda [.pTarget],y
  820  35:AA26  30 24             bmi command_setNoEffectAndReturn
  821  35:AA28            .ok:
  822                     ;$ab27:
  823           0018      .count = $18
  824  35:AA28  A0 12             ldy #$12
  825  35:AA2A  B1 70             lda [.pTarget],y
  826                     
  827  35:AA2C  A0 00             ldy #0
  828                             ;ldx battleMessageCount
  829  35:AA2E  84 18             sty <.count
  830  35:AA30            .queue_weak_points:
  831  35:AA30  0A                        asl a
  832  35:AA31  90 0A                     bcc .next
  833  35:AA33  E6 18                             inc <.count
  834  35:AA35  48                                pha
  835                                             ;pha
  836                                             ;tya
  837                                             ;;clc (always set)
  838                                             ;adc #$47
  839                                             ;sta battleMessages,x
  840                                             ;pla
  841                                             ;inx
  842                                             ;stx battleMessageCount
  843  35:AA36  98                                tya
  844                                             ;carry always be set
  845  35:AA37  69 47                             adc #$47
  846  35:AA39  20 BF 9F                          jsr addBattleMessage
  847  35:AA3C  68                                pla
  848  35:AA3D                    .next:
  849  35:AA3D  C8                        iny
  850  35:AA3E  C0 07                     cpy #7
  851  35:AA40  D0 EE                     bne .queue_weak_points
  852  35:AA42  A5 18             lda <.count
  853  35:AA44  D0 05             bne .finish
  854  35:AA46  A9 43                     lda #$43
  855  35:AA48  20 BF 9F                  jsr addBattleMessage
  856                                     ;sta battleMessages,x
  857  35:AA4B            .finish:
  858  35:AA4B  60                rts
  859                     
  860  35:AA4C            command_setNoEffectAndReturn:
  861                             ;ldx #$3b
  862                             ;stx battleMessages
  863                             ;rts
  864  35:AA4C  A9 3B             lda #$3b
  865  35:AA4E  4C BF 9F          jmp addBattleMessage
  866                     ;======================================================================================================
  867                     ;$35:ab73 command_inspect
  868  35:AA51            command_inspect:
  869           0070      .pTarget = $70
  870                             ;jsr setEffectHandlerTo18
  871  35:AA51  A0 06             ldy #6
  872  35:AA53  A2 03             ldx #3
  873  35:AA55            .copy_hp:
  874  35:AA55  B1 70                     lda [.pTarget],y
  875  35:AA57  9D E4 78                  sta $78e4,x
  876  35:AA5A  88                        dey
  877  35:AA5B  CA                        dex
  878  35:AA5C  10 F7                     bpl .copy_hp
  879                             
  880  35:AA5E  A0 01             ldy #1
  881  35:AA60  A2 3F             ldx #$3f
  882  35:AA62  B1 70             lda [.pTarget],y
  883  35:AA64  10 02             bpl .ok
  884  35:AA66  A2 3B                     ldx #$3b
  885  35:AA68            .ok:
  886  35:AA68  8E DA 78          stx battleMessages
  887  35:AA6B  A2 18             ldx #$0c*2
  888                             ;fall through
  889  35:AA6D            setupNoMotionType01:
  890                     ;[in] x : actionId * 2 (initial value on handler entry)
  891  35:AA6D  20 57 A8          jsr setupActionType01
  892  35:AA70            setEffectHandlerTo18    ;18=do nothing
  893  35:AA70  A9 18             lda #$18
  894  35:AA72  8D C2 7E          sta effectHandlerIndex
  895  35:AA75  E6 CC             inc <$cc
  896  35:AA77  60                rts
  897                     ;======================================================================================================
  898                     ;$35:aba4 command_steal
  899  35:AA78            command_steal:
  900           006E      .pActor = $6e
  901           0070      .pTarget = $70
  902                             ;ldx #$39+$0E
  903  35:AA78  20 6D AA          jsr setupNoMotionType01
  904                     
  905  35:AA7B  A0 2C             ldy #$2c
  906  35:AA7D  B1 70             lda [.pTarget],y
  907  35:AA7F  30 05             bmi .target_is_enemy
  908  35:AA81            .fail:
  909  35:AA81  A9 35                     lda #$35 ;"ぬすみそこなった"
  910  35:AA83  4C BF 9F                  jmp addBattleMessage
  911                                     ;sta battleMessages
  912                                     ;rts
  913  35:AA86            .target_is_enemy:
  914  35:AA86  A0 01             ldy #1
  915  35:AA88  B1 70             lda [.pTarget],y
  916  35:AA8A  29 E8             and #$e8
  917  35:AA8C  D0 F3             bne .fail
  918                     
  919           0024      .rate = $24
  920  35:AA8E  18                clc
  921  35:AA8F  88                dey
  922  35:AA90  B1 6E             lda [.pActor],y
  923  35:AA92  A0 0F             ldy #$0f
  924  35:AA94  71 6E             adc [.pActor],y
  925  35:AA96  85 24             sta <.rate
  926  35:AA98  A9 FF             lda #$ff
  927  35:AA9A  20 64 A5          jsr getSys1Random
  928  35:AA9D  C5 24             cmp <.rate
  929  35:AA9F  B0 E0             bcs .fail
  930                     
  931           0018      .dropTableIndex = $18
  932  35:AAA1  A0 36             ldy #$36
  933  35:AAA3  B1 70             lda [.pTarget],y
  934  35:AAA5  29 1F             and #$1f
  935  35:AAA7  85 18             sta <.dropTableIndex
  936                             ;
  937  35:AAA9  A9 08             lda #$08
  938  35:AAAB  85 1A             sta <$1a
  939                             INIT16 <$20,$9b80
       35:AAAD  A9 80             lda #LOW($9b80)
       35:AAAF  85 20             sta <$20
       35:AAB1  A9 9B             lda #HIGH($9b80)
       35:AAB3  85 21             sta <$20+1
  940  35:AAB5  A9 08             lda #$08
  941  35:AAB7  A2 00             ldx #$00
  942  35:AAB9  A0 1A             ldy #$1a
  943  35:AABB  20 A6 FD          jsr loadTo7400Ex
  944           4400      .dropList = $7400
  945  35:AABE  A9 FF             lda #$ff
  946  35:AAC0  20 64 A5          jsr getSys1Random
  947  35:AAC3  A2 03             ldx #3
  948  35:AAC5            .get_index:
  949  35:AAC5  DD 07 AB                  cmp .bounds,x
  950  35:AAC8  B0 03                     bcs .found_index
  951  35:AACA  CA                        dex
  952  35:AACB  10 F8                     bpl .get_index
  953  35:AACD            .found_index:
  954  35:AACD  BD 00 74          lda .dropList,x
  955  35:AAD0  A8                tay
  956  35:AAD1  F0 AE             beq .fail
  957                     
  958  35:AAD3  20 FA AA          jsr .findItem
  959  35:AAD6  30 07             bmi .put_drop
  960  35:AAD8  A9 00             lda #0
  961  35:AADA  20 FA AA          jsr .findItem
  962  35:AADD  10 A2             bpl .fail
  963  35:AADF            .put_drop:
  964  35:AADF  FE 01 60          inc backpackItems-$c0+1,x
  965  35:AAE2  BD 01 60          lda backpackItems-$c0+1,x
  966  35:AAE5  C9 64             cmp #100
  967  35:AAE7  90 05             bcc .store_id
  968  35:AAE9  A9 63                     lda #99
  969  35:AAEB  9D 01 60                  sta backpackItems-$c0+1,x
  970  35:AAEE            .store_id:
  971  35:AAEE  98                tya     ;itemid
  972  35:AAEF  9D 00 60          sta backpackItems-$c0,x
  973  35:AAF2            .finish:
  974  35:AAF2  8D E4 78          sta $78e4
  975  35:AAF5  A9 29             lda #$29
  976  35:AAF7  4C BF 9F          jmp addBattleMessage
  977                             ;sta battleMessages
  978                             ;rts
  979  35:AAFA            .findItem:
  980                     ;[in] a : itemid to find
  981  35:AAFA  A2 C0             ldx #$c0
  982  35:AAFC            .find_loop:
  983  35:AAFC  DD 00 60                  cmp backpackItems-$c0,x
  984  35:AAFF  F0 04                     beq .found
  985  35:BB01  E8                        inx
  986  35:BB02  E8                        inx
  987  35:BB03  D0 F7                     bne .find_loop
  988  35:BB05            .found:
  989  35:BB05  8A                txa
  990  35:BB06  60                rts
  991  35:BB07            .bounds:
  992  35:BB07  00 30 60          .db $00,$30,$60,$90
       35:BB0A  90        
  993                     ;$ac65
  994                     ;======================================================================================================
  995                     ;$35:ac6f command_charge //0F
  996  35:BB0B            command_charge:
  997           006E      .pActor = $6e
  998                             ;ldx #$39+$0f
  999  35:BB0B  20 57 A8          jsr setupActionType01
 1000                     
 1001  35:BB0E  A2 3B             ldx #$3b ;"こうかがなかった"
 1002  35:BB10  A0 01             ldy #1
 1003  35:BB12  B1 6E             lda [.pActor],y
 1004  35:BB14  29 28             and #$28
 1005  35:BB16  D0 39             bne .fail
 1006  35:BB18  A0 27                     ldy #$27
 1007  35:BB1A  B1 6E                     lda [.pActor],y
 1008  35:BB1C  18                        clc
 1009  35:BB1D  69 14                     adc #CHARGE_INCREMENT
 1010  35:BB1F  C9 29                     cmp #CHARGE_MAX
 1011  35:BB21  B0 08                     bcs .bomb
 1012                                     ;ok
 1013  35:BB23  91 6E                             sta [.pActor],y
 1014  35:BB25  A9 00                             lda #0
 1015  35:BB27  8D 93 7E                          sta $7e93
 1016  35:BB2A  60                                rts
 1017  35:BB2B            .bomb:
 1018                                     ;bomb
 1019  35:BB2B  A9 00                     lda #0
 1020  35:BB2D  91 6E                     sta [.pActor],y
 1021  35:BB2F  A0 04                     ldy #4
 1022  35:BB31  B1 6E                     lda [.pActor],y
 1023  35:BB33  4A                        lsr a
 1024  35:BB34  91 6E                     sta [.pActor],y
 1025  35:BB36  88                        dey
 1026  35:BB37  B1 6E                     lda [.pActor],y
 1027  35:BB39  6A                        ror a
 1028  35:BB3A  91 6E                     sta [.pActor],y
 1029  35:BB3C  C8                        iny
 1030  35:BB3D  11 6E                     ora [.pActor],y
 1031  35:BB3F  D0 09                     bne .bomb_alive
 1032                                             ;jsr setXtoActorIndex
 1033                                             ;asl a
 1034                                             ;tax
 1035  35:BB41  20 B4 9F                          jsr setXtoActorIndex16
 1036  35:BB44  B5 F0                             lda <$f0,x
 1037  35:BB46  09 80                             ora #$80
 1038  35:BB48  95 F0                             sta <$f0,x
 1039  35:BB4A                    .bomb_alive:
 1040  35:BB4A  A9 01                     lda #1
 1041  35:BB4C  8D 93 7E                  sta $7e93
 1042  35:BB4F  A2 2F                     ldx #$2f        ;"ためすぎてじばくした!"
 1043  35:BB51            .fail:
 1044  35:BB51  8E DA 78          stx battleMessages
 1045  35:BB54  60                rts
 1046                     ;======================================================================================================
 1047                     ;$35:acd5 command_sing
 1048  35:BB55            command_sing:
 1049           006E      .pActor = $6e
 1050                     ;竪琴チェック オリジナルは装備欄のIDによる
 1051  35:BB55  A0 31             ldy #$31
 1052  35:BB57  B1 6E             lda [.pActor],y
 1053  35:BB59  C8                iny
 1054  35:BB5A  11 6E             ora [.pActor],y
 1055  35:BB5C  29 08             and #$08        ;harp
 1056  35:BB5E  F0 03             beq .fail
 1057  35:BB60  4C 04 A1                  jmp command_fight
 1058  35:BB63            .fail:
 1059  35:BB63  A9 01             lda #1
 1060  35:BB65  8D D5 78          sta battleProcessType
 1061  35:BB68  A9 42             lda #$42        ;"たてごとがないのでうたえない"
 1062  35:BB6A  8D DA 78          sta battleMessages
 1063  35:BB6D  A9 18             lda #$18
 1064  35:BB6F  8D C2 7E          sta effectHandlerIndex
 1065  35:BB72  60                rts
 1066                     ;======================================================================================================
 1067                     ;$35:ad16 command_intimidate
 1068  35:BB73            command_intimidate:
 1069                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
 1070                     
 1071  35:BB73  AD D8 7E          lda battleMode
 1072  35:BB76  4A                lsr a   ;escape forbidden
 1073  35:BB77  90 03             bcc .ok
 1074  35:BB79  4C 4C AA                  jmp command_setNoEffectAndReturn
 1075  35:BB7C            .ok:
 1076  35:BB7C  A0 00             ldy #0
 1077                             
 1078           0001              .ifdef BOOST_INTIMIDATE
 1079  35:BB7E  A2 07                     ldx #7
 1080  35:BB80                    .set_lv:
 1081  35:BB80  B1 5D                             lda [.pTargetBase],y
 1082  35:BB82  4A                                lsr a
 1083  35:BB83  91 5D                             sta [.pTargetBase],y
 1084  35:BB85  4A                                lsr a
 1085  35:BB86  18                                clc
 1086  35:BB87  71 5D                             adc [.pTargetBase],y
 1087  35:BB89  91 5D                             sta [.pTargetBase],y
 1088                                             ;ADD16 <.pTargetBase,$0040
 1089                                             ADD16by8 <.pTargetBase,#$40
       35:BB8B  A5 5D             lda <.pTargetBase
       35:BB8D  18                clc
       35:BB8E  69 40             adc #$40
       35:BB90  85 5D             sta <.pTargetBase
       35:BB92  90 02             bcc .add16by8_00067
       35:BB94  E6 5E                     inc <.pTargetBase+1
       35:BB96                    .add16by8_00067:
 1090  35:BB96  CA                                dex
 1091  35:BB97  10 E7                             bpl .set_lv
 1092                             .else
 1108                             .endif  ;BOOST_INTIMIDATE
 1109                             
 1110                             INIT16 <.pTargetBase,$7675
       35:BB99  A9 75             lda #LOW($7675)
       35:BB9B  85 5D             sta <.pTargetBase
       35:BB9D  A9 76             lda #HIGH($7675)
       35:BB9F  85 5E             sta <.pTargetBase+1
 1111  35:BBA1  A9 32             lda #$32
 1112  35:BBA3  8D DA 78          sta battleMessages
 1113  35:BBA6  A9 FF             lda #$ff
 1114  35:BBA8  8D D8 78          sta targetName  ;$78d8
 1115                             ;ldx #$39+$11
 1116  35:BBAB  A2 22             ldx #$11*2
 1117  35:BBAD  4C 57 A8          jmp setupActionType01
 1118                     
 1119                     ;$ad6b:
 1120                     ;}
 1121                     ;======================================================================================================
 1122                     ;$35:ad75 command_cheer
 1123  35:BBB0            command_cheer:
 1124                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
 1125  35:BBB0  A2 03             ldx #3
 1126  35:BBB2            .for_each_player:
 1127  35:BBB2  86 52                     stx <.iPlayer
 1128  35:BBB4  20 41 A5                  jsr getPlayerOffset
 1129  35:BBB7  18                        clc
 1130           0001              .ifdef BOOST_CHEER
 1131  35:BBB8  69 38                     adc #$38        ;bonus atk
 1132  35:BBBA  A8                        tay
 1133  35:BBBB  B1 5B                     lda [.pBattleParam],y
 1134                                     ;clc    ;always cleared
 1135  35:BBBD  69 20                     adc #$20
 1136  35:BBBF  90 05                     bcc .next
 1137  35:BBC1  A9 FF                             lda #$ff
 1138  35:BBC3  8D D8 78                          sta targetName
 1139                             .else
 1148                             .endif  ;BOOST_CHEER
 1149  35:BBC6                    .next:
 1150  35:BBC6  91 5B                     sta [.pBattleParam],y
 1151  35:BBC8  CA                        dex
 1152  35:BBC9  10 E7                     bpl .for_each_player
 1153  35:BBCB  A2 31             ldx #$31
 1154  35:BBCD  8E DA 78          stx battleMessages
 1155                             ;ldx #$39+$12
 1156  35:BBD0  A2 24             ldx #$12*2
 1157  35:BBD2  4C 57 A8          jmp setupActionType01
 1158                     
 1159  35:BBD5            ff3_commands_end:
 1160                     ;======================================================================================================
 1161                     ;       RESTORE_PC ff3_commands_begin
#[2]   ff3_hack_master.asm
#[3]   ff3_command_ex.asm
   45                                     .include "ff3_command_ex.asm"; consume( infoWindow_free, calc_player_param_free )
    1                     ; ff3_command_ex.asm
    2                     ;
    3                     ; description:
    4                     ;       replaces originally unimplemented command ($0a)
    5                     ;       implements 'extra ability' feature
    6                     ;
    7                     ; version:
    8                     ;       0.06 (2006-11-10)
    9                     ;======================================================================================================
   10  35:BBD5            ff3_command_ex_begin:
   11                     ;------------------------------------------------------------------------------------------------------
   12           003C      EXTRA_ABILITY_OFFSET    = $3c
   13                     
   14                     ;PASSIVE_ABILITY_MASK   = $FF
   15           0080      PASSIVE_COUNTER                 = $80
   16           0040      PASSIVE_DOUBLE_ITEM_EFFECT = $40
   17           0020      PASSIVE_PROTECT                 = $20
   18           0010      PASSIVE_SUMMON_FUSION   = $10
   19           0008      PASSIVE_WRESTLING               = $08
   20                     ;------------------------------------------------------------------------------------------------------
   21                     
   22                     ;replace tables
   23                     ;$34:9b21(file:69b31) actionId jobActionLists[4][22]
   24                             FILEORG $69b21
                0034              .bank   ($69b21) >> 13
                BB21              .org    ($8000 | (($69b21) & $7fff))
   25  34:BB21                    job_commands:
   26  34:BB21  04 05 06                  .db             $04,$05,$06,$14 ;00 onion
       34:BB24  14        
   27           0001              .ifdef GIVE_FIGHTER_RAID
   28  34:BB25  04 19 06                  .db             $04,$19,$06,$14 ;01 fighter
       34:BB28  14        
   29                             .else
   31                             .endif  ;GIVE_FIGHTER_RAID
   32  34:BB29  04 05 06                  .db             $04,$05,$06,$14 ;02 monk
       34:BB2C  14        
   33  34:BB2D  04 15 06                  .db             $04,$15,$06,$14 ;03 priest (white
       34:BB30  14        
   34  34:BB31  04 15 06                  .db             $04,$15,$06,$14 ;04 mage (black
       34:BB34  14        
   35  34:BB35  04 15 06                  .db             $04,$15,$06,$14 ;05 red
       34:BB38  14        
   36           0001              .ifdef GIVE_HUNTER_DISORDERED_SHOT
   37  34:BB39  04 17 15                          .db             $04,$17,$15,$14
       34:BB3C  14        
   38                             .else
   40                             .endif ;GIVE_HUNTER_DISORDERED_SHOT
   41  34:BB3D  04 05 06                  .db             $04,$05,$06,$14 ;07
       34:BB40  14        
   42  34:BB41  04 0E 07                  .db             $04,$0E,$07,$14 ;08
       34:BB44  14        
   43  34:BB45  04 0C 0D                  .db             $04,$0C,$0D,$14 ;09
       34:BB48  14        
   44  34:BB49  04 0B 05                  .db             $04,$0B,$05,$14 ;0a
       34:BB4C  14        
   45  34:BB4D  04 08 05                  .db             $04,$08,$05,$14 ;0b
       34:BB50  14        
   46           0001              .ifdef GIVE_VIKING_PROVOKE
   47  34:BB51  04 16 05                          .db             $04,$16,$05,$14 ;0c viking
       34:BB54  14        
   48                             .else
   50                             .endif  
   51  34:BB55  04 0F 05                  .db             $04,$0F,$05,$14 ;0d     martialist
       34:BB58  14        
   52           0001              .ifdef GIVE_EVILSWORDMAN_ABYSS
   53  34:BB59  04 18 15                  .db             $04,$18,$15,$14 ;0e
       34:BB5C  14        
   54                             .else
   56                             .endif
   57  34:BB5D  04 15 06                  .db             $04,$15,$06,$14 ;0f
       34:BB60  14        
   58  34:BB61  10 11 12                  .db             $10,$11,$12,$14 ;10     bard
       34:BB64  14        
   59  34:BB65  04 15 06                  .db             $04,$15,$06,$14 ;11
       34:BB68  14        
   60  34:BB69  04 15 06                  .db             $04,$15,$06,$14 ;12
       34:BB6C  14        
   61  34:BB6D  04 15 06                  .db             $04,$15,$06,$14 ;13
       34:BB70  14        
   62  34:BB71  04 15 06                  .db             $04,$15,$06,$14 ;14 sage
       34:BB74  14        
   63  34:BB75  04 05 06                  .db             $04,$05,$06,$14 ;15 ninja
       34:BB78  14        
   64                     ;------------------------------------------------------------------------------------------------------
   65           0039              .bank   $39
   66                     
   67           0001              .ifdef GIVE_FIGHTER_RAID
   68           BB23                      .org    $bb1a + ($01 * 5 + 4)
   69  39:BB23  F1                                .db %11110001   ;12 12 0 4
   70                             .endif  ;raid
   71           0001              .ifdef GIVE_HUNTER_DISORDERED_SHOT
   72           BB3C                      .org    $bb1a + ($06 * 5 + 4)
   73  39:BB3C                            jobParams_hunter_04:
   74  39:BB3C  F9                                .db %11111001   ;12 12 8 4 ; original = $d9 (%11011001)
   75                             .endif  ;disordered_shot
   76                             
   77           0001              .ifdef GIVE_VIKING_PROVOKE
   78           BB5A                      .org    $bb1a + ($0c * 5 + 4)   ;viking job param +04 (actionJobExp)
   79  39:BB5A                            jobParams_viking_04:
   80  39:BB5A  FA                                .db %11111010   ;12 12 8 8
   81                             .endif  ;provoke
   82                             
   83           0001              .ifdef GIVE_EVILSWORDMAN_ABYSS
   84           BB64                              .org    $bb1a + ($0e * 5 + 4)
   85  39:BB64  F9                                .db %11111001   ;12 12 8 4; original = $d9
   86                             .endif  ;abyss
   87                     ;======================================================================================================
   88                             RESTORE_PC infoWindow_free_begin
                0034              .bank   BANK(infoWindow_free_begin)
                CCAC              .org    infoWindow_free_begin
   89                     
   90  34:CCAC            extraAbilityNameIds:
   91  34:CCAC  0A                .db $0a
   92  34:CCAD  5A                .db EXMSG_DISORDERED_SHOT
   93  34:CCAE  5B                .db EXMSG_ABYSS
   94  34:CCAF  5C                .db EXMSG_RAID
   95                     
   96  34:CCB0            getExtraAbilityNameId:
   97                     ;[in] u8 a : actionId
   98  34:CCB0  C9 16             cmp #CMDX_ID_BEGIN
   99  34:CCB2  90 04             bcc .normal_command
  100  34:CCB4  AA                        tax
  101  34:CCB5  BD 96 9C                  lda extraAbilityNameIds-CMDX_ID_BEGIN,x
  102  34:CCB8            .normal_command
  103  34:CCB8  60                rts
  104                     
  105                     
  106           0001              .ifdef FAST_DISORDERED_SHOT
  107                     ;v0.6.1
  108  34:CCB9            setIndexAndCallPresentScene:
  109           0052      .iPlayer = $52
  110  34:CCB9  48                pha
  111  34:CCBA  20 AD 9F          jsr setXtoActorIndex
  112  34:CCBD  86 52             stx <.iPlayer
  113  34:CCBF  68                pla
  114  34:CCC0  4C 0E FA          jmp call_2e_9d53
  115                             .endif ;FAST_DISORDERED_SHOT
  116                     
  117  34:CCC3            updateTargetStatusByCache:
  118           0070      .pTarget = $70
  119           00E0      .targetStatusCache = $e0
  120  34:CCC3  20 A6 9F          jsr setXtoTargetIndex
  121  34:CCC6  0A                asl a
  122  34:CCC7  AA                tax
  123  34:CCC8  A0 02             ldy #2
  124  34:CCCA            .update:
  125                                     ;lda [.pTarget],y
  126  34:CCCA  B5 E1                     lda <.targetStatusCache+1,x
  127  34:CCCC  91 70                     sta [.pTarget],y
  128  34:CCCE  CA                        dex
  129  34:CCCF  88                        dey
  130  34:CCD0  D0 F8                     bne .update
  131  34:CCD2  60                rts
  132                     
  133                             VERIFY_PC infoWindow_free_end
       34:CCD3                    .verify_pc_00072:
                0000              .if (.verify_pc_00072 > infoWindow_free_end)
                                  .endif
  134                     ;======================================================================================================
  135                             RESTORE_PC calc_player_param_free_begin
                0031              .bank   BANK(calc_player_param_free_begin)
                AAB0              .org    calc_player_param_free_begin
  136  31:AAB0            extraAbilityFlags:
  137  31:AAB0  00                .db $00
  138  31:AAB1  00                .db $00
  139  31:AAB2  88                .db $88 ;monk
  140  31:AAB3  00                .db $00
  141                     
  142  31:AAB4  00                .db $00
  143  31:AAB5  00                .db $00
  144  31:AAB6  00                .db $00 ;hunter
  145  31:AAB7  20                .db $20 ;knight
  146                     
  147  31:AAB8  00                .db $00
  148  31:AAB9  40                .db $40 ;scholar
  149  31:AABA  00                .db $00
  150  31:AABB  00                .db $00
  151                     
  152  31:AABC  00                .db $00
  153  31:AABD  08                .db $08 ;martialist
  154  31:AABE  00                .db $00
  155  31:AABF  00                .db $00
  156                     
  157  31:AAC0  00 00 00          .db $00,$00,$00
  158  31:AAC3  10                .db $10 ;summoner
  159  31:AAC4  10                .db $10 ;sage
  160  31:AAC5  00                .db     $00     ;ninja
  161                     ;======================================================================================================
  162                             RESTORE_PC ff3_command_ex_begin
                0035              .bank   BANK(ff3_command_ex_begin)
                BBD5              .org    ff3_command_ex_begin
#[2]   ff3_hack_master.asm
   46                     
#[3]   ff3_item_window.asm
   47                                     .include "ff3_item_window.asm"  ;save
    1                     ; ff3_item_window.asm
    2                     ;
    3                     ; description:
    4                     ;       replaces entire item-window related codes
    5                     ;
    6                     ; version:
    7                     ;       0.12 (2006-11-12)
    8                     ;
    9                     ;======================================================================================================
   10  35:BBD5            ff3_itemWindow_begin:
   11                     
   12           DDAF      item_window_patch_begin = $adaf ;commandWindow_OnItemSelected
   13           6646      item_window_patch_end   = $b646 ;commandWindow_OnMagicSelected
   14                     
   15                             INIT_PATCH $35,item_window_patch_begin,item_window_patch_end
                0035              .bank   $35
                DDAF              .org    item_window_patch_begin
       35:DDAF                    .ds             ((item_window_patch_end) - (item_window_patch_begin))
                DDAF              .org    item_window_patch_begin
   16           BBD5              .org ff3_itemWindow_begin
   17                             ORIGINAL_ADDR item_window_patch_begin
   18                     ;----------------------------------------------------------------------------------------------------------     
   19                     ;global vars
   20                     ;shared with command window
   21           0052      iPlayer                 = $52   ;
   22           0059      pEquips                 = $59   ;
   23           005B      pPlayer                 = $5b   ;
   24           88CF      selectedAction  = $78cf ;
   25           CCE8      doesDrawActionName = $7ce8
   26                     ;------------------------------------------------------------------------------
   27           0062      row                             = $62
   28           0063      col                             = $63
   29           0066      windowLeft              = $66
   30           0067      mode                    = $67
   31           0068      lastRow                 = $68
   32           0069      lastCol                 = $69
   33           00C0      backpackItems   = $60c0
   34           AAF5      cachedItems             = $7af5
   35           BB3D      equipFlags              = $7b3d 
   36                     ;------------------------------------------------------------------------------
   37                     ;
   38           003E      removeId                = $3e           ;address must be $3e
   39           003F      removeCount             = $3f
   40           0040      equipId                 = $40           ;address must be $40
   41           0041      equipCount              = $41
   42           0042      removeIndex             = $42
   43           0043      equipIndex              = $43
   44           0044      removeFlag              = $44
   45           0045      equipFlag               = $45
   46                     ;==========================================================================================================
   47                     ;$35:adaf commandWindow_OnItemSelected()
   48                     ;       [in,out] u8 $52 : playerIndex
   49                     ;uses:
   50                     ;       u8 $62 : cursor row index (0-3), init : 0
   51                     ;       u8 $63 : cursor col index (0-7), init : 1
   52                     ;       u8 $65 : background no (used in scrolling function), init : 0
   53                     ;       u8 $66 : current window left (col index,equipWindow = 0), init : 1
   54                     ;       u8 $67 : indicates Nth selection  (0-1)
   55                     ;       u8 $68 : row index of 1st selection 
   56                     ;       u8 $69 : col index of 1st selection
   57                     ;       u8 $7afd[0x40] : items {id,count}
   58                     ;       u8 $7b3d[0x40] : equipflags (0 = cannot use/equip,mark 'x' next to name)
   59                     ;commandWindow_OnItemSelected:
   60  35:BBD5            commandWindow_OnItem:
   61           0010      .scrollX = $10
   62           0043      .counter = $43
   63  35:BBD5  20 C5 F8          jsr updateDmaPpuScrollSyncNmi
   64  35:BBD8  A9 00             lda #0
   65  35:BBDA  85 3D             sta <$3d        ;erase flag
   66  35:BBDC  20 B0 8E          jsr eraseWindow
   67                     
   68  35:BBDF  A9 78             lda #$78
   69  35:BBE1  85 10             sta <.scrollX
   70  35:BBE3  20 C5 F8          jsr updateDmaPpuScrollSyncNmi
   71                             
   72  35:BBE6  A9 00             lda #0
   73  35:BBE8  8D 73 75          sta $7573       ;erase flag
   74  35:BBEB  20 1F B1          jsr drawEquipWindow
   75                     
   76  35:BBEE  20 8D 9B          jsr setYtoOffset03
   77  35:BBF1  A2 00             ldx #0
   78  35:BBF3            .init_hands:
   79  35:BBF3  B1 59             lda [pEquips],y
   80  35:BBF5  9D F5 7A          sta $7af5,x
   81  35:BBF8  9D F7 7A          sta $7af7,x
   82  35:BBFB  C8                iny
   83  35:BBFC  B1 59             lda [pEquips],y
   84  35:BBFE  9D F6 7A          sta $7af6,x
   85  35:CC01  9D F8 7A          sta $7af8,x
   86  35:CC04  C8                iny
   87  35:CC05  E8                inx
   88  35:CC06  E8                inx
   89  35:CC07  E8                inx
   90  35:CC08  E8                inx
   91  35:CC09  E0 08             cpx #8
   92  35:CC0B  D0 E6             bne .init_hands
   93                             
   94  35:CC0D  A2 23             ldx #$23
   95  35:CC0F  A9 01             lda #1
   96  35:CC11            .init_flags:
   97  35:CC11  9D 3D 7B          sta equipFlags,x
   98  35:CC14  CA                dex
   99  35:CC15  10 FA             bpl .init_flags 
  100                             
  101  35:CC17  E8                inx     ;0
  102  35:CC18            .init_items:
  103  35:CC18  A9 00                     lda #0
  104  35:CC1A  85 20                     sta <$20
  105  35:CC1C  A9 94                     lda #$94
  106  35:CC1E  85 21                     sta <$21
  107  35:CC20  86 43                     stx <.counter
  108  35:CC22  BD C1 60                  lda backpackItems+1,x   ;count
  109  35:CC25  9D FE 7A                  sta cachedItems+9,x
  110  35:CC28  BD C0 60                  lda backpackItems,x             ;id
  111  35:CC2B  9D FD 7A                  sta cachedItems+8,x
  112                                     
  113  35:CC2E  C9 62                     cmp #$62        ;leather cap
  114  35:CC30  90 0A                     bcc .check_equip_valid_for_job
  115  35:CC32  C9 98                     cmp #$98        ;magical key
  116  35:CC34  90 0F                     bcc .cannot_use
  117  35:CC36  C9 C8                     cmp #$c8        ;magic 'flare'
  118  35:CC38  B0 0B                     bcs .cannot_use
  119  35:CC3A  90 10                     bcc .next
  120  35:CC3C                    .check_equip_valid_for_job:
  121                                             ;weapon or shield
  122  35:CC3C  85 18                             sta <$18
  123  35:CC3E  20 F9 B4                          jsr isPlayerAllowedToUseItem    ;$b8fd
  124  35:CC41  A5 1C                             lda <$1c
  125  35:CC43  D0 07                             bne .next
  126  35:CC45                    .cannot_use:    
  127  35:CC45  A5 43                     lda <.counter
  128  35:CC47  4A                        lsr a
  129  35:CC48  AA                        tax
  130  35:CC49  DE 41 7B                  dec equipFlags+4,x
  131  35:CC4C                    .next:
  132  35:CC4C  A6 43                     ldx <.counter
  133  35:CC4E  E8                        inx
  134  35:CC4F  E8                        inx
  135  35:CC50  E0 40                     cpx #$40
  136  35:CC52  D0 C4                     bne .init_items
  137                             
  138  35:CC54  A2 00             ldx #0
  139  35:CC56  86 3D             stx <$3d
  140  35:CC58            .init_window:
  141  35:CC58  86 43             stx <.counter
  142  35:CC5A  20 82 B1          jsr loadTileArrayForItemWindowColumn
  143  35:CC5D  A6 43             ldx <.counter
  144  35:CC5F  BD 2C AD          lda initWindowParams,x
  145  35:CC62  85 18             sta <$18
  146  35:CC64  E8                inx
  147  35:CC65  BD 2C AD          lda initWindowParams,x
  148  35:CC68  85 19             sta <$19
  149  35:CC6A  E8                inx
  150  35:CC6B  BD 2C AD          lda initWindowParams,x
  151  35:CC6E  85 1A             sta <$1a
  152  35:CC70  E8                inx
  153  35:CC71  86 43             stx <.counter
  154  35:CC73  20 38 8B          jsr draw8LineWindow
  155  35:CC76  A6 43             ldx <.counter
  156  35:CC78  E0 09             cpx #$9
  157  35:CC7A  D0 DC             bne .init_window
  158                             
  159  35:CC7C  A9 02             lda #2
  160  35:CC7E  85 55             sta <$55
  161  35:CC80  A9 01             lda #1
  162  35:CC82  85 1A             sta <$1a
  163  35:CC84  20 66 89          jsr loadCursor
  164                             
  165  35:CC87  A9 01             lda #1
  166  35:CC89  85 1A             sta <$1a
  167  35:CC8B  A9 F0             lda #$f0
  168  35:CC8D  85 1C             sta <$1c
  169  35:CC8F  85 1D             sta <$1d
  170  35:CC91  20 2E 89          jsr tileSprites2x2
  171                             
  172  35:CC94  A9 02             lda #2
  173  35:CC96  85 55             sta <$55
  174  35:CC98  A9 00             lda #0
  175  35:CC9A  85 1A             sta <$1a
  176  35:CC9C  20 66 89          jsr loadCursor
  177                     
  178  35:CC9F  A2 00             ldx #0
  179  35:CCA1  86 62             stx <$62        ;row
  180                             ;stx <$65       ;scroll toggle
  181  35:CCA3  86 67             stx <$67        ;mode
  182  35:CCA5  E8                inx
  183  35:CCA6  86 63             stx <$63        ;col
  184  35:CCA8  86 66             stx <$66        ;left
  185                     
  186  35:CCAA            itemWindowInputLoop:
  187  35:CCAA  20 85 81          jsr presentCharacter
  188  35:CCAD  20 AA FB          jsr getPad1Input
  189  35:CCB0  A5 12             lda <inputBits
  190  35:CCB2  F0 F6             beq itemWindowInputLoop
  191  35:CCB4  48                pha
  192  35:CCB5  20 79 9B          jsr requestSoundEffect18        ;9b79
  193  35:CCB8  68                pla
  194                     ;itemWindow_dispatchInput:
  195  35:CCB9  A6 63                     ldx <col
  196  35:CCBB  A4 62                     ldy <row
  197  35:CCBD  0A                        asl a
  198  35:CCBE  B0 4A                     bcs .OnRight
  199  35:CCC0  0A                        asl a
  200  35:CCC1  B0 30                     bcs .OnLeft
  201  35:CCC3  0A                        asl a
  202  35:CCC4  B0 1D                     bcs .OnDown
  203  35:CCC6  0A                        asl a
  204  35:CCC7  B0 0D                     bcs .OnUp
  205  35:CCC9  0A                        asl a
  206                                     ;bcs start
  207  35:CCCA  0A                        asl a
  208                                     ;bcs select
  209  35:CCCB  0A                        asl a
  210  35:CCCC  B0 05                     bcs .OnB
  211  35:CCCE  0A                        asl a
  212  35:CCCF  90 D9                     bcc itemWindowInputLoop ;($aeaa)
  213  35:CCD1            .OnA:
  214                                     ;jmp itemWindow_OnA
  215  35:CCD1  B0 62                     bcs itemWindow_OnA
  216  35:CCD3            .OnB:
  217  35:CCD3  4C E7 AE                  jmp itemWindow_OnB
  218  35:CCD6            .OnUp:  
  219  35:CCD6  98                        tya
  220  35:CCD7  F0 D1                     beq itemWindowInputLoop ;($aeaa)
  221  35:CCD9  E0 00                     cpx #$00
  222  35:CCDB  D0 03                     bne .nocheck_up
  223  35:CCDD  88                        dey
  224  35:CCDE  F0 CA                     beq itemWindowInputLoop
  225  35:CCE0                    .nocheck_up:
  226  35:CCE0  88                        dey
  227  35:CCE1  10 3D                     bpl .update             
  228  35:CCE3            .OnDown:
  229  35:CCE3  C0 03                     cpy #$03
  230  35:CCE5  F0 C3                     beq itemWindowInputLoop ;($aeaa)
  231  35:CCE7  E0 00                     cpx #$00
  232  35:CCE9  D0 05                     bne .nocheck_down
  233  35:CCEB  C8                        iny
  234  35:CCEC  C0 04                     cpy #$04
  235  35:CCEE  F0 BA                     beq itemWindowInputLoop ;($aeaa)
  236  35:CCF0                    .nocheck_down:
  237  35:CCF0  C8                        iny
  238  35:CCF1  10 2D                     bpl .update
  239  35:CCF3            .OnLeft:
  240  35:CCF3  8A                        txa
  241  35:CCF4  F0 B4                     beq itemWindowInputLoop
  242  35:CCF6  C5 66                     cmp <$66
  243  35:CCF8  D0 07                     bne .noscroll_left
  244  35:CCFA  20 52 B0                  jsr itemWindow_scrollLeft       ;$b362
  245  35:CCFD  A6 63                     ldx <col
  246  35:CCFF  A4 62                     ldy <row
  247  35:DD01                    .noscroll_left:
  248  35:DD01  CA                        dex
  249  35:DD02  D0 04                     bne .nocheck_left
  250  35:DD04  98                        tya
  251  35:DD05  09 01                     ora #1
  252  35:DD07  A8                        tay
  253  35:DD08                    .nocheck_left:
  254  35:DD08  D0 16                     bne .update     
  255  35:DD0A            .OnRight:
  256  35:DD0A  E0 08                     cpx #$08
  257  35:DD0C  F0 9C                     beq itemWindowInputLoop
  258  35:DD0E  A5 66                     lda <$66
  259  35:DD10  C9 07                     cmp #$07
  260  35:DD12  F0 0B                     beq .noscroll_right
  261  35:DD14  C5 63                     cmp <col
  262  35:DD16  F0 07                     beq .noscroll_right
  263  35:DD18  20 26 B0                  jsr itemWindow_scrollRight      ;$b2a7
  264  35:DD1B  E6 63                     inc <col
  265  35:DD1D  D0 07                     bne .moveOnly
  266  35:DD1F                    .noscroll_right:
  267  35:DD1F  E8                        inx
  268  35:DD20            .update:
  269  35:DD20  8A                        txa
  270  35:DD21  85 63                     sta <col
  271  35:DD23  98                        tya
  272  35:DD24  85 62                     sta <row
  273  35:DD26            .moveOnly:
  274  35:DD26  20 C1 B1                  jsr itemWindow_moveCursor
  275  35:DD29  4C AA AC                  jmp itemWindowInputLoop
  276                     ;----------------------------------------------------------------------------------------------------------
  277  35:DD2C  10 1E 01  initWindowParams:       DB      $10,$1e,1,      $1f,$8d,0,      $8e,$9c,0
       35:DD2F  1F 8D 00  
       35:DD32  8E 9C 00  
  278                     ;==========================================================================================================
  279                     ;itemWindow_OnA
  280                     ;------------------------------------------------------------------------------
  281                     ;       .org    $af4c
  282  35:DD35            itemWindow_OnA:
  283  35:DD35  A5 67             lda <mode
  284  35:DD37  D0 29             bne .second_item
  285  35:DD39  E6 67                     inc <mode
  286  35:DD3B  A5 62                     lda <row
  287  35:DD3D  85 68                     sta <lastRow
  288  35:DD3F  A5 63                     lda <col
  289  35:DD41  85 69                     sta <lastCol
  290  35:DD43  20 C1 B1                  jsr itemWindow_moveCursor
  291  35:DD46  A5 1D                     lda <$1d
  292  35:DD48  18                        clc
  293  35:DD49  69 04                     adc #4
  294  35:DD4B  85 1D                     sta <$1d
  295  35:DD4D  A9 01                     lda #1
  296  35:DD4F  85 1A                     sta <$1a
  297  35:DD51  20 2E 89                  jsr tileSprites2x2
  298  35:DD54  20 7D 9B                  jsr requestSoundEffect05        ;9b7d
  299  35:DD57  A2 10                     ldx #$10
  300  35:DD59            .present_loop:
  301  35:DD59  20 85 81                          jsr presentCharacter
  302  35:DD5C  CA                                dex
  303  35:DD5D  D0 FA                             bne .present_loop
  304  35:DD5F  4C AA AC                  jmp itemWindowInputLoop
  305  35:DD62            .second_item:
  306  35:DD62  A6 63             ldx <col
  307  35:DD64  A4 62             ldy <row
  308  35:DD66  E4 69             cpx <lastCol
  309  35:DD68  D0 07             bne .exchange_item
  310  35:DD6A  C4 68             cpy <lastRow
  311  35:DD6C  D0 03             bne .exchange_item
  312  35:DD6E  4C DD B1                  jmp itemWindow_OnUse
  313  35:DD71            .exchange_item:
  314  35:DD71  8A                txa
  315  35:DD72  D0 06             bne .check_lastcol
  316  35:DD74  A5 69             lda <lastCol
  317  35:DD76  D0 0C             bne .exchange_ok
  318  35:DD78  F0 04             beq .cannot_exchange
  319  35:DD7A            .check_lastcol:
  320  35:DD7A  A5 69             lda <lastCol
  321  35:DD7C  F0 06             beq .exchange_ok
  322  35:DD7E            .cannot_exchange:
  323  35:DD7E  20 81 9B          jsr $9b81
  324  35:DD81  4C AA AC          jmp itemWindowInputLoop
  325  35:DD84            .exchange_ok:
  326  35:DD84  A9 00             lda #0
  327  35:DD86  8D 08 74          sta $7408
  328  35:DD89  A9 01             lda #1
  329  35:DD8B  8D 09 74          sta $7409
  330  35:DD8E  E4 69             cpx <lastCol
  331  35:DD90  90 09             bcc .no_swap
  332  35:DD92  20 0E AF                  jsr swap_current_and_last
  333  35:DD95  EE 08 74                  inc $7408
  334  35:DD98  CE 09 74                  dec $7409
  335  35:DD9B            .no_swap:
  336  35:DD9B  A5 69             lda <lastCol
  337  35:DD9D  0A                asl a
  338  35:DD9E  0A                asl a
  339  35:DD9F  18                clc             ;not neccesary
  340  35:DDA0  65 68             adc <lastRow
  341  35:DDA2  85 45             sta <equipFlag
  342  35:DDA4  0A                asl a
  343  35:DDA5  85 43             sta <equipIndex
  344  35:DDA7  A6 45             ldx <equipFlag
  345  35:DDA9  BD 3D 7B          lda equipFlags,x
  346  35:DDAC  D0 0E             bne .exchangeable
  347  35:DDAE            .fail:
  348  35:DDAE  20 81 9B                  jsr $9b81
  349  35:DDB1  AD 08 74                  lda $7408
  350  35:DDB4  F0 03                     beq .no_swap_restore
  351  35:DDB6  20 0E AF                          jsr swap_current_and_last
  352  35:DDB9            .no_swap_restore:
  353  35:DDB9  4C AA AC                  jmp itemWindowInputLoop
  354  35:DDBC            .exchangeable:
  355  35:DDBC  A6 43             ldx <equipIndex
  356  35:DDBE  BD F5 7A          lda cachedItems,x
  357  35:DDC1  B0 EB             bcs .fail
  358  35:DDC3  85 40             sta <equipId
  359  35:DDC5  E8                inx
  360  35:DDC6  BD F5 7A          lda cachedItems,x
  361  35:DDC9  85 41             sta <equipCount
  362                             
  363  35:DDCB  A5 63             lda <col
  364  35:DDCD  0A                asl a
  365  35:DDCE  0A                asl a
  366  35:DDCF  18                clc
  367  35:DDD0  65 62             adc <row
  368  35:DDD2  85 44             sta <removeFlag
  369  35:DDD4  0A                asl a
  370  35:DDD5  85 42             sta <removeIndex
  371                             
  372  35:DDD7  AA                tax
  373  35:DDD8  BD F5 7A          lda cachedItems,x
  374  35:DDDB  85 3E             sta <removeId
  375  35:DDDD  E8                inx
  376  35:DDDE  BD F5 7A          lda cachedItems,x
  377  35:DDE1  85 3F             sta <removeCount
  378                     
  379                             ;jsr $b242      ;checks 2-handed weapon?
  380  35:DDE3  20 F1 AF          jsr isHandFreeForItem
  381  35:DDE6  B0 C6             bcs .fail
  382  35:DDE8  A5 40             lda <equipId
  383  35:DDEA  C5 3E             cmp <removeId
  384  35:DDEC  D0 2C             bne .different_item
  385  35:DDEE  C9 00                     cmp #0
  386  35:DDF0  F0 BC                     beq .fail
  387  35:DDF2  A9 00                     lda #0
  388  35:DDF4  A6 42                     ldx <removeIndex
  389  35:DDF6  9D F5 7A                  sta cachedItems,x
  390  35:DDF9  E8                        inx
  391  35:DDFA  9D F5 7A                  sta cachedItems,x
  392  35:DDFD  A6 44                     ldx <removeFlag
  393  35:DDFF  A9 01                     lda #1
  394  35:EE01  9D 3D 7B                  sta equipFlags,x
  395  35:EE04  A6 43                     ldx <equipIndex
  396  35:EE06  E8                        inx
  397  35:EE07  18                        clc
  398  35:EE08  A5 3F                     lda <removeCount
  399  35:EE0A  65 41                     adc <equipCount
  400  35:EE0C  C9 64                     cmp #100
  401  35:EE0E  90 02                     bcc .under_100
  402  35:EE10  A9 63                             lda #99
  403  35:EE12            .under_100:
  404  35:EE12  9D F5 7A                  sta cachedItems,x
  405  35:EE15  8A                        txa
  406  35:EE16  48                        pha
  407  35:EE17  4C 53 AE                  jmp .copyback    
  408  35:EE1A            .different_item:
  409  35:EE1A  A4 41             ldy <equipCount
  410  35:EE1C  C9 00             cmp #0
  411  35:EE1E  F0 2F             beq .pick_result_empty
  412  35:EE20  C9 4F             cmp #$4f        ;wooden arrow
  413  35:EE22  90 0C             bcc .not_arrow
  414  35:EE24  C9 57             cmp #$57        ;medusa arrow
  415  35:EE26  B0 08             bcs .not_arrow
  416  35:EE28            .arrow:
  417                             ;min(equipcount,20)
  418  35:EE28  C0 15             cpy #21
  419  35:EE2A  90 23             bcc .pick_result_empty
  420  35:EE2C  A0 14             ldy #20
  421  35:EE2E  D0 06             bne .exchange
  422  35:EE30            .not_arrow:
  423  35:EE30  C0 01             cpy #1
  424  35:EE32  F0 1B             beq .pick_result_empty
  425  35:EE34  A0 01             ldy #1
  426  35:EE36            .exchange:
  427  35:EE36  A6 3E             ldx <removeId
  428  35:EE38  F0 15             beq .pick_result_empty
  429           0025      .count = $25
  430  35:EE3A  84 25             sty <.count
  431  35:EE3C  20 75 AF          jsr getIndexToPutRemovedItem
  432  35:EE3F  90 03             bcc .can_put
  433  35:EE41  4C AE AD          jmp .fail
  434  35:EE44            .can_put:       
  435  35:EE44  A5 40             lda <equipId
  436  35:EE46  A4 25             ldy <.count
  437  35:EE48  20 FD AE          jsr doExchange
  438  35:EE4B  48                pha     ;col index
  439  35:EE4C  4C 53 AE          jmp .copyback
  440  35:EE4F            .pick_result_empty:
  441                             ;here already a = equipid,y = count
  442  35:EE4F  20 FD AE          jsr doExchange
  443  35:EE52  48                pha     ;col index
  444  35:EE53            .swap_flag:
  445           0000              .IFNDEF CONTINUE_ON_EQUIP_CHANGE
  456                             .ENDIF
  457                     ;here originally $b131          
  458                     ;       .org $b131
  459  35:EE53            .copyback:      
  460  35:EE53  A2 3F             ldx #$3f
  461  35:EE55                    .copyloop:
  462  35:EE55  BD FD 7A                  lda cachedItems+8,x
  463  35:EE58  9D C0 60                  sta backpackItems,x
  464  35:EE5B  CA                        dex
  465  35:EE5C  10 F7                     bpl .copyloop
  466                     
  467                     ;$b13e:         
  468  35:EE5E  20 8D 9B          jsr $9b8d       ;set y to offset 3
  469  35:EE61  AD F7 7A          lda $7af7
  470  35:EE64  91 59             sta [pEquips],y
  471  35:EE66  C8                iny
  472  35:EE67  AD F8 7A          lda $7af8
  473  35:EE6A  91 59             sta [pEquips],y
  474  35:EE6C  C8                iny
  475                             
  476  35:EE6D  AD FB 7A          lda $7afb
  477  35:EE70  91 59             sta [pEquips],y
  478  35:EE72  C8                iny
  479  35:EE73  AD FC 7A          lda $7afc
  480  35:EE76  91 59             sta [pEquips],y
  481  35:EE78  C8                iny
  482  35:EE79  20 7D 9B          jsr requestSoundEffect05
  483  35:EE7C  AD 08 74          lda $7408
  484  35:EE7F  F0 03             beq .no_swap_restore_req
  485  35:EE81  20 0E AF                  jsr swap_current_and_last
  486  35:EE84            .no_swap_restore_req:
  487  35:EE84  68                pla     ;updated col index
  488  35:EE85  4A                lsr a
  489  35:EE86  4A                lsr a
  490  35:EE87  4A                lsr a
  491  35:EE88  48                pha
  492                             
  493  35:EE89  A6 63             ldx <col
  494  35:EE8B  D0 10             bne .not_in_equipWindow
  495  35:EE8D  20 1A B1                  jsr drawEquipWindowNoErase      ;$35:b5f9
  496  35:EE90  68                        pla
  497  35:EE91  C9 03                     cmp #3
  498  35:EE93  B0 27                     bcs .finish
  499  35:EE95  AA                                tax
  500  35:EE96  CA                                dex
  501  35:EE97  20 80 B0                          jsr drawItemWindowColumn        ;subsituate jsr $b601
  502  35:EE9A  4C BC AE                          jmp .finish     
  503  35:EE9D            .not_in_equipWindow:
  504  35:EE9D  CA                        dex     ;based equip-window => based item0
  505  35:EE9E  20 80 B0                  jsr drawItemWindowColumn
  506  35:EEA1  68                        pla
  507  35:EEA2  AA                        tax     ;updated col
  508  35:EEA3  18                        clc
  509  35:EEA4  69 02                     adc #2
  510  35:EEA6  38                        sec
  511  35:EEA7  E5 66                     sbc <windowLeft ;a = (col - 1) - left + 3
  512  35:EEA9  30 08                     bmi .check_equip_redraw ; (col + 2) - left < 0 : col < left - 2
  513  35:EEAB  C9 05                     cmp #5
  514  35:EEAD  B0 04                     bcs .check_equip_redraw ; col + 2 - left - 5 >= 0  col >= left + 3
  515  35:EEAF  CA                                dex     
  516  35:EEB0  20 80 B0                          jsr drawItemWindowColumn        ;subsituate jsr $b601
  517  35:EEB3                    .check_equip_redraw:
  518  35:EEB3  A5 63                     lda <col
  519  35:EEB5  C9 03                     cmp #3
  520  35:EEB7  B0 03                     bcs .finish
  521  35:EEB9  20 1A B1                          jsr drawEquipWindowNoErase
  522                     
  523  35:EEBC            .finish:
  524  35:EEBC  20 26 80          jsr dispatchBattleFunction_05   ;$8026 => recalcParams
  525           0000              .IF CONTINUE_ON_EQUIP_CHANGE
  526  35:EEBF  4C EB AE                  jmp itemWindow_cancel2nd                        
  527                             .ENDIF  
  528                     
  529                     ; itemWindow_OnB will jump to here
  530  35:EEC2            itemWindow_closeAndKeepCurrentPlayer:   
  531  35:EEC2  C6 52             dec <iPlayer
  532                     ; useItem will jump to here
  533                     ;$b198
  534  35:EEC4            closeItemWindow:
  535  35:EEC4  20 B0 8E          jsr eraseWindow ;$34:8eb0();
  536  35:EEC7  A9 00             lda #0
  537  35:EEC9  85 10             sta <$10
  538  35:EECB  A5 08             lda <$08
  539  35:EECD  29 FE             and #$fe
  540  35:EECF  85 08             sta <$08
  541  35:EED1  20 C5 F8          jsr updateDmaPpuScrollSyncNmi ;$3f:f8c5();
  542  35:EED4  A9 00             lda #0
  543  35:EED6  85 18             sta <$18
  544  35:EED8  20 DF 8A          jsr clearSprites2x2      ;
  545  35:EEDB  A9 01             lda #1
  546  35:EEDD  85 18             sta <$18
  547  35:EEDF  20 DF 8A          jsr clearSprites2x2
  548  35:EEE2  E6 52             inc <iPlayer
  549                             ;causes window-erase bug
  550                             ;$b1d0: dispatchBattleCommand(5); ;$34:8026();  
  551  35:EEE4  A9 00             lda #0
  552                             RET_TO_GET_COMMAND_INPUT
       35:EEE6  60                rts
  553                             ;jmp getCommandInput_next       ;$99fd
  554                     
  555                     ;$b198:
  556                     ;[in,out] u8 $67 : mode (0 = 1st,1=2nd selection)
  557  35:EEE7            itemWindow_OnB:
  558  35:EEE7  A5 67             lda <mode
  559  35:EEE9  F0 D7             beq itemWindow_closeAndKeepCurrentPlayer
  560  35:EEEB            itemWindow_cancel2nd:   
  561  35:EEEB  C6 67                     dec <mode
  562  35:EEED  A9 01                     lda #1
  563  35:EEEF  85 1A                     sta <$1a
  564  35:EEF1  A9 F0                     lda #$f0
  565  35:EEF3  85 1C                     sta <$1c
  566  35:EEF5  85 1D                     sta <$1d
  567  35:EEF7  20 2E 89                  jsr tileSprites2x2
  568  35:EEFA  4C AA AC                  jmp itemWindowInputLoop ;$aeaa
  569                     ;----------------------------------------------------------------------------------------------------------
  570                     ;utilities
  571  35:EEFD            doExchange:
  572                     ;[in] y = counttopick, a = id
  573                     ;[out] a = offset to removed item's count
  574  35:EEFD  20 23 AF          jsr pickAndEquipItem
  575  35:FF00  20 75 AF          jsr getIndexToPutRemovedItem
  576  35:FF03  B0 08             bcs .itemfull
  577  35:FF05  A5 3E             lda <removeId
  578  35:FF07  A4 3F             ldy <removeCount
  579  35:FF09  20 4D AF          jsr putItem
  580  35:FF0C  8A                txa
  581  35:FF0D            .itemfull:      
  582  35:FF0D  60                rts
  583  35:FF0E            swap_current_and_last:
  584  35:FF0E  A5 62             lda <row
  585  35:FF10  48                pha
  586  35:FF11  A5 68             lda <lastRow
  587  35:FF13  85 62             sta <row
  588  35:FF15  68                pla
  589  35:FF16  85 68             sta <lastRow
  590  35:FF18            swap_col:
  591  35:FF18  A5 63             lda <col
  592  35:FF1A  48                pha
  593  35:FF1B  A5 69             lda <lastCol
  594  35:FF1D  85 63             sta <col
  595  35:FF1F  68                pla
  596  35:FF20  85 69             sta <lastCol
  597  35:FF22  60                rts
  598                     ;----------------------------------------------------------------------------------------------------------     
  599  35:FF23            pickAndEquipItem:       ;y : countToPick
  600  35:FF23  A6 43             ldx <equipIndex
  601                             ;dey
  602  35:FF25  98                tya
  603  35:FF26  49 FF             eor #$ff        ;NOT
  604  35:FF28  18                clc
  605  35:FF29  65 41             adc <equipCount
  606                             ;here A = equipCount - pickCount - 1
  607  35:FF2B  90 08             bcc .pickAll    
  608  35:FF2D  E8                inx
  609  35:FF2E  69 00             adc #0  ;add carry (here always 1)
  610                             ;iny
  611  35:FF30  9D F5 7A          sta cachedItems,x       ;update count
  612  35:FF33  10 0B             bpl .putEquip
  613  35:FF35            .pickAll:
  614  35:FF35  A9 00             lda #0
  615  35:FF37  9D F5 7A          sta cachedItems,x
  616  35:FF3A  E8                inx
  617  35:FF3B  9D F5 7A          sta cachedItems,x
  618           0000              .IF UPDATE_FLAGS
  622                             .ENDIF
  623  35:FF3E  A4 41             ldy <equipCount
  624  35:FF40            .putEquip:
  625  35:FF40  A6 42             ldx <removeIndex
  626  35:FF42  A5 40             lda <equipId    
  627  35:FF44  9D F5 7A          sta cachedItems,x
  628  35:FF47  E8                inx
  629  35:FF48  98                tya     ;count
  630  35:FF49  9D F5 7A          sta cachedItems,x
  631  35:FF4C  60                rts
  632                     ;----------------------------------------------------------------------------------------------------------     
  633  35:FF4D            putItem:
  634                     ;[in] a:itemid, x:index, y:count
  635                     ;[out] x : offset to put item's count
  636  35:FF4D  DD F5 7A          cmp cachedItems,x
  637  35:FF50  D0 08             bne .putToFree
  638                             ;there is same item,stack it
  639  35:FF52  E8                inx
  640  35:FF53  98                tya
  641  35:FF54  18                clc
  642  35:FF55  7D F5 7A          adc cachedItems,x
  643  35:FF58  10 05             bpl .storeCount
  644  35:FF5A            .putToFree
  645  35:FF5A  9D F5 7A          sta cachedItems,x       ;id
  646           0000              .IF UPDATE_FLAGS
  655                             .ENDIF
  656  35:FF5D  E8                inx
  657  35:FF5E  98                tya
  658  35:FF5F            .storeCount:
  659  35:FF5F  9D F5 7A          sta cachedItems,x       ;count
  660  35:FF62  60                rts
  661                     ;----------------------------------------------------------------------------------------------------------
  662           0048      findItem_notFound = $48 
  663  35:FF63            findItem:       ;a : findId     
  664           0024      .idToFind = $24
  665  35:FF63  A2 08             ldx #8
  666  35:FF65  85 24             sta <.idToFind
  667  35:FF67            .find_loop:
  668  35:FF67  BD F5 7A                  lda cachedItems,x
  669  35:FF6A  C5 24                     cmp <.idToFind
  670  35:FF6C  F0 06                     beq .found
  671  35:FF6E  E8                        inx
  672  35:FF6F  E8                        inx
  673  35:FF70  E0 48                     cpx #findItem_notFound 
  674  35:FF72  D0 F3                     bne .find_loop
  675  35:FF74            .found:         
  676  35:FF74  60                rts
  677                     ;----------------------------------------------------------------------------------------------------------
  678  35:FF75            getIndexToPutRemovedItem:
  679                     ;[out] bool carry : 0=putable ,x = index
  680  35:FF75  A5 3E             lda <removeId
  681  35:FF77  20 63 AF          jsr findItem
  682  35:FF7A  E0 48             cpx #findItem_notFound
  683  35:FF7C  D0 08             bne .checkCount
  684  35:FF7E            .tryFreeSpace:  
  685  35:FF7E  A9 00             lda #0
  686  35:FF80  20 63 AF          jsr findItem
  687  35:FF83  E0 48             cpx #findItem_notFound
  688  35:FF85  60                rts
  689  35:FF86            .checkCount:
  690  35:FF86  E8                inx
  691  35:FF87  A5 3F             lda <removeCount
  692  35:FF89  18                clc
  693  35:FF8A  7D F5 7A          adc cachedItems,x
  694  35:FF8D  CA                dex
  695  35:FF8E  C9 64             cmp #100
  696  35:FF90  60                rts
  697                     ;==========================================================================================================
  698                     ;       .org $b1d8
  699                     ;       .incbin "ff3_$35_b1d8-b4f6.bin"
  700                     ;       .org $b1d8
  701                     
  702  35:FF91            loadTileArrayOfItemProps:       
  703                     ;       [in] u8 $34[2][4] : items
  704                     ;       [in] u16 $43 : ptrToDestTileArray
  705           0034      .items = $34
  706           003C      .counter = $3c
  707  35:FF91  20 54 97          jsr initTileArrayStorage        ;$9754  ;fill_7200to73ff_ff();
  708  35:FF94  A9 00             lda #0
  709  35:FF96  85 3C             sta <.counter
  710  35:FF98            .loop:
  711  35:FF98  A2 0D                     ldx #$0d
  712  35:FF9A  20 49 A5                  jsr initString  ;$35:a549
  713  35:FF9D  A6 3C                     ldx <.counter
  714  35:FF9F  B5 34                     lda <.items,x
  715  35:FFA1  C9 FF                     cmp #$ff
  716  35:FFA3  D0 04                     bne .check_string
  717  35:FFA5  A9 1A                             lda #$0d * 2
  718  35:FFA7  D0 3A                             bne .offset_line
  719  35:FFA9                    .check_string:
  720  35:FFA9  85 1A                     sta <$1a
  721  35:FFAB  BD 00 74                  lda $7400,x
  722  35:FFAE  D0 05                     bne .load_string
  723  35:FFB0  A9 73                             lda #$73
  724  35:FFB2  8D D7 7A                          sta stringCache ;$7ad7
  725  35:FFB5                    .load_string:
  726  35:FFB5  A9 88                     lda #$88
  727  35:FFB7  85 19                     sta <$19
  728  35:FFB9  B5 35                     lda <.items+1,x
  729  35:FFBB  48                        pha
  730  35:FFBC  A9 00                     lda #0
  731  35:FFBE  AA                        tax
  732  35:FFBF  E8                        inx
  733  35:FFC0  85 18                     sta <$18
  734  35:FFC2  A5 1A                     lda <$1a
  735  35:FFC4  20 09 A6                  jsr loadString
  736                                     
  737  35:FFC7  A9 C8                     lda #$c8
  738  35:FFC9  8D E1 7A                  sta stringCache+10
  739           0000              .IFNDEF USE_ITOA8       
  749                             .ELSE
  750  35:FFCC  68                        pla     ;count
  751  35:FFCD  20 25 A6                  jsr itoa_8
  752  35:FFD0  A5 1B                     lda <$1b
  753  35:FFD2  8D E2 7A                  sta stringCache+11
  754  35:FFD5  A5 1C                     lda <$1c
  755  35:FFD7  8D E3 7A                  sta stringCache+12
  756                             .ENDIF  
  757  35:FFDA  A9 0D                     lda #$0d
  758  35:FFDC  85 18                     sta <$18
  759  35:FFDE  20 6A 96                  jsr strToTileArray
  760  35:FFE1  A9 0D                     lda #$0d
  761  35:FFE3                    .offset_line:
  762  35:FFE3  20 58 A5                  jsr offsetTilePtr       ;$35:a559
  763  35:FFE6  E6 3C                     inc <.counter
  764  35:FFE8  E6 3C                     inc <.counter
  765  35:FFEA  A5 3C                     lda <.counter
  766  35:FFEC  C9 08                     cmp #8
  767  35:FFEE  D0 A8             bne .loop
  768  35:FFF0  60                rts
  769                     ;==========================================================================================================
  770                     ;$35:b242 isHandFreeForItem
  771                     ;       [in] itemid $3e : toRemove
  772                     ;       [in] itemid $40 : toEquip
  773                     ;       [in] itemid $7af5 : righthand
  774                     ;       [in] itemid $7af9 : lefthand
  775                     ;       [out] bool carry : 0:ok 1:bad combination
  776                     ;       original:65h bytes      
  777                     ;(id)
  778                     ;00             o       o       o       o       o       o
  779                     ;01-45          o       x       x       x       o
  780                     ;46-49                  x       x       x       x
  781                     ;4a-4e                          x       o       x
  782                     ;4f-57                                  x       x
  783                     ;58-64                                          o
  784                     ;       .ORG $b242
  785                     ;       .DS $65+$172            ;init original region
  786                     ;
  787  35:FFF1            isHandFreeForItem:
  788           003E      .toRemove = $3e
  789           0040      .toEquip = $40
  790           AAF7      .right = $7af5+2        ;original version uses $7af5,but it is not updated through equip change
  791           AAFB      .left = $7af9+2         ;
  792  35:FFF1  AD F7 7A          lda .right
  793  35:FFF4  C5 3E             cmp <.toRemove
  794  35:FFF6  D0 03             bne .get_mask
  795  35:FFF8  AD FB 7A                  lda .left
  796  35:FFFB            .get_mask:
  797  35:FFFB  20 14 B0          jsr idToKind
  798  35:FFFE  BD 0D B0          lda .masks,x
  799  35:0001  48                pha
  800  35:0002  A5 40             lda <.toEquip
  801  35:0004  20 14 B0          jsr idToKind
  802  35:0007  68                pla
  803  35:0008            .shift_loop:
  804  35:0008  0A                        asl a
  805  35:0009  CA                        dex
  806  35:000A  10 FC             bpl .shift_loop
  807  35:000C  60                rts
  808  35:000D            .masks: ;0=ok 1:no
  809  35:000D  03                .DB             %00000011       ;00
  810  35:000E  3B                .DB             %00111011       ;01-45
  811  35:000F  7F                .DB             %01111111       ;46-49
  812  35:0010  77                .DB             %01110111       ;4a-4e
  813  35:0011  6F                .DB             %01101111       ;4f-57
  814  35:0012  3B                .DB             %00111011       ;58-64
  815  35:0013  FF                .DB             %11111111       ;65-
  816                     ;---------------------------------------------------------------------------------------------------------
  817  35:0014            idToKind:       ;a = id,x = result
  818  35:0014  A2 05             ldx #5
  819  35:0016            .loop:
  820  35:0016  DD 20 B0                  cmp .bounds,x
  821  35:0019  B0 03                     bcs .return
  822  35:001B  CA                        dex
  823  35:001C  10 F8             bpl .loop
  824  35:001E            .return:
  825  35:001E  E8                inx
  826  35:001F  60                rts
  827  35:0020            .bounds:
  828  35:0020  01 46 4A          .db     $01,$46,$4a,$4f,$58,$65
       35:0023  4F 58 65  
  829                     ;==========================================================================================================
  830                     ;original:$b2a7
  831                     ;scrolling functions
  832                     ;       [in,out] u8 $65 : background no
  833                     ;       [in,out] u8 $66 : left(colIndex,0-7)
  834                     ;       [in] u8 $69 : col index of 1st selection (if avail)
  835                     ;       [in] u8 $67 : mode
  836                     ;       .ORG $b2a7
  837           0078      itemWindowScrollX       = 120
  838           0028      itemWindowDx            = 120/3 ;orig : $14
  839  35:0026            itemWindow_scrollRight
  840  35:0026  A5 66             lda <windowLeft
  841  35:0028  C9 06             cmp #6
  842  35:002A  B0 0F             bcs .do_scroll
  843  35:002C  69 02                     adc #2
  844  35:002E  48                        pha
  845  35:002F  C9 07                     cmp #7
  846  35:0031  90 03                     bcc .draw_next_column
  847  35:0033  20 0B 8F                          jsr eraseFromLeftBottom0Bx0A    ;//$34:8f0b
  848  35:0036            .draw_next_column:      
  849  35:0036  68                        pla
  850  35:0037  AA                        tax
  851  35:0038  20 80 B0                  jsr drawItemWindowColumn
  852  35:003B            .do_scroll:
  853  35:003B  A5 66             lda <windowLeft
  854  35:003D  C9 07             cmp #7
  855  35:003F  F0 09             beq .update_cursor
  856  35:0041  E6 66                     inc <windowLeft
  857  35:0043  A9 78                     lda #itemWindowScrollX
  858  35:0045  A0 28                     ldy #itemWindowDx
  859  35:0047  20 BB B0                  jsr scrollItemWindow
  860  35:004A            .update_cursor:
  861  35:004A  A5 67             lda <mode
  862  35:004C  F0 03             beq .return
  863  35:004E  20 E5 B0                  jsr update1stCursor
  864  35:0051            .return:
  865  35:0051  60                rts
  866                     ;---------------------------------------------------------------------------------------------------------      
  867                     ;original:$b362
  868                     ;       .ORG $b362
  869  35:0052            itemWindow_scrollLeft:
  870                     ;       [in,out] u8 $65 : background no
  871                     ;       [in,out] u8 $66 : left(colIndex,0-7)
  872                     ;       [in] u8 $69 : col index of 1st selection (if avail)
  873                     ;       [in] u8 $67 : mode
  874  35:0052  A5 66             lda <windowLeft
  875  35:0054  C9 02             cmp #2
  876  35:0056  90 13             bcc .do_scroll
  877  35:0058  D0 0B             bne .draw_next_column
  878  35:005A  A9 00                     lda #0
  879  35:005C  8D 73 75                  sta $7573
  880  35:005F  20 1F B1                  jsr drawEquipWindow
  881  35:0062  4C 6B B0                  jmp .do_scroll
  882  35:0065            .draw_next_column:      
  883                                     ;always sec
  884  35:0065  E9 03                     sbc #3
  885  35:0067  AA                        tax
  886  35:0068  20 80 B0                  jsr drawItemWindowColumn
  887  35:006B            .do_scroll:
  888  35:006B  A5 66             lda <windowLeft
  889  35:006D  F0 09             beq .update_cursor
  890  35:006F  C6 66                     dec <windowLeft
  891  35:0071  A9 88                     lda #-itemWindowScrollX
  892  35:0073  A0 D8                     ldy #-itemWindowDx
  893  35:0075  20 BB B0                  jsr scrollItemWindow
  894  35:0078            .update_cursor:
  895  35:0078  A5 67             lda <mode
  896  35:007A  F0 03             beq .return
  897  35:007C  20 E5 B0                  jsr update1stCursor
  898  35:007F            .return:
  899  35:007F  60                rts                             
  900                     ;---------------------------------------------------------------------------------------------------------
  901  35:0080            drawItemWindowColumn:
  902                     ;       [in] x : colIndex (equip=-1)
  903           0018      .left = $18
  904           0019      .right = $19
  905           001A      .drawFlag = $1a
  906           003D      .firstItemOffset = $3d
  907                     ;.windowPos = $b636
  908  35:0080  8A                txa
  909  35:0081  0A                asl a
  910  35:0082  48                pha
  911  35:0083  0A                asl a
  912  35:0084  0A                asl a
  913  35:0085  85 3D             sta <.firstItemOffset
  914  35:0087  20 82 B1          jsr loadTileArrayForItemWindowColumn    ;$34:b48b
  915  35:008A  68                pla
  916  35:008B  AA                tax
  917  35:008C  F0 08             beq .left_required
  918                     ;check right
  919  35:008E  E0 0E             cpx #14 ;7*2
  920  35:0090  F0 08             beq .right_required
  921  35:0092  A9 00             lda #0
  922  35:0094  F0 06             beq .store_flag
  923  35:0096            .left_required:
  924  35:0096  A9 01             lda #1
  925  35:0098  D0 02             bne .store_flag
  926  35:009A            .right_required:        
  927  35:009A  A9 02             lda #2
  928  35:009C            .store_flag
  929  35:009C  85 1A             sta <.drawFlag          
  930  35:009E  BD AB B0          lda .windowPos,x
  931  35:00A1  85 18             sta <.left
  932  35:00A3  BD AC B0          lda .windowPos+1,x
  933  35:00A6  85 19             sta <.right
  934                             
  935  35:00A8  4C 38 8B          jmp draw8LineWindow     ;$8b38
  936  35:00AB            .windowPos:
  937  35:00AB  10 1E             .db     $10,$1E
  938  35:00AD  1F 8D             .db     $1F,$8D
  939  35:00AF  8E 9C             .db     $8E,$9C
  940  35:00B1  9D 0B             .db $9D,$0B
  941  35:00B3  0C 1A             .db $0C,$1A
  942  35:00B5  1B 89             .db $1B,$89
  943  35:00B7  8A 98             .db $8A,$98
  944  35:00B9  99 07             .db $99,$07     
  945                     ;---------------------------------------------------------------------------------------------------------      
  946  35:00BB            scrollItemWindow:
  947                     ;       [in] s8 a : scrollX
  948                     ;       [in] s8 y : dx
  949           0064      .scrollTo = $64
  950           0065      .invert = $65
  951                     ;.windowLeft = $66
  952           0008      .ppuFlag1 = $08
  953           0010      .currentX = $10
  954  35:00BB  AA                tax
  955  35:00BC  30 04             bmi .scroll_left
  956  35:00BE  A9 00             lda #%00000000
  957  35:00C0  F0 02             beq .store_invert
  958  35:00C2            .scroll_left:
  959  35:00C2  A9 01             lda #%00000001
  960  35:00C4            .store_invert:
  961  35:00C4  85 65             sta <.invert
  962  35:00C6  8A                txa
  963  35:00C7  18                clc
  964  35:00C8  65 10             adc <.currentX
  965  35:00CA  85 64             sta <.scrollTo
  966  35:00CC            .scroll_loop:
  967  35:00CC  20 C5 F8                  jsr updateDmaPpuScrollSyncNmi   ;$3f:f8c5 (y is unchanged)
  968  35:00CF  98                        tya
  969  35:00D0  18                        clc
  970  35:00D1  65 10                     adc <.currentX
  971  35:00D3  85 10                     sta <.currentX
  972  35:00D5  2A                        rol     a       ;take carry
  973  35:00D6  29 01                     and #1  ;mask
  974  35:00D8  45 65                     eor <.invert    ;invert if scroll to left
  975                                     ;a = 01 if overflow
  976  35:00DA  45 08                     eor <.ppuFlag1
  977  35:00DC  85 08                     sta <.ppuFlag1
  978  35:00DE  A5 10                     lda <.currentX
  979  35:00E0  C5 64                     cmp <.scrollTo
  980  35:00E2  D0 E8             bne .scroll_loop
  981  35:00E4  60                rts
  982                     ;---------------------------------------------------------------------------------------------------------
  983  35:00E5            update1stCursor:
  984                             ;if (lastCol == left || lastCol == left + 1)
  985  35:00E5  A6 66             ldx <windowLeft
  986  35:00E7  E4 69             cpx <lastCol
  987  35:00E9  F0 09             beq .move_cursor
  988  35:00EB  E8                inx
  989  35:00EC  E4 69             cpx <lastCol
  990  35:00EE  D0 18             bne .hide_cursor
  991  35:00F0  A9 84             lda #$84
  992  35:00F2  D0 02             bne .store_x
  993  35:00F4            .move_cursor:
  994  35:00F4  A9 0C             lda #$0c
  995  35:00F6            .store_x:       
  996  35:00F6  85 1D             sta <$1d        ;#$84 or #0c
  997  35:00F8  A5 68             lda <lastRow
  998  35:00FA  20 3E FD          jsr $fd3e       ;asl * 4
  999  35:00FD  69 A8             adc #$a8
 1000  35:00FF  85 1C             sta <$1c
 1001  35:1101  A9 01             lda #1
 1002  35:1103  85 1A             sta <$1a
 1003  35:1105  4C 2E 89          jmp tileSprites2x2
 1004                             ;jsr tileSprites2x2
 1005                             ;rts
 1006  35:1108            .hide_cursor:   
 1007  35:1108  A5 1C             lda <$1c
 1008  35:110A  48                pha
 1009  35:110B  A9 F0             lda #$f0
 1010  35:110D  85 1C             sta <$1c
 1011  35:110F  A9 01             lda #1
 1012  35:1111  85 1A             sta <$1a
 1013  35:1113  20 2E 89          jsr tileSprites2x2
 1014  35:1116  68                pla
 1015  35:1117  85 1C             sta <$1c
 1016  35:1119  60                rts     
 1017                     ;$b419:
 1018                     ;==========================================================================================================
 1019                     ;$35:b5f9 drawEquipWindowNoErase
 1020  35:111A            drawEquipWindowNoErase:
 1021           5573      .eraseFlag = $7573      
 1022  35:111A  A9 FF             lda #$ff
 1023  35:111C  8D 73 75          sta .eraseFlag
 1024                             ;jmp drawEquipWindow
 1025                     ;==========================================================================================================
 1026                     ;$35:b419 drawEquipWindow
 1027                     ;       [in] u16 $59 : ptrToEquips ($6200)
 1028                     ;       [in] bool $7573 : eraseFlag 
 1029  35:111F            drawEquipWindow:
 1030           0034      .items = $34
 1031  35:111F  A2 07             ldx #7
 1032  35:1121            .initloop:
 1033  35:1121  A9 01                     lda #1
 1034  35:1123  9D 00 74                  sta $7400,x
 1035  35:1126  A9 FF                     lda #$ff
 1036  35:1128  95 34                     sta <.items,x
 1037  35:112A  CA                        dex
 1038  35:112B  10 F4                     bpl .initloop
 1039  35:112D  20 41 A5          jsr getPlayerOffset
 1040  35:1130  69 03             adc #3
 1041  35:1132  A8                tay     
 1042                     
 1043  35:1133  B1 59             lda [pEquips],y
 1044  35:1135  85 36             sta <.items+2
 1045  35:1137  C8                iny
 1046  35:1138  B1 59             lda [pEquips],y
 1047  35:113A  85 37             sta <.items+3
 1048  35:113C  C8                iny
 1049  35:113D  B1 59             lda [pEquips],y
 1050  35:113F  85 3A             sta <.items+6
 1051  35:1141  C8                iny
 1052  35:1142  B1 59             lda [pEquips],y
 1053  35:1144  85 3B             sta <.items+7
 1054                     
 1055  35:1146  20 91 AF          jsr loadTileArrayOfItemProps
 1056                     
 1057  35:1149  A0 08             ldy #8
 1058  35:114B            .putText:
 1059  35:114B  BE 70 B1                  ldx .putOffsets,y
 1060                                     ;tax
 1061  35:114E  B9 79 B1                  lda .text,y
 1062  35:1151  9D 20 72                  sta TILE_ARRAY_BASE,x
 1063  35:1154  88                        dey
 1064  35:1155  10 F4                     bpl .putText
 1065                     
 1066  35:1157  AD 73 75          lda $7573
 1067  35:115A  C9 FF             cmp #$ff
 1068  35:115C  F0 03             beq .draw
 1069  35:115E  20 0B 8F                  jsr eraseFromLeftBottom0Bx0A
 1070  35:1161            .draw:  
 1071  35:1161  A9 01             lda #1
 1072  35:1163  85 18             sta <$18        ;left
 1073  35:1165  A9 0F             lda #$0f
 1074  35:1167  85 19             sta <$19        ;right
 1075  35:1169  A9 03             lda #$03
 1076  35:116B  85 1A             sta <$1a
 1077  35:116D  4C 38 8B          jmp draw8LineWindow
 1078  35:1170            .putOffsets:
 1079  35:1170  01 35 0F          .db $01,$35,$0f,$44,$0d,$0e,$41,$42,$43
       35:1173  44 0D 0E  
       35:1176  41 42 43  
 1080  35:1179            .text:
 1081  35:1179  C0 C0 9C          .db $c0,$c0,$9c,$9c,$a9,$90,$a4,$99,$b1
       35:117C  9C A9 90  
       35:117F  A4 99 B1  
 1082                             ;b184
 1083                     ;$b48b
 1084                     ;==========================================================================================================
 1085                     ;$35:b48b loadTileArrayForItemWindowColumn()
 1086                     ;       [in,out] u8 $3d : firstItemOffset, incremented by 8 per call
 1087  35:1182            loadTileArrayForItemWindowColumn:
 1088           003D      .firstItem = $3d
 1089           0034      .items = $34
 1090  35:1182  A9 07             lda #7
 1091  35:1184  AA                tax
 1092  35:1185  18                clc
 1093  35:1186  65 3D             adc <.firstItem
 1094  35:1188  A8                tay
 1095  35:1189            .init_loop:
 1096  35:1189  A9 01                     lda #1
 1097  35:118B  9D 00 74                  sta $7400,x
 1098  35:118E  B9 C0 60                  lda $60c0,y
 1099  35:1191  9D 34 00                  sta .items,x
 1100  35:1194  88                        dey
 1101  35:1195  CA                        dex
 1102  35:1196  10 F1                     bpl .init_loop
 1103                             
 1104  35:1198  E8                inx     ;x => 0
 1105  35:1199  A5 3D             lda <.firstItem
 1106  35:119B  4A                lsr a
 1107  35:119C  A8                tay
 1108  35:119D            .replace_loop:
 1109  35:119D  BD 34 00                  lda .items,x
 1110  35:11A0  D0 05                     bne .check_flag
 1111  35:11A2  A9 57                             lda #$57        ;bare fist
 1112  35:11A4  9D 34 00                          sta .items,x
 1113  35:11A7                    .check_flag:
 1114  35:11A7  B9 41 7B                  lda $7b41,y
 1115  35:11AA  D0 03                     bne .next
 1116  35:11AC  DE 00 74                          dec $7400,x
 1117  35:11AF                    .next:
 1118  35:11AF  C8                        iny
 1119  35:11B0  E8                        inx
 1120  35:11B1  E8                        inx
 1121  35:11B2  E0 08                     cpx #8
 1122  35:11B4  D0 E7                     bne .replace_loop
 1123                             
 1124  35:11B6  18                clc
 1125  35:11B7  A5 3D             lda <.firstItem
 1126  35:11B9  69 08             adc #8
 1127  35:11BB  85 3D             sta <.firstItem
 1128  35:11BD  A8                tay
 1129  35:11BE  4C 91 AF          jmp loadTileArrayOfItemProps
 1130                     ;$b4d4:
 1131                     ;==========================================================================================================
 1132                     ;$35:b4d4 itemWindow_moveCursor
 1133  35:11C1            itemWindow_moveCursor:
 1134  35:11C1  A5 62             lda <row
 1135  35:11C3  20 3E FD          jsr $fd3e       ;a <<= 4
 1136  35:11C6  69 A8             adc #$a8
 1137  35:11C8  85 1C             sta <$1c
 1138  35:11CA  A9 08             lda #8
 1139  35:11CC  A6 63             ldx <col
 1140  35:11CE  E4 66             cpx <windowLeft
 1141  35:11D0  F0 02             beq .store_x
 1142  35:11D2  A9 80                     lda #$80
 1143  35:11D4            .store_x:
 1144  35:11D4  85 1D             sta <$1d
 1145  35:11D6  A9 00             lda #0
 1146  35:11D8  85 1A             sta <$1a
 1147  35:11DA  4C 2E 89          jmp tileSprites2x2
 1148                     ;==========================================================================================================
 1149                     ;$b4f7  
 1150                     ;       .ORG $b4f7
 1151  35:11DD            itemWindow_OnUse:
 1152           0026      .index = $26
 1153           0027      .itemId = $27
 1154           4478      .itemParams = $7478
 1155  35:11DD  A5 63             lda <col
 1156  35:11DF  0A                asl a
 1157  35:11E0  0A                asl a
 1158  35:11E1  18                clc
 1159  35:11E2  65 62             adc <row
 1160  35:11E4  85 26             sta <.index
 1161  35:11E6  AA                tax
 1162  35:11E7  BD 3D 7B          lda equipFlags,x
 1163  35:11EA  F0 09             beq .fail
 1164  35:11EC  06 26             asl <.index
 1165  35:11EE  A6 26             ldx <.index
 1166  35:11F0  BD F5 7A          lda cachedItems,x
 1167  35:11F3  D0 0D             bne .use_ok
 1168  35:11F5            .fail:  
 1169  35:11F5  20 9B 9B                  jsr setYtoOffset2E      ;$9b9b
 1170  35:11F8  A9 00                     lda #0
 1171  35:11FA  91 5B                     sta [pPlayer],y
 1172  35:11FC  20 81 9B                  jsr requestSoundEffect06        ;9b81
 1173  35:11FF  4C AA AC                  jmp itemWindowInputLoop
 1174  35:2202            .use_ok:
 1175  35:2202  85 27             sta <.itemId            
 1176  35:2204  AA                tax
 1177  35:2205  20 7D 9B          jsr requestSoundEffect05        ;9b7d
 1178  35:2208  20 9B 9B          jsr setYtoOffset2E      ;$9b9b
 1179  35:220B  8A                txa
 1180  35:220C  91 5B             sta [pPlayer],y
 1181  35:220E  C9 A6             cmp #$a6
 1182  35:2210  90 09             bcc .not_heal
 1183  35:2212  C9 A9             cmp #$a9
 1184  35:2214  B0 05             bcs .not_heal
 1185  35:2216  A9 FF             lda #$ff
 1186  35:2218  8D E8 7C          sta $7ce8
 1187  35:221B            .not_heal:      
 1188  35:221B  88                dey
 1189  35:221C  88                dey
 1190  35:221D  A9 08             lda #8
 1191  35:221F  11 5B             ora [pPlayer],y
 1192  35:2221  91 5B             sta [pPlayer],y
 1193                             ;here x = id
 1194                             ;[00-56] ok
 1195                             ;[57-97]
 1196                             ;[98-c7] ok
 1197                             ;[c8-ff]
 1198  35:2223  E0 57             cpx #$57
 1199  35:2225  90 2E             bcc .use_equip
 1200  35:2227  E0 98             cpx #$98
 1201  35:2229  90 CA             bcc .fail
 1202  35:222B  E0 C8             cpx #$c8
 1203  35:222D  B0 C6             bcs .fail
 1204                             ;[98-c7] $b564:
 1205  35:222F  AD 00 74                  lda $7400
 1206  35:2232  48                        pha
 1207  35:2233  8A                        txa     ;id
 1208                                     ;clc here always clear
 1209  35:2234  69 08                     adc #8          ;$46 = #$91a0 + (a - #$98)
 1210  35:2236  85 46                     sta <$46
 1211  35:2238  A9 00                     lda #0
 1212  35:223A  69 91                     adc #$91
 1213  35:223C  85 47                     sta <$47
 1214  35:223E  A9 01                     lda #1
 1215  35:2240  85 4B                     sta <$4b
 1216  35:2242  A9 1A                     lda #$1a
 1217  35:2244  85 4A                     sta <$4a
 1218  35:2246  A9 17                     lda #$17
 1219  35:2248  20 DC FD                  jsr $fddc       ;copyTo7400(bank:a = #17 base:$46 = #91a0 + (a - #98), size:$4b = 1, restore:$4a = #1a):        ;$fd
 1220  35:224B  AC 00 74                  ldy $7400
 1221  35:224E  68                        pla
 1222  35:224F  8D 00 74                  sta $7400
 1223  35:2252  18                        clc
 1224  35:2253  90 17                     bcc .check_flag
 1225  35:2255            .use_equip:             
 1226                             ;itemid:[00-56]
 1227  35:2255  8A                        txa     ;id
 1228  35:2256  85 18                     sta <$18
 1229  35:2258  A9 08                     lda #8
 1230  35:225A  85 1A                     sta <$1a
 1231  35:225C  A9 00                     lda #$00
 1232  35:225E  85 20                     sta <$20
 1233  35:2260  A9 94                     lda #$94
 1234  35:2262  85 21                     sta <$21
 1235  35:2264  A2 78                     ldx #$78
 1236  35:2266  20 3A BA                  jsr $ba3a       ;loadTo7400FromBank30(index:$18 = a,size:$1a = 8,base:$20 = #9400,dest:x = #78);        ;$ba3a
 1237                                     
 1238  35:2269  AC 7C 74                  ldy .itemParams+4 ;$747c
 1239  35:226C            .check_flag
 1240                             ;here y: effect type? $b58b
 1241                             ;ldx <.index
 1242                             ;lda equipFlags,x
 1243                             ;beq .fail
 1244  35:226C  C0 7F             cpy #$7f
 1245  35:226E  D0 07             bne .load_param
 1246  35:2270  A9 09                     lda #9
 1247  35:2272  8D 7D 74                  sta .itemParams+5
 1248  35:2275  D0 13                     bne .select_target
 1249  35:2277            .load_param:
 1250  35:2277  84 18                     sty <$18
 1251  35:2279  A9 08                     lda #8
 1252  35:227B  85 1A                     sta <$1a
 1253  35:227D  A9 C0                     lda #$c0
 1254  35:227F  85 20                     sta <$20
 1255  35:2281  A9 98                     lda #$98
 1256  35:2283  85 21                     sta <$21
 1257  35:2285  A2 78                     ldx #$78
 1258  35:2287  20 3A BA                  jsr $ba3a
 1259  35:228A            .select_target:
 1260  35:228A  20 79 B9          jsr $b979 ;     ;対象選択? (2 == cancel)
 1261  35:228D  C9 02             cmp #2
 1262  35:228F  D0 03             bne .consume
 1263                                     ;dec <iPlayer
 1264                                     ;jmp closeItemWindow
 1265  35:2291  4C C2 AE                  jmp itemWindow_closeAndKeepCurrentPlayer
 1266  35:2294            .consume:
 1267  35:2294  A9 3F             lda #$3f
 1268  35:2296  20 88 9B          jsr $9b88
 1269  35:2299  A5 27             lda <.itemId
 1270  35:229B  91 5B             sta [pPlayer],y
 1271  35:229D  A5 63             lda <col
 1272  35:229F  D0 05             bne .not_equip
 1273  35:22A1  88                        dey
 1274  35:22A2  A9 01                     lda #1
 1275  35:22A4  91 5B                     sta [pPlayer],y
 1276  35:22A6            .not_equip:
 1277  35:22A6  A6 26             ldx <.index
 1278  35:22A8  E8                inx
 1279  35:22A9  DE F5 7A          dec cachedItems,x
 1280  35:22AC  BD F5 7A          lda cachedItems,x
 1281  35:22AF  D0 04             bne .copyback
 1282                                     ;as cosumed,item count reached 0.so clear id
 1283  35:22B1  CA                        dex
 1284  35:22B2  9D F5 7A                  sta cachedItems,x
 1285  35:22B5            .copyback:              
 1286  35:22B5  A2 3F             ldx #$3f
 1287  35:22B7            .copyloop:      
 1288  35:22B7  BD FD 7A                  lda cachedItems+8,x
 1289  35:22BA  9D C0 60                  sta backpackItems,x
 1290  35:22BD  CA                        dex
 1291  35:22BE  10 F7                     bpl .copyloop
 1292  35:22C0  4C C4 AE          jmp closeItemWindow
 1293                     ;==========================================================================================================
 1294                     ;$b601
 1295                     ;$35:b601 redrawColumn
 1296                     ;//     [in] u8 x : col
 1297                     ;==========================================================================================================
 1298                     ;$b636
 1299  35:22C3            ff3_itemWindow_end:
 1300           66EE      ff3_itemWindow_size = ff3_itemWindow_end - ff3_itemWindow_begin
 1301                     
#[2]   ff3_hack_master.asm
#[3]   ff3_magic_window.asm
   48                                     .include "ff3_magic_window.asm" ;save
    1                     ; ff3_magic_window.asm
    2                     ;
    3                     ;description:
    4                     ;       replaces magic-selection-window 
    5                     ;
    6                     ;version:
    7                     ;       0.06 (2006-10-29)
    8                     ;
    9                     ;======================================================================================================
   10  35:22C3            ff3_magic_window_begin:
   11                     ;------------------------------------------------------------------------------------------------------
   12                             INIT_PATCH $35,$b646,$b979
                0035              .bank   $35
                6646              .org    $b646
       35:6646                    .ds             (($b979) - ($b646))
                6646              .org    $b646
   13           22C3              .org ff3_magic_window_begin
   14                     ;------------------------------------------------------------------------------------------------------
   15                     ;commandWindow_OnMagicSelected:
   16  35:22C3            commandWindow_OnMagic:
   17           0057      .pPlayerBaseParam = $57 ;[in]
   18           0059      .pPlayerEquips = $59    ;[in]
   19           005B      .pPlayer = $5b                  ;[in]
   20           0018      .magicIdOffset = $18
   21           0024      .magicSlot = $24
   22           0026      .magicIndex = $26
   23           0027      .currentMagicLv = $27
   24           0046      .maxMagicLv = $46
   25                     ;---------------------------------------
   26  35:22C3  2C D8 7E          bit $7ed8       ;status_2?
   27  35:22C6  50 06             bvc     .castable       ;bit6 is clear
   28  35:22C8  20 81 9B                  jsr requestSoundEffect06
   29  35:22CB  A9 01                     lda #1
   30                                     RET_TO_GET_COMMAND_INPUT
       35:22CD  60                rts
   31                                     ;jmp getCommandInput_next
   32  35:22CE            .castable:              
   33  35:22CE  A2 17             ldx #$17
   34  35:22D0  A9 FF             lda #$ff
   35  35:22D2            .init_7400:
   36  35:22D2  9D 00 74                  sta $7400,x
   37  35:22D5  CA                        dex
   38  35:22D6  10 FA                     bpl .init_7400
   39  35:22D8  A9 3F             lda #$3f
   40  35:22DA  20 88 9B          jsr setYtoOffsetOf
   41  35:22DD  A2 07             ldx #7
   42  35:22DF            .find_max_lv:   
   43  35:22DF  B1 57                     lda [.pPlayerBaseParam],y
   44  35:22E1  D0 05                     bne .found_lv
   45  35:22E3  CA                        dex
   46  35:22E4  88                        dey
   47  35:22E5  88                        dey
   48  35:22E6  D0 F7                     bne .find_max_lv        ;y shouldn't be 0
   49  35:22E8            .found_lv:              
   50  35:22E8  86 27             stx <.currentMagicLv
   51  35:22EA  86 46             stx <.maxMagicLv
   52                             ;txa
   53                             ;pha
   54  35:22EC  A9 07             lda #7
   55  35:22EE  38                sec
   56  35:22EF  E5 27             sbc <.currentMagicLv
   57                             ;$18 = (7- currentMagicLv)*7
   58  35:22F1  85 18             sta <.magicIdOffset
   59  35:22F3  0A                asl a
   60  35:22F4  0A                asl a
   61  35:22F5  0A                asl a
   62  35:22F6  38                sec
   63  35:22F7  E5 18             sbc <.magicIdOffset
   64  35:22F9  85 18             sta <.magicIdOffset
   65  35:22FB  A9 00             lda #0
   66  35:22FD  85 26             sta <.magicIndex
   67  35:22FF            .getMagicIds:
   68  35:22FF  85 24                     sta <.magicSlot
   69  35:3301  48                        pha     ;magicslot
   70  35:3302  A9 07                     lda #7
   71  35:3304  AA                        tax     ;x:index
   72  35:3305  18                        clc
   73  35:3306  65 27                     adc <.currentMagicLv
   74  35:3308  20 88 9B                  jsr setYtoOffsetOf
   75  35:330B  B1 59                     lda [.pPlayerEquips],y
   76  35:330D                    .find_equipped_magic:   ;$b69e
   77  35:330D  4A                                lsr a
   78  35:330E  90 0B                             bcc .find_equipped_next
   79  35:3310  48                                        pha
   80  35:3311  A4 24                                     ldy <.magicSlot
   81  35:3313  A5 18                                     lda <.magicIdOffset
   82  35:3315  99 00 74                                  sta $7400,y
   83  35:3318  E6 24                                     inc <.magicSlot
   84  35:331A  68                                        pla
   85  35:331B                            .find_equipped_next:
   86  35:331B  E6 18                             inc <.magicIdOffset
   87  35:331D  CA                                dex
   88  35:331E  D0 ED                             bne .find_equipped_magic
   89  35:3320  68                        pla     ;magicslot
   90  35:3321  18                        clc
   91  35:3322  69 03                     adc #3
   92  35:3324  C6 27                     dec <.currentMagicLv
   93  35:3326  A6 27                     ldx <.currentMagicLv
   94  35:3328  10 D5                     bpl .getMagicIds
   95                     ;$b6cc:
   96           0024      .magicLv = $24
   97  35:332A  20 54 97          jsr initTileArrayStorage        ;$9754
   98  35:332D  A6 46             ldx <.maxMagicLv
   99  35:332F  86 24             stx <.magicLv
  100                     ;$b6dc:
  101  35:3331            .loadMagicNames:
  102           0027      .dest = $27
  103  35:3331  A2 1C                     ldx #$1c
  104  35:3333  20 49 A5                  jsr initString  ;a549
  105  35:3336  A9 08                     lda #8
  106  35:3338  85 27                     sta <.dest
  107  35:333A  A9 81                     lda #$81        ;'1'
  108  35:333C  18                        clc
  109  35:333D  65 24                     adc <.magicLv
  110  35:333F  8D D7 7A                  sta stringCache+0
  111  35:3342  A9 C7                     lda #$c7
  112  35:3344  8D DB 7A                  sta stringCache+4
  113  35:3347  A9 07                     lda #7
  114                                     ;clc always clear
  115  35:3349  65 24                     adc <.magicLv
  116  35:334B  20 88 9B                  jsr setYtoOffsetOf      ;9b88
  117  35:334E  B1 5B                     lda [pPlayer],y ;currentMp
  118  35:3350  20 25 A6                  jsr itoa_8
  119  35:3353  A5 1B                     lda <$1b
  120  35:3355  8D D9 7A                  sta stringCache+2
  121  35:3358  A5 1C                     lda <$1c
  122  35:335A  8D DA 7A                  sta stringCache+3
  123                                     ;
  124  35:335D  A5 24                     lda <.magicLv
  125  35:335F  0A                        asl a
  126                                     ;clc always cleared (0 <= magicLv < 8)
  127  35:3360  69 31                     adc #$31
  128  35:3362  20 88 9B                  jsr setYtoOffsetOf      ;9b88
  129  35:3365  B1 57                     lda [.pPlayerBaseParam],y       ;maxMp
  130  35:3367  20 25 A6                  jsr itoa_8
  131  35:336A  A5 1B                     lda <$1b
  132  35:336C  8D DC 7A                  sta stringCache+5
  133  35:336F  A5 1C                     lda <$1c
  134  35:3371  8D DD 7A                  sta stringCache+6
  135                     ;$b734
  136  35:3374  A9 03                     lda #3
  137  35:3376                    .loadMagicNamesOfCurrentLv:
  138  35:3376  48                                pha     ;index (means slot)
  139  35:3377  A6 26                             ldx <.magicIndex
  140  35:3379  BD 00 74                          lda $7400,x
  141  35:337C  C9 FF                             cmp #$ff        ;empty
  142  35:337E  F0 2F                             beq .load_next
  143                     ;$b73f:
  144  35:3380  85 18                                     sta <$18
  145  35:3382  48                                        pha     ;magic id
  146                                                     INIT16 <$20,$98c0
       35:3383  A9 C0             lda #LOW($98c0)
       35:3385  85 20             sta <$20
       35:3387  A9 98             lda #HIGH($98c0)
       35:3389  85 21             sta <$20+1
  147  35:338B  20 F9 B4                                  jsr isPlayerAllowedToUseItem    ;$b8fd
  148  35:338E  A5 1C                                     lda <$1c
  149  35:3390  D0 0E                                     bne .load_name
  150  35:3392  A6 27                                             ldx <.dest
  151  35:3394  A9 73                                             lda #$73        ;'x'
  152  35:3396  9D D7 7A                                          sta stringCache,x
  153  35:3399  A6 26                                             ldx <.magicIndex
  154  35:339B  A9 FF                                             lda #$ff
  155  35:339D  9D 00 74                                          sta $7400,x
  156  35:33A0                                    .load_name:
  157  35:33A0  A6 27                                     ldx <.dest
  158  35:33A2  E8                                        inx
  159                                                     INIT16 <$18,$8990
       35:33A3  A9 90             lda #LOW($8990)
       35:33A5  85 18             sta <$18
       35:33A7  A9 89             lda #HIGH($8990)
       35:33A9  85 19             sta <$18+1
  160  35:33AB  68                                        pla     ;magic id
  161  35:33AC  20 09 A6                                  jsr loadString  ;a609 loadString(index:a, dest:x, src:$18 )
  162  35:33AF                            .load_next:
  163  35:33AF  A5 27                             lda <.dest
  164  35:33B1  18                                clc
  165  35:33B2  69 07                             adc #7
  166  35:33B4  85 27                             sta <.dest
  167  35:33B6  E6 26                             inc <.magicIndex
  168  35:33B8  68                                pla     ;index (means slot)
  169                                             ;sec    always clear (dest < 6 * 3)
  170  35:33B9  E9 00                             sbc #0
  171  35:33BB  D0 B9                             bne .loadMagicNamesOfCurrentLv
  172                     ;$b77e:
  173  35:33BD  A9 1C                     lda #$1c
  174  35:33BF  85 18                     sta <$18
  175  35:33C1  20 6A 96                  jsr strToTileArray      ;966a
  176  35:33C4  A9 1C                     lda #$1c
  177  35:33C6  20 58 A5                  jsr offsetTilePtr
  178  35:33C9  C6 24                     dec <.magicLv
  179  35:33CB  A5 24                     lda <.magicLv
  180  35:33CD  30 03                     bmi .create_window
  181  35:33CF  4C 31 B3                          jmp .loadMagicNames
  182                     ;$b793:
  183  35:33D2            .create_window:
  184  35:33D2  20 B0 8E          jsr eraseWindow
  185  35:33D5  A9 01             lda #1
  186  35:33D7  85 18             sta <$18
  187  35:33D9  85 55             sta <$55        ;cursor id
  188  35:33DB  A9 1E             lda #$1e
  189  35:33DD  85 19             sta <$19
  190  35:33DF  A9 03             lda #$3 ;left|right
  191  35:33E1  85 1A             sta <$1a
  192  35:33E3  20 38 8B          jsr draw8LineWindow     ;draw8LineWindow(left = 1, right = #$1e, border = #3); //$34:8b38
  193  35:33E6  A9 00             lda #0
  194  35:33E8  85 1A             sta <$1a
  195  35:33EA  20 66 89          jsr loadCursor  ;8966
  196                     ;---------------------------
  197  35:33ED            magicWindow_getInput:
  198           001A      .cursorId = $1a
  199           0024      .row = $24
  200           0025      .cursorRow = $25
  201           0026      .col = $26
  202           0046      .rowMax = $46
  203  35:33ED  A2 00             ldx #0
  204  35:33EF  86 24             stx <.row
  205  35:33F1  86 25             stx <.cursorRow
  206  35:33F3  86 26             stx <.col
  207                     ;$b7b8
  208  35:33F5            .magicWindow_inputLoop:
  209           AA2A      .magicWindow_inputHandlerTable = $ba2a
  210  35:33F5  A2 00             ldx #0
  211  35:33F7  86 38             stx <$38
  212  35:33F9  86 1A             stx <.cursorId
  213  35:33FB  A9 02             lda #2
  214  35:33FD  85 1B             sta <$1b
  215  35:33FF  20 9E 89          jsr getInputAndUpdateCursorWithSound    ;commandWindow_dispatchInput    ;899e
  216                             INIT16 <$1e, .magicWindow_inputHandlerTable
       35:4402  A9 2A             lda #LOW(.magicWindow_inputHandlerTable)
       35:4404  85 1E             sta <$1e
       35:4406  A9 BA             lda #HIGH(.magicWindow_inputHandlerTable)
       35:4408  85 1F             sta <$1e+1
  217  35:440A  A5 12             lda <inputBits
  218                     ;getInputAndUpdateCursorWithSound processes input bit from lsb
  219  35:440C  A6 26             ldx <.col
  220  35:440E  A4 24             ldy <.row
  221                     
  222  35:4410  4A                lsr a
  223  35:4411  90 03             bcc .not_a
  224  35:4413  4C 8F B4                  jmp .magicWindow_OnA
  225  35:4416            .not_a:
  226  35:4416  4A                lsr a
  227  35:4417  B0 6D             bcs .magicWindow_OnB
  228  35:4419  4A                lsr a   ;sel
  229  35:441A  4A                lsr a   ;start
  230  35:441B  4A                lsr a
  231  35:441C  B0 18             bcs .magicWindow_OnUp
  232  35:441E  4A                lsr a
  233  35:441F  B0 31             bcs .magicWindow_OnDown
  234  35:4421  4A                lsr a
  235  35:4422  B0 0B             bcs .magicWindow_OnLeft
  236  35:4424  4A                lsr a
  237                             ;bcs .magicWindow_OnRight
  238  35:4425  90 CE             bcc .magicWindow_inputLoop
  239                     ;------------------------------------------------------------------------------------------------------
  240  35:4427            .magicWindow_OnRight:
  241  35:4427  E0 02             cpx #2
  242  35:4429  F0 CA             beq .magicWindow_inputLoop
  243  35:442B  E6 26             inc <.col
  244  35:442D  10 C6             bpl .magicWindow_inputLoop
  245                     ;------------------------------------------------------------------------------------------------------ 
  246  35:442F            .magicWindow_OnLeft:
  247  35:442F  8A                txa
  248  35:4430  F0 C3             beq .magicWindow_inputLoop
  249  35:4432  C6 26             dec <.col
  250  35:4434  10 BF             bpl .magicWindow_inputLoop
  251                     ;------------------------------------------------------------------------------------------------------ 
  252  35:4436            .magicWindow_OnUp:
  253  35:4436  98                tya
  254  35:4437  F0 BC             beq .magicWindow_inputLoop
  255  35:4439  C6 24             dec <.row
  256  35:443B  C6 25             dec <.cursorRow
  257  35:443D  10 B6             bpl .magicWindow_inputLoop
  258  35:443F  E6 25             inc <.cursorRow ;keep 0
  259                             SUB16by8 $7ac0,#$38
       35:4441  AD C0 7A          lda $7ac0
       35:4444  38                sec
       35:4445  E9 38             sbc #$38
       35:4447  8D C0 7A          sta $7ac0
       35:444A  B0 03             bcs .sub16by8_00083
       35:444C  CE C1 7A                  dec $7ac0+1
       35:444F                    .sub16by8_00083:
  260  35:444F  4C 74 B4          jmp .magicWindow_redraw
  261                     ;------------------------------------------------------------------------------------------------------ 
  262  35:4452            .magicWindow_OnDown:    
  263  35:4452  C0 07             cpy #7
  264  35:4454  F0 9F             beq .magicWindow_inputLoop
  265  35:4456  C4 46             cpy <.rowMax
  266  35:4458  F0 9B             beq .magicWindow_inputLoop
  267  35:445A  E6 24             inc <.row
  268  35:445C  E6 25             inc <.cursorRow
  269  35:445E  A5 25             lda <.cursorRow
  270  35:4460  C9 04             cmp #4
  271  35:4462  90 91             bcc .magicWindow_inputLoop
  272  35:4464  C6 25             dec <.cursorRow ;keep 3
  273                             ADD16by8 $7ac0,#$38
       35:4466  AD C0 7A          lda $7ac0
       35:4469  18                clc
       35:446A  69 38             adc #$38
       35:446C  8D C0 7A          sta $7ac0
       35:446F  90 03             bcc .add16by8_00084
       35:4471  EE C1 7A                  inc $7ac0+1
       35:4474                    .add16by8_00084:
  274  35:4474            .magicWindow_redraw:    
  275  35:4474  A9 01             lda #1
  276  35:4476  85 18             sta <$18
  277  35:4478  A9 1E             lda #$1e
  278  35:447A  85 19             sta <$19
  279  35:447C  A9 03             lda #3
  280  35:447E  85 1A             sta <$1a
  281  35:4480  20 38 8B          jsr draw8LineWindow
  282  35:4483  4C F5 B3          jmp .magicWindow_inputLoop
  283                     ;------------------------------------------------------------------------------------------------------
  284  35:4486            .magicWindow_OnB:
  285  35:4486            .magicWindow_close:
  286  35:4486  20 E3 99          jsr clearCursor0
  287  35:4489  20 B0 8E          jsr eraseWindow
  288  35:448C  A9 00             lda #0  ;redraw
  289                             RET_TO_GET_COMMAND_INPUT
       35:448E  60                rts
  290                             ;jmp getCommandInput_next
  291                     ;------------------------------------------------------------------------------------------------------ 
  292  35:448F            .magicWindow_OnA:
  293           4400      .magicIdList = $7400
  294                     ;.col = $26     ;x
  295                     ;.row = $24     ;y
  296           0046      .maxLv = $46
  297           0047      .lv = $47
  298           0052      .iPlayer = $52
  299           005B      .pPlayer = $5b
  300           005F      .playerOffset = $5f
  301  35:448F  98                tya
  302  35:4490  0A                asl a
  303  35:4491  65 24             adc <.row
  304  35:4493  65 26             adc <.col
  305  35:4495  AA                tax
  306  35:4496  BD 00 74          lda .magicIdList,x
  307  35:4499  C9 FF             cmp #$ff
  308  35:449B  F0 25             beq .bad_selection
  309                             
  310  35:449D  48                pha
  311  35:449E  AD D8 7E          lda $7ed8
  312  35:44A1  29 10             and #$10
  313  35:44A3  F0 06             beq .check_mp
  314                             
  315  35:44A5  68                pla
  316  35:44A6  C9 2F             cmp #$2f
  317  35:44A8  F0 18             beq .bad_selection      
  318  35:44AA  48                pha
  319                             
  320  35:44AB            .check_mp:
  321  35:44AB  A5 46             lda <.maxLv
  322  35:44AD  38                sec
  323  35:44AE  E5 24             sbc <.row
  324  35:44B0  85 47             sta <.lv
  325                             ;pha
  326  35:44B2  A6 52             ldx <.iPlayer
  327  35:44B4  9D C7 7A          sta $7ac7,x
  328                             ;pla
  329  35:44B7  18                clc
  330  35:44B8  69 07             adc #7
  331  35:44BA  65 5F             adc <.playerOffset      ;offset
  332  35:44BC  A8                tay
  333  35:44BD  B1 5B             lda [.pPlayer],y        ;mp
  334  35:44BF  D0 07             bne .cast_allowed
  335  35:44C1            .bad_selection_pop:     
  336  35:44C1  68                        pla     ;magic id
  337  35:44C2            .bad_selection:
  338  35:44C2  20 81 9B                  jsr requestSoundEffect06        ;9b81
  339  35:44C5  4C F5 B3                  jmp .magicWindow_inputLoop
  340                     ;$b8bb
  341  35:44C8            .cast_allowed:
  342  35:44C8  20 7D 9B          jsr requestSoundEffect05        ;9b7d
  343  35:44CB  68                pla
  344  35:44CC  48                pha
  345  35:44CD  20 32 B5          jsr getMagicTarget      ;$b953  ;get target?
  346  35:44D0  AA                tax
  347  35:44D1  F0 07             beq .store_command
  348  35:44D3  68                        pla
  349  35:44D4  E0 01                     cpx #1
  350  35:44D6  F0 EA                     beq .bad_selection
  351  35:44D8  D0 AC                     bne .magicWindow_close
  352  35:44DA            .store_command:
  353  35:44DA  20 9B 9B          jsr setYtoOffset2E      ;9b9b
  354  35:44DD  A6 52             ldx <.iPlayer
  355  35:44DF  68                pla
  356  35:44E0  18                clc
  357  35:44E1  69 C8             adc #$c8
  358  35:44E3  9D CF 78          sta $78cf,x
  359  35:44E6  91 5B             sta [pPlayer],y
  360  35:44E8  C9 FF             cmp #$ff
  361  35:44EA  D0 09             bne .finish
  362  35:44EC  AD E1 7B                  lda $7be1
  363  35:44EF  20 20 FD                  jsr flagTargetBit       ;$fd20
  364  35:44F2  8D E1 7B                  sta $7be1
  365  35:44F5            .finish:
  366  35:44F5  E6 52             inc <.iPlayer
  367  35:44F7  D0 8D             bne .magicWindow_close
  368                     ;======================================================================================================
  369  35:44F9            ff3_misc_begin:
  370           0035              .bank   $35
  371           88FD              .org    $b8fd
  372  35:88FD                    .ds             $b953 - $b8fd
  373                             ;.org   $b8fd
  374           44F9              .org    ff3_misc_begin
  375  35:44F9            isPlayerAllowedToUseItem:
  376                     ;       [in] u8 $18 : itemid
  377                     ;       [in] u16 $20 : ? itemDataBase = #$9400
  378                     ;       [out] u8 $1c : allowed (1:ok 0:not)
  379                     ;uses:
  380                     ;       u8 $7478[8] : itemParams
  381           0018      .itemId = $18
  382           0020      .baseAddress = $20
  383           001C      .allowed = $1c
  384           4478      .itemParam = $7478
  385           0038      .userType = $38
  386           003B      .userFlags = $3b
  387           0057      .pPlayerBaseParam = $57
  388  35:44F9  A9 08             lda #8
  389  35:44FB  85 1A             sta <$1a
  390  35:44FD  A2 78             ldx #$78
  391  35:44FF  20 3A BA          jsr loadTo7400FromBank30        ;$ba3a
  392  35:5502  AD 7F 74          lda .itemParam+7
  393  35:5505  29 7F             and #$7f
  394  35:5507  85 38             sta <.userType
  395  35:5509  0A                asl a
  396                             ;clc always clearted (&7f ed)
  397  35:550A  65 38             adc <.userType
  398  35:550C  AA                tax
  399  35:550D  20 8B FD          jsr $fd8b       ;loadUserFlags
  400  35:5510  20 41 A5          jsr getPlayerOffset     ;$a541
  401  35:5513  A8                tay
  402  35:5514  B1 57             lda [.pPlayerBaseParam],y       ;job
  403                             ;$b93e();
  404  35:5516  48                pha
  405  35:5517  4A                lsr a
  406  35:5518  4A                lsr a
  407  35:5519  4A                lsr a
  408  35:551A  85 38             sta <$38
  409  35:551C  A9 02             lda #2
  410  35:551E  38                sec
  411  35:551F  E5 38             sbc <$38
  412  35:5521  AA                tax
  413  35:5522  68                pla
  414  35:5523  29 07             and #7
  415  35:5525  A8                tay
  416  35:5526  B5 3B             lda <.userFlags,x
  417  35:5528            .move_flag:     
  418  35:5528  4A                        lsr a
  419  35:5529  88                        dey
  420  35:552A  10 FC                     bpl .move_flag
  421  35:552C  2A                rol a
  422  35:552D  29 01             and #1
  423  35:552F  85 1C             sta <.allowed
  424  35:5531  60                rts
  425                     ;$b93e:
  426                     ;$b953
  427                     ;======================================================================================================
  428                     ;$35:b953 setMagicTarget
  429  35:5532            getMagicTarget:
  430                     ;[in] a
  431           4478      .magicParams = $7478
  432  35:5532  38                sec     ;??
  433  35:5533  85 18             sta <$18
  434  35:5535  8D E8 7C          sta $7ce8
  435                             INIT16 <$20,$98c0
       35:5538  A9 C0             lda #LOW($98c0)
       35:553A  85 20             sta <$20
       35:553C  A9 98             lda #HIGH($98c0)
       35:553E  85 21             sta <$20+1
  436  35:5540  20 F9 B4          jsr isPlayerAllowedToUseItem    ;b8fd
  437  35:5543  AE 7C 74          ldx .magicParams+4
  438  35:5546  CA                dex
  439  35:5547  D0 04             bne .ok
  440  35:5549  CA                        dex     
  441  35:554A  8E E8 7C                  stx $7ce8 ;x = $ff
  442  35:554D            .ok:
  443  35:554D  A5 1C             lda <$1c
  444  35:554F  F0 03             beq .finish
  445  35:5551  4C 79 B9                  jmp setActionTargetByParam      ;b979
  446  35:5554            .finish 
  447  35:5554  A9 01             lda #1
  448  35:5556  60                rts
  449                             ;bne $ba29      ;do return
  450                     ;$b979
  451                     ;======================================================================================================
  452  35:5557            ff3_magic_window_free_begin:
  453           9979      ff3_magic_window_free_end = $b979
  454                     ;------------------------------------------------------------------------------------------------------
  455                     ;quickfix
  456           0034              .bank   $34
  457           0064              .org    $8064
  458  34:0064  20 F9 B4          jsr isPlayerAllowedToUseItem
  459                     ;======================================================================================================
  460                             RESTORE_PC ff3_magic_window_free_begin
                0035              .bank   BANK(ff3_magic_window_free_begin)
                5557              .org    ff3_magic_window_free_begin
  461           2294      ff3_magic_window_size = ff3_magic_window_free_begin - ff3_magic_window_begin
#[2]   ff3_hack_master.asm
#[3]   ff3_window.asm
   49                                     .include "ff3_window.asm"               ;consume( origin )
    1                     ; ff3_window.asm
    2                     ;
    3                     ;       replaces window drawing functions
    4                     ;       performs much faster than original
    5                     ;       "だるまさんがころんだ"
    6                     ;               6820 PPU cycles = 341 pixels per scanline * 20 scanlines within V-blank
    7                     ;               => approx. 2273 CPU cycles enough.
    8                     ;               まずウインドウ1行分(tile: 8x8 pixel)転送用のコードを
    9                     ;               WRAM($6000-7fff; access timing はRAMと同等 = 100% CPU cycle)に生成し
   10                     ;               V-blankが開始したらループを開始し、転送用のコードが猶予のある限りVRAMへ転送を行う
   11                     ;               転送用のコードは1ループに要するCPUサイクル数(処理を容易にするため8サイクル数単位)をカウントアップしており
   12                     ;               256(=2048 CPU cycles; 理論的な上限は279=2272cycles)を超えたら転送を止めて次のNMIを待つ
   13                     ;               なお、転送用のコードが要するCPUサイクル数は概算で69+9*1行の幅(8x8のタイル単位)
   14                     ;version:
   15                     ;       0.13 (2006-11-13)
   16                     ;
   17                     ;       $1b,22,23,24,25,26 used in caller (so should be avoided)
   18                     ;
   19                     ;======================================================================================================
   20                     
   21  35:5557            ff3_window_begin:
   22                     
   23                     ;GENCODE_ENABLE_LOOP
   24           0005      UNROLL_SHIFT = 5        ;valid range: 1-5
   25           0020      UNROLL_COUNT = (1 << UNROLL_SHIFT)
   26           0006      SIZEOF_PUT_CODE = 6     ;lda $xxxx, sta $2007
   27           000B      LOOP_OVERHEAD = ((69+14) >> 3) + 1
   28                     ;------------------------------------------------------------------------------------------------------
   29                     ;shared variables:
   30           0018      pLeftParts = $18
   31           001A      pRightParts = $1a
   32           001A      borderDrawFlags = $1a   ; [in] bit0:draw left, bit1:draw right
   33           001C      updateCounter = $1c             ;incremented by updateCount;if it overflows then stops drawing and waits for nmi
   34           001D      clockCount = $1d                ;indicates required cpu cycle count / 8 (approx.) for drawing line
   35           001E      borderPutFlags = $1e    ; [lrLRxxxx] R:put right border in 2ndBG,l: put left border in 1st BG
   36           001F      lineLen = $1f                   ;total line width without border
   37           0020      drawLen = $20                   ;line length for bg currently drawing
   38           002E      vram = $2e
   39           AAC0      pTileArray = $7ac0      ;see also initTileArrayStorage
   40                     ;------------------------------------------------------------------------------------------------------
   41                             INIT_PATCH $34,$8b38,$8d03
                0034              .bank   $34
                BB38              .org    $8b38
       34:BB38                    .ds             (($8d03) - ($8b38))
                BB38              .org    $8b38
   42                     
   43  34:BB38            draw8LineWindow:
   44                     ;args
   45           0018      .left = $18                     ; [in] unit = tiles, bit7 = bg select, border incl
   46           0019      .right = $19            ; [in] unit = tiles, bit7 = bg select, border excl
   47                     ;locals
   48           001C      .maskedLeft = $1c               ;temp
   49           001D      .maskedRight = $1d              ;temp
   50           001E      .crossFlag = $1e                ;temp
   51           88B8      .len_1st = $78b8        ;width without border
   52           88B9      .len_2nd = $78b9        ;width without border
   53           002A      .vram_1st = $2a
   54           002C      .vram_2nd = $2c
   55           0030      .line = $30
   56                     ;---------------------------------------
   57  34:BB38  A5 18             lda <.left
   58                             ;pha
   59  34:BB3A  29 1F             and #$1f
   60  34:BB3C  85 1C             sta <.maskedLeft
   61                             
   62  34:BB3E  A5 19             lda <.right
   63                             ;pha
   64  34:BB40  29 1F             and #$1f
   65  34:BB42  85 1D             sta <.maskedRight
   66                             
   67  34:BB44  A5 18             lda <.left
   68  34:BB46  45 19             eor <.right
   69  34:BB48  30 10             bmi .crosses_boundary
   70                             ;both are in same bg
   71  34:BB4A  A9 C0                     lda #$c0        ;left1st | right1st
   72  34:BB4C  85 1E                     sta <borderPutFlags
   73  34:BB4E  A5 19                     lda <.right
   74  34:BB50  18                        clc     ;to exclude border      
   75  34:BB51  E5 18                     sbc <.left
   76  34:BB53  8D B8 78                  sta .len_1st
   77                                     
   78  34:BB56  A9 00                     lda #0
   79  34:BB58  F0 0E                     beq .store_width
   80  34:BB5A            .crosses_boundary:
   81  34:BB5A  A9 90                     lda #$90        ;left1st | right2nd
   82  34:BB5C  85 1E                     sta <borderPutFlags
   83  34:BB5E  A9 1F                     lda #$1f
   84  34:BB60  38                        sec
   85  34:BB61  E5 1C                     sbc <.maskedLeft
   86  34:BB63  8D B8 78                  sta .len_1st
   87  34:BB66  A5 1D                     lda <.maskedRight
   88  34:BB68            .store_width:           
   89  34:BB68  8D B9 78          sta .len_2nd
   90                     ; --- init 1st bg addr
   91  34:BB6B  18                clc
   92  34:BB6C  A9 60             lda #$60
   93  34:BB6E  85 2C             sta <.vram_2nd          ;2nd bg also have $60 at low byte
   94  34:BB70  65 1C             adc <.maskedLeft
   95  34:BB72  85 2A             sta <.vram_1st
   96  34:BB74  A5 18             lda <.left
   97  34:BB76  30 04             bmi .left_starts_bg1
   98  34:BB78  A9 22                     lda #$22
   99  34:BB7A  D0 02                     bne .store_left_high
  100  34:BB7C            .left_starts_bg1:
  101  34:BB7C  A9 26                     lda #$26
  102  34:BB7E            .store_left_high:
  103  34:BB7E  69 00             adc #0  ;carry still remains
  104  34:BB80  85 2B             sta <.vram_1st+1
  105                     ; --- init 2nd bg addr
  106  34:BB82  A5 19             lda <.right
  107  34:BB84  30 04             bmi .right_ends_bg1
  108  34:BB86  A9 22                     lda #$22
  109  34:BB88  D0 02                     bne .store_right_high
  110  34:BB8A            .right_ends_bg1:
  111  34:BB8A  A9 26                     lda #$26
  112  34:BB8C            .store_right_high:
  113  34:BB8C  85 2D             sta <.vram_2nd+1
  114                     
  115  34:BB8E  20 4A 8C          jsr getBorderParts
  116                     ;here still required vars:
  117                     ;       .vram_1st, .vram_2nd, .len_1st, .len_2nd
  118                     ;       lineLen
  119  34:BB91  AD B8 78          lda .len_1st
  120                     
  121  34:BB94  85 20             sta <drawLen
  122  34:BB96  18                clc
  123  34:BB97  6D B9 78          adc .len_2nd
  124  34:BB9A  85 1F             sta <lineLen
  125                     
  126  34:BB9C  20 57 B5          jsr generateCopyLoopCode
  127  34:BB9F  20 80 FB          jsr waitNmi
  128                     ; --- begin drawing     
  129  34:BBA2  A6 2A             ldx <.vram_1st          ;3
  130  34:BBA4  A5 2B             lda <.vram_1st+1        ;3
  131  34:BBA6  20 36 8C          jsr drawWindow_setVram          ;6+24
  132                             
  133  34:BBA9  AD B8 78          lda .len_1st            ;3
  134  34:BBAC  38                sec                                     ;2
  135  34:BBAD  E5 1F             sbc <lineLen            ;3
  136  34:BBAF  20 D4 8B          jsr .drawOnCurrent      ;6 80
  137                             
  138  34:BBB2  AD B9 78          lda .len_2nd
  139  34:BBB5  D0 01             bne .draw_2nd
  140  34:BBB7  60                        rts
  141  34:BBB8            .draw_2nd:      
  142  34:BBB8  48                        pha     ; len_2nd
  143  34:BBB9  85 20                     sta <drawLen
  144  34:BBBB  06 1E                     asl <borderPutFlags
  145  34:BBBD  06 1E                     asl <borderPutFlags
  146  34:BBBF  20 57 B5                  jsr generateCopyLoopCode
  147                     
  148  34:BBC2  20 80 FB                  jsr waitNmi
  149  34:BBC5  A6 2C                     ldx <.vram_2nd          ;3
  150  34:BBC7  A5 2D                     lda <.vram_2nd+1        ;3
  151  34:BBC9  20 36 8C                  jsr drawWindow_setVram          ;6+52
  152                                     
  153  34:BBCC  68                        pla     ; len_2nd               ;4
  154  34:BBCD  38                        sec                                     ;2
  155  34:BBCE  E5 1F                     sbc <lineLen            ;3
  156  34:BBD0  18                        clc                                     ;2
  157  34:BBD1  6D B8 78                  adc .len_1st            ;4 79
  158                                     ;jmp .drawOnCurrent
  159  34:BBD4            .drawOnCurrent:
  160                     ;[in]   a : initialOffset
  161                     ;.len = $18
  162  34:BBD4  48                pha                                     ;2
  163  34:BBD5  A9 00             lda #0                          ;2      (25>>3)
  164  34:BBD7  85 1C             sta <updateCounter      ;3
  165                             
  166  34:BBD9  A9 F8             lda #$f8        ;topline;2
  167  34:BBDB  A6 20             ldx <drawLen                    ;3
  168  34:BBDD  A0 00             ldy #0                          ;2
  169  34:BBDF  20 F8 8B          jsr putTopBottom        ;6+x
  170  34:BBE2  A2 08             ldx #8                          ;2
  171  34:BBE4  86 30             stx <.line                      ;3
  172                             ;
  173  34:BBE6  68                pla     ;initialOffset  ;4
  174  34:BBE7  A8                tay                                     ;2
  175  34:BBE8            .putLines:
  176                                     ;1loop:69 + genCode
  177  34:BBE8  20 01 79                  jsr genCodeBase ;6
  178                     
  179  34:BBEB  20 1B 8C                  jsr checkUpdateAndOffsetVram;56 = 6+50
  180                                     
  181  34:BBEE  C6 30                     dec <.line              ;4
  182  34:BBF0  D0 F6                     bne .putLines   ;3
  183                     ;------
  184  34:BBF2  A9 FD             lda #$fd        ;bottomline
  185  34:BBF4  A6 20             ldx <drawLen
  186  34:BBF6  A0 06             ldy #6
  187                             ;jmp putTopBottom
  188                     ;------------------------------------------------------------------------------------------------------
  189                     ;helpers
  190  34:BBF8            putTopBottom:
  191                     ;[in] a : centerPartTile
  192                     ;[in] x : len_current
  193                     ;[in] y : top(0) or bottom(6)
  194  34:BBF8  48                pha
  195  34:BBF9  24 1E             bit <borderPutFlags
  196  34:BBFB  10 05             bpl .putCenter  ;bpl: bit7 is clear
  197  34:BBFD  B1 18                     lda [pLeftParts],y
  198  34:BBFF  8D 07 20                  sta $2007
  199  34:CC02            .putCenter:
  200  34:CC02  68                pla
  201  34:CC03  CA                dex
  202  34:CC04  30 06             bmi .put_right
  203  34:CC06            .putCenter_loop:
  204  34:CC06  8D 07 20                  sta $2007
  205  34:CC09  CA                        dex
  206  34:CC0A  10 FA                     bpl .putCenter_loop
  207  34:CC0C            .put_right:             
  208  34:CC0C  24 1E             bit <borderPutFlags
  209  34:CC0E  50 05             bvc .finish                     ;bvc: bit6 is clear
  210  34:CC10  B1 1A                     lda [pRightParts],y
  211  34:CC12  8D 07 20                  sta $2007
  212  34:CC15            .finish:
  213  34:CC15  98                tya     ;0(top) or 6(bottom)
  214  34:CC16  F0 03             beq checkUpdateAndOffsetVram
  215                                     ;we finished drawing. setup scroll values
  216  34:CC18  4C CB F8                  jmp updatePpuScrollNoWait
  217                             ;jmp checkUpdateAndOffsetVram
  218                     ;-----------------------------------------------------------------------------------------------------
  219  34:CC1B            checkUpdateAndOffsetVram:       ;50clk = 24 + 26clk(if update skipped)
  220  34:CC1B  A5 1C             lda <updateCounter      ;3
  221  34:CC1D  18                clc                                     ;2
  222  34:CC1E  65 1D             adc <clockCount         ;3
  223  34:CC20  90 09             bcc .store_counter      ;2+1
  224  34:CC22  20 CB F8                  jsr updatePpuScrollNoWait       ;$f8cb 6+34
  225  34:CC25  20 80 FB                  jsr waitNmi             ;
  226  34:CC28  18                        clc                             ;2
  227  34:CC29  A9 05                     lda #(40>>3)    ;2
  228  34:CC2B            .store_counter:
  229  34:CC2B  85 1C             sta <updateCounter      ;3
  230                     
  231  34:CC2D  A5 2E             lda <vram               ;3
  232                             ;clc                    ;always cleared
  233  34:CC2F  69 20             adc #$20                ;2
  234  34:CC31  AA                tax                             ;2
  235  34:CC32  A5 2F             lda <vram+1             ;3
  236  34:CC34  69 00             adc #0                  ;2
  237                             ;fall through
  238  34:CC36            drawWindow_setVram:             ;24clk = 6+18
  239  34:CC36  85 2F             sta <vram+1
  240  34:CC38  86 2E             stx <vram
  241                             ;fall through
  242  34:CC3A            drawWindow_setVramAddr: ;18clk
  243  34:CC3A  2C 02 20          bit $2002       ;reset flip-flop        ;4
  244  34:CC3D  8D 06 20          sta $2006       ;vram addr high         ;4
  245  34:CC40  8E 06 20          stx $2006       ;vram addr low          ;4
  246  34:CC43            drawWindow_doReturn:
  247  34:CC43  60                rts
  248                     
  249  34:CC44            drawWindow_setVramAndInitPpu:
  250  34:CC44  20 3A 8C          jsr drawWindow_setVramAddr      ;6+12
  251  34:CC47  4C CB F8          jmp updatePpuScrollNoWait       ;3+28
  252                     ;------------------------------------------------------------------------------------------------------
  253  34:CC4A            getBorderParts:
  254  34:CC4A  A5 1A             lda <borderDrawFlags
  255  34:CC4C  48                pha
  256  34:CC4D  A9 68             lda #LOW(.borderParts)
  257  34:CC4F  85 18             sta <pLeftParts
  258  34:CC51  18                clc
  259  34:CC52  69 02             adc #2
  260  34:CC54  85 1A             sta <pRightParts
  261  34:CC56  A9 8C             lda #HIGH(.borderParts)
  262  34:CC58  85 19             sta <pLeftParts+1
  263  34:CC5A  85 1B             sta <pRightParts+1
  264                             
  265  34:CC5C  68                pla
  266  34:CC5D  4A                lsr a
  267  34:CC5E  B0 02             bcs .check_right
  268  34:CC60  E6 18                     inc <pLeftParts ;no border
  269  34:CC62            .check_right:
  270  34:CC62  4A                lsr a
  271  34:CC63  B0 02             bcs .finish
  272  34:CC65  C6 1A                     dec <pRightParts
  273  34:CC67            .finish:                
  274  34:CC67  60                rts
  275  34:CC68            .borderParts:
  276  34:CC68  F7 F8 F9          .db $f7,$f8,$f9
  277  34:CC6B  FA FF FB          .db $fa,$ff,$fb
  278  34:CC6E  FC FD FE          .db $fc,$fd,$fe 
  279                     ;------------------------------------------------------------------------------------------------------
  280  34:CC71            genCode_begin:
  281  34:CC71            genCode_put_left:
  282  34:CC71  A9 00             lda #00         ;2
  283  34:CC73  8D 07 20          sta $2007       ;4
  284  34:CC76            genCode_copyLoop:       
  285  34:CC76  98                tya                     ;2
  286  34:CC77  18                clc                     ;2
  287  34:CC78            genCode_adc_offset:     
  288  34:CC78  69 00             adc #0          ;2 alignOffset + (totalWidth - width)
  289  34:CC7A  A8                tay                     ;2
  290  34:CC7B            genCode_go_next:
  291  34:CC7B            genCode_loop_begin:     ;(4+4)*8
  292  34:CC7B  B9 00 72          lda $7200,y
  293  34:CC7E  8D 07 20          sta $2007
  294                     ;       unrolled as many as required to fill a window line
  295                     
  296  34:CC81            genCode_dex:
  297  34:CC81            genCode_put_right:
  298  34:CC81  A9 00             lda #00         ;2
  299  34:CC83  8D 07 20          sta $2007       ;4
  300  34:CC86            genCode_finish_line:
  301  34:CC86  60                rts                     ;6
  302  34:CC87            genCode_end:    ;21(prolog/epilog)+6(left)+6(right)+ 64~72(loop)+5+7(loop overhead)
  303           DD03      genCode_free_end = $8d03
  304                     ;------------------------------------------------------------------------------------------------------
  305                     ;here original:$8d03    
  306                     ;------------------------------------------------------------------------------------------------------
  307           0035              .bank BANK(ff3_window_begin)
  308           5557              .org ff3_window_begin ;$8000 + (ff3_window_begin & $7fff)
  309                     ;------------------------------------------------------------------------------------------------------
  310           9901      genCodeBase = TEMP_RAM+1
  311  35:5557            generateCopyLoopCode:
  312                     ;       [out] clockCount
  313           0021      .alignOffset = $21
  314                     ;genCode_loopOffset = genCodeBase - 1
  315                     ;-----------------------------------
  316  35:5557  A5 20             lda <drawLen
  317                             ; alignOffset = (7 - width)+1 & 7
  318  35:5559  49 FF             eor #$ff
  319  35:555B  18                clc
  320  35:555C  69 01             adc #1
  321  35:555E  29 1F             and #(UNROLL_COUNT - 1) ;
  322  35:5560  85 21             sta <.alignOffset
  323                             ;calc required cpu cycle count
  324                             ; 
  325                             ;clock required: 69 + 26 + (9 * drawLen)
  326                             ; overhead + put cost + loop cost
  327                             ;countdown value : req.clk / (2266/256) (113.3clock*20scanline)
  328  35:5562  A5 20             lda <drawLen
  329  35:5564  4A                lsr a
  330  35:5565  4A                lsr a
  331  35:5566  4A                lsr a
  332  35:5567  18                clc
  333  35:5568  65 20             adc <drawLen
  334                     
  335                             ;sta <clockCount        ;(9 * drawLen) / denom (=8)
  336                             ;lda <drawLen
  337                             ;jsr $fd49 - (UNROLL_SHIFT - 4 + 3)
  338                             ;clc
  339                             ;adc <clockCount
  340  35:556A  69 0B             adc #LOOP_OVERHEAD
  341  35:556C  85 1D             sta <clockCount
  342                     
  343                             ;-----------------------------
  344  35:556E  A0 03             ldy #3
  345  35:5570  B1 1A             lda [pRightParts],y
  346  35:5572  48                pha
  347  35:5573  B1 18             lda [pLeftParts],y
  348  35:5575  48                pha
  349                             ;-----------------------------
  350                             ;from here,Y is reserved to 'dest index'
  351  35:5576  A0 00             ldy #0
  352  35:5578  24 1E             bit <borderPutFlags
  353  35:557A  10 0E             bpl .copy_loop_code     ;bpl: bit7 is clear
  354  35:557C  E6 1D                     inc <clockCount
  355  35:557E  A9 05                     lda #(genCode_copyLoop - genCode_put_left)
  356  35:5580  A2 00                     ldx #0
  357  35:5582  20 F6 B5                  jsr copyCodeBytes
  358  35:5585  68                        pla
  359  35:5586  48                        pha
  360  35:5587  8D 02 79                  sta genCodeBase + 1     ;lda #xx
  361  35:558A            .copy_loop_code:
  362  35:558A  68                pla     ;dummy
  363                     ;       tya
  364                     ;       sta genCode_loopOffset
  365                     
  366  35:558B  A5 20             lda <drawLen
  367  35:558D  F0 50             beq .no_center_tiles
  368  35:558F  A9 05                     lda #(genCode_loop_begin - genCode_copyLoop)
  369  35:5591  A2 05                     ldx #(genCode_copyLoop - genCode_begin)
  370  35:5593  20 F6 B5                  jsr copyCodeBytes
  371                     
  372                                     ;--------------------------------------------------------------
  373                                     ; offsetIndex =
  374                                     ; 8+(len-lenCurrent)-align
  375  35:5596  A9 21                     lda #UNROLL_COUNT+1
  376  35:5598  18                        clc
  377  35:5599  65 1F                     adc <lineLen
  378  35:559B  E5 20                     sbc <drawLen
  379                                     ;sec    ;always set (above sbc)
  380  35:559D  E5 21                     sbc <.alignOffset
  381  35:559F  99 FF 78                  sta genCodeBase - (genCode_loop_begin - genCode_adc_offset) + 1,y
  382                                     ;----------------------------------------------------------------
  383  35:55A2  AD C0 7A                  lda pTileArray
  384  35:55A5  18                        clc
  385  35:55A6  65 21                     adc <.alignOffset
  386  35:55A8  90 03                     bcc .sub_offset
  387  35:55AA  EE C1 7A                          inc pTileArray+1
  388  35:55AD                    .sub_offset:
  389  35:55AD  38                        sec
  390  35:55AE  E9 20                     sbc #UNROLL_COUNT
  391  35:55B0  8D C0 7A                  sta pTileArray
  392  35:55B3  B0 03                     bcs .done_offset
  393  35:55B5  CE C1 7A                          dec pTileArray+1
  394  35:55B8                    .done_offset:
  395  35:55B8  A6 20                     ldx <drawLen
  396  35:55BA                            .unroll_loopBytes:
  397  35:55BA  8A                                txa
  398  35:55BB  48                                pha
  399  35:55BC  A9 06                             lda #SIZEOF_PUT_CODE
  400  35:55BE  A2 0A                             ldx #(genCode_loop_begin - genCode_begin)
  401  35:55C0  20 F6 B5                          jsr copyCodeBytes
  402                                             ; --- init address
  403  35:55C3  AD C0 7A                          lda pTileArray
  404  35:55C6  18                                clc
  405  35:55C7  99 FC 78                          sta genCodeBase + (1 - SIZEOF_PUT_CODE),y
  406  35:55CA  69 01                             adc #1  ;post increment
  407  35:55CC  8D C0 7A                          sta pTileArray
  408                                             
  409  35:55CF  AD C1 7A                          lda pTileArray+1
  410  35:55D2  99 FD 78                          sta genCodeBase + (2 - SIZEOF_PUT_CODE),y
  411  35:55D5  69 00                             adc #0
  412  35:55D7  8D C1 7A                          sta pTileArray+1
  413                                             ;-----------------
  414  35:55DA  68                                pla
  415  35:55DB  AA                                tax
  416  35:55DC  CA                                dex
  417  35:55DD  D0 DB                     bne .unroll_loopBytes
  418                     
  419  35:55DF            .no_center_tiles:
  420  35:55DF            .copy_put_right_code:
  421                     
  422  35:55DF  24 1E             bit <borderPutFlags
  423  35:55E1  50 0E             bvc .copy_last  ;bvc: bit6 is clear
  424  35:55E3  E6 1D                     inc <clockCount
  425  35:55E5  A9 05                     lda #(genCode_finish_line - genCode_put_right)
  426  35:55E7  A2 10                     ldx #(genCode_put_right - genCode_begin)
  427  35:55E9  20 F6 B5                  jsr copyCodeBytes
  428  35:55EC  68                        pla
  429  35:55ED  48                        pha
  430  35:55EE  99 FD 78                  sta genCodeBase - 4,y   ;lda #xx
  431  35:55F1            .copy_last:
  432  35:55F1  68                pla     ;dummy
  433  35:55F2  A9 01             lda #(genCode_end - genCode_finish_line)
  434  35:55F4  A2 15             ldx #(genCode_finish_line - genCode_begin)
  435                             ;jmp .copyCodeBytes
  436  35:55F6            copyCodeBytes:
  437                     ;       [in] a : len
  438                     ;       [in] x : sourceOffset
  439                     ;       [in] y : destOffset     
  440           0030      .copyLast = $30
  441  35:55F6  84 30             sty <.copyLast
  442  35:55F8  18                clc
  443  35:55F9  65 30             adc <.copyLast
  444  35:55FB  85 30             sta <.copyLast
  445  35:55FD            .copy:
  446  35:55FD  BD 71 8C          lda genCode_begin,x
  447  35:6600  99 01 79          sta genCodeBase,y
  448  35:6603  E8                inx
  449  35:6604  C8                iny
  450  35:6605  C4 30             cpy <.copyLast
  451  35:6607  D0 F4             bne .copy
  452  35:6609  60                rts
  453  35:660A            ff3_window_last:        
  454                     ;------------------------------------------------------------------------------------------------------
  455                             INIT_PATCH $34,$8eb0,$8f0b
                0034              .bank   $34
                EEB0              .org    $8eb0
       34:EEB0                    .ds             (($8f0b) - ($8eb0))
                EEB0              .org    $8eb0
  456  34:EEB0            eraseWindow:
  457           2240      .vram1stBegin = $2240
  458           33A0      .vram1stEnd = $23a0     ;last line begins $2380
  459           6640      .vram2ndBegin = $2640
  460                             ;jsr waitNmi    ;presentCharacterのかわりに使うと画面消去中キャラが動かないが多少描画に使える時間が増える
  461  34:EEB0  20 85 81          jsr presentCharacter
  462  34:EEB3  A2 40             ldx #LOW(.vram1stBegin)
  463  34:EEB5  A9 22             lda #HIGH(.vram1stBegin)
  464  34:EEB7  20 C1 8E          jsr .erase
  465                             ;jsr waitNmi
  466  34:EEBA  20 85 81          jsr presentCharacter
  467  34:EEBD  A2 40             ldx #LOW(.vram2ndBegin)
  468  34:EEBF  A9 26             lda #HIGH(.vram2ndBegin)
  469                             ;fall through
  470  34:EEC1            .erase:
  471                             ;jsr drawWindow_setVramAndInitPpu       ;6+49
  472  34:EEC1  20 3A 8C          jsr drawWindow_setVramAddr      ;6+12
  473  34:EEC4  A9 00             lda #0
  474  34:EEC6  A2 20             ldx #$20
  475  34:EEC8            .erase_loop:    ;fill 32*11 bytes
  476  34:EEC8  8D 07 20                  sta $2007
  477  34:EECB  8D 07 20                  sta $2007
  478  34:EECE  8D 07 20                  sta $2007
  479  34:EED1  8D 07 20                  sta $2007
  480  34:EED4  8D 07 20                  sta $2007
  481  34:EED7  8D 07 20                  sta $2007
  482  34:EEDA  8D 07 20                  sta $2007
  483  34:EEDD  8D 07 20                  sta $2007
  484  34:EEE0  8D 07 20                  sta $2007
  485  34:EEE3  8D 07 20                  sta $2007
  486  34:EEE6  8D 07 20                  sta $2007
  487  34:EEE9  CA                        dex
  488  34:EEEA  D0 DC                     bne .erase_loop
  489  34:EEEC  4C CB F8          jmp updatePpuScrollNoWait
  490                     ;$8f0b
  491                     ;------------------------------------------------------------------------------------------------------
  492                             ;.bank  $34
  493                             ;.org   $8f0b
  494                             INIT_PATCH $34,$8f0b,$8f43
                0034              .bank   $34
                FF0B              .org    $8f0b
       34:FF0B                    .ds             (($8f43) - ($8f0b))
                FF0B              .org    $8f0b
  495  34:FF0B            eraseFromLeftBottom0Bx0A:
  496           0018      .vram = $18
  497                             INIT16 <.vram,$2380
       34:FF0B  A9 80             lda #LOW($2380)
       34:FF0D  85 18             sta <.vram
       34:FF0F  A9 23             lda #HIGH($2380)
       34:FF11  85 19             sta <.vram+1
  498  34:FF13  20 80 FB          jsr waitNmi
  499  34:FF16  A0 0A             ldy #$0a
  500  34:FF18            .erase_loop:
  501  34:FF18  A6 18                     ldx <.vram
  502  34:FF1A  A5 19                     lda <.vram+1
  503  34:FF1C  20 44 8C                  jsr drawWindow_setVramAndInitPpu        ;6+49
  504                                     ;jsr drawWindow_setVramAddr
  505  34:FF1F  A2 05                     ldx #5
  506  34:FF21  A9 00                     lda #0
  507  34:FF23                    .erase_line:    
  508  34:FF23  8D 07 20                          sta $2007
  509  34:FF26  8D 07 20                          sta $2007
  510  34:FF29  CA                                dex 
  511  34:FF2A  D0 F7                             bne .erase_line
  512  34:FF2C  8D 07 20                  sta $2007
  513                                     ;SUB16 <.vram,$0020
  514                                     SUB16by8 <.vram,#$20
       34:FF2F  A5 18             lda <.vram
       34:FF31  38                sec
       34:FF32  E9 20             sbc #$20
       34:FF34  85 18             sta <.vram
       34:FF36  B0 02             bcs .sub16by8_00092
       34:FF38  C6 19                     dec <.vram+1
       34:FF3A                    .sub16by8_00092:
  515  34:FF3A  88                        dey     
  516  34:FF3B  D0 DB                     bne .erase_loop
  517  34:FF3D  60                rts
  518                             ;jmp updatePpuScrollNoWait
  519                     ;=======================================================================================================        
  520                             RESTORE_PC      ff3_window_last
                0035              .bank   BANK(ff3_window_last)
                660A              .org    ff3_window_last
#[2]   ff3_hack_master.asm
   50                     
#[3]   ff3_command_04.asm
   51                                     .include "ff3_command_04.asm"   ;consume( genCode_end, getCommandInput_end )
    1                     ; ff3_command_04.asm
    2                     ;
    3                     ;description:
    4                     ;       patches calculations for command 04 ('fight')
    5                     ;       implements 'counter attack' feature
    6                     ;
    7                     ;version:
    8                     ;       0.08 (2006-11-10)
    9                     ;
   10                     ;======================================================================================================
   11  35:660A            ff3_command_04_begin:
   12                             ;INIT_PATCH $35,$a104,$a212
   13                             INIT_PATCH $35,$a104,$a353
                0035              .bank   $35
                1104              .org    $a104
       35:1104                    .ds             (($a353) - ($a104))
                1104              .org    $a104
   14  35:1104            command_fight:
   15           0018      .actorIndex = $18
   16           001A      .knightHps = $1a
   17           0022      .cHealthyKnight = $22
   18           0052      .iPlayer = $52
   19           0057      .pPlayerBaseParams = $57
   20           0059      .pEquips = $59
   21           005B      .pPlayerParams = $5b
   22           005F      .playerOffset = $5f
   23           006E      .pActor = $6e
   24           0070      .pTarget = $70
   25           CCEC      .nearlyDeadFlag = $7cec ;probably (not yet confirmed)
   26                     
   27  35:1104  20 2E A4          jsr getActor2C  ;a42e
   28                             ;bpl .actor_is_player_char
   29  35:1107  30 03             bmi .actor_is_enemy     
   30  35:1109  4C 9C A1          jmp .actor_is_player_char
   31  35:110C            .actor_is_enemy 
   32                                     ;enemy
   33  35:110C  B1 70                     lda [.pTarget],y
   34  35:110E  29 07                     and #7
   35  35:1110  85 18                     sta <.actorIndex
   36  35:1112  AA                        tax
   37  35:1113  AD EC 7C                  lda .nearlyDeadFlag
   38  35:1116  20 38 FD                  jsr maskTargetBit
   39  35:1119  F0 4D                     beq .bump
   40                     
   41  35:111B  A9 C0                     lda #$c0        ;dead|stone
   42  35:111D  A2 21                     ldx #$21        ;confused|jumping
   43  35:111F  20 2B 9A                  jsr isTargetNotInStatus
   44  35:1122  90 72                     bcc .finish_protect_check
   45                                             ;ok
   46                                             ;a == 0 (naturally)
   47  35:1124  85 22                             sta <.cHealthyKnight
   48  35:1126                            .check_protect:
   49  35:1126  A2 03                             ldx #3
   50  35:1128  86 52                             stx <.iPlayer
   51  35:112A                            .find_healthy_knight:
   52                                                     
   53  35:112A  A5 52                                     lda <.iPlayer
   54  35:112C  0A                                        asl a
   55  35:112D  AA                                        tax
   56  35:112E  95 24                                     sta <$24,x
   57  35:1130  A9 00                                     lda #0
   58  35:1132  95 1A                                     sta <.knightHps,x
   59  35:1134  95 1B                                     sta <.knightHps+1,x
   60                                                     
   61  35:1136  20 41 A5                                  jsr getPlayerOffset     ;a541   ;x,y unchanged
   62                     
   63  35:1139  A9 3C                                     lda #EXTRA_ABILITY_OFFSET
   64  35:113B  20 88 9B                                  jsr setYtoOffsetOf
   65  35:113E  B1 5B                                     lda [.pPlayerParams],y
   66  35:1140  29 20                                     and #PASSIVE_PROTECT
   67  35:1142  F0 1E                                     beq .find_next
   68                                                     
   69  35:1144  A9 01                                     lda #1
   70  35:1146  20 88 9B                                  jsr setYtoOffsetOf
   71                                                     ;iny    ;+01
   72  35:1149  B1 5B                                     lda [.pPlayerParams],y
   73  35:114B  29 C1                                     and #$c1
   74  35:114D  D0 13                                     bne .find_next
   75                                                     
   76  35:114F  C8                                        iny     ;+02
   77  35:1150  B1 5B                                     lda [.pPlayerParams],y
   78  35:1152  29 E0                                     and #$e0
   79  35:1154  D0 0C                                     bne .find_next
   80                                                             ;ok
   81  35:1156  C8                                                iny     ;setYtoOffset03
   82  35:1157  B1 5B                                             lda [.pPlayerParams],y
   83  35:1159  95 1A                                             sta <.knightHps,x
   84  35:115B  C8                                                iny
   85  35:115C  B1 5B                                             lda [.pPlayerParams],y
   86  35:115E  95 1B                                             sta <.knightHps+1,x
   87  35:1160  E6 22                                             inc <.cHealthyKnight
   88  35:1162                                    .find_next:
   89  35:1162  C6 52                                     dec <.iPlayer
   90  35:1164  10 C4                                     bpl .find_healthy_knight
   91                     ;$a175:
   92  35:1166  A5 22                             lda <.cHealthyKnight
   93  35:1168            .bump:
   94  35:1168  F0 2C                             beq .finish_protect_check
   95  35:116A  20 87 8C                                  jsr getIndexOfGreatest  ;a30f
   96                                                     ;lda #0
   97                                                     ;jsr flagTargetBit      ;fd20
   98  35:116D  20 BA 9F                                  jsr flagSingleTarget
   99                                                     
  100  35:1170  8D 99 7E                                  sta $7e99
  101  35:1173  8D DF 7E                                  sta play_protectionTargetBits   ;$7edf
  102                                                     
  103  35:1176  A6 18                                     ldx <.actorIndex
  104                                                     ;lda #0
  105                                                     ;jsr flagTargetBit
  106  35:1178  20 BA 9F                                  jsr flagSingleTarget
  107  35:117B  8D E0 7E                                  sta $7ee0
  108                                                     
  109  35:117E  A5 5F                                     lda <.playerOffset
  110  35:1180  18                                        clc
  111  35:1181  69 75                                     adc #$75
  112  35:1183  85 70                                     sta <.pTarget
  113  35:1185  A9 00                                     lda #0
  114  35:1187  69 75                                     adc #$75
  115  35:1189  85 71                                     sta <.pTarget+1
  116                                                     
  117  35:118B  A0 33                                     ldy #$33
  118  35:118D  B1 70                                     lda [.pTarget],y
  119  35:118F  8D E3 7C                                  sta $7ce3       ;save
  120  35:1192  29 FE                                     and #$fe        ;clear 'at backline' flag
  121  35:1194  91 70                                     sta [.pTarget],y
  122  35:1196            .finish_protect_check:
  123                                     ;extra
  124  35:1196  20 53 A2                  jsr checkCounter
  125  35:1199  90 06                     bcc command_fight_doCalc
  126  35:119B  60                                rts
  127                     ;a1ac
  128  35:119C            .actor_is_player_char:
  129  35:119C            command_fight_setupWeaponParam:
  130           0052      .iPlayer = $52
  131  35:119C  29 07             and #7  ;index
  132  35:119E  20 E6 A2          jsr setupWeaponId
  133                     ;a212:
  134  35:11A1            command_fight_doCalc:
  135           0052      .iPlayer = $52
  136           006E      .pActor = $6e
  137           0070      .pTarget = $70
  138  35:11A1  20 1E 80          jsr dispatchBattleFunction_03   ;801e
  139                     
  140  35:11A4  AD DF 7E          lda play_protectionTargetBits
  141  35:11A7  F0 0C             beq .sum_hit_count
  142  35:11A9  A9 52                     lda #$52        ;"ナイトが みをていして かばった！"
  143  35:11AB  20 BF 9F                  jsr addBattleMessage
  144                     
  145  35:11AE  AD EA 7C                  lda $7cea
  146  35:11B1  A0 33                     ldy #$33
  147  35:11B3  91 70                     sta [.pTarget],y
  148                     
  149  35:11B5            .sum_hit_count:
  150           007C      .hitCountRight = $7c
  151           007D      .hitCountLeft = $7d
  152           00E0      .targetStatusCache = $e0
  153           00F0      .actorStatusCache = $f0
  154  35:11B5  18                clc
  155  35:11B6  A5 7C             lda <.hitCountRight
  156  35:11B8  65 7D             adc <.hitCountLeft
  157  35:11BA  C9 21             cmp #33
  158  35:11BC  90 02             bcc .store_count
  159  35:11BE  A9 20                     lda #32
  160  35:11C0            .store_count:
  161  35:11C0  8D D7 78          sta actionName  ;78d7
  162                             
  163  35:11C3  A6 64             ldx <$64
  164  35:11C5  B5 E0             lda <.targetStatusCache,x
  165  35:11C7  30 4E             bmi .target_is_dead
  166                             ;alive
  167  35:11C9  AD D7 78          lda actionName  
  168  35:11CC  F0 56             beq .consume_item       ;miss
  169                             ;alive && hit
  170  35:11CE  E8                inx
  171  35:11CF  B5 E0             lda <.targetStatusCache,x
  172  35:11D1  A0 02             ldy #2
  173  35:11D3  29 18             and #STATUS_REMAIN_MASK ;$18
  174                             ;beq .check_death       ;target is alive (already checked)
  175  35:11D5  F0 4D             beq .consume_item       ;status unchanged
  176                                     ;18 10 08
  177  35:11D7  38                        sec
  178  35:11D8  E9 08                     sbc #8
  179  35:11DA  D0 30                     bne .update_status      ;a295
  180                     ;$a254:
  181                     ;打撃によって回復した
  182  35:11DC  B5 E0                             lda <.targetStatusCache,x
  183  35:11DE  48                                pha
  184  35:11DF  29 07                             and #STATUS_PETRIFY_MASK | STATUS_JUMPING
  185  35:11E1  95 E0                             sta <.targetStatusCache,x
  186  35:11E3  91 70                             sta [.pTarget],y
  187  35:11E5  20 1E 9A                          jsr isTargetActor
  188  35:11E8  D0 08                             bne .get_status_name
  189  35:11EA  B5 E0                                     lda <.targetStatusCache,x
  190  35:11EC  95 F0                                     sta <.actorStatusCache,x
  191  35:11EE  A0 02                                     ldy #BP_OFFSET_STATUS_LITE      ;2
  192  35:11F0  91 6E                                     sta [.pActor],y
  193  35:11F2                            .get_status_name:
  194  35:11F2  68                                pla
  195  35:11F3  A2 01                             ldx #$01
  196  35:11F5                            .find_first_set:
  197  35:11F5  E8                                        inx
  198  35:11F6  0A                                        asl a
  199  35:11F7  90 FC                                     bcc .find_first_set
  200                     ;a27e
  201  35:11F9  8E D9 78                  stx effectMessage       ;78d9
  202                                     ;jsr clearTargetAction
  203  35:11FC  A0 2C                             ldy #BP_OFFSET_INDEX_AND_MODE   ;$2c
  204  35:11FE  B1 70                             lda [.pTarget],y
  205  35:2200  29 E7                             and #$e7
  206  35:2202  91 70                             sta [.pTarget],y
  207  35:2204  C8                                iny
  208  35:2205  C8                                iny
  209  35:2206  A9 00                             lda #0
  210  35:2208  91 70                             sta [.pTarget],y
  211  35:220A  F0 18                     beq .consume_item       ;always satisfied (cleartargetaction)
  212                     
  213  35:220C                    .update_status: ;a295
  214  35:220C  B5 E0                     lda <.targetStatusCache,x
  215  35:220E  38                        sec
  216  35:220F  E9 08                     sbc #8
  217  35:2211  95 E0                     sta <.targetStatusCache,x
  218  35:2213  91 70                     sta [.pTarget],y
  219  35:2215  B0 0D                     bcs .consume_item       ;always set
  220  35:2217            .target_is_dead:
  221  35:2217  A0 2C                     ldy #$2c
  222  35:2219  A2 1A                     ldx #$1a        ;"しんでしまった!"
  223  35:221B  B1 70                     lda [.pTarget],y
  224  35:221D  10 01                     bpl .store_death_message
  225  35:221F  E8                                inx             ;"てきをたおした!"
  226  35:2220                    .store_death_message:
  227  35:2220  8A                        txa
  228  35:2221  20 BF 9F                  jsr addBattleMessage
  229                     
  230  35:2224            .consume_item: ;a2b7
  231           0024      .recalcRequired = $24
  232  35:2224  A9 00             lda #0
  233  35:2226  8D D5 78          sta battleProcessType   ;78d5
  234  35:2229  85 24             sta <.recalcRequired
  235  35:222B  20 2E A4          jsr getActor2C
  236  35:222E  30 22             bmi .finish
  237                     ;$a2c3  
  238  35:2230  29 07                     and #7
  239  35:2232  85 52                     sta <.iPlayer
  240  35:2234  20 41 A5                  jsr getPlayerOffset
  241  35:2237  A9 01                     lda #1
  242  35:2239  20 2A A3                  jsr consumeIfArrow
  243  35:223C  A9 02                     lda #2
  244  35:223E  20 2A A3                  jsr consumeIfArrow
  245  35:2241  A9 03                     lda #3
  246  35:2243  20 3C A3                  jsr consumeIfShuriken
  247  35:2246  A9 05                     lda #5
  248  35:2248  20 3C A3                  jsr consumeIfShuriken
  249                     ;$a307:
  250  35:224B  A5 24                     lda <.recalcRequired
  251  35:224D  F0 03                     beq .finish
  252  35:224F  4C 26 80                          jmp dispatchBattleFunction_05
  253  35:2252            .finish:
  254  35:2252            command_fight_doReturn:
  255  35:2252  60                rts
  256                     ;$a30f
  257                     ;------------------------------------------------------------------------------------------------------
  258  35:2253            checkCounter:   ;extra
  259                     ;out] bool carry : (countered : 1)
  260           0018      .rand = $18
  261           0052      .iPlayer = $52
  262           0057      .pPlayerBaseParams = $57
  263           0059      .pEquips = $59
  264           005B      .pPlayerParams = $5b
  265           006E      .pActor = $6e
  266           0070      .pTarget = $70
  267  35:2253  20 27 9A          jsr isTargetActive
  268  35:2256  90 FA             bcc command_fight_doReturn
  269  35:2258  20 A6 9F          jsr setXtoTargetIndex
  270  35:225B  A0 3C             ldy #EXTRA_ABILITY_OFFSET
  271  35:225D  B1 70             lda [.pTarget],y
  272                             ;and #PASSIVE_COUNTER = 80
  273  35:225F  18                clc
  274  35:2260  10 F0             bpl command_fight_doReturn
  275  35:2262            .calc_rate:
  276  35:2262  8A                txa
  277  35:2263  48                pha
  278  35:2264  A9 64             lda #100
  279  35:2266  20 64 A5          jsr getSys1Random
  280  35:2269  85 18             sta <.rand
  281                             ;%success = 25 + joblv>>1
  282  35:226B  68                pla
  283  35:226C  AA                tax     ;index
  284  35:226D  A0 0F             ldy #$0f
  285  35:226F  B1 70             lda [.pTarget],y        ;joblv
  286  35:2271  4A                lsr a
  287  35:2272  18                clc
  288  35:2273  69 19             adc #25
  289  35:2275  C5 18             cmp <.rand
  290           0000              .ifdef TEST_COUNTER_ATTACK
  292                             .else
  293  35:2277  90 D9                     bcc command_fight_doReturn
  294                             .endif ;TEST_COUNTER_ATTACK
  295                     
  296  35:2279            .doCounter:
  297                             ;x = target index
  298  35:2279  20 BA 9F          jsr flagSingleTarget
  299  35:227C  8D 98 7E          sta play_actorBits
  300                             ;lda play_effectTargetSide
  301                             ;ora #$c1       ;original uses higher 2bit.
  302  35:227F  A9 41             lda #$41
  303  35:2281  8D 9A 7E          sta play_effectTargetSide
  304                     
  305  35:2284  A9 59             lda #EXMSG_COUNTER
  306  35:2286  20 BF 9F          jsr addBattleMessage
  307                     
  308  35:2289  20 AD 9F          jsr setXtoActorIndex
  309  35:228C  20 BA 9F          jsr flagSingleTarget
  310  35:228F  8D 9B 7E          sta play_effectTargetBits       ;damage
  311  35:2292  8D 99 7E          sta play_castTargetBits         ;blow
  312                     
  313  35:2295            command_fight_counter:
  314           006E      .pActor = $6e
  315           0070      .pTarget = $70
  316                             ;jsr .swapActorAndTarget
  317  35:2295  20 C7 A2          jsr .swapStatusCache
  318                             
  319  35:2298  20 2E A4          jsr getActor2C
  320  35:229B  AA                tax
  321                             
  322  35:229C  A0 2F             ldy #$2f
  323  35:229E  B1 6E             lda [.pActor],y ;target bit
  324  35:22A0  48                pha     
  325                     
  326  35:22A1  C8                iny
  327  35:22A2  B1 6E             lda [.pActor],y
  328  35:22A4  48                pha
  329                             
  330  35:22A5  8A                txa
  331  35:22A6  49 80             eor #$80
  332  35:22A8  29 80             and #$80
  333  35:22AA  91 6E             sta [.pActor],y ;force opponent side
  334                     
  335  35:22AC  A0 28             ldy #$28
  336  35:22AE  B1 6E             lda [.pActor],y
  337  35:22B0  48                pha
  338  35:22B1  A9 32             lda #COUNTER_CRITICAL_RATE
  339  35:22B3  91 6E             sta [.pActor],y
  340                             
  341  35:22B5  8A                txa     ;actor 2c
  342  35:22B6  20 9C A1          jsr command_fight_setupWeaponParam;command_fight_doCalc
  343                             
  344  35:22B9  68                pla
  345  35:22BA  A0 28             ldy #$28
  346  35:22BC  91 6E             sta [.pActor],y ;critical
  347                             
  348  35:22BE  A0 30             ldy #$30
  349  35:22C0  68                pla
  350  35:22C1  91 6E             sta [.pActor],y ;target flag
  351                             
  352  35:22C3  88                dey
  353  35:22C4  68                pla
  354  35:22C5  91 6E             sta [.pActor],y ;target bit
  355                     
  356  35:22C7            .swapStatusCache:
  357  35:22C7  A2 0F             ldx #$0f
  358  35:22C9            .swap_stats:
  359  35:22C9  B4 E0             ldy <$e0,x
  360  35:22CB  B5 F0             lda <$f0,x
  361  35:22CD  95 E0             sta <$e0,x
  362  35:22CF  94 F0             sty <$f0,x
  363  35:22D1  CA                dex
  364  35:22D2  10 F5             bpl .swap_stats
  365  35:22D4  38                sec     ;[out] countered
  366  35:22D5            .swapActorAndTarget:
  367  35:22D5  A6 6E             ldx <.pActor
  368  35:22D7  A5 70             lda <.pTarget
  369  35:22D9  86 70             stx <.pTarget
  370  35:22DB  85 6E             sta <.pActor
  371  35:22DD  A6 6F             ldx <.pActor+1
  372  35:22DF  A5 71             lda <.pTarget+1
  373  35:22E1  86 71             stx <.pTarget+1
  374  35:22E3  85 6F             sta <.pActor+1
  375  35:22E5            .finish:
  376  35:22E5  60                rts
  377                     ;------------------------------------------------------------------------------------------------------
  378                     
  379  35:22E6            setupWeaponId:
  380                     ;[in] u8 a : index
  381           0052      .iPlayer = $52
  382           0059      .pEquips = $59
  383           006E      .pActor = $6e
  384           0070      .pTarget = $70
  385                     ;[out]
  386           EE1F      .righthand = $7e1f
  387           EE20      .lefthand = $7e20
  388                     ;       and #7
  389  35:22E6  85 52             sta <.iPlayer
  390  35:22E8  A2 00             ldx #0
  391  35:22EA  8E 20 7E          stx .lefthand
  392  35:22ED  8E 1F 7E          stx .righthand
  393  35:22F0  A0 01             ldy #1
  394  35:22F2  B1 6E             lda [.pActor],y
  395  35:22F4  29 28             and #$28
  396  35:22F6  D0 31             bne .finish     ;toad | minimum
  397                                     ;ok
  398  35:22F8  20 41 A5                  jsr getPlayerOffset     ;a541
  399  35:22FB  20 8D 9B                  jsr setYtoOffset03
  400  35:22FE  B1 59                     lda [.pEquips],y
  401  35:3300  20 AB 8C                  jsr filterShield
  402  35:3303  8D 1F 7E                  sta .righthand
  403                     
  404  35:3306  C8                        iny
  405  35:3307  C8                        iny
  406  35:3308  B1 59                     lda [.pEquips],y
  407  35:330A  20 AB 8C                  jsr filterShield
  408  35:330D  8D 20 7E                  sta .lefthand
  409                                     
  410  35:3310  F0 05                     beq .either_empty
  411  35:3312  AD 1F 7E                  lda .righthand
  412  35:3315  D0 12                     bne .finish
  413  35:3317            .either_empty:
  414                                             ;at least either lefthand or righthand is empty or shield
  415  35:3317  AD 20 7E                          lda .lefthand
  416  35:331A  20 A7 8C                          jsr filterBowArrow
  417  35:331D  8D 20 7E                          sta .lefthand
  418  35:3320  AD 1F 7E                          lda .righthand
  419  35:3323  20 A7 8C                          jsr filterBowArrow
  420  35:3326  8D 1F 7E                          sta .righthand
  421  35:3329            .finish:
  422  35:3329  60                rts
  423                     ;------------------------------------------------------------------------------------------------------
  424  35:332A            consumeIfArrow:
  425                     ;a = 1 : right, 2 : left
  426           005B      .pPlayerParams = $5b
  427  35:332A  AA                tax
  428  35:332B  18                clc
  429  35:332C  69 30             adc #$30
  430  35:332E  20 88 9B          jsr setYtoOffsetOf
  431  35:3331  B1 5B             lda [.pPlayerParams],y
  432  35:3333  29 04             and #$04        ;arrow flag
  433  35:3335  F0 2F             beq $a366       ;.finish
  434  35:3337  E8                        inx
  435  35:3338  8A                        txa
  436  35:3339  0A                        asl a
  437  35:333A  D0 17                     bne consumeEquippedItem
  438                     ;------------------------------------------------------------------------------------------------------
  439  35:333C            consumeIfShuriken:
  440           0059      .pEquips = $59
  441  35:333C  AA                tax
  442  35:333D  20 88 9B          jsr setYtoOffsetOf
  443  35:3340  B1 59             lda [.pEquips],y
  444  35:3342  C9 41             cmp #$41        ;shuriken
  445  35:3344  D0 20             bne $a366 ;.finish
  446  35:3346  E8                        inx
  447  35:3347  8A                        txa
  448  35:3348  D0 09                     bne consumeEquippedItem
  449                     ;$a353
  450                     ;------------------------------------------------------------------------------------------------------
  451                             RESTORE_PC      genCode_end
                0034              .bank   BANK(genCode_end)
                CC87              .org    genCode_end
  452                     ;------------------------------------------------------------------------------------------------------
  453                             ;INIT_PATCH $35,$a30f,$a353
  454  34:CC87            getIndexOfGreatest:     ;original:a30f
  455           001A      .values = $1a
  456           0024      .indices = $24
  457           0052      .iPlayer = $52
  458  34:CC87  A0 05             ldy #5
  459  34:CC89  A2 07             ldx #7
  460  34:CC8B            .find_max:
  461  34:CC8B  38                        sec
  462  34:CC8C  B5 19                     lda <.values-1,x
  463  34:CC8E  F9 19 00                  sbc .values-1,y
  464  34:CC91  B5 1A                     lda <.values,x
  465  34:CC93  F9 1A 00                  sbc .values,y
  466  34:CC96  B0 02                     bcs .next
  467                                     ;16bit value at y is greater than value at x
  468  34:CC98  98                                tya
  469  34:CC99  AA                                tax
  470  34:CC9A                    .next:
  471  34:CC9A  88                        dey
  472  34:CC9B  88                        dey
  473  34:CC9C  10 ED                     bpl .find_max
  474                     ;now x is index of the greatest value
  475  34:CC9E  B5 23             lda <.indices-1,x
  476  34:CCA0  4A                lsr a
  477  34:CCA1  85 52             sta <.iPlayer
  478  34:CCA3  AA                tax
  479  34:CCA4  4C 41 A5          jmp getPlayerOffset
  480                     ;------------------------------------------------------------------------------------------------------
  481  34:CCA7            filterBowArrow:
  482  34:CCA7  A2 03             ldx #3
  483  34:CCA9  D0 02             bne filterByItemKind
  484  34:CCAB            filterShield:
  485  34:CCAB  A2 05             ldx #5  
  486  34:CCAD            filterByItemKind:
  487                     ;a :itemid
  488                     ;x : bound
  489           0018      .bound = $18
  490  34:CCAD  86 18             stx <.bound
  491  34:CCAF  48                pha
  492  34:CCB0  20 14 B0          jsr idToKind
  493  34:CCB3  E4 18             cpx <.bound
  494  34:CCB5  90 04             bcc .valid
  495  34:CCB7  68                        pla
  496  34:CCB8  A9 00                     lda #0
  497  34:CCBA  60                        rts
  498  34:CCBB            .valid:
  499  34:CCBB  68                pla
  500  34:CCBC  60                rts
  501                     ;------------------------------------------------------------------------------------------------------
  502  34:CCBD            set52toEffectTargetIndex:
  503  34:CCBD  A2 01             ldx #1
  504  34:CCBF  20 AB 86          jsr targetBitToCharIndex
  505  34:CCC2  84 52             sty <$52
  506  34:CCC4  60                rts
  507                     
  508                             VERIFY_PC genCode_free_end
       34:CCC5                    .verify_pc_00096:
                0000              .if (.verify_pc_00096 > genCode_free_end)
                                  .endif
  509                     ;------------------------------------------------------------------------------------------------------
  510                             RESTORE_PC      getCommandInput_end
                0034              .bank   BANK(getCommandInput_end)
                AA1E              .org    getCommandInput_end
  511  34:AA1E            isTargetActor:
  512           006E      .pActor = $6e
  513           0070      .pTarget = $70
  514                     ;.actor = $18
  515  34:AA1E  A0 2C             ldy #$2c
  516  34:AA20  B1 6E             lda [.pActor],y
  517  34:AA22  51 70             eor [.pTarget],y
  518  34:AA24  29 87             and #$87
  519  34:AA26  60                rts
  520                     ;------------------------------------------------------------------------------------------------------
  521  34:AA27            isTargetActive:
  522  34:AA27  A9 C0             lda #$c0        ;dead | stone
  523  34:AA29  A2 E1             ldx #$e1        ;paralyzed | sleeping | confused | jumping
  524  34:AA2B            isTargetNotInStatus:
  525                     ;[in] a = status00, x = status01
  526                     ;[out] carry : 
  527           0070      .pTarget = $70
  528  34:AA2B  18                clc
  529  34:AA2C  A0 01             ldy #1
  530  34:AA2E  31 70             and [.pTarget],y
  531  34:AA30  D0 07             bne .finish
  532                             
  533  34:AA32  C8                iny
  534  34:AA33  8A                txa
  535  34:AA34  31 70             and [.pTarget],y
  536  34:AA36  D0 01             bne .finish
  537  34:AA38  38                sec
  538  34:AA39            .finish:
  539  34:AA39  60                rts
  540                     
  541                             VERIFY_PC getCommandInput_free_end
       34:AA3A                    .verify_pc_00098:
                0000              .if (.verify_pc_00098 > getCommandInput_free_end)
                                  .endif
  542                     ;$9a40
  543                     ;======================================================================================================
  544                             INIT_PATCH $34,$8613,$8689
                0034              .bank   $34
                6613              .org    $8613
       34:6613                    .ds             (($8689) - ($8613))
                6613              .org    $8613
  545  34:6613            playEffect_fight:       ;function00
  546  34:6613  A2 00             ldx #0
  547  34:6615  8E 96 7E          stx $7e96
  548  34:6618  20 AB 86          jsr targetBitToCharIndex        ;86ab
  549  34:661B  AD 9A 7E          lda play_effectTargetSide       ;7e9a
  550  34:661E  10 10             bpl .actor_is_player_char
  551  34:6620  20 45 85                  jsr dispatchPresentScene_1f     ;8545
  552  34:6623  A9 20                     lda #$20
  553  34:6625  20 6E 86                  jsr .showBlowEffect
  554  34:6628  20 BD 8C                  jsr set52toEffectTargetIndex
  555  34:662B            .show_hit_effect:
  556  34:662B  A9 14                     lda #$14
  557  34:662D  4C 0E FA                  jmp call_2e_9d53
  558  34:6630            .actor_is_player_char:  ;8647
  559  34:6630  84 52                     sty <$52
  560  34:6632  29 01                     and #1
  561  34:6634  F0 11                     beq .do_usually
  562  34:6636  AD 98 7E                          lda play_actorBits
  563  34:6639  48                                pha
  564  34:663A  AD 9B 7E                          lda play_effectTargetBits
  565  34:663D  8D 98 7E                          sta play_actorBits
  566  34:6640  20 45 85                          jsr dispatchPresentScene_1f     ;
  567  34:6643  68                                pla
  568  34:6644  8D 98 7E                          sta play_actorBits
  569  34:6647                    .do_usually:
  570  34:6647  A9 12                     lda #$12
  571  34:6649  20 6E 86                  jsr .showBlowEffect
  572                                     
  573  34:664C  EE 96 7E                  inc $7e96
  574  34:664F  A5 BB                     lda <$bb
  575  34:6651  48                        pha
  576  34:6652  A5 BC                     lda <$bc
  577  34:6654  48                        pha
  578  34:6655  A9 00                     lda #0
  579  34:6657  85 BB                     sta <$bb
  580  34:6659  85 BC                     sta <$bc
  581  34:665B  A9 12                     lda #$12
  582  34:665D  20 0E FA                  jsr call_2e_9d53
  583                                     
  584  34:6660  20 BD 8C                  jsr set52toEffectTargetIndex
  585                                     
  586  34:6663  68                        pla
  587  34:6664  85 BC                     sta <$bc
  588  34:6666  68                        pla
  589  34:6667  85 BB                     sta <$bb
  590  34:6669  05 BC                     ora <$bc
  591  34:666B  D0 BE                     bne .show_hit_effect
  592  34:666D  60                        rts
  593                     ;------------------------------------------------------------------------------------------------------
  594  34:666E            .showBlowEffect:
  595                     ;[in] a : type ( enemy = 20, player = 12
  596  34:666E  AE 6F 7E          ldx $7e6f
  597  34:6671  F0 0E             beq .finish
  598  34:6673  48                        pha
  599  34:6674  A2 01                     ldx #1
  600  34:6676  20 AB 86                  jsr targetBitToCharIndex        ;86ab
  601  34:6679  84 B8                     sty <$b8
  602  34:667B  68                        pla
  603  34:667C  20 0E FA                  jsr call_2e_9d53
  604  34:667F  68                        pla     ;retaddr
  605  34:6680  68                        pla     ;retaddr
  606  34:6681            .finish:
  607  34:6681  60                rts
  608                     ;$868a:
  609                     ;======================================================================================================
  610  34:6682            ff3_command_04_end:
  611                             RESTORE_PC ff3_command_04_begin
                0035              .bank   BANK(ff3_command_04_begin)
                660A              .org    ff3_command_04_begin
#[2]   ff3_hack_master.asm
#[3]   ff3_command_13.asm
   52                                     .include "ff3_command_13.asm"   ;save
    1                     ; ff3_command_13.asm
    2                     ;
    3                     ; description:
    4                     ;       replaces command 13 (useItem)
    5                     ;
    6                     ; version:
    7                     ;       0.05 (2006-10-28)
    8                     ;======================================================================================================
    9  35:660A            ff3_command_13_begin:
   10                             INIT_PATCH $31,$a65e,$a732
                0031              .bank   $31
                665E              .org    $a65e
       31:665E                    .ds             (($a732) - ($a65e))
                665E              .org    $a65e
   11  31:665E            setupItemCalculation:   ;$31:a65e useItem //dispid:04 [battleFunction04]
   12                     ;[in]
   13           001A      .actionId = $1a
   14           006E      .pActor = $6e
   15           0070      .pTarget = $70
   16                     ;---------------------------------------
   17  31:665E  A0 01             ldy #1
   18  31:6660  8C D5 78          sty battleProcessType
   19  31:6663  85 72             sta <$72
   20  31:6665  85 4B             sta <$4b
   21  31:6667  A9 14             lda #$14
   22  31:6669  8D C2 7E          sta $7ec2
   23  31:666C  A5 1A             lda <.actionId
   24  31:666E  8D D7 78          sta actionName
   25  31:6671  C9 98             cmp #$98        ;magical key
   26  31:6673  B0 27             bcs .not_equip
   27           001A      .pItemParam = $1a
   28  31:6675  A2 08                     ldx #8
   29  31:6677  20 D6 FC                  jsr mul_8x8     ;y is unchanged
   30  31:667A  18                        clc
   31  31:667B  A5 1B                     lda <.pItemParam+1
   32  31:667D  69 94                     adc #$94
   33  31:667F  85 1B                     sta <.pItemParam+1
   34  31:6681  A0 04                     ldy #4
   35  31:6683  B1 1A                     lda [.pItemParam],y
   36  31:6685  29 7F                     and #$7f
   37  31:6687  C9 7F                     cmp #$7f
   38  31:6689  F0 06                     beq .no_effect  ;a722
   39  31:668B  85 1A                     sta <.actionId
   40  31:668D  A9 01                     lda #1
   41  31:668F  D0 7E                     bne .take_effect        ;a71b
   42  31:6691            .no_effect:     ;a722
   43  31:6691  A9 18             lda #$18
   44  31:6693  8D C2 7E          sta $7ec2
   45  31:6696  A9 51             lda #$51        ;"なにも おこらなかった"
   46  31:6698  8D DA 78          sta battleMessages
   47  31:669B  60                rts
   48  31:669C            .not_equip:
   49  31:669C  C9 C8             cmp #$c8
   50  31:669E  B0 F1             bcs .no_effect  ;a722
   51           0046      .pItemEffect = $46
   52           001B      .effectId = $1b
   53                                     ;consumeable item
   54                                     ;$46,47 = (a - #98) + #91a0;
   55  31:66A0  18                        clc
   56  31:66A1  69 08                     adc #08
   57  31:66A3  85 46                     sta <.pItemEffect
   58  31:66A5  A9 00                     lda #0
   59  31:66A7  69 91                     adc #$91
   60  31:66A9  85 47                     sta <.pItemEffect+1
   61  31:66AB  A9 18                     lda #$18
   62  31:66AD  85 4A                     sta <$4a
   63                                     ;fix! v0.6.1
   64  31:66AF  A9 01                     lda #1
   65  31:66B1  85 4B                     sta <$4b
   66                                     ;
   67  31:66B3  A9 17                     lda #$17
   68  31:66B5  20 DC FD                  jsr copyTo7400  ;fddc
   69  31:66B8  AD 00 74                  lda $7400
   70  31:66BB  85 1B                     sta <.effectId
   71  31:66BD  C9 7F                     cmp #$7f
   72  31:66BF  F0 D0                     beq .no_effect  ;a722
   73                                     
   74  31:66C1  AD D8 7E                  lda $7ed8
   75  31:66C4  29 10                     and #$10
   76  31:66C6  F0 06                     beq .consume_item
   77                                     
   78  31:66C8  A5 1A                     lda <.actionId  ;also itemid
   79  31:66CA  C9 AD                     cmp #$ad        ;うちでのこづち
   80  31:66CC  F0 C3                     beq .no_effect  ;a722
   81  31:66CE            .consume_item:
   82  31:66CE  A2 00                             ldx #0
   83  31:66D0                            .find_item:
   84  31:66D0  BD C0 60                                  lda backpackItems,x
   85  31:66D3  C5 1A                                     cmp <.actionId
   86  31:66D5  F0 04                                     beq .found
   87  31:66D7  E8                                        inx
   88  31:66D8  E8                                        inx
   89  31:66D9  D0 F5                                     bne .find_item
   90  31:66DB                            .found: 
   91                                             ;ASSERT(x < 0x40)
   92  31:66DB  E8                                inx
   93  31:66DC  DE C0 60                          dec backpackItems,x
   94  31:66DF  D0 06                             bne .get_cast_count
   95  31:66E1  CA                                        dex
   96  31:66E2  A9 00                                     lda #0
   97  31:66E4  9D C0 60                                  sta backpackItems,x
   98  31:66E7                            .get_cast_count:
   99  31:66E7  A5 1A                             lda <.actionId
  100  31:66E9  A6 1B                             ldx <.effectId
  101  31:66EB  86 1A                             stx <.actionId
  102  31:66ED  C9 A6                             cmp #$a6        ;potion
  103  31:66EF  B0 04                             bcs .load_cast_count
  104  31:66F1  A9 00                                     lda #0
  105  31:66F3  F0 1A                                     beq .take_effect
  106  31:66F5                            .load_cast_count:
  107           0046      .pItemHitCount = $46
  108                                             ;$46,47 = #a35e + (a - #a6);
  109  31:66F5  18                                clc
  110  31:66F6  69 B8                             adc #$b8
  111  31:66F8  85 46                             sta <.pItemHitCount
  112  31:66FA  A9 00                             lda #0
  113  31:66FC  AA                                tax
  114  31:66FD  69 A2                             adc #$a2
  115  31:66FF  85 47                             sta <.pItemHitCount+1
  116  31:7701  A9 18                             lda #$18
  117  31:7703  85 4A                             sta <$4a
  118  31:7705  8A                                txa
  119  31:7706  E8                                inx
  120  31:7707  86 4B                             stx <$4b        ;1
  121  31:7709  20 DC FD                          jsr copyTo7400
  122                                             
  123  31:770C  AD 00 74                          lda $7400
  124  31:770F            .take_effect: ;a71b
  125           007C      .castCountFinal = $7c
  126           0030      .castCount = $30
  127           0001              .ifdef ENABLE_EXTRA_ABILITY_TAG
  128  31:770F  AA                        tax
  129  31:7710  A9 3C                     lda #EXTRA_ABILITY_OFFSET
  130  31:7712  20 98 BE                  jsr b31_setYtoOffsetOf
  131  31:7715  B1 6E                     lda [.pActor],y
  132  31:7717  29 40                     and #PASSIVE_DOUBLE_ITEM_EFFECT
  133  31:7719  F0 03                     beq .effect_normal
  134  31:771B  8A                                txa
  135  31:771C  0A                                asl a
  136  31:771D  AA                                tax
  137  31:771E                    .effect_normal:
  138  31:771E  86 30                     stx <.castCount
  139  31:7720  86 7C                     stx <.castCountFinal
  140                             .endif ;ENABLE_EXTRA_ABILITY_TAG
  141                     
  142  31:7722  4C 77 AF          jmp $af77       ;doSpecialAction
  143                     ;------------------------------------------------------------------------------------------------------
  144                     ;$a732
  145                     ;======================================================================================================
  146                             RESTORE_PC ff3_command_13_begin
                0035              .bank   BANK(ff3_command_13_begin)
                660A              .org    ff3_command_13_begin
#[2]   ff3_hack_master.asm
   53                                             
#[3]   ff3_b34_play_effect.asm
   54                                     .include "ff3_b34_play_effect.asm"      ;save
    1                     ; ff3_b34_play_effect.asm
    2                     ;
    3                     ; description:
    4                     ;       replaces code for controling various effects
    5                     ;
    6                     ; version:
    7                     ;       0.05 (2006-11-30)
    8                     ;======================================================================================================
    9  35:660A            ff3_b34_play_effect_begin:
   10                             ;INIT_PATCH $34,$8411,$843e
   11                             ;INIT_PATCH $34,$83f8,$8460
   12                             INIT_PATCH $34,$8411,$8460
                0034              .bank   $34
                4411              .org    $8411
       34:4411                    .ds             (($8460) - ($8411))
                4411              .org    $8411
   13  34:4411            playEffect:
   14                     ;[in]
   15                     ; u8 $7e9a :    action side flag (80:actor enemy 40:target enemy)
   16                     ; u8 $7ec2 : effectType; set by commandHandler, usually commandId
   17                     ; u8 $7ec3 : (0 or 1?)
   18                     ;playEffect_handlerIndices = $83f8
   19                     ;playEffect_handlers = $843e
   20  34:4411  A2 00             ldx #0
   21  34:4413  2C 9A 7E          bit play_effectTargetSide
   22  34:4416  50 01             bvc .target_player
   23  34:4418  E8                        inx
   24  34:4419            .target_player:
   25  34:4419  8E 6F 7E          stx play_damageTarget
   26                             
   27  34:441C  AC C2 7E          ldy effectHandlerIndex
   28  34:441F  B9 3C 84          lda playEffect_handlerIndices,y
   29  34:4422  C9 01             cmp #1
   30  34:4424  D0 04             bne .not_handler_01
   31  34:4426  18                        clc
   32  34:4427  6D C3 7E                  adc effectHandlerFlag
   33  34:442A            .not_handler_01
   34  34:442A  8D 97 7E          sta $7e97
   35  34:442D  0A                asl a
   36  34:442E  A8                tay
   37  34:442F  B9 57 84          lda playEffect_handlers,y
   38  34:4432  85 18             sta <$18
   39  34:4434  B9 58 84          lda playEffect_handlers+1,y
   40  34:4437  85 19             sta <$19
   41  34:4439  6C 18 00          jmp [$0018]
   42  34:443C            playEffect_handlerIndices:
   43  34:443C  03 03 04          .db $03,$03,$04,$05,$00,$06,$0D,$0D
       34:443F  05 00 06  
       34:4442  0D 0D     
   44  34:4444  07 08 03          .db $07,$08,$03,$03,$03,$03,$03,$09
       34:4447  03 03 03  
       34:444A  03 09     
   45  34:444C  00 0A 0B          .db $00,$0A,$0B,$01,$01,$0C,$0E,$0F
       34:444F  01 01 0C  
       34:4452  0E 0F     
   46  34:4454  10                .db $10
   47                             ;extention to original
   48  34:4455  11                .db $11
   49  34:4456  12                .db $12
   50                     ;$843e
   51  34:4457            playEffect_handlers:
   52  34:4457  13 86             .dw $8613
   53  34:4459  77 85             .dw $8577
   54  34:445B  ED 85             .dw $85ed
   55  34:445D  76 85             .dw $8576       ;effect_for_command_00_01_0a_0b_0c_0d_0e        ;$8576
   56                     
   57  34:445F  B9 84             .dw playEffect_04       ;$853b
   58  34:4461  BD 84             .dw playEffect_05       ;$8540
   59  34:4463  B1 84             .dw playEffect_06       ;$8528
   60  34:4465  B5 84             .dw playEffect_07       ;$852d
   61                     
   62  34:4467  2A 85             .dw playEffect_08       ;$8516
   63  34:4469  1F 85             .dw playEffect_09       ;$850a
   64  34:446B  AD 84             .dw playEffect_0a       ;$8505
   65  34:446D  C1 84             .dw playEffect_0b       ;$84fb
   66                     
   67  34:446F  1B 85             .dw playEffect_0c               ;$84f6
   68  34:4471  FF 84             .dw playEffect_escape   ;$84d7
   69  34:4473  8B 84             .dw playEffect_die              ;$8470
   70  34:4475  7D 84             .dw playEffect_damage   ;$8460
   71                     
   72  34:4477  55 85             .dw $8555
   73  34:4479            playEffect_handlers_end:
   74                     ;$8460:
   75  34:4479  D0 B6             .dw playEffect_provoke
   76  34:447B  9C B8             .dw playEffect_abyss
   77                             ;.ds $04 ;reserve 4bytes
   78                     ;------------------------------------------------------------------------------------------------------
   79                             ;.org   (playEffect_handlers_end + 4)
   80                             
   81  34:447D            playEffect_damage       ;effect 0f
   82           EEE1      .segmentatedEnemyGroup = $7ee1
   83           006E      .pActor = $6e
   84  34:447D  20 8A 86          jsr $868a       ;showDamage
   85  34:4480            .do_usually:
   86  34:4480  AD E1 7E          lda .segmentatedEnemyGroup
   87                             ;cmp #$ff
   88  34:4483  30 23             bmi playEffect_doReturn_00
   89  34:4485  85 7E                     sta <$7e
   90  34:4487  A9 0C                     lda #$0c
   91  34:4489  D0 3D                     bne playEffect_call_2e_9d53
   92                     
   93                     ;$34:8470 playEffect_0e
   94  34:448B            playEffect_die:
   95  34:448B  AD 9A 7E          lda play_effectTargetSide
   96  34:448E  10 06             bpl .actor_is_player
   97  34:4490  20 99 84                  jsr playEffect_0E_worker        ;$8481
   98  34:4493  4C CB 84                  jmp playEffect_8496
   99  34:4496            .actor_is_player:
  100  34:4496  20 CB 84          jsr playEffect_8496
  101                             ;fall through
  102  34:4499            playEffect_0E_worker:
  103  34:4499  A2 00             ldx #0
  104                             ;ldx #$f8
  105  34:449B            .loop:
  106                                     ;lda $78bb - $f8,x
  107                                     ;cmp $7d9b - $f8,x
  108  34:449B  BD BB 78                  lda $78bb,x
  109  34:449E  DD 9B 7D                  cmp $7d9b,x
  110  34:44A1  D0 06                     bne playEffect_present07
  111  34:44A3  E8                        inx
  112  34:44A4  E0 08                     cpx #8
  113  34:44A6  D0 F3                     bne .loop
  114  34:44A8            playEffect_doReturn_00:
  115  34:44A8  60                rts
  116                     
  117  34:44A9            playEffect_present07:
  118  34:44A9  A9 07             lda #$07
  119  34:44AB  D0 1B             bne playEffect_call_2e_9d53
  120                     
  121  34:44AD            playEffect_0a:  ;8505
  122  34:44AD  A9 1A             lda #$1a
  123  34:44AF  D0 12             bne playEffect_set52toActorAndCall
  124                     ;8528 effect06
  125  34:44B1            playEffect_06:  ;8528
  126  34:44B1  A9 15             lda #$15
  127  34:44B3  D0 0E             bne playEffect_set52toActorAndCall
  128                     ;852d effect07 {
  129  34:44B5            playEffect_07:  ;852d
  130  34:44B5  A9 18             lda #$18
  131  34:44B7  D0 0A             bne playEffect_set52toActorAndCall
  132                     
  133  34:44B9            playEffect_04: ;853b
  134  34:44B9  A9 04             lda #$04
  135  34:44BB  D0 06             bne playEffect_set52toActorAndCall 
  136                     
  137  34:44BD            playEffect_05:  ;8540
  138  34:44BD  A9 03             lda #$03
  139  34:44BF  D0 02             bne playEffect_set52toActorAndCall
  140                     
  141  34:44C1            playEffect_0b:
  142  34:44C1  A9 1B             lda #$1b
  143                     ;fall
  144  34:44C3            playEffect_set52toActorAndCall: ;84fd
  145  34:44C3  48                pha
  146  34:44C4  20 3C 85          jsr set52toIndexFromActorBit    ;8532
  147  34:44C7  68                pla
  148                     ;fall
  149  34:44C8            playEffect_call_2e_9d53:
  150  34:44C8  4C 0E FA          jmp call_2e_9d53
  151                     ;------------------------------------------------------------------------------------------------------
  152                     ;$34:8496
  153  34:44CB            playEffect_8496:
  154           DDA7      .enemyIds = $7da7
  155  34:44CB  A2 07             ldx #7
  156  34:44CD            .for_each_enemy:
  157  34:44CD  BC A7 7D                  ldy .enemyIds,x
  158  34:44D0  BD C4 7E                  lda effect_enemyStatus,x
  159  34:44D3  30 10                     bmi .dead
  160  34:44D5  C8                                iny
  161  34:44D6  D0 10                             bne .next
  162                                                     ;enemyId == #$ff
  163  34:44D8  20 F3 84                                  jsr playEffect_buildDeadBits
  164  34:44DB  A5 7E                                     lda <$7e
  165  34:44DD  49 FF                                     eor #$ff
  166  34:44DF  85 7E                                     sta <$7e
  167  34:44E1  A9 0B                                     lda #$0b
  168  34:44E3  D0 E3                                     bne playEffect_call_2e_9d53
  169  34:44E5                    .dead:
  170                                             ;cpy #$ff
  171                                             ;bne .do_die
  172  34:44E5  C8                                iny
  173  34:44E6  D0 04                             bne .do_die
  174  34:44E8                    .next:
  175  34:44E8  CA                        dex
  176  34:44E9  10 E2                     bpl .for_each_enemy
  177  34:44EB  60                rts
  178  34:44EC            .do_die:
  179  34:44EC  20 F3 84          jsr playEffect_buildDeadBits
  180  34:44EF  A9 0A             lda #$0a
  181  34:44F1  D0 D5             bne playEffect_call_2e_9d53
  182                             
  183  34:44F3            playEffect_buildDeadBits:       ;$84c7
  184           007E      .deadBits = $7e
  185  34:44F3  A2 07             ldx #7
  186  34:44F5            .loop:
  187  34:44F5  BD C4 7E                  lda effect_enemyStatus,x
  188  34:44F8  0A                        asl a
  189  34:44F9  66 7E                     ror <.deadBits
  190  34:44FB  CA                        dex
  191  34:44FC  10 F7                     bpl .loop
  192  34:44FE            playEffect_doReturn_01:
  193  34:44FE  60                rts
  194                     ;$84d7:
  195                     ;------------------------------------------------------------------------------------------------------
  196                     ;$34:84d7 playEffect_0d
  197  34:44FF            playEffect_escape:      ;0d
  198  34:44FF  AD 9A 7E          lda play_effectTargetSide
  199  34:5502  30 09             bmi .actor_enemy
  200  34:5504  AD D4 78                  lda $78d4
  201  34:5507  F0 F5                     beq playEffect_doReturn_01
  202  34:5509  A9 21                             lda #$21
  203  34:550B  D0 BB                             bne playEffect_call_2e_9d53
  204  34:550D            .actor_enemy:
  205  34:550D  20 45 85                  jsr $8545 ;dispatchPresenetScene_1f();
  206  34:5510  AD D4 78                  lda $78d4
  207  34:5513  F0 E9                     beq playEffect_doReturn_01
  208  34:5515  85 7E                             sta <$7e
  209  34:5517  A9 0D                             lda #$0d
  210  34:5519  D0 AD                             bne playEffect_call_2e_9d53
  211                     ;$84f6
  212                     ;------------------------------------------------------------------------------------------------------
  213                     ;$34:84f6 playEffect_0c
  214  34:551B            playEffect_0c:
  215  34:551B  A9 24             lda #$24
  216  34:551D  D0 A9             bne playEffect_call_2e_9d53
  217                     ;$84fb
  218                     ;------------------------------------------------------------------------------------------------------
  219  34:551F            playEffect_09:  ;850a
  220  34:551F  20 3C 85          jsr set52toIndexFromActorBit;8532
  221  34:5522  18                clc
  222  34:5523  AD 93 7E          lda $7e93
  223  34:5526  69 16             adc #$16
  224  34:5528  D0 9E             bne playEffect_call_2e_9d53
  225                     ;$8516
  226                     ;$34:8516 effect08
  227  34:552A            playEffect_08:  ;8516
  228  34:552A  20 3C 85          jsr set52toIndexFromActorBit
  229  34:552D  A2 01             ldx #1
  230  34:552F  20 AB 86          jsr targetBitToCharIndex
  231  34:5532  84 B8             sty <$b8
  232  34:5534  A9 19             lda #$19
  233  34:5536  20 0E FA          jsr call_2e_9d53
  234  34:5539  4C 89 86          jmp $8689
  235                             ;.org $8532
  236  34:553C            set52toIndexFromActorBit:       ;8532
  237  34:553C  A2 00             ldx #0
  238  34:553E  20 AB 86          jsr targetBitToCharIndex ;86ab
  239  34:5541  84 52             sty <$52
  240  34:5543  60                rts
  241                     ;8545
  242                     ;------------------------------------------------------------------------------------------------------
  243                     ;quickfix
  244           0035              .bank   $35
  245           AAD5              .org    $bad5
  246  35:AAD5  20 11 84                  jsr playEffect
  247           0034              .bank   $34
  248           558D              .org    $858d
  249  34:558D  20 3C 85                  jsr set52toIndexFromActorBit
  250           0034              .bank   $34
  251           55F0              .org    $85f0
  252  34:55F0  20 3C 85                  jsr set52toIndexFromActorBit
  253                     ;======================================================================================================
  254                             RESTORE_PC ff3_b34_play_effect_begin
                0035              .bank   BANK(ff3_b34_play_effect_begin)
                660A              .org    ff3_b34_play_effect_begin
#[2]   ff3_hack_master.asm
#[3]   ff3_b30_invokeBattleFunction.asm
   55                                     .include "ff3_b30_invokeBattleFunction.asm"
    1                     ; ff3_b30_invokeBattleFunction.asm
    2                     ;
    3                     ;description:
    4                     ;       replaces invokeBattleFunction()
    5                     ;
    6                     ;version:
    7                     ;       0.03 (2006-11-07)
    8                     ;
    9                     ;======================================================================================================
   10  35:660A            ff3_b30_invokeBattleFunction_begin:
   11                             INIT_PATCH $30,$9e58,$9e8a
                0030              .bank   $30
                EE58              .org    $9e58
       30:EE58                    .ds             (($9e8a) - ($9e58))
                EE58              .org    $9e58
   12  30:EE58            invokeBattleFunction:
   13                     ;       least value of S = $12 = $20 - ($0a + $06) (original:$14)
   14                     ;               (dungeon_mainLoop - dungeon_mainLoop - beginBattle - call_doBattle - battleLoop)
   15                     ;                       +(presentBattle - pb_disorderedShot)
   16                     ;                       +(getPlayerCommandInput - commandWindow_OnItem)
   17                     ;                       +(executeAction>command_fight - doCounter - command_fight_doFight)
   18                     ;[in]
   19           004C      .functionId = $4c
   20                     ;.pFunctions = $9e76
   21                     ;note: $18,19,1a are reserved!
   22  30:EE58  A5 4C             lda <.functionId
   23  30:EE5A  0A                asl a
   24  30:EE5B  AA                tax
   25  30:EE5C  BD 69 9E          lda .pFunctions,x
   26  30:EE5F  85 4C             sta <$4c
   27  30:EE61  BD 6A 9E          lda .pFunctions+1,x
   28  30:EE64  85 4D             sta <$4d
   29  30:EE66  6C 4C 00          jmp [$004c]
   30                     ;9e76
   31  30:EE69            .pFunctions:
   32  30:EE69  77 AF             .dw $af77       ;00 doSpecial
   33  30:EE6B  00 A4             .dw $a400       ;01 
   34  30:EE6D  32 A7             .dw $a732       ;02 decideEnemyAction
   35  30:EE6F  8A 9E             .dw $9e8a       ;03 doFight
   36  30:EE71  5E A6             .dw $a65e       ;04 useItem
   37  30:EE73  16 AA             .dw $aa16       ;05 calcBattleParams
   38  30:EE75  E9 A2             .dw $a2e9       ;06
   39  30:EE77  9D BE             .dw $be9d       ;07 calcDataAddress
   40  30:EE79  BF BE             .dw $bebf       ;08 rebuildBackpackItems
   41  30:EE7B  17 BF             .dw $bf17       ;09
   42                             ; end of originally implemented
   43  30:EE7D  5B A8             .dw pickRandomTargetFromEnemyParty      ;0a extra
   44  30:EE7F  28 BB             .dw getNumberOfRandomSuccess                    ;0b extra
   45  30:EE81  44 BB             .dw calcDamage                                          ;0c extra
   46                     ;$30:9e8a
   47                     ;======================================================================================================
   48                             RESTORE_PC ff3_b30_invokeBattleFunction_begin
                0035              .bank   BANK(ff3_b30_invokeBattleFunction_begin)
                660A              .org    ff3_b30_invokeBattleFunction_begin
#[2]   ff3_hack_master.asm
   56                                     
#[3]   ff3_cmdx_provoke.asm
   57                                     .include "ff3_cmdx_provoke.asm"         ;consume( origin )
    1                     ; ff3_cmdx_provoke.asm
    2                     ;
    3                     ; description:
    4                     ;       implements 'provoke' command 
    5                     ;
    6                     ; version:
    7                     ;       0.16 (2007-08-13)
    8                     ;======================================================================================================
    9  35:660A            ff3_cmdx_provoke_begin:
   10                     
   11                     ;======================================================================================================         
   12                     ;consumes space from origin
   13                     
   14           0000              .ifdef PROVOKE_TARGET_SINGLE
   16                             .else
   17           77B6      commandWindow_OnProvoke = commandWindow_decideToTargetAll
   18                             .endif  
   19                     ;======================================================================================================
   20                     ;command handler
   21  35:660A            cmdx_setupPresentParam:
   22                     ;[in] a : effectHanlderIndex
   23                     ;[in] x : actionId * 2
   24  35:660A  8D C2 7E          sta effectHandlerIndex
   25  35:660D  A9 00             lda #0
   26                     ;       sta play_castTargetBits
   27  35:660F  8D 9B 7E          sta play_effectTargetBits
   28  35:6612  8D B8 7E          sta play_reflectedTargetBits
   29  35:6615  4C 57 A8          jmp setupActionType01
   30                     
   31           0000              .ifdef PROVOKE_TARGET_SINGLE
  113                             .else   ;ifdef PROVOKE_TARGET_SINGLE
  114                     
  115  35:6618            cmdx_provoke:
  116  35:6618            doProvokeAll:
  117           006E      .pActor = $6e
  118           0070      .pTarget = $70
  119           0022      .message = $22
  120                     ;.rate = $23
  121           EE89      .effectApplyTarget = $7e89
  122           EE88      .actionIdForEffect = $7e88
  123  35:6618  A9 19             lda #EFFECT_PROVOKE
  124  35:661A  20 0A B6          jsr cmdx_setupPresentParam
  125                     
  126  35:661D  A2 58             ldx #EXMSG_PROVOKE_FAIL
  127  35:661F  86 22             stx <.message
  128  35:6621            .do_provoke:    
  129                             ;init enemy ptr .pTarget = $7675 + #0200 - #40
  130  35:6621  A9 35             lda #$35
  131  35:6623  85 70             sta <.pTarget
  132  35:6625  A9 78             lda #$78
  133  35:6627  85 71             sta <.pTarget+1
  134                             
  135  35:6629  A2 07             ldx #7
  136  35:662B            .change_target: 
  137  35:662B  8A                        txa
  138  35:662C  48                        pha
  139                     
  140  35:662D  BD CD 7E                  lda indexToGroupMap,x
  141  35:6630  30 3B                     bmi .next       ;#ff
  142                     
  143  35:6632  20 27 9A                  jsr isTargetActive
  144  35:6635  90 36                     bcc .next
  145                     
  146  35:6637  A0 30                     ldy #BP_OFFSET_TARGET_FLAG      ;$30
  147  35:6639  B1 70                     lda [.pTarget],y
  148  35:663B  29 C0                     and #TARGET_ENEMY_PARTY | TARGET_MULTIPLE       ;$c0
  149  35:663D  D0 2E                     bne .next
  150                                             ;ok
  151  35:663F  20 82 B6                  jsr hasProvokeSucceeded
  152  35:6642  B0 29                     bcs .next
  153                     
  154  35:6644  20 AD 9F                          jsr setXtoActorIndex
  155  35:6647  20 BA 9F                          jsr flagSingleTarget
  156                                             
  157  35:664A  A0 2F                             ldy #BP_OFFSET_ACTION_TARGET    ;$2f    ;target bits
  158  35:664C  91 70                             sta [.pTarget],y
  159           0001              .ifdef TAG_PROVOKE_EFFECT
  160  35:664E  A0 1E                             ldy #X_BP_OFFSET_PARAM  ;righthand atk (probably unused if .pTarget represents enemy)
  161  35:6650  91 70                             sta [.pTarget],y
  162  35:6652  C8                                iny
  163  35:6653  A9 11                             lda #$10 | PROVOKE_EFFECT_REMAIN
  164  35:6655  91 70                             sta [.pTarget],y
  165                             .endif                          
  166  35:6657  A0 28                             ldy #BP_OFFSET_CRITICAL_RATE    ;$28 (critical rate)
  167  35:6659  A9 4B                             lda #PROVOKE_CRITICAL_RATE
  168  35:665B  91 70                             sta [.pTarget],y        ;75/100 critical!
  169  35:665D  A9 57                             lda #EXMSG_PROVOKE_SUCCESS
  170  35:665F  85 22                             sta <.message
  171                     
  172  35:6661  68                                pla
  173  35:6662  48                                pha
  174  35:6663  AA                                tax
  175  35:6664  AD 9B 7E                          lda play_effectTargetBits
  176  35:6667  20 20 FD                          jsr flagTargetBit
  177  35:666A  8D 9B 7E                          sta play_effectTargetBits
  178  35:666D                    .next:
  179                                     SUB16by8 <.pTarget,#$40
       35:666D  A5 70             lda <.pTarget
       35:666F  38                sec
       35:6670  E9 40             sbc #$40
       35:6672  85 70             sta <.pTarget
       35:6674  B0 02             bcs .sub16by8_00107
       35:6676  C6 71                     dec <.pTarget+1
       35:6678                    .sub16by8_00107:
  180  35:6678  68                        pla
  181  35:6679  AA                        tax
  182  35:667A  CA                        dex
  183  35:667B  10 AE                     bpl .change_target
  184                             ;setup params for display
  185  35:667D            .finish:
  186  35:667D  A5 22             lda <.message
  187  35:667F  4C BF 9F          jmp addBattleMessage
  188                     
  189                             .endif ;PROVOKE_TARGET_SINGLE
  190                     
  191  35:6682            hasProvokeSucceeded:
  192           0023      .penalty = $23
  193           0023      .rate = $23
  194           006E      .pActor = $6e
  195           0070      .pTarget = $70
  196                     
  197  35:6682  A0 0F             ldy #$0f
  198  35:6684  B1 6E             lda [.pActor],y ;joblv
  199  35:6686  A0 00             ldy #0
  200  35:6688  84 23             sty <.penalty
  201  35:668A  18                clc
  202  35:668B  71 6E             adc [.pActor],y ;lv
  203  35:668D  18                clc
  204  35:668E  69 64             adc #PROVOKE_BASE_SUCCESS_RATE
  205  35:6690  90 02             bcc .calc_shield_penalty
  206  35:6692  A9 FF                     lda #$ff
  207  35:6694            .calc_shield_penalty:
  208  35:6694  48                pha
  209  35:6695  B1 70             lda [.pTarget],y        ;lv
  210  35:6697  48                pha
  211  35:6698  A0 31             ldy #$31
  212  35:669A  B1 6E             lda [.pActor],y ;righthand flag
  213  35:669C  10 04             bpl .check_left
  214  35:669E  A9 14                     lda #PROVOKE_SHIELD_PENALTY
  215  35:66A0  85 23                     sta <.penalty
  216  35:66A2            .check_left:
  217  35:66A2  A0 32             ldy #$32
  218  35:66A4  B1 6E             lda [.pActor],y ;lefthand flag
  219  35:66A6  18                clc
  220  35:66A7  10 06             bpl .store_penalty
  221  35:66A9  A5 23                     lda <.penalty
  222  35:66AB  69 14                     adc #PROVOKE_SHIELD_PENALTY
  223  35:66AD  85 23                     sta <.penalty
  224  35:66AF            .store_penalty: 
  225  35:66AF  68                pla
  226  35:66B0  65 23             adc <.penalty
  227  35:66B2  85 23             sta <.penalty
  228  35:66B4  68                pla
  229  35:66B5  38                sec
  230  35:66B6  E5 23             sbc <.penalty
  231  35:66B8  B0 02             bcs .store_rate
  232  35:66BA  A9 01                     lda #1
  233  35:66BC            .store_rate:
  234  35:66BC  85 23             sta <.rate
  235                             ;check for position
  236  35:66BE  A0 33             ldy #$33
  237  35:66C0  B1 6E             lda [.pActor],y
  238  35:66C2  29 01             and #1
  239  35:66C4  F0 02             beq .get_rand
  240  35:66C6  46 23                     lsr <.rate
  241  35:66C8            .get_rand:              
  242  35:66C8  A9 64             lda #100
  243  35:66CA  20 64 A5          jsr getSys1Random
  244  35:66CD  C5 23             cmp <.rate
  245  35:66CF  60                rts
  246                     ;======================================================================================================
  247  35:66D0            playEffect_provoke:
  248  35:66D0  E6 CC             inc <$cc        ;prevent cast motion
  249                     
  250  35:66D2  A9 0F             lda #15         ;'yyyaaa'
  251  35:66D4  85 CA             sta <soundEffectId
  252  35:66D6  A9 20             lda #$20        ;'confuse'
  253  35:66D8  8D 88 7E          sta $7e88       ;effect id
  254                             ;lda play_castTargetBits        
  255                             ;sta $7e89      ;target bits
  256  35:66DB  A9 00             lda #0          ;effect type 0='normal (play on each target)'
  257  35:66DD  8D 9D 7E          sta $7e9d
  258  35:66E0  20 3C 85          jsr set52toIndexFromActorBit    ;$8532
  259  35:66E3  A9 1D             lda #$1d        ;magic (funcid)
  260  35:66E5  4C 0E FA          jmp call_2e_9d53
  261                     ;======================================================================================================
  262  35:66E8            ff3_cmdx_provoke_end:
  263                     ;       RESTORE_PC ff3_cmdx_provoke_begin
#[2]   ff3_hack_master.asm
#[3]   ff3_cmdx_disordered_shot.asm
   58                                     .include "ff3_cmdx_disordered_shot.asm" ;consume( origin )
    1                     ; ff3_cmdx_disordered_shot.asm
    2                     ;
    3                     ; description:
    4                     ;       implements 'disordered shot' command 
    5                     ;
    6                     ; version:
    7                     ;       0.10 (2007-08-13)
    8                     ;======================================================================================================
    9  35:66E8            ff3_cmdx_disorderedShot_begin:
   10                     
   11                     ;------------------------------------------------------------------------------------------------------
   12                             RESTORE_PC pb_handlers_ex
                0034              .bank   BANK(pb_handlers_ex)
                5560              .org    pb_handlers_ex
   13  34:5560  02 B7                     .dw pbx_doDisorderedShot
   14                     ;------------------------------------------------------------------------------------------------------
   15           4450      cmdx_ds_damages = $7450 ;TEMP_RAM+$f0   ;$0110
   16                     ;cmdx_ds_missFlags = cmdx_ds_damages + $20
   17           444F      cmdx_ds_count = cmdx_ds_damages - 1
   18                     
   19                     ;------------------------------------------------------------------------------------------------------
   20                             RESTORE_PC ff3_cmdx_disorderedShot_begin
                0035              .bank   BANK(ff3_cmdx_disorderedShot_begin)
                66E8              .org    ff3_cmdx_disorderedShot_begin
   21                     ;consumes space from origin
   22           77D7      commandWindow_OnDisorderedShot = commandWindow_decideReturn
   23                             ;nothing to do
   24                     ;------------------------------------------------------------------------------------------------------
   25  35:66E8            cmdx_disorderedShot:
   26                             ;setup action params
   27  35:66E8  A9 06             lda #BATTLE_PROCESS_EX_DISORDERED_SHOT
   28  35:66EA  8D D5 78          sta battleProcessType   ;$78d5
   29                             
   30  35:66ED  A9 50             lda #$39+CMDX_DISORDERED_SHOT
   31  35:66EF  8D D7 78          sta actionName  ;action name
   32                             
   33  35:66F2  A2 03             ldx #3
   34  35:66F4  8E 4F 74          stx cmdx_ds_count       ;count
   35  35:66F7            cmdx_initDamageCache:
   36  35:66F7  A9 00             lda #$00
   37  35:66F9  A2 3F             ldx #($40-1)
   38  35:66FB            .init_tag:
   39  35:66FB  9D 50 74                  sta cmdx_ds_damages,x
   40  35:66FE  CA                        dex
   41  35:66FF  10 FA                     bpl .init_tag
   42  35:7701  60                rts
   43                     ;------------------------------------------------------------------------------------------------------
   44  35:7702            pbx_doDisorderedShot:
   45           0064      .iCommand = $64
   46           0052      .index = $52
   47           006E      .pActor = $6e
   48                     
   49  35:7702  A5 62             lda <$62
   50  35:7704  48                pha
   51  35:7705  A5 63             lda <$63
   52  35:7707  48                pha
   53                     
   54  35:7708  A5 64             lda <.iCommand
   55  35:770A  48                pha
   56                     
   57  35:770B  A2 03             ldx #3
   58  35:770D            .reduce_atk_hit:
   59  35:770D  86 52             stx <.index
   60  35:770F  BD F4 B7          lda disorderedShot_offsets,x
   61                             ;weaken attack properties
   62  35:7712  A8                        tay
   63  35:7713  B1 6E                     lda [.pActor],y
   64  35:7715  48                        pha
   65  35:7716  AA                        tax
   66                                     
   67  35:7717  98                        tya
   68  35:7718  48                        pha
   69  35:7719  A0 0F                     ldy #$0f        ;joblv
   70  35:771B  B1 6E                     lda [.pActor],y
   71  35:771D  4A                        lsr a
   72  35:771E  4A                        lsr a
   73  35:771F  18                        clc
   74  35:7720  69 46                     adc #DISORDERED_SHOT_BASE_RATE
   75  35:7722  20 EA F8                  jsr mul_8x8_reg
   76  35:7725  85 18                     sta <$18        ;low
   77  35:7727  86 19                     stx <$19        ;high
   78  35:7729  A9 64                     lda #$64        ;
   79  35:772B  85 1A                     sta <$1a
   80  35:772D  A9 00                     lda #0
   81  35:772F  85 1B                     sta <$1b
   82  35:7731  20 92 FC                  jsr div_16
   83                                     ;$1c = value * (70 + joblv/4) / 100
   84  35:7734  68                        pla
   85  35:7735  A8                        tay
   86  35:7736  A5 1C                     lda <$1c
   87  35:7738  91 6E                     sta [.pActor],y
   88                             ;
   89  35:773A  A6 52             ldx <.index
   90  35:773C  CA                dex
   91  35:773D  10 CE             bpl .reduce_atk_hit
   92                     
   93           0001              .ifdef FAST_DISORDERED_SHOT
   94                     ;v0.6.1
   95  35:773F  A9 09                     lda #$09
   96  35:7741  20 B9 9C                  jsr setIndexAndCallPresentScene
   97                             .endif ;FAST_DISORDERED_SHOT
   98                     
   99  35:7744            disorderedShot_attackRandomTarget:
  100           006E      .pActor = $6e
  101           0062      .targetBit = $62
  102  35:7744  20 F3 9F          jsr initActorDamages    ;workaround
  103                     
  104  35:7747  A0 30             ldy #$30
  105  35:7749  A9 80             lda #$80        ;enemy
  106  35:774B  91 6E             sta [.pActor],y
  107                     
  108  35:774D  4A                lsr a   ;lda #$40       ;actor player | target enemy
  109  35:774E  8D 9A 7E          sta play_effectTargetSide
  110                             
  111  35:7751  88                dey
  112  35:7752  88                dey
  113  35:7753  A9 04             lda #$04        ;fight
  114  35:7755  91 6E             sta [.pActor],y
  115                     
  116  35:7757  20 B4 9F          jsr setXtoActorIndex16
  117  35:775A  B5 F0             lda <$f0,x
  118  35:775C  30 4D             bmi disorderedShot_finish
  119                     ;x=ff
  120  35:775E  20 DA A0          jsr invokePickRandomTarget
  121                     
  122  35:7761  A5 62             lda <.targetBit
  123  35:7763  F0 46             beq disorderedShot_finish
  124                     
  125  35:7765            .valid_target:
  126  35:7765  8A                txa
  127  35:7766  48                pha     ;target index
  128                     
  129  35:7767  20 04 A1          jsr command_fight
  130  35:776A  68                pla
  131  35:776B  48                pha     ;target index
  132  35:776C  20 85 B8          jsr cmdx_sumDamagesOfTargetAndActor
  133                     
  134  35:776F            .done_hp:
  135                     ;------------------------------------------------------------------------------------------------------
  136  35:776F            effect_disorderedShot:
  137                     ;[in]
  138                     ;.actorBits = $7e98
  139           0052      .iPlayer = $52
  140           00B8      .blowTarget = $b8
  141           00BB      .hitCount_right = $bb
  142           00BC      .hitCount_left = $bc
  143                     
  144  35:776F  A2 00             ldx #0
  145  35:7771  8E 96 7E          stx play_arrowTarget
  146                     
  147  35:7774  68                pla     ;target index
  148  35:7775  85 B8             sta <.blowTarget
  149                     
  150           0001              .ifdef FAST_DISORDERED_SHOT
  151  35:7777  A9 26                     lda #PRESENT_SCENE_EX_BLOWONLY
  152  35:7779  20 B9 9C                  jsr setIndexAndCallPresentScene
  153                             .else
  158                             .endif ;FAST_DISORDERED_SHOT
  159                     
  160  35:777C  20 C3 9C          jsr updateTargetStatusByCache
  161                     ;------------------------------------------------------------------------------------------------------
  162  35:777F            pbx_loopDisorderedShot:
  163                     
  164  35:777F  AD E1 7E          lda play_segmentedGroup
  165  35:7782  30 0C             bmi .not_segmented
  166  35:7784  85 7E                     sta <$7e
  167  35:7786  A9 0C                     lda #$0c
  168  35:7788  20 0E FA                  jsr call_2e_9d53
  169  35:778B  A9 FF                     lda #$ff
  170  35:778D  8D E1 7E                  sta play_segmentedGroup
  171                     
  172  35:7790            .not_segmented:
  173  35:7790  AE 4F 74          ldx cmdx_ds_count
  174  35:7793  CA                dex
  175  35:7794  30 15             bmi disorderedShot_finish
  176  35:7796  8E 4F 74                  stx cmdx_ds_count
  177                     
  178  35:7799                    .find_end_of_message:
  179  35:7799  AE EE 78                          ldx battleMessageCount
  180  35:779C  BD DA 78                          lda battleMessages,x
  181  35:779F  C9 FF                             cmp #$ff
  182  35:77A1  F0 05                             beq .message_ok
  183  35:77A3  EE EE 78                          inc battleMessageCount
  184  35:77A6  D0 F1                             bne .find_end_of_message
  185  35:77A8                    .message_ok:
  186  35:77A8  4C 44 B7                  jmp disorderedShot_attackRandomTarget
  187                     
  188  35:77AB            disorderedShot_finish:
  189           0064      .iCommand = $64
  190           004B      .commandId = $4b
  191           006E      .pActor = $6e
  192           0001              .ifdef FAST_DISORDERED_SHOT
  193  35:77AB  A9 08                     lda #$08
  194  35:77AD  20 B9 9C                  jsr setIndexAndCallPresentScene
  195                             .endif ;FAST_DISORDERED_SHOT
  196                     
  197  35:77B0  20 A3 90          jsr pb_showEffectMessage
  198                             
  199           0001              .ifdef SHOW_INFO_ON_DISORDERED_SHOT
  200                     
  201  35:77B3  20 3F 92          jsr pb_showDamage
  202  35:77B6  20 47 92          jsr pb_showDyingEffect
  203  35:77B9  A2 00             ldx #0
  204  35:77BB  8E EE 78          stx battleMessageCount
  205  35:77BE            .show_messages:
  206  35:77BE  20 3A 90                  jsr pb_initString
  207  35:77C1  20 47 91                  jsr pb_showInfoMessage
  208  35:77C4  20 F2 92                  jsr pb_waitConfirmOrTimeout
  209                                     
  210  35:77C7  A9 04                     lda #$04
  211  35:77C9  85 4B                     sta <.commandId
  212  35:77CB  20 D6 94                  jsr pb_closeWindow
  213                             
  214  35:77CE  AE EE 78                  ldx battleMessageCount
  215  35:77D1  BD DA 78                  lda battleMessages,x
  216  35:77D4  C9 FF                     cmp #$ff
  217  35:77D6  D0 E6             bne .show_messages
  218                     
  219  35:77D8  A9 03             lda #$03
  220  35:77DA  85 4B             sta <.commandId
  221  35:77DC  20 D6 94          jsr pb_closeWindow
  222                     
  223                             .endif  ;SHOW_INFO_ON_DISORDERED_SHOT
  224                     ;restore
  225  35:77DF  A2 FC             ldx #$fc
  226  35:77E1            .restore_atk_hit:
  227  35:77E1  BC F8 B6                  ldy disorderedShot_offsets-$fc,x
  228  35:77E4  68                        pla
  229  35:77E5  91 6E                     sta [.pActor],y
  230  35:77E7  E8                        inx
  231  35:77E8  D0 F7                     bne .restore_atk_hit
  232                     ;restore ptr
  233  35:77EA  68                pla
  234  35:77EB  85 64             sta <.iCommand
  235  35:77ED  68                pla
  236  35:77EE  85 63             sta <$63
  237  35:77F0  68                pla
  238  35:77F1  85 62             sta <$62
  239                     
  240  35:77F3  60                rts
  241                     
  242  35:77F4            disorderedShot_offsets:
  243  35:77F4  18 19 1D          .db $18,$19,$1d,$1e
       35:77F7  1E        
  244                     ;======================================================================================================
  245                     
  246  35:77F8            cmdx_sumDamage:
  247                     ;[in] a : index
  248                     ;[out] carry : 1=damage0 
  249           00E0      .statusCache = $e0
  250           0018      .low = $18
  251  35:77F8  0A                asl a
  252  35:77F9  AA                tax
  253                     
  254  35:77FA  BD 4F 7E          lda play_damages,x
  255  35:77FD  A8                tay
  256                     
  257  35:77FE  BD 50 7E          lda play_damages+1,x
  258  35:8801  48                pha
  259  35:8802  C9 FF             cmp #$ff
  260  35:8804  D0 05             bne .valid_damage
  261  35:8806  68                        pla
  262  35:8807  A9 00                     lda #0
  263  35:8809  A8                        tay
  264  35:880A  48                        pha
  265  35:880B            .valid_damage:
  266  35:880B  68                pla
  267  35:880C  29 BF             and #$bf        ;clear miss
  268  35:880E  10 03             bpl .not_heal
  269  35:8810  20 77 B8                  jsr .neg15_y_a
  270  35:8813            .not_heal:
  271  35:8813  48                pha     ;high
  272  35:8814  18                clc
  273  35:8815  98                tya
  274  35:8816  7D 50 74          adc cmdx_ds_damages,x
  275  35:8819  A8                tay     ;low
  276  35:881A  68                pla     ;high
  277  35:881B  7D 51 74          adc cmdx_ds_damages+1,x
  278  35:881E            .check_negative:
  279  35:881E  10 03             bpl .result_damage
  280                     ;healed
  281  35:8820  20 77 B8                  jsr .neg15_y_a
  282  35:8823            .result_damage:
  283  35:8823  48                pha
  284  35:8824  98                tya
  285  35:8825  38                sec
  286  35:8826  E9 10             sbc #LOW(10000)
  287  35:8828  68                pla
  288  35:8829  48                pha
  289  35:882A  29 7F             and #$7f
  290  35:882C  E9 27             sbc #HIGH(10000)
  291  35:882E  90 08             bcc .store_result
  292  35:8830  A0 0F                     ldy #LOW(9999)
  293  35:8832  68                        pla
  294  35:8833  29 80                     and #$80
  295  35:8835  09 27                     ora #HIGH(9999)
  296  35:8837  48                        pha
  297  35:8838            .store_result:
  298  35:8838  98                tya
  299  35:8839  9D 4F 7E          sta play_damages,x
  300  35:883C  68                pla
  301  35:883D  48                pha
  302  35:883E  1D 4F 7E          ora play_damages,x
  303  35:8841  D0 20             bne .store_high
  304                                     ;result0. heal0 or miss
  305  35:8843  BD 50 7E                  lda play_damages+1,x
  306  35:8846  C9 FF                     cmp #$ff
  307  35:8848  D0 02                     bne .not_missed
  308  35:884A  A9 00                             lda #0
  309  35:884C                    .not_missed:
  310  35:884C  29 BF                     and #$bf
  311  35:884E  1D 50 74                  ora cmdx_ds_damages,x
  312  35:8851  1D 51 74                  ora cmdx_ds_damages+1,x
  313  35:8854  D0 09                     bne .heal_0pt
  314  35:8856                    .miss:
  315  35:8856  38                                sec
  316  35:8857  A9 40                             lda #$40
  317  35:8859  9D 50 7E                          sta play_damages+1,x
  318  35:885C  68                                pla
  319  35:885D  F0 09                             beq .check_result_negative
  320  35:885F                    .heal_0pt:
  321                                             ;heal 0pt
  322  35:885F  68                                pla
  323  35:8860  A9 80                             lda #$80
  324  35:8862  48                                pha
  325  35:8863            .store_high:
  326  35:8863  18                clc     ;result (miss flag)
  327  35:8864  68                pla
  328  35:8865  9D 50 7E          sta play_damages+1,x
  329  35:8868            .check_result_negative:
  330  35:8868  10 05             bpl .store_cache
  331  35:886A  20 77 B8                  jsr .neg15_y_a
  332  35:886D  09 80                     ora #$80
  333  35:886F            .store_cache:
  334  35:886F  9D 51 74          sta cmdx_ds_damages+1,x
  335  35:8872  98                tya
  336  35:8873  9D 50 74          sta cmdx_ds_damages,x
  337  35:8876  60                rts
  338  35:8877            .neg15_y_a:
  339                     ;[in] a : high, y: low
  340  35:8877  48                pha
  341  35:8878  98                tya
  342  35:8879  49 FF             eor #$ff
  343  35:887B  18                clc
  344  35:887C  69 01             adc #1
  345  35:887E  A8                tay
  346  35:887F  68                pla
  347  35:8880  49 7F             eor #$7f
  348  35:8882  69 00             adc #0
  349                             ;
  350                             ;ora #$80
  351  35:8884  60                rts
  352                     
  353  35:8885            cmdx_sumDamagesOfTargetAndActor:
  354                     ;[in] a = target index
  355  35:8885  20 F8 B7          jsr cmdx_sumDamage
  356                             ;fall through
  357  35:8888            cmdx_sumActorDamage:
  358  35:8888  20 AD 9F          jsr setXtoActorIndex
  359  35:888B  18                clc
  360  35:888C  69 08             adc #8
  361  35:888E  20 F8 B7          jsr cmdx_sumDamage
  362  35:8891  90 08             bcc .finish
  363                                     ;actor's hp not varied
  364  35:8893  A9 FF                     lda #$ff
  365  35:8895  9D 50 7E                  sta play_damages+1,x
  366  35:8898  9D 4F 7E                  sta play_damages,x
  367  35:889B            .finish:
  368  35:889B  60                rts
  369                     ;-------------------------------------------------------------------------------------------------------
  370                     ;$b979
  371  35:889C            ff3_cmdx_disorderedShot_end:
  372                             VERIFY_PC ff3_magic_window_free_end
       35:889C                    .verify_pc_00110:
                0000              .if (.verify_pc_00110 > ff3_magic_window_free_end)
                                  .endif
  373                             ;.if ff3_cmdx_disorderedShot_end > ff3_magic_window_free_end
  374                             ;       .fail
  375                             ;.endif
#[2]   ff3_hack_master.asm
#[3]   ff3_cmdx_abyss.asm
   59                                     .include "ff3_cmdx_abyss.asm"   ;consume( origin , pb_free )
    1                     ; ff3_cmdx_abyss.asm
    2                     ;
    3                     ; description:
    4                     ;       implements 'abyss' command 
    5                     ;
    6                     ; version:
    7                     ;       0.03 (2006-11-12)
    8                     ;======================================================================================================
    9  35:889C            ff3_cmdx_abyss_begin:
   10                     
   11           0001              .ifdef GIVE_EVILSWORDMAN_ABYSS
   12                     ;======================================================================================================
   13           77B6      commandWindow_OnAbyss = commandWindow_decideToTargetAll
   14                     ;------------------------------------------------------------------------------------------------------
   15                     ;consumes space
   16                             RESTORE_PC pb_free_begin
                0034              .bank   BANK(pb_free_begin)
                3310              .org    pb_free_begin
   17                     
   18  34:3310            calcAbyss:
   19           006E      .pActor = $6e
   20           0070      .pTarget = $70  ;in,const
   21           007C      .count = $7c
   22           0024      .rate = $24
   23           0025      .try = $25
   24           0025      .atkLow = $25
   25           0026      .def = $26
   26           0027      .attr = $27
   27           0028      .bonus = $28
   28           0029      .bonusMul = $29
   29           002A      .divide = $2a
   30           002B      .atkHigh = $2b
   31           0030      .succeeded = $30
   32           00E0      .targetCache = $e0
   33                     
   34  34:3310  A0 13             ldy #$13        ;mevade count
   35  34:3312  B1 70             lda [.pTarget],y
   36  34:3314  85 25             sta <.try
   37  34:3316  C8                iny
   38  34:3317  B1 70             lda [.pTarget],y
   39  34:3319  85 24             sta <.rate
   40  34:331B  20 BB 93          jsr .callGetRandomSucceededCount
   41                     ;       威力 = 75 + 熟練度 + 精神
   42  34:331E  A0 0F             ldy #$0f
   43  34:3320  B1 6E             lda [.pActor],y
   44  34:3322  48                pha
   45  34:3323  18                clc
   46  34:3324  69 4B             adc #75
   47                             ;sta <.atkLow
   48                     
   49  34:3326  C8                iny
   50  34:3327  C8                iny
   51  34:3328  71 6E             adc [.pActor],y
   52  34:332A  90 02             bcc .store_atk
   53  34:332C  A9 FF                     lda #$ff
   54  34:332E            .store_atk
   55  34:332E  85 25             sta <.atkLow
   56                     ;       回数 = 1 + 熟練度/16 + 精神/8
   57  34:3330  B1 6E             lda [.pActor],y
   58  34:3332  4A                lsr a
   59  34:3333  4A                lsr a
   60  34:3334  4A                lsr a
   61  34:3335  85 7C             sta <.count
   62  34:3337  68                pla     ;joblv
   63  34:3338  4A                lsr a
   64  34:3339  4A                lsr a
   65  34:333A  4A                lsr a
   66  34:333B  4A                lsr a
   67  34:333C  38                sec
   68  34:333D  65 7C             adc <.count
   69                             ;adc #2
   70  34:333F  38                sec
   71  34:3340  E5 30             sbc <.succeeded
   72  34:3342  B0 02             bcs .store_count
   73  34:3344  A9 00                     lda #0
   74  34:3346            .store_count:
   75  34:3346  85 7C             sta <.count
   76                     ;
   77  34:3348  A0 15             ldy #$15
   78  34:334A  B1 70             lda [.pTarget],y
   79  34:334C  85 26             sta <.def
   80                     ;attr check
   81  34:334E  A2 00             ldx #0
   82  34:3350  86 28             stx <.bonus
   83  34:3352  86 29             stx <.bonusMul
   84  34:3354  86 2B             stx <.atkHigh
   85  34:3356  E8                inx
   86  34:3357  86 2A             stx <.divide    ;1
   87  34:3359  E8                inx
   88                     
   89  34:335A  A0 20             ldy #$20
   90  34:335C  B1 70             lda [.pTarget],y
   91  34:335E  29 02             and #$02        ;dark
   92  34:3360  F0 02             beq .not_strong
   93  34:3362  A2 01                     ldx #1
   94  34:3364            .not_strong:
   95  34:3364  A0 12             ldy #$12
   96  34:3366  B1 70             lda [.pTarget],y
   97  34:3368  29 02             and #$02        ;dark
   98  34:336A  F0 02             beq .not_weak
   99  34:336C  A2 04                     ldx #4
  100  34:336E            .not_weak:
  101                             ;x = 1(strong) 2(normal) 4(weak)
  102  34:336E  86 27             stx <.attr
  103                             ;calcDamage(hitcount:$7c, atk:$25,2b, def:$26, 
  104                             ;       attr:$27, bonus:$28, bonusMul:$29, divide:$2a);
  105  34:3370  20 BF 93          jsr .callCalcDamage
  106           001C      .resultDamage = $1c
  107  34:3373  20 A6 9F          jsr setXtoTargetIndex
  108                     ;flag target
  109  34:3376  AD 9B 7E          lda play_effectTargetBits
  110  34:3379  20 20 FD          jsr flagTargetBit
  111  34:337C  8D 9B 7E          sta play_effectTargetBits
  112                     
  113  34:337F  8A                txa
  114  34:3380  0A                asl a
  115  34:3381  AA                tax
  116  34:3382  A5 1C             lda <.resultDamage
  117  34:3384  9D 4F 7E          sta play_damages,x
  118  34:3387  A5 1D             lda <.resultDamage+1
  119  34:3389  9D 50 7E          sta play_damages+1,x
  120                     ;apply damage
  121  34:338C  A0 03             ldy #3
  122  34:338E  38                sec
  123  34:338F  B1 70             lda [.pTarget],y
  124  34:3391  E5 1C             sbc <.resultDamage
  125  34:3393  91 70             sta [.pTarget],y
  126  34:3395  C8                iny
  127  34:3396  B1 70             lda [.pTarget],y
  128  34:3398  E5 1D             sbc <.resultDamage+1
  129  34:339A  91 70             sta [.pTarget],y
  130  34:339C  88                dey
  131  34:339D  11 70             ora [.pTarget],y
  132  34:339F  F0 02             beq .target_dead
  133  34:33A1  B0 0B             bcs .remove_segmenting_abiliy
  134  34:33A3            .target_dead:
  135                                     ;result minus (target dead)
  136  34:33A3  A9 00                     lda #0
  137  34:33A5  91 70                     sta [.pTarget],y
  138  34:33A7  C8                        iny
  139  34:33A8  91 70                     sta [.pTarget],y
  140  34:33AA  A9 80                     lda #$80
  141  34:33AC  95 E0                     sta <.targetCache,x
  142  34:33AE            .remove_segmenting_abiliy:
  143                             ;
  144  34:33AE  A0 38             ldy #$38
  145  34:33B0  B1 70             lda [.pTarget],y        ;actionId[0]
  146  34:33B2  C9 4F             cmp #$4f        ;4f:segment
  147  34:33B4  D0 04             bne .finish
  148                             ;remove target's segmenting ability
  149  34:33B6  A9 34                     lda #$34        ;34: care
  150  34:33B8  91 70                     sta [.pTarget],y
  151  34:33BA            .finish:
  152  34:33BA  60                rts
  153  34:33BB            .callGetRandomSucceededCount:
  154  34:33BB  A9 0B             lda #BF_GET_RANDOM_SUCCEEDED_COUNT
  155  34:33BD  D0 02             bne .call
  156  34:33BF            .callCalcDamage:
  157  34:33BF  A9 0C             lda #BF_CALC_DAMAGE
  158  34:33C1            .call:
  159           004C      .functionId = $4c
  160  34:33C1  85 4C             sta <.functionId
  161  34:33C3  4C F3 FD          jmp invoke_b30_battleFunction   ;fdf3
  162  34:33C6            calcAbyss_end:
  163                     ;------------------------------------------------------------------------------------------------------
  164                     ;consumes space from origin
  165                             RESTORE_PC ff3_cmdx_abyss_begin
                0035              .bank   BANK(ff3_cmdx_abyss_begin)
                889C              .org    ff3_cmdx_abyss_begin
  166  35:889C            playEffect_abyss:
  167           00CC      .castFlag = $cc
  168  35:889C  E6 CC             inc <.castFlag  ;prevent cast
  169                             ;inc <$cb       ;critical flag?
  170  35:889E  A9 0B             lda #$0b
  171                             ;lda #$00
  172  35:88A0  8D 9D 7E          sta play_magicType      ;7e9d
  173                             ;lda #$10       ;'dimension'
  174  35:88A3  A9 4A             lda #$4a        ;mega flare
  175                             ;lda #$68
  176  35:88A5  8D 88 7E          sta $7e88       ;effect id
  177                     
  178                     
  179                             ;lda #$4a       ;wavecannon
  180                             ;lda #$11       ;death
  181  35:88A8  A9 47             lda #$47        ;sound of dimension
  182                             ;lda #$22
  183  35:88AA  85 CA             sta <soundEffectId
  184                             
  185  35:88AC  A9 27             lda #PRESENT_SCENE_EX_ABYSS
  186  35:88AE  20 B9 9C          jsr setIndexAndCallPresentScene
  187  35:88B1  A9 00             lda #0
  188  35:88B3  85 CC             sta <.castFlag
  189  35:88B5  60                rts
  190                     ;------------------------------------------------------------------------------------------------------
  191  35:88B6            cmdx_abyss:
  192           006E      .pActor = $6e
  193           00F0      .actorStatusCache = $f0
  194  35:88B6  A9 1A             lda #EFFECT_ABYSS
  195                     ;       sta effectHandlerIndex
  196  35:88B8  20 0A B6          jsr cmdx_setupPresentParam
  197                     
  198                     ;main calcs
  199           0070      .pTarget = $70
  200                             INIT16 <.pTarget,$7835
       35:88BB  A9 35             lda #LOW($7835)
       35:88BD  85 70             sta <.pTarget
       35:88BF  A9 78             lda #HIGH($7835)
       35:88C1  85 71             sta <.pTarget+1
  201  35:88C3  A2 07             ldx #7
  202  35:88C5            .for_each_enemy:
  203  35:88C5  8A                        txa
  204  35:88C6  48                        pha
  205  35:88C7  A9 E8                     lda #$e8        ;dead | stone | toad | minimum
  206  35:88C9  A2 00                     ldx #$00
  207  35:88CB  20 2B 9A                  jsr isTargetNotInStatus
  208  35:88CE  90 03                     bcc .offset_ptr
  209                                             ;ok
  210  35:88D0  20 10 93                          jsr calcAbyss
  211  35:88D3                    .offset_ptr:
  212                                     SUB16by8 <.pTarget,#$40
       35:88D3  A5 70             lda <.pTarget
       35:88D5  38                sec
       35:88D6  E9 40             sbc #$40
       35:88D8  85 70             sta <.pTarget
       35:88DA  B0 02             bcs .sub16by8_00114
       35:88DC  C6 71                     dec <.pTarget+1
       35:88DE                    .sub16by8_00114:
  213  35:88DE  68                        pla
  214  35:88DF  AA                        tax
  215  35:88E0  CA                        dex
  216  35:88E1  10 E2                     bpl .for_each_enemy
  217                     
  218  35:88E3  20 A9 A9          jsr damageActorByQuoterHalf     ;also set x to cache index
  219                     ;setup message and effect params
  220  35:88E6  A9 5D             lda #EXMSG_ABYSS_MESSAGE
  221  35:88E8  4C BF 9F          jmp addBattleMessage
  222                     ;       sta battleMessages
  223                     ;       lda .actorStatusCache,x
  224                     ;       bpl .finish
  225                     ;               ldx #1
  226                     ;               stx battleMessageCount
  227                     ;               lda #$1a        ;"しんでしまった"
  228                     ;               sta battleMessages,x
  229                     ;.finish:
  230                     ;       rts
  231                             ;jsr setXtoActorIndex
  232                             ;jmp setupWeaponId
  233                     
  234                     ;======================================================================================================         
  235  35:88EB            ff3_cmdx_abyss_end:
  236                             VERIFY_PC ff3_magic_window_free_end
       35:88EB                    .verify_pc_00115:
                0000              .if (.verify_pc_00115 > ff3_magic_window_free_end)
                                  .endif
  237                             ;.if ff3_cmdx_abyss_end >= ff3_magic_window_free_end
  238                             ;       .fail
  239                             ;.endif
  240                             
  241                             .else   ;GIVE_EVILSWORDMAN_ABYSS
  248                             .endif  ;GIVE_EVILSWORDMAN_ABYSS
#[2]   ff3_hack_master.asm
#[3]   ff3_cmdx_raid.asm
   60                                     .include "ff3_cmdx_raid.asm"    ;consume( origin )
    1                     ; ff3_cmdx_raid.asm
    2                     ;
    3                     ; description:
    4                     ;       implements 'raid' command 
    5                     ;
    6                     ; version:
    7                     ;       0.04 (2006-11-13)
    8                     ;======================================================================================================
    9  35:88EB            ff3_cmdx_raid_begin:
   10                     
   11           77C1      commandWindow_OnRaid = commandWindow_selectSingleTargetAndNext
   12                     
   13  35:88EB            cmdx_raid:
   14                     ; [in] x : actionid << 1
   15                             DECLARE_COMMAND_VARS
                0052      .iPlayer = $52
                0057      .pBaseParam = $57
                0059      .pEquips = $59
                005B      .pBattleParam = $5b
                005D      .pTargetBase = $5d
                005F      .offset = $5f
   16           006E      .pActor = $6e
   17           00E0      .targetStatusCache = $e0
   18           00F0      .actorStatusCache = $f0
   19  35:88EB  20 1E 9A          jsr isTargetActor
   20  35:88EE  D0 12             bne .ok
   21                             ;target == actor. confuse it as player
   22  35:88F0  20 6D AA                  jsr setupNoMotionType01
   23  35:88F3  A9 60                     lda #$52+$0e    ;こんらん
   24  35:88F5  8D D7 78                  sta actionName
   25  35:88F8  20 B4 9F                  jsr setXtoActorIndex16
   26  35:88FB  B5 F1                     lda <.actorStatusCache+1,x
   27  35:88FD  09 28                     ora #$28        ;こんらん (remain1)
   28  35:88FF  95 F1                     sta <.actorStatusCache+1,x
   29  35:9901  60                        rts
   30  35:9902            .ok:
   31  35:9902  A9 04             lda #4
   32  35:9904  8D C2 7E          sta effectHandlerIndex
   33  35:9907  A0 2E             ldy #$2e
   34  35:9909  91 6E             sta [.pActor],y
   35  35:990B  20 F7 B6          jsr cmdx_initDamageCache
   36                             ;
   37  35:990E  A0 0F             ldy #$0f
   38  35:9910  B1 6E             lda [.pActor],y
   39  35:9912  4A                lsr a
   40  35:9913  4A                lsr a
   41  35:9914  4A                lsr a
   42  35:9915  18                clc
   43  35:9916  69 08             adc #$08
   44  35:9918  A0 27             ldy #$27
   45  35:991A  91 6E             sta [.pActor],y
   46                     
   47  35:991C  20 04 A1          jsr command_fight
   48  35:991F  20 C3 9C          jsr updateTargetStatusByCache
   49  35:9922  20 27 9A          jsr isTargetActive
   50  35:9925  90 2D             bcc .sumDamages
   51                     ;               jsr isTargetActor
   52                     ;               beq .sumDamages
   53                     
   54  35:9927  A9 5E                     lda #EXMSG_RAID_MESSAGE
   55  35:9929  20 BF 9F                  jsr addBattleMessage
   56                     
   57  35:992C  AD E1 7E                  lda play_segmentedGroup
   58  35:992F  48                        pha
   59  35:9930  AD D7 78                  lda actionName
   60  35:9933  48                        pha
   61  35:9934  20 DE 9F                  jsr swapHitCounts
   62                     
   63  35:9937  20 54 B9                  jsr .sumDamages
   64  35:993A  20 EF 9F                  jsr initAllDamages
   65                     
   66  35:993D  20 95 A2                  jsr command_fight_counter
   67  35:9940  20 AD 9F                  jsr setXtoActorIndex
   68  35:9943  20 E6 A2                  jsr setupWeaponId
   69  35:9946  20 DE 9F                  jsr swapHitCounts
   70                     
   71  35:9949  68                        pla
   72  35:994A  8D D7 78                  sta actionName
   73  35:994D  68                        pla
   74  35:994E  8D E1 7E                  sta play_segmentedGroup
   75                     
   76  35:9951  20 CA 9F                  jsr swapDamages
   77                     
   78  35:9954            .sumDamages:
   79  35:9954  20 A6 9F          jsr setXtoTargetIndex
   80  35:9957  4C 85 B8          jmp cmdx_sumDamagesOfTargetAndActor
   81                     
   82  35:995A            cmdx_raid_end:
   83                             VERIFY_PC ff3_magic_window_free_end
       35:995A                    .verify_pc_00117:
                0000              .if (.verify_pc_00117 > ff3_magic_window_free_end)
                                  .endif
   84                     ;======================================================================================================
   85                             RESTORE_PC ff3_cmdx_raid_begin
                0035              .bank   BANK(ff3_cmdx_raid_begin)
                88EB              .org    ff3_cmdx_raid_begin
#[2]   ff3_hack_master.asm
   61                                     ;v0.6.1:
#[3]   ff3_present_scene.asm
   62                                     .include "ff3_present_scene.asm"
    1                     ; ff3_present_scene.asm
    2                     ;
    3                     ;description:
    4                     ;       replaces presentScene()
    5                     ;
    6                     ;version:
    7                     ;       0.01 (2006-10-28)
    8                     ;
    9                     ;======================================================================================================
   10  35:88EB            ff3_present_scene_begin:
   11                     
   12                     ;       [in] u8 A : commandId (00-25h)
   13                     ;               01 : さがる(char:$52)
   14                     ;               02 : 指示するキャラが前に出る(char:$52)
   15                     ;               03 : playEffect_05 (back(03) )
   16                     ;               04 : playEffect_04 (forward(02) )
   17                     ;               07 : playEffect_0e(死亡・味方)
   18                     ;               08 : $b38e 行動中のキャラを示す(一定のラインまで前に出る)
   19                     ;               09 : $b38b 行動終了したキャラを元の位置まで戻す
   20                     ;               0a : playEffect_0e(死亡・敵 $7e=死亡bit(各bitが敵1体に相当) )
   21                     ;               0b : playEffect_0e
   22                     ;                       (蘇生? bitが立っている敵の枠に敵がいたならグラ復活
   23                     ;                        生存かつ非表示の敵がいたとき $7e=生存bit で呼ばれる)
   24                     ;               0C : 敵生成(召還・分裂・増殖) playEffect_0F (disp_0C)
   25                     ;               0d : playEffect_0c (escape(06/07) : $7e9a(sideflag) < 0)
   26                     ;               0e :
   27                     ;               
   28                     ;               0F : prize($35:bb49)
   29                     ;               10 : 対象選択
   30                     ;               12 : 打撃モーション&エフェクト(char:$52)
   31                     ;               13 : presentCharacter($34:8185)
   32                     ;               14 : playEffect_00 (fight/sing 被弾モーション?)
   33                     ;               15 : playEffect_06 (defend(05) )
   34                     ;               16 : playEffect_09 (charge(0f) 通常)
   35                     ;               17 : playEffect_09 (charge(0f) ためすぎ)
   36                     ;               18 : playEffect_07 (jump(08) )
   37                     ;               19 : playEffect_08 (landing(09) )
   38                     ;               1a : playEffect_0a (intimidate(11) )
   39                     ;               1b : playEffect_0b (cheer(12) )
   40                     ;               1c : playEffect_0F (disp_0C) ダメージ表示?
   41                     ;               1d : playEffect_01 (command13/ cast/item)
   42                     ;               1f : playEffect_00 行動する敵が点滅
   43                     ;               20 : playEffect_00 (fight/sing 敵の打撃エフェクト?)
   44                     ;               21 : playEffect_0d (escape(06/07) : $7e9a(effectside) >= 0)
   45                     ;               22 : playEffect_01 (magicparam+06 == #07)
   46                     ;               23 : playEffect_01 (magicparam+06 == #0d)
   47                     ;               24 : playEffect_0c (command15)
   48                     ;       [in] u8 X : actorIndex
   49                     ;       [out] u8 $7d7d : 0
   50                             INIT_PATCH $2f,$af4e,$afc0
                002F              .bank   $2f
                FF4E              .org    $af4e
       2F:FF4E                    .ds             (($afc0) - ($af4e))
                FF4E              .org    $af4e
   51                     
   52  2F:FF4E            presentScene:
   53                     ;.handlers = $af74
   54  2F:FF4E  86 95             stx <$95
   55  2F:FF50  0A                asl a
   56  2F:FF51  18                clc
   57  2F:FF52  69 6A             adc #LOW(.handlers)
   58  2F:FF54  85 93             sta <$93
   59  2F:FF56  A9 AF             lda #HIGH(.handlers)
   60  2F:FF58  85 94             sta <$94
   61  2F:FF5A  A9 6C             lda #$6c
   62  2F:FF5C  85 92             sta <$92
   63  2F:FF5E  98                tya
   64  2F:FF5F  48                pha
   65  2F:FF60  8A                txa
   66  2F:FF61  48                pha
   67  2F:FF62  20 92 00          jsr $0092
   68  2F:FF65  68                pla
   69  2F:FF66  AA                tax
   70  2F:FF67  68                pla
   71  2F:FF68  A8                tay
   72  2F:FF69  60                rts
   73                     ;$2f:af74 $af4e_funcTable;
   74  2F:FF6A            .handlers:
   75  2F:FF6A  69 B4             .dw $b469, $b3c7, $b3cd, $b42a
       2F:FF6C  C7 B3     
       2F:FF6E  CD B3     
       2F:FF70  2A B4     
   76  2F:FF72  43 B4             .dw $b443, $b3f6, $b3d9, $b3d3
       2F:FF74  F6 B3     
       2F:FF76  D9 B3     
       2F:FF78  D3 B3     
   77  2F:FF7A  8B B3             .dw $b38b, $b38e, $b33e, $b343
       2F:FF7C  8E B3     
       2F:FF7E  3E B3     
       2F:FF80  43 B3     
   78  2F:FF82  48 B3             .dw $b348, $b34d, $b304, $b2eb
       2F:FF84  4D B3     
       2F:FF86  04 B3     
       2F:FF88  EB B2     
   79                     
   80  2F:FF8A  FA B2             .dw $b2fa, $b260, $b24f, $b24c
       2F:FF8C  60 B2     
       2F:FF8E  4F B2     
       2F:FF90  4C B2     
   81  2F:FF92  01 B2             .dw $b201, $b246, $b1d8, $b1e0
       2F:FF94  46 B2     
       2F:FF96  D8 B1     
       2F:FF98  E0 B1     
   82  2F:FF9A  CF B1             .dw $b1cf, $b1c1, $b1b5, $b1af
       2F:FF9C  C1 B1     
       2F:FF9E  B5 B1     
       2F:FFA0  AF B1     
   83  2F:FFA2  AC B1             .dw $b1ac, $b15e, $b050, $b024
       2F:FFA4  5E B1     
       2F:FFA6  50 B0     
       2F:FFA8  24 B0     
   84                     
   85  2F:FFAA  05 B0             .dw $b005, $af24, $afff, $afe7
       2F:FFAC  24 AF     
       2F:FFAE  FF AF     
       2F:FFB0  E7 AF     
   86  2F:FFB2  44 AF             .dw $af44, $afd8
       2F:FFB4  D8 AF     
   87                             ;extra
   88                             ;$26
   89  2F:FFB6  97 B3             .dw psx_blowOnly
   90  2F:FFB8  A0 B3             .dw psx_abyss
   91                     ;------------------------------------------------------------------------------------------------------
   92                     ;$2f:b352 moveCharacterBack
   93                             INIT_PATCH $2f,$b352,$b388
                002F              .bank   $2f
                3352              .org    $b352
       2F:3352                    .ds             (($b388) - ($b352))
                3352              .org    $b352
   94                     
   95  2F:3352            moveCharacterBack:
   96                     ;       [in] x : actorIndex
   97           DD7F      .goals = $7d7f
   98  2F:3352  20 64 B3          jsr getMoveOffset
   99  2F:3355  18                clc
  100                     ;fall through
  101  2F:3356            moveCharacter_addAndStoreGoal:
  102           DD7F      .goals = $7d7f
  103  2F:3356  30 03             bmi .confused
  104  2F:3358  EE 7D 7D                  inc $7d7d
  105  2F:335B            .confused:
  106  2F:335B  7D 7F 7D          adc .goals,x
  107  2F:335E  9D 7F 7D          sta .goals,x
  108  2F:3361  4C 5C B4          jmp $b45c       ;
  109                     
  110  2F:3364            getMoveOffset:
  111                     ;[out] u8 a,$7e : offset
  112  2F:3364  A9 00             lda #0
  113  2F:3366  8D 7D 7D          sta $7d7d
  114  2F:3369  8A                txa
  115  2F:336A  0A                asl a
  116  2F:336B  A8                tay
  117  2F:336C  B9 9B 7D          lda $7d9b,y
  118  2F:336F  29 08             and #$08
  119  2F:3371  F0 04             beq .not_confused
  120                     ;backattack
  121  2F:3373  A9 F0                     lda #$f0
  122  2F:3375  D0 09                     bne .store_and_set_x
  123  2F:3377            .not_confused:
  124  2F:3377  BD 8F 7D                  lda $7d8f,x
  125  2F:337A  4A                        lsr a
  126  2F:337B  A9 10                     lda #$10
  127  2F:337D  90 01                     bcc .at_front_line
  128  2F:337F  0A                                asl a
  129  2F:3380                    .at_front_line:
  130  2F:3380            .store_and_set_x:
  131  2F:3380  85 7E             sta <$7e
  132  2F:3382  60                rts
  133                     ;------------------------------------------------------------------------------------------------------
  134                     ;$2f:b38e moveCharacterForward
  135                             INIT_PATCH $2f,$b38e,$b3c7
                002F              .bank   $2f
                338E              .org    $b38e
       2F:338E                    .ds             (($b3c7) - ($b38e))
                338E              .org    $b38e
  136                     
  137  2F:338E            moveCharacterForward:
  138                     ;       [in] x : actorIndex
  139           DD7F      .goals = $7d7f
  140  2F:338E  20 64 B3          jsr getMoveOffset
  141  2F:3391  49 FF             eor #$ff
  142  2F:3393  38                sec
  143  2F:3394  4C 56 B3          jmp moveCharacter_addAndStoreGoal
  144                     ;------------------------------------------------------------------------------------------------------
  145                     
  146  2F:3397            psx_blowOnly:
  147  2F:3397  20 CF A9          jsr $a9cf       ;$a9cf();       
  148  2F:339A  20 EA A8          jsr $a8ea       ;loadBlowEffectParams();        // $a8ea();
  149  2F:339D  4C F0 AE          jmp $aef0       ;dispatchEffectFunction_04();   //$aef0();      //打撃モーション
  150                             
  151  2F:33A0            psx_abyss:
  152  2F:33A0  20 8E B3          jsr moveCharacterForward
  153                             ;presentScene_16 (charge)
  154  2F:33A3  A9 00             lda #0
  155  2F:33A5  8D 19 7E          sta $7e19       ;charge motion flag
  156  2F:33A8  20 CF A9          jsr $a9cf;
  157  2F:33AB  20 B1 A9          jsr $a9b1;
  158  2F:33AE  20 FC AE          jsr $aefc;      dispatchEffectFunction_07();
  159                             ;jsr psx_blowOnly       ;destorys x
  160  2F:33B1  20 CF A9          jsr $a9cf
  161  2F:33B4  20 14 AF          jsr $af14       ;dispatchEffectFunction_0d
  162  2F:33B7  A9 06             lda #6
  163  2F:33B9  20 B3 A1          jsr $a1b3       ;clear sprites
  164  2F:33BC  A6 95             ldx <$95        ;index
  165  2F:33BE  4C C7 B3          jmp $b3c7       ;backAndUpdatePpu
  166                     ;$b3c7:
  167                     ;======================================================================================================
  168                             RESTORE_PC ff3_present_scene_begin
                0035              .bank   BANK(ff3_present_scene_begin)
                88EB              .org    ff3_present_scene_begin
#[2]   ff3_hack_master.asm
   63                                     ;v0.7.0:
#[3]   ff3_doFight.asm
   64                                     .include "ff3_doFight.asm"
    1                     ; ff3_doFight.asm
    2                     ;
    3                     ;description:
    4                     ;       replaces calculation for command 'fight'
    5                     ;
    6                     ;version:
    7                     ;       0.04 (2006-11-11)
    8                     ;======================================================================================================
    9  35:88EB            ff3_battle_calc_begin:
   10                     
   11                             ;INIT_PATCH $31,$a000,$a2b5
   12                             INIT_PATCH $31,$a000,$a290
                0031              .bank   $31
                0000              .org    $a000
       31:0000                    .ds             (($a290) - ($a000))
                0000              .org    $a000
   13                             INIT_PATCH $30,$9e8a,$a000
                0030              .bank   $30
                EE8A              .org    $9e8a
       30:EE8A                    .ds             (($a000) - ($9e8a))
                EE8A              .org    $9e8a
   14                     
   15                     DEF_DO_FIGHT_VARS       .macro
   16                     .atkHigh = $2b
   17                     .atkLow = $25
   18                     .def = $26
   19                     .criticalBonus = $28
   20                     .criticalCount = $29
   21                     .damageDivider = $2a
   22                     .pActor = $6e
   23                     .pTarget = $70
   24                     .escapeCount = $74
   25                     .isGuarding = $7ce4
   26                     .isFarTarget = $7ce9
   27                     ;[out]
   28                     .hitCount_1st = $7c
   29                     .hitCount_2nd = $7d
   30                     .protectFlag = $7edf
   31                     ;[out] shared with checkSegment()
   32                     .hitCountForBlow_1st = $bb
   33                     .hitCountForBlow_2nd = $bc
   34                     ;locals:
   35                     .targetHp = $3c
   36                     .actorHp = $40
   37                     .doubleArmed = $741e
   38                     .handCount = $741f
   39                     .attackProps = $7440
   40                     .defProps = $742a
   41                     ;shared with cacheStatus()
   42                     .iActorCache = $62
   43                     .iTargetCache = $64
   44                     .iActor = $66
   45                     .iTarget = $68
   46                     .actorStatusCache = $f0
   47                     .targetStatusCache = $e0
   48                     ;shared with sumDamage()
   49                     .damageForDisplay = $6a
   50                     .damage = $78
   51                             .endm   ;DEF_DO_FIGHT_VARS
   52  30:EE8A            doFight:
   53                             DEF_DO_FIGHT_VARS
                002B      .atkHigh = $2b
                0025      .atkLow = $25
                0026      .def = $26
                0028      .criticalBonus = $28
                0029      .criticalCount = $29
                002A      .damageDivider = $2a
                006E      .pActor = $6e
                0070      .pTarget = $70
                0074      .escapeCount = $74
                CCE4      .isGuarding = $7ce4
                CCE9      .isFarTarget = $7ce9
                          ;[out]
                007C      .hitCount_1st = $7c
                007D      .hitCount_2nd = $7d
                EEDF      .protectFlag = $7edf
                          ;[out] shared with checkSegment()
                00BB      .hitCountForBlow_1st = $bb
                00BC      .hitCountForBlow_2nd = $bc
                          ;locals:
                003C      .targetHp = $3c
                0040      .actorHp = $40
                441E      .doubleArmed = $741e
                441F      .handCount = $741f
                4440      .attackProps = $7440
                442A      .defProps = $742a
                          ;shared with cacheStatus()
                0062      .iActorCache = $62
                0064      .iTargetCache = $64
                0066      .iActor = $66
                0068      .iTarget = $68
                00F0      .actorStatusCache = $f0
                00E0      .targetStatusCache = $e0
                          ;shared with sumDamage()
                006A      .damageForDisplay = $6a
                0078      .damage = $78
   54                     ;------------------------------------------------------------------------------------------------------
   55  30:EE8A  20 BA A2          jsr cacheStatus
   56  30:EE8D  A6 64             ldx <.iTargetCache
   57  30:EE8F  B5 E0             lda <.targetStatusCache,x
   58  30:EE91  30 08             bmi .bad_target
   59  30:EE93  0A                asl a
   60  30:EE94  30 05             bmi .bad_target
   61                             
   62  30:EE96  B5 E1             lda <.targetStatusCache+1,x
   63  30:EE98  4A                lsr a   ;jumping
   64  30:EE99  90 2B             bcc .begin_calc
   65                     
   66  30:EE9B            .bad_target:
   67           0022      .pTargetSideBase = $22
   68                     
   69  30:EE9B  A9 75             lda #$75
   70  30:EE9D  85 22             sta <.pTargetSideBase
   71  30:EE9F  85 23             sta <.pTargetSideBase+1
   72  30:EEA1  A0 30             ldy #$30
   73  30:EEA3  B1 6E             lda [.pActor],y
   74  30:EEA5  30 15             bmi .target_enemy
   75                     ;.target_player:
   76  30:EEA7  A9 03                     lda #3
   77  30:EEA9  20 00 A3                  jsr getRandomTarget
   78  30:EEAC  A5 69                     lda <$69
   79  30:EEAE  F0 13                     beq .cache_status
   80                     ;.no_valid_target:
   81  30:EEB0  A2 00                             ldx #0
   82  30:EEB2  8E C2 7E                          stx effectHandlerIndex  ;7ec2
   83  30:EEB5  CA                                dex
   84  30:EEB6  8E D8 78                          stx targetName  ;78d8
   85                                             ;bug!! jmp $a264        ;post calc
   86  30:EEB9  4C B5 A2                          jmp b31_getActor2C      
   87  30:EEBC            .target_enemy:
   88  30:EEBC  E6 23                     inc <.pTargetSideBase+1
   89  30:EEBE  A9 07                     lda #7
   90  30:EEC0  20 00 A3                  jsr getRandomTarget     ;a300
   91  30:EEC3            .cache_status:
   92  30:EEC3  20 BA A2          jsr cacheStatus
   93                     
   94  30:EEC6            .begin_calc:
   95  30:EEC6  A2 FF             ldx #$ff
   96  30:EEC8  8E E1 7E          stx play_segmentedGroup
   97  30:EECB  E8                inx
   98  30:EECC  8E E9 7C          stx $7ce9
   99  30:EECF  86 7C             stx <.hitCount_1st
  100  30:EED1  86 7D             stx <.hitCount_2nd
  101  30:EED3  86 6A             stx <$6a
  102  30:EED5  86 6B             stx <$6b
  103  30:EED7  86 42             stx <$42
  104  30:EED9  8E 1E 74          stx .doubleArmed
  105  30:EEDC  E8                inx
  106  30:EEDD  8E 1F 74          stx .handCount
  107                     
  108  30:EEE0  A0 04             ldy #4
  109  30:EEE2            .save_hp:
  110  30:EEE2  B1 70                     lda [.pTarget],y
  111  30:EEE4  95 3C                     sta <.targetHp,x
  112  30:EEE6  B1 6E                     lda [.pActor],y
  113  30:EEE8  95 40                     sta <.actorHp,x
  114  30:EEEA  88                        dey
  115  30:EEEB  CA                        dex
  116  30:EEEC  10 F4                     bpl .save_hp
  117                     
  118  30:EEEE  20 B5 A2          jsr b31_getActor2C
  119  30:EEF1  10 12             bpl .actor_player
  120                     ;actor_enemy
  121  30:EEF3  B1 70                     lda [.pTarget],y        ;y = 2c
  122  30:EEF5  30 21                     bmi .cache_props
  123                                             ;actor_enemy && target_player
  124  30:EEF7  A5 74                             lda <.escapeCount
  125  30:EEF9  F0 1D                             beq .cache_props
  126  30:EEFB  A0 27                                     ldy #$27
  127  30:EEFD  B1 70                                     lda [.pTarget],y
  128  30:EEFF  09 80                                     ora #$80        ;tag
  129  30:FF01  91 70                                     sta [.pTarget],y
  130  30:FF03  30 13                                     bmi .cache_props        ;always
  131  30:FF05            .actor_player:
  132  30:FF05  A0 31                     ldy #$31
  133  30:FF07  B1 6E                     lda [.pActor],y
  134  30:FF09  C9 02                     cmp #2
  135  30:FF0B  B0 0B                     bcs .cache_props
  136  30:FF0D  C8                        iny
  137  30:FF0E  51 6E                     eor [.pActor],y
  138  30:FF10  D0 06                     bne .cache_props
  139                                             ;両手が素手or両手が片手武器
  140  30:FF12  EE 1F 74                          inc .handCount
  141  30:FF15  EE 1E 74                          inc .doubleArmed
  142                     
  143  30:FF18            .cache_props:   ;$9f40
  144                     ;.attackProps = $7440
  145                     ;.defProps = $742a
  146                     
  147  30:FF18  A0 24             ldy #$24
  148  30:FF1A  A2 04             ldx #$04
  149  30:FF1C            .cache_defs:
  150  30:FF1C  B1 70                     lda [.pTarget],y
  151  30:FF1E  9D 2A 74                  sta .defProps,x
  152  30:FF21  88                        dey
  153  30:FF22  CA                        dex
  154  30:FF23  10 F7                     bpl .cache_defs
  155                             ;ldy #$1f
  156  30:FF25  A2 09             ldx #$09
  157  30:FF27            .cache_attacks:
  158  30:FF27  B1 6E                     lda [.pActor],y
  159  30:FF29  9D 20 74                  sta $7420,x
  160  30:FF2C  9D 40 74                  sta .attackProps,x
  161  30:FF2F  88                        dey
  162  30:FF30  CA                        dex
  163  30:FF31  10 F4                     bpl .cache_attacks
  164  30:FF33  A0 29             ldy #$29
  165  30:FF35  A2 02             ldx #$02
  166  30:FF37            .cache_criticals:
  167  30:FF37  B1 6E                     lda [.pActor],y
  168  30:FF39  9D 2F 74                  sta $742f,x
  169  30:FF3C  88                        dey
  170  30:FF3D  CA                        dex
  171  30:FF3E  10 F7                     bpl .cache_criticals
  172                     
  173  30:FF40            doFight_calc_damage_for_hand:   ;9f6a
  174                             DEF_DO_FIGHT_VARS
                002B      .atkHigh = $2b
                0025      .atkLow = $25
                0026      .def = $26
                0028      .criticalBonus = $28
                0029      .criticalCount = $29
                002A      .damageDivider = $2a
                006E      .pActor = $6e
                0070      .pTarget = $70
                0074      .escapeCount = $74
                CCE4      .isGuarding = $7ce4
                CCE9      .isFarTarget = $7ce9
                          ;[out]
                007C      .hitCount_1st = $7c
                007D      .hitCount_2nd = $7d
                EEDF      .protectFlag = $7edf
                          ;[out] shared with checkSegment()
                00BB      .hitCountForBlow_1st = $bb
                00BC      .hitCountForBlow_2nd = $bc
                          ;locals:
                003C      .targetHp = $3c
                0040      .actorHp = $40
                441E      .doubleArmed = $741e
                441F      .handCount = $741f
                4440      .attackProps = $7440
                442A      .defProps = $742a
                          ;shared with cacheStatus()
                0062      .iActorCache = $62
                0064      .iTargetCache = $64
                0066      .iActor = $66
                0068      .iTarget = $68
                00F0      .actorStatusCache = $f0
                00E0      .targetStatusCache = $e0
                          ;shared with sumDamage()
                006A      .damageForDisplay = $6a
                0078      .damage = $78
  175           0024      .count = $24
  176           0025      .rate = $25
  177                     
  178  30:FF40  AD 41 74          lda .attackProps+1
  179  30:FF43  85 24             sta <.count
  180  30:FF45  AD 42 74          lda .attackProps+2
  181  30:FF48  85 25             sta <.rate
  182                             
  183  30:FF4A  A6 62             ldx <.iActorCache
  184  30:FF4C  B5 F0             lda <.actorStatusCache,x
  185  30:FF4E  29 04             and #$04
  186  30:FF50  F0 02             beq .not_blind
  187  30:FF52  46 25                     lsr <.rate
  188  30:FF54            .not_blind:
  189  30:FF54  A0 33             ldy #$33
  190  30:FF56  B1 6E             lda [.pActor],y
  191  30:FF58  29 04             and #$04        ;04:両手遠距離フラグ(竪琴か矢がある弓ならset)
  192  30:FF5A  D0 1D             bne .get_attack_count
  193  30:FF5C  20 B5 A2                  jsr b31_getActor2C
  194  30:FF5F  30 05                     bmi .check_actor_line
  195  30:FF61  20 97 A3                          jsr isRangedWeapon      ;a397
  196  30:FF64  B0 13                             bcs .get_attack_count
  197  30:FF66                    .check_actor_line:
  198  30:FF66  A0 33                     ldy #$33
  199  30:FF68  B1 6E                     lda [.pActor],y
  200  30:FF6A  4A                        lsr a
  201  30:FF6B  90 02                     bcc .check_target_line
  202  30:FF6D  46 25                             lsr <.rate
  203  30:FF6F                    .check_target_line:
  204  30:FF6F  B1 70                     lda [.pTarget],y
  205  30:FF71  4A                        lsr a
  206  30:FF72  90 05                     bcc .get_attack_count
  207  30:FF74  EE E9 7C                          inc .isFarTarget
  208  30:FF77  46 25                             lsr <.rate
  209                     
  210  30:FF79            .get_attack_count:      ;$9fa6:
  211  30:FF79  20 28 BB          jsr getNumberOfRandomSuccess
  212  30:FF7C  85 7C             sta <.hitCount_1st
  213                     
  214  30:FF7E  AD 2B 74          lda .defProps+1
  215  30:FF81  85 24             sta <.count
  216  30:FF83  AD 2C 74          lda .defProps+2
  217  30:FF86  85 25             sta <.rate
  218                     
  219  30:FF88  A6 64             ldx <.iTargetCache
  220  30:FF8A  B5 E0             lda <.targetStatusCache,x
  221  30:FF8C  48                pha
  222  30:FF8D  29 04             and #$04
  223  30:FF8F  F0 02             beq .target_not_blind
  224  30:FF91  46 25                     lsr <.rate
  225  30:FF93            .target_not_blind:      ;$9fbf:
  226  30:FF93  68                pla
  227  30:FF94  A2 01             ldx #1
  228  30:FF96  29 28             and #$28        ;toad | minimum
  229  30:FF98  D0 06             bne .cannot_defend
  230  30:FF9A  A0 27             ldy #$27
  231  30:FF9C  B1 70             lda [.pTarget],y
  232  30:FF9E  F0 03             beq .get_evade_count
  233  30:FFA0            .cannot_defend:
  234  30:FFA0  CA                        dex
  235  30:FFA1  86 25                     stx <.rate
  236                     
  237  30:FFA3            .get_evade_count:
  238  30:FFA3  8A                txa
  239  30:FFA4  48                pha     ;can't defend flag
  240                     
  241  30:FFA5  20 28 BB          jsr getNumberOfRandomSuccess
  242  30:FFA8  AD E9 7C          lda .isFarTarget
  243  30:FFAB  F0 02             beq .calc_hit_count
  244  30:FFAD  E6 30                     inc <$30
  245                     ;$9fd9:
  246  30:FFAF            .calc_hit_count:
  247  30:FFAF  A5 7C             lda <.hitCount_1st
  248  30:FFB1  38                sec
  249  30:FFB2  E5 30             sbc <$30
  250  30:FFB4  B0 02             bcs .store_hit_count
  251  30:FFB6  A9 00                     lda #0
  252  30:FFB8            .store_hit_count:
  253  30:FFB8  85 24             sta <.count
  254  30:FFBA  85 7C             sta <.hitCount_1st
  255  30:FFBC  D0 04             bne .attack_hit
  256  30:FFBE  68                        pla     ;undefendable flag
  257  30:FFBF  4C B9 A0                  jmp doFight_next_hand
  258                     
  259  30:FFC2            .attack_hit:    ;$9ff1
  260           0027      .attrMultiplier = $27
  261  30:FFC2  A2 04             ldx #4
  262  30:FFC4  AD 40 74          lda .attackProps
  263  30:FFC7  A0 12             ldy #$12        ;weakattr
  264  30:FFC9  31 70             and [.pTarget],y
  265  30:FFCB  D0 0F             bne .store_attr_multi
  266                             ;
  267  30:FFCD  A2 02             ldx #2
  268  30:FFCF  AD 2A 74          lda .defProps
  269  30:FFD2  C9 02             cmp #$02
  270  30:FFD4  F0 05             beq .target_strong
  271  30:FFD6  2D 40 74                  and .attackProps
  272  30:FFD9  F0 01                     beq .store_attr_multi
  273  30:FFDB            .target_strong:
  274  30:FFDB  CA                dex
  275  30:FFDC            .store_attr_multi:
  276  30:FFDC  86 27             stx <.attrMultiplier
  277                     
  278  30:FFDE  A2 00             ldx #0
  279  30:FFE0  86 2B             stx <.atkHigh
  280  30:FFE2  86 29             stx <.criticalCount
  281  30:FFE4  E8                inx
  282  30:FFE5  86 2A             stx <.damageDivider
  283  30:FFE7  AD 31 74          lda $7431       ; $6e[y = #29]
  284  30:FFEA  85 28             sta <.criticalBonus
  285  30:FFEC  AD 43 74          lda $7443
  286  30:FFEF  85 25             sta <.atkLow
  287                             
  288  30:FFF1  20 B5 A2          jsr b31_getActor2C
  289  30:FFF4  30 09             bmi .store_def
  290  30:FFF6  A0 38                     ldy #$38
  291  30:FFF8  20 89 A3                  jsr addValueAtOffsetToAttack
  292  30:FFFB  C8                        iny
  293  30:FFFC  20 89 A3                  jsr addValueAtOffsetToAttack
  294                     
  295  30:FFFF            .store_def:
  296  30:FFFF  EA                nop
  297                     
  298                     
  299           0031              .bank $31
  300           0000              .org $a000
  301                     
  302  31:0000            doFight_setupProps:
  303                             DEF_DO_FIGHT_VARS
                002B      .atkHigh = $2b
                0025      .atkLow = $25
                0026      .def = $26
                0028      .criticalBonus = $28
                0029      .criticalCount = $29
                002A      .damageDivider = $2a
                006E      .pActor = $6e
                0070      .pTarget = $70
                0074      .escapeCount = $74
                CCE4      .isGuarding = $7ce4
                CCE9      .isFarTarget = $7ce9
                          ;[out]
                007C      .hitCount_1st = $7c
                007D      .hitCount_2nd = $7d
                EEDF      .protectFlag = $7edf
                          ;[out] shared with checkSegment()
                00BB      .hitCountForBlow_1st = $bb
                00BC      .hitCountForBlow_2nd = $bc
                          ;locals:
                003C      .targetHp = $3c
                0040      .actorHp = $40
                441E      .doubleArmed = $741e
                441F      .handCount = $741f
                4440      .attackProps = $7440
                442A      .defProps = $742a
                          ;shared with cacheStatus()
                0062      .iActorCache = $62
                0064      .iTargetCache = $64
                0066      .iActor = $66
                0068      .iTarget = $68
                00F0      .actorStatusCache = $f0
                00E0      .targetStatusCache = $e0
                          ;shared with sumDamage()
                006A      .damageForDisplay = $6a
                0078      .damage = $78
  304                     
  305  31:0000  AD 2D 74          lda .defProps+3
  306  31:0003  85 26             sta <.def
  307  31:0005  20 25 BC          jsr b31_getTarget2C
  308  31:0008  30 10             bmi .check_target_defendable
  309  31:000A  29 07                     and #7
  310  31:000C  AA                        tax
  311  31:000D  BD E4 7C                  lda .isGuarding,x
  312  31:0010  F0 08                     beq .check_target_defendable
  313  31:0012  06 26                             asl <.def
  314  31:0014  90 04                             bcc .check_target_defendable
  315  31:0016  A9 FF                                     lda #$ff
  316  31:0018  85 26                                     sta <.def
  317                     
  318  31:001A            .check_target_defendable:
  319  31:001A  68                pla     ;defendable flag
  320  31:001B  D0 06             bne .check_actor_toad_minimum
  321  31:001D  85 26                     sta <.def
  322  31:001F  06 25                     asl <.atkLow
  323  31:0021  26 2B                     rol <.atkHigh
  324                     
  325  31:0023            .check_actor_toad_minimum:      ;a055
  326  31:0023  A6 62             ldx <.iActorCache
  327  31:0025  B5 F0             lda <.actorStatusCache,x
  328  31:0027  29 28             and #$28
  329  31:0029  F0 06             beq .apply_charge
  330  31:002B  A9 01                     lda #$01
  331  31:002D  85 25                     sta <.atkLow
  332  31:002F  D0 11                     bne .get_damage
  333  31:0031            .apply_charge:
  334           0001              .ifdef BOOST_CHARGE
  335  31:0031  20 C0 A1                  jsr applyCharge
  336                             .endif;BOOST_CHARGE
  337  31:0034            .randomize_critical:
  338  31:0034  A9 63             lda #99
  339  31:0036  20 B4 BE          jsr b31_getBattleRandom ;beb4
  340  31:0039  CD 30 74          cmp $7430       ;$6e[#28]
  341  31:003C  B0 04             bcs .get_damage
  342                                     ;critical
  343  31:003E  E6 29                     inc <.criticalCount
  344  31:0040  E6 CB                     inc <$cb
  345                     
  346  31:0042            .get_damage:    ;$a093:
  347  31:0042  20 44 BB          jsr calcDamage  ;bb44
  348  31:0045  A5 29             lda <.criticalCount
  349  31:0047  F0 05             beq .setup_effect_and_message
  350  31:0049  A9 34                     lda #$34        ;"クリティカルヒット！"
  351  31:004B  20 B6 A1                  jsr b31_queueBattleMessage
  352                     
  353  31:004E            .setup_effect_and_message:
  354           0024      .pCalc = $24
  355  31:004E  20 BC BD          jsr set24ToTarget
  356                     
  357  31:0051  A5 1C             lda <$1c
  358  31:0053  85 78             sta <.damage
  359  31:0055  A5 1D             lda <$1d
  360  31:0057  85 79             sta <.damage+1
  361  31:0059  05 1C             ora <$1c
  362  31:005B  D0 02             bne .check_absorb
  363  31:005D  E6 78                     inc <.damage
  364                     
  365  31:005F            .check_absorb:
  366           0026      .deadFlag = $26
  367                             ;ldy #$12
  368  31:005F  AD 40 74          lda .attackProps
  369  31:0062  4A                lsr a
  370  31:0063  90 1C             bcc .attr_not_absorb
  371  31:0065  20 E2 BB                  jsr isTargetWeakToHoly
  372  31:0068  B0 03                     bcs .check_is_target_actor
  373  31:006A  20 68 A3                          jsr sumDamage
  374  31:006D                    .check_is_target_actor:
  375  31:006D  20 B5 A2                  jsr b31_getActor2C
  376  31:0070  51 70                     eor [.pTarget],y
  377  31:0072  29 87                     and #$87
  378  31:0074  F0 12                     beq .do_damage
  379                                             ;target != actor
  380  31:0076  20 67 BD                          jsr spoilHp     ;bd67
  381  31:0079  A5 26                             lda <.deadFlag
  382  31:007B  F0 24                             beq .both_alive
  383  31:007D  30 18                             bmi .actor_dead
  384  31:007F  10 0C                             bpl .target_dead
  385  31:0081            .attr_not_absorb:
  386  31:0081  A9 00             lda #0
  387  31:0083  85 26             sta <.deadFlag
  388  31:0085  20 68 A3          jsr sumDamage
  389  31:0088            .do_damage:
  390  31:0088  20 D2 BC          jsr damageHp
  391  31:008B  B0 14             bcs .both_alive
  392  31:008D            .target_dead:
  393  31:008D  A6 64                     ldx <.iTargetCache
  394  31:008F  B5 E0                     lda <.targetStatusCache,x
  395  31:0091  09 80                     ora #$80
  396  31:0093  95 E0                     sta <.targetStatusCache,x
  397  31:0095  30 22                     bmi .next_hand
  398  31:0097            .actor_dead:
  399  31:0097  A6 62                     ldx <.iActorCache
  400  31:0099  B5 F0                     lda <.actorStatusCache,x
  401  31:009B  09 80                     ora #$80
  402  31:009D  95 F0                     sta <.actorStatusCache,x
  403  31:009F  30 18                     bmi .next_hand
  404  31:00A1            .both_alive:
  405  31:00A1  AD D8 7E          lda battleMode
  406  31:00A4  30 13             bmi .next_hand  ;ボス戦なら追加効果判定をしない
  407  31:00A6  A0 01                     ldy #1
  408  31:00A8  B1 6E                     lda [.pActor],y
  409  31:00AA  29 28                     and #$28
  410  31:00AC  D0 0B                     bne .next_hand  ;攻撃者が蛙か小人なら判定しない
  411                                             ;fix --->
  412  31:00AE  A6 64                             ldx <.iTargetCache
  413  31:00B0  B5 E0                             lda <.targetStatusCache,x
  414  31:00B2  29 E8                             and #$e8        ;dead|stone|toad|minimum
  415  31:00B4  D0 03                             bne .next_hand  ;対象が↑の状態なら判定しない(敵なら既に死亡扱い)
  416                                             ;<--- fix
  417  31:00B6  20 14 BE                          jsr checkEnchantedStatus        ;be14 追加効果判定
  418                     
  419  31:00B9            .next_hand:
  420  31:00B9            doFight_next_hand:      ;$a139: //hit数0(=ミス)ならここまで飛んでくる
  421                             DEF_DO_FIGHT_VARS
                002B      .atkHigh = $2b
                0025      .atkLow = $25
                0026      .def = $26
                0028      .criticalBonus = $28
                0029      .criticalCount = $29
                002A      .damageDivider = $2a
                006E      .pActor = $6e
                0070      .pTarget = $70
                0074      .escapeCount = $74
                CCE4      .isGuarding = $7ce4
                CCE9      .isFarTarget = $7ce9
                          ;[out]
                007C      .hitCount_1st = $7c
                007D      .hitCount_2nd = $7d
                EEDF      .protectFlag = $7edf
                          ;[out] shared with checkSegment()
                00BB      .hitCountForBlow_1st = $bb
                00BC      .hitCountForBlow_2nd = $bc
                          ;locals:
                003C      .targetHp = $3c
                0040      .actorHp = $40
                441E      .doubleArmed = $741e
                441F      .handCount = $741f
                4440      .attackProps = $7440
                442A      .defProps = $742a
                          ;shared with cacheStatus()
                0062      .iActorCache = $62
                0064      .iTargetCache = $64
                0066      .iActor = $66
                0068      .iTarget = $68
                00F0      .actorStatusCache = $f0
                00E0      .targetStatusCache = $e0
                          ;shared with sumDamage()
                006A      .damageForDisplay = $6a
                0078      .damage = $78
  422                     
  423  31:00B9  CE 1F 74          dec .handCount
  424  31:00BC  F0 19             beq .setup_damages
  425  31:00BE  A2 04                     ldx #4
  426  31:00C0                    .update_props_to_another_hand:
  427  31:00C0  BD 25 74                          lda $7425,x
  428  31:00C3  9D 40 74                          sta $7440,x
  429  31:00C6  CA                                dex
  430  31:00C7  10 F7                             bpl .update_props_to_another_hand
  431                     
  432  31:00C9  A5 7C                     lda <.hitCount_1st
  433  31:00CB  85 7D                     sta <.hitCount_2nd
  434  31:00CD  E8                        inx     ;0
  435  31:00CE  86 7C                     stx <.hitCount_1st
  436  31:00D0  86 78                     stx <.damage
  437  31:00D2  86 79                     stx <.damage+1
  438  31:00D4  4C 40 9F                  jmp doFight_calc_damage_for_hand        ;9f6a
  439                     
  440  31:00D7            .setup_damages:
  441  31:00D7  A0 27             ldy #$27
  442  31:00D9  B1 70             lda [.pTarget],y
  443  31:00DB  29 7F             and #$7f        ;clear undefendable tag
  444  31:00DD  91 70             sta [.pTarget],y
  445                     
  446  31:00DF  A9 00             lda #0
  447  31:00E1  91 6E             sta [.pActor],y ;clear charge count
  448                     
  449  31:00E3  AD 1E 74          lda .doubleArmed
  450  31:00E6  F0 08             beq .store_damages
  451  31:00E8  A5 7C                     lda <.hitCount_1st
  452  31:00EA  A6 7D                     ldx <.hitCount_2nd
  453  31:00EC  86 7C                     stx <.hitCount_1st
  454  31:00EE  85 7D                     sta <.hitCount_2nd
  455  31:00F0            .store_damages:
  456  31:00F0  A4 64             ldy <.iTargetCache
  457  31:00F2  A5 7C             lda <.hitCount_1st
  458  31:00F4  85 BB             sta <.hitCountForBlow_1st
  459  31:00F6  05 7D             ora <.hitCount_2nd
  460  31:00F8  D0 0D             bne .not_miss
  461  31:00FA  85 BC                     sta <.hitCountForBlow_2nd
  462  31:00FC  99 4F 7E                  sta play_damages,y
  463  31:00FF  A9 40                     lda #$40        ;miss
  464  31:1101  99 50 7E                  sta play_damages+1,y
  465  31:1104  4C 9B A1                  jmp .add_cannot_defend_message
  466  31:1107            .not_miss:
  467  31:1107  A5 7D                     lda <.hitCount_2nd
  468  31:1109  85 BC                     sta <.hitCountForBlow_2nd
  469                     
  470  31:110B  A9 00                     lda #0
  471  31:110D  85 43                     sta <$43
  472                     
  473  31:110F  A0 03                     ldy #3
  474  31:1111  B1 6E                     lda [.pActor],y
  475  31:1113  85 78                     sta <.damage
  476  31:1115  C8                        iny
  477  31:1116  B1 6E                     lda [.pActor],y
  478  31:1118  85 79                     sta <.damage+1
  479                                     
  480  31:111A  20 B5 A2                  jsr b31_getActor2C
  481  31:111D  51 70                     eor [.pTarget],y
  482  31:111F  29 87                     and #$87
  483  31:1121  F0 55                     beq .no_message ;a203 => a216
  484                     
  485  31:1123  A6 62                     ldx <.iActorCache
  486  31:1125  38                        sec
  487  31:1126  A5 40                     lda <.actorHp
  488  31:1128  E5 78                     sbc <.damage
  489  31:112A  9D 5F 7E                  sta play_damages+$10,x
  490  31:112D  A5 41                     lda <.actorHp+1
  491  31:112F  E5 79                     sbc <.damage+1
  492  31:1131  9D 60 7E                  sta play_damages+$11,x
  493  31:1134  90 1C                     bcc .actor_healed
  494                                             ;actorHpBeforeAttack >= actor.hp
  495  31:1136  1D 5F 7E                          ora play_damages+$10,x
  496  31:1139  D0 08                             bne .actually_healed
  497                                                     ;heal0pt
  498  31:113B  DE 5F 7E                                  dec play_damages+$10,x
  499  31:113E  DE 60 7E                                  dec play_damages+$11,x
  500  31:1141  30 35                                     bmi .no_message
  501  31:1143                            .actually_healed:
  502  31:1143  A0 16                             ldy #$16
  503  31:1145  B1 6E                             lda [.pActor],y
  504  31:1147  A0 1B                             ldy #$1b
  505  31:1149  11 6E                             ora [.pActor],y
  506  31:114B  4A                                lsr a
  507  31:114C  90 2A                             bcc .no_message
  508  31:114E  A2 27                                     ldx #$27        ;"HPをぎゃくにすいとられた!"
  509  31:1150  D0 20                                     bne .add_absorb_message
  510  31:1152                    .actor_healed:
  511  31:1152  BD 60 7E                          lda play_damages+$11,x
  512  31:1155  49 7F                             eor #$7f
  513  31:1157  9D 60 7E                          sta play_damages+$11,x
  514                                             
  515  31:115A  BD 5F 7E                          lda play_damages+$10,x
  516  31:115D  49 FF                             eor #$ff
  517  31:115F  A8                                tay
  518  31:1160  C8                                iny
  519  31:1161  D0 03                             bne .store_heal_low
  520  31:1163  FE 60 7E                                  inc play_damages+$11,x
  521  31:1166                            .store_heal_low:
  522  31:1166  98                                tya
  523  31:1167  9D 5F 7E                          sta play_damages+$10,x
  524                                                     
  525  31:116A  A2 25                             ldx #$25
  526  31:116C  20 B5 A2                          jsr b31_getActor2C
  527  31:116F  10 01                             bpl .player_is_healed
  528  31:1171  E8                                        inx
  529  31:1172                    .player_is_healed:
  530  31:1172                    .add_absorb_message:
  531  31:1172  8A                        txa
  532  31:1173  20 B6 A1                  jsr b31_queueBattleMessage
  533  31:1176  E6 43                     inc <$43
  534  31:1178            .no_message:
  535  31:1178  A6 64             ldx <.iTargetCache
  536  31:117A  A5 42             lda <$42
  537  31:117C  F0 13             beq .store_target_damage
  538  31:117E  A0 03                     ldy #3
  539  31:1180  38                        sec
  540  31:1181  B1 70                     lda [.pTarget],y
  541  31:1183  E5 3C                     sbc <.targetHp
  542  31:1185  9D 4F 7E                  sta play_damages,x
  543  31:1188  C8                        iny
  544  31:1189  B1 70                     lda [.pTarget],y
  545  31:118B  E5 3D                     sbc <.targetHp+1
  546  31:118D  09 80                     ora #$80
  547  31:118F  D0 07                     bne .store_target_damage_high
  548  31:1191                    .store_target_damage:
  549  31:1191  A5 6A                     lda <$6a
  550  31:1193  9D 4F 7E                  sta play_damages,x
  551  31:1196  A5 6B                     lda <$6b
  552  31:1198            .store_target_damage_high:
  553  31:1198  9D 50 7E          sta play_damages+1,x
  554                     
  555  31:119B            .add_cannot_defend_message:     ;$a264:
  556  31:119B  20 B5 A2          jsr b31_getActor2C
  557  31:119E  10 10             bpl .check_segment
  558                     
  559  31:11A0  A5 74                     lda <.escapeCount
  560  31:11A2  F0 09                     beq .finish
  561                     
  562  31:11A4  A5 7C                     lda <.hitCount_1st
  563  31:11A6  F0 05                     beq .finish
  564                     
  565  31:11A8  A9 55                             lda #$55        ;"にげごしで ぼうぎょできなかった!"
  566  31:11AA  20 B6 A1                          jsr b31_queueBattleMessage
  567  31:11AD                    .finish:
  568  31:11AD  4C B5 A2                  jmp b31_getActor2C
  569                     
  570  31:11B0            .check_segment: ;a28d
  571  31:11B0  20 53 BF          jsr checkSegment        ;bf53
  572  31:11B3  4C 90 A2          jmp $a290
  573                     
  574  31:11B6            b31_queueBattleMessage:
  575  31:11B6  AE EE 78          ldx battleMessageCount
  576  31:11B9  9D DA 78          sta battleMessages,x
  577  31:11BC  EE EE 78          inc battleMessageCount
  578  31:11BF  60                rts
  579                     
  580  31:11C0            applyCharge:
  581           0025      .atkLow = $25
  582           002B      .atkHigh = $2b
  583           0018      .tempAtk = $18  ;
  584           006E      .pActor = $6e
  585  31:11C0  A5 25             lda <.atkLow
  586  31:11C2  85 18             sta <.tempAtk
  587  31:11C4  A5 2B             lda <.atkHigh
  588  31:11C6  85 19             sta <.tempAtk+1
  589                     
  590  31:11C8  A2 04             ldx #4
  591  31:11CA            .shift_left_atk:
  592  31:11CA  06 25                     asl <.atkLow
  593  31:11CC  26 2B                     rol <.atkHigh
  594  31:11CE  CA                        dex
  595  31:11CF  D0 F9                     bne .shift_left_atk
  596  31:11D1  A0 27             ldy #$27
  597  31:11D3  B1 6E             lda [.pActor],y
  598  31:11D5  AA                tax
  599  31:11D6  F0 10             beq .restore
  600  31:11D8            .add_charge_bonus:
  601  31:11D8  18                        clc
  602  31:11D9  A5 25                     lda <.atkLow
  603  31:11DB  65 18                     adc <.tempAtk
  604  31:11DD  85 25                     sta <.atkLow
  605  31:11DF  A5 2B                     lda <.atkHigh
  606  31:11E1  65 19                     adc <.tempAtk+1
  607  31:11E3  85 2B                     sta <.atkHigh
  608  31:11E5  CA                        dex
  609  31:11E6  D0 F0                     bne .add_charge_bonus
  610  31:11E8            .restore:
  611  31:11E8  A2 04             ldx #4
  612  31:11EA            .shift_right_atk:
  613  31:11EA  46 2B                     lsr <.atkHigh
  614  31:11EC  66 25                     ror <.atkLow
  615  31:11EE  CA                        dex
  616  31:11EF  D0 F9                     bne .shift_right_atk
  617  31:11F1  60                rts
  618                     
  619                             VERIFY_PC $a28d
       31:11F2                    .verify_pc_00129:
                0000              .if (.verify_pc_00129 > $a28d)
                                  .endif
  620                     ;
  621                     ;$a28d:
  622                     ;       checkSegmentation();    //$bf53();
  623                     ;       //if ((a = $6e[y = #31]) >= 0) {        //bmi a29a
  624                     ;       //      if ((a & 1) == 0) { //bne a2a6
  625                     ;       if ((a = $6e[y = #31] < 0)
  626                     ;               || (a & 1) != 0)
  627                     ;       {
  628                     ;$a29a:
  629                     ;               if ($7d == 0) {
  630                     ;$a29e:
  631                     ;                       $bc = $7c;
  632                     ;                       $bb = 0;
  633                     ;               }
  634                     ;       }
  635                     ;$a2a6:
  636                     ;       a = $6e[y = #33] & 4;
  637                     ;       if (a != 0) {
  638                     ;               $bb = $7c + $7d;
  639                     ;       }
  640                     ;$a2b5:
  641                     ;       return getActor2C(); //fall through
  642                     ;}
  643                     ;------------------------------------------------------------------------------------------------------
  644                             INIT_PATCH $31,$bd67,$bdaa
                0031              .bank   $31
                DD67              .org    $bd67
       31:DD67                    .ds             (($bdaa) - ($bd67))
                DD67              .org    $bd67
  645                     ;$31:bd67 spoilHp
  646  31:DD67            spoilHp:
  647           0026      .deadFlag = $26
  648           0042      .undead = $42
  649           0078      .damage = $78
  650           0024      .pCalc = $24
  651           006E      .pActor = $6e
  652           0070      .pTarget = $70
  653                     ;
  654  31:DD67  A9 00             lda #0
  655  31:DD69  85 26             sta <.deadFlag
  656  31:DD6B  20 E2 BB          jsr isTargetWeakToHoly  ;bbe2
  657  31:DD6E  90 0F             bcc .normal_target
  658                             ;undead
  659  31:DD70  A5 70                     lda <.pTarget
  660  31:DD72  48                        pha
  661  31:DD73  A5 71                     lda <.pTarget+1
  662  31:DD75  48                        pha
  663  31:DD76  20 B3 BD                  jsr set24ToActor
  664  31:DD79  E6 42                     inc <.undead
  665  31:DD7B  A9 81                     lda #$81
  666  31:DD7D  D0 08                     bne .do_damage
  667  31:DD7F            .normal_target:
  668  31:DD7F  A5 6E                     lda <.pActor
  669  31:DD81  48                        pha
  670  31:DD82  A5 6F                     lda <.pActor+1
  671  31:DD84  48                        pha
  672  31:DD85  A9 01                     lda #$01
  673  31:DD87            .do_damage:
  674  31:DD87  48                pha
  675  31:DD88  20 D2 BC          jsr damageHp    ;bcd2
  676  31:DD8B  68                pla
  677  31:DD8C  B0 02             bcs .alive
  678                             ;dead
  679  31:DD8E  85 26                     sta <.deadFlag
  680  31:DD90            .alive:
  681  31:DD90  A0 2E             ldy #$2e
  682  31:DD92  B1 6E             lda [.pActor],y
  683  31:DD94  C9 04             cmp #$04        ;fight
  684  31:DD96  D0 03             bne .do_heal
  685  31:DD98  20 AA BD                  jsr shiftRightDamageBy2 ;bdaa
  686  31:DD9B            .do_heal:
  687  31:DD9B  68                pla
  688  31:DD9C  85 25             sta <.pCalc+1
  689  31:DD9E  68                pla
  690  31:DD9F  85 24             sta <.pCalc
  691  31:DDA1  4C 24 BD          jmp healHp
  692                     ;$bdaa
  693                     
  694                     ;------------------------------------------------------------------------------------------------------
  695                             INIT_PATCH $31,$bcc9,$bcd2
                0031              .bank   $31
                CCC9              .org    $bcc9
       31:CCC9                    .ds             (($bcd2) - ($bcc9))
                CCC9              .org    $bcc9
  696  31:CCC9            applyStatus_addStoneMessage:
  697  31:CCC9  A9 28             lda #$28
  698  31:CCCB  4C B6 A1          jmp b31_queueBattleMessage
  699                     
  700                     ;======================================================================================================
  701                             RESTORE_PC ff3_battle_calc_begin
                0035              .bank   BANK(ff3_battle_calc_begin)
                88EB              .org    ff3_battle_calc_begin
#[2]   ff3_hack_master.asm
   65                                     ;v0.7.8:
#[3]   ff3_calcDamage.asm
   66                                     .include "ff3_calcDamage.asm"
    1                     ; ff3_calcDamage.asm
    2                     ;
    3                     ;description:
    4                     ;       replaces damage calculation function
    5                     ;
    6                     ;version:
    7                     ;       0.01 (2007-08-22)
    8                     ;======================================================================================================
    9  35:88EB            ff3_calcDamage_begin:
   10                     
   11                             INIT_PATCH $31,$bb44,$bbe2
                0031              .bank   $31
                BB44              .org    $bb44
       31:BB44                    .ds             (($bbe2) - ($bb44))
                BB44              .org    $bb44
   12                     
   13  31:BB44            calcDamage:
   14                     ;       $1c,1d = ((($25*(1.0~1.5)*($27/2)+$28*$29)-$26)*$7c)/$2a
   15                     ;       [in] u16 $25,2b : attack power?
   16                     ;       [in] u8 $26 : defence power?
   17                     ;       [in] u8 $27 : attr multiplier
   18                     ;       [in] u8 $28 : additional damage (critical modifier)
   19                     ;       [in] u8 $29 : critical count(0/1)
   20                     ;       [in] u8 $2a : damage divider (target count)
   21                     ;       [in] u8 $007c : damage multiplier (hit count)
   22                     ;       [out] u16 $1c : final damage (0-9999)
   23           0025      .atkLow = $25
   24           002B      .atkHigh = $2b
   25           0026      .def = $26
   26           0027      .attrMultiplier = $27
   27           0028      .criticalBonus = $28
   28           0029      .criticalMultiplier = $29
   29           002A      .damageDivider = $2a
   30           007C      .damageMultiplier = $7c
   31           006E      .pActor = $6e
   32           0070      .pTarget = $70
   33                     
   34  31:BB44  A5 2B             lda <.atkHigh
   35  31:BB46  4A                lsr a
   36  31:BB47  A5 25             lda <.atkLow
   37  31:BB49  6A                ror a
   38  31:BB4A  20 B4 BE          jsr b31_getBattleRandom
   39  31:BB4D  18                clc
   40  31:BB4E  65 25             adc <.atkLow
   41  31:BB50  85 18             sta <$18
   42  31:BB52  A5 2B             lda <.atkHigh
   43  31:BB54  69 00             adc #0
   44  31:BB56  85 19             sta <$19
   45                     
   46  31:BB58  A5 27             lda <.attrMultiplier
   47  31:BB5A  4A                lsr a
   48  31:BB5B  D0 0B             bne .multiply_atk
   49                             ;
   50  31:BB5D  A5 19                     lda <$19
   51  31:BB5F  4A                        lsr a
   52  31:BB60  48                        pha     ;sta <$1d
   53  31:BB61  A5 18                     lda <$18
   54  31:BB63  6A                        ror a
   55  31:BB64  48                        pha     ;sta <$1c
   56  31:BB65  4C 77 BB                  jmp .apply_critical
   57  31:BB68            .multiply_atk:
   58  31:BB68  85 1A                     sta <$1a
   59  31:BB6A  A9 00                     lda #0
   60  31:BB6C  85 1B                     sta <$1b
   61  31:BB6E  20 F5 FC                  jsr mul_16x16
   62  31:BB71  A5 1D                     lda <$1d
   63  31:BB73  48                        pha
   64  31:BB74  A5 1C                     lda <$1c
   65  31:BB76  48                        pha
   66  31:BB77            .apply_critical:        ;$bb75:
   67  31:BB77  A5 29             lda <.criticalMultiplier
   68  31:BB79  A6 28             ldx <.criticalBonus
   69  31:BB7B  20 D6 FC          jsr mul_8x8             ;fcd6
   70  31:BB7E  18                clc
   71  31:BB7F  68                pla
   72  31:BB80  65 1A             adc <$1a
   73  31:BB82  85 18             sta <$18
   74  31:BB84  68                pla
   75  31:BB85  65 1B             adc <$1b
   76  31:BB87  85 19             sta <$19
   77  31:BB89  20 B5 A2          jsr b31_getActor2C      ;a2b5
   78  31:BB8C  A2 00             ldx #0
   79  31:BB8E  11 70             ora     [.pTarget],y
   80  31:BB90  10 11             bpl .player_to_player
   81  31:BB92  38                        sec
   82  31:BB93  A5 18                     lda <$18
   83  31:BB95  E5 26                     sbc <$26
   84  31:BB97  85 18                     sta <$18
   85  31:BB99  B0 08                     bcs .atk_positive
   86  31:BB9B  C6 19                             dec <$19
   87  31:BB9D  10 04                             bpl .atk_positive
   88  31:BB9F  86 19                                     stx <$19
   89  31:BBA1  86 18                                     stx <$18
   90  31:BBA3            .atk_positive:
   91  31:BBA3            .player_to_player:
   92                             ;here a = 0
   93  31:BBA3  86 1B             stx <$1b
   94  31:BBA5  A5 7C             lda <.damageMultiplier
   95  31:BBA7  85 1A             sta <$1a
   96  31:BBA9  20 F5 FC          jsr mul_16x16
   97                             
   98  31:BBAC  A5 1C             lda <$1c
   99  31:BBAE  85 18             sta <$18
  100  31:BBB0  A5 1D             lda <$1d
  101  31:BBB2  85 19             sta <$19
  102                     
  103  31:BBB4  A5 2A             lda <.damageDivider
  104  31:BBB6  85 1A             sta <$1a
  105  31:BBB8  A9 00             lda #0
  106  31:BBBA  85 1B             sta <$1b
  107  31:BBBC  20 92 FC          jsr div_16
  108                     
  109           0001              .ifdef CHARGE_BREAK_DAMAGE_LIMIT
  110  31:BBBF  A0 27                     ldy #BP_OFFSET_ATTACK_MULTIPLIER
  111  31:BBC1  B1 6E                     lda [.pActor],y
  112  31:BBC3  D0 13                     bne .finish
  113                             .endif
  114  31:BBC5  38                sec
  115  31:BBC6  A5 1C             lda <$1c
  116  31:BBC8  E9 0F             sbc #LOW(9999)
  117  31:BBCA  A5 1D             lda <$1d
  118  31:BBCC  E9 27             sbc #HIGH(9999)
  119  31:BBCE  90 08             bcc .finish
  120                                     INIT16 <$1c,#9999
       31:BBD0  A9 0F             lda #LOW(#9999)
       31:BBD2  85 1C             sta <$1c
       31:BBD4  A9 27             lda #HIGH(#9999)
       31:BBD6  85 1D             sta <$1c+1
  121  31:BBD8            .finish:
  122  31:BBD8  60                rts
  123                     
  124                             VERIFY_PC $bbe2
       31:BBD9                    .verify_pc_00135:
                0000              .if (.verify_pc_00135 > $bbe2)
                                  .endif
  125                     ;=====================================================================================================
  126                             RESTORE_PC ff3_calcDamage_begin
                0035              .bank   BANK(ff3_calcDamage_begin)
                88EB              .org    ff3_calcDamage_begin
#[2]   ff3_hack_master.asm
   67                                     ;v0.7.9:
#[3]   ff3_floor_treasure.asm
   68                                     .include "ff3_floor_treasure.asm"       ;save
    1                     ; ff3_floor_treasure.asm
    2                     ;
    3                     ;description:
    4                     ;       implements treasure related functions
    5                     ;
    6                     ;version:
    7                     ;       0.02 (2007-08-31)
    8                     ;======================================================================================================
#[4]   ff3_floor.h
    9                             .include "ff3_floor.h"
    1                     ; ff3_floor.h
    2                     ;
    3                     ;description:
    4                     ;       definitions for floor related functions
    5                     ;
    6                     ;version:
    7                     ;       0.01 (2007-08-29)
    8                     ;======================================================================================================
    9                     
   10                     ;bank 3c
   11                     
   12           337E      floor_searchSpaceForItem = $937e
   13                     
   14                     ;bank 3f
   15                     
   16           551C      floor_getChipEvent      = $e51c
   17                     ;floor_getTreasure = $f549
   18                     ;floor_getItemValue = $f5d4
#[3]   ff3_floor_treasure.asm
   10  35:88EB            ff3_floor_treasure_begin:
   11                     
   12                             INIT_PATCH $3f,$e917,$e9bb
                003F              .bank   $3f
                9917              .org    $e917
       3F:9917                    .ds             (($e9bb) - ($e917))
                9917              .org    $e917
   13                     
   14                     ;e917
   15  3F:9917            floor_processChipEvent:
   16                     ;[in]
   17           0049      .isTreasureGil = $49
   18           0078      .worldId = $78
   19           0080      .pFloorChips = $80
   20           7710      .treasureIdList = $0710
   21           000E      .leaderOffset = $600e
   22           0040      .treasureFlags = $6040
   23                     ;[local/params for functions]
   24           0044      .chipAttributes = $44
   25           0045      .eventParams = $45
   26           00BA      .isTreasureNaked = $ba
   27                     ;--------------------------------------------
   28                     
   29  3F:9917  20 1C E5          jsr floor_getChipEvent  ;$e51c() [out] y = chipid
   30  3F:991A  A5 44             lda <.chipAttributes
   31  3F:991C  10 10             bpl .no_event
   32  3F:991E            .has_event:
   33  3F:991E  C0 90             cpy #$90
   34  3F:9920  90 0C             bcc .no_event
   35  3F:9922  C0 A0             cpy #$a0
   36  3F:9924  90 0A             bcc .door_event
   37  3F:9926  C0 D0             cpy #$d0
   38  3F:9928  90 04             bcc .no_event
   39  3F:992A  C0 F0             cpy #$f0
   40  3F:992C  90 1C             bcc .treasure_event
   41  3F:992E            .no_event:
   42  3F:992E  18                clc
   43  3F:992F  60                rts
   44                     
   45  3F:9930            .door_event:    ;[90 <= chipid < a0]
   46                     ;$e968:
   47  3F:9930  AE 0E 60          ldx .leaderOffset       ;600e
   48  3F:9933  BD 00 61          lda playerBaseParams,x  ;6100
   49  3F:9936  C9 08             cmp #JOB_THIEF  ;08
   50  3F:9938  F0 04             beq .door_is_unlocked
   51  3F:993A  A9 03                     lda #$03
   52  3F:993C  38                        sec
   53  3F:993D  60                        rts
   54  3F:993E            .door_is_unlocked:
   55  3F:993E  AD 21 60          lda $6021
   56  3F:9941  09 40             ora #$40
   57  3F:9943  8D 21 60          sta $6021
   58  3F:9946  A9 7A             lda #$7a
   59  3F:9948  38                sec
   60  3F:9949  60                rts
   61                     
   62  3F:994A            .treasure_event:        ;[d0 <= chipid < f0]
   63  3F:994A  A2 00             ldx #0
   64  3F:994C  C0 E0             cpy #$e0
   65  3F:994E  90 01             bcc .store_naked
   66  3F:9950  CA                        dex
   67  3F:9951            .store_naked:
   68  3F:9951  86 BA             stx <.isTreasureNaked
   69                             
   70  3F:9953  20 97 E9          jsr floor_getTreasureFlagMaskAndIndex
   71  3F:9956  39 40 60          and .treasureFlags,y
   72  3F:9959  F0 D3             beq .no_event
   73                     ;has treasure
   74  3F:995B  A9 BF             lda #$3f | $80
   75  3F:995D  8D 49 7F          sta soundDriver_effectId
   76                     
   77  3F:9960  A5 BA             lda <.isTreasureNaked
   78  3F:9962  30 03             bmi .fetch_treasure
   79  3F:9964  20 F0 E6                  jsr $e6f0       ;unk
   80  3F:9967            .fetch_treasure:
   81  3F:9967  A5 80             lda <$80
   82  3F:9969  48                pha
   83  3F:996A  A5 81             lda <$81
   84  3F:996C  48                pha
   85                             
   86  3F:996D  20 49 F5          jsr floor_getTreasure   ;f549 [out] a = message id
   87                             
   88  3F:9970  AA                tax
   89  3F:9971  68                pla
   90  3F:9972  85 81             sta <$81
   91  3F:9974  68                pla
   92  3F:9975  85 80             sta <$80
   93                     
   94  3F:9977  A0 00             ldy #0
   95  3F:9979  E0 50             cpx #$50        ;message ("もちものがいっぱいです")
   96  3F:997B  D0 06             bne .got_treasure
   97  3F:997D  84 44                     sty <.chipAttributes
   98  3F:997F  84 0D                     sty <$0d
   99  3F:9981  F0 08                     beq .finish     ;
  100  3F:9983            .got_treasure:
  101  3F:9983  A5 BA             lda <.isTreasureNaked
  102  3F:9985  30 04             bmi .finish
  103  3F:9987  A9 7D                     lda #CHIPID_OPENED_TREASURE_BOX ;7d
  104  3F:9989  91 80                     sta [.pFloorChips],y
  105  3F:998B            .finish:
  106  3F:998B  8A                txa
  107  3F:998C  38                sec
  108  3F:998D  60                rts
  109                     
  110  3F:998E            floor_getTreasureId:
  111                     ;[in]
  112           0045      .eventParams = $45
  113           7710      .treasureIdList = $0710
  114                     ;[out]
  115                     ;       a : treasureId
  116                     ;       x : list index
  117  3F:998E  A5 45             lda <.eventParams
  118  3F:9990  29 0F             and #$0f
  119  3F:9992  AA                tax
  120  3F:9993  BD 10 07          lda .treasureIdList,x
  121  3F:9996  60                rts
  122                     
  123  3F:9997            floor_getTreasureFlagMaskAndIndex:
  124                     ;[in]
  125           0045      .eventParams = $45
  126           0078      .worldId = $78
  127           7710      .treasureIdList = $0710
  128           0040      .treasureFlags = $6040
  129                     ;[out]
  130                     ;       a : mask value
  131                     ;       x : bit index
  132                     ;       y : byte index
  133  3F:9997  20 8E E9          jsr floor_getTreasureId
  134  3F:999A  48                pha
  135  3F:999B  29 07             and #$07        ;mask to bit index
  136  3F:999D  AA                tax
  137  3F:999E  68                pla
  138  3F:999F  4A                lsr a
  139  3F:99A0  4A                lsr a
  140  3F:99A1  4A                lsr a
  141  3F:99A2  A4 78             ldy <.worldId
  142  3F:99A4  F0 03             beq .test_flag
  143  3F:99A6  18                        clc
  144  3F:99A7  69 20                     adc #$20
  145  3F:99A9            .test_flag:
  146  3F:99A9  A8                tay
  147  3F:99AA  BD AE E9          lda floor_setBitMask,x
  148  3F:99AD  60                rts
  149                     
  150  3F:99AE            floor_setBitMask:
  151  3F:99AE  01 02 04          .db $01,$02,$04,$08,$10,$20,$40,$80
       3F:99B1  08 10 20  
       3F:99B4  40 80     
  152                     ;e9bb
  153                             VERIFY_PC $e9bb
       3F:99B6                    .verify_pc_00138:
                0000              .if (.verify_pc_00138 > $e9bb)
                                  .endif
  154                     ;-----------------------------------------------------------------------------------------------------
  155                     ; treasure functions
  156                     ;
  157                             INIT_PATCH $3f,$f549,$f670
                003F              .bank   $3f
                5549              .org    $f549
       3F:5549                    .ds             (($f670) - ($f549))
                5549              .org    $f549
  158                     ;$3f:f549 getTreasure
  159                     ;//     [in] u8 $0710[0x10] : treasureIds
  160                     ;//     [in] u8 $45 : eventParam
  161                     ;//     [in] u8 $49 : warpparam.+01 & 0x20
  162                     ;//     [in] u8 $ba : 00: chipId=d0-df, FF: chipId=e0-ef
  163                     ;//             chipId:D0-DF = staticChipId:7C(宝箱)
  164                     ;//     [out] a : messageId
  165  3F:5549            floor_getTreasure:
  166                     ;[in]
  167           0045      .eventParams = $45
  168           0049      .isTreasureGil = $49
  169           0078      .worldId = $78
  170           008F      .treasureId = $8f
  171           00AB      .eventFlag = $ab
  172           006A      .encounterId = $6a
  173           00BA      .isTreasureNaked = $ba
  174           00BB      .messageParam = $bb
  175           0080      .treasureItem = $80     ;u24
  176           0081      .treasureItemCount = $81
  177           7710      .treasureIdList = $0710
  178           CC00      .treasureParams = $9c00 ;512params
  179                     ;------------------------------------------
  180  3F:5549  20 8E E9          jsr floor_getTreasureId
  181  3F:554C  85 8F             sta <.treasureId
  182  3F:554E  AA                tax
  183  3F:554F            .getTreasureParam:
  184  3F:554F  A9 01             lda #$01
  185  3F:5551  20 06 FF          jsr call_switch1stBank  ;ff06
  186  3F:5554  BD 00 9C          lda .treasureParams,x
  187  3F:5557  A4 78             ldy <.worldId
  188  3F:5559  F0 03             beq .got_param
  189  3F:555B  BD 00 9D                  lda .treasureParams+$100,x
  190  3F:555E            .got_param:
  191  3F:555E  AA                tax
  192  3F:555F  86 BB             stx <.messageParam
  193                     
  194  3F:5561  A5 BA             lda <.isTreasureNaked
  195  3F:5563  D0 04             bne .treasure_is_item
  196  3F:5565  A5 49             lda <.isTreasureGil
  197  3F:5567  D0 4B             bne .treasure_is_gil
  198  3F:5569            .treasure_is_item:
  199  3F:5569  86 80                     stx <.treasureItem
  200                     
  201  3F:556B  A9 01                     lda #$01
  202  3F:556D  E0 57                     cpx #$57        ;leather shield
  203  3F:556F  B0 06                     bcs .store_increment
  204  3F:5571  E0 4F                             cpx #$4f        ;wooden arrow
  205  3F:5573  90 02                             bcc .store_increment
  206  3F:5575  A9 14                                     lda #20
  207  3F:5577                    .store_increment:
  208  3F:5577  85 81                     sta <.treasureItemCount
  209                     
  210  3F:5579  20 27 F7                  jsr switchBanksTo3c3d   ;f727
  211                                     
  212                                     ;lda <.treasureParam
  213                                     ;sta <.messageParam     ;$bb
  214                                     
  215  3F:557C  20 7E 93                  jsr floor_searchSpaceForItem    ;3c:937e [out] x = index to put
  216  3F:557F  90 03                     bcc .put_item
  217                                             ;item_full
  218  3F:5581  A9 50                             lda #$50        ;"もちものがいっぱいです"
  219  3F:5583  60                                rts
  220  3F:5584                    .put_item:
  221  3F:5584  A5 80                     lda <.treasureItem
  222  3F:5586  9D C0 60                  sta backpackItems,x
  223  3F:5589  BD E0 60                  lda backpackItems+$20,x ;count
  224  3F:558C  18                        clc
  225  3F:558D  65 81                     adc <.treasureItemCount
  226  3F:558F  C9 64                     cmp #100
  227  3F:5591  90 02                     bcc .store_item_count
  228  3F:5593  A9 63                             lda #99
  229  3F:5595                    .store_item_count:
  230  3F:5595  9D E0 60                  sta backpackItems+$20,x
  231                     
  232  3F:5598  20 C0 F5                  jsr floor_invertTreasureFlag
  233                     
  234  3F:559B  A5 BA                     lda <.isTreasureNaked
  235  3F:559D  F0 03                     beq .treasure_in_box
  236  3F:559F  A9 76                             lda #$76        ;"こんなところにxxが！"
  237  3F:55A1  60                                rts
  238  3F:55A2                    .treasure_in_box:
  239  3F:55A2  A5 8F                     lda <.treasureId
  240  3F:55A4  C9 E0                     cmp #TREASURE_WITH_ENCOUNTER_BASE       ;$e0
  241  3F:55A6  B0 03                     bcs .encounter
  242  3F:55A8  A9 59                             lda #$59        ;"たからばこのなかから..."
  243  3F:55AA  60                                rts
  244  3F:55AB                    .encounter:
  245  3F:55AB  85 6A                     sta <.encounterId
  246  3F:55AD  A9 20                     lda #EVENT_FLAG_ENCOUNTER       ;$20
  247  3F:55AF  85 AB                     sta <.eventFlag
  248  3F:55B1  A9 02                     lda #$02        ;"たからばこの...とつぜんモンスターが..."
  249  3F:55B3  60                        rts
  250  3F:55B4            .treasure_is_gil:
  251                             ;here x ==  (itemid)
  252  3F:55B4  20 CA F5          jsr floor_getItemValue  ;f5d4
  253  3F:55B7  20 F4 F5          jsr floor_incrementPartyGil
  254  3F:55BA  20 C0 F5          jsr floor_invertTreasureFlag
  255  3F:55BD  A9 01             lda #$01        ;"たからばこの...ぎるてにいれた"
  256  3F:55BF  60                rts
  257                     
  258                     ;$3f:f640 invertTreasureFlag
  259  3F:55C0            floor_invertTreasureFlag:
  260                     ;[in]
  261           0045      .eventParams = $45
  262           0078      .worldId = $78
  263           7710      .treasureIdList = $0710
  264           0040      .treasureFlags = $6040
  265  3F:55C0  20 97 E9          jsr floor_getTreasureFlagMaskAndIndex
  266  3F:55C3  59 40 60          eor .treasureFlags,y
  267  3F:55C6  99 40 60          sta .treasureFlags,y
  268  3F:55C9  60                rts
  269                     
  270                             VERIFY_PC $f5d4
       3F:55CA                    .verify_pc_00140:
                0000              .if (.verify_pc_00140 > $f5d4)
                                  .endif
  271                     ;-------------------------------------------------------------------------------------------------
  272                     ;$3f:f5d4 getItemValue ;getTreasureGil
  273                     ;       [in] x : itemid
  274                     ;       [out] u24 $80 : = $10:9e00[x]
  275                     ;caller:
  276                     ;       $3d:b230 @ floor::shop::getItemValues
  277                     ;       $3d:b271 @ floor::shop::getItemValue
  278                     ;       $3f:ef73 @ field::decodeString 
  279                     ;       $3f:f5b8 @ floor::getTreasure
  280                     ;       caller expects y has been unchanged
  281  3F:55CA            floor_getItemValue:
  282           0080      .value = $80
  283           EE00      .itemValues = $9e00
  284                     ;------------------------
  285  3F:55CA  A9 10             lda #$10
  286  3F:55CC  20 06 FF          jsr call_switch1stBank
  287                     
  288  3F:55CF  8A                txa
  289  3F:55D0  0A                asl a
  290  3F:55D1  AA                tax
  291  3F:55D2  B0 0A             bcs .item_80_to_ff
  292  3F:55D4  BD 00 9E                  lda .itemValues,x
  293  3F:55D7  85 80                     sta <.value
  294  3F:55D9  BD 01 9E                  lda .itemValues+1,x
  295  3F:55DC  90 08                     bcc .store_value
  296  3F:55DE            .item_80_to_ff:
  297  3F:55DE  BD 00 9F                  lda .itemValues+$100,x
  298  3F:55E1  85 80                     sta <.value
  299  3F:55E3  BD 01 9F                  lda .itemValues+$101,x
  300  3F:55E6            .store_value:
  301  3F:55E6  85 81             sta <.value+1
  302  3F:55E8  A9 00             lda #0
  303  3F:55EA  85 82             sta <.value+2
  304  3F:55EC  8A                txa
  305  3F:55ED  4A                lsr a
  306  3F:55EE  AA                tax
  307                     
  308  3F:55EF  A9 3C             lda #$3c
  309  3F:55F1  4C 06 FF          jmp call_switch1stBank
  310                     ;--------------------------------------------------------------------------------------------------
  311                     ;$3f:f5ff incrementGil
  312                     ;//     [in] u24 $80 : gil
  313                     ;       INIT_PATCH $3f,$f5ff,$f670
  314                     
  315  3F:55F4            floor_incrementPartyGil:
  316                     ;[in]
  317           0080      .gil = $80
  318           001C      .partyGil = $601c
  319  3F:55F4  A2 00             ldx #0
  320  3F:55F6  8A                txa
  321  3F:55F7            .add24:
  322  3F:55F7  6A                        ror a
  323  3F:55F8  BD 1C 60                  lda .partyGil,x
  324  3F:55FB  75 80                     adc <.gil,x
  325  3F:55FD  9D 1C 60                  sta .partyGil,x
  326  3F:6600  2A                        rol     a;save carry
  327  3F:6601  E8                        inx
  328  3F:6602  E0 03                     cpx #3
  329  3F:6604  D0 F1                     bne .add24
  330                     
  331  3F:6606  A2 FD             ldx #$fd
  332  3F:6608  38                sec
  333  3F:6609            .cmp24:
  334  3F:6609  BD 1F 5F                  lda .partyGil-$fd,x
  335  3F:660C  FD 23 F5                  sbc .maxGil-$fd,x
  336  3F:660F  E8                        inx
  337  3F:6610  D0 F7                     bne .cmp24
  338                     
  339  3F:6612  90 0B             bcc .finish
  340                     
  341                     ;here x == 0
  342  3F:6614  A2 02             ldx #2
  343  3F:6616            .init24:
  344  3F:6616  BD 20 F6                  lda .maxGil,x
  345  3F:6619  9D 1C 60                  sta .partyGil,x
  346  3F:661C  CA                        dex
  347  3F:661D  10 F7                     bpl .init24
  348  3F:661F            .finish:
  349  3F:661F  60                rts
  350  3F:6620            .maxGil:
  351  3F:6620  7F 96 98          .db $7f,$96,$98 ;9999999
  352                     
  353                             VERIFY_PC $f670
       3F:6623                    .verify_pc_00141:
                0000              .if (.verify_pc_00141 > $f670)
                                  .endif
  354  3F:6623            floor_treasure_free_begin:
  355           6670      floor_treasure_free_end = $f670
  356                     ;------------------------------------------------------------------------------------------------------
  357                     ;quick fixes
  358           003D              .bank   $3d
  359           2230              .org    $b230
  360  3D:2230  20 CA F5          jsr floor_getItemValue
  361           2271              .org    $b271
  362  3D:2271  20 CA F5          jsr floor_getItemValue
  363                             
  364           003F              .bank   $3f
  365           FF73              .org    $ef73
  366  3F:FF73  20 CA F5          jsr floor_getItemValue
  367                     
  368           003D              .bank   $3d
  369           11C2              .org    $b1c2
  370  3D:11C2  20 F4 F5          jsr floor_incrementPartyGil
  371                     ;=====================================================================================================
  372                             RESTORE_PC ff3_floor_treasure_begin
                0035              .bank   BANK(ff3_floor_treasure_begin)
                88EB              .org    ff3_floor_treasure_begin
#[2]   ff3_hack_master.asm
   69                                     ;v0.7.3:
#[3]   ff3_field_window.asm
   70                                     .include "ff3_field_window.asm" ;consume(field_treasure_begin)
    1                     ; ff3_field_window.asm
    2                     ;
    3                     ; description:
    4                     ;       replaces field::drawWindow($3f:ed02) related codes
    5                     ;
    6                     ; version:
    7                     ;       0.2.0
    8                     ;======================================================================================================
    9  35:88EB            ff3_field_window_begin:
   10                     
   11           0000              .ifdef FAST_FIELD_WINDOW
  411                             .endif  ;FAST_FIELD_WINDOW
  412                     ;======================================================================================================
  413                     ;$3f:f40a setVramAddrForWindow
  414                     ;//     [in] u8 $3a : x offset
  415                     ;//     [in] u8 $3b : y
  416                             INIT_PATCH $3f,$f40a,$f435
                003F              .bank   $3f
                440A              .org    $f40a
       3F:440A                    .ds             (($f435) - ($f40a))
                440A              .org    $f40a
  417  3F:440A            field_setVramAddrForWindow:
  418           003A      .offsetX = $3a
  419  3F:440A  A4 3A             ldy <.offsetX
  420  3F:440C            field_setVramAddrForWindowEx:
  421                     ;[in] a : widthInCurrentBg
  422                     ;[in] y : offsetX
  423                     ;[out] y : offsetX & #20 ^ #20
  424                     ;[in]
  425           003A      .offsetX = $3a
  426           003B      .offsetY = $3b
  427                     ;[ref]
  428           44A1      .vramAddrLow = $f4a1
  429           44C1      .vramAddrHigh = $f4c1
  430                     ;--------------------------------------
  431  3F:440C  98                tya
  432  3F:440D  48                pha
  433  3F:440E  A4 3B             ldy <.offsetY
  434  3F:4410  29 20             and #$20
  435  3F:4412  AA                tax
  436  3F:4413  F0 02             beq .left_on_1st_bg
  437  3F:4415  A9 04                     lda #$04
  438  3F:4417            .left_on_1st_bg:
  439  3F:4417  19 C1 F4          ora .vramAddrHigh,y
  440  3F:441A  8D 06 20          sta $2006
  441                     
  442  3F:441D  68                pla
  443  3F:441E  29 1F             and #$1f
  444  3F:4420  19 A1 F4          ora .vramAddrLow,y
  445  3F:4423  8D 06 20          sta $2006
  446                     
  447                     ;x = left & #20
  448  3F:4426  8A                txa
  449  3F:4427  49 20             eor #$20
  450  3F:4429  A8                tay
  451                     
  452  3F:442A  60                rts
  453                     
  454                             VERIFY_PC $f435
       3F:442B                    .verify_pc_00144:
                0000              .if (.verify_pc_00144 > $f435)
                                  .endif
  455                     ;------------------------------------------------------------------------------------------------------
  456           0000              .ifdef FAST_FIELD_WINDOW
  543                             .endif  ;FAST_FIELD_WINDOW
  544                     ;------------------------------------------------------------------------------------------------------
  545                     ;$3f:f6aa putWindowTiles
  546                     ;//     [in] u8 $38 : offset x
  547                     ;//     [in] u8 $39 : offset per 2 line
  548                     ;//     [in,out] u8 $3b : offset y (wrap-around)
  549                             INIT_PATCH      $3f,$f6aa,$f727
                003F              .bank   $3f
                66AA              .org    $f6aa
       3F:66AA                    .ds             (($f727) - ($f6aa))
                66AA              .org    $f6aa
  550                     ;; call tree:
  551                     ;;      $eb43: ?
  552                     ;;              $eec0: field::drawEncodedStringInWindow
  553                     ;;                      $eefa: field::decodeStringAndDrawInWindow
  554                     ;;                              $f692: field::drawStingInWindow
  555                     ;;      
  556                     ;;      $ed02: field::drawWindowBox
  557                     ;;              $edc6: field::drawWindowLine
  558  3F:66AA            field_drawWindowContent:
  559                     ;[in]
  560           0038      .left = $38
  561           003C      .width = $3c
  562           003A      .offsetX = $3a
  563           003A      .offsetString = $3a
  564           003B      .offsetY = $3b
  565           0090      .iChar = $90
  566           0091      .widthIn1stBg = $91
  567           7780      .tileArray = $0780
  568           7780      .upperLineString = $0780
  569           77A0      .lowerLineString = $07a0
  570                     
  571                     ;-----------------------------------------
  572  3F:66AA  C9 09             cmp #9
  573  3F:66AC  F0 05             beq .draw_lower_line
  574  3F:66AE  A9 00                     lda #0
  575  3F:66B0  20 B5 F6                  jsr .draw_line
  576  3F:66B3            .draw_lower_line:
  577  3F:66B3  A9 20             lda #$20
  578  3F:66B5            .draw_line:
  579                     ;[in] a  = index offset
  580  3F:66B5  48                pha
  581  3F:66B6  85 3A             sta <.offsetString
  582                     
  583  3F:66B8  2C 02 20          bit $2002
  584  3F:66BB  A5 91             lda <.widthIn1stBg
  585  3F:66BD  A4 38             ldy <.left
  586  3F:66BF  20 E0 F6          jsr .putTiles   ;[out] y = offsetX & #20 ^ #20, $3a = offsetString
  587                     
  588  3F:66C2  18                clc
  589  3F:66C3  68                pla
  590  3F:66C4  65 3C             adc <.width
  591  3F:66C6  38                sec
  592  3F:66C7  E5 3A             sbc <.offsetString
  593  3F:66C9  90 05             bcc .next_line
  594  3F:66CB  F0 03             beq .next_line
  595  3F:66CD  20 E0 F6                  jsr .putTiles
  596                     
  597  3F:66D0            .next_line:
  598  3F:66D0  A4 3B             ldy <.offsetY
  599  3F:66D2  C8                iny
  600  3F:66D3  C0 1E             cpy #30
  601  3F:66D5  D0 02             bne .no_wrap
  602  3F:66D7  A0 00                     ldy #0
  603  3F:66D9            .no_wrap:
  604  3F:66D9  84 3B             sty <.offsetY
  605  3F:66DB  A9 00             lda #0
  606  3F:66DD  85 90             sta <.iChar     ;$90
  607  3F:66DF  60                rts
  608                     
  609  3F:66E0            .putTiles:
  610  3F:66E0  48                pha
  611                     
  612  3F:66E1  20 0C F4          jsr field_setVramAddrForWindowEx
  613           003A      .beginOffset = .offsetString
  614           003A      .endOffset = .beginOffset
  615  3F:66E4  68                pla     ;widthInCurrentBg
  616  3F:66E5  A6 3A             ldx <.offsetString
  617  3F:66E7  48                pha
  618  3F:66E8  18                clc
  619  3F:66E9  65 3A             adc <.offsetString
  620  3F:66EB  85 3A             sta <.endOffset
  621  3F:66ED  68                pla
  622  3F:66EE  4A                lsr a
  623  3F:66EF  6A                ror a
  624  3F:66F0  10 04             bpl .length_even
  625                     ;odd
  626  3F:66F2            .length_odd:
  627  3F:66F2  90 19             bcc .copy_loop_1
  628  3F:66F4  B0 09             bcs .copy_loop_3
  629                     ;even
  630  3F:66F6            .length_even:
  631  3F:66F6  B0 0E             bcs .copy_loop_2
  632  3F:66F8            .copy_loop_0:
  633  3F:66F8  BD 80 07          lda .tileArray,x
  634  3F:66FB  8D 07 20          sta $2007
  635  3F:66FE  E8                inx
  636  3F:66FF            .copy_loop_3:
  637  3F:66FF  BD 80 07          lda .tileArray,x
  638  3F:7702  8D 07 20          sta $2007
  639  3F:7705  E8                inx
  640  3F:7706            .copy_loop_2:
  641  3F:7706  BD 80 07          lda .tileArray,x
  642  3F:7709  8D 07 20          sta $2007
  643  3F:770C  E8                inx
  644  3F:770D            .copy_loop_1:
  645  3F:770D  BD 80 07          lda .tileArray,x
  646  3F:7710  8D 07 20          sta $2007
  647  3F:7713  E8                inx
  648                             
  649  3F:7714  E4 3A             cpx <.offsetString
  650  3F:7716  D0 E0             bne .copy_loop_0
  651                     
  652  3F:7718  60                rts
  653                             ;VERIFY_PC $f727
  654  3F:7719            field_X_shrink_window_metrics:
  655           0038      .left = $38     ;loaded by field_getWindowMetrics
  656           0039      .top = $39      ;loaded by field_getWindowMetrics
  657           003C      .width = $3c    ;loaded by field_getWindowMetrics
  658           003D      .height = $3d   ;loaded by field_getWindowMetrics
  659  3F:7719  E6 38             inc <.left
  660  3F:771B  E6 39             inc <.top
  661  3F:771D  C6 3C             dec <.width
  662  3F:771F  C6 3C             dec <.width
  663  3F:7721  C6 3D             dec <.height
  664  3F:7723  C6 3D             dec <.height
  665  3F:7725  60                rts
  666                             VERIFY_PC $f727
       3F:7726                    .verify_pc_00146:
                0000              .if (.verify_pc_00146 > $f727)
                                  .endif
  667                     ;======================================================================================================
  668                             RESTORE_PC ff3_field_window_begin
                0035              .bank   BANK(ff3_field_window_begin)
                88EB              .org    ff3_field_window_begin
#[2]   ff3_hack_master.asm
   71                                     
   72           0000                      .ifdef EXPERIMENTAL
   74                                     .endif  ;EXPERIMENTAL
   75                             .endif  ;BETA
   76                     
   77                             ;.include "ff3_battle_calc.asm"
   78                     ;==========================================================================================================
#[1]   ff3_hack_beta.asm
